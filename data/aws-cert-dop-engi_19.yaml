- en: 'Chapter 16: Various Logs Generated (VPC Flow Logs, Load Balancer Logs, CloudTrail
    Logs)'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第16章：生成的各种日志（VPC 流日志、负载均衡器日志、CloudTrail 日志）
- en: Logs are a river of information, and they flow from various sources. The logs
    that come from the Load Balancer can be a valuable source of data or a resource
    for troubleshooting. Knowing how to enable these resources can be vital when setting
    up or running your environment. Any action taken in the AWS environment, either
    via the AWS Management Console, the CLI, or an SDK, is recorded via the underlying
    API call to CloudTrail. As a DevOps engineer, it's essential to know who and what
    is making changes to your environment and be able to retrieve that data, especially
    when requested.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 日志是一条信息流，来自不同的源。来自负载均衡器的日志可以成为宝贵的数据源或故障排除的资源。了解如何启用这些资源对于设置或运行您的环境至关重要。在 AWS
    环境中执行的任何操作，无论是通过 AWS 管理控制台、CLI 还是 SDK，都会通过底层 API 调用记录到 CloudTrail 中。作为一名 DevOps
    工程师，了解是谁以及什么在对环境进行更改并能够检索这些数据，尤其是在请求时，是非常重要的。
- en: 'In this chapter, we''re going to cover the following main topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将讨论以下主要内容：
- en: The power of AWS CloudTrail
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**AWS CloudTrail** 的强大功能'
- en: Enabling Elastic Load Balancer logs
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启用弹性负载均衡器日志
- en: Using VPC Flow Logs
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 VPC 流日志
- en: Cleaning up the resources
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 清理资源
- en: Previous logs discussed
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 之前讨论的日志
- en: So far, we have mainly been discussing logs that are generated from the application
    itself. Also included in some of those earlier exercises with CloudWatch Logs
    were some logs that AWS gives us as wrappers around those logs; however, these
    are still, for the most part, just application and AWS service logs.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们主要讨论的是从应用程序本身生成的日志。还包括一些在之前使用 CloudWatch Logs 时 AWS 提供的日志，它们是这些日志的包装器；然而，这些大部分仍然是应用程序和
    AWS 服务日志。
- en: When we want to understand how users are interacting with our environment, be
    it our network environment or how they are adding and removing resources within
    our account, then we would not be able to find that information in the application
    logs. Instead, we must look at some of the other logs available in AWS.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们想要了解用户如何与我们的环境进行交互时，无论是网络环境还是他们如何在我们的帐户内添加和删除资源时，我们将无法在应用程序日志中找到这些信息。相反，我们必须查看
    AWS 中的其他日志。
- en: Knowing which logs to use for which purpose can also help us when it comes to
    other services to protect our environment, such as **GuardDuty**.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 了解哪些日志适用于哪个目的，还可以帮助我们保护环境的其他服务，例如**GuardDuty**。
- en: Note
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: We will discuss GuardDuty in [*Chapter 22*](B17405_22_Final_JM_ePub.xhtml#_idTextAnchor486),
    *Other Policy and Standards Services to Know About*.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在[*第22章*](B17405_22_Final_JM_ePub.xhtml#_idTextAnchor486)中讨论 GuardDuty，*了解的其他政策和标准服务*。
- en: Now that we've looked at where we have been and where we are going, let's start
    with our first set of logs – CloudTrail logs.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经看到了我们走过的路和未来的方向，让我们从第一组日志——CloudTrail 日志开始。
- en: The power of AWS CloudTrail
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '**AWS CloudTrail** 的强大功能'
- en: '**CloudTrail** enables governance, compliance, risk auditing, and operational
    auditing with either your AWS account or multiple accounts using AWS organizations.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '**CloudTrail** 可通过 AWS 账户或多个账户（使用 AWS 组织）启用治理、合规性、风险审计和操作审计功能。'
- en: 'In AWS, every action is performed by an API call. This is true if you are using
    the AWS Management Console, the Amazon CLI, or any of the available SDKs. All
    of these use API calls to perform the necessary actions, then those API actions
    are recorded by the CloudTrail service if it has been turned on:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 在 AWS 中，每个操作都是通过 API 调用执行的。无论您是使用 AWS 管理控制台、Amazon CLI 还是任何可用的 SDK，都是如此。这些操作都通过
    API 调用来执行，然后这些 API 操作如果已启用 CloudTrail 服务，则会被记录下来：
- en: '![Figure 16.1 – The flow of actions to logs via the CloudTrail service'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '![图16.1 – 通过 CloudTrail 服务将操作流动到日志的过程'
- en: '](img/Figure_16.1_B17405.jpg)'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_16.1_B17405.jpg)'
- en: Figure 16.1 – The flow of actions to logs via the CloudTrail service
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 图16.1 – 通过 CloudTrail 服务将操作流动到日志的过程
- en: 'These include recording calls to start and stop EC2 instances, uploading and
    deleting objects from S3, adding or removing security groups from a VPC, adding
    or dropping indexing from a DynamoDB table, and many more. When an activity occurs
    within your account, CloudTrail will capture and record that activity as a CloudTrail
    event. This CloudTrail event contains the following details:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 这些内容包括记录启动和停止 EC2 实例的调用、上传和删除 S3 对象、从 VPC 添加或删除安全组、在 DynamoDB 表中添加或删除索引等。 当您的帐户内发生活动时，CloudTrail
    会捕捉并记录该活动作为 CloudTrail 事件。此 CloudTrail 事件包含以下详细信息：
- en: Who performed the request
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 执行请求的人
- en: The date and time that the request was made
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求发出的日期和时间
- en: The source IP of the request
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求的源 IP
- en: How the request was made
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求是如何发出的
- en: What action is being performed
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 正在执行的操作
- en: The region the action is being conducted in
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 执行操作的区域
- en: The response to the request
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求的响应
- en: It's also important to note that CloudTrail logs are not pushed in real-time
    to the S3 bucket that they are stored in. Instead, the CloudTrail service publishes
    updated log files every 5 minutes with a batch of events it has collected.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 还需要注意的是，CloudTrail 日志不会实时推送到存储的 S3 存储桶中。相反，CloudTrail 服务每 5 分钟发布一次更新的日志文件，包含它收集到的一批事件。
- en: When it comes to securing the CloudTrail logs themselves, by default, the service
    encrypts the files, which it stores in Amazon S3 with **S3 server-side encryption**
    (**SSE**). You also have the option to create an encryption key using the **KMS**
    service and encrypt the CloudTrail logs with that key.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 在确保 CloudTrail 日志本身安全方面，默认情况下，服务会使用 **S3 服务器端加密**（**SSE**）对文件进行加密，并将其存储在 Amazon
    S3 中。你还可以选择使用 **KMS** 服务创建加密密钥，并使用该密钥对 CloudTrail 日志进行加密。
- en: The CloudTrail service offers several benefits. The first is that it records
    user and resource activity. Using these recordings, you can identify who did what
    and when they performed an action on a resource in your AWS account. Secondly,
    since event logs are automatically stored and recorded, compliance reporting becomes
    much more manageable. Third, you gain the ability to monitor, alarm, and react
    to the events that are happening by sending the CloudTrail events to CloudWatch
    Logs. The fourth and final benefit that we will mention here is the ability to
    search through the logs using the CloudWatch service using a SQL-like syntax.
    This enables you to perform powerful queries on the large amounts of data that
    CloudTrail produces.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: CloudTrail 服务提供了几个好处。第一个是它记录了用户和资源的活动。通过这些记录，你可以识别是谁在什么时间对 AWS 账户中的资源执行了什么操作。其次，由于事件日志会自动存储和记录，合规性报告变得更加易于管理。第三，你能够通过将
    CloudTrail 事件发送到 CloudWatch Logs 来监控、警报和响应正在发生的事件。第四个也是我们在这里提到的最后一个好处是，通过使用类似
    SQL 的语法，你可以利用 CloudWatch 服务搜索日志。这使你能够对 CloudTrail 产生的大量数据执行强大的查询。
- en: Now that we know about the CloudTrail service, we will set up CloudTrail in
    our account.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们了解了 CloudTrail 服务，我们将在我们的账户中设置 CloudTrail。
- en: Setting up CloudTrail
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置 CloudTrail
- en: We are going to set up CloudTrail before we look at the logs that CloudTrail
    has recorded. We're doing this so that as we perform other exercises in this chapter,
    we are sure that the CloudTrail service is on and recording our actions. This
    will also ensure that we have a comprehensive set of recordings to search through
    when we perform the CloudTrail exercise later.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将设置 CloudTrail，然后再查看 CloudTrail 记录的日志。我们这样做是为了确保在执行本章其他练习时，CloudTrail 服务已经开启并记录了我们的操作。这还将确保在稍后进行
    CloudTrail 练习时，我们有一个完整的记录集可以进行搜索。
- en: 'Amazon has updated the default way that it creates CloudTrail trails so that
    all the regions are included when it''s initialized. In this section, we want
    to create a trail that will be specific to the region that we are working in.
    This is still possible, but only if we use the AWS CLI:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 亚马逊已经更新了默认创建 CloudTrail 路径的方式，使得所有区域在初始化时都被包含在内。在本节中，我们将创建一个特定于我们正在工作的区域的路径。这仍然是可能的，但仅在使用
    AWS CLI 的情况下：
- en: 'Open your terminal so that you have access to the AWS CLI. First, we will need
    to create an S3 bucket so that our CloudTrail logs can be captured and placed.
    Use the following *example* command, remembering that each S3 bucket name is unique
    and that you will need to create your own S3 bucket:'
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开终端以便访问 AWS CLI。首先，我们需要创建一个 S3 存储桶，以便捕获并存储 CloudTrail 日志。使用以下*示例*命令，记住每个 S3
    存储桶名称都是唯一的，你需要创建自己的 S3 存储桶：
- en: '[PRE0]'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'For the CloudTrail service to be able to put logs into the S3 bucket, we need
    to attach a bucket policy to our bucket. Cut and paste the following bucket policy
    into a local file (where you are performing your terminal commands) called `cloudtrail_s3.json`.
    Look for the two instances of the word `BucketName`; you will need to replace
    those with the name of the bucket that you created in the previous step. A copy
    of this file can be downloaded from the `Chapter-16` folder of this book''s GitHub
    repository:'
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了让CloudTrail服务能够将日志放入S3桶，我们需要为我们的桶附加一个桶策略。将以下桶策略复制并粘贴到本地文件中（在你执行终端命令的地方），命名为`cloudtrail_s3.json`。查找两处出现`BucketName`的地方，你需要将它们替换为你在上一步创建的桶的名称。该文件的副本可以从本书GitHub仓库的`Chapter-16`文件夹下载：
- en: '[PRE1]'
  id: totrans-38
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Once you have created the policy file, you can attach it to your bucket using
    the following command. Be sure to change your bucket name so that the policy attaches
    to your bucket:'
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建策略文件后，你可以使用以下命令将其附加到你的桶上。确保更改桶名称，以便策略附加到你的桶：
- en: '[PRE2]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'With our S3 bucket attached, we can create our single-region trail. Use the
    following command to create your trail, remembering to switch out the name of
    the S3 bucket in the command for the bucket that you created in *step 1* of this
    exercise. Note how we named our trail `sixteen`. We will be referencing this trail
    name later in this chapter:'
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在附加了我们的S3桶后，我们可以创建单区域跟踪。使用以下命令创建你的跟踪，记得将命令中的S3桶名称替换为你在*步骤1*中创建的桶名称。请注意，我们将跟踪命名为`sixteen`。我们将在本章后面引用这个跟踪名称：
- en: '[PRE3]'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'If the trail was created successfully, then you should see JSON returned, similar
    to the following:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 如果跟踪创建成功，你应该会看到返回的JSON，类似以下内容：
- en: '[PRE4]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now, it''s time to start the trail. Just because we created the trail doesn''t
    make it automatically start recording events. Use the following command to start
    the trail so that it captures all the API calls in the region:'
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在是时候开始跟踪了。仅仅因为我们创建了跟踪并不意味着它会自动开始记录事件。使用以下命令启动跟踪，以便捕获该区域的所有API调用：
- en: '[PRE5]'
  id: totrans-46
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Next, to stream our logs to CloudWatch Logs (so that we can search for them
    later), we will need to log into the AWS Management Console and make a quick edit
    to our trail. After logging into the console, navigate to the CloudTrail service.
    When you are brought to the CloudTrail dashboard, you should see the trail that
    we created named **sixteen**. Click on this trail's name:![Figure 16.2 – The sixteen
    CloudTrail trail on the Dashboard
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，为了将日志流式传输到CloudWatch日志（以便我们以后可以搜索它们），我们需要登录到AWS管理控制台并快速编辑我们的跟踪。登录控制台后，导航到CloudTrail服务。当你进入CloudTrail仪表板时，你应该看到我们创建的名为**sixteen**的跟踪。点击该跟踪名称：![图16.2
    – 仪表板上的第十六个CloudTrail跟踪
- en: '](img/Figure_16.2_B17405.jpg)'
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.2_B17405.jpg)'
- en: Figure 16.2 – The sixteen CloudTrail trail on the dashboard
  id: totrans-49
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图16.2 – 仪表板上的第十六个CloudTrail跟踪
- en: When you are in the sixteen cloud trail, you should see a section named **CloudTrail
    logs**. Click the button to the right of the section labeled **Edit**.
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当你进入第十六个CloudTrail时，你应该会看到一个名为**CloudTrail日志**的部分。点击该部分右侧标记为**编辑**的按钮。
- en: On the `CloudTrailRole-sixteen`. Then, click the orange **Save changes** button
    at the bottom of the screen.
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`CloudTrailRole-sixteen`上。然后，点击屏幕底部的橙色**保存更改**按钮。
- en: Now that we have set up the CloudTrail service to record the API actions that
    we will perform going forward, we will look at Elastic Load Balancer logs.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们已经设置了CloudTrail服务来记录我们将来执行的API操作，接下来我们来看看弹性负载均衡器日志。
- en: Enabling Elastic Load Balancer logs
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 启用弹性负载均衡器日志
- en: 'The **Elastic Load Balancing** service lets you capture more data about your
    environment. This can help with troubleshooting, especially regarding latency.
    Elastic Load Balancer access logs can also let you see the path that a user or
    service took from an originating address to the destination service. Sometimes,
    this information is not captured on application logs since the originating address
    that is captured is the Elastic Load Balancer address. The Elastic Load Balancer
    access logs include the following information:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: '**弹性负载均衡**服务允许你捕获更多关于你环境的数据。这有助于故障排除，尤其是在延迟方面。弹性负载均衡器访问日志还能让你查看用户或服务从源地址到目标服务的路径。有时，这些信息不会出现在应用日志中，因为捕获到的源地址是弹性负载均衡器的地址。弹性负载均衡器访问日志包括以下信息：'
- en: The client's IP address
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 客户端的IP地址
- en: Request paths taken
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求路径
- en: The time and date that the request was received
  id: totrans-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 请求接收的时间和日期
- en: Server responses (in numerical format)
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器响应（以数字格式显示）
- en: 'We looked at how load balancing helps spread the load between both instances
    and services when we examined in-depth services such as Elastic Beanstalk and
    OpsWorks. At this point, we should also understand that Elastic Load Balancing
    can be used to attach multiple instances and even instances that are part of an
    auto-scaling group:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在深入研究 Elastic Beanstalk 和 OpsWorks 等服务时，已经了解了负载均衡如何帮助在两个实例和服务之间分配负载。此时，我们还应该明白，弹性负载均衡可以用来附加多个实例，甚至是自动扩展组中的实例：
- en: '![Figure 16.3 – The flow of the access logs from an Elastic Load Balancer to
    an S3 bucket'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 16.3 – 从弹性负载均衡器到 S3 存储桶的访问日志流'
- en: '](img/Figure_16.3_B17405.jpg)'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_16.3_B17405.jpg)'
- en: Figure 16.3 – The flow of the access logs from an Elastic Load Balancer to an
    S3 bucket
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 图 16.3 – 从弹性负载均衡器到 S3 存储桶的访问日志流
- en: Once you have enabled access logs for your Elastic Load Balancer, there is no
    additional charge for logging. There is a charge, however, for storing the logs
    in S3\.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你启用了弹性负载均衡器的访问日志记录，日志记录本身不会产生额外费用。然而，将日志存储在 S3 中会产生存储费用\。
- en: Setting up an Elastic Load Balancer and enabling logging
  id: totrans-64
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置弹性负载均衡器并启用日志记录
- en: 'In our first hands-on example for this chapter, we will use two cross-referenced
    CloudFormation templates to stand up a VPC; the second template will stand up
    an Elastic Load Balancer with two EC2 instances serving a simple website. The
    child template will also create an S3 bucket for capturing our access logs. Once
    we have stood up our test environment, we will need to go into the AWS Management
    Console and turn on logging for our Elastic Load Balancer. Once logging has been
    turned on, we can try to access the website a few times. Doing this should put
    some records in our S3 bucket that we can access and analyze. The templates referenced
    in this exercise are located in the `Chapter-16` directory of this book''s GitHub
    repository. You should download all the templates before starting. Let''s get
    started:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章的第一个实践示例中，我们将使用两个相互引用的 CloudFormation 模板来搭建一个 VPC；第二个模板将搭建一个弹性负载均衡器，并通过两个
    EC2 实例提供一个简单的网站。子模板还将创建一个 S3 存储桶，用于捕获我们的访问日志。完成测试环境搭建后，我们需要进入 AWS 管理控制台并启用弹性负载均衡器的日志记录。启用日志记录后，我们可以尝试多次访问该网站。这样做应该会在我们的
    S3 存储桶中留下记录，我们可以访问并分析这些记录。本练习中引用的模板位于本书 GitHub 仓库的 `Chapter-16` 目录下。在开始之前，请下载所有模板。我们开始吧：
- en: Log into **AWS Management Console** and navigate to the **CloudFormation** service.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到**AWS 管理控制台**，并导航到**CloudFormation**服务。
- en: Once you're on the **CloudFormation** page, if you are brought to the main CloudFormation
    service page, then click on the orange **Create stack** button. Otherwise, if
    you are brought to a listing of your current stacks, then click on the **Create
    stack** button at the top right of the main window and choose the **With new resources
    (standard)** option:![Figure 16.4 – The Create stack button from the stacks listing
    page in CloudFormation
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦进入**CloudFormation**页面，如果跳转到主 CloudFormation 服务页面，请点击橙色的**创建堆栈**按钮。否则，如果跳转到当前堆栈的列表页面，请点击主窗口右上角的**创建堆栈**按钮，并选择**使用新资源（标准）**选项：![图
    16.4 – 在 CloudFormation 中从堆栈列表页面的创建堆栈按钮
- en: '](img/Figure_16.4_B17405.jpg)'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.4_B17405.jpg)'
- en: Figure 16.4 – The Create stack button from the stacks listing page in CloudFormation
  id: totrans-69
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 16.4 – 在 CloudFormation 中从堆栈列表页面的创建堆栈按钮
- en: Whichever way you got here, we should now be on the `vpc.yaml` template to upload
    it. Then, click the **Open** button in the dialog box. Once the file has been
    uploaded, you can click the orange **Next** button.
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 无论你是如何到达这里的，我们现在应该能够上传 `vpc.yaml` 模板。然后，在对话框中点击**打开**按钮。一旦文件上传完成，你可以点击橙色的**下一步**按钮。
- en: This will bring you to the `Chapter16-VPC` when naming your stack. This name
    will be important as this stack will create some of the resources that will be
    used by the next stack, and it will reference those resources by the name of the
    stack. Once you have entered the name, click the orange **Next** button at the
    bottom of the page.
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将带你进入 `Chapter16-VPC`，这是为你的堆栈命名时需要使用的名称。这个名称很重要，因为这个堆栈将创建一些资源，后续堆栈将引用这些资源，并通过堆栈的名称进行引用。一旦输入了名称，点击页面底部的橙色**下一步**按钮。
- en: On the **Configure stack options** page, scroll down to the bottom and hit the
    orange **Next** button.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**配置堆栈选项**页面，向下滚动到底部并点击橙色的**下一步**按钮。
- en: At this point, we will be on the `Chapter16-VPC` stack. Scroll down to the bottom
    of the page and fill in the box under the **Capabilities** section, acknowledging
    that this template will create an IAM role. After this, you can click the orange
    **Create stack** button so that our initial stack can be initialized and created.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此时，我们将在`Chapter16-VPC`堆栈中。向下滚动到页面底部，在**Capabilities**部分下的框中填写，确认此模板将创建一个IAM角色。完成后，点击橙色的**Create
    stack**按钮，以便初始化并创建我们的初始堆栈。
- en: Clicking on the `Chapter16-VPC` stacks page of the CloudFormation service. Once
    the stack has been created, go to **Outputs** via the horizontal menu. At this
    point, you should see the six outputs that the VPC stack has created, including
    the VPCid, two private subnets, and two public subnets:![Figure 16.5 – The outputs
    from the initial stack creation
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击CloudFormation服务中的`Chapter16-VPC`堆栈页面。堆栈创建完成后，进入**Outputs**部分。此时，你应该能看到VPC堆栈创建的六个输出，包括VPCid、两个私有子网和两个公共子网：![图16.5
    – 初始堆栈创建的输出
- en: '](img/Figure_16.5_B17405.jpg)'
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.5_B17405.jpg)'
- en: Figure 16.5 – The outputs from the initial stack creation
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图16.5 – 初始堆栈创建的输出
- en: With our VPC template created and showing the outputs, we can move on to our
    next template. This next template will set up the Load Balancer, along with two
    EC2 instances running the Apache web server. Each server is running a static web
    page, but you will know the difference if you are being directed to instance number
    one or instance number two based on the page displayed.
  id: totrans-77
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建好我们的VPC模板并显示输出后，我们可以继续下一个模板。下一个模板将设置负载均衡器，并配置两个运行Apache Web服务器的EC2实例。每个服务器都运行一个静态网页，但如果你看到的是不同的页面，就能知道自己是被定向到实例一还是实例二。
- en: Since we are already on the **CloudFormation** page of the **Outputs** section,
    we can simply go to the top right-hand corner and click on the white **Create
    stack** button. When the drop-down list appears, choose the **With new resources
    (standard)** option.
  id: totrans-78
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 由于我们已经在**CloudFormation**页面的**Outputs**部分，我们可以直接前往右上角，点击白色的**Create stack**按钮。当下拉列表出现时，选择**With
    new resources (standard)**选项。
- en: Now, back on the `cross-stack-website.yaml` template to upload it. Once the
    template has been uploaded, click on the orange **Next** button at the bottom
    of the page.
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，返回`cross-stack-website.yaml`模板上传它。上传模板后，点击页面底部的橙色**Next**按钮。
- en: You should now be on the `Chapter16-Elastic Load Balancer`. Enter this value
    in the **Stack name** box.
  id: totrans-80
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在你应该处于`Chapter16-Elastic Load Balancer`页面。在**Stack name**框中输入此值。
- en: You will also see a box for parameters. It should already be filled out with
    `Chapter16-VPC`. You won't need to change this value if you named your previous
    stack `Chapter16-VPC`. If you named it something other than this, then you will
    need to provide the name here, as this is the value that drives all intake for
    the outputs we saw earlier. Once you have filled in your values, click the orange
    **Next** button at the bottom of the page:![Figure 16.6 – The Stack name and Parameters
    fields on the Specify stack details page
  id: totrans-81
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你还会看到一个参数框。这个框应该已经填上了`Chapter16-VPC`。如果你之前的堆栈命名为`Chapter16-VPC`，你无需更改此值。如果你给堆栈取了其他名字，则需要在此输入该名称，因为这是驱动我们之前看到的所有输出的值。填写完值后，点击页面底部的橙色**Next**按钮：![图16.6
    – 指定堆栈详情页面中的堆栈名称和参数字段
- en: '](img/Figure_16.6_B17405.jpg)'
  id: totrans-82
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.6_B17405.jpg)'
- en: Figure 16.6 – The Stack name and Parameters fields on the Specify stack details
    page
  id: totrans-83
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图16.6 – 指定堆栈详情页面中的堆栈名称和参数字段
- en: At this point, you will be taken to the **Configure stack options** page. There
    is nothing to configure on this page, so we will scroll down to the bottom of
    the page and click the orange **Next** button.
  id: totrans-84
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此时，你将被带到**Configure stack options**页面。此页面无需配置任何内容，因此我们将向下滚动到页面底部，点击橙色的**Next**按钮。
- en: Finally, we will be on the **Review stack** page. Briefly look over the options
    you have chosen for your stack. If you don't see any errors, then click on the
    orange **Create stack** button at the bottom of the page.
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，我们将进入**Review stack**页面。简要查看你为堆栈选择的选项。如果没有错误，点击页面底部的橙色**Create stack**按钮。
- en: It will take a few minutes for our stack to be created as it is creating the
    two EC2 instances and installing the software and web page. It is also creating
    a classic Load Balancer, registering those instances with that Load Balancer,
    and performing the initial health checks.
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 由于我们的堆栈正在创建两个EC2实例并安装软件和网页，同时还在创建经典负载均衡器，注册这些实例到该负载均衡器，并执行初步健康检查，因此需要几分钟的时间来完成创建。
- en: Once the stack has completed, click on **Outputs** from the horizontal menu,
    as we did with the previous stack. This time, you will find the URL of a key there
    and the value of the public URL for the Elastic Load Balancer. Right-click on
    the URL to open it in a new tab.
  id: totrans-87
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦堆栈完成，点击**输出**菜单项，就像我们在前一个堆栈中所做的那样。这时，您会在这里找到一个密钥的URL和Elastic Load Balancer的公共URL值。右键点击该URL并在新标签页中打开。
- en: Now, click on the **Resources** menu item in the same horizontal menu where
    you found **Outputs**. Click on the **Physical ID** link for the Elastic Load
    Balancer so that you are taken directly to the Elastic Load Balancer's details
    page:![Figure 16.7 – The resource listing of the ELB shown in CloudFormation
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，点击同一水平菜单中的**资源**菜单项，您在其中找到了**输出**。点击Elastic Load Balancer的**物理ID**链接，您将直接进入Elastic
    Load Balancer的详细信息页面：![图16.7 – 在CloudFormation中显示的ELB资源列表
- en: '](img/Figure_16.7_B17405.jpg)'
  id: totrans-89
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.7_B17405.jpg)'
- en: Figure 16.7 – The resource listing of the Elastic Load Balancer shown in CloudFormation
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图16.7 – 在CloudFormation中显示的Elastic Load Balancer资源列表
- en: Now, scroll down to the bottom half of the screen until you find the **Attributes**
    heading. Under this heading, you will find the **Access logs** section. It should
    have a value next to it that is currently set to **Disabled**. Click the gray
    button labeled **Configure Access logs**.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，向下滚动屏幕的下半部分，直到找到**属性**标题。在此标题下，您将找到**访问日志**部分。此处应该有一个值，当前设置为**禁用**。点击灰色的**配置访问日志**按钮。
- en: 'When the dialog box appears, you will need to fill in the following values:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当对话框出现时，您需要填写以下值：
- en: Check the **Enable Access logs** box.
  id: totrans-93
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 勾选**启用访问日志**框。
- en: Change the interval in which the logs are being pushed to **5 minutes**.
  id: totrans-94
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将日志推送间隔更改为**5分钟**。
- en: Choose a name for a **NEW** S3 bucket where the Elastic Load Balancer access
    logs can be stored.
  id: totrans-95
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为存储Elastic Load Balancer访问日志选择一个**新的**S3桶名称。
- en: 'Check the box to have the S3 bucket created for you:'
  id: totrans-96
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 勾选框以创建S3桶：
- en: '![Figure 16.8 – Configure access logs'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: '![图16.8 – 配置访问日志'
- en: '](img/Figure_16.8_B17405.jpg)'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_16.8_B17405.jpg)'
- en: Figure 16.8 – Configure access logs
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图16.8 – 配置访问日志
- en: Once you have filled out all the values, click on the blue **Save** button.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 填写完所有值后，点击蓝色的**保存**按钮。
- en: Now, with the logs turned on, it is time to go back to the browser tab that
    you opened previously that contained the URL for the Elastic Load Balancer. Refresh
    the page multiple times; if both servers came up healthy for the Elastic Load
    Balancer, then you should see a mix of server one and server two appear on the
    screen.
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，开启日志功能后，是时候回到之前打开的浏览器标签页，其中包含Elastic Load Balancer的URL。多次刷新页面；如果两个服务器都已成功启动并通过Elastic
    Load Balancer的健康检查，您应该会看到服务器一和服务器二的混合显示在屏幕上。
- en: Once you have generated some traffic, we can start to navigate to the S3 bucket
    that we created for our Elastic Load Balancer access log storage. However, remember
    that the logs are only pushed once every 5 minutes, so you might need to be a
    bit patient as you wait for the logs to appear.
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦生成了一些流量，我们可以开始导航到为Elastic Load Balancer访问日志存储创建的S3桶。但是，请记住，日志每5分钟才会推送一次，因此您可能需要耐心等待日志的出现。
- en: At this point, it's time to navigate to the S3 service and find the name of
    the bucket you created to store your Elastic Load Balancer access logs. Click
    the name of the bucket. You should see a *folder* named `AWSLogs` and then a *subfolder*
    underneath that is numerically named based on an account number. In that account
    folder, there should be further subfolders named `elasticloadbalancing` and then
    subfolders based on region, year, month, and day. Finally, you will get to the
    log files. Click on one of the log files, download it, and open it in Textpad
    or Notepad.
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这时，是时候转到S3服务并找到您为存储Elastic Load Balancer访问日志而创建的桶的名称了。点击桶的名称。您应该会看到一个名为`AWSLogs`的*文件夹*，然后是一个以帐户号码命名的*子文件夹*。在该帐户文件夹中，应该有名为`elasticloadbalancing`的进一步子文件夹，然后是按地区、年份、月份和日期命名的子文件夹。最后，您将看到日志文件。点击其中一个日志文件，下载并用Textpad或记事本打开它。
- en: With that, we've learned how to enable logs and see the traffic patterns coming
    from our Elastic Load Balancers. Don't take down this set of CloudFormation templates
    just yet, however. We are going to use the VPC that we created here in the next
    section to examine VPC Flow Logs. But first, let's look at the use cases for Elastic
    Load Balancer logs.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这个，我们已经了解了如何启用日志并查看来自我们的弹性负载均衡器的流量模式。然而，不要急着关闭这组CloudFormation模板。我们将在接下来的部分中使用这里创建的VPC，来检查VPC流日志。但首先，让我们看一下弹性负载均衡器日志的用例。
- en: Use cases for Elastic Load Balancer logs
  id: totrans-105
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 弹性负载均衡器日志的用例
- en: 'You may be wondering why you would be interested in turning on Elastic Load
    Balancer logs when you could get information such as a client''s address from
    your application''s log files? Let''s look at a few use cases in detail:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会想，为什么你会对启用弹性负载均衡器日志感兴趣，而你可以从应用程序的日志文件中获取类似客户端地址的信息？让我们详细查看几个用例：
- en: Understanding the latency from requests – how long it takes to respond to a
    request.
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解请求的延迟——响应请求需要多长时间。
- en: Monitoring access requests – where the requests are coming from and going to.
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控访问请求——请求来自哪里，去往哪里。
- en: Measuring how efficient the operation is between the client and the resources
    – are there any bottlenecks in the process that can be detected easily?
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 衡量客户端与资源之间操作的效率——是否存在可以轻松检测到的瓶颈？
- en: Now that we understand when we would use Elastic Load Balancer logs, let's look
    at VPC Flow Logs.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们理解了何时使用弹性负载均衡器日志，让我们看看VPC流日志。
- en: Using VPC Flow Logs
  id: totrans-111
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用VPC流日志
- en: Flow logs help you capture information regarding the IP traffic going in and
    out of the network interfaces of your **Virtual Private Cloud** (**VPC**). Once
    this data has been captured, it can be written to either an S3 bucket or pushed
    out to a CloudWatch log group.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 流日志帮助您捕获有关**虚拟私有云**（**VPC**）网络接口进出IP流量的信息。一旦捕获到这些数据，它可以被写入S3存储桶或推送到CloudWatch日志组。
- en: 'Once a flog log group has been created and has started writing logs, the logs
    do not appear immediately. It can take up to 5 minutes for the logs to appear
    in either the S3 bucket or the log group:'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦创建了流日志组并开始记录日志，日志不会立即出现。日志可能需要最多5分钟才会出现在S3存储桶或日志组中：
- en: '![Figure 16.9 – VPC Flow Logs traveling to and from different sources'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: '![图16.9 – VPC流日志在不同来源之间传输'
- en: '](img/Figure_16.9_B17405.jpg)'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_16.9_B17405.jpg)'
- en: Figure 16.9 – VPC Flow Logs traveling to and from different sources
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 图16.9 – VPC流日志在不同来源之间传输
- en: 'Flow logs can be created for network interfaces. These include the network
    interface of a VPC itself or even other services that contain network interfaces,
    such as the following:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 可以为网络接口创建流日志。这些包括VPC本身的网络接口，甚至是其他包含网络接口的服务，如下所示：
- en: Elastic Load Balancers
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 弹性负载均衡器
- en: Amazon RDS databases
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 亚马逊RDS数据库
- en: Amazon ElastiCache caches
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 亚马逊ElastiCache缓存
- en: Amazon Redshift databases
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 亚马逊Redshift数据库
- en: Amazon WorkSpaces
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 亚马逊WorkSpaces
- en: Transit Gateway
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 传输网关
- en: NAT Gateway
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: NAT网关
- en: Now that we understand what VPC Flow Logs are and what they can be attached
    to, let's see what kind of limitations they have before we set up the flow logs
    on the VPC we stood up earlier.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们了解了VPC流日志是什么以及它们可以附加到哪些内容，让我们先看看它们的限制，然后再设置之前创建的VPC上的流日志。
- en: Limitations regarding VPC Flow Logs
  id: totrans-126
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 关于VPC流日志的限制
- en: 'Although VPC Flow Logs allow you to capture most traffic either coming from
    or going to the different network interfaces in your **VPC**, there are cases
    where this isn''t possible. Let''s take a quick look at those. In this case, if
    one of these scenarios comes up either in the DevOps professional exam or in real
    life, we know that flow logs would not be the optimal solution. An example of
    this is when flow logs cannot be enabled for peered VPCs unless the VPCs have
    been peered within the same account. Another thing to note is that Flow Logs do
    not capture all IP traffic. There is specific traffic that is *dropped* and specifically
    not captured by the flow log files:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然VPC流日志允许您捕获大多数来自或前往**VPC**中不同网络接口的流量，但也有一些情况是无法捕获的。我们来快速了解这些情况。在这种情况下，如果在DevOps专业考试中或现实生活中出现其中一个场景，我们就知道流日志并不是最佳解决方案。例如，当VPC之间的对等连接未在同一帐户内进行对等时，无法为对等的VPC启用流日志。另一个需要注意的是，流日志并不会捕获所有的IP流量。有一些特定的流量是*丢失的*，特别是不会被流日志文件捕获的：
- en: Any traffic from instances trying to contact the Amazon DNS server.
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 任何来自实例的流量，试图连接到亚马逊DNS服务器。
- en: Any traffic from a Windows instance for Amazon Windows license registration.
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从Windows实例发送的用于Amazon Windows许可证注册的任何流量。
- en: All traffic to and from `169.254.169.254` for metadata information
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有与`169.254.169.254`之间的流量，用于元数据相关信息
- en: All traffic to and from `169.254.169.123` for the Amazon Time Sync service
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有与`169.254.169.123`之间的流量，用于Amazon Time Sync服务
- en: Any DHCP traffic
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有的DHCP流量
- en: Any traffic to the VPC router that travels on a reserved IP address
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 任何发送到VPC路由器并通过保留IP地址传输的流量
- en: All traffic between an endpoint network interface and a Network Load Balancer
    interface
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有位于终端节点网络接口与网络负载均衡器接口之间的流量
- en: Enabling VPC Flow Logs
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 启用VPC流日志
- en: As we mentioned previously in our previous hands-on exercise, we are going to
    use the same **VPC** that we stood up in this hands-on exercise to capture the
    VPC Flow Logs.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 如我们之前在动手练习中提到的，我们将使用本次动手练习中创建的相同**VPC**来捕获VPC流日志。
- en: 'When you create a flow log, you need to specify the following items:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 创建流日志时，你需要指定以下项目：
- en: The AWS resource that you want to have
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你希望拥有的AWS资源
- en: If you wish to capture accepted traffic, rejected traffic, or all the traffic
    in the flow log
  id: totrans-139
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果你希望捕获接受的流量、拒绝的流量或流日志中的所有流量
- en: Where you want the data to be published to (an S3 bucket or CloudWatch Logs)
  id: totrans-140
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你希望数据发布到的地方（S3桶或CloudWatch日志）
- en: 'Let''s get started:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们开始吧：
- en: Start by going to the **CloudWatch** service. On the left-hand menu, find **Logs**
    and click on **Log groups**.
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从**CloudWatch**服务开始。在左侧菜单中找到**日志**，点击**日志组**。
- en: At the top right, click on the orange **Create log group** button.
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在右上角，点击橙色的**创建日志组**按钮。
- en: Create a log group called `FlowLogs`. You can change the retention settings
    to allow the logs to expire after 7 days (1 week). Once you have updated these
    settings, scroll to the bottom of the page and click the orange **Create** button.
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为`FlowLogs`的日志组。你可以更改保留设置，允许日志在7天后（1周）过期。更新完这些设置后，滚动到页面底部并点击橙色的**创建**按钮。
- en: Navigate back to the `Chapter16-VPC`. Click on this stack name to get to the
    details of this stack.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回到`Chapter16-VPC`。点击这个堆栈名称查看该堆栈的详细信息。
- en: Then, from the top horizontal menu of the stack, click on the **Resources**
    menu item. Once the table of resources appears, scroll down until you find the
    listing for the VPC (it might be near the bottom since it was one of the first
    resources we created). Click on the blue **Physical ID** link for the VPC to be
    taken to the VPC. (Make a note of the physical ID before you click it; remember
    the last 4 alphanumeric characters of the VPC).
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，从堆栈的顶部水平菜单中点击**资源**菜单项。当资源表格出现时，向下滚动，直到找到VPC的条目（它可能靠近底部，因为它是我们最先创建的资源之一）。点击VPC的蓝色**物理ID**链接，进入VPC界面。（在点击之前记下物理ID的最后4个字母数字字符；记住VPC的最后4个字母数字字符）。
- en: Once you are on the **Your VPCs** page, *check* the box to the right of the
    name of the VPC. Once the box has been checked, click on the white button named
    **Actions** at the top right of the screen. Once you've done this, a drop-down
    menu should appear. Select the **Create flow log** menu item.
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦你进入**你的VPC**页面，*勾选*VPC名称右侧的框。勾选后，点击屏幕右上角的白色**操作**按钮。完成后，一个下拉菜单会出现。选择**创建流日志**菜单项。
- en: At this point, you will be brought to the `All`
  id: totrans-148
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此时，你将被带到`All`
- en: '`1 minute`'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`1分钟`'
- en: '`Send to CloudWatch Logs`'
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`发送到CloudWatch日志`'
- en: '`FlowLogs`'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`FlowLogs`'
- en: '`VpcFlowLogRole`)'
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`VpcFlowLogRole`'
- en: After you have filled out all these settings, click the orange **Create flow
    log** button.
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 填写完所有这些设置后，点击橙色的**创建流日志**按钮。
- en: Now, it's time to go back to your Elastic Load Balancer URL and send some traffic
    to the websites that have been loaded on the EC2 instances. Doing this will generate
    logs for the VPC Flow Logs. Once you have generated some traffic, go back to the
    CloudWatch Log group called `FlowLogs` and look at the records that it generated.
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，回到你的Elastic Load Balancer URL并向已经加载在EC2实例上的网站发送一些流量。这样会生成VPC流日志。一旦生成了一些流量，回到名为`FlowLogs`的CloudWatch日志组，查看它生成的记录。
- en: We just learned how to create a custom CloudWatch log group and turn on VPC
    Flow Logs so that we could capture traffic from our VPC. Next, we will look at
    some use cases when it makes sense to turn VPC Flow Logs on.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 我们刚刚学习了如何创建自定义的CloudWatch日志组并开启VPC流日志，以便捕获VPC中的流量。接下来，我们将看看在哪些使用场景下开启VPC流日志是有意义的。
- en: Use cases for VPC Flow Logs
  id: totrans-156
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: VPC流日志的使用场景
- en: With so many types of logs available, let's look at some clear use cases for
    using VPC Flow Logs.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 由于有如此多类型的日志可用，让我们来看一些使用 VPC 流日志的明确用例。
- en: Using VPC Flow Logs to monitor remote logins
  id: totrans-158
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 VPC 流日志来监控远程登录
- en: Remotely logging in to instances on your cloud infrastructure should only be
    done through authorized personnel, as well as trusted addresses. You can use VPC
    Flow Logs to see what users and IP addresses are gaining access to or trying to
    gain access to via protocols such as **Remote Desktop Protocol** (**RDP**) or
    **Secure Shell Access** (**SSH**).
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 远程登录到你云基础设施上的实例应仅通过授权人员以及可信地址进行。你可以使用 VPC 流日志查看哪些用户和 IP 地址正在通过 **远程桌面协议** (**RDP**)
    或 **安全外壳协议** (**SSH**) 等协议获取访问权限或尝试获取访问权限。
- en: Note
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can connect to AWS Mac instances using a **Virtual Network Connection**
    (**VNC**) client; however, this type of connection is insecure. To make the connection
    secure, you can wrap the connection in an SSH tunnel, as mentioned here: [https://aws.amazon.com/premiumsupport/knowledge-center/ec2-mac-instance-gui-access/](https://aws.amazon.com/premiumsupport/knowledge-center/ec2-mac-instance-gui-access/).'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 **虚拟网络连接** (**VNC**) 客户端连接到 AWS Mac 实例；然而，这种连接是不安全的。为了确保连接的安全性，你可以通过 SSH
    隧道将连接封装起来，具体方法可以参考这里：[https://aws.amazon.com/premiumsupport/knowledge-center/ec2-mac-instance-gui-access/](https://aws.amazon.com/premiumsupport/knowledge-center/ec2-mac-instance-gui-access/)。
- en: Detecting threats with VPC Flow Logs
  id: totrans-162
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 VPC 流日志检测威胁
- en: If you choose to capture all events, both ingress and egress, with VPC Flow
    Logs, then you can detect threats to your environment such as port scans being
    performed on your network, network scans, someone trying to look for weakness
    or entry points into your system, or data being pushed out to unauthorized sources.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你选择使用 VPC 流日志捕获所有事件，包括入口和出口，那么你可以检测到对环境的威胁，例如网络上的端口扫描、网络扫描、有人试图寻找弱点或进入点，或者数据被推送到未经授权的来源。
- en: If you find that your system has been impacted by an event, then you can use
    VPC Flow Logs to trace the path that the offender took through the network.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你发现你的系统受到某个事件的影响，那么你可以使用 VPC 流日志追踪攻击者通过网络的路径。
- en: Diagnosing and troubleshooting network issues
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 诊断和故障排除网络问题
- en: With layered security, there will be times where you are trying to figure out
    why access to a particular instance or service is not being allowed, which is
    troublesome.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 在分层安全的情况下，有时你会遇到尝试弄清楚为什么无法访问某个实例或服务的情况，这可能会很麻烦。
- en: Gaining an understanding of your network traffic
  id: totrans-167
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 了解你的网络流量
- en: You can use VPC Flow Logs to analyze how the users of your network and AWS account
    are behaving and generate reports of any unsafe behavior that might be occurring.
    This can include using unprotected ports or allowing access from the world, rather
    than restricting access to origin assets to specific IP addresses and leaving
    world access to content delivery servers such as CloudFront.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 VPC 流日志来分析你的网络和 AWS 账户的用户行为，并生成可能发生的不安全行为的报告。这可能包括使用未保护的端口，或者允许来自全球的访问，而不是将访问限制在特定的
    IP 地址上，并将全球访问限制为内容分发服务器（如 CloudFront）。
- en: Now that we've looked at the various use cases for VPC Flow Logs, we will turn
    our attention to the initial logs that we looked at – CloudTrail logs.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经了解了 VPC 流日志的各种使用案例，我们将把注意力转向我们最初查看的日志——CloudTrail 日志。
- en: Going back to our CloudTrail logs
  id: totrans-170
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 回到我们的 CloudTrail 日志
- en: Now that we have created some resources through the exercises we have performed
    in the chapter, as well as several different API calls, we can go back to our
    CloudTrail logs and see how they have been populated with events.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们已经通过本章中执行的练习和多个 API 调用创建了一些资源，我们可以回到 CloudTrail 日志中，看看它们是如何被事件填充的。
- en: Searching through CloudTrail logs
  id: totrans-172
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 搜索 CloudTrail 日志
- en: 'Since we have performed enough activities to generate CloudTrail logs at this
    point, we will start to search through our logs to see what we have captured:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们目前已经执行了足够的操作来生成 CloudTrail 日志，现在我们将开始搜索日志，查看我们捕获到了什么内容：
- en: Navigate back to the **CloudWatch** service. From the left-hand menu, find **Logs**,
    but this time click on the submenu named **Log Insights**.
  id: totrans-174
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回到 **CloudWatch** 服务。从左侧菜单中找到 **Logs**，但这次点击名为 **Log Insights** 的子菜单。
- en: From the drop-down menu for selecting log groups, choose the **CloudTrail**
    log group.
  id: totrans-175
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从选择日志组的下拉菜单中，选择 **CloudTrail** 日志组。
- en: 'Place the following query in the query box and then press the orange **Run
    query** button:'
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下查询放入查询框中，然后按下橙色的 **Run query** 按钮：
- en: '[PRE6]'
  id: totrans-177
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: You should see a graphic similar to the following:![Figure 16.10 – The CloudWatch
    logs insights visualization graph
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你应该会看到类似以下的图形：![图 16.10 – CloudWatch 日志洞察可视化图表
- en: '](img/Figure_16.10_B17405.jpg)'
  id: totrans-179
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_16.10_B17405.jpg)'
- en: Figure 16.10 – The CloudWatch Logs insights visualization graph
  id: totrans-180
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 16.10 – CloudWatch Logs 洞察可视化图表
- en: You can try and see what other things you can find in your CloudTrail log if
    you like.
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果你愿意，可以尝试查看 CloudTrail 日志中你能发现的其他信息。
- en: With that, we've learned how to query CloudTrail logs using CloudWatch Log Insights.
    Now, let's clean up the resources we created before we summarize this chapter.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 有了这些，我们已经学习了如何使用 CloudWatch Log Insights 查询 CloudTrail 日志。现在，在总结本章之前，让我们清理一下之前创建的资源。
- en: Cleaning up the resources
  id: totrans-183
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 清理资源
- en: We created a lot of resources in this chapter that, if left up and running,
    may leave you with a higher AWS bill than you may expect. After completing this
    chapter, be sure to delete the CloudFormation templates that were used to create
    the instances and Elastic Load Balancer.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们创建了很多资源，如果不清理并保持运行，可能会导致你收到比预期更高的 AWS 账单。完成本章后，务必删除用于创建实例和 Elastic Load
    Balancer 的 CloudFormation 模板。
- en: Summary
  id: totrans-185
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we looked at three different sources of logs that can provide
    information for your AWS accounts that are not CloudTrail or application logs.
    Initially, we learned how to set up a CloudTrail trail to record all the API calls
    that happen inside of an account. Next, we looked at Elastic Load Balancer access
    logs and how they record the IP addresses, time, and responses coming into an
    Elastic Load Balancer. Finally, we looked at how VPC Flow Logs can capture network
    traffic from a variety of network interfaces.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们查看了三种不同的日志来源，这些日志可以为你的 AWS 账户提供信息，这些日志不是 CloudTrail 或应用程序日志。首先，我们学习了如何设置
    CloudTrail 跟踪记录账户内发生的所有 API 调用。接下来，我们查看了 Elastic Load Balancer 访问日志，了解它们如何记录进入
    Elastic Load Balancer 的 IP 地址、时间和响应。最后，我们查看了 VPC Flow Logs 如何捕获来自各种网络接口的网络流量。
- en: In the next chapter, we will wrap up our discussion on logging by going over
    how enterprises complement the AWS services that capture logs. Then, we'll learn
    how log storage and advance searching are handled.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将总结日志记录的讨论，介绍企业如何补充捕获日志的 AWS 服务。然后，我们将了解日志存储和高级搜索是如何处理的。
- en: Review questions
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 复习问题
- en: You are working as a DevOps engineer at a company that has implemented multiple
    CI/CD pipelines. One pipeline is used to push out the application code and its
    features. Another pipeline is used to update the underlying infrastructure and
    security settings of the account. After the last set of security group updates
    for the application, all the users at one of the company's remote offices can
    no longer access the instances in the autoscaling group. These users can still
    access the application from the web protocol via the Elastic Load Balancer. These
    users contain members of multiple IAM groups, including developers, power users,
    and even an administrator. Where can you go for information to try and find out
    where the issue is occurring?
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你作为 DevOps 工程师在一家已经实施了多个 CI/CD 流水线的公司工作。一个流水线用于推送应用程序代码及其功能，另一个流水线用于更新账户的基础设施和安全设置。在应用程序的最后一轮安全组更新之后，公司某个远程办公室的所有用户无法再访问自动扩展组中的实例。这些用户仍然可以通过
    Elastic Load Balancer 从 Web 协议访问应用程序。这些用户包含多个 IAM 用户组的成员，包括开发人员、权限用户，甚至是管理员。你可以去哪里寻找信息，试图找出问题发生的原因？
- en: a. Gather the IAM usernames that have been denied access. Use these usernames
    to search through the IAM log group in CloudWatch.
  id: totrans-190
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a. 收集被拒绝访问的 IAM 用户名。使用这些用户名搜索 CloudWatch 中的 IAM 日志组。
- en: b. Make sure that VPC Flow Logs have been turned on. Search the VPC Flow Logs
    for both the internal and external IP addresses for the remote office.
  id: totrans-191
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b. 确保已启用 VPC Flow Logs。搜索 VPC Flow Logs 中远程办公室的内部和外部 IP 地址。
- en: c. Gather the IAM usernames that have been denied access. Go to the CloudTrail
    service and search for the usernames to find denial.
  id: totrans-192
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: c. 收集被拒绝访问的 IAM 用户名。转到 CloudTrail 服务，搜索用户名以查找拒绝访问的记录。
- en: d. Turn on logging to the application's Elastic Load Balancer. Check the Elastic
    Load Balancer logs for both the internal and external IP addresses for the remote
    office.
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: d. 启用应用程序的 Elastic Load Balancer 日志记录。检查 Elastic Load Balancer 日志，查看远程办公室的内部和外部
    IP 地址。
- en: You have been brought into a company that is about to make a major production
    push and release of their application. As part of this release, they are implementing
    a new governing model that requires all activity on the AWS account to be monitored.
    How can you quickly and effectively help the company achieve this goal?
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你被引入到一家即将进行重要生产发布的公司，作为这次发布的一部分，他们正在实施一个新的治理模型，要求监控AWS账户上的所有活动。你如何快速有效地帮助公司实现这一目标？
- en: a. Set up the Amazon Inspector service to constantly inspect all of the activity
    happening on the account.
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a. 设置Amazon Inspector服务，持续检查账户上发生的所有活动。
- en: b. Turn on VPC Flow Logs for all the VPCs, making sure that you are capturing
    both inbound and outbound traffic.
  id: totrans-196
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b. 为所有VPC开启VPC流日志，确保捕获进出流量。
- en: c. Set up the AWS CloudTrail service to monitor and record all the activity
    in all regions.
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: c. 设置AWS CloudTrail服务，监控并记录所有区域的活动。
- en: d. Create a designated CloudWatch Logs log group so that any creation or termination
    events can be filtered specifically to this log group.
  id: totrans-198
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: d. 创建一个指定的CloudWatch Logs日志组，以便可以专门过滤创建或终止事件到该日志组。
- en: Review answers
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 审核答案
- en: b
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: b
- en: c
  id: totrans-201
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: c
