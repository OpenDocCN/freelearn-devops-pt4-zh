- en: 'Chapter 6:'
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
  zh: 第 6 章：
- en: Hosting Your Own Azure Pipeline Agent
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 托管你自己的 Azure 管道代理
- en: In the previous two chapters, we looked at setting up continuous integration
    through Azure Pipelines while using Microsoft-hosted agents. In this chapter,
    we'll be building a self-hosted agent and updating the pipeline to use our own
    agent, rather than using the Microsoft-hosted one.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在前两章中，我们看到了如何通过 Azure Pipelines 设置持续集成，并使用 Microsoft 托管的代理。在本章中，我们将建立一个自托管代理，并更新管道以使用我们自己的代理，而不是使用
    Microsoft 托管的代理。
- en: We will first look at the types of pipeline agents available and then dive into
    the technical specifications of setting up the agent pools. We will also look
    at how you can use VM scale sets for large-scale Azure DevOps projects.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将首先查看可用的管道代理类型，然后深入探讨设置代理池的技术规格。我们还将了解如何使用 VM 扩展集来支持大规模的 Azure DevOps 项目。
- en: 'We''ll be covering the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将涵盖以下主题：
- en: Azure pipeline agent overview
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 管道代理概述
- en: Understanding the types of agents in Azure Pipelines
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 了解 Azure Pipelines 中代理的类型
- en: Planning and setting up your own pipeline agent in Azure
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 规划并设置你自己的 Azure 管道代理
- en: Updating your Azure pipeline to use your self-hosted agent
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更新你的 Azure 管道以使用自托管代理
- en: Using containers as your self-hosted agents
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用容器作为自托管代理
- en: Planning for scale – using Azure VM scale sets as self-hosted agents
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 扩展规划 – 使用 Azure VM 扩展集作为自托管代理
- en: Technical requirements
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: To follow this chapter, you need to have an active Azure DevOps organization
    and an Azure subscription to create a VM.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 要跟随本章，你需要有一个有效的 Azure DevOps 组织和一个 Azure 订阅来创建虚拟机。
- en: '**Getting the project pre-requisites ready**: This section requires you to
    have the **PartsUnlimited** project ready in your own DevOps organization. If
    you are continuing from the previous chapter, [*Chapter 5*](B16392_05_Final_JM_ePub.xhtml#_idTextAnchor123),
    *Running Quality Tests in a Build Pipeline*, you should have it already.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '**准备项目前提条件**：本节要求你在自己的 DevOps 组织中准备好**PartsUnlimited**项目。如果你正在继续上一章内容，[*第 5
    章*](B16392_05_Final_JM_ePub.xhtml#_idTextAnchor123)，*在构建管道中运行质量测试*，你应该已经有该项目了。'
- en: 'If you do not have the project ready in your DevOps org, you can import it
    using Azure DevOps Demo Generator – [https://azuredevopsdemogenerator.azurewebsites.net/](https://azuredevopsdemogenerator.azurewebsites.net/):'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在 DevOps 组织中没有准备好项目，可以使用 Azure DevOps Demo Generator 导入它 – [https://azuredevopsdemogenerator.azurewebsites.net/](https://azuredevopsdemogenerator.azurewebsites.net/)：
- en: Log in to the **Azure DevOps Demo Generator** website.
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到**Azure DevOps Demo Generator**网站。
- en: Enter a project name and select your **DevOps organization**.
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入项目名称并选择你的**DevOps 组织**。
- en: Click on **Choose Template** and find **PartsUnlimited**.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**选择模板**并找到**PartsUnlimited**。
- en: Once you're ready, click **Create Project**:![Figure 6.1 – Creating a sample
    DevOps project
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦准备好，点击**创建项目**：![图 6.1 – 创建示例 DevOps 项目
- en: '](img/Figure_6.01_B16392.jpg)'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.01_B16392.jpg)'
- en: Figure 6.1 – Creating a sample DevOps project
  id: totrans-20
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.1 – 创建示例 DevOps 项目
- en: It will take a couple of minutes for the project to be imported; you can monitor
    the progress using the progress bar displayed.
  id: totrans-21
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 项目导入需要几分钟时间，你可以使用显示的进度条来监控进度。
- en: 'Upon completion, click on **Navigate to project**:'
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 完成后，点击**导航到项目**：
- en: '![Figure 6.2 – Project successfully created'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 6.2 – 项目成功创建'
- en: '](img/Figure_6.02_B16392.jpg)'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_6.02_B16392.jpg)'
- en: Figure 6.2 – Project successfully created
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 图 6.2 – 项目成功创建
- en: We'll be using this project throughout this chapter.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在本章中贯穿使用这个项目。
- en: Azure pipeline agent overview
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Azure 管道代理概述
- en: An Azure pipeline agent is the component responsible for executing the tasks
    defined in the pipeline definition. This agent typically runs inside a VM or container
    and includes the pre-requisites required for the pipeline to run successfully.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 管道代理是负责执行管道定义中任务的组件。这个代理通常运行在虚拟机或容器中，并包含成功运行管道所需的前提条件。
- en: In most cases, you'll need to have an agent in order to run the pipeline. As
    your project size and the number of developers grows, you will need to have more
    agents to support the scale.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，你需要一个代理来运行管道。随着项目规模和开发人员数量的增加，你将需要更多的代理来支持扩展。
- en: 'Each execution of a pipeline initiates a job on one of the agents, and one
    agent can only run one job at a time. Azure pipeline agents can be hosted in the
    cloud or on-premises in one of the following compute infrastructures:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 每次执行管道时，都会在一个代理上启动一个作业，并且每个代理一次只能运行一个作业。Azure 管道代理可以托管在云端或本地的以下计算基础设施中：
- en: Server or client host (physical or virtual)
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器或客户端主机（物理或虚拟）
- en: Containers
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 容器
- en: Azure VM scale sets (preview)
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure VM 扩展集（预览版）
- en: Azure pipeline agents are grouped into **agent pools**. You can create as many
    agent pools as you require.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 管道代理被分组为 **代理池**。你可以根据需要创建任意数量的代理池。
- en: Important note
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Azure Pipelines supports running basic tasks, such as invoking the REST API
    or Azure Function without the need to have any agents. Please refer to [https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml#server-jobs](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml#server-jobs)
    for more details about agentless execution of Azure Pipelines.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 支持运行基本任务，例如调用 REST API 或 Azure Function，而无需任何代理。有关无代理执行 Azure
    Pipelines 的更多详情，请参考 [https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml#server-jobs](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml#server-jobs)。
- en: Understanding the types of agents in Azure Pipelines
  id: totrans-37
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 了解 Azure Pipelines 中代理的类型
- en: 'Azure Pipelines offers two types of agents:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 提供两种类型的代理：
- en: Microsoft-hosted agents
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Microsoft 托管代理
- en: Self-hosted agents
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自托管代理
- en: Let's look at them in detail.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们详细看一下它们。
- en: Microsoft-hosted agents
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Microsoft 托管代理
- en: Microsoft-hosted agents are fully managed VMs, deployed and managed by Microsoft.
    You can choose to use a Microsoft-hosted agent with no additional pre-requisites
    or configurations. Microsoft-hosted agents are the simplest and are available
    at no additional cost.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: Microsoft 托管代理是完全托管的虚拟机，由 Microsoft 部署和管理。你可以选择使用 Microsoft 托管代理，无需任何额外的前置要求或配置。Microsoft
    托管代理是最简单的，且无需额外费用。
- en: Every time you execute a pipeline, you get a new VM for running the job, and
    it's discarded after one use.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 每次执行管道时，你都会获得一个新的虚拟机来运行任务，且使用一次后就会被丢弃。
- en: Self-hosted agents
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 自托管代理
- en: Self-hosted agents are servers owned by you, running in any cloud platform or
    data center owned by you. Self-hosted agents are preferred due to various reasons,
    including security, scalability, and performance.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 自托管代理是你拥有的服务器，运行在你拥有的任何云平台或数据中心中。由于安全性、可扩展性和性能等多种原因，自托管代理更受欢迎。
- en: You can configure your self-hosted agent to have the dependencies pre-installed,
    which will help you decrease the time for your pipeline execution.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以配置自托管代理以预先安装所需的依赖项，这将帮助你减少管道执行的时间。
- en: 'Choosing between a Microsoft-hosted agent and self-hosted agents depends on
    various factors, such as the following:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 选择 Microsoft 托管代理和自托管代理取决于多种因素，以下是一些考虑因素：
- en: The size of the code base
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 代码库的大小
- en: The number of developers
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 开发人员数量
- en: The build and release frequency
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建和发布的频率
- en: The dependencies and packages required for the build process
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建过程中所需的依赖项和包
- en: Security and compliance requirements
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安全性和合规性要求
- en: Performance
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 性能
- en: If your code base is small and the build pipeline is optimized, it's better
    to use Microsoft-hosted agents as it won't take much time to download all the
    dependencies on the fly. However, if you have a large code base with numerous
    amounts of dependencies, using a self-hosted agent will be a better option as
    you can eliminate various build pre-creation tasks from the pipeline by configuring
    them in your self-hosted environment in advance. Self-hosted agents would be the
    only option in the case of highly secure and customized build pipelines that interact
    with other services running in your network. If you need more CPU and memory than
    what is provided with Microsoft-hosted agents, you can use self-hosted agents
    with your customized sizing.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的代码库较小且构建管道经过优化，最好使用 Microsoft 托管代理，因为下载所有依赖项所需的时间不多。然而，如果你有一个庞大的代码库和大量的依赖项，使用自托管代理会是一个更好的选择，因为你可以通过提前在自托管环境中配置它们，从而消除管道中的各种构建前期任务。如果你需要比
    Microsoft 托管代理提供的更多 CPU 和内存，可以使用自托管代理并自定义大小。
- en: It is recommended to start with Microsoft-hosted agents and move to self-hosted
    at a later stage when the Microsoft-hosted agents become a bottleneck in your
    build and release process.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 推荐从 Microsoft 托管代理开始，等到 Microsoft 托管代理在你的构建和发布过程中成为瓶颈时，再转向自托管代理。
- en: Planning and setting up your self-hosted Azure pipeline agent
  id: totrans-57
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 规划和设置你的自托管 Azure 管道代理
- en: In order to use a self-hosted agent with Azure Pipelines, you will need to set
    up a machine and configure it for your pipeline requirements. Typically, you would
    choose an OS version best suited for your project, considering the framework,
    libraries, and build tools compatibility.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在 Azure Pipelines 中使用自托管代理，您需要设置一台机器并根据管道需求进行配置。通常，您会根据项目的框架、库和构建工具兼容性选择最适合的操作系统版本。
- en: For the purpose of this demonstration, we'll be setting up a VM in Azure and
    will configure it to use a self-hosted agent. You can choose to host your agent
    server in any cloud or on-premises environment.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 为了演示，我们将在 Azure 中设置一台虚拟机，并将其配置为使用自托管代理。您可以选择将代理服务器托管在任何云环境或本地环境中。
- en: Choosing the right OS/image for the agent VM
  id: totrans-60
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为代理虚拟机选择正确的操作系统/镜像
- en: The first decision you take while setting up the VM is choosing the OS/image
    for the server depending on your target deployment. If you are deploying in an
    on-premises environment, you may just select one of the supported OS versions
    (such as Windows Server 2016) and install the necessary software. In the case
    of cloud deployments, you have multiple options provided in the form of images,
    which come in various combinations of OS version and pre-installed tools.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 设置虚拟机时的第一个决定是选择操作系统/镜像，这取决于您的目标部署。如果您在本地环境中部署，您可以选择一个支持的操作系统版本（例如 Windows Server
    2016）并安装必要的软件。对于云部署，您可以选择多种操作系统版本和预安装工具的组合镜像。
- en: 'It is advised that you have the agent VM specifications planned with your developers
    to have them best suited for your project needs. Here is a recommended approach:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 建议与开发人员共同规划代理虚拟机的规格，以确保其最适合您的项目需求。以下是一种推荐的做法：
- en: Identify whether your application is built to run on Windows, Linux, or macOS.
    If it's cross-platform, choose the one that runs it best and has support for the
    build tools you're using.
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确定您的应用程序是构建为运行在 Windows、Linux 还是 macOS 上。如果是跨平台的，请选择运行效果最佳且支持您正在使用的构建工具的操作系统。
- en: List down the underlying frameworks and external libraries/components used with
    their versions.
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 列出所使用的底层框架和外部库/组件及其版本。
- en: Select the latest version of the OS version from the top-level OS selected in
    *step 1*.
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从*步骤 1*中选择的顶层操作系统中选择最新版本的操作系统。
- en: Identify whether it is compatible and supported by the **original equipment
    manufacturers** (**OEMs**) for all the dependencies listed in *step 2*.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确定它是否与**原始设备制造商**（**OEM**）支持的所有依赖项兼容，依赖项详见*步骤 2*。
- en: Keep going one version down at a time and select the one that is compatible
    for all the required dependencies for your project.
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 依次选择每个版本，直到选定一个与项目所需所有依赖项兼容的版本。
- en: Based on the specifications identified in this process, you can choose to start
    with a vanilla OS and install your required frameworks and build tools, or choose
    a pre-created image in the cloud.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 根据此过程确定的规格，您可以选择从原生操作系统开始，安装所需的框架和构建工具，或者在云中选择一个预创建的镜像。
- en: OS support and pre-requisites for installing an Azure Pipelines agent
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装 Azure Pipelines 代理的操作系统支持及前提条件
- en: Azure supports various OS versions to use as a self-hosted agent; based on the
    OS you choose, there is a set of pre-requisites you'll need to complete before
    you can install the Azure Pipelines agent on your host.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 支持多种操作系统版本作为自托管代理使用；根据您选择的操作系统，您需要完成一组前提条件，才能在主机上安装 Azure Pipelines 代理。
- en: Supported OSes
  id: totrans-71
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 支持的操作系统
- en: 'The following list shows the supported OSes:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是支持的操作系统列表：
- en: 'Windows-based:'
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于 Windows：
- en: a) Windows 7, 8.1, or 10 (if you're using a client OS)
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) Windows 7，8.1 或 10（如果您使用的是客户端操作系统）
- en: b) Windows Server 2008 R2 SP1 or higher (Windows Server OS)
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) Windows Server 2008 R2 SP1 或更高版本（Windows Server 操作系统）
- en: 'Linux-based:'
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于 Linux：
- en: a) CentOS 7, 6
  id: totrans-77
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) CentOS 7，6
- en: b) Debian 9
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) Debian 9
- en: c) Fedora 30, 29
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: c) Fedora 30，29
- en: d) Linux Mint 18, 17
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: d) Linux Mint 18，17
- en: e) openSUSE 42.3 or later
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: e) openSUSE 42.3 或更高版本
- en: f) Oracle Linux 7
  id: totrans-82
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: f) Oracle Linux 7
- en: g) Red Hat Enterprise Linux 8, 7, 6
  id: totrans-83
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: g) Red Hat Enterprise Linux 8，7，6
- en: h) SUSE Enterprise Linux 12 SP2 or later
  id: totrans-84
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: h) SUSE Enterprise Linux 12 SP2 或更高版本
- en: i) Ubuntu 18.04, 16.04
  id: totrans-85
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: i) Ubuntu 18.04，16.04
- en: 'ARM32:'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ARM32：
- en: a) Debian 9
  id: totrans-87
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) Debian 9
- en: b) Ubuntu 18.04
  id: totrans-88
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) Ubuntu 18.04
- en: 'macOS-based:'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于 macOS：
- en: a) macOS Sierra (10.12) or higher
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) macOS Sierra（10.12）或更高版本
- en: Pre-requisite software
  id: totrans-91
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 前提软件
- en: 'Based on the OS you choose, you will have to install the following pre-requisites
    before you can set up the host as an Azure pipeline agent:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 根据您选择的操作系统，您必须在将主机设置为 Azure Pipeline 代理之前，先安装以下前提条件：
- en: 'Windows-based:'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于 Windows：
- en: a) PowerShell 3.0 or higher
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) PowerShell 3.0 或更高版本
- en: b) .NET Framework 4.6.2 or higher
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) .NET Framework 4.6.2 或更高版本
- en: 'Linux/ARM/macOS-based:'
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基于 Linux/ARM/macOS：
- en: a) Git 2.9.0 or higher.
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) Git 2.9.0 或更高版本。
- en: b) RHEL 6 and CentOS 6 require installing the specialized RHEL.6-x64 version
    of the agent.
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) RHEL 6 和 CentOS 6 需要安装专门的 RHEL.6-x64 版本的代理。
- en: The agent installer for Linux includes a script to auto-install the required
    pre-requisite. You can complete the pre-requisite by running `./bin/installdependencies.sh` ,
    which is available in the downloaded agent directory. The downloading of the agent
    is covered in the following sections of this chapter.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 的代理安装程序包括一个脚本，用于自动安装所需的先决条件。您可以通过运行`./bin/installdependencies.sh`来完成先决条件安装，该脚本位于下载的代理目录中。下载代理的过程将在本章的后续部分中介绍。
- en: Important note
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Please note that the preceding pre-requisites are just to install the Azure
    Pipelines agent on the host; based on your application development requirements,
    you may need to install additional tools, such as Visual Studio build tools, a
    Subversion client, and any other frameworks that your application might need.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，上述先决条件仅用于在主机上安装 Azure Pipelines 代理；根据您的应用程序开发需求，您可能需要安装其他工具，例如 Visual Studio
    构建工具、Subversion 客户端以及您的应用程序可能需要的任何其他框架。
- en: Now that we have understood the pre-requisites, we will create an agent VM for
    our sample project, **PartsUnlimited**.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经了解了先决条件，我们将为我们的示例项目**PartsUnlimited**创建一个代理虚拟机。
- en: Creating a VM in Azure for your project
  id: totrans-103
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为您的项目在 Azure 中创建虚拟机
- en: The **PartsUnlimited** project is built using .NET Framework 4.5 and Visual
    Studio as the primary IDE tool. You can review that by browsing through the repository
    in the **PartsUnlimited** project in your Azure DevOps.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: '**PartsUnlimited** 项目使用 .NET Framework 4.5 和 Visual Studio 作为主要的 IDE 工具进行构建。您可以通过浏览
    **PartsUnlimited** 项目的 Azure DevOps 仓库来查看该信息。'
- en: 'Looking at that, our best bet would be to use a Visual Studio-based server
    OS. Let''s look in Azure to explore our options here:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 看来看去，我们最好的选择是使用基于 Visual Studio 的服务器操作系统。让我们在 Azure 中查看并探索我们在这方面的选择：
- en: Log in to the Azure portal and click **+ Create a resource**.
  id: totrans-106
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到 Azure 门户并点击**+ 创建资源**。
- en: Search for **Visual Studio** and select the **Visual Studio images for Azure**
    option:![Figure 6.3 – Visual Studio in the Azure portal
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 搜索**Visual Studio**并选择**Azure 的 Visual Studio 镜像**选项:![图 6.3 – Azure 门户中的 Visual
    Studio
- en: '](img/Figure_6.03_B16392.jpg)'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.03_B16392.jpg)'
- en: Figure 6.3 – Visual Studio in the Azure portal
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.3 – Azure 门户中的 Visual Studio
- en: Now, you'll be able to select from the various combinations available. We'll
    go with **Visual Studio community 2017 on Windows Server 2016(x64)**:![Figure
    6.4 – Visual Studio images available in Azure
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，您将能够从各种可用组合中进行选择。我们将选择**Visual Studio Community 2017 on Windows Server 2016(x64)**:![图
    6.4 – Azure 中可用的 Visual Studio 镜像
- en: '](img/Figure_6.04_B16392.jpg)'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.04_B16392.jpg)'
- en: Figure 6.4 – Visual Studio images available in Azure
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.4 – Azure 中可用的 Visual Studio 镜像
- en: Important note
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 重要提示
- en: Visual Studio 2019-based images are available in the Azure portal directly in
    the search results.
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基于 Visual Studio 2019 的镜像可以直接在 Azure 门户的搜索结果中找到。
- en: Click **Create** to start creating a VM. Choose the required subscription, resource
    group, and other settings based on your preference.
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建**开始创建虚拟机。根据您的偏好选择所需的订阅、资源组和其他设置。
- en: In further pages, you can modify the settings to use a pre-created virtual network,
    as well as customize the storage settings and other management aspects. Please
    review the documentation to explore more on VM creation in Azure.
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在后续页面中，您可以修改设置以使用预先创建的虚拟网络，并自定义存储设置及其他管理方面的内容。请查看文档，了解更多关于在 Azure 中创建虚拟机的信息。
- en: Important note
  id: totrans-117
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 重要提示
- en: 'Please follow the Microsoft docs to learn more about creating a VM in Azure:
    [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal).'
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 请参考 Microsoft 文档，了解如何在 Azure 中创建虚拟机：[https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal)。
- en: Log in to the VM upon creation and install the required pre-requisites.
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建虚拟机后，登录并安装所需的先决条件。
- en: Now that we have the VM ready, we'll set it up as an Azure Pipelines agent for
    our project.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经准备好虚拟机，我们将其设置为我们项目的 Azure Pipelines 代理。
- en: Setting up the build agent
  id: totrans-121
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置构建代理
- en: In this section, we'll configure the newly created VM to use as a self-hosted
    pipeline agent.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将配置新创建的虚拟机，以将其用作自托管的管道代理。
- en: Setting up the agent pool in Azure DevOps
  id: totrans-123
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在 Azure DevOps 中设置代理池
- en: You can organize your agents in Azure DevOps as **agent pools**. **Agent pools**
    are a collection of your self-hosted agents; they help you organize and manage
    the agents at the pool level, rather than managing them individually.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在 Azure DevOps 中将您的代理组织为 **代理池**。**代理池**是您自托管代理的集合，它们帮助您在池级别组织和管理代理，而不是单独管理每个代理。
- en: '**Agent pools** are managed at the organization level and can be used by multiple
    projects at the same time. Let''s create an **agent pool** to get started:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: '**代理池** 在组织级别进行管理，并可以同时供多个项目使用。让我们创建一个 **代理池** 来开始：'
- en: Log in to Azure DevOps and click on **Organization settings**:![Figure 6.5 –
    Azure DevOps Organization settings
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到 Azure DevOps 并点击 **组织设置**：![图6.5 – Azure DevOps 组织设置
- en: '](img/Figure_6.05_B16392.jpg)'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.05_B16392.jpg)'
- en: Figure 6.5 – Azure DevOps Organization settings
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.5 – Azure DevOps 组织设置
- en: Click on **Agent pools** under **Pipelines**:![Figure 6.6 – Azure DevOps Agent
    pools
  id: totrans-129
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 **管道** 下点击 **代理池**：![图6.6 – Azure DevOps 代理池
- en: '](img/Figure_6.06_B16392.jpg)'
  id: totrans-130
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.06_B16392.jpg)'
- en: Figure 6.6 – Azure DevOps Agent pools
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.6 – Azure DevOps 代理池
- en: You will see that there are two default agent pools created. Click on **Add
    pool** to create a new pool:![Figure 6.7 – Azure DevOps – adding an agent pool
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您会看到已创建了两个默认的代理池。点击 **添加池** 创建一个新池：![图6.7 – Azure DevOps – 添加代理池
- en: '](img/Figure_6.07_B16392.jpg)'
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.07_B16392.jpg)'
- en: Figure 6.7 – Azure DevOps – adding an agent pool
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.7 – Azure DevOps – 添加代理池
- en: 'Provide the pool type, name, description, and pipeline permissions. Under the
    permissions option, you can choose to make this pool available to all pipelines
    and projects at once. Click **Create** once you''re ready:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提供池类型、名称、描述和管道权限。在权限选项下，您可以选择让此池同时适用于所有管道和项目。准备好后点击 **创建**：
- en: 'a) --**Pool type**: **Self-hosted**'
  id: totrans-136
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: a) --**池类型**：**自托管**
- en: 'b) --**Name** and **Description**: Give a meaningful name that you can use
    to refer to later:'
  id: totrans-137
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: b) --**名称** 和 **描述**：为其起个有意义的名称，以便以后可以引用：
- en: '![Figure 6.8 – Azure DevOps – adding agent pool configuration'
  id: totrans-138
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图6.8 – Azure DevOps – 添加代理池配置'
- en: '](img/Figure_6.08_B16392.jpg)'
  id: totrans-139
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.08_B16392.jpg)'
- en: Figure 6.8 – Azure DevOps – adding agent pool configuration
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.8 – Azure DevOps – 添加代理池配置
- en: Your agent pool should be listed under **Agent pools** now.
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在您的代理池应该已列在 **代理池** 下。
- en: We will now set up an access token for the agent VM to be able to authenticate
    with Azure DevOps.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将为代理虚拟机设置访问令牌，以便其能够与 Azure DevOps 进行身份验证。
- en: Setting up an access token for agent communication
  id: totrans-143
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 设置代理通信的访问令牌
- en: 'In this task, you will create a personal access token that will be used by
    the Azure Pipelines agent to communicate with your Azure DevOps organization:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 在此任务中，您将创建一个个人访问令牌，Azure Pipelines 代理将使用它与您的 Azure DevOps 组织进行通信：
- en: Sign in to your Azure DevOps organization with the admin user account.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用管理员用户帐户登录您的 Azure DevOps 组织。
- en: Go to your user profile and click **Personal access tokens**:![Figure 6.9 –
    Personal access token
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 转到您的用户个人资料并点击 **个人访问令牌**：![图6.9 – 个人访问令牌
- en: '](img/Figure_6.09_B16392.jpg)'
  id: totrans-147
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.09_B16392.jpg)'
- en: Figure 6.9 – Personal access token
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.9 – 个人访问令牌
- en: Click on **New token**.
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **新建令牌**。
- en: 'Provide the token specifications as given here:'
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照此处提供的令牌规格进行设置：
- en: '--**Name**: **Self-Hosted Agent Token**.'
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**名称**：**自托管代理令牌**。
- en: '--**Organization**: Your Azure DevOps organization.'
  id: totrans-152
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**组织**：您的 Azure DevOps 组织。
- en: '--**Expiration**: You can choose a date as per your choice. This is only for
    a one-time setup; you do **not** need to re-configure the agent once this token
    expires.'
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**到期时间**：您可以根据需要选择一个日期。这只是一次性设置；一旦此令牌过期，您**不需要**重新配置代理。
- en: '--**Scope**: **Custom defined**.'
  id: totrans-154
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**范围**：**自定义定义**。
- en: On **Scope**, it is recommended to only give the permissions required to manage
    the agents. Click on **Show all scope** and select both the **Read** and **Read
    & manage** permissions:![Figure 6.10 – Agent pool access
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 **范围** 中，建议仅授予管理代理所需的权限。点击 **显示所有范围** 并选择 **读取** 和 **读取与管理** 权限：![图6.10 –
    代理池访问
- en: '](img/Figure_6.10_B16392.jpg)'
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.10_B16392.jpg)'
- en: Figure 6.10 – Agent pool access
  id: totrans-157
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.10 – 代理池访问
- en: Review all the settings and click **Create**:![Figure 6.11 – Creating a personal
    access token for the agent pool
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查看所有设置并点击 **创建**：![图6.11 – 为代理池创建个人访问令牌
- en: '](img/Figure_6.11_B16392.jpg)'
  id: totrans-159
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.11_B16392.jpg)'
- en: Figure 6.11 – Creating a personal access token for the agent pool
  id: totrans-160
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图6.11 – 为代理池创建个人访问令牌
- en: Once you click **Create**, Azure DevOps will display the personal access token.
    Please copy the token and save it in a secure location. If you happen to lose
    this token, you must create a new token for setting up new agents.
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦您点击**创建**，Azure DevOps 会显示个人访问令牌。请复制该令牌并将其保存在安全位置。如果您丢失了该令牌，必须为新代理的设置创建一个新的令牌。
- en: We will use this token when setting up the Azure Pipelines agent.
  id: totrans-162
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们将在设置 Azure Pipelines 代理时使用此令牌。
- en: Important note
  id: totrans-163
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 重要提示
- en: 'You will need to give additional permissions when creating a token if you plan
    to use deployment groups (more information here: [https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops)).'
  id: totrans-164
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您计划使用部署组，创建令牌时需要赋予额外的权限（更多信息请参考：[https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops)）。
- en: Now that we have completed the agent pool setup in Azure DevOps, we can start
    installing the agent in the VM we created earlier.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经在 Azure DevOps 中完成了代理池的设置，我们可以开始在之前创建的虚拟机上安装代理。
- en: Installing Azure Pipelines agents
  id: totrans-166
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 安装 Azure Pipelines 代理
- en: 'You are now ready to install the Azure Pipelines agent on your VMs that you
    created earlier. Let''s download the Azure Pipelines agent. Before you start,
    please log in to the VM created earlier using **Remote desktop**:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可以在之前创建的虚拟机上安装 Azure Pipelines 代理。让我们下载 Azure Pipelines 代理。在开始之前，请使用**远程桌面**登录到之前创建的虚拟机：
- en: In your Azure DevOps account, browse to **Organization Settings** > **Agent
    Pools**.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的 Azure DevOps 账户中，浏览到 **组织设置** > **代理池**。
- en: Select your newly created agent pool and click on **New agent**:![Figure 6.12
    – Add agent
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择您新创建的代理池并点击**新建代理**：![图 6.12 – 添加代理
- en: '](img/Figure_6.12_B16392.jpg)'
  id: totrans-170
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.12_B16392.jpg)'
- en: Figure 6.12 – Add agent
  id: totrans-171
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.12 – 添加代理
- en: On the next page, you can download the agent installer based on the OS and architecture
    (x64/x32). In our example, we're using a Windows Server 2016-based VM. We'll choose
    Windows and the x64 architecture. You can also copy the download URL and use it
    to download the agent directly inside your self-hosted agent machine. You can
    also choose to follow the installation steps given in the Azure DevOps portal
    based on the OS for your agent machine:![Figure 6.13 – Agent commands
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在下一页，您可以根据操作系统和架构（x64/x32）下载代理安装程序。在我们的示例中，我们使用的是基于 Windows Server 2016 的虚拟机。我们将选择
    Windows 和 x64 架构。您还可以复制下载 URL，并在您的自托管代理机器上直接下载代理。您也可以选择根据操作系统在 Azure DevOps 门户中提供的安装步骤来安装代理：![图
    6.13 – 代理命令
- en: '](img/Figure_6.13_B16392.jpg)'
  id: totrans-173
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.13_B16392.jpg)'
- en: Figure 6.13 – Agent commands
  id: totrans-174
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.13 – 代理命令
- en: Tip
  id: totrans-175
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 提示
- en: If you are unable to download the agent file on your Visual Studio machine,
    you can use a different browser than Internet Explorer or disable **Enhanced IE
    Security** configuration from the server manager. You can refer to [https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/](https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/)
    to learn how to disable enhanced Internet Explorer security configuration.
  id: totrans-176
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您无法在 Visual Studio 机器上下载代理文件，您可以使用不同的浏览器（如非 Internet Explorer）或在服务器管理器中禁用**增强的
    IE 安全性**配置。您可以参考 [https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/](https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/)
    了解如何禁用 Internet Explorer 增强的安全性配置。
- en: Launch an elevated PowerShell window and change to the `C:` directory root by
    running the `cd C:\` command:![Figure 6.14 – Change directory
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动一个提升权限的 PowerShell 窗口，并通过运行 `cd C:\` 命令更改到 `C:` 目录根目录：![图 6.14 – 更改目录
- en: '](img/Figure_6.14_B16392.jpg)'
  id: totrans-178
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.14_B16392.jpg)'
- en: Figure 6.14 – Change directory
  id: totrans-179
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.14 – 更改目录
- en: 'Run the following PowerShell commands to create an agent directory on the `C`
    drive and extract the agent files to the new directory. Please note that you may
    have to change the filename/path depending on the version of the agent you''ve
    downloaded and the directory where you saved the downloaded file:'
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 运行以下 PowerShell 命令在 `C` 盘创建一个代理目录，并将代理文件提取到新目录中。请注意，您可能需要根据您下载的代理版本和保存下载文件的目录更改文件名/路径：
- en: '[PRE0]'
  id: totrans-181
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: It will take a minute or two to extract the files. Please browse to the new
    directory once it's completed. You should see files as displayed in the following
    screenshot:![Figure 6.15 – Agent files
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提取文件将需要一分钟左右的时间。完成后，请浏览到新的目录。您应该会看到如下截图中的文件：![图 6.15 – 代理文件
- en: '](img/Figure_6.15_B16392.jpg)'
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.15_B16392.jpg)'
- en: Figure 6.15 – Agent files
  id: totrans-184
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.15 – 代理文件
- en: 'You can run the Azure pipeline agent in two modes:'
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以以两种模式运行 Azure 管道代理：
- en: --`run` batch file stored in the agent directory. Your agent will stop responding
    to pipelines if you stop the interactive authentication.
  id: totrans-186
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --`run` 批处理文件存储在代理目录中。如果您停止交互式认证，您的代理将停止响应管道。
- en: '--**Run as Service**: In this version, you configure the agent to run as a
    Windows service that will remain online all the time and auto-start on reboot.
    This is the recommended setup for production scenarios.'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**作为服务运行**：在这个版本中，您将配置代理作为 Windows 服务运行，该服务将始终保持在线，并在重启时自动启动。这是生产环境推荐的设置。
- en: Let's configure the agent to run as a service. In your PowerShell window, run
    `.\config.cmd`.
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们配置代理为服务运行。在您的 PowerShell 窗口中，运行 `.\config.cmd`。
- en: This will ask a series of questions about your Azure DevOps organization.
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将询问有关您 Azure DevOps 组织的一系列问题。
- en: Enter your Azure DevOps organization as the server URL. Typically, this would
    be [https://dev.azure.com/YourOrganizationName](https://dev.azure.com/YourOrganizationName).
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入您的 Azure DevOps 组织作为服务器 URL。通常，这将是 [https://dev.azure.com/YourOrganizationName](https://dev.azure.com/YourOrganizationName)。
- en: Press *Enter* to select **PAT** (**Personal access token**) as the authentication
    mechanism for Azure DevOps.
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按 *Enter* 键选择 **PAT**（**个人访问令牌**）作为 Azure DevOps 的认证机制。
- en: Provide your personal access token generated earlier.
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提供您之前生成的个人访问令牌。
- en: Provide the agent pool name you created earlier.
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 提供您之前创建的代理池名称。
- en: Provide a name for this agent.
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为此代理提供一个名称。
- en: Provide a working directory for the agent to choose as default.
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为代理提供一个工作目录，作为默认目录。
- en: Finally, press *Y* and hit *Enter* to configure to run the agent as a Windows
    service.
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，按 *Y* 并按 *Enter* 键，将代理配置为作为 Windows 服务运行。
- en: You can accept the default account to run the service.
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以接受默认帐户来运行此服务。
- en: 'This will complete the agent setup; at the end, you should see a message stating
    that the services are started successfully:'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将完成代理设置；最后，您应该看到一条消息，表示服务已成功启动：
- en: '![Figure 6.16 – Installing the agent'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 6.16 – 安装代理'
- en: '](img/Figure_6.16_B16392.jpg)'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_6.16_B16392.jpg)'
- en: Figure 6.16 – Installing the agent
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 图 6.16 – 安装代理
- en: 'Now, if you look under your agent pool in the Azure DevOps portal, you should
    see this agent listed:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，如果您在 Azure DevOps 门户中的代理池下查看，应该会看到这个代理列出：
- en: '![Figure 6.17 – Azure Pipelines agent listed'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 6.17 – Azure Pipelines 代理列出'
- en: '](img/Figure_6.17_B16392.jpg)'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_6.17_B16392.jpg)'
- en: Figure 6.17 – Azure Pipelines agent listed
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 图 6.17 – Azure Pipelines 代理列出
- en: 'You now have a ready-to-use, self-hosted agent for your Azure pipelines! This
    self-hosted agent can be used to run your Azure pipeline jobs, and you can add
    as many agents as you want in a similar fashion. You may have various types of
    hosted agents in one pool; the appropriate agent for the job is automatically
    selected based on the pipeline requirements, or you can select an agent specifically
    at execution time. Typically, in a large environment, you''d pre-create an image
    of an agent server so that it is faster to provision additional agents whenever
    needed. In the next section, we will update our pipeline to leverage this newly
    set-up self-hosted agent. Please refer to this documentation if you wish to use
    a Linux-based hosted agent: [https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops).'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您已经拥有一个可用的自托管代理来运行您的 Azure 管道！此自托管代理可用于运行您的 Azure 管道作业，并且您可以以类似的方式添加任意数量的代理。您可以在同一个池中拥有多种类型的托管代理；根据管道要求，系统会自动选择合适的代理，或者您也可以在执行时专门选择一个代理。通常，在大型环境中，您会预先创建一个代理服务器的镜像，以便在需要时能够更快地配置额外的代理。在接下来的章节中，我们将更新我们的管道，以利用新设置的自托管代理。如果您希望使用基于
    Linux 的托管代理，请参考以下文档：[https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops)。
- en: 'Refer to the following link for macOS-based agents: [https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops).'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考以下链接，了解基于 macOS 的代理：[https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops)。
- en: Important note
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: 'If your self-hosted agent machine is behind a network firewall or proxy, you
    must define the proxy address while installing the Azure pipeline agent. You can
    do that by specifying the proxy URL, username, and password with a config command:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的自托管代理机器位于网络防火墙或代理后面，在安装 Azure 管道代理时，必须定义代理地址。你可以通过在配置命令中指定代理 URL、用户名和密码来完成此操作：
- en: '`./config.cmd --proxyurl http://127.0.0.1:8888 --proxyusername "myuser" --proxypassword
    "mypass"`'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: '`./config.cmd --proxyurl http://127.0.0.1:8888 --proxyusername "myuser" --proxypassword
    "mypass"`'
- en: Updating your Azure pipeline to use self-hosted agents
  id: totrans-211
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 更新你的 Azure 管道以使用自托管代理
- en: In this section, we'll take the Azure pipeline scenario covered in the last
    chapters (**PartsUnlimited**) and modify it to use our newly created self-hosted
    agent. This will enable us to use our self-hosted agent to run the pipelines,
    rather than using Microsoft-provided agents.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将修改上几章中涵盖的 Azure 管道场景（**PartsUnlimited**），以使用我们新创建的自托管代理。这将使我们能够使用自托管代理来运行管道，而不是使用
    Microsoft 提供的代理。
- en: Preparing your self-hosted agent to build the Parts Unlimited project
  id: totrans-213
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备你的自托管代理来构建**PartsUnlimited**项目
- en: 'Before we can start using the self-hosted agent, we must prepare it to support
    building our sample project, **PartsUnlimited**. The **PartsUnlimited** project
    is built using Visual Studio leveraging .NET Framework, Azure development tools
    and .NET Core, Node.js, and so on. In order to use our self-hosted agent for building
    the solution, we must install the required dependencies prior to running the pipeline
    jobs:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们开始使用自托管代理之前，我们必须准备它以支持构建我们的示例项目**PartsUnlimited**。**PartsUnlimited**项目是使用
    Visual Studio 构建的，依赖于 .NET Framework、Azure 开发工具和 .NET Core、Node.js 等技术。为了使用我们的自托管代理构建解决方案，我们必须在运行管道作业之前安装所需的依赖项：
- en: Log in to your self-hosted agent VM.
  id: totrans-215
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到你的自托管代理虚拟机。
- en: 'Download the Visual Studio build tools with this link: [https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&rel=16](https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&rel=16).'
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下链接下载 Visual Studio 构建工具：[https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&rel=16](https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&rel=16)。
- en: This will launch Visual Studio Installer.
  id: totrans-217
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将启动 Visual Studio 安装程序。
- en: Select **ASP.Net and Web Development** and **Azure Development**.
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**ASP.Net 和 Web 开发**以及**Azure 开发**。
- en: Click **Modify**. This will start installing the required framework and tools.
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**修改**。这将开始安装所需的框架和工具。
- en: 'Once this is completed, please download and install .NET Core 2.2\. You can
    download it from this link: [https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer](https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer).'
  id: totrans-220
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 完成后，请下载并安装 .NET Core 2.2。你可以从这个链接下载：[https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer](https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer)。
- en: 'You can find all the .NET downloads here: [https://dotnet.microsoft.com/download](https://dotnet.microsoft.com/download).'
  id: totrans-221
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你可以在这里找到所有的 .NET 下载：[https://dotnet.microsoft.com/download](https://dotnet.microsoft.com/download)。
- en: 'Install Azure PowerShell by running the following commands in an elevated PowerShell
    window:'
  id: totrans-222
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过在提升权限的 PowerShell 窗口中运行以下命令来安装 Azure PowerShell：
- en: '[PRE1]'
  id: totrans-223
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Install Node.js version 6.x from [https://nodejs.org/download/release/v6.12.3](https://nodejs.org/download/release/v6.12.3).
    You can download the file named `node-v6.12.3-x64.msi` and install it using the
    interactive installer.
  id: totrans-224
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从[https://nodejs.org/download/release/v6.12.3](https://nodejs.org/download/release/v6.12.3)下载
    Node.js 版本 6.x。你可以下载名为`node-v6.12.3-x64.msi`的文件，并使用交互式安装程序进行安装。
- en: Your host is now ready to build the **PartsUnlimited** solution.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 你的主机现在已准备好构建**PartsUnlimited**解决方案。
- en: Running the Azure pipeline
  id: totrans-226
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 运行 Azure 管道
- en: 'In this task, we''ll now run the pipeline job to build the **PartsUnlimited**
    solution using our own self-hosted agents:'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个任务中，我们将运行管道作业，使用我们自己的自托管代理构建**PartsUnlimited**解决方案：
- en: Log in to the **Azure DevOps** portal and browse to the **PartsUnlimited** project.
  id: totrans-228
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到**Azure DevOps**门户并浏览到**PartsUnlimited**项目。
- en: Browse to **Pipelines**:![Figure 6.18 – Azure Pipelines
  id: totrans-229
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 浏览到**Pipelines**：![图 6.18 – Azure Pipelines
- en: '](img/Figure_6.18_B16392.jpg)'
  id: totrans-230
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.18_B16392.jpg)'
- en: Figure 6.18 – Azure Pipelines
  id: totrans-231
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.18 – Azure Pipelines
- en: Open the pre-created pipeline named `PartsUnlimitedE2E`.
  id: totrans-232
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开名为`PartsUnlimitedE2E`的预创建管道。
- en: Click on **Edit Pipeline**.
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**编辑管道**。
- en: In the pipeline, change the **agent pool** to your newly created agent pool:![Figure
    6.19 – Selecting an agent pool for the pipeline
  id: totrans-234
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在管道中，将**代理池**更改为您新创建的代理池：![图 6.19 – 为管道选择代理池
- en: '](img/Figure_6.19_B16392.jpg)'
  id: totrans-235
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.19_B16392.jpg)'
- en: Figure 6.19 – Selecting an agent pool for the pipeline
  id: totrans-236
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.19 – 为管道选择代理池
- en: Save the pipeline. You can also choose to run it after saving by selecting **Save
    & queue**:![Figure 6.20 – Saving the pipeline
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存管道。您还可以选择在保存后运行它，方法是选择**保存并排队**：![图 6.20 – 保存管道
- en: '](img/Figure_6.20_B16392.jpg)'
  id: totrans-238
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.20_B16392.jpg)'
- en: Figure 6.20 – Saving the pipeline
  id: totrans-239
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.20 – 保存管道
- en: Now, we are ready to execute the pipeline. Click on **Run pipeline**:![Figure
    6.21 – Running the pipeline
  id: totrans-240
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，我们准备好执行管道。点击**运行管道**：![图 6.21 – 运行管道
- en: '](img/Figure_6.21_B16392.jpg)'
  id: totrans-241
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.21_B16392.jpg)'
- en: Figure 6.21 – Running the pipeline
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.21 – 运行管道
- en: Under **Agent pool**, change the pool name to the agent pool you configured
    in the previous section and click **Run**:![Figure 6.22 – The Run pipeline wizard
  id: totrans-243
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**代理池**下，将池名称更改为您在前一部分配置的代理池名称，然后点击**运行**：![图 6.22 – 运行管道向导
- en: '](img/Figure_6.22_B16392.jpg)'
  id: totrans-244
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.22_B16392.jpg)'
- en: Figure 6.22 – The Run pipeline wizard
  id: totrans-245
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.22 – 运行管道向导
- en: This will start executing the pipeline job on your self-hosted agent. This may
    take a few minutes to complete:![Figure 6.23 – The Azure pipeline Jobs logs
  id: totrans-246
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将开始在您的自托管代理上执行管道作业。完成此操作可能需要几分钟：![图 6.23 – Azure 管道作业日志
- en: '](img/Figure_6.23_B16392.jpg)'
  id: totrans-247
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.23_B16392.jpg)'
- en: Figure 6.23 – The Azure pipeline Jobs logs
  id: totrans-248
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.23 – Azure 管道作业日志
- en: You can click on the job name to view the logs in real time.
  id: totrans-249
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以点击作业名称以实时查看日志。
- en: You've now completed setting up an Azure pipeline, which is using a VM-based
    self-hosted pipeline agent for running the jobs.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在已经完成了 Azure 管道的设置，该管道使用基于 VM 的自托管管道代理来运行作业。
- en: Using containers as self-hosted agents
  id: totrans-251
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用容器作为自托管代理
- en: Azure Pipelines supports using Docker containers as the compute target for running
    pipeline jobs. You can use both Windows containers (Windows Server Core/Nano Server)
    and Linux containers (Ubuntu) to host your agents.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 支持使用 Docker 容器作为运行管道作业的计算目标。您可以使用 Windows 容器（Windows Server
    Core/Nano Server）和 Linux 容器（Ubuntu）来托管您的代理。
- en: In order to connect the container to your Azure DevOps organization, you'll
    need to pass a few environment variables, such as the agent pool name, personal
    access token, and so on.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将容器连接到您的 Azure DevOps 组织，您需要传递一些环境变量，例如代理池名称、个人访问令牌等。
- en: Setting up Windows containers as Azure pipeline agents
  id: totrans-254
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置 Windows 容器作为 Azure 管道代理
- en: In order to use Windows containers as Azure pipeline agents, you need to build
    the container image first and then run it with your Azure DevOps organization
    environment variables. Let's look at the process.
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将 Windows 容器作为 Azure 管道代理使用，您需要先构建容器镜像，然后用 Azure DevOps 组织的环境变量运行它。让我们看看这个过程。
- en: Building the container image
  id: totrans-256
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 构建容器镜像
- en: 'Follow these steps to build the container image:'
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤构建容器镜像：
- en: 'Launch Command Prompt and run the following commands:'
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动命令提示符并运行以下命令：
- en: '[PRE2]'
  id: totrans-259
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Create a new file named `Dockerfile` (no extension) and update it with the
    following content. You can use Notepad to open the file:'
  id: totrans-260
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为`Dockerfile`（无扩展名）的新文件，并用以下内容更新它。您可以使用记事本打开该文件：
- en: '[PRE3]'
  id: totrans-261
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Create a new PowerShell file with the name `start.ps1` and copy the content
    from here: [https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1](https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1).'
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的 PowerShell 文件，命名为`start.ps1`，并从此处复制内容：[https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1](https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1)。
- en: 'Run the following command to build the container image:'
  id: totrans-263
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 运行以下命令以构建容器镜像：
- en: '[PRE4]'
  id: totrans-264
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Your container image is now ready to use. You can use `dockeragent` as the image
    name to refer to this image. Optionally, you can save this image in your container
    repository.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 您的容器镜像现在已准备好使用。您可以使用`dockeragent`作为镜像名称来引用此镜像。可选地，您也可以将此镜像保存在您的容器仓库中。
- en: Running the Azure Pipelines agent container
  id: totrans-266
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 运行 Azure Pipelines 代理容器
- en: Now that you have a container image ready, you can use it as the pipeline agent
    by running the container.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您已经准备好容器镜像，您可以通过运行该容器将其用作管道代理。
- en: 'Launch a Command Prompt window and run the following command. Be sure to update
    the Azure DevOps organization URL, token, and agent name:'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 启动命令提示符窗口并运行以下命令。请确保更新 Azure DevOps 组织 URL、令牌和代理名称：
- en: '[PRE5]'
  id: totrans-269
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Your container-based Azure pipeline agent is now ready to use. If you want to
    use a container for one job and re-create it every time, you can use the `–-once`
    flag to use one container for running one job **only** and use a container orchestrator
    such as Kubernetes to re-create the container as soon as it finishes executing
    the current job.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你的基于容器的 Azure 管道代理已经准备好使用。如果你希望每次只为一个作业使用容器并在作业执行完毕后重新创建容器，你可以使用 `–-once`
    标志，**仅**使用一个容器运行一个作业，并使用容器编排工具（如 Kubernetes）在当前作业执行完毕后重新创建容器。
- en: Important note
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Refer to the Microsoft docs – [https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/](https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/)
    – for additional details about Windows containers.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考 Microsoft 文档 – [https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/](https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/)
    – 了解有关 Windows 容器的更多细节。
- en: In the next section, we'll take a look at setting up Linux-based containers
    as Azure Pipelines agents.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的部分中，我们将介绍如何将基于 Linux 的容器设置为 Azure Pipelines 代理。
- en: Setting up Linux containers as Azure Pipelines agents
  id: totrans-274
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置 Linux 容器作为 Azure Pipelines 代理
- en: In order to use Linux containers as Azure pipeline agents, you can either use
    the Docker image published by Microsoft on Docker Hub or build your own Docker
    image.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将 Linux 容器用作 Azure 管道代理，你可以选择使用 Microsoft 在 Docker Hub 上发布的 Docker 镜像，或者自行构建
    Docker 镜像。
- en: 'Microsoft''s Azure pipeline agent image is available here: [https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent).
    You can directly run this image with environment variables, including information
    about your Azure DevOps organization:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: Microsoft 的 Azure 管道代理镜像可以在此找到： [https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent)。你可以直接运行此镜像，并通过环境变量传入
    Azure DevOps 组织的相关信息：
- en: '[PRE6]'
  id: totrans-277
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '[PRE7]'
  id: totrans-278
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[PRE8]'
  id: totrans-279
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '[PRE9]'
  id: totrans-280
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Alternatively, you can also choose to build your own Docker image to use for
    your Pipelines agents. The process is similar to building an image for Windows
    containers. Please refer to the Microsoft docs here – [https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops)
    – for reference to the entry point script.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，你也可以选择构建自己的 Docker 镜像来作为你的管道代理使用。该过程类似于为 Windows 容器构建镜像。请参考 Microsoft 文档：[https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops](https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops)
    – 获取有关入口点脚本的参考。
- en: Using Azure Container Instances as agents
  id: totrans-282
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Azure 容器实例作为代理
- en: '**Azure Container Instances** (**ACI**) is a managed service to run Windows
    and Linux containers in the Azure cloud. If standard Microsoft-hosted agents don''t
    fit your needs (requirements, performances, and so on) and you do not have sufficient
    infrastructure to host the container on-premises, you can use ACI to create a
    self-hosted agent for Azure DevOps.'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: '**Azure 容器实例** (**ACI**) 是一种托管服务，可以在 Azure 云中运行 Windows 和 Linux 容器。如果标准的 Microsoft
    托管代理不符合你的需求（如要求、性能等），而且你没有足够的基础设施来在本地托管容器，你可以使用 ACI 来为 Azure DevOps 创建自托管代理。'
- en: You can create a build agent running on ACI by using a custom image or reusing
    one of Microsoft's images that are available.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过使用自定义镜像或重用 Microsoft 提供的镜像之一，在 ACI 上创建构建代理。
- en: 'You''ll need the Azure DevOps account name, personal access token, and agent
    name to run an Azure pipeline agent in ACI. When you have the required details,
    you can create an agent on ACI by executing the following command from the Azure
    CLI (after connecting to your Azure subscription):'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 要在 ACI 上运行 Azure 管道代理，你需要 Azure DevOps 账户名、个人访问令牌和代理名称。获取所需的详细信息后，你可以通过在 Azure
    CLI 中执行以下命令来创建 ACI 上的代理（在连接到你的 Azure 订阅后）：
- en: '[PRE10]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Here, we have the following:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们有以下内容：
- en: '`RESOURCE_GROUP_NAME` is the name of your resource group in Azure where you
    want to create this resource.'
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`RESOURCE_GROUP_NAME` 是你希望在 Azure 中创建该资源的资源组名称。'
- en: '`CONTAINER_NAME` is the name of the ACI container name.'
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`CONTAINER_NAME` 是 ACI 容器的名称。'
- en: '`AZURE_DEVOPS_ACCOUNT_NAME` is the name of your Azure DevOps account.'
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZURE_DEVOPS_ACCOUNT_NAME` 是你的 Azure DevOps 账户名。'
- en: '`PERSONAL_ACCESS_TOKEN` is the personal access token previously created.'
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PERSONAL_ACCESS_TOKEN` 是之前创建的个人访问令牌。'
- en: '`AGENT_NAME` is the name of the build agent that you want to create and that
    will be displayed on Azure DevOps.'
  id: totrans-292
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AGENT_NAME` 是你希望创建的构建代理名称，并将在 Azure DevOps 中显示。'
- en: 'In this command, there are also other two important parameters:'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 在此命令中，还有其他两个重要参数：
- en: 'The `--image` parameter is used to select the name of the Azure Pipelines image
    for creating your agent, as described here: [https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent).'
  id: totrans-294
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--image` 参数用于选择用于创建代理的 Azure Pipelines 镜像名称，如下所述：[https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent)。'
- en: The VSTS_POOL parameter is used to select the agent pool for your build agent.
  id: totrans-295
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: VSTS_POOL 参数用于选择你的构建代理池。
- en: Remember that you can start and stop an ACI instance by using the `az container
    stop` and `az container start` commands, and this can help you save money.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，你可以使用 `az container stop` 和 `az container start` 命令来启动和停止 ACI 实例，这可以帮助你节省成本。
- en: Let's take a look at some of the additional environment variables you can use
    with Azure pipeline agent-based containers.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们来看看你可以与 Azure 管道代理容器一起使用的一些额外环境变量。
- en: Environment variables
  id: totrans-298
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 环境变量
- en: 'Azure DevOps pipeline agents running on containers can be customized further
    by using additional environment variables. The environment variables and their
    purposes are described as follows:'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 运行在容器上的 Azure DevOps 管道代理可以通过使用额外的环境变量进一步自定义。环境变量及其目的如下所述：
- en: '`AZP_URL`: The URL of the Azure DevOps organization'
  id: totrans-300
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZP_URL`：Azure DevOps 组织的 URL'
- en: '`AZP_TOKEN`: Personal access token'
  id: totrans-301
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZP_TOKEN`：个人访问令牌'
- en: '`AZP_AGENT_NAME`: The name of your Azure pipeline agent'
  id: totrans-302
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZP_AGENT_NAME`：你的 Azure 管道代理名称'
- en: '`AZP_POOL`: Agent pool name (default value is `Default`)'
  id: totrans-303
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZP_POOL`：代理池名称（默认值为 `Default`）'
- en: '`AZP_WORK`: Work directory (default value is `_work`)'
  id: totrans-304
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZP_WORK`：工作目录（默认值为 `_work`）'
- en: In this section, we learned about using containers as your Azure pipeline agents
    for executing your pipeline jobs.
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一部分，我们了解了如何使用容器作为 Azure 管道代理来执行管道作业。
- en: Planning for scale – Azure VM scale sets as Azure pipeline agents
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 规划扩展 – Azure 虚拟机规模集作为 Azure 管道代理
- en: Azure VM scale sets are an Azure service that allow you to create and manage
    hundreds of identical VMs with the ability to automatically or manually scale
    the number of VMs. Azure VM scale sets can be used as Azure pipeline agents in
    a large-scale project where you need elastic capacity based on your Azure pipeline
    job execution workload.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 虚拟机规模集是 Azure 服务，允许你创建和管理数百个相同的虚拟机，具备自动或手动扩展虚拟机数量的能力。Azure 虚拟机规模集可以作为
    Azure 管道代理，适用于大规模项目，在这些项目中，你需要根据 Azure 管道作业执行负载的需求来动态扩展容量。
- en: Azure VM scale sets support up to 1,000 VMs in one scale set.
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 虚拟机规模集最多支持 1,000 个虚拟机。
- en: Planning for scale
  id: totrans-309
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 规划扩展
- en: 'Azure VM scale set-based agents can be auto-scaled based on your Azure Pipelines
    jobs demand at a given time. There are several reasons why scale set agents can
    be a better option, rather than using dedicated agents:'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 基于 Azure 虚拟机规模集的代理可以根据 Azure Pipelines 作业需求自动扩展。规模集代理相比专用代理有几个优势：
- en: You need more computer power (CPU and memory) at a certain time and this requirement
    fluctuates based on workload.
  id: totrans-311
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你在某个时刻需要更多的计算能力（CPU 和内存），而且这一需求会根据工作负载波动。
- en: Microsoft-hosted agents are not able to meet your pipeline requirements.
  id: totrans-312
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Microsoft 托管的代理无法满足你的管道需求。
- en: Your job runs for a long time or takes time to complete.
  id: totrans-313
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你的作业运行时间较长或需要较长时间才能完成。
- en: You wish to use the same agent for various jobs consecutively to take advantage
    of caching and so on.
  id: totrans-314
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你希望连续使用相同的代理来执行多个作业，以便利用缓存等功能。
- en: You don't want to run dedicated agents all the time as these incur costs.
  id: totrans-315
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你不想一直运行专用代理，因为这样会产生成本。
- en: You want to regularly update the image of VMs running jobs.
  id: totrans-316
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你希望定期更新运行作业的虚拟机镜像。
- en: Azure VM scale sets can automatically increase/decrease the number of pipeline
    agents available based on the current demand of Azure Pipelines. This helps you
    save money, as well as supports your scaling requirements.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 虚拟机规模集可以根据 Azure Pipelines 当前的需求自动增加/减少可用的管道代理数量。这有助于节省成本，并支持你的扩展需求。
- en: Creating an Azure VM scale set
  id: totrans-318
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建 Azure 虚拟机规模集
- en: 'In this section, we''ll create an Azure VM scale set to use as an Azure pipeline
    agent. Please note that Azure Pipelines requires the scale set to be created with
    certain configurations, so you may not be able to use an existing scale set:'
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将创建一个 Azure VM 扩展集，用作 Azure Pipeline 代理。请注意，Azure Pipelines 要求以特定配置创建扩展集，因此您可能无法使用现有的扩展集：
- en: Log in to the Azure portal and click on **+ Create a resource**.
  id: totrans-320
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录 Azure 门户并点击**+ 创建资源**。
- en: Search for `Virtual machine scale set`:![Figure 6.24 – A VM scale set in the
    Azure portal
  id: totrans-321
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 搜索 `虚拟机扩展集`：![图 6.24 – Azure 门户中的 VM 扩展集
- en: '](img/Figure_6.24_B16392.jpg)'
  id: totrans-322
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.24_B16392.jpg)'
- en: Figure 6.24 – A VM scale set in the Azure portal
  id: totrans-323
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.24 – Azure 门户中的 VM 扩展集
- en: Click **Create**.
  id: totrans-324
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建**。
- en: 'Fill in the values as described here:'
  id: totrans-325
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照此处描述的方式填写值：
- en: '--**Subscription**: Choose the subscription on which you wish to deploy this
    scale set.'
  id: totrans-326
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**订阅**：选择您希望部署此扩展集的订阅。
- en: '--**Resource group**: Choose an existing resource group or create a new one.'
  id: totrans-327
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**资源组**：选择现有的资源组或创建一个新组。
- en: '--**Virtual machine scale set name**: Identifier of your choice.'
  id: totrans-328
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**虚拟机扩展集名称**：您选择的标识符。
- en: '--**Region**: The Azure region of your choice; it is recommended to choose
    the one closest to you.'
  id: totrans-329
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**区域**：选择您选择的 Azure 区域；建议选择离您最近的区域。
- en: '--**Availability zone**: Recommended to choose all three for high availability.'
  id: totrans-330
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**可用性区域**：建议选择所有三个区域以实现高可用性。
- en: '--**Image**: Choose a supported Windows or Linux image for the Azure Pipelines
    agent.'
  id: totrans-331
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**镜像**：为 Azure Pipelines 代理选择一个支持的 Windows 或 Linux 镜像。
- en: '--**Azure Spot instance**: Can help in minimizing cost. Refer to [https://azure.microsoft.com/en-us/pricing/spot/](https://azure.microsoft.com/en-us/pricing/spot/)
    for details.'
  id: totrans-332
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**Azure Spot 实例**：可以帮助降低成本。详情请参阅[https://azure.microsoft.com/en-us/pricing/spot/](https://azure.microsoft.com/en-us/pricing/spot/)。
- en: '--**Size**: The VM size for your agents.'
  id: totrans-333
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**大小**：为您的代理选择虚拟机大小。
- en: '--**Authentication**: Username/password or SSH key:'
  id: totrans-334
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**身份验证**：用户名/密码或 SSH 密钥：
- en: '![Figure 6.25 – Creating a VM scale set'
  id: totrans-335
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 6.25 – 创建 VM 扩展集'
- en: '](img/Figure_6.25_B16392.jpg)'
  id: totrans-336
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.25_B16392.jpg)'
- en: Figure 6.25 – Creating a VM scale set
  id: totrans-337
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.25 – 创建 VM 扩展集
- en: 'Click **Next: Disks >**.'
  id: totrans-338
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步：磁盘 >**。
- en: You can customize the disk performance tier and encryption settings, and add
    additional disks if required. If you're unsure, accept the defaults and click
    **Next**.
  id: totrans-339
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以自定义磁盘性能层和加密设置，并在需要时添加额外的磁盘。如果不确定，接受默认设置并点击**下一步**。
- en: On the networking page, you can choose to connect the scale set to an existing
    virtual network if your scale set needs to access any of your network resources
    securely. Please ensure that **Use a load balancer** is set to **No** for the
    Azure Pipelines scale set. Once configured, click **Next**:![Figure 6.26 – Azure
    VM scale set load balancing settings
  id: totrans-340
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在网络页面上，如果您的扩展集需要访问任何网络资源并确保安全连接，您可以选择将扩展集连接到现有的虚拟网络。请确保**使用负载均衡器**设置为**否**，以用于
    Azure Pipelines 扩展集。配置完成后，点击**下一步**：![图 6.26 – Azure VM 扩展集负载均衡设置
- en: '](img/Figure_6.26_B16392.jpg)'
  id: totrans-341
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.26_B16392.jpg)'
- en: Figure 6.26 – Azure VM scale set load balancing settings
  id: totrans-342
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.26 – Azure VM 扩展集负载均衡设置
- en: On **Scaling**, provide an initial instance count and keep **Scaling policy**
    to **Manual**. Leave the other settings as the default and click **Next**:![Figure
    6.27 – Scale set settings
  id: totrans-343
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**扩展**部分，提供初始实例数量，并将**扩展策略**设置为**手动**。将其他设置保持为默认，点击**下一步**：![图 6.27 – 扩展集设置
- en: '](img/Figure_6.27_B16392.jpg)'
  id: totrans-344
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.27_B16392.jpg)'
- en: Figure 6.27 – Scale set settings
  id: totrans-345
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.27 – 扩展集设置
- en: On **Management**, ensure that **Upgrade mode** is set to **Manual**. Leave
    the other settings as the default and click **Next**:![Figure 6.28 – Scale set
    upgrade policy
  id: totrans-346
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**管理**部分，确保**升级模式**设置为**手动**。将其他设置保持为默认，点击**下一步**：![图 6.28 – 扩展集升级策略
- en: '](img/Figure_6.28_B16392.jpg)'
  id: totrans-347
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.28_B16392.jpg)'
- en: Figure 6.28 – Scale set upgrade policy
  id: totrans-348
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.28 – 扩展集升级策略
- en: On the **Health and Advanced Setting** page, optionally change any settings
    you want to customize for your environment. Click **Review and Create** once you're
    ready to start creating the scale set.
  id: totrans-349
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**健康和高级设置**页面上，您可以选择更改任何希望自定义的环境设置。准备好创建扩展集时，点击**审核并创建**。
- en: Once the validation is successful, click **Create** to start the deployment.
  id: totrans-350
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证成功后，点击**创建**以开始部署。
- en: It may take a few minutes for the deployment to complete. Please wait while
    the deployment finishes. One the VM scale set is ready, we'll set it up to be
    used as an Azure Pipelines agent.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 部署完成可能需要几分钟的时间。请耐心等待部署完成。虚拟机扩展集准备好后，我们将设置它作为 Azure Pipelines 代理使用。
- en: Setting up Azure pipeline agents with VM scale set
  id: totrans-352
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用虚拟机规模集设置 Azure 管道代理
- en: 'In the last section, we created a VM scale set. Now, we will set that up as
    an Azure pipeline agent:'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中，我们创建了一个虚拟机规模集。现在，我们将其设置为 Azure 管道代理：
- en: Log in to your Azure DevOps organization and browse to **Project Settings**
    > **Agent Pools**.
  id: totrans-354
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到你的 Azure DevOps 组织，进入 **项目设置** > **代理池**。
- en: Click on **Add Pool**.
  id: totrans-355
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **添加池**。
- en: 'Fill in the values as defined here:'
  id: totrans-356
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照这里定义的值填写：
- en: '--**Pool Type**: Virtual machine scale set'
  id: totrans-357
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**池类型**：虚拟机规模集
- en: '--**Project for Service Connections**: Choose your Azure DevOps project'
  id: totrans-358
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**服务连接的项目**：选择你的 Azure DevOps 项目
- en: '--**Azure Subscription**: Select the Azure subscription where you created the
    VM scale set:'
  id: totrans-359
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --**Azure 订阅**：选择你创建虚拟机规模集的 Azure 订阅：
- en: '![Figure 6.29 – Adding an agent pool for the scale set'
  id: totrans-360
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 6.29 – 为规模集添加代理池](img/Figure_6.29_B16392.jpg)'
- en: '](img/Figure_6.29_B16392.jpg)'
  id: totrans-361
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.29_B16392.jpg)'
- en: Figure 6.29 – Adding an agent pool for the scale set
  id: totrans-362
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.29 – 为规模集添加代理池
- en: Click **Authorize** to enable access to your Azure subscription. You may be
    asked to log in to your Azure account in this process.
  id: totrans-363
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **授权**，以启用对你 Azure 订阅的访问权限。你可能会被要求在此过程中登录到 Azure 帐户。
- en: 'Once authenticated, select an existing VM scale set and fill in the values
    as described here:'
  id: totrans-364
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证身份后，选择一个现有的虚拟机规模集，并按照这里描述的值填写：
- en: --The name and description of your choice for this agent pool.
  id: totrans-365
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --你选择的代理池的名称和描述。
- en: --Optionally, configure the scale set to delete the VM after each execution.
  id: totrans-366
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --可选地，配置规模集在每次执行后删除虚拟机。
- en: --The maximum number of VMs.
  id: totrans-367
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --虚拟机的最大数量。
- en: --The number of agents to keep as standby. While this can help you in completing
    jobs quickly, it may increase your Azure cost.
  id: totrans-368
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: --保留备用的代理数量。虽然这有助于更快地完成任务，但可能会增加你的 Azure 成本。
- en: Click **Create** once you have filled in all the values:![Figure 6.30 – Creating
    a scale set-based agent pool
  id: totrans-369
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 填写完所有值后，点击 **创建**：[![图 6.30 – 创建基于规模集的代理池](img/Figure_6.30_B16392.jpg)]
- en: '](img/Figure_6.30_B16392.jpg)'
  id: totrans-370
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/Figure_6.29_B16392.jpg)'
- en: Figure 6.30 – Creating a scale set-based agent pool
  id: totrans-371
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 6.30 – 创建基于规模集的代理池
- en: 'Your agent pool creation will now start. Please note that it may take around
    15 minutes before your agent pool is ready to take up the jobs. You should see
    the agents live in your agent pool upon completion:'
  id: totrans-372
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，代理池的创建将开始。请注意，代理池准备好接收任务可能需要大约 15 分钟。在完成时，你应该能看到代理池中的代理处于活动状态：
- en: '![Figure 6.31 – Agents'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 6.31 – 代理](img/Figure_6.30_B16392.jpg)'
- en: '](img/Figure_6.31_B16392.jpg)'
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_6.31_B16392.jpg)'
- en: Figure 6.31 – Agents
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
  zh: 图 6.31 – 代理
- en: Once your agent pool is ready, you can update your Azure pipeline to start using
    this pool for job execution.
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦代理池准备就绪，你可以更新你的 Azure 管道，开始使用这个池来执行任务。
- en: Summary
  id: totrans-377
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we looked at using Microsoft-hosted agents and self-hosted
    agents to run your Azure pipeline jobs. We dug deep into the process of setting
    up a self-hosted agent and updated our pipelines to use the self-hosted agent.
  id: totrans-378
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们讨论了如何使用微软托管的代理和自托管代理来运行你的 Azure 管道任务。我们深入了解了设置自托管代理的过程，并更新了管道以使用自托管代理。
- en: We also looked at how you can use Docker containers, Azure container instances,
    and Azure VM scale sets as your Azure pipeline agents. With this chapter, you
    should be able to plan and implement the appropriate pipeline agent solution for
    your projects
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还讨论了如何使用 Docker 容器、Azure 容器实例和 Azure 虚拟机规模集作为你的 Azure 管道代理。通过本章内容，你应该能够为你的项目规划并实现适当的管道代理解决方案。
- en: In the next chapter, we'll learn about Artifacts in Azure DevOps.
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将学习 Azure DevOps 中的工件（Artifacts）。
