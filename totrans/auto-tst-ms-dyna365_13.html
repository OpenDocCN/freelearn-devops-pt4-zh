<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Getting Business Central Standard Tests Working on Your Code</h1>
                </header>
            
            <article>
                
<p>Now you know how to write your automated tests and have integrated them in your daily development practice, how could you also take profit from this humongous collateral of tests Microsoft have provided? This chapter shows you how to add them to your own collateral. We'll discuss:</p>
<ul>
<li>Why to use the standard tests</li>
<li>Executing standard tests</li>
<li>Fixing failing standard tests</li>
<li>Making your code testable</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Why use the standard tests?</h1>
                </header>
            
            <article>
                
<p>Ever since they introduced the testability framework in 2009, Microsoft have been building on their application test collateral. As already pointed out in <a href="fdf2b65f-be7c-4710-a3a9-39f4cc34ee5c.xhtml" target="_blank">Chapter 3</a>, <em>The Test Tool and Standard Tests</em>, it contains an immense number of tests. These tests cover the whole standard application, from financial management, sales and purchase, through warehouse and manufacturing, to service management. With every major release or cumulative update, new tests have been and will continue to be added to cover new features and recent bug fixes. Years of work we all can profit from. If your code extends the standard application, what will be the impact of it on the standard application?</p>
<p>You could go about writing your own tests. You could also choose to run the standard tests and see the results. And, of course, in the end, you could do both, as your extension most probably will not only change standard behavior, but also add new functionality not covered by any test in the Microsoft collateral.</p>
<p>We could discuss a lot and bang each other's heads on the validity of running the Microsoft tests, but instead we could just as well run them and see if our code makes the standard tests fail. This is exactly what I did years ago as my first step in structurally picking up test automation for Business Central. Those that have been following my blog might recall that, some years ago, I dedicated a post on this called <em>How-to: Run Standard Tests against Your Code</em>. As the title clearly unveils, it discusses the steps to take to get the standard tests run on your solution. Go there, read it, execute, and examine the results. There is little or no reason not to do this. Within 30 minutes, you will have the tests running. And within a couple of hours, you will have the results. The next chart shows our results where only 23% of the standard tests were successful (the dark spikes):</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-784 image-border" src="assets/b4b94c61-248f-466a-8212-2fbd26363e2f.png" style="width:117.42em;height:34.92em;"/></p>
<div class="packt_infobox">Here is where you can find my post: <a href="https://dynamicsuser.net/nav/b/vanvugt/posts/how-to-run-standard-tests-against-your-code">https://dynamicsuser.net/nav/b/vanvugt/posts/how-to-run-standard-tests-against-your-code</a><a href="https://dynamicsuser.net/nav/b/vanvugt/posts/how-to-run-standard-tests-against-your-code"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Executing standard test</h1>
                </header>
            
            <article>
                
<p>The proof is in eating the pudding, so let's effectuate it as follows:</p>
<ol>
<li>Deploy the solution we built and tested in <a href="13a9d0b2-ae46-45ba-8790-8489439e70fc.xhtml" target="_blank">Section 3</a>, <em>Designing and Building Automated Tests for</em> <em>Microsoft Dynamics 365 Business Central</em>, to Business Central</li>
<li>Import the standard tests</li>
</ol>
<ol start="3">
<li>Set up a test suite in the test tool using the <span class="packt_screen">All Test Codeunits</span> option, as discussed in <a href="fdf2b65f-be7c-4710-a3a9-39f4cc34ee5c.xhtml" target="_blank">Chapter 3</a>, <em>The Test Tool and Standard Tests</em></li>
<li>Run all the tests</li>
</ol>
<p>As it will take a couple of hours, we'll make a jump in time and have a look at the results. Out of the almost 23,000 tests, more than 3,000 have failed.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What does this tell us?</h1>
                </header>
            
            <article>
                
<p>First of all, as 3,000 is quite a substantial number of failures, this should mainly be related to our extension for the following reasons:</p>
<ul>
<li>Running standard tests on standard Business Central always throws a number of errors.</li>
<li>This number might be a couple of hundred and some of them have to do with environmental settings, like not having permission to write data to a file.</li>
<li>As automated tests are also code, there might even be bugs in a couple of them. 3,000 plus tests failing, however, is way beyond a couple of hundred.</li>
</ul>
<p>Secondly, this means that a major number of standard tests do hit our code. Using the t<span>e</span><span>st coverage map,</span> <span>we can find out what test codeunits indeed do touch our extension and add them to our own test collateral we have built so far. But, of course, only if we can fix them.</span></p>
<div class="packt_infobox">Until now, we have been using the Business Central web client to run our tests. In this chapter, we will be making use of the Windows client and debugger, as the web client cannot handle running thousands of tests very well at this point in time. And, with the display and manipulation of all the test function lines, the test tool isn't, unfortunately, your best friend.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Fixing failing standard tests</h1>
                </header>
            
            <article>
                
<p>Let's have a look at some of the errors that relate to the extension. They might already unclose some of their secrets:</p>
<pre>Lookup Value Code must have a value in Sales Header: Document Type=Invoice, No.=1004. It cannot be zero or empty.<br/><br/>Assert.ExpectedError failed. Expected: . Actual: Lookup Value Code must have a value in Sales Header: Document Type=Order, No.=1001. It cannot be zero or empty.<br/><br/>Assert.ExpectedError failed. Expected: The total amount for the invoice must be 0 or greater.. Actual: Lookup Value Code must have a value in Sales Header: Document Type=Order, No.=1001. It cannot be zero or empty.</pre>
<p>With approximately 2,500 hits, the first error is the most striking one. And for those of you with some years as a developer in the Business Central world, it may already hint at its cause: the format of the error message is typically the error the record method <kbd>TestField</kbd> throws. Clearly this is an error that was not expected in any of the failing tests.</p>
<p>The two other errors were caught by <kbd>asserterror</kbd> and picked out by the <kbd>ExpectedError</kbd> method of the <kbd>Assert</kbd> library as part of the verification of the test concerned. Looking closer at the <em>Actual</em> error message, we can recognize that it's the same type of error as the first one. Most likely the same <kbd>TestField</kbd>.</p>
<p>Now let's handle the errors. This is what I call my <em>attack</em> protocol:</p>
<ol>
<li>Open the test tool and select the failing test</li>
<li>Start up a debug session</li>
<li>Run the individual test using <span class="packt_screen">Run Selected</span></li>
<li>Let the debugger break on the error</li>
<li>See where the error occurred</li>
<li>Use the Call Stack to step back in the code and see if you can already distinguish the cause, or if you want to get some more details</li>
<li>Place a breakpoint somewhat earlier in the code</li>
<li>Finish the code execution and rerun the test</li>
<li>Debug by stepping through the code</li>
<li>Implement the fix and restart from <em>Step 1</em></li>
</ol>
<p>OK, follow me in attacking the most occurring error on our list first.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attacking the error</h1>
                </header>
            
            <article>
                
<p>For attacking the error, we need to take the following steps:</p>
<ol>
<li>Open the test tool and select the failing test.<br/>
In our case, take out any test that fails with the <kbd>Lookup Value Code must have a value…</kbd> error, the first of the three errors listed previously:</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-786 image-border" src="assets/af49e852-44c3-49c2-ac9f-f29de41f4194.png" style="width:116.25em;height:59.33em;"/></p>
<ol start="2">
<li>Start up a debug session:</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-787 image-border" src="assets/e19e0507-af20-437a-96d8-bdfb621ee245.png" style="width:94.00em;height:51.42em;"/></p>
<ol start="3">
<li>Run the individual test using <span><span class="packt_screen">Run Selected</span>:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><em><img class="alignnone size-full wp-image-788 image-border" src="assets/2b8fe29a-6b23-4b45-ad80-7f7a56400ad0.png" style="width:116.33em;height:59.50em;"/><br/></em></p>
<ol start="4">
<li>Let the debugger break on the error:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-789 image-border" src="assets/51499435-32ca-408b-b95e-1b4704011547.png" style="width:110.58em;height:59.83em;"/></p>
<ol start="5">
<li>See where the error occurred. See where the error occurred<br/>
It clearly happens in an object in our extension. It might not be familiar to you as we haven't had a look at this code yet. It's the implementation of the business rule when posting a sales document, it is mandatory that the <kbd>Lookup Value Code</kbd> field is populated. See the call to the <kbd>TestField</kbd> method:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-790 image-border" src="assets/0d6526b0-d65a-4dc2-a381-5ac41e78a9e8.png" style="width:116.42em;height:53.83em;"/></p>
<ol start="6">
<li>Use the call stack to step back in the code.<br/>
Notice that I selected the line on the call stack just above the line with <kbd>RunTest</kbd>. <kbd>RunTest</kbd> is the main function in the standard test runner codeunit (130400) that calls each test codeunit. The line on top of that is always the call to the current test function. In this specific case <kbd>TestCustNoMatchOutsideThreshold</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-791 image-border" src="assets/fc7a4efe-ba96-4875-8b51-f485922371d3.png" style="width:116.50em;height:59.75em;"/></p>
<p style="padding-left: 60px">Having jumped to <kbd>TestCustNoMatchOutsideThreshold</kbd> and knowing what my extension is about, the statement line with <kbd>CreateCustomer</kbd>, four lines above the green pointer, triggers me. Apparently, a local method exists that creates a customer as part of the <em>fresh fixture</em>. I bet my money <span>on it</span><span>, all my money, that this customer did not get a</span> <kbd>Lookup Value</kbd> <span>assigned. Inspecting the variable</span> <kbd>Customer</kbd><span> as follows, shows me that I'm right:</span></p>
<p class="mce-root CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-792 image-border" src="assets/e9c208f9-bc2e-4c8e-ab5a-6437d91628f8.png" style="width:59.58em;height:35.25em;"/></p>
<ol start="7">
<li>Place a breakpoint somewhat earlier in the code.<br/>
You might have guessed already,<span> </span>at the line calling <kbd>CreateCustomer</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-793 image-border" src="assets/c389dba6-5a24-45d7-8e8e-9515f99ce4bd.png" style="width:116.42em;height:59.50em;"/></p>
<ol start="8">
<li>Finish the code execution and rerun the test.<br/>
As planned it stops at the <kbd>CreateCustomer</kbd> call<span>:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-794 image-border" src="assets/ac537e61-d589-4c41-9676-74611a514a00.png" style="width:116.58em;height:59.58em;"/></p>
<ol start="9">
<li>Debug by stepping through the code.<br/>
We take a big step now by skipping the local <kbd>CreateCustomer</kbd> method to the generic helper method <kbd>CreateCustomer</kbd> in the <kbd>Library - Sales</kbd><span> codeunit:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-795 image-border" src="assets/f57527be-d23b-4bce-a48e-b2067bc61da3.png" style="width:116.42em;height:59.83em;"/></p>
<p style="padding-left: 60px">And typically this is where we would like to fix our issue. Typically this helper function will be called upon from almost any test that is needing a newly created customer. Notice the <kbd>OnAfterCreateCustomer</kbd> publisher. Our fix will contain a subscriber to it.</p>
<ol start="10">
<li class="CDPAlignLeft CDPAlign">Implement the fix and restart from <em>Step 1</em>. We will elaborate on this in the following sections.</li>
</ol>
<div class="packt_infobox">Only recently, Microsoft has started to add publishers like <kbd>OnAfterCreateCustomer</kbd> to helper functions in their libraries. You might still run into quite a number of helpers that have not yet been <em>blessed</em> with a publisher.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Fixing the error</h1>
                </header>
            
            <article>
                
<p>To fix the error, the trick is to add a codeunit to our extension with a subscriber to the <kbd>OnAfterCreateCustomer</kbd> publisher that sets a lookup value on the customer:</p>
<pre>codeunit 80050 "Library - Sales Events"<br/>{<br/>    [EventSubscriber(ObjectType::Codeunit,<br/>       Codeunit::"Library - Sales", 'OnAfterCreateCustomer',<br/>        '', false, false)]<br/>    local procedure OnAfterCreateCustomerEvent(<br/>                        var Customer: Record Customer)<br/>    begin<br/>        SetLookupValueOnCustomer(Customer);<br/>    end;<br/><br/>    local procedure SetLookupValueOnCustomer(<br/>                        var Customer: record Customer)<br/>    var<br/>        LibraryLookupValue: Codeunit "Library - Lookup Value";<br/>    begin<br/>        with Customer do begin<br/>            Validate("Lookup Value Code",<br/>                LibraryLookupValue.CreateLookupValueCode());<br/>            Modify();<br/>        end;<br/>    end;<br/>}</pre>
<p>Note the reference to the codeunit <kbd>Library - Lookup Value</kbd>. This is the result of the discussion on refactoring at the end of <a href="bb9ee41e-4c60-4a27-8fad-5343adfcd86a.xhtml" target="_blank">Chapter 7</a>, <em>From Customer Wish to Test Automation - And Some More</em>. The <kbd>Library - Lookup Value</kbd> contains a reusable function <kbd>CreateLookupValueCode</kbd>. Go to GitHub to have a look at the details.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running the failing tests again</h1>
                </header>
            
            <article>
                
<p>Deploy everything again and rerun all the failing tests. Use the <span class="packt_screen">Select on Failures</span> feature from our test tool extension to select only the failing tests. It will take a while before 3,000 plus tests have been processed. The result will be that the amount of failing tests has declined to 559. Clearly this fix was a good investment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Viewing the call stack from the test tool</h1>
                </header>
            
            <article>
                
<p>If you're not debugging your failing test but would like to have a look at the call stack right from the test tool, drill down from the <span class="packt_screen">First Error</span> field into the <span class="packt_screen">CAL Test Results</span> window as shown already in <a href="56634efe-664c-421a-9582-b2a6ae69722a.xhtml" target="_blank">Chapter 5</a>, <em>From Customer Wish to Test Automation - The Basics</em>. Then<em> </em>select the <span class="packt_screen">Call Stack</span> action. In the next screenshot, the call stack is displayed for the <kbd>TestCustNoMatchOutsideThreshold</kbd> test we were examining already:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-796 image-border" src="assets/d9398167-65a7-4ff2-b6a6-87fb03f970b2.png" style="width:69.33em;height:36.83em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">It's all about data</h1>
                </header>
            
            <article>
                
<p>In my experience, getting the standard tests working on your code is mainly about getting the test fixture right. As in the previous exercise, fixing the first error on our list isn't a coincident. It's a plain example of what you will be doing in getting the standard tests run on your code: bring the test fixture in the right state. In this specific case, we fixed the fresh fixture. Solving the remaining errors is again about updating the test fixture. In those cases, it concerns the shared fixture.</p>
<p>Looking closer at the remaining failing tests, it seems that our first error did not completely vanish. Saving you the trouble of going through all of them, I have picked out the following three failing tests:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-797 image-border" src="assets/6b4eafef-7346-4446-bab3-0e1686839db8.png" style="width:116.33em;height:52.25em;"/></p>
<p>Apparently, our generic fix for the <kbd>CreateCustomer</kbd> helper method did not have any effect on these. Debugging each of them shows eventually that the prebuilt fixture, that is, data from the <kbd>CRONUS</kbd> demo company, is being used. Taking the first test, <kbd>PartialDisposalOfFA</kbd> from test codeunit 134450 (<kbd>ERM Fixed Assets Journal</kbd>), shows the obvious. Have a look:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-798 image-border" src="assets/6b4849d6-ad00-45da-95b0-d3d388cf5d24.png" style="width:94.08em;height:44.83em;"/></p>
<p>Within a set of filters, the first customer record is retrieved from the database. Reading from the <span class="packt_screen">Watches</span> pane, it is a well-known customer in <kbd>CRONUS</kbd>, customer <kbd>10000</kbd>. As we haven't touched the prebuilt fixture, any customer record in <kbd>CRONUS</kbd> must do without a lookup value.</p>
<p>In the case of the other two test their errors also find root in an insufficient prebuilt fixture:</p>
<ul>
<li><kbd>SalesFromContactToPayment</kbd> in test codeunit 134640 (<kbd>Sales E2E</kbd>) makes use of a customer template from <kbd>CRONUS</kbd></li>
<li><kbd>PullAndPostMixedHeadersUsingUseFilters</kbd> in test codeunit 136140 (<kbd>Service Order Release</kbd>) retrieves a sales document from<span> </span><kbd>CRONUS</kbd></li>
</ul>
<p>The conclusion is that in all three cases we have to update the prebuilt fixture, that is, create a shared fixture, making sure that customers, customer templates, and sales documents already residing in <kbd>CRONUS</kbd> get their <kbd>Lookup Value Code</kbd> field populated. To achieve this we can make use of one of the publishers in the shared fixture method, <kbd>Initialize</kbd>, implemented in most of the Microsoft test functions. <span>You might recall from </span><a href="db955f66-11f4-4d9a-90c7-5af04058ebbe.xhtml" target="_blank">Chapter 4</a><span>, </span><em>Test Design</em><span>, this structure:</span></p>
<pre>local Initialize()<br/>// Generic Fresh Setup<br/>LibraryTestInitialize.OnTestInitialize(&lt;codeunit id&gt;);<br/>&lt;generic fresh data initialization&gt;<br/><br/>// Lazy Setup<br/>if isInitialized then<br/>  exit();<br/><br/>LibraryTestInitialize.OnBeforeTestSuiteInitialize(&lt;codeunit id&gt;);<br/>&lt;shared data initialization&gt;<br/>Initialized := true;<br/>Commit();<br/>LibraryTestInitialize.OnAfterTestSuiteInitialize(&lt;codeunit id&gt;);</pre>
<p>Either we subscribe to the <kbd>OnBeforeTestSuiteInitialize</kbd> or <kbd>OnAfterTestSuiteInitialize</kbd> publisher. In general, I chose to subscribe to the first one to make sure this is done before any standard update to the fixture is performed and to make use of the already present call on <kbd>Commit</kbd>.</p>
<p>This is how our fix implementation looks:</p>
<pre>codeunit 80051 "Library - Initialize"<br/>{<br/>    [EventSubscriber(ObjectType::Codeunit,<br/>         Codeunit::"Library - Test Initialize",<br/>         'OnBeforeTestSuiteInitialize','', false, false)]<br/>    local procedure OnBeforeTestSuiteInitializeEvent(<br/>             CallerCodeunitID: Integer)<br/>    begin<br/>        Initialize(CallerCodeunitID);<br/>    end;<br/><br/>    local procedure Initialize(CallerCodeunitID: Integer)<br/>    var<br/>        LibraryLookupValue: Codeunit "Library - Lookup Value";<br/>        LibrarySetup: Codeunit "Library - Setup";<br/>    begin<br/>        case CallerCodeunitID of<br/>            Codeunit::"ERM Fixed Assets Journal",<br/>            Codeunit::"ERM Fixed Assets GL Journal":<br/>                LibrarySetup.UpdateCustomers(<br/>                  LibraryLookupValue.CreateLookupValueCode());<br/>            Codeunit::"Service Order Release":<br/>                LibrarySetup.UpdateSalesHeader(<br/>                  LibraryLookupValue.CreateLookupValueCode());<br/>            Codeunit::"Sales E2E":<br/>                LibrarySetup.UpdateCustomerTemplates(<br/>                  LibraryLookupValue.CreateLookupValueCode());<br/>        end;<br/>    end;<br/>}</pre>
<p>Notice this code also fixes the errors thrown by tests in codeunit 134453 (<kbd>ERM Fixed Assets GL Journal</kbd>) by updating the existing records in the <kbd>Customer</kbd> table.</p>
<p>The three newly introduced helper functions in the new library codeunit <kbd>Library - Setup</kbd> do exactly what their names describes:</p>
<ul>
<li><kbd>UpdateCustomers</kbd> updates all customer records already existing in <kbd>CRONUS</kbd> so their <kbd>Lookup Value Code</kbd> field is populated</li>
<li><kbd>UpdateCustomerTemplates</kbd> and <kbd>UpdateSalesHeader</kbd> do the same with respect to all customer templates and sales headers</li>
</ul>
<p>Go to GitHub to study the details of each of these functions.</p>
<p>Ready? Almost.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making your code testable</h1>
                </header>
            
            <article>
                
<p>We were looking at getting standard tests fixed and we did. But at the same time we did overlook that fixing them made a pair of our own tests fall over. Do you see?</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-799 image-border" src="assets/4ce6a9a4-974f-43d5-b663-fe474acfd9cf.png" style="width:116.17em;height:52.33em;"/></p>
<p>We have two failing tests and in the same codeunit <kbd>LookupValue Posting</kbd>:</p>
<ul>
<li><kbd>PostSalesOrderWithNoLookupValue</kbd></li>
<li><kbd>PostWarehouseShipmentFromSalesOrderWithNoLookupValue</kbd></li>
</ul>
<p>This is their error text:</p>
<pre>Microsoft.Dynamics.Nav.Types.Exceptions.NavNCLAssertErrorException: An error was expected inside an ASSERTERROR statement.\   at Microsoft.Dynamics.Nav.Runtime.NavMethodScope.AssertError(Action body)\   at Microsoft.Dynamics.Nav.BusinessApplication.C</pre>
<p>Without debugging, this information already tells me a whole story. This is confirmed by the code of the first test method:</p>
<pre>procedure PostSalesOrderWithNoLookupValue();<br/>//[FEATURE] LookupValue Posting Sales Document<br/>var<br/>    SalesHeader: Record "Sales Header";<br/>    PostedSaleInvoiceNo: Code[20];<br/>    SalesShipmentNo: Code[20];<br/>begin<br/>    //[SCENARIO #0027] Check posting throws error on sales<br/>    //                 order with empty lookup value<br/>    Initialize();<br/><br/>    //[GIVEN] A sales order without a lookup value<br/>    CreateSalesOrder(SalesHeader, UseNoLookupValue());<br/>    //[WHEN] Sales order is posted (invoice &amp; ship)<br/>    asserterror PostSalesDocument(<br/>                    SalesHeader,<br/>                    PostedSaleInvoiceNo,<br/>                    SalesShipmentNo);<br/>    //[THEN] Missing lookup value on sales order error thrown<br/>    VerifyMissingLookupValueOnSalesOrderError(SalesHeader);<br/>end;</pre>
<p>The <kbd>asserterror</kbd> is placed here to catch an error supposedly expected to be thrown by <kbd>PostSalesDocument</kbd>. And this is precisely what the test error message is hinting at. The fact that we get the error means that there did not occur an error at all. The expected error should have been reporting that the <kbd>SalesHeader</kbd>, being posted, was missing a lookup value. This is the one-fold goal of <kbd>PostSalesOrderWithNoLookupValue</kbd> (see also the <kbd>[THEN]</kbd> tag).</p>
<p>The very reason that no error is happening, is that the <kbd>Lookup Value Code</kbd> field on the <kbd>SalesHeader</kbd> record is empty. This is due to our generic fix we implemented a number of pages back, where we extended the <kbd>CreateCustomer</kbd> helper method by means of our subscriber <kbd>OnAfterCreateCustomerEvent</kbd>. Leaving it to you to dig into the details on GitHub, I will only mention here that the customer linked to the <kbd>SalesHeader</kbd> record is created by the standard <kbd>CreateCustomer</kbd> helper method. As this is triggered by our test, it yields a result opposite to what was intended. How do we go about resolving the errors?</p>
<p>Removing the <kbd>OnAfterCreateCustomerEvent</kbd> subscriber is not an option as it's there to get 2,500 standard tests to succeed. We could, however, try to disable the subscriber when our own tests run. Or using another term: we could <em>mock</em> the behavior of the subscriber by applying the <em>Handled pattern</em>. In solving our issue as follows, we will apply a variation on this pattern.</p>
<div class="packt_infobox">Read more on the Handled pattern here:<br/>
<a href="https://markbrummel.blog/2015/11/25/the-handled-pattern/">https://markbrummel.blog/2015/11/25/the-handled-pattern/</a> and <a href="https://community.dynamics.com/nav/b/navigateintosuccess/archive/2016/10/04/gentlemen-s-agreement-pattern-or-handling-the-handled-pattern">https://community.dynamics.com/nav/b/navigateintosuccess/archive/2016/10/04/gentlemen-s-agreement-pattern-or-handling-the-handled-pattern</a><a href="https://community.dynamics.com/nav/b/navigateintosuccess/archive/2016/10/04/gentlemen-s-agreement-pattern-or-handling-the-handled-pattern"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Applying the Handled pattern</h1>
                </header>
            
            <article>
                
<p>A test codeunit that wants to circumvent the effect of the subscriber creates a record in this table as part of their shared fixture, and check marks a Boolean field, which will be called <kbd>Skip OnAfterCreateCustomer</kbd>. Check marking this field in the <kbd>OnAfterCreateCustomerEvent</kbd> subscriber will enable us to execute the subscriber in its full extend, or to just skip it. This is how the subscriber has been updated:</p>
<pre>[EventSubscriber(ObjectType::Codeunit,<br/>    Codeunit::"Library - Sales", 'OnAfterCreateCustomer',<br/>    '', false, false)]<br/>local procedure OnAfterCreateCustomerEvent(<br/>                    var Customer: Record Customer)<br/>var<br/>    LibraryTestsSetup: Codeunit "Library - Tests Setup";<br/>begin<br/>    if LibraryTestsSetup.SkipOnAfterCreateCustomer() then<br/>        exit;<br/><br/>    SetLookupValueOnCustomer(Customer);<br/>end;</pre>
<p>The helper function <kbd>SkipOnAfterCreateCustomer</kbd>, part of a new library codeunit called <kbd>Library - Tests Setup</kbd>, will check the <kbd>Skip OnAfterCreateCustomer</kbd> field in our new setup table:</p>
<pre>procedure SkipOnAfterCreateCustomer(): Boolean<br/>var<br/>    TestsSetup: Record TestsSetup;<br/>begin<br/>    with TestsSetup do begin<br/>        Get();<br/>        exit("Skip OnAfterCreateCustomer");<br/>    end;<br/>end;</pre>
<p>The only step to be taken is to add the following code to the relevant <kbd>Initialize</kbd> function:</p>
<pre>local procedure Initialize()<br/>var<br/>    LibraryTestsSetup: Codeunit "Library - Tests Setup";<br/>begin<br/>    if isInitialized then<br/>        exit;<br/>    LibraryTestsSetup.SetSkipOnAfterCreateCustomer(true);<br/>    LocationSetup();<br/><br/>    isInitialized := true;<br/>    Commit();<br/>end;</pre>
<p>This is one of the ways of making code testable. In this example, we applied it to test code, but in a similar matter, you can apply it to application code. By inserting publishers into your code, you enable subscribers to take control of the process flow, like for example form you test code.</p>
<div class="packt_infobox">As you might know, Dynamics 365 Business Central allows you to bind and unbind subscriber on the fly given the right circumstances. Alas, in the case of our tests, this was not feasible as we are not fully in control of the standard test codeunits.<br/>
<br/>
Read more on binding subscribers here: <a href="https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/methods-auto/session/session-bindsubscription-method">https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/methods-auto/session/session-bindsubscription-method</a></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Is it all really about data?</h1>
                </header>
            
            <article>
                
<p>Of course not. But in the majority of the cases of failing standard tests, it worked out that way for me. Based on this experience, my best practice in getting a failing standard test fixed is the following sequence. Try fixing the error by adjusting:</p>
<ol>
<li>The shared fixture; if that does not do the job.</li>
<li>The fresh fixture; if not.</li>
<li>The test code, often the verification part, in this case you hit upon a test code bug; if still not working.</li>
<li>The app code, you found a <em>real</em> bug!</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you learned why you would want to use the Microsoft tests, how to start applying them on your Business Central code, and how to fix the errors they might throw. You learned that most fixes relate to adjusting the test fixture, be it <em>shared</em> or <em>fresh</em>.</p>
<p>With this chapter, the book has come to an end. But your journey into test automation has just started. To me, every time it's still fun to pick up. It enables me to go astray in my application code, finding the results of my test recalling me. It allows me to refactor my code at any time. It also enables me to more easily reflect on the quality of the code, because it can be changed and instantly checked. I could go on with my praising and more or less redo the first chapter of this book. But I won't, as it is time to conclude for now. I hope you enjoyed reading and practising with me, as much as I did while writing.</p>


            </article>

            
        </section>
    </body></html>