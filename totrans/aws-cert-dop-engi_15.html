<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer193">
			<h1 id="_idParaDest-329"><a id="_idTextAnchor338"/>Chapter 13: Blue Green Deployments</h1>
			<p>Releasing applications by shifting traffic between two identical environments is better known as using blue/green deployments. Knowing how to use blue/green deployments through the different AWS service offerings can help mitigate risk when releasing new versions of an application. Walking through the various techniques for the various services and understanding the usage of each is essential to passing the AWS DevOps Professional exam.</p>
			<p>In this chapter, we're going to cover the following main topics: </p>
			<ul>
				<li>Understanding the concept of blue/green deployments </li>
				<li>AWS services that you can use for blue/green deployments</li>
				<li>Benefits of blue/green with AWS </li>
				<li>Updating Auto Scaling group launch configurations </li>
				<li>Using best practices in your data tier with blue/green deployments </li>
			</ul>
			<h1 id="_idParaDest-330"><a id="_idTextAnchor339"/>Understanding the concept of blue/green deployments </h1>
			<p>When you use the blue/green deployment<a id="_idIndexMarker1168"/> technique, you employ a technique that reduces downtime and risk. You do this by running a duplicated environment where one is taking the active traffic and the other is receiving the changes. Once the changes have been completed and any testing has been commenced, the traffic that was previously directed at the initial environment, the blue environment, can then be switched over to the green environment. This switch can happen all at once or in gradual phases, depending on both your deployment plan and the services that you use in your deployment. If there is any issue with the deployment, then you can quickly reroute the traffic back to the previously known good state environment, the blue environment, while you remediate the new environment. </p>
			<p>The foundation of blue/green deployments<a id="_idIndexMarker1169"/> is two distinct environments. One environment, the <em class="italic">blue environment</em>, refers to the current<a id="_idIndexMarker1170"/> environment where your application or workload is currently running. The second environment, or the <em class="italic">green environment</em>, refers to a duplicated environment where you can<a id="_idIndexMarker1171"/> deploy your updated changes to your application code or workload. Using both of these separate environments in symphony allows for near zero-downtime release and rollback proficiencies. </p>
			<p>When you perform a blue/green deployment, you are working with an immutable infrastructure. This means that you are not upgrading or updating the current infrastructure in place. Instead, you are creating a new set of resources for each deployment process. </p>
			<h2 id="_idParaDest-331"><a id="_idTextAnchor340"/>Deployments are not easy</h2>
			<p>Traditional deployments favor in-place upgrades. However, with in-place upgrades, there are many risk factors<a id="_idIndexMarker1172"/> to consider:</p>
			<ul>
				<li>Resource constraints</li>
				<li>Potential downtime</li>
				<li>Dependencies from other systems </li>
				<li>Difficulties in rolling back unsuccessful deployments </li>
			</ul>
			<p>With the cost and complexity involved in the deployment process, teams will sometimes choose to deploy to an existing infrastructure. This is a viable deployment strategy, but it contains inherent risks, especially when performing a deployment such as an all-at-once deployment where all of the instances or applications are updated simultaneously. If there was an issue or failure during the deployment, this often leads to downtime, loss of revenue, loss of trust in the product brand, and loss of customer confidence, depending on how long the outage lasts.</p>
			<p class="callout-heading">Question</p>
			<p class="callout">When starting to map out a deployment, try and ask yourself, <em class="italic">What solutions reduce downtime, handle dependencies, and can coordinate workloads in an improved manner?</em></p>
			<p>There are multiple risks to navigate when performing deployments, including the following:</p>
			<ul>
				<li>Application failure </li>
				<li>Infrastructure failure </li>
			</ul>
			<p>Using blue/green deployment strategies helps mitigate these risks and business impacts by allowing an almost seamless cutover from one environment to the next. </p>
			<p>The term <em class="italic">environment</em> is used a great deal when<a id="_idIndexMarker1173"/> talking about deployments and especially blue/green deployments. Having an understanding of the definition of environment is critical for understanding what resources are subject to change. Knowing what is being defined as the environment is also crucial when navigating some of the questions on the AWS DevOps professional test. </p>
			<p>An environment is a boundary where things change and where things need to be deployed. This can be as small as one component of your application or it can be as large as a full tier of the application, such as the web tier.</p>
			<h1 id="_idParaDest-332"><a id="_idTextAnchor341"/>AWS services that you can use for blue/green deployments</h1>
			<p>There are a number of tools available natively from AWS that allow you to perform blue/green deployments. These tools<a id="_idIndexMarker1174"/> allow for a range of deployment options, from full<a id="_idIndexMarker1175"/> control of all aspects of the environment using a service such as CloudFormation to granular changes in services such as Route 53 or Auto Scaling. These more granular options would only allow you to perform modifications to a specific section of your application but can be just as effective in implementing blue/green deployments. </p>
			<p>Let's look at the different AWS services that are available to assist us in blue/green deployments.</p>
			<h2 id="_idParaDest-333"><a id="_idTextAnchor342"/>AWS CloudFormation </h2>
			<p>Using <strong class="bold">AWS CloudFormation</strong>, you have the ability to use the service's templating capabilities<a id="_idIndexMarker1176"/> to both describe the AWS resources you are deploying along with quickly creating a copy of the environment with any updates that are needed. This is all done with one of the two languages that CloudFormation supports: JSON or YAML. </p>
			<p>The templates can be smaller pieces of a more extensive infrastructure. You have the ability with CloudFormation templates to create groups of dependent items, such as an autoscaling group, and then either use the output of this created group to update a previously created template that holds the load balancer to update where it is pointing or make the switch manually with the newly created Auto Scaling group. </p>
			<h2 id="_idParaDest-334"><a id="_idTextAnchor343"/>AWS Elastic Beanstalk </h2>
			<p><strong class="bold">Elastic Beanstalk</strong> is a service that helps developers concentrate on their code by managing the underlying<a id="_idIndexMarker1177"/> infrastructure. This includes items such as ELB, EC2 instances, storage for the EC2 instances with EBS volumes, Elastic IPs, Auto Scaling groups, security groups, and even monitoring via CloudWatch metrics. </p>
			<p>When you are performing blue/green deployments in Elastic Beanstalk, you can easily clone your environments. These clones can be exact replicas of your current application code base, or they can even be the latest version of the code if you have pushed features and changes to Beanstalk since you last made your deployment. Elastic Beanstalk makes it easy for those using the service to switch from one environment to the next using the Swap Environment URL feature. This feature takes and then performs the DNS switch in the background and reroutes the traffic from the previous (blue) environment to the new (green) environment. </p>
			<h2 id="_idParaDest-335"><a id="_idTextAnchor344"/>AWS CodeDeploy </h2>
			<p><strong class="bold">AWS CodeDeploy</strong> is a managed deployment service that helps automate the deployment of your software<a id="_idIndexMarker1178"/> to on-premise servers, EC2 instances, AWS Lambda functions, and AWS Fargate containers. When creating a deployment with AWS CodeDeploy, you have the option to choose either an in-place deployment or a blue/green deployment. </p>
			<p>With the blue/green deployment option, you have the ability in your environment configuration to have CodeDeploy automatically copy your EC2 Auto Scaling group or manually provision instances for a blue/green deployment. There are also options to enable load<a id="_idIndexMarker1179"/> balancing. There is also an option to reroute the traffic automatically or allow for manual rerouting of the traffic after the deployment to the new instances or Auto Scaling group is complete. </p>
			<p>There is even the ability to integrate CloudFormation templates using the CodeDeploy service to perform blue/green ECS deployments. </p>
			<h2 id="_idParaDest-336"><a id="_idTextAnchor345"/>AWS ELB </h2>
			<p><strong class="bold">AWS ELB</strong> (<strong class="bold">ELB</strong>) is a compute service that allows you to route and distribute<a id="_idIndexMarker1180"/> your traffic to multiple instances, IP addresses, Lambda functions, containers, and even virtual containers. As ELB is a managed service, it can also perform health checks to determine which instances are healthy and which ones need to stop having traffic being directed to them:</p>
			<div>
				<div id="_idContainer184" class="IMG---Figure">
					<img src="Images/Figure_13.1_B17405.jpg" alt="Figure 13.1 – An Application Load Balancer deploying traffic to two versions of an application at once using target groups " width="314" height="152"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.1 – An Application Load Balancer deploying traffic to two versions of an application at once using target groups </p>
			<p>Using target groups with Application Load Balancers, you can roll out a new version of your application to a subset of your users with a canary deployment, which is a variety of the blue/green deployment. Using multiple target groups that are connected to the same Application Load Balancer, you can determine how much traffic will be directed to each version of the application. </p>
			<h2 id="_idParaDest-337"><a id="_idTextAnchor346"/>Amazon ECS </h2>
			<p>Amazon <strong class="bold">ECS</strong> (<strong class="bold">ECS</strong>) uses tasks to make groups of Docker containers easy<a id="_idIndexMarker1181"/> to run, stop, and manage on AWS EC2 instances. With ECS, you can schedule when you want your containers to be placed on an instance using the service scheduler. ECS also lets you stretch multiple containers running the same task across multiple ECS-compatible instances in the same Region but in different Availability Zones:</p>
			<div>
				<div id="_idContainer185" class="IMG---Figure">
					<img src="Images/Figure_13.2_B17405.jpg" alt="Figure 13.2 – Switching from Target Group 1 to Target Group 2 in ECS using an ALB &#13;&#10;" width="627" height="303"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.2 – Switching from Target Group 1 to Target Group 2 in ECS using an ALB </p>
			<p>The use of containers can make deployments, and especially blue/green deployments, more straightforward to perform. Containers are not as complex as full instances, and multiple containers can run in a single EC2 instance, even those that are running different versions of an application. </p>
			<h2 id="_idParaDest-338"><a id="_idTextAnchor347"/>Amazon Elastic Kubernetes Service </h2>
			<p>Amazon <strong class="bold">Elastic Kubernetes Service</strong> (<strong class="bold">EKS</strong>) allows you to run Kubernetes applications and scale<a id="_idIndexMarker1182"/> Kubernetes applications both in the AWS cloud and on-premises. It helps the management of the clusters by providing secure clusters and allows the clusters to be highly available.</p>
			<p>EKS can be run on specialized EC2 instances or can be run on <strong class="bold">AWS Fargate</strong>, which provides on-demand<a id="_idIndexMarker1183"/> compute capacity for containers. The use of Fargate removes the need for provisioning instances, choosing server types, or managing virtual machines. </p>
			<p>You can perform blue/green deployments with EKS on AWS Fargate with the help of the blue/green deployment<a id="_idIndexMarker1184"/> feature of the CodeDeploy service. When you create a new blue/green deployment for EKS, you specify your Application Load Balancer name fronting your Kubernetes task, and the CodeDeploy service handles deploying the new green service and then phasing out the older blue task. </p>
			<h2 id="_idParaDest-339"><a id="_idTextAnchor348"/>AWS OpsWorks </h2>
			<p><strong class="bold">AWS OpsWorks</strong> is a configuration management service that allows you to configure stacks based<a id="_idIndexMarker1185"/> on the Chef or Puppet frameworks. </p>
			<p>Blue/green deployments are simplified with OpsWorks by simply cloning the entire stack. </p>
			<h2 id="_idParaDest-340"><a id="_idTextAnchor349"/>Amazon CloudWatch </h2>
			<p><strong class="bold">Amazon CloudWatch</strong> is the metrics and monitoring service that allows users to track and observe their deployed resources. The CloudWatch service also has the ability to set alarms and<a id="_idIndexMarker1186"/> send notifications via other services, such as Amazon SNS or Amazon SES. </p>
			<p>When metrics have been set up on the resources in both the blue and green environments, then you have the ability to assess the new environment as you start to direct traffic to it. Keeping an eye on the metrics that you have set in CloudWatch and making sure that all services stay in a steady state while making the switch to the new environment can help ease the anxiety of switching to a new environment. </p>
			<h2 id="_idParaDest-341"><a id="_idTextAnchor350"/>Amazon Route 53 </h2>
			<p><strong class="bold">Amazon Route 53</strong> is the DNS service that can be used in blue/green deployments by allowing<a id="_idIndexMarker1187"/> the pointing of DNS records to the new green environment. This allows DevOps professionals and network administrators to quickly and easily redirect traffic by updating the DNS<a id="_idIndexMarker1188"/> records. Route 53 also includes advanced capabilities, such as the ability to adjust the <strong class="bold">Time To Live</strong> (<strong class="bold">TTL</strong>) for resource records and using advanced techniques such as weighted policies so that traffic can be shifted gradually to the new environment instead of redirected all at once. </p>
			<p>Now that we have looked at the different services that can be used to implement blue/green deployments, let's look at the benefits of using blue/green deployments. </p>
			<h1 id="_idParaDest-342"><a id="_idTextAnchor351"/>Benefits of blue/green deployments with AWS </h1>
			<p>The use of blue/green deployment strategies provides multiple benefits over in-place deployments. It is important<a id="_idIndexMarker1189"/> to note that although these benefits are substantial, there are extra costs for the additional environments that are created during the blue/green process. The secondary environments may be taken down after the deployment has been validated or, in the case of a failed deployment, after a rollback has been completed. </p>
			<h1 id="_idParaDest-343"><a id="_idTextAnchor352"/>Techniques for performing blue/green deployments in AWS </h1>
			<p>Implementing blue/green deployments in AWS can be done in a variety of ways. Recognized patterns<a id="_idIndexMarker1190"/> have emerged for successful ways to implement these deployments. As we look at each technique described, specific services used will be featured. Different applications lean toward different patterns. </p>
			<h2 id="_idParaDest-344"><a id="_idTextAnchor353"/>Updating DNS routing with Route 53 </h2>
			<p>The Route 53 service<a id="_idIndexMarker1191"/> allows you to use hosted zones once you have brought up your new environment. Adding the additional<a id="_idIndexMarker1192"/> record to the record set will<a id="_idIndexMarker1193"/> then create a seamless transition to the new application deployment for your end users: </p>
			<div>
				<div id="_idContainer186" class="IMG---Figure">
					<img src="Images/Figure_13.3_B17405.jpg" alt="Figure 13.3 – Showing blue/green deployment using Route 53-hosted zones &#13;&#10;" width="389" height="485"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.3 – Showing blue/green deployment using Route 53-hosted zones </p>
			<p>This switch can be done all at once to force all the traffic to the new green environment. You can also use weighted records to send a portion of the traffic to the green environment, initially as a canary test. These canary users would then generate logs and metrics that could<a id="_idIndexMarker1194"/> be evaluated over a period of time. If there<a id="_idIndexMarker1195"/> are no errors being reported in your new<a id="_idIndexMarker1196"/> environment, then you can change the weight of your policy so that 100% of the traffic is now being directed to the green environment. </p>
			<p>This technique is not limited to creating a new green environment in the same set of Availability Zones or even the same Region for that matter. You can create your new green environment in a totally separate Region. If you are planning to switch from Region to Region in your environment, be sure that you have taken into account your data tier and how that would be affected during a regional switch. </p>
			<p>This is also not limited to instances or services listening for requests behind a load balancer. Using a DNS routing switch with Route 53 could be used in all of the following scenarios:</p>
			<ul>
				<li>Groups or clusters of EC2 instances fronted by ELB </li>
				<li>Instances in an Auto Scaling group that are fronted by ELB </li>
				<li>Single instances that have either a public address or an Elastic IP address </li>
				<li>Elastic Beanstalk web applications in specified environments </li>
				<li>Services running in ECS or EKS</li>
			</ul>
			<h3>Process for deployment – DNS routing </h3>
			<p>The process for<a id="_idIndexMarker1197"/> implementing a blue/green deployment using<a id="_idIndexMarker1198"/> Route 53 to switch hosted zones is detailed<a id="_idIndexMarker1199"/> as follows:</p>
			<ol>
				<li>Start with 100% of your traffic being directed to the <strong class="bold">blue</strong> environment, with the current version of the application deployed. </li>
				<li>Deploy the new version of the application into the <strong class="bold">green</strong> environment. </li>
				<li>Test that the deployment of the green stack was successful either by running a series of manual or scripted tests.</li>
				<li>Update the weighted record in the Route 53-hosted zone to direct a portion of the traffic over to the new green environment. </li>
				<li>Monitor the new environment for errors or failures. </li>
				<li>Update the weighted record in the Route 53-hosted zone to shift the remaining traffic to the <strong class="bold">green</strong> environment. </li>
				<li>If there was an issue with the deployment, update the Route 53 record to redirect all the traffic back to the <strong class="bold">blue</strong> environment.</li>
			</ol>
			<p>Now that we have seen how to do blue/green deployments using DNS and Route 53, let's look next at how we can do blue/green deployments without changing the DNS settings. </p>
			<h2 id="_idParaDest-345"><a id="_idTextAnchor354"/>Swapping the Auto Scaling group behind ELB </h2>
			<p>In our second blue/green deployment<a id="_idIndexMarker1200"/> option, we will take the DNS option out of the picture. In many organizations, the team that does the application deployment<a id="_idIndexMarker1201"/> is not the same team that deals with the networking configurations, including the DNS records hosted by the Route 53 service. Hence, we need to be prepared for those scenarios:</p>
			<div>
				<div id="_idContainer187" class="IMG---Figure">
					<img src="Images/Figure_13.4_B17405.jpg" alt="Figure 13.4 – Deploying blue/green environments by swapping Auto Scaling groups&#13;&#10;" width="389" height="490"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.4 – Deploying blue/green environments by swapping Auto Scaling groups</p>
			<p>Once the new Auto Scaling group has been launched, you perform a set of tests on the new green stack before registering the new Auto Scaling group, the green Auto Scaling group, with ELB. </p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">We go through the hands-on exercise of creating and deploying Auto Scaling launch templates in <a href="B17405_18_Final_JM_ePub.xhtml#_idTextAnchor433"><em class="italic">Chapter 18</em></a>, <em class="italic">Autoscaling and Lifecycle Hooks</em>. </p>
			<p>An important item of note here is that ELB is only part of the deployment process<a id="_idIndexMarker1202"/> as far as registration and deregistering are concerned. As you are deploying new versions of the software, you are not deploying a new load balancer. </p>
			<h3>Process for deployment – swapping the Auto Scaling group </h3>
			<p>The process<a id="_idIndexMarker1203"/> for carrying out a blue/green deployment by swapping the Auto Scaling group is as follows:</p>
			<ol>
				<li value="1">Before you start, make sure that your ELB instance is not part of your deployment environment.</li>
				<li>Begin with the ELB instance pointing to the <strong class="bold">blue</strong> Auto Scaling group. </li>
				<li>Deploy the new <strong class="bold">green</strong> Auto Scaling group. </li>
				<li>Test the <strong class="bold">green</strong> Auto Scaling group. </li>
				<li>Register the <strong class="bold">green</strong> Auto Scaling group with the ELB instance. </li>
				<li>Deregister the <strong class="bold">blue</strong> Auto Scaling group from the ELB instance.</li>
			</ol>
			<p>Now that we have seen how to carry out a blue/green deployment by swapping Auto Scaling groups, let's next look at another technique for blue/green deployments that also uses Auto Scaling groups. </p>
			<h2 id="_idParaDest-346"><a id="_idTextAnchor355"/>Updating Auto Scaling group launch configurations </h2>
			<p>Each Auto Scaling group<a id="_idIndexMarker1204"/> is associated with a launch configuration. The launch configuration<a id="_idIndexMarker1205"/> contains the information needed to launch new instances whenever a scaling event occurs. </p>
			<p>Create a new launch template (or launch configuration). This new launch configuration contains either an updated AMI, updated user data, or both:</p>
			<div>
				<div id="_idContainer188" class="IMG---Figure">
					<img src="Images/Figure_13.5_B17405.jpg" alt="Figure 13.5 – Deploying blue/green environments by swapping launch configurations&#13;&#10;" width="388" height="488"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.5 – Deploying blue/green environments by swapping launch configurations</p>
			<h3>Process for deployment – updating the Auto Scaling group launch configurations </h3>
			<p>The process for performing a blue/green deployment by updating Auto Scaling group launch configurations<a id="_idIndexMarker1206"/> is as follows:</p>
			<ol>
				<li value="1">Ensure that your ELB<a id="_idIndexMarker1207"/> instance is not part of the deployment process.</li>
				<li>Start with your traffic being directed to the current Auto Scaling group using the blue launch configuration. </li>
				<li>Create a new launch configuration (the green launch configuration) and attach it to the Auto Scaling group. </li>
				<li>Scale out the Auto Scaling group to <strong class="bold">twice</strong> its original size. </li>
				<li>Once the instances have been launched and have become healthy from the green Auto<a id="_idIndexMarker1208"/> Scaling group, scale down<a id="_idIndexMarker1209"/> the Auto Scaling group back to its original size. </li>
			</ol>
			<h2 id="_idParaDest-347"><a id="_idTextAnchor356"/>Updating ECS </h2>
			<p>Packaging your<a id="_idIndexMarker1210"/> application in a container makes it easy to deploy. </p>
			<p>Use target groups, which<a id="_idIndexMarker1211"/> allow you to run multiple services behind a single load balancer. One can be the blue service and one can be the green service. </p>
			<p>One of the key pieces to executing a blue/green deployment with ECS is the Application Load Balancer. It is at the Application Load Balancer where the ECS tasks are registered:</p>
			<div>
				<div id="_idContainer189" class="IMG---Figure">
					<img src="Images/Figure_13.6_B17405.jpg" alt="Figure 13.6 – Using an ECS service update for a blue/green deployment &#13;&#10;" width="437" height="524"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.6 – Using an ECS service update for a blue/green deployment </p>
			<p>When using<a id="_idIndexMarker1212"/> this approach, you need to take the following considerations<a id="_idIndexMarker1213"/> into mind:</p>
			<ul>
				<li>Your code needs to be completely stateless.</li>
				<li>Canary deployments aren't possible.</li>
				<li>Long-running connections will be abruptly terminated during the task switch.</li>
			</ul>
			<h3>Process for deployment – updating ECS </h3>
			<p>The process for conducting a blue/green deployment by updating ECS is as follows:</p>
			<ol>
				<li value="1">Start with a blue service that has a task definition defined that is pointing to the Application Load Balancer. </li>
				<li>Next, create a new task definition that is established on the new application version, which has been created in a new container; this is your green version. </li>
				<li>Scale up the green service with the green task definition and map this green service to the Application Load Balancer. </li>
				<li>Scale down the blue service by setting the number of tasks to zero. </li>
			</ol>
			<p>Now that we have<a id="_idIndexMarker1214"/> seen how to perform a blue/green deployment using containers and ECS, let's look at using the Elastic Beanstalk service to quickly swap application versions in a blue/green deployment. </p>
			<h2 id="_idParaDest-348"><a id="_idTextAnchor357"/>Swapping the environment of an Elastic Beanstalk application </h2>
			<p>If you are going<a id="_idIndexMarker1215"/> to use a blue/green deployment strategy with Elastic Beanstalk, then<a id="_idIndexMarker1216"/> you must make sure that your application environments are separated from your database:</p>
			<div>
				<div id="_idContainer190" class="IMG---Figure">
					<img src="Images/Figure_13.7_B17405.jpg" alt="Figure 13.7 – A blue/green deployment by swapping an Elastic Beanstalk application&#13;&#10;" width="478" height="525"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.7 – A blue/green deployment by swapping an Elastic Beanstalk application</p>
			<h3>Process for deployment – swapping an Elastic Beanstalk environment </h3>
			<p>The process for executing a swap of an Elastic Beanstalk environment to perform a blue/green deployment<a id="_idIndexMarker1217"/> is as follows:</p>
			<ol>
				<li value="1">Open up your AWS Management Console<a id="_idIndexMarker1218"/> to the Elastic Beanstalk service and ensure that you are in the correct Region for your Beanstalk application. </li>
				<li>Clone your environment. You can do this without any changes to the current platform or choose <strong class="screen-inline">Clone with latest platform</strong> to use the newest version of the platform's Git branch. This new platform becomes your green environment.</li>
				<li>If you only cloned the environment, you will need to deploy the new version of the application to the green environment.</li>
				<li>You can now test the new environment using the unique DNS name given to the green environment's ELB. </li>
				<li>On the environment overview page, choose <strong class="screen-inline">Environment Actions | Swap URLs</strong>.</li>
				<li>The traffic coming from Route 53 will now be directed to the green environment.</li>
			</ol>
			<p>We have looked<a id="_idIndexMarker1219"/> at how to easily do a blue/green deployment with the Elastic Beanstalk<a id="_idIndexMarker1220"/> service using the Swap URLs feature. Next, let's look at how we can perform blue/green deployments in the OpsWorks service by cloning OpsWorks stacks. </p>
			<h2 id="_idParaDest-349"><a id="_idTextAnchor358"/>Cloning an OpsWorks stack and then updating the DNS record </h2>
			<p>When you create an application in AWS OpsWorks, you start by creating a stack. An OpsWorks stack consists<a id="_idIndexMarker1221"/> of one or more layers. Once the stack<a id="_idIndexMarker1222"/> has been created, it can easily be cloned to an exact copy of itself to create<a id="_idIndexMarker1223"/> an entirely new environment. Within this new environment, you can update<a id="_idIndexMarker1224"/> your recipes and deploy a new version of your application. You can even use the local DNS name on ELB to test the new version of the application before routing any traffic to the new stack. </p>
			<p>Combining the OpsWorks stack hosting your application and the Route 53 service to direct the traffic for your CNAME, you can quickly and easily switch between stacks as you deploy new versions of your application.</p>
			<div>
				<div id="_idContainer191" class="IMG---Figure">
					<img src="Images/Figure_13.8_B17405.jpg" alt="Figure 13.8 – Cloning an OpsWorks stack &#13;&#10;" width="473" height="408"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.8 – Cloning an OpsWorks stack </p>
			<h3>Process for deployment – cloning the OpsWorks stack </h3>
			<p>The process for undertaking<a id="_idIndexMarker1225"/> a blue/green deployment by cloning an OpsWorks stack is as follows:</p>
			<ol>
				<li value="1">Start with<a id="_idIndexMarker1226"/> your current stack in OpsWorks; this is your blue stack that contains the current version<a id="_idIndexMarker1227"/> of your application.</li>
				<li>Next, create the new stack<a id="_idIndexMarker1228"/> by cloning the stack, which is now your green environment. You can do this by clicking on the clone link in the console or by using the CLI. </li>
				<li>Deploy the new version of the application to the application layer of the green environment. There should not be any traffic being directed to the green environment at this point. </li>
				<li>If necessary, pre-warm your ELB so that it can handle the traffic for your customer base.</li>
				<li>When you are ready to promote your green stack to the one being used as the production stack, update the DNS records to point to ELB using Route 53. This can be done all at once or in a gradual process. </li>
				<li>When you are satisfied with your deployment, then you can decommission the blue stack. </li>
			</ol>
			<p>Now that we<a id="_idIndexMarker1229"/> have examined a multitude<a id="_idIndexMarker1230"/> of different blue/green deployment techniques<a id="_idIndexMarker1231"/> using a variety<a id="_idTextAnchor359"/> of different<a id="_idIndexMarker1232"/> AWS services, we will next move on to the data tier. </p>
			<h1 id="_idParaDest-350"><a id="_idTextAnchor360"/>Using best practices in your data tier with blue/green deployments </h1>
			<p>One of the more significant<a id="_idIndexMarker1233"/> risks that can be present when deploying a newer version of an application is making<a id="_idIndexMarker1234"/> changes to the database. This is especially<a id="_idIndexMarker1235"/> true when performing blue/green deployments since the whole point of them is to mitigate risk and create the ability to roll back quickly.</p>
			<p>If you are using Amazon RDS, it is a good idea to create a snapshot of your database prior to starting your deployment if you are going to be performing any database changes. This will allow you to restore from that snapshot if the data deployment doesn't go as planned and have as little downtime as possible. </p>
			<h2 id="_idParaDest-351"><a id="_idTextAnchor361"/>Separating schema changes from code changes</h2>
			<p>When performing<a id="_idIndexMarker1236"/> deployments, it is vitally important<a id="_idIndexMarker1237"/> to separate any database changes, such as schema changes, from the application deployment. The order in which you perform some of the database updates may depend on what type of schema changes you are performing. </p>
			<p>There are generally two approaches that you can take when schema changes are necessary, yet when to use either of the two approaches depends on whether the schema approaches are backward compatible and will work with the current version of the application:</p>
			<div>
				<div id="_idContainer192" class="IMG---Figure">
					<img src="Images/Figure_13.9_B17405.jpg" alt="Figure 13.9 – The process for making database schema changes during blue/green deployments&#13;&#10;" width="757" height="200"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.9 – The process for making database schema changes during blue/green deployments</p>
			<p>The second approach is to compete for the schema changes after you have conducted your deployment. This is best for any changes that would not be compatible with the current version of the application and, if done prior to deployment, would cause errors to the current application version. </p>
			<p>There are cases<a id="_idIndexMarker1238"/> when you should perform two separate<a id="_idIndexMarker1239"/> schema changes. This would be when you have both a set of non-breaking changes as well as a set of breaking changes. In splitting up the changes into two separate deployments, you have made smaller incremental changes to your database and therefore are mitigating the risk by breaking the steps into smaller, more manageable pieces. </p>
			<h1 id="_idParaDest-352"><a id="_idTextAnchor362"/>Summary</h1>
			<p>In this chapter, we covered blue/green deployments, what they are, and how to deploy them successfully. We also talked about the services in AWS that can be used to successfully perform blue/green deployments, along with the processes for performing the deployment with each of the services. Finally, we looked at how to deal with data updates when implementing deployments. We concentrated on which schema changes should be performed first. </p>
			<p>In the next chapter, we will begin to look at monitoring and logging for our environments and workloads. This starts with a look at the roles that the CloudWatch and X-Ray services play in DevOps. </p>
			<h1 id="_idParaDest-353"><a id="_idTextAnchor363"/>Review questions</h1>
			<ol>
				<li value="1">You have been contracted by a company to help architect their application on AWS. The company has a requirement to have a hardened AMI that can be auto scaled as part of the application. The application is also listening on both HTTP and TCP ports, so you have decided to use a Classic Load Balancer that can handle both protocols. There is a vanity CNAME, which is being hosted on Route 53. Blue/green deployments must be a part of this architecture. Which routing policy can you use in Route 53 to achieve blue/green deployments?<p>a. Multi-answer </p><p>b. Latency </p><p>c. Weighted </p><p>d. Simple</p></li>
				<li>You are performing a blue/green deployment, updating an application environment within Elastic Beanstalk. Once you have created an identical <em class="italic">green</em> environment to the existing <em class="italic">blue</em> environment and deployed the new version of the application to the green environment, what should be done next to switch over to the new <em class="italic">green</em> environment?<p>a. Update the DNS records to point to the green environment. </p><p>b. Redirect traffic to the new green environment using Amazon Route 53. </p><p>c. Replace the Auto Scaling launch configuration that is currently pointed at the environment's load balancer. </p><p>d. Select the Swap Environment URLs option. </p></li>
				<li>A company has hired you because they need help implementing their blue/green deployment process on AWS. After deployment of the new environment, they want to be able to gradually shift the traffic from the blue environment over to the new green environment. The application has been deployed on EC2 instances, which are in an Auto Scaling group placed behind the Application Load Balancer. Route 53 is routing the consumer traffic to the load balancer. Finally, the application's data tier consists of PostgreSQL RDS Multi-AZ database instances.  <p>Which three steps will successfully implement the blue/green deployment process?</p><p>a. Create a new Application Load Balancer and a new Auto Scaling group. </p><p>b. Create a new Auto Scaling group behind the current load balancer. </p><p>c. Create a new alias record in Route 53 that points to the green environment and has a failover policy for the two records.</p><p>d. Create a new alias record in Route 53 that points to the green environment and uses weighted routing between the two records.</p><p>e. In your new Auto Scaling group, set the EC2 instances to use the same RDS instance.</p><p>f. In your new Auto Scaling group, set the EC2 instances to use the failover node of RDS.</p></li>
			</ol>
			<h1 id="_idParaDest-354"><a id="_idTextAnchor364"/>Review answers </h1>
			<ol>
				<li value="1">C</li>
				<li>D</li>
				<li>A, D, and E</li>
			</ol>
		</div>
	</div></body></html>