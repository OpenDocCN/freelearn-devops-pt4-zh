<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer207">
			<h1 id="_idParaDest-356"><a id="_idTextAnchor366"/>Chapter 14: CloudWatch and X-Ray's Role in DevOps</h1>
			<p>Once you have your application running in the cloud, you need a way to keep an eye on it to make sure that it stays healthy and is performing effectively. <strong class="bold">CloudWatch</strong> can aggregate the logs of your services and applications, but combining this with <strong class="bold">X-Ray</strong> allows you to trace the performance of your application to see where you can enhance performance even further.</p>
			<p>In this chapter, we're going to cover the following main topics: </p>
			<ul>
				<li>CloudWatch overview</li>
				<li>Using CloudWatch to aggregate your logs</li>
				<li>CloudWatch alarms</li>
				<li>Adding X-Ray for application tracing</li>
			</ul>
			<h1 id="_idParaDest-357"><a id="_idTextAnchor367"/>CloudWatch overview </h1>
			<p>Monitoring<a id="_idIndexMarker1240"/> is important for several reasons that range from both the operational side to the business side. First, it gives you visibility into not only what is running in your environment but how the resources in your environment are performing. Second, monitoring matters <a id="_idIndexMarker1241"/>from an operational level when you are trying to troubleshoot issues in real time. From a business perspective, monitoring lets you know things such as whether your deployments have been completed successfully, and whether your customers don't see any adverse effects. </p>
			<p>In today's world, where information can be dispersed quickly throughout the internet and especially social media channels, anything that affects customer experience can and usually does spread quickly. This can affect your brand and your business bottom line. Monitoring your resources with CloudWatch allows you to stay ahead of this and be proactive rather than reactive:</p>
			<div>
				<div id="_idContainer195" class="IMG---Figure">
					<img src="Images/Figure_14.1_B17405.jpg" alt="Figure 14.1 – How monitoring continues to evolve&#13;&#10;" width="597" height="429"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.1 – How monitoring continues to evolve</p>
			<p>How you <a id="_idIndexMarker1242"/>monitor <a id="_idIndexMarker1243"/>your systems and resources today may be different than how you monitored things 5 to 10 years ago. Things such as infrastructure changes and waterfall deployment philosophies drove what was going to be monitored. </p>
			<p>Gone are the days where you would be provisioning a server, and that same server would be running for up to a decade before being sunsetted. With services in the cloud such as auto-scaling, which constantly adds and removes instances based on demand, the metrics that you monitor need to not only be relevant to the health of your system but the performance of your customers: </p>
			<div>
				<div id="_idContainer196" class="IMG---Figure">
					<img src="Images/Figure_14.2_B17405.jpg" alt="Figure 14.2 – The features of AWS CloudWatch&#13;&#10;" width="602" height="474"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.2 – The features of AWS CloudWatch</p>
			<p>Amazon CloudWatch <a id="_idIndexMarker1244"/>is an AWS native service that helps you monitor your services and resources. It is part of the management tools offered by AWS. The primary function of CloudWatch is to help you track and monitor the performance of your resources and applications. While monitoring, the CloudWatch service can use alarms to notify either personnel via the SNS service or use events to trigger automation in response to those alarms. CloudWatch can also be used to collect and monitor log files. CloudWatch consists of three main components: <em class="italic">metrics</em>, <em class="italic">alarms</em>, and <em class="italic">events</em>.</p>
			<h2 id="_idParaDest-358"><a id="_idTextAnchor368"/>Understanding and using the CloudWatch unified agent</h2>
			<p>AWS provides a unified<a id="_idIndexMarker1245"/> CloudWatch agent that can help you do several things both for on-premises servers and on EC2 instances. Let's review a few common scenarios where using the CloudWatch unified agent comes in handy. </p>
			<h3>Running as a different user</h3>
			<p>When <a id="_idIndexMarker1246"/>running the CloudWatch agent on Linux servers, the CloudWatch agent will run as the root user by default. If your company does not allow agents and programs to be run as the root user, then you can create a custom user for the CloudWatch agent to use and then, in the configuration file, tell the agent to <strong class="source-inline">run_as_user</strong>.</p>
			<h3>Having multiple CloudWatch agent configuration files </h3>
			<p>Organizations that base <a id="_idIndexMarker1247"/>their build on an approved <strong class="bold">Amazon Machine Image</strong> (<strong class="bold">AMI</strong>) that must be used for any development or production builds can have a CloudWatch configuration file pre-baked into the instance. This configuration file would allow standard configurations to be collected across all instances. Development teams can then add another configuration file that the CloudWatch agent can read and process at startup, which would include any specific application metrics or logs. </p>
			<p>An example of this could be if an application team is running an NGINX server to front their web application; otherwise, they may be using the proxy powers of NGINX to redirect traffic. Their custom configuration file can be designated to look for 4XX and 5XX errors from NGINX, and they can also be configured to consume the logs and ship them back to CloudWatch Logs. </p>
			<h3>Sending metrics and logs to a different account than the one the instance is running in</h3>
			<p>The CloudWatch agent<a id="_idIndexMarker1248"/> has the flexibility to send either metrics, logs, or both to another AWS account for monitoring purposes by specifying <strong class="source-inline">role_arn</strong> in the configuration. </p>
			<h3>Adding custom dimensions to metrics collected by the CloudWatch agent </h3>
			<p>CloudWatch <a id="_idIndexMarker1249"/>will create its own rollups of the metrics that it collects. These might not always be the optimal grouping for you and your team; hence, there are ways to customize how things are grouped by using the <strong class="source-inline">append_dimensions</strong> field. </p>
			<p>We just saw how the unified CloudWatch agent, whether used on an AWS EC2 instance or an on-premises server, allows you to collect logs and metrics in a multitude of scenarios. Now, let's go through the process of installing the CloudWatch agent on an EC2 instance. </p>
			<h2 id="_idParaDest-359"><a id="_idTextAnchor369"/>Installing the CloudWatch agent on an EC2 instance </h2>
			<p>The best way to get <a id="_idIndexMarker1250"/>a good understanding of the<a id="_idIndexMarker1251"/> CloudWatch unified agent is to go through the process of installing the agent on an EC2 instance. The following tutorial will take you through the steps of standing up an EC2 instance and then installing and configuring the agent. Finally, we will send some traffic to the EC2 instance so that we can look at the metrics and logs that have been generated. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">We will go much deeper into CloudWatch metrics in the next chapter. <a href="B17405_15_Final_JM_ePub.xhtml#_idTextAnchor381"><em class="italic">Chapter 15</em></a>, <em class="italic">CloudWatch Metrics and Amazon EventBridge</em>, will discuss both generic metrics and custom metrics.</p>
			<p>So far, we have been using Amazon Linux for any EC2 instances in our examples. Amazon Linux is an excellent operating system and comes pre-installed with many packages for use on the AWS cloud computing environment. This is the precise reason that for this example, we are going to use a different operating system – <em class="italic">Ubuntu</em>. The Ubuntu OS will not have some of the packages, such as the CloudWatch unified agent, installed by default. This allows us to go through the process of installing it on this EC2 instance, but the process would be the same if you had an EC2 instance running in your data center, except for the fact that you would need to authenticate your instance in your data center with a keypair, which would be rotated regularly. EC2 instances, on the other hand, may assume roles and would not need the access key and secret key to be stored on the instance, and in fact, assuming the role is a more secure practice. Let's get started:</p>
			<ol>
				<li>First, let's create the IAM role for our instance; we are going to need our instance to have permissions for CloudWatch and AWS Systems Manager. To create the role, we will need to save an initial <strong class="source-inline">JSON</strong> policy locally, and then we can attach the two managed policies that we need. Copy the <strong class="source-inline">JSON</strong> policy to a file named <strong class="source-inline">STS.json</strong>:<p class="source-code"><strong class="bold">{</strong></p><p class="source-code"><strong class="bold">  "Version": "2012-10-17",</strong></p><p class="source-code"><strong class="bold">  "Statement": {</strong></p><p class="source-code"><strong class="bold">    "Effect": "Allow",</strong></p><p class="source-code"><strong class="bold">    "Principal": {"Service": "ec2.amazonaws.com"},</strong></p><p class="source-code"><strong class="bold">    "Action": "sts:AssumeRole"</strong></p><p class="source-code"><strong class="bold">  }</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>With our<a id="_idIndexMarker1252"/> initial policy saved, we can<a id="_idIndexMarker1253"/> now create the role and attach the two managed policies:<p class="source-code"><strong class="bold">aws iam create-role --role-name CW-EC2 --assume-role-policy-document file://STS.json</strong></p><p class="source-code"><strong class="bold">aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore --role-name CW-EC2</strong></p><p class="source-code"><strong class="bold">aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy --role-name CW-EC2</strong></p></li>
				<li>Since we will be launching our instance with the CLI, we will need to create an instance profile. Once our instance profile has been created, we can attach our new role to <strong class="source-inline">instance profile</strong>:<p class="source-code"><strong class="bold">aws iam create-instance-profile --instance-profile-name CW_SSM</strong></p><p class="source-code"><strong class="bold">aws iam add-role-to-instance-profile --role-name CW-EC2 --instance-profile-name CW_SSM</strong></p></li>
				<li>Then, we will need to query the <strong class="source-inline">SSM</strong> parameter store for the AMI, which we want to use to spin up our image:<p class="source-code"><strong class="bold">AMI='aws ssm get-parameters --names \      /aws/service/canonical/ubuntu/server/16.04/stable/current/amd64/hvm/ebs-gp2/ami-id \</strong></p><p class="source-code"><strong class="bold">    --query 'Parameters[0].[Value]' --output text --region us-east-2'</strong></p><p>If you would like to see the value of the AMI that is returned, then you can use the following command: </p><p class="source-code"><strong class="bold">echo $AMI</strong></p></li>
				<li>We are <a id="_idIndexMarker1254"/>going to want to get into our <a id="_idIndexMarker1255"/>instance later, but rather than creating a key pair, we will add the following script, which will install both SSM Agent and the unified CloudWatch agent for Debian. We will create this script and save it to a file named <strong class="source-inline">agents.sh</strong> so that we can use it when launching our EC2 instance later in the <strong class="source-inline">user-data</strong> parameter.<p>The script to install SSM Agent and <strong class="source-inline">the</strong> <strong class="source-inline">unified</strong> <strong class="source-inline">CloudWatch</strong> <strong class="source-inline">agent</strong> is as follows: </p><p class="source-code"><strong class="bold">#!/bin/bash</strong></p><p class="source-code"><strong class="bold">mkdir /tmp/ssm</strong></p><p class="source-code"><strong class="bold">mkdir /tmp/cw-agent</strong></p><p class="source-code"><strong class="bold"># Download and Install the SSM Agent </strong></p><p class="source-code"><strong class="bold">cd /tmp/ssm</strong></p><p class="source-code"><strong class="bold">wget https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb</strong></p><p class="source-code"><strong class="bold">sudo dpkg -i amazon-ssm-agent.deb</strong></p><p class="source-code"><strong class="bold">sudo systemctl enable amazon-ssm-agent</strong></p><p class="source-code"><strong class="bold"># Install CollectD </strong></p><p class="source-code"><strong class="bold">sudo apt-get update -y</strong></p><p class="source-code"><strong class="bold">sudo apt-get install -y collectd</strong></p><p class="source-code"><strong class="bold"># Download and Install the Unified CloudWatch agent</strong></p><p class="source-code"><strong class="bold">cd /tmp/cw-agent</strong></p><p class="source-code"><strong class="bold">wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb</strong></p><p class="source-code"><strong class="bold">sudo dpkg -i -E ./amazon-cloudwatch-agent.deb</strong></p><p class="source-code"><strong class="bold">sudo systemctl enable amazon-cloudwatch-agent</strong></p><p class="callout-heading">Note</p><p class="callout">This script can also be downloaded from the <strong class="source-inline">Chapter-14</strong> folder of this book's GitHub repository under the same name – <strong class="source-inline">agents.sh</strong>. </p></li>
				<li>Once we<a id="_idIndexMarker1256"/> have the <strong class="source-inline">AMI</strong> value stored in<a id="_idIndexMarker1257"/> our variable, we can launch our image with the following command:<p class="source-code"><strong class="bold">aws ec2 run-instances \</strong></p><p class="source-code"><strong class="bold">--image-id $AMI \</strong></p><p class="source-code"><strong class="bold">--instance-type t2.micro \</strong></p><p class="source-code"><strong class="bold">--user-data file://agents.sh \</strong></p><p class="source-code"><strong class="bold">--tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=CW_Agent}]' \</strong></p><p class="source-code"><strong class="bold">--region us-east-2</strong></p><p>You will notice that we have added a few more parameters in our instance for the startup, including the <strong class="source-inline">user-data</strong> script, which we just created, as well as a <strong class="source-inline">Name</strong> tag for our instance. This name will help us identify our instance when we try to find it later. </p></li>
				<li>While our instance is initiating and running the startup scripts that we have given to it, we can log into the AWS Console and go directly to the SSM session manager using the following URL: <a href="https://console.aws.amazon.com/systems-manager/session-manager">https://console.aws.amazon.com/systems-manager/session-manager</a>. Once logged in, at the top right-hand side, check that you are in the correct region. We specified for our instance to be launched in the Ohio region (<strong class="source-inline">us-east-2</strong>), and if another region is listed, then switch to the region where you have spun up your instance. As an alternative, you could also do this from the <strong class="bold">EC2</strong> screen by selecting the instance and then choosing <strong class="bold">Connect</strong> from the <strong class="bold">Actions</strong> dropdown. On the <strong class="bold">Connect to instance</strong> screen, choose <strong class="bold">Session Manager</strong> and then the orange <strong class="bold">connect</strong> button. A new window containing your session should appear as you connect to your instance. </li>
				<li>Now that we<a id="_idIndexMarker1258"/> are connected to our<a id="_idIndexMarker1259"/> instance securely without having to use keys, we can configure the agent. We have already installed the CloudWatch agent using some of the commands in our <strong class="source-inline">user-data</strong> script. To get some of the logs flowing to CloudWatch Logs, we will need to tell the agent which logs specifically to push. We will need to run the configuration script as a <strong class="source-inline">sudo</strong> user, which is located at <strong class="source-inline">/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard</strong>. To simplify the commands, we will jump into the root user using the <strong class="source-inline">sudo su</strong> command:<p class="source-code"><strong class="bold">sudo su </strong></p><p class="source-code"><strong class="bold">/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard</strong></p></li>
				<li>Running the CloudWatch agent configuration manager will prompt you for quite a few questions, but the setup should take less than 5 minutes. The questions shown here are the ones that do not follow the defaults:<ul><li>Which default metrics config do you want? Standard (2) Log file path: <strong class="source-inline">/var/log/amazon/ssm/amazon-ssm-agent.log</strong>.</li><li>Do you want to specify any additional log files to monitor? No (2).</li><li>Do you want to store the config in the SSM parameter store? No (2).</li></ul></li>
				<li>When the config wizard has completed, since we are using the Ubuntu operating system, we will copy the newly generated <strong class="source-inline">config</strong> file to where the agent is expecting it to be and give ownership to the <strong class="source-inline">cwagent</strong> user:<p class="source-code"><strong class="bold">cp /opt/aws/amazon-cloudwatch-agent/bin/config.json /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json</strong></p><p class="source-code"><strong class="bold">chown cwagent /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json</strong></p></li>
				<li>With our <a id="_idIndexMarker1260"/>CloudWatch agent file now <a id="_idIndexMarker1261"/>configured, we will have to restart the agent for the changes to take effect. We can do this with the following command:<p class="source-code"><strong class="bold">/opt/aws/amazon-cloudwatch-agent/bin/start-amazon-cloudwatch-agent &amp;</strong></p><p>The <strong class="source-inline">&amp;</strong> symbol at the end of the command will put the script in the background so that you can do other things, and the script will still be running.</p></li>
				<li>One of the first ways we can generate a log is by clicking the orange <strong class="bold">Terminate</strong> button at the top right-hand side of our <strong class="bold">SSM session</strong> window. Confirm that you want to terminate the session. This tab should close automatically once terminated. Find one of your other <strong class="bold">AWS Management Console</strong> tabs, which should still be open, and using the top search bar, search for the <strong class="source-inline">CloudWatch</strong> service. Once the service name appears, click on <strong class="bold">CloudWatch</strong> to be taken to the service. </li>
				<li>Once in <strong class="bold">CloudWatch</strong>, from the left menu, find the main item named <strong class="bold">Logs</strong>. Expand the <strong class="bold">Logs</strong> item so that you can see <strong class="bold">Log groups</strong>. You should see a group named <strong class="screen-inline">amazon-ssm-agent.log</strong>. Click on this log group's name to be taken to the log streams. </li>
				<li>There should only be one log stream in the log group. The log stream's name will be the identifier for your AWS EC2 instance. Click on this <strong class="bold">Log stream</strong> so that we can view the logs:<div id="_idContainer197" class="IMG---Figure"><img src="Images/Figure_14.3_B17405.jpg" alt="Figure 14.3 – A single log stream in our CloudWatch log group&#13;&#10;" width="916" height="277"/></div><p class="figure-caption">Figure 14.3 – A single log stream in our CloudWatch log group</p></li>
				<li>If you did log <a id="_idIndexMarker1262"/>out of your <strong class="bold">Session Manager</strong> session, then<a id="_idIndexMarker1263"/> you can use the search box to search for the term <strong class="source-inline">Session</strong> <strong class="source-inline">worker</strong> <strong class="source-inline">closed</strong>. Any time that you have logged out of <strong class="bold">Session Manager</strong> while the CloudWatch agent was running should appear in the list of logs. You can click the small triangle on the left-hand side of the log to expand the contents and see the full log entry.<p class="callout-heading">Note</p><p class="callout">We are going to continue to use this instance for further exercises in this chapter. If you are going to continue at a later point in time, I would suggest that you put this instance into hibernation so that you don't get charged for it. Then, you don't have to reconfigure everything when you are ready to go again. </p></li>
			</ol>
			<p>Now that we have added the unified CloudWatch agent to a non-Amazon instance, we will look at some other features of CloudWatch Logs. If you plan on doing the next exercise with the CloudWatch alarms in a relatively short manner, I would suggest that you either leave this instance running or simply stop the instance so that you have access to the metrics that the CloudWatch agent aggregates and pushes for alarming. </p>
			<h1 id="_idParaDest-360"><a id="_idTextAnchor370"/>Using CloudWatch to aggregate your logs</h1>
			<p>Amazon's <a id="_idIndexMarker1264"/>CloudWatch service is not only a powerful monitoring<a id="_idIndexMarker1265"/> tool, but it also allows you to route multiple types of logs such as operating systems, applications, custom log files, and even CloudTrail logs to the dependable storage of CloudWatch Logs. </p>
			<p>CloudWatch Logs allow you to group logs that come from the same source (log streams) and then search through those groups using filter patterns. Filter patterns are like the CloudWatch version of regular expressions and allow you to search through the different fields of the logs in your log streams and groups. </p>
			<p>Using subscriptions, you can push either all the logs from a particular log stream or only those that meet a particular filter pattern. You can have subscriptions push data to either an Amazon Kinesis stream for real-time data processing or to a Lambda function for event-driven processing. You can even use a Lambda function to push logs that are driven into one or more CloudWatch log groups directly into the managed Elasticsearch service for easier searching and graphical trending using the Kibana interface.  </p>
			<p>With an overview of CloudWatch Logs out of the way, let's take a closer look at some of the terms we just used for this service and how they all work together in CloudWatch Logs.  </p>
			<h2 id="_idParaDest-361"><a id="_idTextAnchor371"/>CloudWatch Logs terminology</h2>
			<p>As we start to get deeper into <a id="_idIndexMarker1266"/>CloudWatch Logs, there are some terms that we need to be familiar with, especially in the context of both the following exercise and the professional exam: </p>
			<p><strong class="bold">Filter pattern</strong>: The filtering<a id="_idIndexMarker1267"/> expressions that restrict which logs get forwarded to the AWS destination resource. </p>
			<p><strong class="bold">Log events</strong>: A <a id="_idIndexMarker1268"/>record of some activity that's been recorded in CloudWatch Logs is known as a log event. Event messages must be in UTF-8 format. </p>
			<p><strong class="bold">Log streams</strong> and <strong class="bold">Log groups</strong>: A group of log streams<a id="_idIndexMarker1269"/> that share the same<a id="_idIndexMarker1270"/> source is grouped in the CloudWatch Logs console as log groups. There is no limit on how many log streams can be a part of one log group. </p>
			<p><strong class="bold">Metric filters</strong>: Using metric filters, you can <a id="_idIndexMarker1271"/>extract data from ingested events. You can then convert them into data points on a CloudWatch metric. Metric filters are assigned to log groups. All log streams in a particular log group get the particular metric filters assigned. </p>
			<p><strong class="bold">Retention settings</strong>: How long <a id="_idIndexMarker1272"/>your log files are kept in CloudWatch Logs is determined by the retention settings. By default, logs are kept indefinitely and never expire. This can lead to extra costs if you do not need your logs over a specified time. Instead, you<a id="_idIndexMarker1273"/> can choose a retention period between 1 day and 10 years for each log group, and once the retention period is met, then the logs will be automatically deleted:</p>
			<div>
				<div id="_idContainer198" class="IMG---Figure">
					<img src="Images/Figure_14.4_B17405.jpg" alt="Figure 14.4 – The flow of logs from resources to CloudWatch Logs &#13;&#10;" width="750" height="310"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.4 – The flow of logs from resources to CloudWatch Logs </p>
			<p>Using the terms we just learned, in the preceding diagram, we can see how a log that has been generated from an AWS resource becomes a log stream. One or more streams are combined to form a log group. Log streams are then retained or deleted based on the retention settings. </p>
			<p>Next, we will learn how to use one of the features of CloudWatch logs, Insights, to analyze the data that is being captured by the CloudWatch Logs service. </p>
			<h1 id="_idParaDest-362"><a id="_idTextAnchor372"/>CloudWatch alarms </h1>
			<p>In addition to shipping <a id="_idIndexMarker1274"/>your logs for storage and searching, another aspect of monitoring your system is being alerted when something goes awry. These could be simple notifications that let you know that a service or server is not being responsive. It could also be proactive alerts, letting you know that the platform that you are running your application on is running out of CPU or memory and needs to be scaled before larger issues arise. </p>
			<p>You can use the <strong class="bold">CloudWatch</strong> service to monitor either a single metric or multiple conditions to create alarms. These alarms can be raised when the metrics of the underlying resources meet a certain criterion. There are two types of alarms that you can create in CloudWatch: metric alarms and composite alarms. </p>
			<p>A <strong class="bold">metric alarm</strong> monitors <a id="_idIndexMarker1275"/>a specific metric of CloudWatch. It has a threshold for monitoring that is set when it's initially created, along with the number of periods that can break the threshold before going into an alarm state. Once that alarm state has been triggered, then an action can be configured. Available actions include sending a notification to an SNS topic, performing an EC2 action, performing an AutoScaling action, or creating an OpsItem or incident in Systems Manager. </p>
			<p>A <strong class="bold">composite alarm</strong> uses <a id="_idIndexMarker1276"/>multiple alarm states that you have created to allow you to create specific conditions when the alarm goes off. </p>
			<p>Once the alarm goes off, you can have the alarm perform a variety of actions, such as the following:</p>
			<ul>
				<li>Stop, terminate, or reboot an EC2 instance.</li>
				<li>Have an autoscaling group scale up or down.</li>
				<li>Send a notification message to an AWS SNS topic. </li>
			</ul>
			<div>
				<div id="_idContainer199" class="IMG---Figure">
					<img src="Images/Figure_14.5_B17405.jpg" alt="Figure 14.5 – Examples of CloudWatch alarms&#13;&#10;" width="611" height="311"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.5 – Examples of CloudWatch alarms</p>
			<p>There are certain facts about<a id="_idIndexMarker1277"/> CloudWatch alarms that you should know about when studying for the DevOps Professional exam. While the Professional exam will not test you on these facts verbatim, they can be incorporated into a larger scenario:</p>
			<ul>
				<li>Alarm names can only be comprised of ASCII characters.</li>
				<li>You can create up to 5,000 alarms per region, per account.</li>
				<li>You can add alarms to CloudWatch dashboards.</li>
				<li>You can test alarms by using the <strong class="source-inline">SetAlarmState</strong> setting (either to engage or disengage the alarm).</li>
				<li>The CloudWatch service saves alarm history for 2 weeks.</li>
			</ul>
			<p>Next, we will create a CloudWatch alarm and create some events to trigger the alarm. To receive the notifications for the alarm, we will also need to create an SNS topic. However, you can skip this first step if you already have an SNS topic and would like to use that previously created topic. Just make sure that if you are going to skip this step, you are subscribed to the topic.  </p>
			<h2 id="_idParaDest-363"><a id="_idTextAnchor373"/>Creating a CloudWatch alarm </h2>
			<p>You should have<a id="_idIndexMarker1278"/> an EC2 instance that is creating metrics that have been stood up from our previous exercise. We will use the metrics from this instance to monitor for an alarm and then stress the instance so that an alarm is created. </p>
			<p>For us to receive notifications for the alarm, we will need an SNS topic that we can subscribe our email address to:</p>
			<ol>
				<li value="1">Open your terminal and type the following commands to create <strong class="source-inline">topic</strong>:<p class="source-code"><strong class="bold"> $aws sns create-topic --name cwatch</strong></p><p>If <strong class="source-inline">topic</strong> was created successfully, then it should return something like this:</p><p class="source-code"><strong class="bold">{</strong></p><p class="source-code"><strong class="bold">    "TopicArn": "arn:aws:sns:us-east-2:470066103307:cwatch"</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>Now that we have our <strong class="source-inline">topic</strong>, we need to use <strong class="source-inline">subscribe</strong> with our email address:<p class="source-code"><strong class="bold">$ aws sns subscribe \</strong></p><p class="source-code"><strong class="bold">    --topic-arn arn:aws:sns:us-east-2:470066103307:cwatch \</strong></p><p class="source-code"><strong class="bold">    --protocol email \</strong></p><p class="source-code"><strong class="bold">    --notification-endpoint devopsproandbeyond@gmail.com</strong></p><p>This should return a <strong class="source-inline">JSON</strong> statement telling you that the subscription is pending:</p><p class="source-code"><strong class="bold">{</strong></p><p class="source-code"><strong class="bold">    "SubscriptionArn": "pending confirmation"</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>Now, we need to go to our email account and find the email that the SNS service has just sent. Then, we must click on the link that says <strong class="bold">Confirm Subscription</strong>.</li>
				<li>With our SNS topic created, we can now back to the AWS Management Console and navigate to the <strong class="bold">EC2 </strong>service. Click on the <strong class="bold">EC2</strong> dashboard and click on the <strong class="bold">Instances (running)</strong> link under the resources section. Find the instance we created named <strong class="source-inline">CW_Agent</strong> and make a note of the instance ID. Once you have this marked down, go to the CloudWatch service under the <strong class="bold">Services</strong> dropdown at the top left of the navigation bar. Open the CloudWatch service in a new tab; we will need to come back to this instance to test our alarm later. </li>
				<li>Once you're in the<a id="_idIndexMarker1279"/> CloudWatch service, find the <strong class="bold">Alarms</strong> menu setting from the left-hand menu. Click on this to expand the menu item and view the sub-menu items. Once expanded, click on <strong class="bold">All alarms</strong> so that you can be taken to the <strong class="bold">Alarms</strong> screen. </li>
				<li> On the <strong class="bold">Alarms</strong> page, click on the orange button labeled <strong class="bold">Create Alarm</strong> to create a new alarm. This will bring up the prompts for creating the alarm. </li>
				<li>Click on the <strong class="bold">Select metric</strong> button. This will bring up a dialog where you can choose the metric. Find <strong class="bold">Custom Namespaces</strong> and click on <strong class="bold">CWAgent</strong>. Once you're inside the <strong class="bold">CWAgent</strong> namespace, choose the grouping labeled <strong class="bold">ImageId, InstanceId, InstanceType</strong> and click on this link. </li>
				<li>Find the metric named <strong class="source-inline">mem_used_percent</strong>. However, before clicking on the box to select it, make sure that the <strong class="screen-inline">InstanceId</strong> matches the instance ID that you found earlier. If everything matches, then select the checkbox to the left of the metric to use this metric in the alarm. When you select this metric or any metric, a graph will appear at the top, showing the recorded values for the metric you selected. Click on the orange <strong class="bold">Select metric</strong> button at the bottom to continue:<div id="_idContainer200" class="IMG---Figure"><img src="Images/Figure_14.6_B17405.jpg" alt="Figure 14.6 – Selecting the single metric to monitor when creating a CloudWatch alarm&#13;&#10;" width="1127" height="247"/></div><p class="figure-caption">Figure 14.6 – Selecting the single metric to monitor when creating a CloudWatch alarm</p></li>
				<li>Scroll down to the <strong class="bold">Conditions</strong> section of the next page. Under <strong class="bold">Threshold type</strong>, choose <strong class="bold">Static</strong> and <strong class="bold">Greater</strong>, and set the defined value to <strong class="source-inline">20</strong>. Once you have changed these values, click the orange <strong class="bold">Next</strong> button. </li>
				<li>Now, on the <strong class="bold">Notifications</strong> screen, use the following selections. Once you have filled in all the <a id="_idIndexMarker1280"/>sections, scroll to the bottom of the page and click the orange <strong class="bold">Next</strong> button:<p>a. <strong class="bold">Alarm state trigger</strong>: In Alarm. </p><p>b. <strong class="bold">Select an SNS Topic</strong>: Select an existing SNS topic. </p><p>c. <strong class="bold">Send notification to</strong>: Choose the cwatch notification topic you just created.</p></li>
				<li>Next, on the <strong class="bold">Add name and description</strong> page, use <strong class="source-inline">chapter14</strong> as the alarm name. Click the orange <strong class="bold">Next</strong> button. </li>
				<li>Finally, on the <strong class="bold">Preview and create</strong> page, scroll down to the bottom of the page, checking the values of the items on the way down. If everything looks right, then click on the orange <strong class="bold">Create Alarm</strong> button at the bottom of the page. </li>
				<li>Now that we have created our alarm, we need to test it. We could test it by changing <strong class="source-inline">SetAlarmState</strong> using the CLI. However, we are going to test our alarm by performing a stress test on the EC2 instance itself. Find the tab that contains the instance ID that we opened earlier. Select the checkbox next to the instance, and then at the top of the <strong class="bold">Instances</strong> screen in the AWS Management Console, find the dropdown labeled <strong class="bold">Actions</strong>. Click on the <strong class="bold">Actions</strong> menu to expose the sub-menu items. Choose <strong class="bold">Connect</strong>. </li>
				<li>On the <strong class="bold">Connect</strong> screen, use <strong class="bold">Session Manager</strong> to connect to the instance. Once on the <strong class="bold">Session Manager</strong> tab, click on the orange <strong class="bold">Connect</strong> button at the bottom to start our session inside of our EC2 instance. </li>
				<li>Now that we are inside the instance, we will need to install a package to help us stress test the instance and set off the alarm. Run the following command to install the package:<p class="source-code"><strong class="bold">sudo apt-get install -y stress</strong></p></li>
				<li>Once the <strong class="source-inline">stress</strong> package has been installed, we can run it with the following options to stresstest the memory of the instance:<p class="source-code"><strong class="bold">stress –vm 2 –vm-bytes 126M</strong></p></li>
				<li>After the <strong class="bold">Memory used</strong> percent on the instance goes above 20% for 5 minutes, you<a id="_idIndexMarker1281"/> should receive an email notification to whatever email you subscribed with in the SNS topic. </li>
			</ol>
			<p>Now that we have seen how the CloudWatch service can collect and aggregate our logs and help us with our monitoring duties with sending alerts, we will take a look at another tool in our monitoring and debugging toolbelt: <strong class="bold">AWS X-Ray</strong>. </p>
			<h1 id="_idParaDest-364"><a id="_idTextAnchor374"/>Adding application tracing with X-Ray </h1>
			<p><strong class="bold">X-Ray</strong><a id="_idIndexMarker1282"/> is a service that's used to monitor modern web applications. Modern applications are essentially service-oriented applications. These can be serverless architecture applications or applications that run inside containers. With these modern applications, the app itself is broken into multiple pieces. While this presents many advantages, including ease of scaling in a horizontal nature and taking full advantage of cloud-native services, it can also present some challenges. Understanding where errors are ultimately impacting your service (or business) becomes more problematic. </p>
			<p>Tracing allows you to connect the <a id="_idIndexMarker1283"/>dots in a modern application by<a id="_idIndexMarker1284"/> letting you do the following:</p>
			<ul>
				<li>Discover multiple services.</li>
				<li>Get insights into individual operations.</li>
				<li>See issues isolated within a segment.</li>
				<li>Perform root cause analysis for a specific issue.</li>
			</ul>
			<div>
				<div id="_idContainer201" class="IMG---Figure">
					<img src="Images/Figure_14.7_B17405.jpg" alt="Figure 14.7 – How an X-Ray trace breaks down pieces into segments&#13;&#10;" width="538" height="235"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.7 – How an X-Ray trace breaks down pieces into segments</p>
			<p>Tracing allows you to <a id="_idIndexMarker1285"/>quickly look at and easily examine what happened<a id="_idIndexMarker1286"/> for a particular API call or a particular user. </p>
			<p>A <strong class="bold">trace</strong> is a <a id="_idIndexMarker1287"/>holistic view, and it encapsulates the end-to-end transactions from a customer standpoint where the customer created the transaction. </p>
			<p>At that point, X-Ray breaks the trace down into segments. Segments are chunks that come from individual servers. </p>
			<p>Now that we understand traces, which are one of the main concepts in X-Ray, let's look at how the X-Ray service itself works. </p>
			<p>The trace is then broken up into various<a id="_idIndexMarker1288"/> segments. A <strong class="bold">segment</strong> furnishes the name of the resource, the specifics about the request, and the work being done. Segments can also show issues that occur in the segment, such as errors, faults, and exceptions. </p>
			<h2 id="_idParaDest-365"><a id="_idTextAnchor375"/>How does the X-Ray service work?</h2>
			<p>You start by <a id="_idIndexMarker1289"/>integrating the X-Ray SDK into your applications. This can be customized for different languages such as Python, Java, and Node.js. Next, an on-instance daemon starts to collect the data. The daemon then ships this data to the X-Ray backend. At the X-Ray backend, the traces are then recorded. There may be feeds coming for different services at multiple points in time, yet the X-Ray service can piece all of this information together using <a id="_idIndexMarker1290"/>a <strong class="bold">trace id</strong>. Once the trace has been collected, the X-Ray service creates an aggregated view<a id="_idIndexMarker1291"/> called a <strong class="bold">Service Map</strong>. Finally, X-Ray presents a set of analytics capabilities that allow you to dive into and answer three valuable questions.</p>
			<p>Another item to note is that the X-Ray service is cloud-agnostic. This means that the code you have written doesn't have to only run in the AWS cloud. The code can run in other places to take advantage of the X-Ray service's tracing capabilities, such as on a developer's laptop or in a corporate data center. This assumes that the environment that it is running in has connectivity back to the AWS X-Ray service and a set of credentials that will enable it to run. </p>
			<h3>X-Ray helps you answer three questions</h3>
			<p>The X-Ray service helps<a id="_idIndexMarker1292"/> developers answer three specific questions: </p>
			<ol>
				<li value="1"><strong class="bold">How</strong> is my application doing?</li>
				<li><strong class="bold">Why</strong> is my application performing the way it is?</li>
				<li><strong class="bold">Who</strong> is impacted by the issues?</li>
			</ol>
			<p>The graphical nature of the X-Ray interface, which is depicted as a service graph, lets you and your development team see where the users of your application are consuming resources. It also gives you the times of responses for the different resources so that you can see if a particular resource is the cause of latency or trouble issues. </p>
			<p>Now that we understand how X-Ray can help us with developing and troubleshooting our applications that are running on the AWS cloud, let's take a look a how the X-Ray service integrates with serverless services. </p>
			<h2 id="_idParaDest-366"><a id="_idTextAnchor376"/>X-Ray and serverless services</h2>
			<p>When using X-Ray<a id="_idIndexMarker1293"/> in conjunction with serverless services and Lambda, in particular, the X-Ray service brings a few unique benefits to the table that you would not get with CloudWatch monitoring. X-Ray lets you obtain information on the timing of AWS Lambda cold starts. </p>
			<p>When a Lambda service first receives a request to run a function, it needs to prepare an execution environment. This means that it needs to retrieve the code from an S3 bucket where the code is stored and then allocate the runtime environment, which includes the memory and CPU. After performing any last initialization steps, Lambda can then run the handler. </p>
			<h2 id="_idParaDest-367"><a id="_idTextAnchor377"/>Implementing X-Ray on a Lambda function</h2>
			<p>In <a href="B17405_12_Final_JM_ePub.xhtml#_idTextAnchor307"><em class="italic">Chapter 12</em></a>, <em class="italic">Lambda Deployments and Versioning</em>, we went over AWS Lambda. This is the Function-as-a-Service <a id="_idIndexMarker1294"/>offering from AWS. We can take <a id="_idIndexMarker1295"/>the functions we build and then enable the X-Ray service on one of them to see the traces and segments from AWS X-Ray: </p>
			<p class="callout-heading">Note</p>
			<p class="callout">If you have either not done the <em class="italic">Creating a Lambda function</em> exercise in <a href="B17405_12_Final_JM_ePub.xhtml#_idTextAnchor307"><em class="italic">Chapter 12</em></a>, <em class="italic">Lambda Deployments and Versioning</em>, where we went through the process of creating the word count function, or you have deleted this function from your account, please go back and do/redeploy this exercise. We will be using this function to continue our AWS X-Ray exercise. </p>
			<ol>
				<li value="1">Log into <strong class="bold">AWS Management Console</strong> and navigate to the <strong class="bold">Lambda</strong> service. </li>
				<li>Once at the <strong class="bold">Lambda</strong> service, find the function we created previously in <a href="B17405_12_Final_JM_ePub.xhtml#_idTextAnchor307"><em class="italic">Chapter 12</em></a>, <em class="italic">Lambda Deployments and Versioning</em>, named <strong class="source-inline">my_word_count_python</strong>. Click on the name of this function to be taken to this function. If you have not created this function or had deleted it after performing the exercise, you have two options. You can go back and recreate the function or you can try and follow the steps for another function that you have created in your account to implement the X-Ray tracing service. </li>
				<li>Now that you are in the <strong class="bold">Lambda</strong> service, scroll down the page until you find the horizontal menu bar and click on the menu item named <strong class="bold">Configuration</strong>:<div id="_idContainer202" class="IMG---Figure"><img src="Images/Figure_14.8_B17405.jpg" alt="Figure 14.8 – Configuration highlighted on the Lambda horizontal menu&#13;&#10;" width="1065" height="105"/></div><p class="figure-caption">Figure 14.8 – Configuration highlighted on the Lambda horizontal menu</p></li>
				<li>The <strong class="bold">Configuration</strong> menu choice will bring up a vertical menu on the left-hand side of the screen. Locate the option named <strong class="bold">Monitoring and operations tools</strong> and click on it. This will bring <strong class="bold">Monitoring and operations view</strong> into focus. At the top right of this view, choose <strong class="bold">Edit</strong>. </li>
				<li>On the <strong class="bold">Edit monitoring tools</strong> page, find the section labeled <strong class="bold">AWS X-Ray</strong>. Click on the <strong class="bold">Slider</strong> button<a id="_idIndexMarker1296"/> to turn X-Ray tracing on for <a id="_idIndexMarker1297"/>this Lambda function. Then, click <strong class="bold">Save</strong> at the bottom of the page:<div id="_idContainer203" class="IMG---Figure"><img src="Images/Figure_14.9_B17405.jpg" alt="Figure 14.9 – Adding AWS X-Ray to our Lambda function&#13;&#10;" width="1224" height="373"/></div><p class="figure-caption">Figure 14.9 – Adding AWS X-Ray to our Lambda function</p></li>
				<li>Clicking <strong class="bold">Save</strong> will take you back to the <strong class="bold">Monitoring and operations tools</strong> page under the <strong class="bold">Configuration</strong> header. You should see that <strong class="bold">Active tracing</strong> is now enabled. With tracing enabled, let's run a test to see X-Ray in action. From the horizontal navigation bar, click the menu item named <strong class="bold">Test</strong>. </li>
				<li>If you need to create another test event, then you can use the default data and save it as <strong class="source-inline">XRtest</strong>. If you still have the Lambda function up from the previous exercise, then you should have a test event named <strong class="source-inline">Test1</strong> that we previously created. With your test event created, click the orange <strong class="bold">Test</strong> button in the top-right corner of the <strong class="bold">Test event</strong> section:<div id="_idContainer204" class="IMG---Figure"><img src="Images/Figure_14.10_B17405.jpg" alt="Figure 14.10 – The orange test button to the right of the Test event section&#13;&#10;" width="707" height="51"/></div><p class="figure-caption">Figure 14.10 – The orange test button to the right of the Test event section</p></li>
				<li>Once your test event has run, we can click on the <strong class="bold">Monitor</strong> menu item on the horizontal menu to be taken to the <strong class="bold">Monitoring</strong> page. By default, this page will be on the metrics section. However, we will click on the item named <strong class="bold">Traces</strong> so that we can see the X-Ray trace that was produced. </li>
				<li>On the trace screen, we<a id="_idIndexMarker1298"/> can now see a <strong class="bold">Service Map</strong>, which<a id="_idIndexMarker1299"/> was produced along with the trace ID of the function, which was traced in the following table:<div id="_idContainer205" class="IMG---Figure"><img src="Images/Figure_14.11_B17405.jpg" alt="Figure 14.11 – The generated X-Ray Service Map&#13;&#10;" width="845" height="327"/></div><p class="figure-caption">Figure 14.11 – The generated X-Ray Service Map</p></li>
				<li>Go back to the <strong class="bold">Test</strong> section and click <strong class="bold">Test event</strong> about two to three more times. Once the Lambda invocations have been completed, you can go back to the <strong class="bold">Monitor</strong> tab and look at the trace table once again:</li>
			</ol>
			<div>
				<div id="_idContainer206" class="IMG---Figure">
					<img src="Images/Figure_14.12_B17405.jpg" alt="Figure 14.12 – Table of traces from the same Lambda function&#13;&#10;" width="1206" height="283"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.12 – Table of traces from the same Lambda function</p>
			<p>If you clicked the test <a id="_idIndexMarker1300"/>event multiple times in a row, then in the <strong class="bold">Response Time</strong> column in the table, you should see that there will be some functions that have<a id="_idIndexMarker1301"/> a much faster response time than others. This is because there is no cold start needed for these functions. </p>
			<p>We just went through an exercise that took a previous Lambda function that we had running, and then allowed us to gain more information on it by adding X-Ray traces. We could see the path of the calls, starting from the customer, as well as the variations in the time that the function takes to respond initially. </p>
			<p>Next, let's wrap up what we learned in this chapter regarding AWS CloudWatch and X-Ray. </p>
			<h1 id="_idParaDest-368"><a id="_idTextAnchor378"/>Summary</h1>
			<p>In this chapter, we looked at the importance of monitoring for our different environments and applications, especially the CloudWatch service. </p>
			<p>In the next chapter, we will continue to look at the CloudWatch service by looking deeper at the monitoring and metrics capabilities of the service. We will also learn how to automate reactions from the CloudWatch service using AWS EventHub. </p>
			<h1 id="_idParaDest-369"><a id="_idTextAnchor379"/>Review questions </h1>
			<p>Answer the following questions to test your knowledge of this chapter:</p>
			<ol>
				<li value="1">You have been hired by a company to help the DevOps team. The team currently needs help with their monitoring. The company wants to use all native AWS services rather than third-party services. There is currently a production RDS PostgreSQL database that needs to be monitored closely as it is the main data store for the customer orders. Which services can be used to monitor and alert in real time if the IOPs metrics exceed the normal levels and allow the DevOps teams to provision more IOPs? (Choose two) <p>a. Amazon CloudWatch </p><p>b. Amazon CloudTrail </p><p>c. Amazon Simple Notification Service </p><p>d. Amazon Route 53</p></li>
				<li>You have developed a modern application using AWS Lambda functions for a company that is invoked when someone places a file in an S3 bucket. The company would like more visibility into the application and has requested that you integrate AWS X-Ray into the Lambda function so that they can see the traces. How should you do this to ensure that you make sure that all non-instrumented services that invoke your Lambda function are traced?<p>a. Under the AWS Lambda function configuration, enable Start tracing.</p><p>b. Under the AWS Lambda function configuration, enable Active tracing. </p><p>c. Lambda functions do not support tracing when invoked by non-instrumented services.</p><p>d. Lambda functions do not need any additional configuration to record traces when invoked by non-instrumented services.</p></li>
				<li>You have been brought on to a team that is using a mainly serverless architecture consisting of Lambda functions. They want to be able to analyze the invocations of the functions during the testing phase of their SDLC. Which of the two (2) following tools will help them achieve this?<p>a. Amazon CloudTrail</p><p>b. Amazon CloudWatch </p><p>c. Amazon Inspector</p><p>d. Amazon X-Ray</p></li>
			</ol>
			<h1 id="_idParaDest-370"><a id="_idTextAnchor380"/>Review answers</h1>
			<ol>
				<li value="1">a, c</li>
				<li>b</li>
				<li>b, d </li>
			</ol>
		</div>
	</div></body></html>