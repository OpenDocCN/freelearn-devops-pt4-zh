<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer294">
			<h1 id="_idParaDest-450"><a id="_idTextAnchor462"/>Chapter 20: Enforcing Standards and Compliance with System Manger's Role and AWS Config</h1>
			<p>Systems Manager is a<a id="_idIndexMarker1593"/> service comprising multiple individual capabilities grouped into five categories: Operations Management, Application Management, Change Management, Node Management, and Shared Resources. Learning to use this tool effectively can make you, as a DevOps professional, much more efficient, especially when implementing standards and checking for compliance in one or multiple AWS environments or accounts. And as automation and compliance demands increase from organizations, having a tool that can check for compliance, alert against discrepancies, and remediate violations can be essential in preventing environmental drift.</p>
			<p>In this chapter, we're going to cover the following main topics:  </p>
			<ul>
				<li>The various capabilities of AWS Systems Manager </li>
				<li>Using runbooks in Systems Manager </li>
				<li>AWS Config essentials </li>
			</ul>
			<h1 id="_idParaDest-451"><a id="_idTextAnchor463"/>The various capabilities of AWS Systems Manager</h1>
			<p>DevOps is a marriage of two responsibilities: development and operations. AWS <strong class="bold">Systems Manager</strong> (<strong class="bold">SSM</strong>) focuses<a id="_idIndexMarker1594"/> on the operations part of those responsibilities, giving you a vast array of tools to use for everyday operations tasks. These tools range from creating <a id="_idIndexMarker1595"/>predefined runbooks to quickly, easily, and repetitively performing functions on your instances, whether they're Linux or Windows instances. Systems Manager can also provide you with an interface to track your resources or groups of resources from a common place. </p>
			<p>As an added benefit, Systems Manager not only helps with your instances in the AWS Cloud, but it <a id="_idIndexMarker1596"/>can also help manage your servers on-premises by installing the lightweight agent on those servers and allowing that agent to communicate back to the AWS account.</p>
			<h2 id="_idParaDest-452"><a id="_idTextAnchor464"/>Key features and benefits of Systems Manager </h2>
			<p>Systems Manager is <a id="_idIndexMarker1597"/>not just one service; instead, it is a whole <a id="_idIndexMarker1598"/>set of tools for you to use. You may not use all of its capabilities, but knowing them can help when you are looking to solve a problem quickly:</p>
			<div>
				<div id="_idContainer273" class="IMG---Figure">
					<img src="Images/Figure_20.1_B17405.jpg" alt="Figure 20.1 – An overview of many of the critical components that make up Systems Manager&#13;&#10;" width="769" height="284"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.1 – An overview of many of the critical components that make up Systems Manager</p>
			<p>Now that we have looked at some of the capabilities that Systems Manager provides, let's dive deeper into managing our instances and nodes more effectively with it.  </p>
			<h2 id="_idParaDest-453"><a id="_idTextAnchor465"/>Node management with Systems Manager </h2>
			<p>Systems Manager <a id="_idIndexMarker1599"/>provides many capabilities to operations team members, but there is a whole category of items that specifically fall<a id="_idIndexMarker1600"/> into the category of <strong class="bold">Node management</strong>. </p>
			<p>We will look at <a id="_idIndexMarker1601"/>some of the specialty services in AWS Config that have been created for the express purpose of node management. </p>
			<h3>Fleet Manager </h3>
			<p>Knowing all the different instances that you are controlling at once can <a id="_idIndexMarker1602"/>be an<a id="_idIndexMarker1603"/> overwhelming task. SSM Fleet Manager provides you with a user interface to see all the instances in which you are in control. Fleet Manager also allows you to gather data from those instances to relay back without ever having to go into the servers or instances individually.  </p>
			<h3>Inventory</h3>
			<p>If you <a id="_idIndexMarker1604"/>need<a id="_idIndexMarker1605"/> visibility into either your on-premises servers, your Cloud EC2 instances, or both, then the <strong class="bold">Inventory</strong> capability of Systems Manager can be extremely useful for you. </p>
			<h3>Hybrid activations</h3>
			<p>If you have servers that <a id="_idIndexMarker1606"/>are not on the AWS cloud or on-premises, you can use SSM <strong class="bold">Hybrid Activations</strong> to manage both those devices, along with other EC2 instances that need to<a id="_idIndexMarker1607"/> be managed in a single management console. The hybrid activations capability helps walk you through the prerequisites required to create an activation on an on-premises server. This includes creating an IAM service role, ensuring that the operating system is compatible, and installing the Systems Manager agent. </p>
			<h3>Session manager </h3>
			<p>Managing<a id="_idIndexMarker1608"/> all the different PEM keys, for instance, especially when developers create their own keys, can be a burdensome task. <strong class="bold">Session Manager</strong> helps <a id="_idIndexMarker1609"/>ease this burden by allowing authorized users to use a web-based console to perform commands without the need to have a copy of the key. Instead, you can find the name of the machine that you need to create a session remotely and then instantly start a session. </p>
			<p>We will go through an exercise that covers using the Session Manager capability later in this chapter. </p>
			<h3>Run command </h3>
			<p>With the <strong class="bold">run command</strong> capability<a id="_idIndexMarker1610"/> of Systems Manager, you can securely update the configuration <a id="_idIndexMarker1611"/>of your registered managed instances. <strong class="bold">Command documents</strong> are created for the <a id="_idIndexMarker1612"/>run command to execute. Commands are then run for specified targets of managed instances using either instance IDs or tags. </p>
			<p class="callout-heading">Tip</p>
			<p class="callout">You should always test the run commands that you create on non-production or test instances. This way, you can make sure that the command is going to perform the way you expect before enacting the commands or servers taking on production traffic. </p>
			<h3>State manager </h3>
			<p>Systems <a id="_idIndexMarker1613"/>manager's <strong class="bold">State Manager</strong> allows you to perform the<a id="_idIndexMarker1614"/> following actions:</p>
			<ul>
				<li>You can configure network settings. </li>
				<li>You can have your instances join a Windows domain.</li>
				<li>It allows you to install software at instance startup using bootstrap scripts.</li>
				<li>It lets you run scripts on Windows-, Linux-, or even macOS-managed instances throughout their life cycle. </li>
			</ul>
			<h3>Patch manager </h3>
			<p>If you <a id="_idIndexMarker1615"/>are not running immutable infrastructure in your environment, then you <a id="_idIndexMarker1616"/>should have a strategy to keep your instances up to date system patches. Patch manager allows you to add these system patches on a maintenance schedule.</p>
			<h2 id="_idParaDest-454"><a id="_idTextAnchor466"/>Running remote commands on an EC2 instance</h2>
			<p>Previously, if you<a id="_idIndexMarker1617"/> wanted to <a id="_idIndexMarker1618"/>run a remote command on an EC2 instance, then <a id="_idIndexMarker1619"/>you had to create a PEM-encoded key. SSM Session Manager changes all of this as it allows you to log in to an instance using a web browser using a role that has the <a id="_idIndexMarker1620"/>correct permissions instead of managing and rotating keys. </p>
			<p class="callout-heading">Note </p>
			<p class="callout"><strong class="bold">PEM</strong> stands for <strong class="bold">Privacy-Enhanced Mail</strong>, but this is just extra knowledge, and knowing the <a id="_idIndexMarker1621"/>definition of PEM will not be a requirement for the exam.   </p>
			<p>We'll see how<a id="_idIndexMarker1622"/> this works in the following exercise. Before we can go about using Systems Manager to remotely access an instance, we need to set up an IAM role that will allow the SSM service permissions to access any instance that has that role. Luckily for us, AWS already has a managed IAM policy that contains all of the permissions that we need to <a id="_idIndexMarker1623"/>accomplish this task; however, we still need to create a role that we can attach to our EC2 instance. Let's get started: </p>
			<ol>
				<li>Open your browser and <a id="_idIndexMarker1624"/>go to the Amazon web console, navigating to the IAM service: <a href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a>.</li>
				<li>From the left navigation bar, choose <strong class="bold">Roles</strong> and then press the blue <strong class="bold">Create Role</strong> button in the mainframe once it appears. </li>
				<li>On the <strong class="bold">Select type of trusted entity</strong> page, make sure that <strong class="bold">AWS service</strong> is selected.<div id="_idContainer274" class="IMG---Figure"><img src="Images/Figure_20.2_B17405.jpg" alt="Figure 20.2 – Selecting AWS service as the type of entity when creating a role&#13;&#10;" width="1092" height="171"/></div><p class="figure-caption">Figure 20.2 – Selecting AWS service as the type of entity when creating a role</p></li>
				<li>Then, from the list of common use cases, find <strong class="bold">EC2</strong> and click on it to select it. Once selected, you can click the blue <strong class="bold">Next: Permissions</strong> button located at the bottom right of the page. <div id="_idContainer275" class="IMG---Figure"><img src="Images/Figure_20.3_B17405.jpg" alt="Figure 20.3 – Common use cases when creating a role in IAM&#13;&#10;" width="528" height="153"/></div><p class="figure-caption">Figure 20.3 – Common use cases when creating a role in IAM</p></li>
				<li>Now <a id="_idIndexMarker1625"/>that you're on the <strong class="bold">Attach permissions policies</strong> page, in the search box in the middle of the screen, search for the policy named <em class="italic">AmazonEC2RoleforSSM</em>. Select the box next to the policy <a id="_idIndexMarker1626"/>once it appears in the search results. Once selected, you can click the blue <strong class="bold">Next: Tags</strong> button to continue.<div id="_idContainer276" class="IMG---Figure"><img src="Images/Figure_20.4_B17405.jpg" alt="Figure 20.4 – Adding a managed permission policy to the IAM role&#13;&#10;" width="1083" height="171"/></div><p class="figure-caption">Figure 20.4 – Adding a managed permission policy to the IAM role</p></li>
				<li>On the <strong class="bold">Add Tags</strong> page, just select the <strong class="bold">Next: Review</strong> button at the bottom of the page since we are not adding tags to this role. </li>
				<li>On the <strong class="bold">Review</strong> page, you are going to need to name your role. I suggest using <strong class="source-inline">Remote2EC2SSM</strong>. You can change the role description if you like to something that is <a id="_idIndexMarker1627"/>more fitting of what the role allows. Once you have made these updates, click the blue <strong class="bold">Create Role</strong> button at the bottom of the page. Great! Your role should now be created.<div id="_idContainer277" class="IMG---Figure"><img src="Images/Figure_20.5_B17405.jpg" alt="Figure 20.5 – Adding the role name and description&#13;&#10;" width="1037" height="320"/></div><p class="figure-caption">Figure 20.5 – Adding the role name and description</p><p>With our <a id="_idIndexMarker1628"/>role created, we can start creating a temporary EC2 instance that we will use for testing the capabilities of SSM. </p></li>
				<li>Find the <strong class="bold">Services</strong> menu<a id="_idIndexMarker1629"/> item on the left-hand side of the top menu. Click on the word <strong class="bold">services</strong> to bring up the drop-down menu, which will show all the AWS services. Click on <strong class="bold">EC2</strong>, which should be near the top, under the <strong class="bold">Compute</strong> heading, to be taken to the <strong class="bold">EC2</strong> service page.<div id="_idContainer278" class="IMG---Figure"><img src="Images/Figure_20.6_B17405.jpg" alt="Figure 20.6 – EC2 service page&#13;&#10;" width="223" height="165"/></div><p class="figure-caption">Figure 20.6 – EC2 service page</p></li>
				<li>Once you're on the <strong class="bold">EC2</strong> page, find the <strong class="bold">Launch instance</strong> section in the middle of the <a id="_idIndexMarker1630"/>page. Click on the orange <strong class="bold">Launch instance</strong> button inside this section to begin launching your instance. When you click on that button, you will be presented with two options; choose the option labeled <strong class="bold">Launch instance</strong>.<div id="_idContainer279" class="IMG---Figure"><img src="Images/Figure_20.7_B17405.jpg" alt="Figure 20.7 – Launching an EC2 instance from the main EC2 page&#13;&#10;" width="732" height="221"/></div><p class="figure-caption">Figure 20.7 – Launching an EC2 instance from the main EC2 page</p></li>
				<li>Now <a id="_idIndexMarker1631"/>you should be on a page where you should be able to select the AMI that you want to use. Select any <strong class="bold">Amazon Linux</strong> or <strong class="bold">Amazon Linux 2</strong> version dated 2017.09 or later as it will contain the AWS SSM <a id="_idIndexMarker1632"/>agent already preinstalled. Click the blue <strong class="bold">Select</strong> button to choose your image.<div id="_idContainer280" class="IMG---Figure"><img src="Images/Figure_20.08_B17405.jpg" alt="Figure 20.8 – Amazon Linux 2 on the AMI selection page&#13;&#10;" width="1024" height="298"/></div><p class="figure-caption">Figure 20.8 – Amazon Linux 2 on the AMI selection page</p></li>
				<li>We won't <a id="_idIndexMarker1633"/>need much computing power for our test, so we can use a <strong class="bold">t2.small instance</strong>. Click on the gray <strong class="bold">Next: Configure Instance Details</strong> button as we need to ensure that we attach our role to our instance. </li>
				<li>Once you're on the <strong class="bold">Configure Instance Details</strong> page, find the line that contains the <strong class="bold">IAM role</strong> value – this is where we need to make a change. From the drop-down menu to the right, find the role that we just created, called <strong class="source-inline">Remote2EC2SSM</strong>, and choose this value for the field. Once you have done this, click on the gray <strong class="bold">Next: Add Storage</strong> button. <div id="_idContainer281" class="IMG---Figure"><img src="Images/Figure_20.9_B17405.jpg" alt="Figure 20.9 – Choosing the Remote2EC2SSM role while configuring our EC2 instance&#13;&#10;" width="427" height="46"/></div><p class="figure-caption">Figure 20.9 – Choosing the Remote2EC2SSM role while configuring our EC2 instance</p></li>
				<li>There is nothing to change on the <strong class="bold">Add Storage</strong> page, so we will click through to the gray <strong class="bold">Next: Tags</strong> button.  Once you're on the <strong class="bold">Add Tags</strong> page, click on the gray <strong class="bold">Add Tag</strong> button in the middle of the screen. Use <strong class="source-inline">name</strong> as the key and <strong class="source-inline">Remote</strong> <strong class="source-inline">Test</strong> as the value. Make sure that you capitalized the <em class="italic">N</em> in Name, otherwise, it will not set the value <a id="_idIndexMarker1634"/>of the <a id="_idIndexMarker1635"/>name of the instance correctly and only set a tag and value pair. Once you have set the key-value pair, you can click on the blue <strong class="bold">Review and Launch</strong> button at the bottom of the page.<div id="_idContainer282" class="IMG---Figure"><img src="Images/Figure_20.10_B17405.jpg" alt="Figure 20.10 – Setting the Name for the instance using tags&#13;&#10;" width="903" height="273"/></div><p class="figure-caption">Figure 20.10 – Setting the name for the instance using tags</p></li>
				<li>On the <strong class="bold">Review Instance Launch</strong> page, click the blue <strong class="bold">Launch</strong> button at the bottom of the page. This will bring up a dialog about which key pair you would like to use. However, we are going to clear out the values from the top drop-down menu so that the value that is selected reads <strong class="bold">Proceed without a key pair</strong>. Click on the box to acknowledge that you are proceeding without a key pair, and<a id="_idIndexMarker1636"/> then click the blue <strong class="bold">Launch instances</strong> button to start your EC2 instance.<div id="_idContainer283" class="IMG---Figure"><img src="Images/Figure_20.11_B17405.jpg" alt="Figure 20.11 – Launching our EC2 instance without a keypair &#13;&#10;" width="881" height="508"/></div><p class="figure-caption">Figure 20.11 – Launching our EC2 instance without a key pair </p><p>Now <a id="_idIndexMarker1637"/>that our instance has started launching, we have finished all the prerequisites for this exercise. We can now <a id="_idIndexMarker1638"/>move on to the Systems Manager service in the AWS Console to log in without the key and perform the command(s).  </p></li>
				<li>In the <a id="_idIndexMarker1639"/>search bar at the top of the AWS Management Console, type in <em class="italic">Systems Manager</em> and click on the menu item when it appears in the list:<div id="_idContainer284" class="IMG---Figure"><img src="Images/Figure_20.12_B17405.jpg" alt="Figure 20.12 – The Systems Manager service as it appears from searching on the AWS Management Console" width="712" height="81"/></div><p class="figure-caption">Figure 20.12 – The Systems Manager service as it appears from searching on the AWS Management Console </p></li>
				<li>Once you're on the <strong class="bold">Systems Manager</strong> service page, find the <strong class="bold">Node Management</strong> heading on the left-hand menu. Under this heading, click on the menu item named <strong class="bold">Session Manager</strong>. </li>
				<li>When the main <strong class="bold">Sessions Manager</strong> page appears, click on the orange <strong class="bold">Start a session</strong> button at the top right-hand side of the main window. </li>
				<li>Now that we are on the <strong class="bold">Start a session</strong> page, we should see our instance, which we named <strong class="source-inline">Remote Test</strong> when we created the instance earlier. Click on the radio <a id="_idIndexMarker1640"/>button next to the instance's name to select this instance and then click the orange <strong class="bold">Start session</strong> button to remotely access the instance without using a PEM key. </li>
				<li>A new <a id="_idIndexMarker1641"/>tab or <a id="_idIndexMarker1642"/>browser window will appear once the <strong class="bold">Start session</strong> button has been pressed. Congratulations! You are now inside the instance that you created, without the need to start an SSH command from your terminal. Run the following command to see who you have just logged in as:<p class="source-code"><strong class="bold">$whoami</strong></p><p>It should return a value of <strong class="source-inline">ssm-user</strong>. This is the user that the Systems Manager Sessions Manager connects to. </p></li>
			</ol>
			<p>You just saw how Session Manager can make accessing instances much more accessible from an operations perspective. You no longer have to create and manage keys for your instances. However, let's talk about some of the issues that need to be taken into consideration when using Sessions Manager. </p>
			<h3>Using runbooks in Systems Manager </h3>
			<p>Since we<a id="_idIndexMarker1643"/> already have a managed instance up and running, we can create a runbook in AWS Systems Manager to see how easy it is to execute <a id="_idIndexMarker1644"/>commands on one or a thousand instances, all with the single click of a mouse remotely. </p>
			<p>Before we start, the <strong class="source-inline">clamav.json</strong> scripting file, which we will use for our runbook, is going to be available in the <strong class="source-inline">Chapter-20</strong> folder of this book's GitHub repository. Since the file is not extremely long, we will also be showing it throughout this exercise as well. </p>
			<p>This exercise <a id="_idIndexMarker1645"/>also builds upon the previous exercise, so if you wish to complete this exercise but did not do the <em class="italic">Running remote commands on an EC2 instance</em> exercise, then you will need to set up your environment by going through steps 1 to 14 in the previous exercise. Let's get started:</p>
			<ol>
				<li value="1">If you <a id="_idIndexMarker1646"/>have previously logged out of your AWS Management Console, log back in as your administrative user and navigate to the <strong class="bold">Systems Manager</strong> service, either through the top search bar or via the <strong class="bold">Services</strong> dropdown in the top left. </li>
				<li>We will need to create a document for Systems Manager to run. Although several predefined run documents are created by AWS, we will create a custom document. From the left-hand navigation menu of the <strong class="bold">Systems Manager</strong> service, under the <strong class="bold">Shared Resources</strong> header, click <strong class="bold">Documents</strong>.<div id="_idContainer285" class="IMG---Figure"><img src="Images/Figure_20.13_B17405.jpg" alt="Figure 20.13 – The Documents menu item on the Systems Manager service&#13;&#10;" width="196" height="74"/></div><p class="figure-caption">Figure 20.13 – The Documents menu item on the Systems Manager service</p></li>
				<li>Now that we're on the <strong class="bold">Documents</strong> page, we will need to find the orange <strong class="bold">Create document</strong> button at the top right-hand side. When you click on it, two options should appear. Choose the <strong class="bold">Command or Session</strong> option.<div id="_idContainer286" class="IMG---Figure"><img src="Images/Figure_20.14_B17405.jpg" alt="Figure 20.14 – The Create document button showing the two different options&#13;&#10;" width="257" height="135"/></div><p class="figure-caption">Figure 20.14 – The Create document button showing the two different options</p></li>
				<li>Once the <strong class="bold">Create document</strong> page appears, under <strong class="bold">Document details</strong>, enter in the following information:<ul><li><strong class="bold">Name</strong>: <strong class="source-inline">Linux_ClamAV_Installer</strong>.</li><li><strong class="bold">Target type</strong>: Leave this value blank.</li><li><strong class="bold">Document</strong>: <strong class="bold">Command document</strong>.</li></ul></li>
			</ol>
			<div>
				<div id="_idContainer287" class="IMG---Figure">
					<img src="Images/Figure_20.15_B17405.jpg" alt="Figure 20.15 – The Document details page when creating the document&#13;&#10;" width="1014" height="474"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.15 – The Document details page when creating the document</p>
			<ol>
				<li value="5">At the <a id="_idIndexMarker1647"/>bottom of the <strong class="bold">Create document</strong> page will be the <strong class="bold">Content</strong> section. This is where we load the script that we want <a id="_idIndexMarker1648"/>to run for our run command. You can either cut and paste the script from the <strong class="bold">clamav.json</strong> script that you downloaded at the beginning of this exercise, or you can type in the script, as shown here. Once the script is in the content box, press the orange <strong class="bold">Create document</strong> button:<p class="source-code"><strong class="bold">{</strong></p><p class="source-code"><strong class="bold">    "description": "Install ClamAV on Amazon Linux, Run freshclam and clamscan",</strong></p><p class="source-code"><strong class="bold">    "schemaVersion": "2.2",</strong></p><p class="source-code"><strong class="bold">    "mainSteps": [</strong></p><p class="source-code"><strong class="bold">      {</strong></p><p class="source-code"><strong class="bold">        "inputs": {</strong></p><p class="source-code"><strong class="bold">          "runCommand": [</strong></p><p class="source-code"><strong class="bold">            "#!/bin/bash",</strong></p><p class="source-code"><strong class="bold">            "sudo amazon-linux-extras install -y epel",</strong></p><p class="source-code"><strong class="bold">            "sudo yum -y install clamav",</strong></p><p class="source-code"><strong class="bold">            "sudo touch /var/log/freshclam.log",</strong></p><p class="source-code"><strong class="bold">            "sudo chmod 600 /var/log/freshclam.log",</strong></p><p class="source-code"><strong class="bold">            "sudo freshclam ",</strong></p><p class="source-code"><strong class="bold">            "sudo clamscan -r /var --leave-temps"</strong></p><p class="source-code"><strong class="bold">          ]</strong></p><p class="source-code"><strong class="bold">        },</strong></p><p class="source-code"><strong class="bold">        "name": "ALclamInstall",</strong></p><p class="source-code"><strong class="bold">        "action": "aws:runShellScript"</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">    ]</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>After pressing the <strong class="bold">Create document</strong> button, you will be taken back to the main <a id="_idIndexMarker1649"/>documents page. Here, you should see a <a id="_idIndexMarker1650"/>green banner at the top of the page, confirming that your document was created successfully. If you would like to quickly and easily find the document that you just created, click on the middle tab of the top menu labeled <strong class="bold">Owned by me</strong>. At this point, you should be able to see your document.<div id="_idContainer288" class="IMG---Figure"><img src="Images/Figure_20.16_B17405.jpg" alt="Figure 20.16 – The notification showing that your document was created successfully&#13;&#10;" width="392" height="42"/></div><p class="figure-caption">Figure 20.16 – The notification showing that your document was created successfully</p></li>
				<li>With <a id="_idIndexMarker1651"/>our document created, we can find the <strong class="bold">Run Command</strong> menu item underneath the <strong class="bold">Node Management</strong> heading<a id="_idIndexMarker1652"/> from the left-hand set of menu options. Click on <strong class="bold">Run Command</strong> to be taken to the <strong class="bold">Run Command</strong> capability. </li>
				<li>On the <strong class="bold">Run Command</strong> capability screen, click on the orange <strong class="bold">Run command</strong> button at the top right of the main window to start the process. </li>
				<li>For the command document to run, we are going to run the document that we just created. You can find it by typing <strong class="source-inline">Linux</strong> in the search box. Use a radio button to select an instance of the document. We will just leave the default version (1) selected since we only have one version of the document.<div id="_idContainer289" class="IMG---Figure"><img src="Images/Figure_20.17_B17405.jpg" alt="Figure 20.17 – Finding the document that we created based on a search term&#13;&#10;" width="712" height="613"/></div><p class="figure-caption">Figure 20.17 – Finding the document that we created based on a search term</p></li>
				<li>In the <strong class="bold">Targets</strong> section, we will choose our instances manually since the only tag we used<a id="_idIndexMarker1653"/> when spinning up our instance was the name tag. When you click on <strong class="bold">Choose instances manually</strong>, if you don't see the instance, then type the name of your instance; that is, <em class="italic">Remote Test</em>. Choose the selection box next to the instance's name.<div id="_idContainer290" class="IMG---Figure"><img src="Images/Figure_20.18_B17405.jpg" alt="Figure 20.18 – Choosing the target instance to run the command on&#13;&#10;" width="549" height="166"/></div><p class="figure-caption">Figure 20.18 – Choosing the target instance to run the command on</p></li>
				<li>For<a id="_idIndexMarker1654"/> the <strong class="bold">Output</strong> option, leave the <strong class="bold">Enable an S3 bucket</strong> option checked. For the <strong class="bold">S3 bucket name</strong> option, use <strong class="bold">Choose an S3 bucket name from the list</strong>. Now, use the S3 bucket that we created for the previous exercises – in our case, <strong class="source-inline">devopspro-beyond</strong>. Once you have chosen your bucket, you can click the orange <strong class="bold">Run</strong> button at the bottom of the page. </li>
				<li>Once you start the run command, you should be taken to a screen where you can see your instance and the status of <em class="italic">in progress</em> as the command runs. </li>
				<li>After a few minutes, you should see success after the command has run. </li>
			</ol>
			<p>Now that we have learned how to run remote commands on multiple instances, let's look at some of the use cases for AWS Systems Manager. </p>
			<h2 id="_idParaDest-455"><a id="_idTextAnchor467"/>Use cases for Systems Manager </h2>
			<p>Systems Manager<a id="_idIndexMarker1655"/> can help with your day-to-day operations management tasks in numerous ways. Let's take a look at some real-world use<a id="_idIndexMarker1656"/> cases for Systems Manager.</p>
			<p>You need to make sure that the EC2 instances running in your AWS account stay up to date with security patches.</p>
			<p>If you have a compliance or security requirement that all the security patches that are released must be installed in a specific timeframe, such as 7 days from release, then this can be a daunting task without automation. This is especially the case if you are not using immutable<a id="_idIndexMarker1657"/> infrastructure and are maintaining long-running instances that need to be updated. </p>
			<p>When <a id="_idIndexMarker1658"/>using<a id="_idIndexMarker1659"/> the <strong class="bold">Maintenance Windows</strong> service, which is part of SSM, you can assign a maintenance window to a group of resources that would be out of their primary task schedule and then combine this with<a id="_idIndexMarker1660"/> the <strong class="bold">Patch Manager</strong> service to install the security patches. This combination works with both Linux and Windows operating systems. It will also work for on-premises servers that have the SSM agent installed. </p>
			<p>One of the keys to success in this is making sure that you have the correct tags on your instances so that you can group the resources according to tags. With Maintenance Windows, you can combine tags when making your resource group that only target the specific types of instances that you are planning to patch.  </p>
			<p>Now that we have learned how we can manage many of our operations tasks and help keep our resources in a compliant state using AWS Systems Manager, we will move on to the AWS Config service. With AWS Config, we will learn how we can constantly record the history of our environment, visually see what has changed, and even proactively remediate items that don't comply with the rules we have set for our account. </p>
			<h1 id="_idParaDest-456"><a id="_idTextAnchor468"/>AWS Config essentials </h1>
			<p>In most cases, the <a id="_idIndexMarker1661"/>resources in an AWS account are constantly changing in one form or another. Instances are being started and stopped, along with being created and destroyed. Security settings are changing as users turn ports on and off to allow the correct protocols for communication. </p>
			<p>The AWS Config service allows you to gain a comprehensive view of what happens in your AWS account. It also lets you see how things change over time.</p>
			<p>With the<a id="_idIndexMarker1662"/> AWS Config service, the following capabilities are presented to you:</p>
			<ul>
				<li>You can assess the AWS resource configurations to see whether they conform to the desired settings for the account.</li>
				<li>The ability to save the current configuration settings as a snapshot for supported resources. </li>
				<li>You can<a id="_idIndexMarker1663"/> retrieve the historical configuration for just one or even multiple supported resources.</li>
				<li>You can set up the ability to receive notifications when resources are created, deleted, or modified.  </li>
				<li>Gain a view of the relationships that exist between resources. </li>
			</ul>
			<p>Another value that Config provides is that you can use common predefined rules or even write your own rules to check your environment for compliance. </p>
			<h2 id="_idParaDest-457"><a id="_idTextAnchor469"/>Concepts to understand about AWS Config</h2>
			<p>Before we dive into the AWS Config service, let's look at some of the key terms and concepts <a id="_idIndexMarker1664"/>that <a id="_idIndexMarker1665"/>will be discussed.</p>
			<h3>AWS Resources </h3>
			<p>The entities that you <a id="_idIndexMarker1666"/>create and manage either from the AWS Management Console, the CLI, or any of the SDKs available, are <strong class="bold">AWS Resources</strong>. These can include EC2 instances, EBS volumes, DynamoDB tables, RDS instances and security groups, S3 buckets, SNS topics, and much more. AWS Config uses the <strong class="bold">Amazon Resource Name</strong> (<strong class="bold">ARN</strong>) to identify<a id="_idIndexMarker1667"/> each of the <a id="_idIndexMarker1668"/>unique resources. For a complete list of supported resources, visit <a href="https://docs.aws.amazon.com/config/latest/developerguide/resource-config-reference.html">https://docs.aws.amazon.com/config/latest/developerguide/resource-config-reference.html</a>.</p>
			<h3>Configuration Recorder </h3>
			<p>As you run <a id="_idIndexMarker1669"/>the AWS Config service, the <strong class="bold">Configuration Recorder</strong> is what saves and stores the values and changes of the various supported AWS Resources as configuration items. Before it can start recording, however, the Configuration Recorder must be created and then started. </p>
			<h3>Configuration History</h3>
			<p>When<a id="_idIndexMarker1670"/> you want to understand what changes have been made to a particular supported AWS Resource and when they occurred, then you can use the <strong class="bold">Configuration History</strong>. The Configuration History is a cumulation of data (configuration items) for a specific resource over any period in which the configuration recorder has been running. </p>
			<h3>Configuration Snapshot</h3>
			<p>Unlike <a id="_idIndexMarker1671"/>the name somewhat implies, a <strong class="bold">Configuration Snapshot</strong> is not a graphical picture in time of configuration items. Instead, it is a code-based recording of how your supported resources and their different settings are used at a particular point in time. These snapshots can be saved in a designated S3 bucket so that they can be retrieved or compared with future or past configuration snapshots. </p>
			<h3>Configuration Items </h3>
			<p>Point-in-time <a id="_idIndexMarker1672"/>views for supported AWS resources are captured as <strong class="bold">configuration items</strong>. The information that's captured includes attributes, metadata, current configuration, relationships, and related events. </p>
			<p>Now that we have an understanding of the concepts and pieces that AWS Config uses, let's take a deeper look at how AWS Config works. </p>
			<h2 id="_idParaDest-458"><a id="_idTextAnchor470"/>Understanding how Config works </h2>
			<p>After starting<a id="_idIndexMarker1673"/> the service, AWS Config starts to scan for supported resources within the account. As it finds these resources, it produces a configuration item for each one. </p>
			<p>As those resources change, a new configuration item is then generated and recorded by the config recorder.</p>
			<div>
				<div id="_idContainer291" class="IMG---Figure">
					<img src="Images/Figure_20.19_B17405.jpg" alt="Figure 20.19 – Understanding the workflow of AWS Config&#13;&#10;" width="747" height="337"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.19 – Understanding the workflow of AWS Config</p>
			<p>If you have <a id="_idIndexMarker1674"/>enabled rules for the Config service to evaluate, then the Config service will continuously check the configuration items against the rules. If an item does not meet the criteria of a rule, then the lambda that is associated with that rule will be triggered, and the associated action will be taken. </p>
			<p>For example, if a company has enabled a mandate that all EBS data volumes must be encrypted, regardless of whether they are deployed from CloudFormation, the CLI, an SDK, or created by hand, then a simple rule in AWS could be created to send a notification to an SNS topic that contains an email group list once an offending volume has been found. </p>
			<p>A more complex rule could be created that not only pushes out the notification to the SNS topic but also uses one of the AWS SDKs programmed in the corresponding lambda function for the rule, which would terminate any created EBS volume that was encrypted upon creation. </p>
			<p>As your Config item history is compiled, you can view both the inventory of the resources that AWS has discovered, as well as view the compliance history for any particular AWS resource.  </p>
			<p>If you are using Config rules, then resources can be constantly checked whenever changes happen. They can also be set to be checked on timed intervals, such as every 12 or 24 hours. </p>
			<p>Now that we have a good understanding of how AWS Config works, let's try it out for ourselves with the next exercise so that we can get some hands-on experience. </p>
			<h2 id="_idParaDest-459"><a id="_idTextAnchor471"/>Standing up AWS Config – a practical example</h2>
			<p>To see <a id="_idIndexMarker1675"/>how the AWS Config service works, we will stand up a configuration recorder along with two rules that will check our account. Once the recorder has been stood up and then turned on, we can go back after a while to see its findings. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Since we are using a CloudFormation template to stand up our Config recorder, we can easily take it down once we are done with it. If you were to stand up the Config recorder from the AWS Management console, it would be challenging to take down the default Config recorder and reset everything back to zero if needed. </p>
			<p>Before we begin, make sure that you have downloaded the CloudFormation template named <strong class="source-inline">configTemplate.yml</strong> from this book's GitHub repository, under the <strong class="source-inline">Chapter-20</strong> folder:</p>
			<ol>
				<li value="1">Open your browser and log in to your AWS account using the Administrator user. After logging in, navigate to the CloudFormation service. </li>
				<li>In the top right-hand corner, click on the <strong class="bold">Create Stack</strong> button. Once pressed, choose the <strong class="bold">With new resources</strong> option. </li>
				<li>Choose the following options on the <strong class="bold">Create stack</strong> page:<ul><li><strong class="bold">Prerequisite</strong> – <strong class="bold">Prepare Template</strong>: The template is ready. </li><li><strong class="bold">Specify template</strong>: Upload a template file. </li><li><strong class="bold">Choose file</strong>: <strong class="source-inline">configTemplate.yml</strong>.</li></ul></li>
				<li>After using these options, click on the orange <strong class="bold">Next</strong> button.</li>
				<li>You will be presented with all the parameters on the <strong class="bold">Specify stack details</strong> page. There will be several values that need to be filled in. You can use all of the default values that were filled in when you were spinning up the template. However, some values will need to be filled in manually, as follows: <ul><li><strong class="bold">Stack name</strong>: <em class="italic">Chapter20-config</em></li><li><strong class="source-inline">MaximumExecutionFrequency</strong>: <strong class="source-inline">One_Hour</strong></li></ul><p>Once you have filled in these parameters, click the orange <strong class="bold">Next</strong> button. </p></li>
				<li>After <a id="_idIndexMarker1676"/>clicking the initial <strong class="bold">Next</strong> button when creating the stack, you will be taken to the <strong class="bold">Configure stack options</strong> page. Just click the orange <strong class="bold">Next</strong> button at the bottom right of the page to continue. </li>
				<li>Once you're on the <strong class="bold">Review</strong> page, at the bottom of the page, you will need to check the box in the <strong class="bold">Capabilities</strong> section, acknowledging that the stack may create IAM resources. Once you have done this, click the orange <strong class="bold">Create Stack</strong> button to start the creation of the Config recorder and rules via CloudFormation.  </li>
				<li>In less than 5 minutes, the resources should have been created, including the Configuration Recorder, a new S3 bucket to capture the configuration snapshots, and an SNS topic especially for notifications from the AWS Config service. </li>
				<li>Now, use the search bar in the middle of the AWS Management Console to search for the Config service. Once the icon appears, click on it to be taken to that service:<div id="_idContainer292" class="IMG---Figure"><img src="Images/Figure_20.20_B17405.jpg" alt="Figure 20.20 – The AWS Config service icon from the search results &#13;&#10;" width="675" height="247"/></div><p class="figure-caption">Figure 20.20 – The AWS Config service icon from the search results </p></li>
				<li>From the <strong class="bold">AWS Config</strong> dashboard, which should be the first screen you see as you are taken to the service, we will see our compliance status right away. From our CloudFormation template, we enabled two rules automatically. These rules on my demo account are already showing to be in compliance. However, if you did not put an MFA on your root account, then it may show that you are out of compliance with one or more of the Config rules.<div id="_idContainer293" class="IMG---Figure"><img src="Images/Figure_20.21_B17405.jpg" alt="Figure 20.21 – The compliance status on the AWS Config dashboard&#13;&#10;" width="575" height="215"/></div><p class="figure-caption">Figure 20.21 – The compliance status on the AWS Config dashboard</p></li>
				<li>To <a id="_idIndexMarker1677"/>view the rules that we currently have in AWS Config, simply go to the <strong class="bold">Rules</strong> item via the left menu. Once we click on this item, we should see the names of the two rules that were loaded with the template.</li>
				<li>If we want to look at the resources in our account that AWS Config can check, we can go to the <strong class="bold">Resources</strong> menu item. Once <strong class="bold">Resource Inventory</strong> has loaded on the main screen, under the <strong class="bold">Resource</strong> category dropdown, change the selection to <strong class="bold">AWS resources</strong>. This will allow you to see the AWS items in your account that Config can keep track of. </li>
				<li>On any of these resources, click on the blue <strong class="bold">Resource Identifier</strong> button to be taken to the <strong class="bold">Resource details</strong> page. If you would like to see the timeline of how the resource has changed over time, go to the top-right corner of the <strong class="bold">Resource details</strong> pages. Here, you will see a button labeled <strong class="bold">Resource Timeline</strong>. Clicking on this button will bring up the timeline interface, showing how the resource has changed over time.  </li>
			</ol>
			<p>I would suggest that you leave the Config recorder up for a day or so while you make a few changes to different resources in your account. Remember to take down the Config recorder via the CloudFormation template; otherwise, you will incur the charges of the AWS Config service.    </p>
			<p>Now that we have learned how to stand up a Config recorder and enable some rules in our AWS account, let's <a id="_idIndexMarker1678"/>take a deeper look at what different types of rules are available from AWS Config. </p>
			<h2 id="_idParaDest-460"><a id="_idTextAnchor472"/>The Config rule structure </h2>
			<p>AWS Config can constantly check the compliance of your AWS resources by using <strong class="bold">Config rules</strong>. These <a id="_idIndexMarker1679"/>rules portray the ideal state of how your resources should be constructed.</p>
			<p>You can use Config rules to help determine how your environment and resources conform to industry guidelines, internal best practices, and specified policies you need to enforce. </p>
			<p>Rules can be run on a few different types of triggers:</p>
			<ul>
				<li><strong class="bold">Configuration changes</strong>: When <a id="_idIndexMarker1680"/>the config service detects that a change has been made to the resource.</li>
				<li><strong class="bold">Periodic checks</strong>: The Config service <a id="_idIndexMarker1681"/>runs on a regular schedule such as every 3 hours or every 24 hours, looking for changes to the resources. </li>
			</ul>
			<h3>Managed rules versus custom rules </h3>
			<p>There<a id="_idIndexMarker1682"/> are lots of predefined rules that have already been designed by Amazon to use on many of the most common use cases. These rules can be checking resources, such as whether EBS volumes are encrypted or whether certain ports have been opened to allow traffic to flow. </p>
			<p>These managed rules can be customized with extra items for remediation. </p>
			<p>Custom rules can be created for any resource or policy that your organization needs checking and or enforcement on.</p>
			<p>Using both managed and custom rules, you can automatically keep your organization in the state of compliance that it desires. </p>
			<p>Now that we have learned how to use both Config and SSM to help keep our AWS account in compliance, let's review what we have learned in this chapter. </p>
			<h1 id="_idParaDest-461"><a id="_idTextAnchor473"/>Summary</h1>
			<p>In this chapter, we looked at some of the tools that can help make the operations part of our DevOps role easier. This included AWS Systems Manager, which, in and of itself, provides a variety of services to help you accomplish tasks. These range from being able to quickly create a session on a remote instance to creating repeatable processes and installing software or gathering files from an instance. We also learned that Systems Manager works with both compute instances in the cloud as well as servers on-premises. </p>
			<p>We also examined the AWS Config service. We saw how it can keep a timeline of the state of supported AWS resources. We also looked at how Config rules work and how they can be used to flag resources that don't meet the standards we have set for our organization. </p>
			<p>In the next chapter, we will look at using Amazon Inspector. This is a service that helps you proactively find security vulnerabilities in your account. </p>
			<h1 id="_idParaDest-462"><a id="_idTextAnchor474"/>Questions </h1>
			<ol>
				<li value="1">You have been asked by a company to configure EC2 instances so that they can be managed by AWS Systems Manager. The company is using a distinct version of Linux for their base Amazon Machine Image. What actions will ensure that once the instance is launched from this AMI, it will be able to be found in the Session Manager console? (Choose two answers)<ol><li>Install the Systems Manager Agent as part of the base AMI.</li><li>Create a key pair named <strong class="source-inline">ssm-user</strong> and use this key pair when launching the instance.</li><li>Make sure that any Security Group that the instances are associated with allow traffic from port <strong class="source-inline">22</strong>. </li><li>Add an instance role to any launched instance that allows Systems Manager permissions.</li></ol></li>
				<li>The company you have been working with is asking for a weekly report of the top five operating systems that are being used across the EC2 instances in the two regions where they are currently operating their production systems. What is the quickest and most cost-effective way to get them this information?<ol><li>Use Amazon Athena to gather the CloudTrail data about all running instances. Create a report in QuickSight that will display a graph and detailed data of the top five operating systems per region. Share this report with the stakeholders who have requested it. </li><li>Make sure all the instances have instance profiles that allow access by the Systems Manager service. Use Systems Manager Inventory to create a report that shows the top five operating systems for each region. </li><li>Use the EC2 instances console to group all instances by operating systems. Create a report from the sorted data. </li><li>Create a lambda function that uses the CLI to call the operating system type of all EC2 instances. Have this output sent to an S3 bucket to be downloaded by the stakeholders. </li></ol></li>
				<li>The security department of an e-commerce company has put in force a new company policy that no web traffic may travel over non-secure HTTP, or port <strong class="source-inline">80</strong>. Any traffic that was previously allowed on port <strong class="source-inline">80</strong> must now be redirected to port <strong class="source-inline">443</strong> using a secure certificate. Any security groups found open to port <strong class="source-inline">80</strong> will be in violation of this new policy and suspended immediately. What is the best way to regularly monitor whether any security group is allowing traffic to enter port <strong class="source-inline">80</strong>?<ol><li>Use Trusted Advisor to scan for insecure security groups that have been created. Set up an SNS topic where Trusted Advisor can send the notifications.</li><li>Add a network ACL rule to all VPCs that blocks traffic from entering port <strong class="source-inline">80</strong>. </li><li>Use CloudTrail logs to determine whether any security group has opened port <strong class="source-inline">80</strong>. </li><li>Set up a rule in AWS Config that checks for traffic being allowed on port <strong class="source-inline">80</strong> on any security group. If a security group is found in violation, send a notification to the security department's SNS topic.</li></ol></li>
			</ol>
			<h1 id="_idParaDest-463"><a id="_idTextAnchor475"/>Review answers</h1>
			<ol>
				<li value="1">a and d</li>
				<li>b</li>
				<li>d</li>
			</ol>
		</div>
	</div></body></html>