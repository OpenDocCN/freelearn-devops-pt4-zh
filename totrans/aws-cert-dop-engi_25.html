<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer301">
			<h1 id="_idParaDest-464"><a id="_idTextAnchor476"/>Chapter 21: Using Amazon Inspector to Check your Environment</h1>
			<p>Amazon Inspector allows you to make security testing a regular part of development and <strong class="bold">Information Technology</strong> (<strong class="bold">IT</strong>) operations. As <strong class="bold">Development Operations</strong> (<strong class="bold">DevOps</strong>) makes the shift left to <strong class="bold">Development Security Operations</strong> (<strong class="bold">DevSecOps</strong>) and security responsibilities fall more to developers, using tools such as Amazon Inspector can help to form a more proactive approach to your and your organization's security posture. </p>
			<p>In this chapter, we're going to cover the following main topics:  </p>
			<ul>
				<li>Understanding Amazon Inspector</li>
				<li>Configuring the Inspector agent both manually and automatically </li>
			</ul>
			<h1 id="_idParaDest-465"><a id="_idTextAnchor477"/>Understanding Amazon Inspector </h1>
			<p><strong class="bold">Amazon Inspector</strong> enables you to analyze the behavior of your <strong class="bold">Amazon Web Services</strong> (<strong class="bold">AWS</strong>) resources and helps you identify potential security issues. With Amazon Inspector, you can <a id="_idIndexMarker1683"/>run automated assessments over any or all applications you are hosting in the AWS cloud, based on hundreds of rules created by AWS security experts. These rules look for vulnerabilities as well as deviations from <a id="_idIndexMarker1684"/>the best practices. After performing an assessment, Amazon Inspector delivers a detailed list of findings, which are categorized by their level of severity. The process is illustrated in the following diagram:</p>
			<div>
				<div id="_idContainer295" class="IMG---Figure">
					<img src="Images/Figure_21.1_B17405.jpg" alt="Figure 21.1 – The Amazon Inspector process &#13;&#10;" width="468" height="189"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.1 – The Amazon Inspector process </p>
			<p>At the time of writing <a id="_idIndexMarker1685"/>this, the assessments that Amazon Inspector <a id="_idIndexMarker1686"/>can perform are contained to only those on Amazon <strong class="bold">Elastic Compute Cloud</strong> (<strong class="bold">EC2</strong>) instances. </p>
			<p>Since we have just had an overview of Amazon Inspector, let's look at how we can get started with the Amazon Inspector service. </p>
			<h2 id="_idParaDest-466"><a id="_idTextAnchor478"/>Getting started with Amazon Inspector </h2>
			<p>To get started <a id="_idIndexMarker1687"/>with Amazon Inspector, there are three initial steps to take, outlined as follows:</p>
			<ol>
				<li>Install the <strong class="bold">AWS Inspector agent</strong> on the <strong class="bold">Amazon EC2</strong> instances that you wish for <a id="_idIndexMarker1688"/>Inspector to scan.<p class="callout-heading">Note</p><p class="callout">It's both a good idea and a good practice to tag the instance(s) with a unique tag so that you can add these instances to a specific assessment target for an assessment run.</p></li>
				<li>Create an <a id="_idIndexMarker1689"/>assessment target, which is a collection of the AWS resources that you want Inspector to examine.</li>
				<li>Create an assessment template that serves as a blueprint for your assessment. </li>
				<li>Run an assessment on your target.</li>
				<li>Review your findings and remediate any security issues. </li>
			</ol>
			<p>There are ways to incorporate other AWS services into the mix as well. You can configure a <strong class="bold">Simple Notification Service</strong> (<strong class="bold">SNS</strong>) topic to send out notifications to a particular email <a id="_idIndexMarker1690"/>address or distribution group once a finding report has been published. There are also ways to have <strong class="bold">Lambda</strong> functions automatically kick <a id="_idIndexMarker1691"/>off Inspector scans either periodically, using <strong class="bold">CloudWatch</strong> <a id="_idIndexMarker1692"/>events, or whenever a particular event happens, such as the creation of a new <strong class="bold">Amazon Machine Image</strong> (<strong class="bold">AMI</strong>). </p>
			<p>We just looked at how to get started with Amazon Inspector and even took a high overview of how some of the other AWS services could be brought in to be incorporated with Inspector assessments. Let's now look at some real-world use cases with Amazon Inspector. </p>
			<h2 id="_idParaDest-467"><a id="_idTextAnchor479"/>Use cases for Amazon Inspector </h2>
			<p>Companies are using Amazon Inspector both as a standalone service and by integrating Amazon Inspector into <a id="_idIndexMarker1693"/>their DevOps pipelines to ensure that instances are free from vulnerabilities, especially in their production environments. </p>
			<p>In the case of <a id="_idIndexMarker1694"/>companies working in regulated industries, such as those that need to comply with <strong class="bold">Health Information Portability and Accountability Act</strong> (<strong class="bold">HIPAA</strong>) guidelines or <strong class="bold">Payment Card Industry Data Security Standard</strong> (<strong class="bold">PCI DSS</strong>) scanning for vulnerabilities. Amazon Inspector's assessment reports provide not only a trail of which vulnerabilities <a id="_idIndexMarker1695"/>have been found, but <a id="_idIndexMarker1696"/>they can also show a timeline of what has been fixed by comparing past reports. The following diagram shows Inspector being used in a <strong class="bold">Continuous Integration/Continuous Deployment</strong> (<strong class="bold">CI/CD</strong>) pipeline:</p>
			<div>
				<div id="_idContainer296" class="IMG---Figure">
					<img src="Images/Figure_21.2_B17405.jpg" alt="Figure 21.2 – Inspector in a CI/CD pipeline &#13;&#10;" width="652" height="307"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.2 – Inspector in a CI/CD pipeline </p>
			<p>As the preceding diagram shows, Amazon Inspector can also be added as a vulnerability assessment to a CI/CD pipeline as one of the final checks before creating a final AMI. This final AMI can either <a id="_idIndexMarker1697"/>be used as a golden image or just a versioned image for an application. If Inspector has findings in this pipeline setup, the build is failed, and any issues need to be remediated before being passed on to the final stage where an image is created. </p>
			<p>Now that we see how Amazon Inspector is being used in the real world, let's see how we can install the Amazon Inspector agent so that we can perform our own assessments. </p>
			<h1 id="_idParaDest-468"><a id="_idTextAnchor480"/>Configuring the Inspector agent both manually and automatically </h1>
			<p>The <strong class="bold">Amazon Inspector agent</strong> can be installed on your target in one of three ways. The first way is to install the agent manually, which includes logging on to the target instance. The second <a id="_idIndexMarker1698"/>way is to use <strong class="bold">SSM</strong> and take advantage of the <strong class="source-inline">run</strong> command feature to automatically install the Inspector agent on the instances in which we want the Inspector service to look for vulnerabilities. The <a id="_idIndexMarker1699"/>third way is to incorporate a simple script into the user data so that the agent will be installed during the launch of the instance. These three methods are depicted in the following diagram:</p>
			<div>
				<div id="_idContainer297" class="IMG---Figure">
					<img src="Images/Figure_21.3_B17405.jpg" alt="Figure 21.3 – Three ways to install the Inspector agent&#13;&#10;" width="351" height="199"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.3 – Three ways to install the Inspector agent</p>
			<p>Now that we have <a id="_idIndexMarker1700"/>seen how to install the agent, let's go <a id="_idIndexMarker1701"/>through the exercise of spinning up some instances and using Systems Manager to install the agent.</p>
			<h2 id="_idParaDest-469"><a id="_idTextAnchor481"/>Using Amazon Inspector hands-on</h2>
			<p>In the following hands-on exercise, we are going to launch two instances at the same time and provide them <a id="_idIndexMarker1702"/>with a tag of <strong class="source-inline">Inspector</strong> and a value of <strong class="source-inline">TRUE</strong>. Since we are going to be using the <strong class="source-inline">run</strong> command option from Systems Manager, we are going to need to have an <strong class="bold">Identity and Access Management</strong> (<strong class="bold">IAM</strong>) role that allows access to our instances. The good news <a id="_idIndexMarker1703"/>is that we have previously created this role in our exercise for <a href="B17405_14_Final_JM_ePub.xhtml#_idTextAnchor366"><em class="italic">Chapter 14</em></a>, <em class="italic">CloudWatch and X-Ray's Role in DevOps</em>. If you never completed this exercise and you would like to perform it, then you will need to go back and create this role before starting this exercise. </p>
			<p>We will start off by creating <a id="_idIndexMarker1704"/>two instances in our group, one of which will be of the Ubuntu 16.04 <strong class="bold">Operating System</strong> (<strong class="bold">OS</strong>) and one that will be running the Amazon Linux OS. For the Ubuntu OS instance, we will need to install the AWS <strong class="bold">Systems Manager</strong> (<strong class="bold">SSM</strong>) Agent using a user-data script. Fortunately, we already have this script as we used it in <a href="B17405_14_Final_JM_ePub.xhtml#_idTextAnchor366"><em class="italic">Chapter 14</em></a>, <em class="italic">CloudWatch and X-Ray's Role in DevOps</em>. This same <a id="_idIndexMarker1705"/>script will be included in the <strong class="source-inline">chapter 21</strong> GitHub repository resources. The script to install the SSM agent once again is called <strong class="source-inline">agents.sh</strong>.</p>
			<p>We just went through how to set up the Amazon Inspector agent using a Systems Manager <strong class="source-inline">run</strong> command. We also conducted an Inspector assessment. Next, we will see how to ingest the findings contained in the assessment report, as follows:</p>
			<ol>
				<li value="1">Open up your terminal so that we can start our commands. Make sure that in the directory you <a id="_idIndexMarker1706"/>are working in, you have either made a copy of the <strong class="source-inline">agents.sh</strong> script from where you originally created it when you did the exercises in <a href="B17405_14_Final_JM_ePub.xhtml#_idTextAnchor366"><em class="italic">Chapter 14</em></a>, <em class="italic">CloudWatch and X-Ray's Role in DevOps</em> or that you have <a id="_idIndexMarker1707"/>downloaded a fresh copy from the <strong class="source-inline">Chapter 21</strong> GitHub folder. We will start off by obtaining the AMI <strong class="bold">identifier</strong> (<strong class="bold">ID</strong>) for the Amazon Linux AMI. Use the command shown next to store the value of the AMI in the <strong class="source-inline">IMAGE</strong> parameter:<p class="source-code"><strong class="bold">IMAGE='aws ssm get-parameters --names \</strong></p><p class="source-code"><strong class="bold">        /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2 \</strong></p><p class="source-code"><strong class="bold">    --query 'Parameters[0].[Value]' --output text --region us-east-2'</strong></p><p>If you would like to see the actual value of the AMI ID, then you can run the <strong class="source-inline">$IMAGE</strong> command <strong class="source-inline">echo</strong>.</p></li>
				<li>With the current AMI stored in the <strong class="source-inline">IMAGE</strong> parameter, we can now start to create our first instance. Use the following command to create an instance:<p class="source-code"><strong class="bold">aws ec2 run-instances \</strong></p><p class="source-code"><strong class="bold">--image-id $IMAGE \</strong></p><p class="source-code"><strong class="bold">--instance-type t2.micro \</strong></p><p class="source-code"><strong class="bold">--iam-instance-profile 'Name=CW_SSM' \</strong></p><p class="source-code"><strong class="bold">--tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=AmazonLinux},{Key=Inspector,Value=TRUE}]' \</strong></p><p class="source-code"><strong class="bold">--region us-east-2</strong></p></li>
				<li>Now, we will get the AMI ID for the Ubuntu instance. The command will look a lot like the command <a id="_idIndexMarker1708"/>to store the variable for the Amazon Linux AMI, but the <strong class="source-inline">names</strong> value is different. Run the following command so that we can store the Ubuntu AMI ID in a value named <strong class="source-inline">AMI</strong> and then create our second instance:<p class="source-code"><strong class="bold">AMI='aws SSM get-parameters --names \</strong></p><p class="source-code"><strong class="bold">        /aws/service/canonical/ubuntu/server/16.04/stable /current/amd64/hvm/ebs-gp2/ami-id \</strong></p><p class="source-code"><strong class="bold">    --query 'Parameters[0].[Value]' --output text --region us-east-2'</strong></p></li>
				<li>Now, just as we created our first instance, we will create our second instance. Two values will change in this command—the first value will be the <strong class="source-inline">image-id</strong> value, and the second will be the <strong class="source-inline">name tag</strong> value. You should also notice that we have added a second tag of <strong class="source-inline">Inspector</strong> with a value of <strong class="source-inline">TRUE</strong> to each of these instances. Use the command shown next to create a second Ubuntu instance:<p class="source-code"><strong class="bold">  aws ec2 run-instances \</strong></p><p class="source-code"><strong class="bold">--image-id $AMI \</strong></p><p class="source-code"><strong class="bold">--instance-type t2.micro \</strong></p><p class="source-code"><strong class="bold">--user-data file://agents.sh \</strong></p><p class="source-code"><strong class="bold">--iam-instance-profile 'Name=CW_SSM' \</strong></p><p class="source-code"><strong class="bold">--tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Ubuntu},{Key=Inspector,Value=TRUE}]' \</strong></p><p class="source-code"><strong class="bold">--region us-east-2</strong></p></li>
				<li>Both instances should be up and running at this point in time. We can now switch over to our browser. Log in to the <strong class="bold">Amazon Management Console</strong> and navigate to the <strong class="bold">Systems Manager</strong> service. Make sure that you are in the correct region (<strong class="source-inline">Ohio</strong>) in which you spun up the instances. Once at the <strong class="bold">Systems Manager</strong> service, under <strong class="bold">Node Management</strong> on the left-hand menu, find the sub-menu option named <strong class="bold">Run Command</strong> and click on it. </li>
				<li>With the AWS Systems <a id="_idIndexMarker1709"/>Manager <strong class="source-inline">run</strong> command now in the main window, click on the orange <strong class="bold">Run a command</strong> button so that we can use the <strong class="source-inline">run</strong> command to install the Inspector Agent. </li>
				<li>We should now be on the <strong class="bold">Command Document</strong> screen. In the search box, type <strong class="source-inline">Inspector</strong> and hit <em class="italic">Enter</em>. This will bring up the <strong class="source-inline">run</strong> command document named <strong class="source-inline">AmazonInspector-ManageAWSAgent</strong>. Click on the <strong class="bold">Radio</strong> button next to the document name, as illustrated in the following screenshot:<div id="_idContainer298" class="IMG---Figure"><img src="Images/Figure_21.4_B17405.jpg" alt="Figure 21.4 – The Systems Manager run document to install the Inspector Agent&#13;&#10;" width="953" height="327"/></div><p class="figure-caption">Figure 21.4 – The Systems Manager run document to install the Inspector Agent</p></li>
				<li>Once we have the document selected, scroll down on the page until we come to a heading of <strong class="bold">Targets</strong>. Here, we can specify the instance tags that we want to target. We will use a <strong class="bold">Tag key</strong> value of <strong class="source-inline">Inspector</strong> and a <strong class="bold">Tag value</strong> value of <strong class="source-inline">TRUE</strong>, then click the <strong class="bold">Add</strong> button to specify the tag in our search, as illustrated in the following screenshot: <div id="_idContainer299" class="IMG---Figure"><img src="Images/Figure_21.5_B17405.jpg" alt="Figure 21.5 – Specifying the instance tags to target with our run command" width="928" height="450"/></div><p class="figure-caption">Figure 21.5 – Specifying the instance tags to target with our run command</p></li>
				<li>Next, scroll down to <strong class="bold">Output options</strong>. If you still have your S3 bucket that you made in <a href="B17405_04_Final_JM_ePub.xhtml#_idTextAnchor110"><em class="italic">Chapter 4</em></a>, <em class="italic">Amazon S3 Blob Storage</em>, use this bucket for the output from the <strong class="source-inline">Systems Manager</strong> command. If you do not have an S3 bucket readily available, then simply uncheck the <strong class="bold">Enable an S3 bucket</strong> box, as this step is optional.</li>
				<li>Scroll down to the <a id="_idIndexMarker1710"/>bottom of the page and click on the orange <strong class="bold">Run</strong> button. You will be taken to the <strong class="bold">Command Status</strong> page, where you should see <strong class="bold">In Progress</strong> in the <strong class="bold">Status</strong> section of the targets and outputs. After about a minute, you can refresh the <strong class="bold">Command Status</strong> page, and you should see <strong class="bold">Success</strong> for both instances, as illustrated in the following screenshot:<div id="_idContainer300" class="IMG---Figure"><img src="Images/Figure_21.6_B17405.jpg" alt="Figure 21.6 – The Inspector agent successfully installed on our instances&#13;&#10;" width="1027" height="332"/></div><p class="figure-caption">Figure 21.6 – The Inspector agent successfully installed on our instances</p></li>
				<li>With our agent installed, we can now go to the <strong class="bold">Amazon Inspector</strong> service. In the top search box from the <strong class="bold">Amazon Management Console</strong>, type in <strong class="bold">Inspector</strong> and then <a id="_idIndexMarker1711"/>click on the service once it appears. When the main <strong class="bold">Inspector</strong> page appears, click on the blue <strong class="bold">Get started</strong> button. </li>
				<li>You should now be brought to a page with a heading on the top titled <strong class="bold">Welcome to Amazon Inspector</strong>. Under <strong class="bold">Assessment Setup</strong>, uncheck the box next to <strong class="bold">Network Assessments</strong>, as we are only trying to run assessments on our EC2 instances. This will leave the box next to <strong class="bold">Host Assessments</strong> checked. At the bottom of the page, click on the gray button labeled <strong class="bold">Run once</strong> and <em class="italic">NOT</em> the blue button. </li>
				<li>When the dialog box pops up, click the blue <strong class="bold">OK</strong> button.</li>
				<li>It can take around an hour for the assessment report to become ready. </li>
			</ol>
			<p>We have now seen how to set up the Amazon Inspector agent on different OSes. Next, after our assessment is run, we will look at the report and see how to digest the findings of the report. </p>
			<h2 id="_idParaDest-470"><a id="_idTextAnchor482"/>Comprehending the findings of Inspector assessment reports</h2>
			<p>Once Amazon Inspector has completed its assessment, it will then return an assessment report. Any findings <a id="_idIndexMarker1712"/>that the report returns will contain both a detailed description of the security issue along with a recommendation of how to fix the problem. </p>
			<p>You have the ability to store the reports as well as share these reports with your team members so that they can perform remediation actions on the findings contained in the report. </p>
			<h1 id="_idParaDest-471"><a id="_idTextAnchor483"/>Summary</h1>
			<p>In this chapter, we learned about Amazon Inspector and how it can scan instances running applications for vulnerabilities. We learned about the three ways in which we could install the Inspector agent and even performed a hands-on exercise, installing the Inspector agent using the Systems Manager <strong class="source-inline">run</strong> command. Finally, we discussed the findings that Amazon Inspector returns. </p>
			<p>In the next chapter, we will look at a number of other policies and standard services to know for the certification exam as well as for use in the real world. These include services such as <strong class="bold">AWS GuardDuty</strong> and <strong class="bold">Macie</strong>, as well as others that can be present in exam questions. Understanding these services will also help you in your current and future positions. </p>
			<h1 id="_idParaDest-472"><a id="_idTextAnchor484"/>Review questions</h1>
			<ol>
				<li value="1">You have been brought into a company where they are trying to rectify their security and compliance posture. The security and compliance teams are now requiring that all EC2 instances use approved AMIs. As a DevOps engineer, you must find a way to implement a process to find any EC2 instances that have been launched from unapproved AMIs. Which solution will satisfy the requirements?<p>a. Use Trusted Advisor checks to identify EC2 instances that have been launched from unapproved AMIs.</p><p>b. Create an AWS Config rule that identifies any non-approved AMIs and then sends a notification to the security and compliance distribution lists.</p><p>c. Have Systems Manager Inventory create a custom report of all the EC2 instances using unapproved AMIs. </p><p>d. Have Amazon Inspector run across all the instances in the account. Share the findings of unapproved AMIs with the security and compliance team members. </p></li>
				<li>You and your team are running an application in a production environment. The application is built and deployed using Elastic Beanstalk but runs on EC2 instances. You want to make sure that the application is free of any vulnerabilities; which AWS service should you implement to help with this?<p>a. AWS Trusted Advisor</p><p>b. AWS <strong class="bold">Web Application Firewall</strong> (<strong class="bold">WAF</strong>) </p><p>c. AWS Shield </p><p>d. AWS Inspector </p></li>
				<li>There has been a recent investigation at the company you are working for. During this investigation, it was discovered that all application programming interface (API) calls were turned off for the production AWS account. It was also discovered that a new administrative user account was created, along with an access key and a secret access key. This key pair was used several times to create extra-large EC2 instances. How could you have used automation to detect and prevent this incident?<p>a. Use Amazon CloudTrail to create a new CloudTrail that looks for the events of disabling any CloudTrails as well as the creation of any API keys with the Amazon administrator managed policy.</p><p>b. Use Amazon Inspector to review all API calls leveraged. Configure the Inspector agent to use an SNS topic if any changes are detected to the CloudTrail. Use an IAM permissions boundary to prevent the spin-up of any extra-large EC2 instances. </p><p>c. Use AWS Config to create a config rule that detects when CloudTrail is disabled. Create a Lambda function to re-enable CloudTrail if the rule is triggered. Use an IAM permissions boundary to prevent the spin-up of any extra-large EC2 instances.</p><p>d. Use the Trusted Advisor API to periodically check if CloudTrail has been disabled. Create a Lambda function to re-enable CloudTrail if the rule is triggered. Use an IAM permissions boundary to prevent the spin-up of any extra-large EC2 instances.</p></li>
			</ol>
			<h1 id="_idParaDest-473"><a id="_idTextAnchor485"/>Review answers </h1>
			<ol>
				<li value="1">b</li>
				<li>d</li>
				<li>c</li>
			</ol>
		</div>
	</div></body></html>