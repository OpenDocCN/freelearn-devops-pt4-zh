- en: 5\. Designing policies, locks, and tags for Azure deployments
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5\. 设计 Azure 部署的策略、锁定和标签
- en: Azure is a versatile cloud platform. Customers can not only create and deploy
    their applications; they can also actively manage and govern their environments.
    Clouds generally follow a pay-as-you-go paradigm, where a customer subscribes
    and can then deploy virtually anything to the cloud. It could be as small as a
    basic virtual machine, or it could be thousands of virtual machines with higher
    **stock-keeping units** (**SKUs**). Azure will not stop any customer from provisioning
    the resources they want to provision. Within an organization, there could be a
    large number of people with access to the organization's Azure subscription. There
    needs to be a governance model in place so that only necessary resources are provisioned
    by people who have the right to create them. Azure provides resource management
    features, such as **Azure Role-Based Access Control** (**RBAC**), Azure Policy,
    management groups, blueprints, and resource locks, for managing and providing
    governance for resources.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 是一个多功能的云平台。客户不仅可以创建和部署他们的应用程序，还可以积极管理和治理他们的环境。云计算通常遵循按需付费的模式，客户可以订阅并将几乎任何东西部署到云端。它可以是一个简单的虚拟机，也可以是数千个具有更高**库存单位**（**SKU**）的虚拟机。Azure
    不会阻止任何客户配置他们希望配置的资源。在一个组织内，可能有很多人可以访问该组织的 Azure 订阅。需要建立一个治理模型，以确保只有具有创建权限的人才能配置必要的资源。Azure
    提供了资源管理功能，如**Azure 基于角色的访问控制**（**RBAC**）、Azure 策略、管理组、蓝图和资源锁定，用于管理和提供资源治理。
- en: Other major aspects of governance include cost, usage, and information management.
    An organization's management team always wants to be kept up to date about cloud
    consumption and costs. They would like to identify what team, department, or unit
    is using what percentage of their total cost. In short, they want to have reports
    based on various dimensions of consumption and cost. Azure provides a tagging
    feature that can help provide this kind of information on the fly.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 治理的其他主要方面包括成本、使用情况和信息管理。组织的管理团队总是希望实时了解云计算消耗和成本情况。他们希望能够识别出哪些团队、部门或单位使用了多少比例的总成本。简而言之，他们希望能够基于不同的消费和成本维度生成报告。Azure
    提供了一种标签功能，可以帮助实时提供这类信息。
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: Azure management groups
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 管理组
- en: Azure tags
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 标签
- en: Azure Policy
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 策略
- en: Azure locks
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 锁定
- en: Azure RBAC
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure RBAC
- en: Azure Blueprints
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 蓝图
- en: Implementing Azure governance features
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施 Azure 治理功能
- en: Azure management groups
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure 管理组
- en: We are starting with Azure management groups because, in most of the upcoming
    sections, we will be referencing or mentioning management groups. Management groups
    act as a level of scope for you to effectively assign or manage roles and policies.
    Management groups are very useful if you have multiple subscriptions.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 我们从 Azure 管理组开始，因为在接下来的章节中，我们会引用或提到管理组。管理组充当作用域级别，使你能够有效地分配或管理角色和策略。如果你有多个订阅，管理组非常有用。
- en: Management groups act as a placeholder for organizing subscriptions. You can
    also have nested management groups. If you apply a policy or access at the management
    group level, it will be inherited by the underlying management groups and subscriptions.
    From the subscription level, that policy or access will be inherited by resource
    groups and then finally by the resources.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 管理组充当组织订阅的占位符。你也可以拥有嵌套的管理组。如果在管理组层级应用策略或访问权限，它将被下层的管理组和订阅继承。从订阅层级开始，这些策略或访问权限将被资源组继承，最终被资源继承。
- en: 'The hierarchy of management groups is shown here:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 管理组的层次结构如下所示：
- en: '![Hierarchy of Azure management groups](img/B15432_05_01.jpg)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![Azure 管理组的层次结构](img/B15432_05_01.jpg)'
- en: 'Figure 5.1: Hierarchy of Azure management groups'
  id: totrans-16
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5.1：Azure 管理组的层次结构
- en: In Figure 5.1, we are using management groups to separate the operations of
    different departments, such as marketing, IT, and HR. Inside each of these departments,
    there are nested management groups and subscriptions, which helps to organize
    resources into a hierarchy for policy and access management. Later, you will see
    how management groups are used as a scope for governance, policy management, and
    access management.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在图 5.1 中，我们使用管理组将不同部门的操作分开，如市场营销、IT 和人力资源。在每个部门内部，有嵌套的管理组和订阅，这有助于将资源组织成层次结构，以便进行政策和访问管理。稍后，您将看到管理组如何作为治理、政策管理和访问管理的范围。
- en: In the next section, we will be discussing Azure tags, which play another vital
    role in the logical grouping of resources.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一部分，我们将讨论 Azure 标签，它在资源的逻辑分组中发挥着另一个重要作用。
- en: Azure tags
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure 标签
- en: Azure allows the tagging of resource groups and resources with name-value pairs.
    Tagging helps in the logical organization and categorization of resources. Azure
    also allows the tagging of 50 name-value pairs for a resource group and its resources.
    Although a resource group acts as a container or a placeholder for resources,
    tagging a resource group does not mean the tagging of its constituent resources. Resource
    groups and resources should be tagged based on their usage, which will be explained
    later in this section. Tags are bound to a subscription, resource group, or resource.
    Azure accepts any name-value pair, and so it is important for an organization
    to define both the names and their possible values.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 允许通过名称-值对对资源组和资源进行标签标记。标签帮助对资源进行逻辑组织和分类。Azure 还允许对资源组及其资源标记最多 50 个名称-值对。尽管资源组充当资源的容器或占位符，但标记资源组并不意味着标记其组成资源。资源组和资源应根据其使用情况进行标记，本节稍后将解释这一点。标签绑定到订阅、资源组或资源。Azure
    接受任何名称-值对，因此组织需要定义名称及其可能的值。
- en: 'But why is tagging important? In other words, what problems can be solved using
    tagging? Tagging has the following benefits:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 那么，为什么标签很重要呢？换句话说，标签能解决哪些问题？标签具有以下优点：
- en: '**Categorization of resources**: An Azure subscription can be used by multiple
    departments within an organization. It is important for the management team to
    identify the owners of any resources. Tagging helps in assigning identifiers to
    resources that can be used to represent departments or roles.'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**资源分类**：一个 Azure 订阅可以被组织内的多个部门使用。管理团队需要识别任何资源的所有者。标签有助于为资源分配标识符，这些标识符可以代表部门或角色。'
- en: '**Information management for Azure resources**: Again, Azure resources can
    be provisioned by anyone with access to the subscription. Organizations like to
    have a proper categorization of resources in place to comply with information
    management policies. Such policies can be based on application life cycle management,
    such as the management of development, testing, and production environments. They
    could also be based on usage or any other priorities. Each organization has its
    own way of defining information categories, and Azure caters for this with tags.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Azure 资源的信息管理**：同样，Azure 资源可以由任何有权限访问订阅的人进行配置。为了符合信息管理政策，组织通常希望对资源进行适当的分类。这些政策可以基于应用程序生命周期管理，如开发、测试和生产环境的管理。它们还可以基于使用情况或任何其他优先事项。每个组织都有自己定义信息类别的方式，Azure
    通过标签满足这一需求。'
- en: '**Cost management**: Tagging in Azure can help in identifying resources based
    on their categorization. Queries can be executed against Azure to identify cost
    per category, for instance. For example, the cost of resources in Azure for the
    development of an environment for the finance department and the marketing department
    can be easily ascertained. Moreover, Azure also provides billing information based
    on tags. This helps in identifying the consumption rates of teams, departments,
    or groups.'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**成本管理**：在 Azure 中使用标签可以根据资源的分类帮助识别资源。例如，可以针对 Azure 执行查询，以识别每个类别的成本。例如，Azure
    中为财务部门和市场部门开发环境的资源成本可以轻松确定。此外，Azure 还提供基于标签的计费信息，这有助于识别团队、部门或小组的消耗率。'
- en: 'Tags in Azure do have certain limitations, however:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，Azure 中的标签确实存在一些限制：
- en: Azure allows a maximum of 50 tag name-value pairs to be associated with resource
    groups.
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 允许最多 50 个标签名称-值对与资源组关联。
- en: Tags are non-inheritable. Tags applied to a resource group do not apply to the
    individual resources within it. However, it is quite easy to forget to tag resources
    when provisioning them. Azure Policy provides the mechanism to use to ensure that
    tags are tagged with the appropriate value during provision time. We will consider
    the details of such policies later in this chapter.
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 标签是不可继承的。应用于资源组的标签不会应用于其中的单个资源。然而，在为资源配置时，容易忘记为资源添加标签。Azure 策略提供了一种机制，确保在配置时为资源添加适当的标签值。我们将在本章稍后讨论这类策略的详细信息。
- en: Tags can be assigned to resources and resource groups using PowerShell, the
    Azure CLI 2.0, Azure Resource Manager templates, the Azure portal, and the Azure
    Resource Manager REST APIs.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用 PowerShell、Azure CLI 2.0、Azure 资源管理器模板、Azure 门户和 Azure 资源管理器 REST API 来为资源和资源组分配标签。
- en: 'An example of information management categorization using Azure tags is shown
    here:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 这里展示了使用 Azure 标签进行信息管理分类的示例：
- en: '![Information management categorization using Azure tags](img/B15432_05_02.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![使用 Azure 标签进行信息管理分类](img/B15432_05_02.jpg)'
- en: 'Figure 5.2: Information management categorization using Azure tags'
  id: totrans-31
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5.2：使用 Azure 标签进行信息管理分类
- en: In this example, the **Department**, **Project**, **Environment**, **Owner**,
    **Approver**, **Maintainer**, **Start Date**, **Retire Date**, and **Patched Date**
    name-value pairs are used to tag resources. It is extremely easy to find all the
    resources for a particular tag or a combination of tags using PowerShell, the
    Azure CLI, or REST APIs. The next section will discuss ways to use PowerShell
    to assign tags to resources.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，**Department**、**Project**、**Environment**、**Owner**、**Approver**、**Maintainer**、**Start
    Date**、**Retire Date** 和 **Patched Date** 等名称-值对用于为资源添加标签。使用 PowerShell、Azure
    CLI 或 REST API，非常容易查找具有特定标签或标签组合的所有资源。下一节将讨论如何使用 PowerShell 为资源分配标签。
- en: Tags with PowerShell
  id: totrans-33
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 PowerShell 的标签
- en: 'Tags can be managed using PowerShell, Azure Resource Manager templates, the
    Azure portal, and REST APIs. In this section, PowerShell will be used to create
    and apply tags. PowerShell provides a cmdlet for retrieving and attaching tags
    to resource groups and resources:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用 PowerShell、Azure 资源管理器模板、Azure 门户和 REST API 来管理标签。在本节中，将使用 PowerShell 来创建和应用标签。PowerShell
    提供了一个 cmdlet 用于检索并附加标签到资源组和资源：
- en: 'To retrieve tags associated with a resource using PowerShell, the `Get-AzResource` cmdlet
    can be used:'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要使用 PowerShell 检索与资源关联的标签，可以使用 `Get-AzResource` cmdlet：
- en: '[PRE0]'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To retrieve tags associated with a resource group using PowerShell, the following
    command can be used:'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要使用 PowerShell 检索与资源组关联的标签，可以使用以下命令：
- en: '[PRE1]'
  id: totrans-38
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'To set tags to a resource group, the `Update-AzTag` cmdlet can be used:'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要为资源组设置标签，可以使用 `Update-AzTag` cmdlet：
- en: '[PRE2]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'To set tags to a resource, the same `Update-AzTag` cmdlet can be used:'
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要为资源设置标签，可以使用相同的 `Update-AzTag` cmdlet：
- en: '[PRE3]'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'You can update existing tags using the `Update-AzTag` command; however, you
    need to specify the operation as `Merge` or `Replace`. `Merge` will append the
    new tags you are passing into the existing tags; however, the `Replace` operation
    will replace all the old tags with the new ones. Here is one example of updating
    the tags in a resource group without replacing the existing ones:'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以使用 `Update-AzTag` 命令更新现有标签；但是，你需要指定操作为 `Merge` 或 `Replace`。`Merge` 将把你传入的新标签附加到现有标签中；而
    `Replace` 操作将替换掉所有旧标签，使用新标签。下面是一个不替换现有标签的资源组标签更新示例：
- en: '[PRE4]'
  id: totrans-44
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Let's now look at tags with Azure Resource Manager templates.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们来看一下使用 Azure 资源管理器模板的标签。
- en: Tags with Azure Resource Manager templates
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 Azure 资源管理器模板的标签
- en: 'Azure Resource Manager templates also help in defining tags for each resource.
    They can be used to assign multiple tags to each resource, as follows:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 资源管理器模板也有助于为每个资源定义标签。可以使用它们为每个资源分配多个标签，如下所示：
- en: '[PRE5]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: In the previous example, a couple of tags, `Dept` and `Environment`, were added
    to a storage account resource using Azure Resource Manager templates.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的示例中，使用 Azure 资源管理器模板为存储帐户资源添加了两个标签，`Dept` 和 `Environment`。
- en: Tagging resource groups versus resources
  id: totrans-50
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 资源组标签与资源标签的区别
- en: It is a must for architects to decide the taxonomy and information architecture
    for Azure resources and resource groups. They should identify the categories by
    which resources will be classified based on the query requirements. However, they
    must also identify whether tags should be attached to individual resources or
    to resource groups.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 架构师必须决定 Azure 资源和资源组的分类法和信息架构。他们应根据查询要求识别资源的分类标准。然而，他们还必须确定标签应该附加到单个资源上，还是附加到资源组上。
- en: If all resources within a resource group need the same tag, then it is better
    to tag the resource group, even though tags don't inherit the resources in the
    resource group. If your organization requires tags to be passed to all the underlying
    resources, then you can consider writing a PowerShell script to get the tags from
    the resource group and update the tags for the resources in the resource group.
    It is important to take queries on tags into consideration before deciding whether
    tags should be applied at the resource level or the resource group level. If the
    queries relate to individual resource types across a subscription and across resource
    groups, then assigning tags to individual resources makes more sense. However,
    if identifying resource groups is enough for your queries to be effective, then
    tags should be applied only to resource groups. If you are moving resources across
    resource groups, the tags applied at the resource group level will be lost. If
    you are moving resources, consider adding the tags again.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 如果资源组内的所有资源都需要相同的标签，那么最好给资源组打标签，尽管标签不会继承到资源组中的资源。如果您的组织要求将标签传递到所有底层资源，可以考虑编写
    PowerShell 脚本，从资源组获取标签，并更新资源组中资源的标签。在决定是否在资源级别或资源组级别应用标签之前，重要的是考虑对标签的查询。如果查询涉及跨订阅和跨资源组的单个资源类型，那么为单个资源分配标签更为合理。然而，如果仅通过识别资源组就能有效地进行查询，那么标签应仅应用于资源组。如果您将资源从一个资源组移动到另一个资源组，资源组级别应用的标签将丢失。如果您要移动资源，请考虑重新添加标签。
- en: Azure Policy
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure 策略
- en: 'In the previous section, we talked about applying tags for Azure deployments.
    Tags are great for organizing resources; however, there is one more thing that
    was not discussed: how do organizations ensure that tags are applied for every
    deployment? There should be automated enforcement of Azure tags to resources and
    resource groups. There is no check from Azure to ensure that appropriate tags
    are applied to resources and resource groups. This is not just specific to tags—this
    applies to the configuration of any resource on Azure. For example, you may wish
    to restrict where your resources can be provisioned geographically (to only the
    US-East region, for instance).'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中，我们讨论了如何为 Azure 部署应用标签。标签在组织资源方面非常有用；然而，还有一件事没有讨论：组织如何确保每次部署都应用了标签？应该对
    Azure 标签进行自动化强制执行，确保资源和资源组都应用标签。Azure 本身没有检查机制来确保资源和资源组上应用了适当的标签。这不仅仅是标签的问题——这适用于
    Azure 上任何资源的配置。例如，您可能希望限制资源的地理位置（例如，仅限于美国东部地区）。
- en: You might have guessed by now that this section is all about formulating a governance
    model on Azure. Governance is an important element in Azure because it ensures
    that everyone accessing the Azure environment is aware of organizational priorities
    and processes. It also helps to bring costs under control. It helps in defining
    organizational conventions for managing resources.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能已经猜到，这一节主要是讲述如何在 Azure 上制定治理模型。治理是 Azure 中的重要元素，因为它确保每个访问 Azure 环境的人都能了解组织的优先事项和流程。它还有助于控制成本，并帮助定义管理资源的组织惯例。
- en: Each policy can be built using multiple rules, and multiple policies can be
    applied to a subscription or resource group. Based on whether the rules are satisfied,
    policies can execute various actions. An action could be to deny an ongoing transaction,
    to audit a transaction (which means writing to logs and allowing it to finish),
    or to append metadata to a transaction if it's found to be missing.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 每个策略可以通过多个规则构建，多个策略可以应用到订阅或资源组。根据规则是否满足，策略可以执行各种操作。操作可以是拒绝正在进行的交易、审计交易（即写入日志并允许其完成），或者如果发现缺少元数据，则将元数据附加到交易中。
- en: Policies could be related to the naming convention of resources, the tagging
    of resources, the types of resources that can be provisioned, the location of
    resources, or any combination of those.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 策略可能与资源的命名约定、资源的标签、可配置的资源类型、资源的位置或这些的任意组合相关。
- en: Azure provides numerous built-in policies and it is possible to create custom
    policies. There is a policy language based on JSON that can be used to define
    custom policies.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: Azure提供了众多内置策略，并且可以创建自定义策略。可以使用基于JSON的策略语言来定义自定义策略。
- en: Now that you know the purpose and use case of Azure Policy, let's go ahead and
    discuss built-in policies, policy language, and custom policies.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经了解了Azure策略的目的和使用场景，让我们继续讨论内置策略、策略语言和自定义策略。
- en: Built-in policies
  id: totrans-60
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 内置策略
- en: Azure provides a service for the creation of custom policies; however, it also
    provides some out-of-the-box policies that can be used for governance. These policies
    relate to allowed locations, allowed resource types, and tags. More information
    for these built-in policies can be found at [https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-policy](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-policy).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: Azure提供了一个用于创建自定义策略的服务；然而，它也提供了一些现成的策略，这些策略可以用于治理。这些策略涉及允许的位置、允许的资源类型和标签。有关这些内置策略的更多信息，请访问[https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-policy](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-policy)。
- en: Policy language
  id: totrans-62
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 策略语言
- en: Policies in Azure use JSON to define and describe policies. There are two steps
    in policy adoption. The policy should be defined and then it should be applied
    and assigned. Policies have scope and can be applied at the management group,
    subscription, or resource group level.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: Azure中的策略使用JSON来定义和描述策略。政策采用有两个步骤：首先定义策略，然后应用和分配它。策略具有作用域，可以在管理组、订阅或资源组级别应用。
- en: 'Policies are defined using `if...then` blocks, similar to any popular programming
    language. The `if` block is executed to evaluate the conditions, and based on
    the result of those conditions, the `then` block is executed:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 策略是使用`if...then`块定义的，类似于任何流行编程语言。`if`块会执行以评估条件，基于这些条件的结果，`then`块将会执行：
- en: '[PRE6]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The policies not only allow simple `if` conditions but also allow multiple `if` conditions
    to be joined together logically to create complex rules. These conditions can
    be joined using `AND`, `OR`, and `NOT` operators:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 策略不仅允许简单的`if`条件，还允许将多个`if`条件逻辑地连接起来，创建复杂的规则。这些条件可以通过`AND`、`OR`和`NOT`运算符连接：
- en: The `AND` syntax requires all conditions to be true.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AND`语法要求所有条件都为真。'
- en: The `OR` syntax requires one of the conditions to be true.
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`OR`语法要求至少有一个条件为真。'
- en: The `NOT` syntax inverts the result of the condition.
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`NOT`语法反转条件的结果。'
- en: 'The `AND` syntax is shown next. It is represented by the `allOf` keyword:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来是`AND`语法，它由`allOf`关键字表示：
- en: '[PRE7]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The `OR` syntax is shown next. It is represented by the `anyOf` keyword:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来是`OR`语法，它由`anyOf`关键字表示：
- en: '[PRE8]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The `NOT` syntax is shown next. It is represented by the `not` keyword:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来是`NOT`语法，它由`not`关键字表示：
- en: '[PRE9]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'In fact, these logical operators can be combined together, as follows:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 事实上，这些逻辑运算符可以组合在一起，如下所示：
- en: '[PRE10]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'This is very similar to the use of `if` conditions in popular programming languages
    such as C# and Node.js:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 这与在流行编程语言（如C#和Node.js）中使用`if`条件非常相似：
- en: '[PRE11]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: It is important to note that there is no `allow` action, although there is a `Deny` action.
    This means that policy rules should be written with the possibility of denial
    in mind. Rules should evaluate conditions and `Deny` the action if the conditions
    are met.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 需要注意的是，虽然有`Deny`操作，但没有`allow`操作。这意味着策略规则应考虑到可能的拒绝，规则应评估条件并在满足条件时`Deny`该操作。
- en: Allowed fields
  id: totrans-81
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 允许的字段
- en: 'The fields that are allowed in conditions while defining policies are as follows:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在定义策略时，允许的条件字段如下：
- en: '`Name`: The name of the resource for applying the policy to. This is very specific
    and applicable to a resource by its usage.'
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Name`：应用策略的资源名称。这是非常具体的，并且适用于资源的使用。'
- en: '`Type`: The type of resource, such as `Microsoft.Compute/VirtualMachines`.
    That would apply the policy to all instances of virtual machines, for example.'
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Type`：资源类型，例如`Microsoft.Compute/VirtualMachines`。这将把策略应用于所有虚拟机实例。'
- en: '`Location`: The location (that is, the Azure region) of a resource.'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Location`：资源的位置（即Azure区域）。'
- en: '`Tags`: The tags associated with a resource.'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`标签`：与资源关联的标签。'
- en: '`Property aliases`: Resource-specific properties. These properties are different
    for different resources.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`属性别名`：特定资源的属性。这些属性对于不同的资源是不同的。'
- en: In the next section, you will learn more about safekeeping resources in production
    environments.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，你将学习更多关于如何保护生产环境中的资源的信息。
- en: Azure locks
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure 锁定
- en: Locks are mechanisms for stopping certain activities on resources. RBAC provides
    rights to users, groups, and applications within a certain scope. There are out-of-the-box
    RBAC roles, such as owner, contributor, and reader. With the contributor role,
    it is possible to delete or modify a resource. How can such activities be prevented
    despite the user having a contributor role? Enter Azure locks.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 锁定是一种停止对资源执行某些操作的机制。RBAC（基于角色的访问控制）为用户、组和应用程序提供在特定范围内的权限。有现成的 RBAC 角色，例如所有者、贡献者和读取者。使用贡献者角色，可以删除或修改资源。那么，即便用户拥有贡献者角色，如何避免这些操作呢？答案是：使用
    Azure 锁定。
- en: 'Azure locks can help in two ways:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 锁定可以提供以下两种帮助：
- en: They can lock resources such that they cannot be deleted, even if you have owner
    access.
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们可以锁定资源，使其即便拥有所有者权限，也无法删除。
- en: They can lock resources in such a way that they can neither be deleted nor have
    their configuration modified.
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 锁定可以以这样的方式保护资源，使它们既不能被删除，也不能修改其配置。
- en: Locks are typically very helpful for resources in production environments that
    should not be modified or deleted accidentally.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 锁定通常对生产环境中的资源非常有帮助，这些资源不应被意外修改或删除。
- en: Locks can be applied at the levels of subscription, resource group, management
    group, and individual resource. Locks can be inherited between subscriptions,
    resource groups, and resources. Applying a lock at the parent level will ensure
    that those resources at the child level will also inherit it. Resources that are
    added later in the sub-scope also inherit the lock configuration by default. Applying
    a lock at the resource level will also prevent the deletion of the resource group
    containing the resource.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 锁定可以应用于订阅、资源组、管理组以及单个资源的级别。锁定可以在订阅、资源组和资源之间继承。对父级应用锁定将确保子级资源也继承该锁定。后续添加到子范围的资源也默认继承该锁定配置。在资源级别应用锁定还会阻止包含该资源的资源组被删除。
- en: Locks are applied only to operations that help in managing a resource, rather
    than operations that are within a resource. Users need either `Microsoft.Authorization/*` or `Microsoft.Authorization/locks/*` RBAC
    permissions to create and modify locks.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 锁定仅应用于帮助管理资源的操作，而不涉及资源内部的操作。用户需要拥有 `Microsoft.Authorization/*` 或 `Microsoft.Authorization/locks/*`
    的 RBAC 权限才能创建和修改锁定。
- en: Locks can be created and applied through the Azure portal, Azure PowerShell,
    the Azure CLI, Azure Resource Manager templates, and REST APIs.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 锁定可以通过 Azure 门户、Azure PowerShell、Azure CLI、Azure 资源管理器模板以及 REST API 创建和应用。
- en: 'Creating a lock using an Azure Resource Manager template is done as follows:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Azure 资源管理器模板创建锁定的方法如下：
- en: '[PRE12]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The `resources` section of the Azure Resource Manager template code consists
    of a list of all the resources to be provisioned or updated within Azure. There
    is a storage account resource, and the storage account has a lock resource. A
    name for the lock is provided using dynamic string concatenation, and the lock
    that's applied is of the `CannotDelete` type, which means that the storage account
    is locked for deletion. The storage account can only be deleted after the removal
    of the lock.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 资源管理器模板代码中的 `resources` 部分包含了所有在 Azure 中将要配置或更新的资源列表。这里有一个存储账户资源，并且存储账户中包含一个锁定资源。锁定的名称是通过动态字符串拼接提供的，所应用的锁定是
    `CannotDelete` 类型，这意味着该存储账户被锁定，无法删除。只有在移除锁定后，存储账户才能被删除。
- en: 'Creating and applying a lock to a resource using PowerShell is done as follows:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 PowerShell 创建并应用锁定到资源的方法如下：
- en: '[PRE13]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Creating and applying a lock to a resource group using PowerShell is done as
    follows:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 PowerShell 创建并应用锁定到资源组的方法如下：
- en: '[PRE14]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Creating and applying a lock to a resource using the Azure CLI is done as follows:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Azure CLI 创建并应用锁定到资源的方法如下：
- en: '[PRE15]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Creating and applying a lock to a resource group using the Azure CLI is done
    as follows:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Azure CLI 创建并应用锁定到资源组的方法如下：
- en: '[PRE16]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: To create or delete resource locks, the user should have access to the `Microsoft.Authorization/*`
    or `Microsoft.Authorization/locks/*` actions. You can further give granular permissions
    as well. Owners and user access administrators will have access to creating or
    deleting locks by default.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建或删除资源锁定，用户应当具有对 `Microsoft.Authorization/*` 或 `Microsoft.Authorization/locks/*`
    操作的访问权限。你还可以进一步授予更细粒度的权限。拥有者和用户访问管理员默认将具有创建或删除锁定的权限。
- en: If you are wondering what the `Microsoft.Authorization/*` and `Microsoft.Authorization/locks/*`
    keywords are, you will get to know more about them in the next section.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想知道 `Microsoft.Authorization/*` 和 `Microsoft.Authorization/locks/*` 关键字是什么，下一节你会了解更多相关内容。
- en: Let's now look at Azure RBAC.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们来看一下 Azure RBAC。
- en: Azure RBAC
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure RBAC
- en: Azure provides authentication using Azure Active Directory for its resources.
    Once an identity has been authenticated, the resources the identity will be allowed
    to access should be decided. This is known as authorization. Authorization evaluates
    the permissions that have been afforded to an identity. Anybody with access to
    an Azure subscription should be given just enough permissions so that their specific
    job can be performed, and nothing more.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 使用 Azure Active Directory 进行资源的身份验证。身份验证完成后，应该确定该身份可以访问哪些资源。这就是授权。授权评估已赋予身份的权限。任何拥有
    Azure 订阅访问权限的人应该仅被赋予足够的权限来执行他们的特定工作，其他的权限不需要提供。
- en: Authorization is popularly also known as RBAC. RBAC in Azure refers to the assigning
    of permissions to identities within a scope. The scope could be a management group,
    a subscription, a resource group, or individual resources.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 授权也常被称为 RBAC。Azure 中的 RBAC 是指在某个范围内为身份分配权限。该范围可以是管理组、订阅、资源组或单个资源。
- en: RBAC helps in the creation and assignment of different permissions to different
    identities. This helps in segregating duties within teams, rather than everyone
    having all permissions. RBAC helps in making people responsible for their job
    only, because others might not even have the necessary access to perform it. It
    should be noted that providing permissions at a greater scope automatically ensures
    that child resources inherit those permissions. For example, providing an identity
    with read access to a resource group means that the identity will have read access
    to all the resources within that group, too.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: RBAC 帮助创建和分配不同的权限给不同的身份。这有助于在团队内部分配职责，而不是每个人都有所有的权限。RBAC 帮助让每个人只对自己的工作负责，因为其他人可能没有执行该工作的必要访问权限。需要注意的是，在更大范围内提供权限会自动确保子资源继承这些权限。例如，给一个身份提供对资源组的读取权限意味着该身份也会对该组内的所有资源拥有读取权限。
- en: 'Azure provides three general-purpose, built-in roles. They are as follows:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 提供了三种通用的内建角色，具体如下：
- en: The owner role, which has full access to all resources
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 拥有者角色，具有对所有资源的完全访问权限
- en: The contributor role, which has access to read/write resources
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 贡献者角色，具有读取/写入资源的权限
- en: The reader role, which has read-only permissions to resources
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 读者角色，具有只读资源权限
- en: There are more roles provided by Azure, but they are resource-specific, such
    as the network contributor and security manager roles.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 提供了更多的角色，但它们是特定于资源的，如网络贡献者和安全管理员角色。
- en: To get all roles provided by Azure for all resources, execute the `Get-AzRoleDefinition` command
    in the PowerShell console.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取 Azure 为所有资源提供的所有角色，请在 PowerShell 控制台中执行 `Get-AzRoleDefinition` 命令。
- en: 'Each role definition has certain allowed and disallowed actions. For example,
    the owner role has all actions permitted; no action is prohibited:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 每个角色定义都有特定的允许和**不允许**的操作。例如，拥有者角色允许所有操作；没有任何操作是禁止的：
- en: '[PRE17]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Each role comprises multiple permissions. Each resource provides a list of
    operations. The operations supported by a resource can be obtained using the `Get-AzProviderOperation` cmdlet.
    This cmdlet takes the name of the provider and resource to retrieve the operations:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 每个角色由多个权限组成。每个资源提供一组操作。可以通过 `Get-AzProviderOperation` cmdlet 获取某个资源支持的操作。此 cmdlet
    需要提供提供者和资源的名称来检索操作：
- en: '[PRE18]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'This will result in the following output:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 这将导致以下输出：
- en: '[PRE19]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The output shown here provides all the actions available within the `Microsoft.Insights`
    resource provider across its associated resources. The resources include `Metrics`,
    `Register`, and others, while the actions include `Read`, `Write`, and others.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 这里显示的输出提供了 `Microsoft.Insights` 资源提供程序中所有可用的操作，包括其关联的资源。资源包括 `Metrics`、`Register`
    等，而操作包括 `Read`、`Write` 等。
- en: Let's now look at custom roles.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们来看看自定义角色。
- en: Custom roles
  id: totrans-130
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 自定义角色
- en: Azure provides numerous out-of-the-box generic roles, such as owner, contributor,
    and reader, as well as specialized resource-specific roles, such as virtual machine
    contributor. Having a reader role assigned to a user/group or service principal
    will mean reader permissions being assigned to the scope. The scope could be a
    resource, resource group, or a subscription. Similarly, a contributor would be
    able to read as well as modify the assigned scope. A virtual machine contributor
    would be able to modify virtual machine settings and not any other resource settings.
    There are, however, times when existing roles might not suit our requirements.
    In such cases, Azure allows the creation of custom roles. They can be assigned
    to users, groups, and service principals and are applicable to resources, resource
    groups, and subscriptions.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 提供了许多现成的通用角色，如所有者、贡献者和阅读者，以及专门的资源特定角色，如虚拟机贡献者。当为用户/组或服务主体分配阅读者角色时，意味着会将阅读者权限分配给某个范围。这个范围可以是资源、资源组或订阅。同样，贡献者能够读取并修改分配的范围。而虚拟机贡献者则只能修改虚拟机的设置，而不能修改其他资源的设置。然而，有时现有的角色可能不符合我们的需求。在这种情况下，Azure
    允许创建自定义角色。它们可以分配给用户、组和服务主体，并且适用于资源、资源组和订阅。
- en: 'Custom roles are created by combining multiple permissions. For example, a
    custom role can consist of operations from multiple resources. In the next code
    block, a new role definition is being created, but instead of setting all properties
    manually, one of the existing `"Virtual Machine Contributor"` roles is retrieved
    because it almost matches with the configuration of the new custom role. Avoid
    using the same name as built-in roles, as that would create conflict. Then, the
    ID property is nullified and a new name and description is provided. The code
    also clears all the actions, adds some actions, adds a new scope after clearing
    the existing scope, and finally creates a new custom role:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 自定义角色是通过组合多个权限来创建的。例如，一个自定义角色可以由多个资源的操作组成。在下一个代码块中，正在创建一个新的角色定义，但不是手动设置所有属性，而是获取其中一个现有的“虚拟机贡献者”角色，因为它几乎与新自定义角色的配置匹配。避免使用与内置角色相同的名称，因为这会导致冲突。然后，将
    ID 属性置为空，提供一个新的名称和描述。代码还清除了所有操作，添加了一些操作，在清除现有范围后添加了新范围，最后创建了一个新的自定义角色：
- en: '[PRE20]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'There is a preview feature available in the Azure portal that you can use to
    create custom RBAC roles from the Azure portal itself. You have the option to
    create roles from scratch, clone an existing role, or start writing the JSON manifest.
    *Figure 5.3* shows the **Create a custom role** blade, which is available at **IAM
    > +Add** section:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure 门户中，有一个预览功能，可以让你直接在门户中创建自定义 RBAC 角色。你可以选择从头开始创建角色、克隆现有角色或直接编写 JSON 清单。*图
    5.3* 显示了**创建自定义角色**窗格，它位于 **IAM > +添加** 部分：
- en: '![Creating a custom role from the Azure portal](img/B15432_05_03.jpg)'
  id: totrans-135
  prefs: []
  type: TYPE_IMG
  zh: '![从 Azure 门户创建自定义角色](img/B15432_05_03.jpg)'
- en: 'Figure 5.3: Creating custom roles from the Azure portal'
  id: totrans-136
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5.3：从 Azure 门户创建自定义角色
- en: This makes the process of custom role creation hassle-free.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 这使得创建自定义角色的过程变得轻松无忧。
- en: How are locks different from RBAC?
  id: totrans-138
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 锁与 RBAC 有什么不同？
- en: Locks are not the same as RBAC. RBAC helps in allowing or denying permissions for
    resources. These permissions relate to performing operations, such as read, write,
    and update operations on resources. Locks, on the other hand, relate to disallowing
    permissions to configure or delete resources.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 锁与 RBAC 不同。RBAC 帮助允许或拒绝对资源的权限。这些权限与执行操作相关，如对资源进行读取、写入和更新等操作。而锁则与禁止配置或删除资源的权限有关。
- en: In the next section, we will be discussing Azure Blueprints, which helps us
    with the orchestration of artifacts, such as role assignments, policy assignments,
    and more, that we have discussed so far.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的章节中，我们将讨论 Azure 蓝图，它有助于我们组织已经讨论过的工件，如角色分配、策略分配等。
- en: Azure Blueprints
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure 蓝图
- en: You will be familiar with the word blueprint, which refers to the plan or drawing
    that is used by an architect to architect a solution. Similarly, in Azure, cloud
    architects can leverage Azure Blueprints to define a set of repeatable Azure resources
    that adheres to an organization's standards, processes, and patterns.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 你将会熟悉“蓝图”这个词，它指的是建筑师用来设计解决方案的计划或图纸。同样，在 Azure 中，云架构师可以利用 Azure Blueprints 来定义一组可重复的
    Azure 资源，符合组织的标准、流程和模式。
- en: 'Blueprints allows us to orchestrate the deployment of various resources and
    other artifacts, such as:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: Blueprints 允许我们编排各种资源和其他工件的部署，例如：
- en: Role assignments
  id: totrans-144
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 角色分配
- en: Policy assignments
  id: totrans-145
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 策略分配
- en: Azure Resource Manager templates
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 资源管理器模板
- en: Resource groups
  id: totrans-147
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 资源组
- en: Azure blueprint objects are replicated to multiple regions and are backed by
    Azure Cosmos DB. The replication helps in providing consistent access to resources
    and maintaining the organization's standards irrespective of which region you
    are deploying to.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 蓝图对象会复制到多个区域，并由 Azure Cosmos DB 提供支持。复制有助于提供一致的资源访问，并保持组织标准，无论你将资源部署到哪个区域。
- en: 'Azure Blueprints comprises various artifacts, and you can find the list of
    supported artifacts here: [https://docs.microsoft.com/azure/governance/blueprints/overview#blueprint-definition](https://docs.microsoft.com/azure/governance/blueprints/overview#blueprint-definition).'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Blueprints 包含了各种工件，你可以在这里找到支持的工件列表：[https://docs.microsoft.com/azure/governance/blueprints/overview#blueprint-definition](https://docs.microsoft.com/azure/governance/blueprints/overview#blueprint-definition)。
- en: Blueprints can be created from the Azure portal, Azure PowerShell, the Azure
    CLI, REST APIs, or ARM templates.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过 Azure 门户、Azure PowerShell、Azure CLI、REST API 或 ARM 模板创建蓝图。
- en: In the next section, we will look at an example of implementing Azure governance
    features. Services and features such as RBAC, Azure Policy, and Azure resource
    locks will be used in the example.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将看到一个实施 Azure 治理功能的示例。示例中将使用 RBAC、Azure 策略和 Azure 资源锁等服务和功能。
- en: An example of implementing Azure governance features
  id: totrans-152
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 实施 Azure 治理功能的示例
- en: In this section, we will go through a sample architecture implementation for
    a fictitious organization that wants to implement Azure governance and cost management
    features.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将介绍一个示例架构实施，针对一个虚构的组织，该组织希望实现 Azure 治理和成本管理功能。
- en: Background
  id: totrans-154
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 背景
- en: '**Company Inc** is a worldwide company that is implementing a social media
    solution on an Azure IaaS platform. They use web servers and application servers
    deployed on Azure virtual machines and networks. Azure SQL Server acts as the
    backend database.'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '**公司 Inc** 是一家全球性公司，正在 Azure IaaS 平台上实现社交媒体解决方案。他们使用部署在 Azure 虚拟机和网络上的 Web
    服务器和应用服务器。Azure SQL Server 作为后台数据库。'
- en: RBAC for Company Inc
  id: totrans-156
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Company Inc 的 RBAC
- en: The first task is to ensure that the appropriate teams and application owners
    can access their resources. It is recognized that each team has different requirements.
    For the sake of clarity, Azure SQL is deployed in a separate resource group to
    the Azure IaaS artifacts.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 第一个任务是确保适当的团队和应用程序所有者能够访问他们的资源。需要注意的是，每个团队有不同的需求。为了清晰起见，Azure SQL 被部署在与 Azure
    IaaS 工件不同的资源组中。
- en: 'The administrator assigns the following roles for the subscription:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 管理员为订阅分配以下角色：
- en: '![Different roles with access details](img/Table_5.1.jpg)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![不同角色及访问详情](img/Table_5.1.jpg)'
- en: 'Table 5.1: Different roles with access details'
  id: totrans-160
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 表 5.1：不同角色及访问详情
- en: Azure Policy
  id: totrans-161
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure 策略
- en: The company should implement Azure Policy to ensure that its users always provision
    resources according to the company guidelines.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 该公司应该实施 Azure 策略，以确保其用户始终按照公司指南配置资源。
- en: The policies in Azure govern various aspects related to the deployment of resources.
    The policies will also govern updates after the initial deployment. Some of the
    policies that should be implemented are given in the following section.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 中的策略治理与资源部署相关的各个方面。策略还将治理初始部署后的更新。以下部分列出了应实施的一些策略。
- en: '**Deployments to certain locations**'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: '**部署到特定位置**'
- en: Azure resources and deployments can only be executed for certain chosen locations.
    It would not be possible to deploy resources in regions outside of the policy.
    For example, the regions that are allowed are West Europe and East US. It should
    not be possible to deploy resources in any other region.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 资源和部署只能在选定的位置执行。无法在政策以外的区域部署资源。例如，允许的区域是西欧和东美。应该无法在其他任何区域部署资源。
- en: '**Tags of resources and resource groups**'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: '**资源和资源组的标签**'
- en: Every resource in Azure, including the resource groups, will mandatorily have tags assigned
    to it. The tags will include, as a minimum, details about the department, environment,
    creation data, and project name.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 中的每一个资源，包括资源组，都必须强制分配标签。标签至少应包括有关部门、环境、创建日期和项目名称的详细信息。
- en: '**Diagnostic logs and Application Insights for all resources**'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: '**所有资源的诊断日志和应用程序洞察**'
- en: Every resource deployed on Azure should have diagnostic logs and application logs
    enabled wherever possible.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure 上部署的每个资源都应该在可能的情况下启用诊断日志和应用程序日志。
- en: Azure locks
  id: totrans-170
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure 锁定
- en: A company should implement Azure locks to ensure that crucial resources are
    not deleted accidentally. Every resource that is crucial for the functioning of
    a solution needs to be locked down. This means that even the administrators of
    the services running on Azure do not have the capability to delete these resources;
    the only way to delete a resource is to remove the lock first.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 企业应实施 Azure 锁定，确保重要资源不会被意外删除。所有对解决方案功能至关重要的资源都需要锁定。这意味着即使是 Azure 上运行服务的管理员也没有权限删除这些资源；删除资源的唯一方法是先移除锁定。
- en: 'You should also note that:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 你还需要注意：
- en: All production and pre-production environments, apart from the development and
    testing environments, would be locked for deletion.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 除了开发和测试环境外，所有生产和预生产环境将会被锁定，禁止删除。
- en: All development and testing environments that have single instances would also
    be locked for deletion.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 所有具有单实例的开发和测试环境也将被锁定，禁止删除。
- en: All resources related to the web application would be locked for deletion for
    all production environments.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 所有与 Web 应用相关的资源将在所有生产环境中被锁定，禁止删除。
- en: All shared resources would be locked for deletion irrespective of the environment.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 所有共享资源无论环境如何，都将被锁定，禁止删除。
- en: Summary
  id: totrans-177
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, you learned that governance and cost management are among the
    top priorities for companies moving to the cloud. Having an Azure subscription
    with a pay-as-you-go scheme can harm the company budget, because anyone with access
    to the subscription can provision as many resources as they like. Some resources
    are free, but others are expensive.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你了解到治理和成本管理是企业迁移到云端时的首要任务之一。拥有一个按需付费的 Azure 订阅可能会对公司预算造成影响，因为任何拥有访问权限的人都可以根据需要创建资源。某些资源是免费的，但其他资源则非常昂贵。
- en: You also learned that it is important for organizations to remain in control
    of their cloud costs. Tags help in generating billing reports. These reports could
    be based on departments, projects, owners, or any other criteria. While cost is
    important, governance is equally important. Azure provides locks, policies, and
    RBAC to implement proper governance. Policies ensure that resource operations
    can be denied or audited, locks ensure that resources cannot be modified or deleted,
    and RBAC ensures that employees have the right permissions to perform their jobs.
    With these features, companies can have sound governance and cost control for
    their Azure deployments.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 你还了解到，组织保持云端成本控制非常重要。标签有助于生成计费报告，这些报告可以基于部门、项目、所有者或任何其他标准。虽然成本很重要，但治理同样重要。Azure
    提供了锁定、策略和 RBAC 来实施适当的治理。策略确保可以拒绝或审计资源操作，锁定确保资源无法被修改或删除，RBAC 确保员工具有执行工作所需的权限。通过这些功能，企业可以实现对
    Azure 部署的良好治理和成本控制。
- en: In the next chapter, we will be discussing cost management in Azure. We will
    go through different optimization methods, cost management, and billing APIs.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将讨论 Azure 中的成本管理。我们将讲解不同的优化方法、成本管理和计费 API。
