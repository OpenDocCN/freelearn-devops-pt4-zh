<html><head></head><body>
		<div>
			<div id="_idContainer104" class="Content">
			</div>
		</div>
		<div id="_idContainer105" class="Content">
			<h1 id="_idParaDest-146">6. <a id="_idTextAnchor149"/>Cost management for Azure solutions</h1>
		</div>
		<div id="_idContainer120" class="Content">
			<p>In the previous chapter, we discussed tags, policies, and locks and how they can be leveraged from a compliance standpoint. Tags allow us to add metadata to our resources; they also help us in the logical management of resources. In the Azure portal, we can filter resources based on tags. If we assume there is a large number of resources, which is quite common in enterprises, filtering will help us to easily manage our resources. Another benefit of tags is that they can be used to filter our billing reports or usage reports in terms of tags. In this chapter, we are going to explore cost management for Azure solutions.</p>
			<p>The primary reason why corporations are moving to the cloud is to save on cost. There is no upfront cost for having an Azure subscription. Azure provides a pay-as-you-go subscription, where billing is based on consumption. Azure measures resource usage and provides monthly invoices. There is no upper limit for Azure consumption. As we are on a public cloud, Azure (like any other service provider) has some hard and soft limits on the number of resources that can be deployed. Soft limits can be increased by working with Azure Support. There are some resources that have a hard limit. The service limits can be found at <a href="https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits">https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits</a>, and the default limit varies based on the type of subscription you have.</p>
			<p>It is important for companies to keep a close watch on Azure consumption and usage. Although they can create policies to set organizational standards and conventions, there is also a need to keep track of billing and consumption data. Moreover, they should employ best practices for consuming Azure resources so that the return is maximized. For this, architects need to know about Azure resources and features, their corresponding costs, and the cost/benefit analysis of features and solutions.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Azure offer details</li>
				<li>Billing</li>
				<li>Invoicing</li>
				<li>Usage and quotas</li>
				<li>Usage and Billing APIs</li>
				<li>Azure pricing calculator</li>
				<li>Best practices for cost optimization</li>
			</ul>
			<p>Let's go ahead and discuss each of these points.</p>
			<h2 id="_idParaDest-147"><a id="_idTextAnchor150"/>Azure offer details</h2>
			<p>Azure has different offers that you can purchase. So far, we have discussed pay-as-you-go, but there are others, such as <strong class="bold">Enterprise Agreements</strong> (<strong class="bold">EAs</strong>), Azure Sponsorship, and Azure in CSP. We will cover each of these as they are very important for billing:</p>
			<ul>
				<li><strong class="bold">Pay-as-you-go</strong>: This is a commonly known offering, where customers pay based on the consumption and the rates are available in the public-facing documentation of Azure. Customers receive an invoice every month for usage from Microsoft and they can pay via credit card or an invoice payment method.</li>
				<li><strong class="bold">EAs</strong>: EAs entail a monetary commitment with Microsoft, which means that organizations sign an agreement with Microsoft and promise that they will use x amount of Azure resources. If the usage goes above the agreed amount, the customer will receive an overage invoice. Customers can create multiple accounts under an EA and have multiple subscriptions inside these accounts. There are two types of EA: Direct EA and Indirect EA. Direct EA customers have a direct billing relationship with Microsoft; on the other hand, with Indirect EA, the billing is managed by a partner. EA customers will get better offers and discounts because of the commitment they make with Microsoft. The EA is managed via a portal called the EA portal (<a href="https://ea.azure.com">https://ea.azure.com</a>), and you need to have enrolment privileges to access this portal.</li>
				<li><strong class="bold">Azure in CSP</strong>: Azure in CSP is where a customer reaches out to a <strong class="bold">Cloud Solution Provider</strong> (<strong class="bold">CSP</strong>) partner, and this partner provisions a subscription for the customer. The billing will be completely managed by the partner; the customer will not have a direct billing relationship with Microsoft. Microsoft invoices the partner and the partner invoices the customer, adding their margin.</li>
				<li><strong class="bold">Azure Sponsorship</strong>: Sponsorship is given by Microsoft to start-ups, NGOs, and other non-profit organizations to use Azure. The sponsorship is for a fixed term and a fixed amount of credit. If the term expires or credit gets exhausted, the subscription will be converted to a pay-as-you-go subscription. If organizations want to renew their sponsorship entitlement, they have to work with Microsoft.</li>
			</ul>
			<p>We have just outlined a few of Azure's offerings. The complete list is available at <a href="https://azure.microsoft.com/support/legal/offer-details">https://azure.microsoft.com/support/legal/offer-details</a>, which includes other offerings, such as Azure for Students, Azure Pass, and Dev/Test subscriptions.</p>
			<p>Next, let's discuss billing in Azure.</p>
			<h2 id="_idParaDest-148"><a id="_idTextAnchor151"/>Understanding billing</h2>
			<p>Azure is a service utility that has the following features:</p>
			<ul>
				<li>No upfront costs</li>
				<li>No termination fees</li>
				<li>Billing per second, per minute, or per hour depending on the type of resource</li>
				<li>Payment based on consumption-on-the-go</li>
			</ul>
			<p>In such circumstances, it is very difficult to estimate the upfront cost of consuming Azure resources. Every resource in Azure has its own cost model and charge based on storage, usage, and time span. It is very important for management, administration, and finance departments to keep track of usage and costs. Azure provides usage and billing reporting capabilities to help upper management and administrators generate cost and usage reports based on multiple criteria.</p>
			<p>The Azure portal provides detailed billing and usage information through the <strong class="bold">Cost Management + Billing</strong> feature, which can be accessed from the master navigation blade, as shown in <em class="italics">Figure 6.1</em>:</p>
			<div>
				<div id="_idContainer106" class="IMG---Figure">
					<img src="image/B15432_06_01.jpg" alt="Cost Management + Billing"/>
				</div>
			</div>
			<h6>Figure 6.1: Cost Management + Billing service in the Azure portal</h6>
			<p>Please note that if your billing is managed by a CSP, you will not have access to this feature. CSP customers can view their costs in the pay-as-you-go scheme if they transition their CSP legacy subscriptions to the Azure plan. We will discuss the Azure plan and the Modern Commerce platform later in the chapter.</p>
			<p><strong class="bold">Cost Management + Billing</strong> shows all the subscriptions and the billing scopes you have access to, as shown in <em class="italics">Figure 6.2</em>:</p>
			<div>
				<div id="_idContainer107" class="IMG---Figure">
					<img src="image/B15432_06_02.jpg" alt="Billing details of all listed user subscriptions"/>
				</div>
			</div>
			<h6>Figure 6.2: Billing overview of user subscriptions</h6>
			<p>The <strong class="bold">Cost Management</strong> section has several blades, such as:</p>
			<ul>
				<li><strong class="bold">Cost analysis</strong> for analyzing the usage of a scope.</li>
				<li><strong class="bold">Budgets</strong> for settings budgets.</li>
				<li><strong class="bold">Cost alerts</strong> for notifying administrators when the usage exceeds a certain threshold.</li>
				<li><strong class="bold">Advisor recommendations</strong> for getting advice on how to make potential savings. We will discuss Azure Advisor in the last section of this chapter.</li>
				<li><strong class="bold">Exports</strong> for automating usage exports to Azure Storage.</li>
				<li><strong class="bold">Cloudyn</strong>, which is a tool used by CSP partners to analyze costs, as they don't have access to Cost Management.</li>
				<li><strong class="bold">Connectors for AWS</strong> for connecting your AWS consumption data to Azure Cost Management.</li>
			</ul>
			<p>The different options available in Azure Cost Management are shown in <em class="italics">Figure 6.3</em>:</p>
			<div>
				<div id="_idContainer108" class="IMG---Figure">
					<img src="image/B15432_06_03.jpg" alt="List of services in the Azure Cost Management section in the Azure portal"/>
				</div>
			</div>
			<h6>Figure 6.3: Cost Management overview </h6>
			<p>Clicking on the <strong class="bold">Cost analysis</strong> menu on this blade provides a comprehensive interactive dashboard, using which cost can be analyzed with different dimensions and measures:</p>
			<div>
				<div id="_idContainer109" class="IMG---Figure">
					<img src="image/B15432_06_04.jpg" alt="Analysing subscription costs through the Cost Analysis option"/>
				</div>
			</div>
			<h6>Figure 6.4: Analyzing subscription costs through the Cost analysis option</h6>
			<p>The dashboard not only shows the current cost but also forecasts the cost and breaks it down based on multiple dimensions. <strong class="bold">Service name</strong>, <strong class="bold">Location</strong>, and <strong class="bold">Resource group name</strong> are provided by default, but they can be changed to other dimensions as well. There will be always a scope associated with every view. Some of the available scopes are billing account, management group, subscription, and resource group. You can switch the scope depending on the level you want to analyze.</p>
			<p>The <strong class="bold">Budget</strong> menu on the left allows us to set up the budget for better cost management and provides alerting features in case the actual cost is going to breach the budget estimates:</p>
			<div>
				<div id="_idContainer110" class="IMG---Figure">
					<img src="image/B15432_06_05.jpg" alt="Creating a budget alert for cost management"/>
				</div>
			</div>
			<h6>Figure 6.5: Creating a budget</h6>
			<p>Cost Management also allows us to fetch cost data from other clouds, such as AWS, within the current dashboards, thereby managing costs for multiple clouds from a single blade and dashboard. However, this feature is in preview at the time of writing. This connector will become chargeable after August 25, 2020.</p>
			<p>You need to fill in your AWS role details and other details to pull the cost information, as shown in <em class="italics">Figure 6.5</em>. If you are unsure how to create the policy and role in AWS, refer to <a href="https://docs.microsoft.com/azure/cost-management-billing/costs/aws-integration-set-up-configure#create-a-role-and-policy-in-aws">https://docs.microsoft.com/azure/cost-management-billing/costs/aws-integration-set-up-configure#create-a-role-and-policy-in-aws</a>:</p>
			<div>
				<div id="_idContainer111" class="IMG---Figure">
					<img src="image/B15432_06_06.jpg" alt="Creating a connector to bring AWS cost and usage report data into Azure Cost Management"/>
				</div>
			</div>
			<h6>Figure 6.6: Creating an AWS connector in Cost Management</h6>
			<p>The cost reports can also be exported to a storage account on a scheduled basis.</p>
			<p>Some of the cost analysis is also available in the <strong class="bold">Subscriptions</strong> blade. In the <strong class="bold">Overview</strong> section, you can see resources and their cost. Also, there is another graph, where you can see your current spend, forecast, and balance credit (if you are using a credit-based subscription).</p>
			<p><em class="italics">Figure 6.7</em> shows cost information:</p>
			<div>
				<div id="_idContainer112" class="IMG---Figure">
					<img src="image/B15432_06_07.jpg" alt="Overview of costs by resource for the subscription"/>
				</div>
			</div>
			<h6>Figure 6.7: Cost analysis for the subscription</h6>
			<p>Clicking on any of the costs in <em class="italics">Figure 6.7</em> will redirect you to the <strong class="bold">Cost Management</strong> – <strong class="bold">Cost Analysis</strong> section. There are a lot of dimensions in Cost Management with which you can group the data for analysis. The available dimensions will vary based on the scope you have selected. Some of the commonly used dimensions are as follows:</p>
			<ul>
				<li>Resource types</li>
				<li>Resource group</li>
				<li>Tag</li>
				<li>Resource location</li>
				<li>Resource ID</li>
				<li>Meter category</li>
				<li>Meter subcategory</li>
				<li>Service</li>
			</ul>
			<p>At the beginning of the chapter, we said that tags can be used for cost management. For example, let's say you have a tag called Department with values of IT, HR, and Finance. Tagging the resources appropriately will help you understand the cost incurred by each department. You can also download the cost report as a CSV, Excel, or PNG file using the <strong class="bold">Download</strong> button.</p>
			<p>Additionally, Cost Management supports multiple views. You can create your own dashboard and save it. EA customers get the added benefit of the Cost Management connector or Power BI. With the connector, users can pull the usage statistics to Power BI and create visualizations.</p>
			<p>Up to this point, we have been discussing how we can keep track of our usage using Cost Management. In the next section, we will explore how invoicing works for the services we have used.</p>
			<h2 id="_idParaDest-149"><a id="_idTextAnchor152"/>Invoicing</h2>
			<p>Azure's billing system also provides information about invoices that are generated monthly.</p>
			<p>Depending on the offer type, the method of invoicing may vary. For pay-as-you-go users, the invoices will be sent monthly to the account administrator. However, for EA customers, the invoice will be sent to the contact on the enrollment.</p>
			<p>Clicking on the <strong class="bold">Invoices</strong> menu brings up a list of all the invoices generated, and clicking on any of the invoices provides details about that invoice. <em class="italics">Figure 6.8</em> shows how the invoices are shown in the Azure portal:</p>
			<div>
				<div id="_idContainer113" class="IMG---Figure">
					<img src="image/B15432_06_08.jpg" alt="A list of billed invoices and their details"/>
				</div>
			</div>
			<h6>Figure 6.8: List of invoices and their details</h6>
			<p>There are two types of invoices: one is for Azure services such as SQL, Virtual Machines, and Networking. Another type is for Azure Marketplace and Reservations. Azure Marketplace provides partner services from different vendors for customers. We will be talking about Azure Reservations later on.</p>
			<p>By default, for a pay-as-you-go subscription, the account admin has access to the invoices. If they want, they can delegate access to other users, such as the organization's finance team, by choosing the <strong class="bold">Access invoice</strong> option in <em class="italics">Figure 6.8</em>. Additionally, the account admin can opt for email addresses where they want to send out the copies of the invoices.</p>
			<p>The <strong class="bold">Email Invoice</strong> option is not available for Support Plan now. Alternatively, you can visit the Accounts portal and download the invoice. Microsoft is slowly moving away from this portal, and most of the features are getting deprecated as they are integrated into the Azure portal.</p>
			<p>So far, we have discussed subscriptions and how invoicing is done. Something new that has been introduced by Microsoft is Modern Commerce. With this new commerce experience, the purchase process and experience has been simplified. Let's take a closer look at Modern Commerce and learn how it is different from the legacy platform that we have discussed so far.</p>
			<h3 id="_idParaDest-150"><a id="_idTextAnchor153"/>The Modern Commerce experience</h3>
			<p>If your organization is already working with Microsoft, you will know that there are multiple agreements involved for each offer, such as Web Direct, EAs, CSP, <strong class="bold">Microsoft Service and Product Agreement</strong> (<strong class="bold">MSPA</strong>), <strong class="bold">Server Cloud Enrollments</strong> (<strong class="bold">SCE</strong>), and so on. Along with this, each of them has its own portal; for example, EAs have the EA portal, CSP has the Partner Center portal, and Volume Licensing has its own portal too.</p>
			<p>Each offer comes with a different set of terms and conditions, and the customers need to go through them every time they make a purchase. The transition from one offer to another is not very easy as each offer has a different set of terms and conditions. Let's imagine that you already have an EA subscription and would like to convert it to a CSP subscription; you may have to delete some of the partner services as they are not supported in CSP. For each product, each offer will have different rules. From a customer standpoint, it's very hard to understand what supports what and how rules differ.</p>
			<p>Addressing this issue, Microsoft has recently issued a new agreement called <strong class="bold">Microsoft Customer Agreement</strong> (<strong class="bold">MCA</strong>). This will act as the basic terms and conditions. You can make amendments to it whenever required when you sign up for a new program.</p>
			<p>For Azure, there will be three <strong class="bold">Go-To-Market</strong> (<strong class="bold">GTM</strong>) programs:</p>
			<ul>
				<li><strong class="bold">Field Led</strong>: Customers will interact directly with the Microsoft Accounts Team and the billing will be directly managed by Microsoft. Eventually, this will replace EAs.</li>
				<li><strong class="bold">Partner Led</strong>: This is equivalent to the Azure-in-CSP program, where a partner manages your billing. There are different partners across the world. A quick web search will help you find the partners around you. This program will replace the Azure-in-CSP program. As the first step to Modern Commerce, a partner will sign a <strong class="bold">Microsoft Partner Agreement</strong> (<strong class="bold">MPA</strong>) with Microsoft and transition their existing customers by making them sign the MCA. At the time of writing this book, many partners have transitioned their customers to Modern Commerce, and the new commerce experience is available in 139 countries.</li>
				<li><strong class="bold">Self Service</strong>: This will be a replacement for Web Direct. It doesn't require any involvement from the partner or the Microsoft Accounts Team. Customers can directly purchase from <a href="http://microsoft.com">microsoft.com</a> and they will sign the MCA during the purchase.</li>
			</ul>
			<p>In Azure, the billing will be done on the Azure Plan, and the billing will be always aligned with the calendar month. Buying an Azure Plan is very similar to buying any other subscription. The difference is that the MCA will be signed during the process.</p>
			<p>Azure Plan can host multiple subscriptions, and it will act as a root-level container. All the usage is tied back to a single Azure Plan. All the subscriptions inside the Azure Plan will act as containers to host services, such as Virtual Machines, SQL Database, and Networking.</p>
			<p>Some of the changes and advancements we could observe after the introduction of Modern Commerce are as follows:</p>
			<ul>
				<li>Eventually, the portals will be deprecated. For example, earlier EA customers were only able to download the enrollment usage information from the EA portal. Now Microsoft has integrated it into Azure Cost Management with a richer experience than the EA portal.</li>
				<li>Pricing will be done in USD and billed in the local currency. If your currency is not USD, then the <strong class="bold">foreign exchange</strong> (<strong class="bold">FX</strong>) rate will be applied and is available in your invoice. Microsoft uses FX rates from Thomson Reuters, and these rates will be assigned on the first of every month. This value will be consistent throughout the month, irrespective of what the market rate is.</li>
				<li>CSP customers who transition to the new Azure Plan will be able to use Cost Management. Access to Cost Management opens a new world of cost tracking, as it provides access to all native Cost Management features.</li>
			</ul>
			<p>All the subscriptions that we have discussed so far will eventually be moved to an Azure Plan, which is the future of Azure. Now that you understand the basics of Modern Commerce, let's discuss another topic that has a very important role when we are architecting solutions. Most services have limits by default; some of these limits can be increased while some are hard limits. When we are architecting a solution, we need to make sure that there is ample quota. Capacity planning is a vital part of architectural design. In the next section, you will learn more about limits on subscriptions.</p>
			<h2 id="_idParaDest-151"><a id="_idTextAnchor154"/>Usage and quotas</h2>
			<p>As mentioned in the previous section, capacity planning needs to be one of the first steps when we architect a solution. We need to verify whether the subscription has enough quota to accommodate the new resources we are architecting. If not, during the deployment, we may face issues.</p>
			<p>Each subscription has a limited quota for each resource type. For example, there could be a maximum of 10 public IP addresses provisioned with an MSDN Microsoft account. Similarly, all resources have a maximum default limit for each resource type. These resource type numbers for a subscription can be increased by contacting Azure Support or clicking on the <strong class="bold">Request Increase</strong> button in the <strong class="bold">Usage</strong> <strong class="bold">+</strong> <strong class="bold">Quota</strong> blade on the <strong class="bold">Subscription</strong> page.</p>
			<p>Considering the number of resources in each region, it'll be a challenge to go through the list. The portal provides options to filter the dataset and look for what we want. In <em class="italics">Figure 6.9</em>, you can see that if we filter the location to <strong class="bold">Central US</strong> and set the resource provider to <strong class="bold">Microsoft.Storage</strong>, we can confirm which quotas are available for storage accounts:</p>
			<p> </p>
			<div>
				<div id="_idContainer114" class="IMG---Figure">
					<img src="image/B15432_06_09.jpg" alt="Checking usage and quota for a given location and resource provider"/>
				</div>
			</div>
			<h6>Figure 6.9: Usage and quota for a given location and resource provider</h6>
			<p>You can clearly see in <em class="italics">Figure 6.9</em> that we haven't created any storage accounts in Central US, and that leaves us with a quota of 250 accounts. If the solution we are architecting requires more than 250 accounts, we need to click on <strong class="bold">Request Increase</strong>, which would contact Azure Support.</p>
			<p>This blade gives us the freedom to perform capacity planning prior to deployment.</p>
			<p>When filtering the report, we used the term <strong class="bold">resource provider</strong> and selected <strong class="bold">Microsoft.Storage</strong>. In the next section, will take a closer look at what this term means.</p>
			<h2 id="_idParaDest-152"><a id="_idTextAnchor155"/>Resource providers and resource types</h2>
			<p>Whether you are interacting with the Azure portal, filtering services, or filtering the billing usage report, you might need to work with resource providers and resource types. For example, when you are creating a virtual machine, you are interacting with the <strong class="inline">Microsoft.Compute</strong> resource provider and the <strong class="inline">virtualMachines</strong> resource type. The <strong class="bold">create</strong> button that you click on to create the virtual machines communicates with the resource provider via an API to get your deployment done. This is always denoted in the format <strong class="inline">{resource-provider}/{resource-type}</strong>. So, the resource type for the virtual machine is <strong class="inline">Microsoft.Compute/virtualMachines</strong>. In short, resource providers help to create resource types.</p>
			<p>Resource providers need to be registered with an Azure subscription. Resource types will not be available in a subscription if resource providers are not registered. By default, most providers are automatically registered; having said that, there will be scenarios where we must manually register.</p>
			<p>To get a list of providers that are available, the ones that are registered and the ones that are not registered, and to register non-registered providers or vice versa, the dashboard shown in <em class="italics">Figure 6.10</em> can be used. For this operation, you need to have the necessary roles assigned—Owner or Contributor roles will suffice. <em class="italics">Figure 6.10</em> shows what the dashboard looks like:</p>
			<div>
				<div id="_idContainer115" class="IMG---Figure">
					<img src="image/B15432_06_10.jpg" alt="List of registered and non-registered resource providers"/>
				</div>
			</div>
			<h6>Figure 6.10: List of registered and non-registered resource providers</h6>
			<p>In the previous section, we discussed how to download invoices and usage information. If you need to download the data programmatically and save it, then you can use APIs. The next section is all about Azure Billing APIs.</p>
			<h2 id="_idParaDest-153"><a id="_idTextAnchor156"/>Usage and Billing APIs</h2>
			<p>Although the portal is a great way to find usage, billing, and invoice information manually, Azure also provides the following APIs to programmatically retrieve details and create customized dashboards and reports. The APIs vary depending on the kind of subscription you are using. As there are many APIs, we will be sharing the Microsoft documentation with each API so that you can explore them all.</p>
			<h3 id="_idParaDest-154"><a id="_idTextAnchor157"/>Azure Enterprise Billing APIs</h3>
			<p>EA customers have a dedicated set of APIs available for them to work with billing data. The following APIs use the API key from the EA portal for authentication; tokens from Azure Active Directory will not work with them:</p>
			<ul>
				<li><strong class="bold">Balance and Summary API</strong>: As we discussed earlier, EA works with a monetary commitment, and it is very important to track the balance, overage, credit adjustments, and Azure Marketplace charges. Using this API, customers can pull the balance and summary for a billing period.</li>
				<li><strong class="bold">Usage Details API</strong>: The Usage Details API will help you to get daily usage information about the enrollment with granularity down to the instance level. The response of this API will be like the usage report that can be downloaded from the EA portal.</li>
				<li><strong class="bold">Marketplace Store Charge API</strong>: This is a dedicated API for extracting the charges for Marketplace purchases.</li>
				<li><strong class="bold">Price Sheet API</strong>: Each enrollment will have a special price sheet, and discounts vary from customers to customers. The Price Sheet API can pull the price list.</li>
				<li><strong class="bold">Reserved Instance Details API</strong>: We haven't discussed Azure Reservations so far, but it will be discussed by the end of this chapter. Using this API, you can get usage information about the reservations and a list of the reservations in the enrollment.</li>
			</ul>
			<p>Here is the link to the documentation for the EA APIs: <a href="https://docs.microsoft.com/azure/cost-management-billing/manage/enterprise-api">https://docs.microsoft.com/azure/cost-management-billing/manage/enterprise-api</a>.</p>
			<p>Let's take a look at the Azure Consumption APIs now.</p>
			<h3 id="_idParaDest-155"><a id="_idTextAnchor158"/>Azure Consumption APIs</h3>
			<p>Azure Consumption APIs can be used with EA as well as Web Direct (with some exceptions) subscriptions. This requires a token, which needs to be generated by authenticating against Azure Active Directory. Since these APIs also support EA, don't confuse this token with the EA API key that we mentioned in the previous section. Here are the key APIs that are self-explanatory:</p>
			<ul>
				<li>Usage Details API</li>
				<li>Marketplace Charges API</li>
				<li>Reservation Recommendations API</li>
				<li>Reservation Details and Summary API</li>
			</ul>
			<p>EA customers have additional support for the following APIs:</p>
			<ul>
				<li>Price sheet</li>
				<li>Budgets</li>
				<li>Balances</li>
			</ul>
			<p>Documentation is available here: <a href="https://docs.microsoft.com/azure/cost-management-billing/manage/consumption-api-overview">https://docs.microsoft.com/azure/cost-management-billing/manage/consumption-api-overview</a>.</p>
			<p>Additionally, there is another set of APIs that can be only used by Web Direct customers:</p>
			<ul>
				<li><strong class="bold">Azure Resource Usage API</strong>: This API can be used with an EA or pay-as-you-go subscription to download the usage data.</li>
				<li><strong class="bold">Azure Resource RateCard API</strong>: This is only applicable to Web Direct; EAs are not supported. Web Direct customers can use this to download price sheets.</li>
				<li><strong class="bold">Azure Invoice Download API</strong>: This is only applicable to Web Direct customers. It's used to download invoices programmatically.</li>
			</ul>
			<p>The names may look familiar, and the difference is only the endpoint that we are calling. For Azure Enterprise Billing APIs, the URL will start with <strong class="inline">https://consumption.azure.com</strong>, and for Azure Consumption APIs, the URL starts with <strong class="inline">https://management.azure.com</strong>. This is how you can differentiate them. In the next section, you will be seeing a new set of APIs that are specifically used by Cost Management.</p>
			<h3 id="_idParaDest-156"><a id="_idTextAnchor159"/>Azure Cost Management APIs</h3>
			<p>With the introduction of Azure Cost Management, a new set of APIs are available for the customer to use. These APIs are the backbone of Cost Management, which we used in the Azure portal earlier. The key APIs are as follows:</p>
			<ul>
				<li><strong class="bold">Query Usage API</strong>: This is the same API used by Cost Analysis in the Azure portal. We can customize the response with what we need using a payload. It's very useful when we want a customized report. The date range cannot exceed 365 days.</li>
				<li><strong class="bold">Budgets API</strong>: Budgets is another feature of Azure Cost Management, and this API lets us interact with the budgets programmatically.</li>
				<li><strong class="bold">Forecast API</strong>: This can be used to get a forecast of a scope. The Forecast API is only available for EA customers now.</li>
				<li><strong class="bold">Dimensions API</strong>: Earlier, when we were discussing Cost Management, we said that Cost Management supports multiple dimensions based on the scope. If you would like to get the list of dimensions supported based on a specific scope, you can use this API.</li>
				<li><strong class="bold">Exports API</strong>: Another feature of Cost Management is that we can automate the report export to a storage account. The Exports API can be used to interact with the export configuration, such as the name of the storage account, customization, frequency, and so on.</li>
			</ul>
			<p>Check out the official documentation at <a href="https://docs.microsoft.com/rest/api/cost-management">https://docs.microsoft.com/rest/api/cost-management</a>.</p>
			<p>Since Modern Commerce is expanding MCA, there's a whole new set of APIs that can be explored here: <a href="https://docs.microsoft.com/rest/api/billing">https://docs.microsoft.com/rest/api/billing</a>.</p>
			<p>You may have noticed that we haven't mentioned CSP in any of these scenarios. In CSP, the customer doesn't have access to the billing as it's managed by a partner, hence the APIs are not exposed. However, a transition to an Azure Plan would let the CSP customer use the Azure Cost Management APIs to see the retail rates.</p>
			<p>Any programming or scripting language can be used to use these APIs and mix them together to create complete comprehensive billing solutions. In the next section, we will be focusing on the Azure pricing calculator, which will help the customer or architect to understand the cost of a deployment.</p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor160"/>Azure pricing calculator</h2>
			<p>Azure provides a cost calculator for users and customers to estimate their cost and usage. This calculator is available at <a href="https://azure.microsoft.com/pricing/calculator">https://azure.microsoft.com/pricing/calculator</a>:</p>
			<div>
				<div id="_idContainer116" class="IMG---Figure">
					<img src="image/B15432_06_11.jpg" alt="Azure pricing calculator"/>
				</div>
			</div>
			<h6>Figure 6.11: Azure pricing calculator</h6>
			<p>Users can select multiple resources from the left menu, and they will be added to the calculator. In the following example, a virtual machine is added. Further configuration with regard to virtual machine region, operating system, type, tier, instance size, number of hours, and count should be provided to calculate costs:</p>
			<div>
				<div id="_idContainer117" class="IMG---Figure">
					<img src="image/B15432_06_12.jpg" alt="Providing configuration details for calculating resource costs"/>
				</div>
			</div>
			<h6>Figure 6.12: Providing configuration details to calculate resource costs</h6>
			<p>Similarly, the cost for Azure Functions, which relates to virtual machine memory size, execution time, and executions per seconds, is shown in <em class="italics">Figure 6.13</em>:</p>
			<div>
				<div id="_idContainer118" class="IMG---Figure">
					<img src="image/B15432_06_13.jpg" alt="Calculating costs for Azure functions"/>
				</div>
			</div>
			<h6>Figure 6.13: Calculating costs for Azure Functions</h6>
			<p> Azure provides different levels and support plans:</p>
			<ul>
				<li>Default support: free</li>
				<li>Developer support: $29 per month</li>
				<li>Standard support: $300 per month</li>
				<li>Profession direct: $1,000 per month</li>
			</ul>
			<p>To see a complete comparison of the support plans, please refer to <a href="https://azure.microsoft.com/support/plans">https://azure.microsoft.com/support/plans</a>.</p>
			<p>You can select the support that you want depending on your requirements. Finally, the overall estimated cost is displayed:</p>
			<div>
				<div id="_idContainer119" class="IMG---Figure">
					<img src="image/B15432_06_14.jpg" alt="Cost estimation for a selected support plan"/>
				</div>
			</div>
			<h6>Figure 6.14: Cost estimation for selected support plan</h6>
			<p>It is important that architects understand every Azure feature used in their architecture and solution. The success of the Azure calculator depends on the resources that are selected and how they are configured. Any misrepresentation would lead to biased and incorrect estimates and would be different than the actual billing.</p>
			<p>We have reached the last section of this chapter. We have covered the basics of billing, and now it's time to learn the best practices. Following the best practices will help you achieve cost optimization.</p>
			<h2 id="_idParaDest-158"><a id="_idTextAnchor161"/>Best practices</h2>
			<p>Architects need to understand their architecture and the Azure components that are utilized. Based on the active monitoring, audits, and usage, they should determine the best offering from Microsoft in terms of SKU, size, and features. This section will detail some of the best practices to be adopted from a cost optimization perspective.</p>
			<h3 id="_idParaDest-159"><a id="_idTextAnchor162"/>Azure Governance</h3>
			<p>Azure Governance can be defined as a set of processes or mechanisms that can be leveraged to maintain complete control over the resources deployed in Azure. Some of the key points are as follows:</p>
			<ul>
				<li>Set up a naming convention for all resource types and resource groups. Ensure that the naming convention is followed consistently and comprehensively across all resources and resource groups. This can be done by establishing Azure policies. </li>
				<li>Set up a logical organization and multiple taxonomies for resources, resource groups, and subscriptions by applying tags to them. Tags categorize resources and can also help evaluate costs from different perspectives. This can be done by establishing Azure policies, and multiple policies can be combined into initiatives. These initiatives can be applied, which in turn will apply all policies for compliance checks and reporting.</li>
				<li>Use Azure Blueprints instead of ARM templates directly. This will ensure that the deployment of new environments, resources, and resource groups can be standardized according to corporate standards, including naming conventions and the use of tags.</li>
			</ul>
			<h3 id="_idParaDest-160"><a id="_idTextAnchor163"/>Compute best practices</h3>
			<p>Compute refers to services that help in the execution of services. Some of the best compute practices that Azure architects should follow for optimal utilization of resources and cost efficiency are as follows:</p>
			<ul>
				<li>Leverage Azure Advisor to see the available options to save costs on your virtual machines and to find out whether a virtual machine is underutilized. Advisor uses machine learning patterns and artificial intelligence to analyze your usage and provide recommendations. These recommendations play an important role in cost optimization.</li>
				<li>Use Azure <strong class="bold">Reserved Instances</strong> (<strong class="bold">RI</strong>). RIs can get you potential savings on compute costs by paying the cost of the virtual machine upfront or monthly. The term of the RI can be a year or three years. If you buy an RI, that will cut down the compute cost and you will only be seeing the disk, network, and license (if any) charges for a virtual machine. If you have five virtual machines, you can opt for five RIs to suppress the cost of compute completely. RIs automatically look for virtual machines with the matching SKU and attaches to it. Potential savings may vary from 20% to 40% depending on the size of the virtual machine.</li>
				<li>Using <strong class="bold">Azure Hybrid Benefit</strong> (<strong class="bold">AHUB</strong>), you can use your own Windows Server or SQL licenses to reduce the license cost. Combining RIs and AHUB can give you immense savings.</li>
				<li>Choose the best location for your compute services, such as virtual machines. Choose a location where all the Azure features are together in the same region. This will avoid egress traffic.</li>
				<li>Choose the optimal size for virtual machines. A large virtual machine costs more than a small one, and a large virtual machine might not be required at all.</li>
				<li>Resize virtual machines during times of demand and reduce their size when demand subsides. Azure releases new SKUs quite frequently. If a new size suits your needs better, then it must be used.</li>
				<li>Shut down compute services during off-hours or when they are not needed. This is for non-production environments.</li>
				<li>Deallocate virtual machines instead of shutting them down. This will release all their resources, and the meter for their consumption will stop.</li>
				<li>Use dev/test labs for development and testing purposes. They provide policies, auto-shutdown, and auto-start features.</li>
				<li>With virtual machine scale sets, start with a small number of virtual machines and scale out when demand increases.</li>
				<li>Choose the correct size (small, medium, or large) for application gateways. They are backed up by virtual machines and can help reduce costs.</li>
				<li>Choose a Basic tier application gateway if the web application firewall is not needed.</li>
				<li>Choose the correct tiers for VPN gateways (Basic VPN, Standard, High performance, and Ultra performance).</li>
				<li>Reduce network traffic between Azure regions.</li>
				<li>Use a load balancer with a public IP to access multiple virtual machines rather than assigning a public IP to each virtual machine.</li>
				<li>Monitor virtual machines and calculate performance and usage metrics. Based on those calculations, determine whether you want to upscale or downscale your virtual machines. This could result in downsizing and reducing the number of virtual machines.</li>
			</ul>
			<p>Considering these best practices while architecting will inevitably lead to cost savings. Now that we have covered compute, let's take a similar approach to storage.</p>
			<h3 id="_idParaDest-161"><a id="_idTextAnchor164"/>Storage best practices</h3>
			<p>Since we are hosting our applications in the cloud, Azure Storage will be used to store the data related to these applications. If we don't follow the right practices, things may go wrong. Some of the best practices for storage are as follows:</p>
			<ul>
				<li>Choose an appropriate storage redundancy type (GRS, LRS, RA-GRS). GRS is costlier than LRS.</li>
				<li>Archive storage data to the cool or archive access tier. Keep data that is frequently accessed in the hot tier.</li>
				<li>Remove blobs that are not required.</li>
				<li>Delete virtual machine operating system disks explicitly after deleting virtual machines if they are not needed.</li>
				<li>Storage accounts should be metered based on their size, write, read, list, and container operations. </li>
				<li>Prefer standard disks over premium disks; use premium disks only if your business requires it.</li>
				<li>Using CDN and caching for static files instead of fetching them from storage every time.</li>
				<li>Azure offers reserved capacity to save costs on blob data.</li>
			</ul>
			<p>Keeping these best practices handy will help you to architect cost-effective storage solutions. In the next section, we are going to discuss the best practices involved in the deployment of PaaS services.</p>
			<h3 id="_idParaDest-162"><a id="_idTextAnchor165"/>PaaS best practices</h3>
			<p>There are many PaaS services offered by Azure and if they are misconfigured, the chances are that you might end up with unexpected charges in the invoice. To avoid this scenario, you can leverage the following best practices:</p>
			<ul>
				<li>Choose an appropriate Azure SQL tier (Basic, Standard, Premium RS, or Premium) and appropriate performance levels.</li>
				<li>Choose appropriately between a single database and an elastic database. If there are a lot of databases, it is more cost efficient to use elastic databases than single databases.</li>
				<li>Re-architect your solution to use PaaS (serverless or microservices with containers) solutions instead of IaaS solutions. These PaaS solutions take away maintenance costs and are available on a per-minute consumption basis. If you do not consume these services, there is no cost, despite your code and services being available around the clock.</li>
			</ul>
			<p>There are resource-specific cost optimizations, and it is not possible to cover all of them in a single chapter. You are advised to read the documentation related to each feature's cost and usage.</p>
			<h3 id="_idParaDest-163"><a id="_idTextAnchor166"/>General best practices</h3>
			<p>So far, we have looked at service-specific best practices, and we will wind up this section with some general guidelines:</p>
			<ul>
				<li>The cost of resources is different across regions. Try an alternate region, provided it's not creating any performance or latency issues.</li>
				<li>EAs offer better discounts than other offers. You can speak to the Microsoft Account Team and see what benefits you can get if you sign up to an EA.</li>
				<li>If Azure costs can be pre-paid, then you get discounts for all kinds of subscriptions.</li>
				<li>Delete or remove unused resources. Figure out resources that are underutilized and reduce their SKU or size. If they aren't needed, delete them.</li>
				<li>Use Azure Advisor and take its recommendations seriously.</li>
			</ul>
			<p>As mentioned earlier, these are some generic guidelines and as you architect more solutions, you'll be able to create a set of best practices for yourself. But to begin with, you can consider these ones. Nevertheless, each component in Azure has its own best practices, and referring to the documentation while you are architecting will help you to create a cost-effective solution.</p>
			<h2 id="_idParaDest-164"><a id="_idTextAnchor167"/>Summary</h2>
			<p>In this chapter, we learned the importance of cost management and administration when working in a cloud environment. We also covered the various Azure pricing options and various price optimization capabilities that Azure offers. Managing a project's cost is paramount primarily because the monthly expense could be very low but could rise if the resources are not monitored periodically. Cloud architects should design their applications in a cost-effective manner. They should use appropriate Azure resources, appropriate SKUs, tiers, and sizes, and know when to start, stop, scale up, scale out, scale down, scale in, transfer data, and more. Proper cost management will ensure that the actual expense meets the budgetary expenses. </p>
			<p>In the next chapter, we will look at various Azure features related to data services, such as Azure SQL, Cosmos DB, and sharding.</p>
		</div>
	</body></html>