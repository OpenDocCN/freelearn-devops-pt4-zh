- en: 6\. Cost management for Azure solutions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we discussed tags, policies, and locks and how they
    can be leveraged from a compliance standpoint. Tags allow us to add metadata to
    our resources; they also help us in the logical management of resources. In the
    Azure portal, we can filter resources based on tags. If we assume there is a large
    number of resources, which is quite common in enterprises, filtering will help
    us to easily manage our resources. Another benefit of tags is that they can be
    used to filter our billing reports or usage reports in terms of tags. In this
    chapter, we are going to explore cost management for Azure solutions.
  prefs: []
  type: TYPE_NORMAL
- en: The primary reason why corporations are moving to the cloud is to save on cost.
    There is no upfront cost for having an Azure subscription. Azure provides a pay-as-you-go
    subscription, where billing is based on consumption. Azure measures resource usage
    and provides monthly invoices. There is no upper limit for Azure consumption.
    As we are on a public cloud, Azure (like any other service provider) has some
    hard and soft limits on the number of resources that can be deployed. Soft limits
    can be increased by working with Azure Support. There are some resources that
    have a hard limit. The service limits can be found at [https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits),
    and the default limit varies based on the type of subscription you have.
  prefs: []
  type: TYPE_NORMAL
- en: It is important for companies to keep a close watch on Azure consumption and
    usage. Although they can create policies to set organizational standards and conventions,
    there is also a need to keep track of billing and consumption data. Moreover,
    they should employ best practices for consuming Azure resources so that the return
    is maximized. For this, architects need to know about Azure resources and features,
    their corresponding costs, and the cost/benefit analysis of features and solutions.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Azure offer details
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Billing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Invoicing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Usage and quotas
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Usage and Billing APIs
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure pricing calculator
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Best practices for cost optimization
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let's go ahead and discuss each of these points.
  prefs: []
  type: TYPE_NORMAL
- en: Azure offer details
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Azure has different offers that you can purchase. So far, we have discussed
    pay-as-you-go, but there are others, such as **Enterprise Agreements** (**EAs**),
    Azure Sponsorship, and Azure in CSP. We will cover each of these as they are very
    important for billing:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Pay-as-you-go**: This is a commonly known offering, where customers pay based
    on the consumption and the rates are available in the public-facing documentation
    of Azure. Customers receive an invoice every month for usage from Microsoft and
    they can pay via credit card or an invoice payment method.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**EAs**: EAs entail a monetary commitment with Microsoft, which means that
    organizations sign an agreement with Microsoft and promise that they will use
    x amount of Azure resources. If the usage goes above the agreed amount, the customer
    will receive an overage invoice. Customers can create multiple accounts under
    an EA and have multiple subscriptions inside these accounts. There are two types
    of EA: Direct EA and Indirect EA. Direct EA customers have a direct billing relationship
    with Microsoft; on the other hand, with Indirect EA, the billing is managed by
    a partner. EA customers will get better offers and discounts because of the commitment
    they make with Microsoft. The EA is managed via a portal called the EA portal
    ([https://ea.azure.com](https://ea.azure.com)), and you need to have enrolment
    privileges to access this portal.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure in CSP**: Azure in CSP is where a customer reaches out to a **Cloud
    Solution Provider** (**CSP**) partner, and this partner provisions a subscription
    for the customer. The billing will be completely managed by the partner; the customer
    will not have a direct billing relationship with Microsoft. Microsoft invoices
    the partner and the partner invoices the customer, adding their margin.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Sponsorship**: Sponsorship is given by Microsoft to start-ups, NGOs,
    and other non-profit organizations to use Azure. The sponsorship is for a fixed
    term and a fixed amount of credit. If the term expires or credit gets exhausted,
    the subscription will be converted to a pay-as-you-go subscription. If organizations
    want to renew their sponsorship entitlement, they have to work with Microsoft.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We have just outlined a few of Azure's offerings. The complete list is available
    at [https://azure.microsoft.com/support/legal/offer-details](https://azure.microsoft.com/support/legal/offer-details),
    which includes other offerings, such as Azure for Students, Azure Pass, and Dev/Test
    subscriptions.
  prefs: []
  type: TYPE_NORMAL
- en: Next, let's discuss billing in Azure.
  prefs: []
  type: TYPE_NORMAL
- en: Understanding billing
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Azure is a service utility that has the following features:'
  prefs: []
  type: TYPE_NORMAL
- en: No upfront costs
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: No termination fees
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Billing per second, per minute, or per hour depending on the type of resource
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Payment based on consumption-on-the-go
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In such circumstances, it is very difficult to estimate the upfront cost of
    consuming Azure resources. Every resource in Azure has its own cost model and
    charge based on storage, usage, and time span. It is very important for management,
    administration, and finance departments to keep track of usage and costs. Azure
    provides usage and billing reporting capabilities to help upper management and
    administrators generate cost and usage reports based on multiple criteria.
  prefs: []
  type: TYPE_NORMAL
- en: 'The Azure portal provides detailed billing and usage information through the
    **Cost Management + Billing** feature, which can be accessed from the master navigation
    blade, as shown in *Figure 6.1*:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Cost Management + Billing](img/B15432_06_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.1: Cost Management + Billing service in the Azure portal'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Please note that if your billing is managed by a CSP, you will not have access
    to this feature. CSP customers can view their costs in the pay-as-you-go scheme
    if they transition their CSP legacy subscriptions to the Azure plan. We will discuss
    the Azure plan and the Modern Commerce platform later in the chapter.
  prefs: []
  type: TYPE_NORMAL
- en: '**Cost Management + Billing** shows all the subscriptions and the billing scopes
    you have access to, as shown in *Figure 6.2*:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Billing details of all listed user subscriptions](img/B15432_06_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.2: Billing overview of user subscriptions'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'The **Cost Management** section has several blades, such as:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Cost analysis** for analyzing the usage of a scope.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Budgets** for settings budgets.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Cost alerts** for notifying administrators when the usage exceeds a certain
    threshold.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Advisor recommendations** for getting advice on how to make potential savings.
    We will discuss Azure Advisor in the last section of this chapter.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Exports** for automating usage exports to Azure Storage.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Cloudyn**, which is a tool used by CSP partners to analyze costs, as they
    don''t have access to Cost Management.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Connectors for AWS** for connecting your AWS consumption data to Azure Cost
    Management.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The different options available in Azure Cost Management are shown in *Figure
    6.3*:'
  prefs: []
  type: TYPE_NORMAL
- en: '![List of services in the Azure Cost Management section in the Azure portal](img/B15432_06_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.3: Cost Management overview'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Clicking on the **Cost analysis** menu on this blade provides a comprehensive
    interactive dashboard, using which cost can be analyzed with different dimensions
    and measures:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Analysing subscription costs through the Cost Analysis option](img/B15432_06_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.4: Analyzing subscription costs through the Cost analysis option'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: The dashboard not only shows the current cost but also forecasts the cost and
    breaks it down based on multiple dimensions. **Service name**, **Location**, and
    **Resource group name** are provided by default, but they can be changed to other
    dimensions as well. There will be always a scope associated with every view. Some
    of the available scopes are billing account, management group, subscription, and
    resource group. You can switch the scope depending on the level you want to analyze.
  prefs: []
  type: TYPE_NORMAL
- en: 'The **Budget** menu on the left allows us to set up the budget for better cost
    management and provides alerting features in case the actual cost is going to
    breach the budget estimates:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a budget alert for cost management](img/B15432_06_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.5: Creating a budget'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Cost Management also allows us to fetch cost data from other clouds, such as
    AWS, within the current dashboards, thereby managing costs for multiple clouds
    from a single blade and dashboard. However, this feature is in preview at the
    time of writing. This connector will become chargeable after August 25, 2020.
  prefs: []
  type: TYPE_NORMAL
- en: 'You need to fill in your AWS role details and other details to pull the cost
    information, as shown in *Figure 6.5*. If you are unsure how to create the policy
    and role in AWS, refer to [https://docs.microsoft.com/azure/cost-management-billing/costs/aws-integration-set-up-configure#create-a-role-and-policy-in-aws](https://docs.microsoft.com/azure/cost-management-billing/costs/aws-integration-set-up-configure#create-a-role-and-policy-in-aws):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a connector to bring AWS cost and usage report data into Azure Cost
    Management](img/B15432_06_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.6: Creating an AWS connector in Cost Management'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: The cost reports can also be exported to a storage account on a scheduled basis.
  prefs: []
  type: TYPE_NORMAL
- en: Some of the cost analysis is also available in the **Subscriptions** blade.
    In the **Overview** section, you can see resources and their cost. Also, there
    is another graph, where you can see your current spend, forecast, and balance
    credit (if you are using a credit-based subscription).
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 6.7* shows cost information:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Overview of costs by resource for the subscription](img/B15432_06_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.7: Cost analysis for the subscription'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Clicking on any of the costs in *Figure 6.7* will redirect you to the **Cost
    Management** – **Cost Analysis** section. There are a lot of dimensions in Cost
    Management with which you can group the data for analysis. The available dimensions
    will vary based on the scope you have selected. Some of the commonly used dimensions
    are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Resource types
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Resource group
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tag
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Resource location
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Resource ID
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Meter category
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Meter subcategory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Service
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: At the beginning of the chapter, we said that tags can be used for cost management.
    For example, let's say you have a tag called Department with values of IT, HR,
    and Finance. Tagging the resources appropriately will help you understand the
    cost incurred by each department. You can also download the cost report as a CSV,
    Excel, or PNG file using the **Download** button.
  prefs: []
  type: TYPE_NORMAL
- en: Additionally, Cost Management supports multiple views. You can create your own
    dashboard and save it. EA customers get the added benefit of the Cost Management
    connector or Power BI. With the connector, users can pull the usage statistics
    to Power BI and create visualizations.
  prefs: []
  type: TYPE_NORMAL
- en: Up to this point, we have been discussing how we can keep track of our usage
    using Cost Management. In the next section, we will explore how invoicing works
    for the services we have used.
  prefs: []
  type: TYPE_NORMAL
- en: Invoicing
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Azure's billing system also provides information about invoices that are generated
    monthly.
  prefs: []
  type: TYPE_NORMAL
- en: Depending on the offer type, the method of invoicing may vary. For pay-as-you-go
    users, the invoices will be sent monthly to the account administrator. However,
    for EA customers, the invoice will be sent to the contact on the enrollment.
  prefs: []
  type: TYPE_NORMAL
- en: 'Clicking on the **Invoices** menu brings up a list of all the invoices generated,
    and clicking on any of the invoices provides details about that invoice. *Figure
    6.8* shows how the invoices are shown in the Azure portal:'
  prefs: []
  type: TYPE_NORMAL
- en: '![A list of billed invoices and their details](img/B15432_06_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.8: List of invoices and their details'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'There are two types of invoices: one is for Azure services such as SQL, Virtual
    Machines, and Networking. Another type is for Azure Marketplace and Reservations.
    Azure Marketplace provides partner services from different vendors for customers.
    We will be talking about Azure Reservations later on.'
  prefs: []
  type: TYPE_NORMAL
- en: By default, for a pay-as-you-go subscription, the account admin has access to
    the invoices. If they want, they can delegate access to other users, such as the
    organization's finance team, by choosing the **Access invoice** option in *Figure
    6.8*. Additionally, the account admin can opt for email addresses where they want
    to send out the copies of the invoices.
  prefs: []
  type: TYPE_NORMAL
- en: The **Email Invoice** option is not available for Support Plan now. Alternatively,
    you can visit the Accounts portal and download the invoice. Microsoft is slowly
    moving away from this portal, and most of the features are getting deprecated
    as they are integrated into the Azure portal.
  prefs: []
  type: TYPE_NORMAL
- en: So far, we have discussed subscriptions and how invoicing is done. Something
    new that has been introduced by Microsoft is Modern Commerce. With this new commerce
    experience, the purchase process and experience has been simplified. Let's take
    a closer look at Modern Commerce and learn how it is different from the legacy
    platform that we have discussed so far.
  prefs: []
  type: TYPE_NORMAL
- en: The Modern Commerce experience
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If your organization is already working with Microsoft, you will know that there
    are multiple agreements involved for each offer, such as Web Direct, EAs, CSP,
    **Microsoft Service and Product Agreement** (**MSPA**), **Server Cloud Enrollments**
    (**SCE**), and so on. Along with this, each of them has its own portal; for example,
    EAs have the EA portal, CSP has the Partner Center portal, and Volume Licensing
    has its own portal too.
  prefs: []
  type: TYPE_NORMAL
- en: Each offer comes with a different set of terms and conditions, and the customers
    need to go through them every time they make a purchase. The transition from one
    offer to another is not very easy as each offer has a different set of terms and
    conditions. Let's imagine that you already have an EA subscription and would like
    to convert it to a CSP subscription; you may have to delete some of the partner
    services as they are not supported in CSP. For each product, each offer will have
    different rules. From a customer standpoint, it's very hard to understand what
    supports what and how rules differ.
  prefs: []
  type: TYPE_NORMAL
- en: Addressing this issue, Microsoft has recently issued a new agreement called
    **Microsoft Customer Agreement** (**MCA**). This will act as the basic terms and
    conditions. You can make amendments to it whenever required when you sign up for
    a new program.
  prefs: []
  type: TYPE_NORMAL
- en: 'For Azure, there will be three **Go-To-Market** (**GTM**) programs:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Field Led**: Customers will interact directly with the Microsoft Accounts
    Team and the billing will be directly managed by Microsoft. Eventually, this will
    replace EAs.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Partner Led**: This is equivalent to the Azure-in-CSP program, where a partner
    manages your billing. There are different partners across the world. A quick web
    search will help you find the partners around you. This program will replace the
    Azure-in-CSP program. As the first step to Modern Commerce, a partner will sign
    a **Microsoft Partner Agreement** (**MPA**) with Microsoft and transition their
    existing customers by making them sign the MCA. At the time of writing this book,
    many partners have transitioned their customers to Modern Commerce, and the new
    commerce experience is available in 139 countries.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Self Service**: This will be a replacement for Web Direct. It doesn''t require
    any involvement from the partner or the Microsoft Accounts Team. Customers can
    directly purchase from [microsoft.com](http://microsoft.com) and they will sign
    the MCA during the purchase.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In Azure, the billing will be done on the Azure Plan, and the billing will be
    always aligned with the calendar month. Buying an Azure Plan is very similar to
    buying any other subscription. The difference is that the MCA will be signed during
    the process.
  prefs: []
  type: TYPE_NORMAL
- en: Azure Plan can host multiple subscriptions, and it will act as a root-level
    container. All the usage is tied back to a single Azure Plan. All the subscriptions
    inside the Azure Plan will act as containers to host services, such as Virtual
    Machines, SQL Database, and Networking.
  prefs: []
  type: TYPE_NORMAL
- en: 'Some of the changes and advancements we could observe after the introduction
    of Modern Commerce are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Eventually, the portals will be deprecated. For example, earlier EA customers
    were only able to download the enrollment usage information from the EA portal.
    Now Microsoft has integrated it into Azure Cost Management with a richer experience
    than the EA portal.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Pricing will be done in USD and billed in the local currency. If your currency
    is not USD, then the **foreign exchange** (**FX**) rate will be applied and is
    available in your invoice. Microsoft uses FX rates from Thomson Reuters, and these
    rates will be assigned on the first of every month. This value will be consistent
    throughout the month, irrespective of what the market rate is.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: CSP customers who transition to the new Azure Plan will be able to use Cost
    Management. Access to Cost Management opens a new world of cost tracking, as it
    provides access to all native Cost Management features.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All the subscriptions that we have discussed so far will eventually be moved
    to an Azure Plan, which is the future of Azure. Now that you understand the basics
    of Modern Commerce, let's discuss another topic that has a very important role
    when we are architecting solutions. Most services have limits by default; some
    of these limits can be increased while some are hard limits. When we are architecting
    a solution, we need to make sure that there is ample quota. Capacity planning
    is a vital part of architectural design. In the next section, you will learn more
    about limits on subscriptions.
  prefs: []
  type: TYPE_NORMAL
- en: Usage and quotas
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As mentioned in the previous section, capacity planning needs to be one of the
    first steps when we architect a solution. We need to verify whether the subscription
    has enough quota to accommodate the new resources we are architecting. If not,
    during the deployment, we may face issues.
  prefs: []
  type: TYPE_NORMAL
- en: Each subscription has a limited quota for each resource type. For example, there
    could be a maximum of 10 public IP addresses provisioned with an MSDN Microsoft
    account. Similarly, all resources have a maximum default limit for each resource
    type. These resource type numbers for a subscription can be increased by contacting
    Azure Support or clicking on the **Request Increase** button in the **Usage**
    **+** **Quota** blade on the **Subscription** page.
  prefs: []
  type: TYPE_NORMAL
- en: 'Considering the number of resources in each region, it''ll be a challenge to
    go through the list. The portal provides options to filter the dataset and look
    for what we want. In *Figure 6.9*, you can see that if we filter the location
    to **Central US** and set the resource provider to **Microsoft.Storage**, we can
    confirm which quotas are available for storage accounts:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Checking usage and quota for a given location and resource provider](img/B15432_06_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.9: Usage and quota for a given location and resource provider'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: You can clearly see in *Figure 6.9* that we haven't created any storage accounts
    in Central US, and that leaves us with a quota of 250 accounts. If the solution
    we are architecting requires more than 250 accounts, we need to click on **Request
    Increase**, which would contact Azure Support.
  prefs: []
  type: TYPE_NORMAL
- en: This blade gives us the freedom to perform capacity planning prior to deployment.
  prefs: []
  type: TYPE_NORMAL
- en: When filtering the report, we used the term **resource provider** and selected
    **Microsoft.Storage**. In the next section, will take a closer look at what this
    term means.
  prefs: []
  type: TYPE_NORMAL
- en: Resource providers and resource types
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Whether you are interacting with the Azure portal, filtering services, or filtering
    the billing usage report, you might need to work with resource providers and resource
    types. For example, when you are creating a virtual machine, you are interacting
    with the `Microsoft.Compute` resource provider and the `virtualMachines` resource
    type. The `{resource-provider}/{resource-type}`. So, the resource type for the
    virtual machine is `Microsoft.Compute/virtualMachines`. In short, resource providers
    help to create resource types.
  prefs: []
  type: TYPE_NORMAL
- en: Resource providers need to be registered with an Azure subscription. Resource
    types will not be available in a subscription if resource providers are not registered.
    By default, most providers are automatically registered; having said that, there
    will be scenarios where we must manually register.
  prefs: []
  type: TYPE_NORMAL
- en: 'To get a list of providers that are available, the ones that are registered
    and the ones that are not registered, and to register non-registered providers
    or vice versa, the dashboard shown in *Figure 6.10* can be used. For this operation,
    you need to have the necessary roles assigned—Owner or Contributor roles will
    suffice. *Figure 6.10* shows what the dashboard looks like:'
  prefs: []
  type: TYPE_NORMAL
- en: '![List of registered and non-registered resource providers](img/B15432_06_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.10: List of registered and non-registered resource providers'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: In the previous section, we discussed how to download invoices and usage information.
    If you need to download the data programmatically and save it, then you can use
    APIs. The next section is all about Azure Billing APIs.
  prefs: []
  type: TYPE_NORMAL
- en: Usage and Billing APIs
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Although the portal is a great way to find usage, billing, and invoice information
    manually, Azure also provides the following APIs to programmatically retrieve
    details and create customized dashboards and reports. The APIs vary depending
    on the kind of subscription you are using. As there are many APIs, we will be
    sharing the Microsoft documentation with each API so that you can explore them
    all.
  prefs: []
  type: TYPE_NORMAL
- en: Azure Enterprise Billing APIs
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'EA customers have a dedicated set of APIs available for them to work with billing
    data. The following APIs use the API key from the EA portal for authentication;
    tokens from Azure Active Directory will not work with them:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Balance and Summary API**: As we discussed earlier, EA works with a monetary
    commitment, and it is very important to track the balance, overage, credit adjustments,
    and Azure Marketplace charges. Using this API, customers can pull the balance
    and summary for a billing period.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Usage Details API**: The Usage Details API will help you to get daily usage
    information about the enrollment with granularity down to the instance level.
    The response of this API will be like the usage report that can be downloaded
    from the EA portal.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Marketplace Store Charge API**: This is a dedicated API for extracting the
    charges for Marketplace purchases.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Price Sheet API**: Each enrollment will have a special price sheet, and discounts
    vary from customers to customers. The Price Sheet API can pull the price list.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Reserved Instance Details API**: We haven''t discussed Azure Reservations
    so far, but it will be discussed by the end of this chapter. Using this API, you
    can get usage information about the reservations and a list of the reservations
    in the enrollment.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Here is the link to the documentation for the EA APIs: [https://docs.microsoft.com/azure/cost-management-billing/manage/enterprise-api](https://docs.microsoft.com/azure/cost-management-billing/manage/enterprise-api).'
  prefs: []
  type: TYPE_NORMAL
- en: Let's take a look at the Azure Consumption APIs now.
  prefs: []
  type: TYPE_NORMAL
- en: Azure Consumption APIs
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Azure Consumption APIs can be used with EA as well as Web Direct (with some
    exceptions) subscriptions. This requires a token, which needs to be generated
    by authenticating against Azure Active Directory. Since these APIs also support
    EA, don''t confuse this token with the EA API key that we mentioned in the previous
    section. Here are the key APIs that are self-explanatory:'
  prefs: []
  type: TYPE_NORMAL
- en: Usage Details API
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Marketplace Charges API
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reservation Recommendations API
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reservation Details and Summary API
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'EA customers have additional support for the following APIs:'
  prefs: []
  type: TYPE_NORMAL
- en: Price sheet
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Budgets
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Balances
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Documentation is available here: [https://docs.microsoft.com/azure/cost-management-billing/manage/consumption-api-overview](https://docs.microsoft.com/azure/cost-management-billing/manage/consumption-api-overview).'
  prefs: []
  type: TYPE_NORMAL
- en: 'Additionally, there is another set of APIs that can be only used by Web Direct
    customers:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Azure Resource Usage API**: This API can be used with an EA or pay-as-you-go
    subscription to download the usage data.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Resource RateCard API**: This is only applicable to Web Direct; EAs
    are not supported. Web Direct customers can use this to download price sheets.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Invoice Download API**: This is only applicable to Web Direct customers.
    It''s used to download invoices programmatically.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The names may look familiar, and the difference is only the endpoint that we
    are calling. For Azure Enterprise Billing APIs, the URL will start with `https://consumption.azure.com`,
    and for Azure Consumption APIs, the URL starts with `https://management.azure.com`.
    This is how you can differentiate them. In the next section, you will be seeing
    a new set of APIs that are specifically used by Cost Management.
  prefs: []
  type: TYPE_NORMAL
- en: Azure Cost Management APIs
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'With the introduction of Azure Cost Management, a new set of APIs are available
    for the customer to use. These APIs are the backbone of Cost Management, which
    we used in the Azure portal earlier. The key APIs are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Query Usage API**: This is the same API used by Cost Analysis in the Azure
    portal. We can customize the response with what we need using a payload. It''s
    very useful when we want a customized report. The date range cannot exceed 365
    days.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Budgets API**: Budgets is another feature of Azure Cost Management, and this
    API lets us interact with the budgets programmatically.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Forecast API**: This can be used to get a forecast of a scope. The Forecast
    API is only available for EA customers now.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Dimensions API**: Earlier, when we were discussing Cost Management, we said
    that Cost Management supports multiple dimensions based on the scope. If you would
    like to get the list of dimensions supported based on a specific scope, you can
    use this API.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Exports API**: Another feature of Cost Management is that we can automate
    the report export to a storage account. The Exports API can be used to interact
    with the export configuration, such as the name of the storage account, customization,
    frequency, and so on.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Check out the official documentation at [https://docs.microsoft.com/rest/api/cost-management](https://docs.microsoft.com/rest/api/cost-management).
  prefs: []
  type: TYPE_NORMAL
- en: 'Since Modern Commerce is expanding MCA, there''s a whole new set of APIs that
    can be explored here: [https://docs.microsoft.com/rest/api/billing](https://docs.microsoft.com/rest/api/billing).'
  prefs: []
  type: TYPE_NORMAL
- en: You may have noticed that we haven't mentioned CSP in any of these scenarios.
    In CSP, the customer doesn't have access to the billing as it's managed by a partner,
    hence the APIs are not exposed. However, a transition to an Azure Plan would let
    the CSP customer use the Azure Cost Management APIs to see the retail rates.
  prefs: []
  type: TYPE_NORMAL
- en: Any programming or scripting language can be used to use these APIs and mix
    them together to create complete comprehensive billing solutions. In the next
    section, we will be focusing on the Azure pricing calculator, which will help
    the customer or architect to understand the cost of a deployment.
  prefs: []
  type: TYPE_NORMAL
- en: Azure pricing calculator
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Azure provides a cost calculator for users and customers to estimate their
    cost and usage. This calculator is available at [https://azure.microsoft.com/pricing/calculator](https://azure.microsoft.com/pricing/calculator):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Azure pricing calculator](img/B15432_06_11.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.11: Azure pricing calculator'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Users can select multiple resources from the left menu, and they will be added
    to the calculator. In the following example, a virtual machine is added. Further
    configuration with regard to virtual machine region, operating system, type, tier,
    instance size, number of hours, and count should be provided to calculate costs:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Providing configuration details for calculating resource costs](img/B15432_06_12.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.12: Providing configuration details to calculate resource costs'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Similarly, the cost for Azure Functions, which relates to virtual machine memory
    size, execution time, and executions per seconds, is shown in *Figure 6.13*:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Calculating costs for Azure functions](img/B15432_06_13.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.13: Calculating costs for Azure Functions'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Azure provides different levels and support plans:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Default support: free'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Developer support: $29 per month'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Standard support: $300 per month'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Profession direct: $1,000 per month'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To see a complete comparison of the support plans, please refer to [https://azure.microsoft.com/support/plans](https://azure.microsoft.com/support/plans).
  prefs: []
  type: TYPE_NORMAL
- en: 'You can select the support that you want depending on your requirements. Finally,
    the overall estimated cost is displayed:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Cost estimation for a selected support plan](img/B15432_06_14.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 6.14: Cost estimation for selected support plan'
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: It is important that architects understand every Azure feature used in their
    architecture and solution. The success of the Azure calculator depends on the
    resources that are selected and how they are configured. Any misrepresentation
    would lead to biased and incorrect estimates and would be different than the actual
    billing.
  prefs: []
  type: TYPE_NORMAL
- en: We have reached the last section of this chapter. We have covered the basics
    of billing, and now it's time to learn the best practices. Following the best
    practices will help you achieve cost optimization.
  prefs: []
  type: TYPE_NORMAL
- en: Best practices
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Architects need to understand their architecture and the Azure components that
    are utilized. Based on the active monitoring, audits, and usage, they should determine
    the best offering from Microsoft in terms of SKU, size, and features. This section
    will detail some of the best practices to be adopted from a cost optimization
    perspective.
  prefs: []
  type: TYPE_NORMAL
- en: Azure Governance
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Azure Governance can be defined as a set of processes or mechanisms that can
    be leveraged to maintain complete control over the resources deployed in Azure.
    Some of the key points are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Set up a naming convention for all resource types and resource groups. Ensure
    that the naming convention is followed consistently and comprehensively across
    all resources and resource groups. This can be done by establishing Azure policies.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set up a logical organization and multiple taxonomies for resources, resource
    groups, and subscriptions by applying tags to them. Tags categorize resources
    and can also help evaluate costs from different perspectives. This can be done
    by establishing Azure policies, and multiple policies can be combined into initiatives.
    These initiatives can be applied, which in turn will apply all policies for compliance
    checks and reporting.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use Azure Blueprints instead of ARM templates directly. This will ensure that
    the deployment of new environments, resources, and resource groups can be standardized
    according to corporate standards, including naming conventions and the use of
    tags.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Compute best practices
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Compute refers to services that help in the execution of services. Some of
    the best compute practices that Azure architects should follow for optimal utilization
    of resources and cost efficiency are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Leverage Azure Advisor to see the available options to save costs on your virtual
    machines and to find out whether a virtual machine is underutilized. Advisor uses
    machine learning patterns and artificial intelligence to analyze your usage and
    provide recommendations. These recommendations play an important role in cost
    optimization.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use Azure **Reserved Instances** (**RI**). RIs can get you potential savings
    on compute costs by paying the cost of the virtual machine upfront or monthly.
    The term of the RI can be a year or three years. If you buy an RI, that will cut
    down the compute cost and you will only be seeing the disk, network, and license
    (if any) charges for a virtual machine. If you have five virtual machines, you
    can opt for five RIs to suppress the cost of compute completely. RIs automatically
    look for virtual machines with the matching SKU and attaches to it. Potential
    savings may vary from 20% to 40% depending on the size of the virtual machine.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using **Azure Hybrid Benefit** (**AHUB**), you can use your own Windows Server
    or SQL licenses to reduce the license cost. Combining RIs and AHUB can give you
    immense savings.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose the best location for your compute services, such as virtual machines.
    Choose a location where all the Azure features are together in the same region.
    This will avoid egress traffic.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose the optimal size for virtual machines. A large virtual machine costs
    more than a small one, and a large virtual machine might not be required at all.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Resize virtual machines during times of demand and reduce their size when demand
    subsides. Azure releases new SKUs quite frequently. If a new size suits your needs
    better, then it must be used.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Shut down compute services during off-hours or when they are not needed. This
    is for non-production environments.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Deallocate virtual machines instead of shutting them down. This will release
    all their resources, and the meter for their consumption will stop.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use dev/test labs for development and testing purposes. They provide policies,
    auto-shutdown, and auto-start features.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: With virtual machine scale sets, start with a small number of virtual machines
    and scale out when demand increases.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose the correct size (small, medium, or large) for application gateways.
    They are backed up by virtual machines and can help reduce costs.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose a Basic tier application gateway if the web application firewall is not
    needed.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose the correct tiers for VPN gateways (Basic VPN, Standard, High performance,
    and Ultra performance).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reduce network traffic between Azure regions.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use a load balancer with a public IP to access multiple virtual machines rather
    than assigning a public IP to each virtual machine.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Monitor virtual machines and calculate performance and usage metrics. Based
    on those calculations, determine whether you want to upscale or downscale your
    virtual machines. This could result in downsizing and reducing the number of virtual
    machines.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Considering these best practices while architecting will inevitably lead to
    cost savings. Now that we have covered compute, let's take a similar approach
    to storage.
  prefs: []
  type: TYPE_NORMAL
- en: Storage best practices
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Since we are hosting our applications in the cloud, Azure Storage will be used
    to store the data related to these applications. If we don''t follow the right
    practices, things may go wrong. Some of the best practices for storage are as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Choose an appropriate storage redundancy type (GRS, LRS, RA-GRS). GRS is costlier
    than LRS.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Archive storage data to the cool or archive access tier. Keep data that is frequently
    accessed in the hot tier.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Remove blobs that are not required.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Delete virtual machine operating system disks explicitly after deleting virtual
    machines if they are not needed.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Storage accounts should be metered based on their size, write, read, list, and
    container operations.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Prefer standard disks over premium disks; use premium disks only if your business
    requires it.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using CDN and caching for static files instead of fetching them from storage
    every time.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure offers reserved capacity to save costs on blob data.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Keeping these best practices handy will help you to architect cost-effective
    storage solutions. In the next section, we are going to discuss the best practices
    involved in the deployment of PaaS services.
  prefs: []
  type: TYPE_NORMAL
- en: PaaS best practices
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'There are many PaaS services offered by Azure and if they are misconfigured,
    the chances are that you might end up with unexpected charges in the invoice.
    To avoid this scenario, you can leverage the following best practices:'
  prefs: []
  type: TYPE_NORMAL
- en: Choose an appropriate Azure SQL tier (Basic, Standard, Premium RS, or Premium)
    and appropriate performance levels.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Choose appropriately between a single database and an elastic database. If there
    are a lot of databases, it is more cost efficient to use elastic databases than
    single databases.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Re-architect your solution to use PaaS (serverless or microservices with containers)
    solutions instead of IaaS solutions. These PaaS solutions take away maintenance
    costs and are available on a per-minute consumption basis. If you do not consume
    these services, there is no cost, despite your code and services being available
    around the clock.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: There are resource-specific cost optimizations, and it is not possible to cover
    all of them in a single chapter. You are advised to read the documentation related
    to each feature's cost and usage.
  prefs: []
  type: TYPE_NORMAL
- en: General best practices
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'So far, we have looked at service-specific best practices, and we will wind
    up this section with some general guidelines:'
  prefs: []
  type: TYPE_NORMAL
- en: The cost of resources is different across regions. Try an alternate region,
    provided it's not creating any performance or latency issues.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: EAs offer better discounts than other offers. You can speak to the Microsoft
    Account Team and see what benefits you can get if you sign up to an EA.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If Azure costs can be pre-paid, then you get discounts for all kinds of subscriptions.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Delete or remove unused resources. Figure out resources that are underutilized
    and reduce their SKU or size. If they aren't needed, delete them.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use Azure Advisor and take its recommendations seriously.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: As mentioned earlier, these are some generic guidelines and as you architect
    more solutions, you'll be able to create a set of best practices for yourself.
    But to begin with, you can consider these ones. Nevertheless, each component in
    Azure has its own best practices, and referring to the documentation while you
    are architecting will help you to create a cost-effective solution.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this chapter, we learned the importance of cost management and administration
    when working in a cloud environment. We also covered the various Azure pricing
    options and various price optimization capabilities that Azure offers. Managing
    a project's cost is paramount primarily because the monthly expense could be very
    low but could rise if the resources are not monitored periodically. Cloud architects
    should design their applications in a cost-effective manner. They should use appropriate
    Azure resources, appropriate SKUs, tiers, and sizes, and know when to start, stop,
    scale up, scale out, scale down, scale in, transfer data, and more. Proper cost
    management will ensure that the actual expense meets the budgetary expenses.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will look at various Azure features related to data
    services, such as Azure SQL, Cosmos DB, and sharding.
  prefs: []
  type: TYPE_NORMAL
