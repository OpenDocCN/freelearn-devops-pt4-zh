- en: 'Chapter 4:'
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
  zh: 第 4 章：
- en: Understanding Azure DevOps Pipelines
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 了解 Azure DevOps Pipelines
- en: When adopting **Azure DevOps** in your organization, one of the main important
    decisions you must make is how to define the **pipeline** of your development
    process. A pipeline is a company-defined model that describes the steps and actions
    that a code base must support, from building to the final release phase. It's
    a key part of any DevOps architecture.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在组织中采用 **Azure DevOps** 时，您必须做出的一个主要决策是如何定义您的开发过程的 **流水线**。流水线是一个公司定义的模型，描述了从构建到最终发布阶段代码库必须支持的步骤和操作。它是任何
    DevOps 架构的关键部分。
- en: In this chapter, we'll learn how to define and use pipelines with Azure DevOps
    for building code.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将学习如何定义和使用 Azure DevOps 管道来构建代码。
- en: 'We will cover the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将涵盖以下主题：
- en: Implementing a CI/CD process
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实现 CI/CD 流程
- en: An overview of Azure Pipelines
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure Pipelines 概述
- en: Creating and using build agents
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建和使用构建代理
- en: Overview of the YAML format
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: YAML 格式概述
- en: Creating a CI/CD pipeline with Azure DevOps
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Azure DevOps 中创建 CI/CD 流水线
- en: Retention of builds
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建的保持
- en: Multi-stage pipeline
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 多阶段管道
- en: Build pipeline with GitHub repositories
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 GitHub 仓库构建管道
- en: Using container jobs in Azure Pipelines
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Azure Pipelines 中使用容器作业
- en: Let's get started!
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 开始吧！
- en: Technical requirements
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'To follow this chapter, you need to have the following:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 要跟随本章，您需要具备以下内容：
- en: A valid organization in Azure DevOps
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure DevOps 中的有效组织
- en: An Azure subscription where you can create an Azure VM or a local machine on
    one of these environments so that you can install the build agent software
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个 Azure 订阅，您可以在这些环境中的一个上创建 Azure 虚拟机或本地机器，以便安装构建代理软件
- en: Visual Studio or Visual Studio Code as your development environment
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Visual Studio 或 Visual Studio Code 作为您的开发环境
- en: 'Access to the following GitHub repository for cloning the project: [https://github.com/Microsoft/PartsUnlimited](https://github.com/Microsoft/PartsUnlimited)'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 访问以下 GitHub 仓库以克隆项目：[https://github.com/Microsoft/PartsUnlimited](https://github.com/Microsoft/PartsUnlimited)
- en: Implementing a CI/CD process
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 实现 CI/CD 流程
- en: When adopting DevOps in a company, implementing the right DevOps tools with
    the right DevOps processes is essential and crucial. One of the fundamental flows
    in a DevOps implementation is the **continuous integration** (**CI**) and **continuous
    delivery** (**CD**) process, which can help developers build, test, and distribute
    a code base in a quicker, structured, and safer way.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在公司采用 DevOps 时，实现正确的 DevOps 工具和 DevOps 流程至关重要。DevOps 实现中的一个基本流程是 **持续集成**（**CI**）和
    **持续交付**（**CD**）过程，它可以帮助开发人员以更快速、结构化和安全的方式构建、测试和分发代码库。
- en: '**CI** is a software engineering practice where developers in a team integrate
    code modifications in a central repository a few times in a day. When a code modification
    integrated into a particular branch (normally with a pull request, as explained
    in the previous chapter), a new build is triggered in order to check the code
    and detect integration bugs quickly. Also, automatic tests (if available) are
    executed during this phase to check for breakages.'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '**CI** 是一种软件工程实践，开发团队中的开发人员每天会多次将代码修改集成到中央代码库中。当代码修改被集成到特定分支时（通常通过拉取请求，正如前一章所述），会触发一个新的构建，以便快速检查代码并发现集成错误。此外，在此阶段还会执行自动化测试（如果可用），以检查是否存在故障。'
- en: '**CD** is the process that comes after the CI process. In this process, the
    output of the CI phase is packaged and delivered to the production stage without
    bugs. This is extremely helpful so that we always have a master branch that is
    tested, consistent, and ready to be deployed.'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '**CD** 是在 CI 过程之后的一个过程。在此过程中，CI 阶段的输出被打包并交付到生产阶段，无错误。这对于确保我们始终拥有经过测试、一致且准备好部署的主分支非常有帮助。'
- en: In DevOps, you can also have a **continuous deployment** process in place, where
    you can automate the deployment of your code modifications to the final production
    environments without manual intervention.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在 DevOps 中，您还可以实现 **持续部署** 过程，在此过程中，您可以自动将代码修改部署到最终的生产环境中，而无需手动干预。
- en: 'The typical DevOps CI/CD loop is represented in the following famous "loop"
    diagram:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 典型的 DevOps CI/CD 循环在以下著名的“循环”图中表示：
- en: '![Figure 4.1 – DevOps CI/CD loop'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.1 – DevOps CI/CD 循环'
- en: '](img/B16392_04_001.jpg)'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_001.jpg)'
- en: Figure 4.1 – DevOps CI/CD loop
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.1 – DevOps CI/CD 循环
- en: 'A typical CI/CD pipeline implementation contains the following stages:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 一个典型的 CI/CD 流水线实现包含以下阶段：
- en: '**Commit stage**: Here, new code modifications are integrated into the code
    base and a set of unit tests are performed in order to check code integrity and
    quality.'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**提交阶段**：在此阶段，新代码修改会被集成到代码库中，并执行一系列单元测试，以检查代码的完整性和质量。'
- en: '**Build stage**: Here, the code is automatically built and then the final results
    of the build process (artifacts) are pushed to the final registry.'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**构建阶段**：在此阶段，代码会自动构建，然后将构建过程的最终结果（构建产物）推送到最终的注册表。'
- en: '**Test stage**: The build code will be deployed to preproduction, where the
    final testing will be performed and then go to production deployment. Here, the
    code is tested by adopting alpha and beta deployments. The alpha deployment stage
    is where developers check the performance of their new builds and the interactions
    between builds. In the Beta deployment stage, developers execute manual testing
    in order to double-check whether the application is working correctly.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**测试阶段**：构建的代码将部署到预生产环境，在那里执行最终的测试，然后进入生产部署阶段。在这里，代码通过采用 Alpha 和 Beta 部署进行测试。Alpha
    部署阶段是开发人员检查新构建的性能和构建之间的交互的地方。在 Beta 部署阶段，开发人员执行手动测试，以再次检查应用程序是否正常工作。'
- en: '**Production deployment stage**: This is where the final application, after
    successfully passing all the testing requirements, goes live to the production
    stage.'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**生产部署阶段**：这是最终应用程序在成功通过所有测试要求后，推送到生产阶段的地方。'
- en: 'There are lots of benefits of implementing a CI/CD process in your organizations.
    The main benefits are as follows:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在您的组织中实现 CI/CD 流程有很多好处。主要好处如下：
- en: '**Improved code quality and early bug detection**: By adopting automated tests,
    you can discover bugs and issues at an early stage and fix them accordingly.'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**提高代码质量和早期发现漏洞**：通过采用自动化测试，您可以在早期发现漏洞和问题，并进行修复。'
- en: '**Complete traceability**: The whole build, test, and deployment process is
    tracked and can be analyzed later. This guarantees that you can inspect which
    changes in a particular build are included and the impact that they can have on
    the final tests or release.'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**完整的可追溯性**：整个构建、测试和部署过程都被跟踪，并且可以稍后进行分析。这确保您可以检查特定构建中的哪些更改被包含，并了解这些更改对最终测试或发布的影响。'
- en: '**Faster testing and release phases**: Automating building and testing of your
    code base on every new commit (or before a release).'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**更快的测试和发布阶段**：自动化每次新提交（或发布前）的代码库构建和测试。'
- en: 'In the next section, we''ll provide an overview of the service offered by the
    Azure platform for implementing CI/CD: Azure Pipelines.'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将概述 Azure 平台提供的用于实现 CI/CD 的服务：Azure Pipelines。
- en: Overview of Azure Pipelines
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Azure Pipelines 概述
- en: '**Azure Pipelines** is a cloud service offered by the Azure platform that allows
    you to automate the building, testing, and releasing phases of your development
    life cycle (CI/CD). Azure Pipelines works with any language or platform, it''s
    integrated in Azure DevOps, and you can build your code on Windows, Linux, or
    macOS machines.'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: '**Azure Pipelines** 是 Azure 平台提供的云服务，可以自动化您的开发生命周期中的构建、测试和发布阶段（CI/CD）。Azure
    Pipelines 可以与任何语言或平台一起使用，集成在 Azure DevOps 中，您可以在 Windows、Linux 或 macOS 机器上构建代码。'
- en: 'Azure Pipelines is free for public projects, while for private projects, you
    have up to 1,800 minutes'' (30 hours) worth of pipelines for free each month.
    More information about pricing can be found here:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 对于公共项目是免费的，而对于私有项目，每月提供最多 1,800 分钟（30 小时）的免费管道使用时间。有关定价的更多信息，请访问这里：
- en: '[https://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/](https://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/)'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/](https://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/)'
- en: 'Some important feature of Azure Pipelines can be summarized as follows:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 的一些重要特性可以总结如下：
- en: It's platform and language independent, which means you can build code on every
    platform using the code base you want.
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它是平台和语言独立的，这意味着您可以在任何平台上使用所需的代码库构建代码。
- en: It can be integrated with different types of repositories (Azure Repos, GitHub,
    GitHub Enterprise, BitBucket, and so on).
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以与不同类型的代码库（Azure Repos、GitHub、GitHub Enterprise、BitBucket 等）集成。
- en: Lots of extensions (standard and community-driven) are available for building
    your code and for handling custom tasks.
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有许多扩展（标准和社区驱动）可供构建代码和处理自定义任务。
- en: Allows you to deploy your code to different cloud vendors.
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许将代码部署到不同的云供应商。
- en: You can work with containerized applications such as Docker, Azure Container
    Registry, or Kubernetes.
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用容器化应用程序，如Docker、Azure Container Registry 或 Kubernetes。
- en: 'To use Azure Pipelines, you need the following:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用Azure Pipelines，您需要以下内容：
- en: An organization in Azure DevOps, where you can create public or private projects
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在Azure DevOps中的组织，您可以创建公开或私有项目
- en: A source code stored in a version control system (such as Azure DevOps Repos
    or GitHub)
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 存储在版本控制系统中的源代码（如 Azure DevOps Repos 或 GitHub）
- en: 'Azure Pipelines works with the following schema:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 使用以下架构：
- en: '![Figure 4.2 – Azure Pipelines schema'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.2 – Azure Pipelines 架构'
- en: '](img/B16392_04_002.jpg)'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_002.jpg)'
- en: Figure 4.2 – Azure Pipelines schema
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.2 – Azure Pipelines 架构
- en: When your code is committed to a particular branch inside a repository, the
    **build pipeline** engine starts, build and test tasks are executed, and if all
    is successfully completed, your app is built and you have the final output (artifact).
    You can also create a **release pipeline** that takes the output of your build
    and releases it to the target environment (staging or production).
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 当您的代码提交到仓库中的特定分支时，**构建管道**引擎启动，构建和测试任务执行，如果一切顺利完成，您的应用程序将被构建，您将得到最终输出（工件）。您还可以创建一个**发布管道**，将构建的输出发布到目标环境（预发布或生产）。
- en: 'To start using Azure Pipelines, you need to create a **pipeline**. A pipeline
    in Azure DevOps can be created in the following two ways:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始使用 Azure Pipelines，您需要创建一个**管道**。Azure DevOps 中的管道可以通过以下两种方式创建：
- en: '**Using the Classic interface**: This allows you to select some tasks visually
    from a list of possible tasks. You only need to fill in the parameters for these
    tasks.'
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**使用经典界面**：这允许您从可能的任务列表中可视化选择一些任务，您只需填写这些任务的参数。'
- en: '**Using a scripting language called YAML**: The pipeline can be defined by
    creating a YAML file inside your repository with all the needed steps.'
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**使用名为YAML的脚本语言**：可以通过在仓库中创建一个YAML文件，定义所有需要的步骤来定义管道。'
- en: Using the classic interface can be easier initially, but remember that many
    features are only available on YAML pipelines. A YAML pipeline definition is a
    file, and this can be versioned and controlled just like any other file inside
    a repository. You can easily move the pipeline definition between projects (this
    is not possible with the Classic interface).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 使用经典界面初始阶段可能更简单，但请记住，许多功能仅在YAML管道中可用。YAML管道定义是一个文件，这个文件可以像仓库中的其他文件一样进行版本控制和管理。您可以轻松地在项目之间迁移管道定义（这在经典界面中是不可能的）。
- en: 'An Azure Pipeline can be represented as follows (courtesy of Microsoft):'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Pipelines 可以表示为如下所示（感谢 Microsoft 提供）：
- en: '![Figure 4.3 – Representation of an Azure Pipeline'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.3 – Azure Pipelines 的表示'
- en: '](img/B16392_04_003.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_003.jpg)'
- en: Figure 4.3 – Representation of an Azure Pipeline
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.3 – Azure Pipelines 的表示
- en: A pipeline starts from a **trigger** (a manual trigger, a push inside a repository,
    a pull request, or a schedule). A pipeline is normally composed of one or more
    **stages** (logical separation of concerns in a pipeline, such as building, testing,
    deployment, and so on; they can run in parallel), and each stage contains one
    or more **jobs** (a set of steps that can also run in parallel). Every pipeline
    contains at least one stage if you don't explicitly create it. Each job runs on
    an **agent** (service or piece of software that executes the job). Every step
    is composed of a **task** that performs some action on your code (sequentially).
    The final output of a pipeline is an **artifact** (collection of files or packages
    published by the build).
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 一个管道从**触发器**开始（手动触发、仓库中的推送、拉取请求或计划任务）。管道通常由一个或多个**阶段**组成（管道中的逻辑分离，例如构建、测试、部署等；它们可以并行运行），每个阶段包含一个或多个**作业**（一组步骤，这些步骤也可以并行运行）。每个管道至少包含一个阶段，除非您明确创建了多个阶段。每个作业在**代理**上运行（执行作业的服务或软件）。每个步骤由**任务**组成，任务对代码执行某些操作（按顺序执行）。管道的最终输出是一个**工件**（构建发布的文件或包的集合）。
- en: When creating a pipeline, you need to define a set of jobs and tasks for automating
    your builds (or multi-phased builds). You have native support for testing integration,
    release gates, automatic reporting, and so on.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 创建管道时，您需要定义一组作业和任务，以自动化您的构建（或多阶段构建）。您可以获得对测试集成、发布门、自动报告等的原生支持。
- en: 'When defining multiple jobs within a pipeline, these jobs are executed in parallel.
    A pipeline that contains multiple jobs is called a **fan-out** scenario:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 当在管道中定义多个作业时，这些作业是并行执行的。包含多个作业的管道被称为**扇出**场景：
- en: '![Figure 4.4 – Fan-out pipeline'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.4 – 扩展管道'
- en: '](img/B16392_04_004.jpg)'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_004.jpg)'
- en: Figure 4.4 – Fan-out pipeline
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.4 – 扩展管道
- en: 'A pipeline with multiple jobs in a single stage can be represented as follows:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 一个包含多个任务的单阶段管道可以表示如下：
- en: '[PRE0]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '[PRE1]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '[PRE2]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '[PRE3]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '[PRE4]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '[PRE5]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '[PRE6]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '[PRE7]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[PRE8]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '[PRE9]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '[PRE10]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'If you''re using stages when defining your pipeline, this is what is called
    a fan-out/fan-in scenario:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在定义管道时使用阶段，那么这就是所谓的扩展/合并场景：
- en: '![Figure 4.5 – Fan-out pipeline'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.5 – 扩展管道'
- en: '](img/B16392_04_005.jpg)'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_005.jpg)'
- en: Figure 4.5 – Fan-out pipeline
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.5 – 扩展管道
- en: Here, each stage is a fan-in operation, where all the jobs in the stage (which
    can consist of multiple tasks that run in sequence) must be finished before the
    next stage can be triggered (only one stage can be executing at a time). We'll
    talk about multi-stage pipelines later in this chapter.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，每个阶段都是一个合并操作，阶段中的所有任务（这些任务可以是按顺序运行的多个任务）必须完成后，下一个阶段才能触发（每次只能有一个阶段在执行）。我们将在本章后面讨论多阶段管道。
- en: Understanding build agents
  id: totrans-89
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 理解构建代理
- en: To build and deploy your code using Azure Pipelines, you need at least one agent.
    An agent is a service that runs the jobs defined in your pipeline. The execution
    of these jobs can occur directly on the agent's host machine or in containers.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用 Azure Pipelines 构建和部署代码，你至少需要一个代理。代理是运行你管道中定义的任务的服务。这些任务的执行可以直接在代理的主机机器上，或在容器中进行。
- en: 'When defining agents for your pipeline, you have essentially two types of possible
    agents:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 在为管道定义代理时，你基本上有两种代理类型可选：
- en: '**Microsoft-hosted agents**: This is a service totally managed by Microsoft
    and it''s cleared on every execution of the pipeline (on each pipeline execution,
    you have a fresh new environment).'
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Microsoft 托管代理**：这是一个完全由 Microsoft 管理的服务，每次执行管道时都会清除（每次管道执行时，你都会获得一个全新的环境）。'
- en: '**Self-hosted agents**: This is a service that you need to set up and manage
    by yourself. This can be a custom virtual machine on Azure or a custom on-premise
    machine inside your infrastructure. In a self-hosted agent, you can install all
    the software you need for your builds, and this is persisted on every pipeline
    execution. A self-hosted agent can be on Windows, Linux, macOS, or in a Docker
    container.'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**自托管代理**：这是一个需要你自己设置和管理的服务。它可以是 Azure 上的自定义虚拟机，或者是你基础设施内的自定义本地机器。在自托管代理中，你可以安装所有需要的构建软件，并且这些软件会在每次管道执行时得到保留。自托管代理可以运行在
    Windows、Linux、macOS 或 Docker 容器中。'
- en: Microsoft-hosted agents
  id: totrans-94
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Microsoft 托管代理
- en: 'Microsoft-hosted agents is the simplest way to define an agent for your pipeline.
    Azure Pipelines provides a Microsoft-hosed agent pool by default called **Azure
    Pipelines**:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: Microsoft 托管代理是定义管道代理的最简单方法。Azure Pipelines 默认提供一个名为 **Azure Pipelines** 的 Microsoft
    托管代理池：
- en: '![Figure 4.6 – Azure Pipelines default agent pool'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.6 – Azure Pipelines 默认代理池'
- en: '](img/B16392_04_006.jpg)'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_006.jpg)'
- en: Figure 4.6 – Azure Pipelines default agent pool
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.6 – Azure Pipelines 默认代理池
- en: 'By selecting this agent pool, you can create different virtual machine types
    for executing your pipeline. At the time of writing, the available standard agent
    types are as follows:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 通过选择此代理池，你可以为执行管道创建不同的虚拟机类型。在撰写本文时，提供的标准代理类型如下：
- en: '![Table 1.1'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '![表 1.1'
- en: '](img/Table_1.1.jpg)'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_1.1.jpg)'
- en: Table 1.1
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 表 1.1
- en: 'Each of these images has its own set of software automatically installed. You
    can install additional tools by using the pre-defined Tool Installer task in your
    pipeline definition. More information can be found here:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 这些图像中的每一张都有自己的软件自动安装。你可以通过在管道定义中使用预定义的工具安装器任务来安装额外的工具。更多信息请见这里：
- en: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/?view=azure-devops#tool.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/?view=azure-devops#tool。
- en: 'When you create a pipeline using a Microsoft-hosted agent, you just need to
    specify the name of the virtual machine image to use for your agent from the preceding
    table. As an example, this is the definition of a hosted agent that''s using Windows
    Server 2019 with a Visual Studio 2019 image:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 当你使用 Microsoft 托管代理创建管道时，只需要指定要用于代理的虚拟机镜像名称，如前表所示。举例来说，这是一个使用 Windows Server
    2019 和 Visual Studio 2019 镜像的托管代理定义：
- en: '[PRE11]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '[PRE12]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '[PRE13]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'When using a Microsoft-hosted agent, you need to remember the following:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Microsoft 托管代理时，需要记住以下几点：
- en: You cannot sign in on the agent machine.
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你无法在代理机器上登录。
- en: The agent runs on a Standard DS2v2 Azure Virtual Machine and you cannot increase
    that capacity.
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 该代理运行在标准 DS2v2 Azure 虚拟机上，并且无法增加其容量。
- en: It runs as an administrator user on the Windows platform and as a *passwordless
    sudo* user on the Linux platform.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它在 Windows 平台上以管理员用户身份运行，在 Linux 平台上以*无密码的 sudo* 用户身份运行。
- en: For public projects, you have 10 free Microsoft-hosted parallel jobs that can
    run for up to 360 minutes each time, with no overall time limit per month.
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于公共项目，你可以获得 10 个免费的 Microsoft 托管并行作业，每个作业最多运行 360 分钟，且每月没有整体时间限制。
- en: For private projects, you have one free parallel job that can run for up to
    60 minutes each time, with the maximum being 1,800 minutes (30 hours) per month.
    If you need more capacity, you can pay for additional parallel jobs. By doing
    this, you can run each job for up to 360 minutes.
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于私有项目，你可以获得一个免费的并行作业，每次运行最多 60 分钟，每月的最大时长为 1,800 分钟（30 小时）。如果需要更多容量，你可以支付额外费用来增加并行作业数量。这样，你可以让每个作业运行最多
    360 分钟。
- en: The Microsoft-hosted agent runs in the same Azure geography as your Azure DevOps
    organization, but it's not guaranteed that it will run in the same region too
    (an Azure geography contains one or more regions).
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Microsoft 托管代理在与 Azure DevOps 组织相同的 Azure 地理区域内运行，但不保证它也会在相同的区域运行（一个 Azure 地理区域包含一个或多个区域）。
- en: Self-hosted agents
  id: totrans-116
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 自托管代理
- en: While Microsoft-hosted agents are a SaaS service, self-hosted agents are private
    agents that you can configure as per your needs by using Azure virtual machines
    or directly using your on-premise infrastructure. You are responsible for providing
    all the necessary software and tools to execute your pipeline and you're responsible
    for maintaining and upgrading your agent.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 Microsoft 托管代理是一个 SaaS 服务，但自托管代理是你可以根据需要配置的私有代理，使用 Azure 虚拟机或直接使用你自己的本地基础设施。你负责提供执行管道所需的所有软件和工具，并且你负责维护和升级代理。
- en: 'A self-hosted agent can be installed on the following platforms:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 自托管代理可以安装在以下平台上：
- en: Windows
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows
- en: Linux
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Linux
- en: macOS
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: macOS
- en: Docker
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Docker
- en: 'Creating a self-hosted agent involves completing the following activities:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 创建自托管代理包括完成以下活动：
- en: Prepare the environment
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 准备环境
- en: Prepare permissions on Azure DevOps
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 Azure DevOps 上准备权限
- en: Download and configure the agent
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 下载并配置代理
- en: Start the agent
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启动代理
- en: These steps are similar for all the environments. Next, we'll learn how to create
    a self-hosted Windows agent.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 这些步骤在所有环境中都类似。接下来，我们将学习如何创建一个自托管的 Windows 代理。
- en: Creating a self-hosted Windows agent
  id: totrans-129
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建自托管 Windows 代理
- en: A self-hosted Windows agent is used to build and deploy applications built on
    top of Microsoft's platforms (such as .NET applications, Azure cloud apps, and
    so on) but also for other types of platforms, such as Java and Android apps.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 自托管 Windows 代理用于构建和部署基于 Microsoft 平台（如 .NET 应用、Azure 云应用等）构建的应用程序，也适用于其他平台类型，如
    Java 和 Android 应用。
- en: 'The first step to perform when creating an agent is to register the agent in
    your Azure DevOps organization. To do so, you need to sign into your DevOps organization
    as an administrator and from the **User Settings** menu, click on **Personal access
    tokens**:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 创建代理时的第一步是将代理注册到你的 Azure DevOps 组织中。为此，你需要以管理员身份登录到你的 DevOps 组织，并从**用户设置**菜单中点击**个人访问令牌**：
- en: '![Figure 4.7 – Personal access tokens'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.7 – 个人访问令牌'
- en: '](img/B16392_04_007.jpg)'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_007.jpg)'
- en: Figure 4.7 – Personal access tokens
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.7 – 个人访问令牌
- en: 'Here, you can create a new personal access token for your organization with
    an expiration date and with full access or with a custom defined access level
    (if you select the custom defined scope, you need to select the permission you
    want for each scope). To see the complete list of available scopes, click on the
    **Show all scopes** link at the bottom of this window:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，你可以为你的组织创建一个新的个人访问令牌，设置过期日期，并选择完全访问或自定义访问级别（如果选择自定义访问范围，则需要为每个范围选择所需的权限）。要查看可用范围的完整列表，请点击此窗口底部的**显示所有范围**链接：
- en: '![Figure 4.8 – Create a new personal access token'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.8 – 创建新的个人访问令牌'
- en: '](img/B16392_04_008.jpg)'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_008.jpg)'
- en: Figure 4.8 – Create a new personal access token
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.8 – 创建新的个人访问令牌
- en: Please check that the **Agent Pools** scope has the **Read & manage** permission
    enabled.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 请检查是否已启用**代理池**范围的**读取和管理**权限。
- en: When finished, click on **Create** and then copy the generated token before
    closing the window (it will only be shown once).
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后，点击**创建**，然后在关闭窗口之前复制生成的令牌（它只会显示一次）。
- en: Important Note
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: The user that you will be using for the agent must be a user with permissions
    to register the agent. You can check this by going to **Organization Settings**
    | **Agent pools**, selecting the **Default** pool, and clicking on **Security**.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 你将用于代理程序的用户必须是具有注册代理程序权限的用户。你可以通过进入**组织设置** | **代理池**，选择**默认**池，然后点击**安全性**来检查这一点。
- en: 'Now, you need to download the agent software and configure it. From **Organization
    Settings** | **Agent Pools**, select the **Default** pool and from the **Agents**
    tab, click on **New agent**:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你需要下载代理软件并进行配置。从**组织设置** | **代理池**，选择**默认**池，在**代理**选项卡中点击**新代理**：
- en: '![Figure 4.9 – Creating a new agent'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.9 – 创建新代理'
- en: '](img/B16392_04_009.jpg)'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_009.jpg)'
- en: Figure 4.9 – Creating a new agent
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.9 – 创建新代理
- en: 'The **Get the agent** window will open. Select **Windows** as the target platform,
    select **x64** or **x86** as your target agent platform (machine) accordingly,
    and then click on the **Download** button:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: '**获取代理**窗口将打开。选择**Windows**作为目标平台，选择**x64**或**x86**作为目标代理平台（机器），然后点击**下载**按钮：'
- en: '![Figure 4.10 – Agent software download page'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.10 – 代理软件下载页面'
- en: '](img/B16392_04_010.jpg)'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_010.jpg)'
- en: Figure 4.10 – Agent software download page
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.10 – 代理软件下载页面
- en: 'This procedure will download a package (normally called `vsts-agent-win-x64-2.166.4.zip`).
    You need to run this package (`config.cmd`) on the agent machine (an Azure VM
    or your on-premise server, which will act as an agent for your builds):'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 该过程会下载一个包（通常名为`vsts-agent-win-x64-2.166.4.zip`）。你需要在代理机器上运行这个包（`config.cmd`）（可以是
    Azure 虚拟机或你的本地服务器，它将作为你构建的代理程序）：
- en: '![Figure 4.11 – Agent software package'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.11 – 代理软件包'
- en: '](img/B16392_04_011.jpg)'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_011.jpg)'
- en: Figure 4.11 – Agent software package
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.11 – 代理软件包
- en: 'The setup will ask you for the following:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 安装程序会询问你以下内容：
- en: The URL of your Azure DevOps organization ([https://dev.azure.com/](https://dev.azure.com/){your-organization})
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你的 Azure DevOps 组织的 URL ([https://dev.azure.com/](https://dev.azure.com/){your-organization})
- en: The personal access token to use (created previously)
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要使用的个人访问令牌（之前创建的）
- en: When running the agent (interactively or as a service), it's recommended to
    run it as a service if you want to automate builds.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行代理程序时（无论是交互式还是作为服务），如果你希望自动化构建，推荐以服务的方式运行它。
- en: 'After inserting these parameters, the setup registers the agent:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 在插入这些参数后，安装程序会注册代理程序：
- en: '![Figure 4.12 – Agent registration'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.12 – 代理注册'
- en: '](img/B16392_04_012.jpg)'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_012.jpg)'
- en: Figure 4.12 – Agent registration
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.12 – 代理注册
- en: To register the agent, you need to insert the agent pool, the agent name, and
    the work folder (you can leave the default value as-is).
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 要注册代理程序，你需要插入代理池、代理名称和工作文件夹（你可以保持默认值不变）。
- en: Finally, you need to decide whether your agent must be executed *interactively* or *as
    a service*. As we mentioned previously, running the agent as a service is recommended,
    but in many cases, the interactive option can be helpful because it gives you
    a console where you can see the status and running UI tests.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你需要决定你的代理程序是必须以*交互式*方式执行，还是*作为服务*运行。正如我们之前提到的，推荐以服务的方式运行代理程序，但在很多情况下，交互式选项会很有帮助，因为它可以为你提供一个控制台，你可以在其中查看状态和运行中的
    UI 测试。
- en: In both cases, please be aware of the user account you select for running the
    agent. The default account is the built-in Network Service user, but this user
    normally doesn't have all the needed permissions on local folders. Using an administrator
    account can help you solve a lot of problems.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 在这两种情况下，请注意你为运行代理程序选择的用户帐户。默认帐户是内建的网络服务用户，但这个用户通常没有本地文件夹所需的所有权限。使用管理员帐户可以帮助你解决很多问题。
- en: 'If the setup has been completed successfully, you should see a service running
    on your agent machine and a new agent that pops up on your agent pool in Azure
    DevOps:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 如果安装成功，你应该能在代理机器上看到一个正在运行的服务，并且在 Azure DevOps 的代理池中弹出一个新代理：
- en: '![4.13 – New agent created'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '![4.13 – 新代理已创建'
- en: '](img/B16392_04_013.jpg)'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_013.jpg)'
- en: 4.13 – New agent created
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 4.13 – 新代理已创建
- en: 'If you select the agent and then go to the **Capabilities** section, you will
    be able to see all its capabilities (OS version, OS architecture, computer name,
    software installed, and so on):'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你选择了代理程序，然后进入**功能**部分，你将能够看到它的所有功能（操作系统版本、操作系统架构、计算机名称、安装的软件等）：
- en: '![Figure 4.14 – Agent capabilities'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.14 – 代理功能'
- en: '](img/B16392_04_014.jpg)'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_014.jpg)'
- en: Figure 4.14 – Agent capabilities
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.14 – 代理功能
- en: The agent's capabilities can be automatically discovered by the agent software
    or added by you (user-defined capabilities) if you click on the **Add a new capability**
    action. Capabilities are used by the pipeline engine to redirect a particular
    build to the correct agent according to the required capabilities for the pipeline
    (demands).
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 代理的能力可以由代理软件自动发现，也可以通过你（用户自定义的能力）添加，如果你点击**添加新能力**操作。能力用于管道引擎，根据管道所需的能力（需求）将特定的构建重定向到正确的代理。
- en: When the agent is online, it's ready to accept your code build, which should
    be queued.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 当代理在线时，它已准备好接受你的代码构建，该构建应该排队等待。
- en: Remember that you can also install multiple agents on the same machine (for
    example, if you want the possibility to execute core pipelines or handle jobs
    in parallel), but this scenario is only recommended if the agents will not share
    resources.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，你也可以在同一台机器上安装多个代理（例如，如果你希望执行核心管道或并行处理作业），但仅在代理不会共享资源的情况下推荐这种方案。
- en: When to use a Microsoft-hosted or a self-hosted agent
  id: totrans-177
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 何时使用 Microsoft 托管代理或自托管代理
- en: Microsoft-hosted agents are normally useful when you have a standard code base
    and you don't need particular software or environment configuration to build your
    code. If you're in this scenario, using a Microsoft-hosted agent is recommended
    because you don't have to worry about creating environments. As an example, if
    you need to build an Azure Function project, normally, you don't have the need
    to install custom software on the build agent and the Microsoft-hosted agent can
    work perfectly.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 当你有一个标准的代码库并且不需要特定的软件或环境配置来构建代码时，Microsoft 托管的代理通常很有用。如果你处于这种情况，推荐使用 Microsoft
    托管的代理，因为你不必担心创建环境。例如，如果你需要构建一个 Azure Function 项目，通常情况下，你不需要在构建代理上安装自定义软件，Microsoft
    托管的代理可以完美工作。
- en: Self-hosted agents are the way to go when you need a particular environment
    configuration, when you need a particular piece of software or tools installed
    on the agent, and when you need more power for your builds. Self-hosted agents
    are also the way to go when you need to preserve the environment between each
    run of your builds. A self-hosted agent is normally the right choice when you
    need to have better control of your agent or you wish to deploy your build to
    on-premise environments (not accessible externally). It also normally allows you
    to save money.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 当你需要特定的环境配置，或者需要在代理上安装特定的软件或工具，或者需要更多的构建计算能力时，自托管代理是最佳选择。自托管代理也是当你需要在每次构建运行之间保持环境一致时的首选。当你需要更好地控制代理或希望将构建部署到本地环境（外部无法访问）时，自托管代理通常是正确的选择。它也通常能帮你节省成本。
- en: Now that we've discussed about the possible build agents that you can use for
    your build pipelines, in the next section, we'll provide an overview of YAML,
    the scripting language that allows you to define a pipeline.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经讨论了可以用于构建管道的可能构建代理，在接下来的部分中，我们将概述 YAML，这是一种允许你定义管道的脚本语言。
- en: Overview of the YAML language
  id: totrans-181
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: YAML 语言概述
- en: '**YAML**, an acronym for **YAML Ain''t Markup Language**, is a human-readable
    scripting language used for data serialization and normally used for handling
    configurations definitions for applications. It can be considered a superset of
    JSON.'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: '**YAML**，即**YAML 不只是标记语言**，是一种人类可读的脚本语言，用于数据序列化，通常用于处理应用程序的配置定义。它可以视为 JSON
    的超集。'
- en: YAML uses indentation for handling the structure of the object's definitions,
    and it's insensitive to quotation marks and braces. It's simply a data representation
    language and is not used for executing commands.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: YAML 使用缩进来处理对象定义的结构，并且对引号和大括号不敏感。它只是一个数据表示语言，不用于执行命令。
- en: With Azure DevOps, YAML is extremely important because it allows you to define
    a pipeline by using a script definition instead of a graphical interface (that
    cannot be ported between projects).
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure DevOps 中，YAML 极为重要，因为它允许你使用脚本定义来定义管道，而不是使用图形界面（图形界面无法在项目之间移植）。
- en: 'The official YAML website can be found here:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 官方 YAML 网站可以在这里找到：
- en: '[http://yaml.org/](http://yaml.org/)'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: '[http://yaml.org/](http://yaml.org/)'
- en: 'A YAML structure is based on key-value elements:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: YAML 结构基于键值元素：
- en: '`Key: Value # This is a comment`'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: '`Key: Value # 这是一个注释`'
- en: In the following sections, we'll learn how to define objects in YAML.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的部分中，我们将学习如何在 YAML 中定义对象。
- en: Scalars
  id: totrans-190
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 标量
- en: 'As an example, the following are scalar variables that have been defined in
    YAML:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 作为示例，以下是 YAML 中已定义的标量变量：
- en: '[PRE14]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'You can also define multi-line keys by using `?`, followed by a space, as follows:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以通过使用`?`后跟一个空格来定义多行键，如下所示：
- en: '[PRE15]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: '[PRE16]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '[PRE17]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: '[PRE18]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Collections and lists
  id: totrans-198
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 集合和列表
- en: 'This is a YAML definition for a collection object:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个集合对象的 YAML 定义：
- en: '[PRE19]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '[PRE20]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '[PRE21]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: '[PRE22]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'You can also define nested collections:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以定义嵌套集合：
- en: '[PRE23]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: '[PRE24]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: '[PRE25]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: '[PRE26]'
  id: totrans-208
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: '[PRE27]'
  id: totrans-209
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: '[PRE28]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '[PRE29]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Dictionaries
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 字典
- en: 'You can define a `Dictionary` object by using YAML in the following way:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过以下方式使用 YAML 定义一个`Dictionary`对象：
- en: '[PRE30]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: '[PRE31]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: '[PRE32]'
  id: totrans-216
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: '[PRE33]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: Document structure
  id: totrans-218
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 文档结构
- en: 'YAML uses three dashes, `---`, to separate directives from document content
    and to identify the start of a document. As an example, the following YAML defines
    two documents in a single file:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: YAML 使用三个短横线`---`来分隔指令与文档内容，并标识文档的开始。作为示例，以下 YAML 定义了一个文件中的两个文档：
- en: '[PRE34]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: '[PRE35]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: '[PRE36]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: '[PRE37]'
  id: totrans-223
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: '[PRE38]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: '[PRE39]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: '[PRE40]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: '[PRE41]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: '[PRE42]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: '[PRE43]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: '[PRE44]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: Complex object definition
  id: totrans-231
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 复杂对象定义
- en: 'As an example of how to define a complex object in YAML, the following is the
    representation used for an `Invoice` object:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 作为如何在 YAML 中定义复杂对象的示例，以下是用于表示`Invoice`对象的方式：
- en: '[PRE45]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: '[PRE46]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: '[PRE47]'
  id: totrans-235
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: '[PRE48]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: '[PRE49]'
  id: totrans-237
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: '[PRE50]'
  id: totrans-238
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: '[PRE51]'
  id: totrans-239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: '[PRE52]'
  id: totrans-240
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: '[PRE53]'
  id: totrans-241
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: '[PRE54]'
  id: totrans-242
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: '[PRE55]'
  id: totrans-243
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: '[PRE56]'
  id: totrans-244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: '[PRE57]'
  id: totrans-245
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: '[PRE58]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: '[PRE59]'
  id: totrans-247
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: '[PRE60]'
  id: totrans-248
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: '[PRE61]'
  id: totrans-249
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: '[PRE62]'
  id: totrans-250
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: '[PRE63]'
  id: totrans-251
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: '[PRE64]'
  id: totrans-252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: '[PRE65]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: '[PRE66]'
  id: totrans-254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: '[PRE67]'
  id: totrans-255
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: '[PRE68]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: '[PRE69]'
  id: totrans-257
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: '[PRE70]'
  id: totrans-258
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: '[PRE71]'
  id: totrans-259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: Now that we've provided a quick overview of the YAML syntax, in the next section,
    we'll learn how to create a build pipeline with Azure DevOps.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经提供了 YAML 语法的快速概述，在下一部分，我们将学习如何使用 Azure DevOps 创建构建管道。
- en: Creating a build pipeline with Azure DevOps
  id: totrans-261
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Azure DevOps 创建构建管道
- en: Having a build pipeline in place is a fundamental step if you want to implement
    continuous integration for your code (having your code automatically built and
    tested on every commit).
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想为代码实现持续集成（每次提交时自动构建和测试代码），那么设置构建管道是一个基本步骤。
- en: The prerequisite to creating a build pipeline with Azure DevOps is obviously
    to have some code stored inside a repository.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Azure DevOps 创建构建管道的先决条件显然是需要将代码存储在一个代码库中。
- en: 'To create a build pipeline with Azure DevOps, you need to go to the **Pipelines**
    hub and select the **Pipelines** action:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用 Azure DevOps 创建构建管道，你需要进入**管道**中心并选择**管道**操作：
- en: '![Figure 4.15 – Build pipeline creation'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.15 – 构建管道创建'
- en: '](img/B16392_04_015.jpg)'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_015.jpg)'
- en: Figure 4.15 – Build pipeline creation
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.15 – 构建管道创建
- en: 'From here, you can create a new build pipeline by selecting the **New pipeline**
    button. When pressed, you will see the following screen, which asks you for a
    code repository:'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 从这里，你可以通过选择**新建管道**按钮来创建一个新的构建管道。点击后，你将看到以下屏幕，要求你提供一个代码库：
- en: '![Figure 4.16 – Selecting a repository'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.16 – 选择一个代码库'
- en: '](img/B16392_04_016.jpg)'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_016.jpg)'
- en: Figure 4.16 – Selecting a repository
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.16 – 选择一个代码库
- en: 'This screen is extremely important. From here, you can start creating a build
    pipeline in two possible ways (described previously):'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 这个屏幕非常重要。从这里，你可以通过两种可能的方式开始创建构建管道（如前所述）：
- en: Using a YAML file to create your pipeline definition. This is what happens when
    you select the repository in this window.
  id: totrans-273
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 YAML 文件创建管道定义。这就是当你在此窗口中选择代码库时发生的情况。
- en: Using the classic editor (graphical user interface). This is what happens when
    you click on the **Use the classic editor** link at the bottom of this page.
  id: totrans-274
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用经典编辑器（图形用户界面）。当你点击页面底部的**使用经典编辑器**链接时，就会发生这种情况。
- en: In the next section, we'll learn how to create a build pipeline by using these
    two methods.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一部分，我们将学习如何使用这两种方法创建构建管道。
- en: Pipeline definition with the classic editor
  id: totrans-276
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用经典编辑器定义管道
- en: The classic editor permits you to define a build pipeline for your project graphically
    by selecting pre-defined actions. As we mentioned previously, a pipeline definition
    created in this way is not under source control.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 经典编辑器允许你通过选择预定义的操作，图形化地定义项目的构建管道。如前所述，以这种方式创建的管道定义不受源代码控制。
- en: 'When you click on the **Use the classic editor** link, you need to select the
    repository where your code is stored (**Azure Repos Git**, **GitHub**, **GitHub
    Enterprise Server**, **Subversion**, **TFVC**, **Bitbucket Cloud**, or **Other
    Git**) and the branch that the build pipeline will be connected to:'
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: 当你点击**使用经典编辑器**链接时，你需要选择存放代码的代码库（**Azure Repos Git**、**GitHub**、**GitHub 企业服务器**、**Subversion**、**TFVC**、**Bitbucket
    Cloud** 或 **其他 Git**）以及构建管道将连接的分支：
- en: '![Figure 4.17 – Classic editor pipeline definition'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.17 – 经典编辑器管道定义'
- en: '](img/B16392_04_017.jpg)'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_017.jpg)'
- en: Figure 4.17 – Classic editor pipeline definition
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.17 – 经典编辑器管道定义
- en: 'Then, you need to choose a template for the kind of app you''re building. You
    have a set of predefined templates to choose from (that you can customize later),
    but you can also start from an empty template:'
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，您需要选择正在构建的应用程序类型的模板。您有一组预定义的模板可供选择（稍后可以自定义），但您也可以从空模板开始：
- en: '![Figure 4.18 – Pipeline template selection'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.18 – 管道模板选择'
- en: '](img/B16392_04_018.jpg)'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_018.jpg)'
- en: Figure 4.18 – Pipeline template selection
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.18 – 管道模板选择
- en: If predefined templates fit your needs, you can start by using them; otherwise,
    it's recommended to create a custom pipeline by selecting the actions you need.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 如果预定义的模板符合您的需求，您可以开始使用它们；否则，建议通过选择您需要的操作来创建自定义管道。
- en: 'Here, my application that''s stored in the Azure DevOps project repository
    is an ASP.NET web application (an e-commerce website project called `PartsUnlimited`;
    you can find the public repository at the following URL: [https://github.com/Microsoft/PartsUnlimited](https://github.com/Microsoft/PartsUnlimited)),
    so I''ve selected the ASP.NET template.'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我的应用程序存储在Azure DevOps项目存储库中，是一个ASP.NET Web应用程序（名为`PartsUnlimited`的电子商务网站项目；您可以在以下URL找到公共存储库：[https://github.com/Microsoft/PartsUnlimited](https://github.com/Microsoft/PartsUnlimited)），因此我选择了ASP.NET模板。
- en: 'When selected, this is the pipeline template that will be created for you automatically:'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 当选择时，这是将自动为您创建的管道模板：
- en: '![Figure 4.19 – Pipeline created from a template'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.19 – 从模板创建的管道'
- en: '](img/B16392_04_019.jpg)'
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_019.jpg)'
- en: Figure 4.19 – Pipeline created from a template
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.19 – 从模板创建的管道
- en: Let's check every section of the pipeline in detail.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们详细检查管道的每个部分。
- en: 'The pipeline (here, this is called `PartsUnlimited-demo-pipeline`) runs on
    a Microsoft-hosted agent (Azure Pipelines agent pool) based on the **vs2017-win2016**
    template (Windows Server 2016 with Visual Studio 2017), as shown in the following
    screenshot:'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 管道（这里称为`PartsUnlimited-demo-pipeline`）在Microsoft托管的代理（Azure管道代理池）上运行，基于**vs2017-win2016**模板（Windows
    Server 2016与Visual Studio 2017），如下截图所示：
- en: '![Figure 4.20 – Agent specification on the pipeline'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.20 – 管道上的代理规范'
- en: '](img/B16392_04_020.jpg)'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_020.jpg)'
- en: Figure 4.20 – Agent specification on the pipeline
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.20 – 管道上的代理规范
- en: 'The agent job starts by installing the NuGet package manager and restoring
    the required packages for building the project in the selected repository. For
    these actions, the pipeline definition contains the tasks that you can see in
    the following screenshot:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 代理作业从安装NuGet软件包管理器开始，并恢复所选存储库中构建项目所需的软件包。对于这些操作，管道定义包含您可以在以下截图中看到的任务：
- en: '![Figure 4.21 – NuGet tasks'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.21 – NuGet 任务'
- en: '](img/B16392_04_021.jpg)'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_021.jpg)'
- en: Figure 4.21 – NuGet tasks
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.21 – NuGet 任务
- en: 'Then, there''s a task for building the solution:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，有一个构建解决方案的任务：
- en: '![Figure 4.22 – Build solution task'
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.22 – 构建解决方案任务'
- en: '](img/B16392_04_022.jpg)'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_022.jpg)'
- en: Figure 4.22 – Build solution task
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.22 – 构建解决方案任务
- en: 'There''s also a task for testing the solution and publishing the test results:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一个任务是测试解决方案并发布测试结果：
- en: '![Figure 4.23 – Test Assemblies task'
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.23 – 测试组件任务'
- en: '](img/B16392_04_023.jpg)'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_023.jpg)'
- en: Figure 4.23 – Test Assemblies task
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.23 – 测试组件任务
- en: 'The last steps are for publishing the sources of the build process as artifacts
    (output of the build):'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 最后几步是将构建过程的源发布为工件（构建的输出）：
- en: '![Figure 4.24 – Publishing tasks'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.24 – 发布任务'
- en: '](img/B16392_04_024.jpg)'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_024.jpg)'
- en: Figure 4.24 – Publishing tasks
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.24 – 发布任务
- en: 'If you select the **Variables** tab, you will see that there are some parameters
    that are used during the build process. Here, you can create your own variables
    to use inside the pipeline if needed:'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 如果选择**变量**选项卡，您将看到在构建过程中使用的一些参数。在这里，如果需要，您可以创建自己的变量以在管道内部使用：
- en: '![Figure 4.25 – Pipeline variables'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.25 – 管道变量'
- en: '](img/B16392_04_025.jpg)'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_025.jpg)'
- en: Figure 4.25 – Pipeline variables
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.25 – 管道变量
- en: 'The next section is called **Triggers**. Here, you can define what triggers
    start your pipeline. By default, no triggers are published initially, but here,
    you can enable CI to automatically start your pipeline on every commit on the
    selected branch:'
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来的部分称为**触发器**。在这里，您可以定义触发器何时启动您的管道。默认情况下，最初没有触发器发布，但在这里，您可以启用CI以在所选分支上的每次提交时自动启动您的管道：
- en: '![Figure 4.26 – Pipeline triggers'
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.26 – 管道触发器'
- en: '](img/B16392_04_026.jpg)'
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_026.jpg)'
- en: Figure 4.26 – Pipeline triggers
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.26 – 管道触发器
- en: Important Note
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Enabling CI is a recommended practice if you want every piece of code that's
    committed on a branch (for example, on the **master** branch) to always be tested
    and safely controlled. In this way, you can be assured that the code is always
    working as expected.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 启用 CI 是一种推荐做法，如果你希望每次在某个分支上提交的代码（例如在 **master** 分支上）都经过测试并得到安全控制。这样，你可以确保代码始终按预期工作。
- en: 'In the **Option** tab, you can set some options related to your build definition.
    For example, here, you can create links to all the work items so that they''re
    linked to associated changes when a build completes successfully, create work
    items on failure of a build, set the status badge for your pipeline, specify timeouts,
    and so on:'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **选项** 选项卡中，你可以设置一些与构建定义相关的选项。例如，在这里，你可以创建与所有工作项的链接，使它们在构建成功完成时与相关更改关联，构建失败时创建工作项，设置管道的状态徽章，指定超时时间等：
- en: '![Figure 4.27 – Pipeline options'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.27 – 管道选项'
- en: '](img/B16392_04_027.jpg)'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_027.jpg)'
- en: Figure 4.27 – Pipeline options
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.27 – 管道选项
- en: The **Retention** tab, on the other hand, is used for configuring the retention
    policy for this specific pipeline (how many days to keep artifacts for, the number
    of days to keep runs and pull requests for, and so on). Doing this will override
    the general retention settings. We'll talk about them later in the *Retention
    of builds* section.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: '**保留** 选项卡用于配置这个特定管道的保留策略（例如，保留工件多少天，保留运行和拉取请求多少天等）。这样做将覆盖一般的保留设置。我们将在后面的 *构建保留*
    部分讨论这些设置。'
- en: 'Once you''ve finished defining the pipeline, you can click **Save & queue**
    to save your definition. By clicking on **Save and run**, the pipeline will be
    placed in a queue and wait for an agent:'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成定义管道，你可以点击 **保存并排队** 来保存你的定义。通过点击 **保存并运行**，管道将被放入队列并等待代理：
- en: '![Figure 4.28 – Run pipeline'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.28 – 运行管道'
- en: '](img/B16392_04_028.jpg)'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_028.jpg)'
- en: Figure 4.28 – Run pipeline
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.28 – 运行管道
- en: 'When the agent is found, the pipeline is executed and your code is built:'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 当找到代理时，管道将被执行，且你的代码会被构建：
- en: '![Figure 4.29 – Pipeline execution starting'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.29 – 管道执行开始'
- en: '](img/B16392_04_029.jpg)'
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_029.jpg)'
- en: Figure 4.29 – Pipeline execution starting
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.29 – 管道执行开始
- en: 'You can follow the execution of each step of the pipeline and see the related
    logs. If the pipeline ends successfully, you can view a summary of its execution:'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以跟踪管道每个步骤的执行，并查看相关的日志。如果管道成功结束，你可以查看其执行摘要：
- en: '![Figure 4.30 – Pipeline – final result'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.30 – 管道 – 最终结果'
- en: '](img/B16392_04_030.jpg)'
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_030.jpg)'
- en: Figure 4.30 – Pipeline – final result
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.30 – 管道 – 最终结果
- en: 'You can also select the **Tests** tab to review the test execution status:'
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以选择 **测试** 选项卡，查看测试执行状态：
- en: '![Figure 4.31 – Pipeline tests result'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.31 – 管道测试结果'
- en: '](img/B16392_04_031.jpg)'
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_031.jpg)'
- en: Figure 4.31 – Pipeline tests result
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.31 – 管道测试结果
- en: In the next section, we'll learn how to create a YAML pipeline for this application.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将学习如何为这个应用程序创建一个 YAML 管道。
- en: YAML pipeline definition
  id: totrans-345
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: YAML 管道定义
- en: As previously explained, when you start creating a build pipeline with Azure
    DevOps, the wizard creates a YAML-based pipeline by default.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，当你开始使用 Azure DevOps 创建构建管道时，向导默认会创建一个基于 YAML 的管道。
- en: To start creating a YAML pipeline, go to the **Pipeline** section in Azure DevOps
    and click on **New Pipeline**.
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始创建 YAML 管道，进入 Azure DevOps 的 **管道** 部分并点击 **新建管道**。
- en: 'Here, instead of selecting the classic editor (as we did in the previous section),
    just select the type of repository where your code is located (**Azure Repos Git**,
    **GitHub**, **BitBucket**, and so on):'
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，不要选择经典编辑器（正如我们在前一节中所做的），只需选择你的代码所在的仓库类型（**Azure Repos Git**，**GitHub**，**BitBucket**等）：
- en: '![Figure 4.32 – YAML pipeline definition'
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.32 – YAML 管道定义'
- en: '](img/B16392_04_032.jpg)'
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_032.jpg)'
- en: Figure 4.32 – YAML pipeline definition
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.32 – YAML 管道定义
- en: 'Then, select your repository from the available repositories list:'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，从可用的仓库列表中选择你的仓库：
- en: '![Figure 4.33 – YAML pipeline – repository selection'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.33 – YAML 管道 – 仓库选择'
- en: '](img/B16392_04_033.jpg)'
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_033.jpg)'
- en: Figure 4.33 – YAML pipeline – repository selection
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.33 – YAML 管道 – 仓库选择
- en: 'The system now analyzes your repository and proposes a set of available templates
    according to the code stored in the repository itself. You can start from a blank
    YAML template or you can select a template. Here, I''m selecting the ASP.NET template:'
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: 系统现在会分析你的代码库，并根据库中存储的代码建议一组可用的模板。你可以从一个空白的 YAML 模板开始，或者选择一个模板。这里，我选择了 ASP.NET
    模板：
- en: '![Figure 4.34 – YAML pipeline – template selection'
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.34 – YAML 管道 – 模板选择'
- en: '](img/B16392_04_034.jpg)'
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_034.jpg)'
- en: Figure 4.34 – YAML pipeline – template selection
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.34 – YAML 管道 – 模板选择
- en: 'The system creates a YAML file (called `azure-pipelines.yml`), as shown in
    the following screenshot:'
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
  zh: 系统会创建一个 YAML 文件（名为 `azure-pipelines.yml`），如以下截图所示：
- en: '![Figure 4.35 – YAML pipeline definition'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.35 – YAML 管道定义'
- en: '](img/B16392_04_035.jpg)'
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_035.jpg)'
- en: Figure 4.35 – YAML pipeline definition
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.35 – YAML 管道定义
- en: 'The generated YAML definition contains a set of tasks, just like in the previous
    example, but here, these tasks are in their YAML definition. The complete generated
    file is as follows:'
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: 生成的 YAML 定义包含了一组任务，就像前面的示例一样，但这些任务在它们的 YAML 定义中。完整的生成文件如下：
- en: '[PRE72]'
  id: totrans-365
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: '[PRE73]'
  id: totrans-366
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: '[PRE74]'
  id: totrans-367
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: '[PRE75]'
  id: totrans-368
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: '[PRE76]'
  id: totrans-369
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: '[PRE77]'
  id: totrans-370
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: '[PRE78]'
  id: totrans-371
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: '[PRE79]'
  id: totrans-372
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: '[PRE80]'
  id: totrans-373
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: '[PRE81]'
  id: totrans-374
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: '[PRE82]'
  id: totrans-375
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: '[PRE83]'
  id: totrans-376
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: '[PRE84]'
  id: totrans-377
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: '[PRE85]'
  id: totrans-378
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: '[PRE86]'
  id: totrans-379
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: '[PRE87]'
  id: totrans-380
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: '[PRE88]'
  id: totrans-381
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: '[PRE89]'
  id: totrans-382
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: '[PRE90]'
  id: totrans-383
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: '[PRE91]'
  id: totrans-384
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: '[PRE92]'
  id: totrans-385
  prefs: []
  type: TYPE_PRE
  zh: '[PRE92]'
- en: '[PRE93]'
  id: totrans-386
  prefs: []
  type: TYPE_PRE
  zh: '[PRE93]'
- en: '[PRE94]'
  id: totrans-387
  prefs: []
  type: TYPE_PRE
  zh: '[PRE94]'
- en: '[PRE95]'
  id: totrans-388
  prefs: []
  type: TYPE_PRE
  zh: '[PRE95]'
- en: '[PRE96]'
  id: totrans-389
  prefs: []
  type: TYPE_PRE
  zh: '[PRE96]'
- en: '[PRE97]'
  id: totrans-390
  prefs: []
  type: TYPE_PRE
  zh: '[PRE97]'
- en: '[PRE98]'
  id: totrans-391
  prefs: []
  type: TYPE_PRE
  zh: '[PRE98]'
- en: '[PRE99]'
  id: totrans-392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE99]'
- en: '[PRE100]'
  id: totrans-393
  prefs: []
  type: TYPE_PRE
  zh: '[PRE100]'
- en: '[PRE101]'
  id: totrans-394
  prefs: []
  type: TYPE_PRE
  zh: '[PRE101]'
- en: '[PRE102]'
  id: totrans-395
  prefs: []
  type: TYPE_PRE
  zh: '[PRE102]'
- en: '[PRE103]'
  id: totrans-396
  prefs: []
  type: TYPE_PRE
  zh: '[PRE103]'
- en: '[PRE104]'
  id: totrans-397
  prefs: []
  type: TYPE_PRE
  zh: '[PRE104]'
- en: '[PRE105]'
  id: totrans-398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE105]'
- en: '[PRE106]'
  id: totrans-399
  prefs: []
  type: TYPE_PRE
  zh: '[PRE106]'
- en: '[PRE107]'
  id: totrans-400
  prefs: []
  type: TYPE_PRE
  zh: '[PRE107]'
- en: '[PRE108]'
  id: totrans-401
  prefs: []
  type: TYPE_PRE
  zh: '[PRE108]'
- en: '[PRE109]'
  id: totrans-402
  prefs: []
  type: TYPE_PRE
  zh: '[PRE109]'
- en: '[PRE110]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE110]'
- en: '[PRE111]'
  id: totrans-404
  prefs: []
  type: TYPE_PRE
  zh: '[PRE111]'
- en: As you can see, the YAML file contains the trigger that starts the pipeline
    (here, this is a commit on the master branch), the agent pool to use, the pipeline
    variables, and the sequence of each task to execute (with its specific parameters).
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，YAML 文件包含了启动管道的触发器（这里是主分支上的提交）、使用的代理池、管道变量，以及每个任务执行的顺序（以及它的具体参数）。
- en: Click on Save and run as shown in the previous screenshot to queue the pipeline
    and have it executed. The following screenshot shows the executed YAML pipeline.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 点击保存并运行，如前面截图所示，这将排队执行管道。以下截图显示了执行后的 YAML 管道。
- en: '![Figure 4.36 – YAML pipeline executed'
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.36 – 执行的 YAML 管道'
- en: '](img/B16392_04_036.jpg)'
  id: totrans-408
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_036.jpg)'
- en: Figure 4.36 – YAML pipeline executed
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.36 – 执行的 YAML 管道
- en: 'To add new tasks, it''s useful to use the assistant tool on the right of the
    editor frame. It allows you to have a **Tasks** list where you can search for
    a task, fill in the necessary parameters, and then have the final YAML definition:'
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: 若要添加新任务，使用编辑器框右侧的助手工具非常有用。它允许你查看**任务**列表，你可以在其中搜索任务，填写必要的参数，然后生成最终的 YAML 定义：
- en: '![Figure 4.37 – YAML pipeline task selection'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.37 – YAML 管道任务选择'
- en: '](img/B16392_04_037.jpg)'
  id: totrans-412
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_037.jpg)'
- en: Figure 4.37 – YAML pipeline task selection
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.37 – YAML 管道任务选择
- en: 'When you choose to create a pipeline with YAML, Azure DevOps creates a file
    that''s stored in the same repository that your code is stored in:'
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
  zh: 当你选择使用 YAML 创建管道时，Azure DevOps 会在与你的代码存储在同一代码库中创建一个文件：
- en: '![Figure 4.38 – YAML pipeline file created'
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.38 – 创建的 YAML 管道文件'
- en: '](img/B16392_04_038.jpg)'
  id: totrans-416
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_038.jpg)'
- en: Figure 4.38 – YAML pipeline file created
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.38 – 创建的 YAML 管道文件
- en: This file is under source control and versioned on every modification.
  id: totrans-418
  prefs: []
  type: TYPE_NORMAL
  zh: 这个文件在源控制下，并且每次修改时都会版本控制。
- en: 'For a complete reference to the YAML schema for a pipeline, I suggest following
    this link:'
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解管道的完整 YAML 模式，建议点击以下链接：
- en: '[https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema](https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema.)'
  id: totrans-420
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/zh-cn/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema](https://docs.microsoft.com/zh-cn/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema.)'
- en: Retention of builds
  id: totrans-421
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 构建保留
- en: When you run a pipeline, Azure DevOps logs each step's execution and stores
    the final artifacts and tests for each run.
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
  zh: 当你运行管道时，Azure DevOps 会记录每个步骤的执行情况，并存储每次运行的最终工件和测试结果。
- en: 'Azure DevOps has a default retention policy for pipeline execution of 30 days.
    You can change these default values by going to **Project settings** | **Pipelines**
    | **Settings**:'
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: Azure DevOps 对管道执行有一个默认的保留策略，保留时间为 30 天。你可以通过进入**项目设置** | **管道** | **设置**来更改这些默认值：
- en: '![Figure 4.39 – Pipeline retention policy'
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.39 – 管道保留策略'
- en: '](img/B16392_04_039.jpg)'
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_039.jpg)'
- en: Figure 4.39 – Pipeline retention policy
  id: totrans-426
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.39 – 管道保留策略
- en: 'You can also use the **Copy files** task to store your build and artifacts
    data in external storage so that you can preserve them for longer than what''s
    specified in the retention policy:'
  id: totrans-427
  prefs: []
  type: TYPE_NORMAL
  zh: 你还可以使用**复制文件**任务，将构建和工件数据存储到外部存储中，这样你就可以将它们保存得比保留策略中指定的时间更长：
- en: '![Figure 4.40 – Copy files task'
  id: totrans-428
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.40 – 复制文件任务'
- en: '](img/B16392_04_040.jpg)'
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_040.jpg)'
- en: Figure 4.40 – Copy files task
  id: totrans-430
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.40 – 复制文件任务
- en: 'The YAML definition for this task is as follows:'
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
  zh: 此任务的 YAML 定义如下：
- en: '[PRE112]'
  id: totrans-432
  prefs: []
  type: TYPE_PRE
  zh: '[PRE112]'
- en: '[PRE113]'
  id: totrans-433
  prefs: []
  type: TYPE_PRE
  zh: '[PRE113]'
- en: '[PRE114]'
  id: totrans-434
  prefs: []
  type: TYPE_PRE
  zh: '[PRE114]'
- en: '[PRE115]'
  id: totrans-435
  prefs: []
  type: TYPE_PRE
  zh: '[PRE115]'
- en: '[PRE116]'
  id: totrans-436
  prefs: []
  type: TYPE_PRE
  zh: '[PRE116]'
- en: '[PRE117]'
  id: totrans-437
  prefs: []
  type: TYPE_PRE
  zh: '[PRE117]'
- en: Important Note
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Remember that any data saved as artifacts with the **Publish Build Artifacts**
    task is periodically deleted.
  id: totrans-439
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，任何通过**发布构建构件**任务保存为构件的数据都会定期删除。
- en: 'More information about the **Copy files** task can be found here:'
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
  zh: 关于**复制文件**任务的更多信息，请参见此处：
- en: '[https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/copy-files?view=azure-devops&tabs=yaml](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/copy-files?view=azure-devops&tabs=yaml).'
  id: totrans-441
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/copy-files?view=azure-devops&tabs=yaml](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/copy-files?view=azure-devops&tabs=yaml)。'
- en: Multi-stage pipeline
  id: totrans-442
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 多阶段流水线
- en: As we explained previously, you can organize the jobs in your pipeline into
    `stages`. `Stages` are logical boundaries inside a pipeline flow (units of works
    that you can assign to an agent) that allow you to isolate the work, pause the
    pipeline, and execute checks or other actions. By default, every pipeline is composed
    of one stage, but you can create more than one and arrange those stages into a
    dependency graph.
  id: totrans-443
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们之前所解释的，您可以将流水线中的工作划分为`stages`。`Stages`是在流水线流程中的逻辑边界（可以分配给代理的工作单元），它们允许您隔离工作、暂停流水线并执行检查或其他操作。默认情况下，每个流水线由一个阶段组成，但您可以创建多个阶段，并将这些阶段安排成依赖图。
- en: 'The basic YAML definition of a multi-stage pipeline is as follows:'
  id: totrans-444
  prefs: []
  type: TYPE_NORMAL
  zh: 多阶段流水线的基本 YAML 定义如下：
- en: '[PRE118]'
  id: totrans-445
  prefs: []
  type: TYPE_PRE
  zh: '[PRE118]'
- en: '[PRE119]'
  id: totrans-446
  prefs: []
  type: TYPE_PRE
  zh: '[PRE119]'
- en: '[PRE120]'
  id: totrans-447
  prefs: []
  type: TYPE_PRE
  zh: '[PRE120]'
- en: '[PRE121]'
  id: totrans-448
  prefs: []
  type: TYPE_PRE
  zh: '[PRE121]'
- en: '[PRE122]'
  id: totrans-449
  prefs: []
  type: TYPE_PRE
  zh: '[PRE122]'
- en: '[PRE123]'
  id: totrans-450
  prefs: []
  type: TYPE_PRE
  zh: '[PRE123]'
- en: '[PRE124]'
  id: totrans-451
  prefs: []
  type: TYPE_PRE
  zh: '[PRE124]'
- en: '[PRE125]'
  id: totrans-452
  prefs: []
  type: TYPE_PRE
  zh: '[PRE125]'
- en: '[PRE126]'
  id: totrans-453
  prefs: []
  type: TYPE_PRE
  zh: '[PRE126]'
- en: '[PRE127]'
  id: totrans-454
  prefs: []
  type: TYPE_PRE
  zh: '[PRE127]'
- en: '[PRE128]'
  id: totrans-455
  prefs: []
  type: TYPE_PRE
  zh: '[PRE128]'
- en: '[PRE129]'
  id: totrans-456
  prefs: []
  type: TYPE_PRE
  zh: '[PRE129]'
- en: '[PRE130]'
  id: totrans-457
  prefs: []
  type: TYPE_PRE
  zh: '[PRE130]'
- en: '[PRE131]'
  id: totrans-458
  prefs: []
  type: TYPE_PRE
  zh: '[PRE131]'
- en: '[PRE132]'
  id: totrans-459
  prefs: []
  type: TYPE_PRE
  zh: '[PRE132]'
- en: '[PRE133]'
  id: totrans-460
  prefs: []
  type: TYPE_PRE
  zh: '[PRE133]'
- en: '[PRE134]'
  id: totrans-461
  prefs: []
  type: TYPE_PRE
  zh: '[PRE134]'
- en: '[PRE135]'
  id: totrans-462
  prefs: []
  type: TYPE_PRE
  zh: '[PRE135]'
- en: '[PRE136]'
  id: totrans-463
  prefs: []
  type: TYPE_PRE
  zh: '[PRE136]'
- en: As an example of how to create a multi-stage pipeline with YAML, let's look
    at a pipeline that builds code in your repository (with .NET Core SDK) and publishes
    the artifacts as NuGet packages. The pipeline definition is as follows. The pipeline
    uses the `stages` keyword to identify that this is a multi-stage pipeline.
  id: totrans-464
  prefs: []
  type: TYPE_NORMAL
  zh: 作为创建多阶段流水线的示例，假设我们有一个流水线，它使用 .NET Core SDK 在您的仓库中构建代码，并将构件发布为 NuGet 包。流水线定义如下。该流水线使用`stages`关键字来标识这是一个多阶段流水线。
- en: 'In the first stage definition (`Build`), we have the tasks for building the
    code:'
  id: totrans-465
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一阶段定义（`Build`）中，我们有用于构建代码的任务：
- en: '[PRE137]'
  id: totrans-466
  prefs: []
  type: TYPE_PRE
  zh: '[PRE137]'
- en: '[PRE138]'
  id: totrans-467
  prefs: []
  type: TYPE_PRE
  zh: '[PRE138]'
- en: '[PRE139]'
  id: totrans-468
  prefs: []
  type: TYPE_PRE
  zh: '[PRE139]'
- en: '[PRE140]'
  id: totrans-469
  prefs: []
  type: TYPE_PRE
  zh: '[PRE140]'
- en: '[PRE141]'
  id: totrans-470
  prefs: []
  type: TYPE_PRE
  zh: '[PRE141]'
- en: '[PRE142]'
  id: totrans-471
  prefs: []
  type: TYPE_PRE
  zh: '[PRE142]'
- en: '[PRE143]'
  id: totrans-472
  prefs: []
  type: TYPE_PRE
  zh: '[PRE143]'
- en: '[PRE144]'
  id: totrans-473
  prefs: []
  type: TYPE_PRE
  zh: '[PRE144]'
- en: '[PRE145]'
  id: totrans-474
  prefs: []
  type: TYPE_PRE
  zh: '[PRE145]'
- en: '[PRE146]'
  id: totrans-475
  prefs: []
  type: TYPE_PRE
  zh: '[PRE146]'
- en: '[PRE147]'
  id: totrans-476
  prefs: []
  type: TYPE_PRE
  zh: '[PRE147]'
- en: '[PRE148]'
  id: totrans-477
  prefs: []
  type: TYPE_PRE
  zh: '[PRE148]'
- en: '[PRE149]'
  id: totrans-478
  prefs: []
  type: TYPE_PRE
  zh: '[PRE149]'
- en: '[PRE150]'
  id: totrans-479
  prefs: []
  type: TYPE_PRE
  zh: '[PRE150]'
- en: '[PRE151]'
  id: totrans-480
  prefs: []
  type: TYPE_PRE
  zh: '[PRE151]'
- en: '[PRE152]'
  id: totrans-481
  prefs: []
  type: TYPE_PRE
  zh: '[PRE152]'
- en: '[PRE153]'
  id: totrans-482
  prefs: []
  type: TYPE_PRE
  zh: '[PRE153]'
- en: '[PRE154]'
  id: totrans-483
  prefs: []
  type: TYPE_PRE
  zh: '[PRE154]'
- en: '[PRE155]'
  id: totrans-484
  prefs: []
  type: TYPE_PRE
  zh: '[PRE155]'
- en: '[PRE156]'
  id: totrans-485
  prefs: []
  type: TYPE_PRE
  zh: '[PRE156]'
- en: '[PRE157]'
  id: totrans-486
  prefs: []
  type: TYPE_PRE
  zh: '[PRE157]'
- en: '[PRE158]'
  id: totrans-487
  prefs: []
  type: TYPE_PRE
  zh: '[PRE158]'
- en: '[PRE159]'
  id: totrans-488
  prefs: []
  type: TYPE_PRE
  zh: '[PRE159]'
- en: '[PRE160]'
  id: totrans-489
  prefs: []
  type: TYPE_PRE
  zh: '[PRE160]'
- en: '[PRE161]'
  id: totrans-490
  prefs: []
  type: TYPE_PRE
  zh: '[PRE161]'
- en: '[PRE162]'
  id: totrans-491
  prefs: []
  type: TYPE_PRE
  zh: '[PRE162]'
- en: '[PRE163]'
  id: totrans-492
  prefs: []
  type: TYPE_PRE
  zh: '[PRE163]'
- en: '[PRE164]'
  id: totrans-493
  prefs: []
  type: TYPE_PRE
  zh: '[PRE164]'
- en: '[PRE165]'
  id: totrans-494
  prefs: []
  type: TYPE_PRE
  zh: '[PRE165]'
- en: '[PRE166]'
  id: totrans-495
  prefs: []
  type: TYPE_PRE
  zh: '[PRE166]'
- en: 'Here, we installed the .NET Core SDK by using the **UseDotnet** standard task
    template that''s available in Azure DevOps (more information can be found here:
    [https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/dotnet-core-tool-installer?view=azure-devops)](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/dotnet-core-tool-installer?view=azure-devops)).
    After that, we restored the required NuGet packages and built the solution.'
  id: totrans-496
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们使用 Azure DevOps 中可用的**UseDotnet**标准任务模板安装了 .NET Core SDK（更多信息请参见：[https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/dotnet-core-tool-installer?view=azure-devops)](https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/tool/dotnet-core-tool-installer?view=azure-devops)）。之后，我们还原了所需的
    NuGet 包并构建了解决方案。
- en: 'Now, we have the task of creating the release version of the NuGet package.
    This package is saved in the packages/release folder of the artifact staging directory.
    Here, we will use `nobuild = true` because in this task, we do not have to rebuild
    the solution again (no more compilation):'
  id: totrans-497
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们需要创建 NuGet 包的发布版本。此包保存在构件暂存目录的 packages/release 文件夹中。在这里，我们将使用`nobuild
    = true`，因为在此任务中，我们不需要再次构建解决方案（不再进行编译）：
- en: '[PRE167]'
  id: totrans-498
  prefs: []
  type: TYPE_PRE
  zh: '[PRE167]'
- en: '[PRE168]'
  id: totrans-499
  prefs: []
  type: TYPE_PRE
  zh: '[PRE168]'
- en: '[PRE169]'
  id: totrans-500
  prefs: []
  type: TYPE_PRE
  zh: '[PRE169]'
- en: '[PRE170]'
  id: totrans-501
  prefs: []
  type: TYPE_PRE
  zh: '[PRE170]'
- en: '[PRE171]'
  id: totrans-502
  prefs: []
  type: TYPE_PRE
  zh: '[PRE171]'
- en: '[PRE172]'
  id: totrans-503
  prefs: []
  type: TYPE_PRE
  zh: '[PRE172]'
- en: '[PRE173]'
  id: totrans-504
  prefs: []
  type: TYPE_PRE
  zh: '[PRE173]'
- en: 'As the next step, we have the task of creating the prerelease version of the
    NuGet package. In this task, we''re using the `buildProperties` option to add
    the build number to the package version (for example, if the package version is
    2.0.0.0 and the build number is 20200521.1, the package version will be 2.0.0.0.20200521.1).
    Here, a build of the package is mandatory (for retrieving the build ID):'
  id: totrans-505
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来的步骤是创建 NuGet 包的预发布版本。在此任务中，我们使用`buildProperties`选项将构建号添加到包版本中（例如，如果包版本为 2.0.0.0，构建号为
    20200521.1，则包版本将为 2.0.0.0.20200521.1）。在这里，必须构建包（用于获取构建 ID）：
- en: '[PRE174]'
  id: totrans-506
  prefs: []
  type: TYPE_PRE
  zh: '[PRE174]'
- en: '[PRE175]'
  id: totrans-507
  prefs: []
  type: TYPE_PRE
  zh: '[PRE175]'
- en: '[PRE176]'
  id: totrans-508
  prefs: []
  type: TYPE_PRE
  zh: '[PRE176]'
- en: '[PRE177]'
  id: totrans-509
  prefs: []
  type: TYPE_PRE
  zh: '[PRE177]'
- en: '[PRE178]'
  id: totrans-510
  prefs: []
  type: TYPE_PRE
  zh: '[PRE178]'
- en: '[PRE179]'
  id: totrans-511
  prefs: []
  type: TYPE_PRE
  zh: '[PRE179]'
- en: '[PRE180]'
  id: totrans-512
  prefs: []
  type: TYPE_PRE
  zh: '[PRE180]'
- en: 'The next task publishes the package as an artifact:'
  id: totrans-513
  prefs: []
  type: TYPE_NORMAL
  zh: 下一任务将包发布为构件：
- en: '[PRE181]'
  id: totrans-514
  prefs: []
  type: TYPE_PRE
  zh: '[PRE181]'
- en: '[PRE182]'
  id: totrans-515
  prefs: []
  type: TYPE_PRE
  zh: '[PRE182]'
- en: 'Next, we need to define the second stage, called `PublishPrereleaseNuGetPackage`.
    Here, we skip the checkout of the repository and the download step downloads the
    `packages` artifact that we published in the previous build stage. Then, the `NuGetCommand`
    task publishes the prerelease package to an internal feed in Azure DevOps called
    `Test`:'
  id: totrans-516
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们需要定义第二阶段，称为`PublishPrereleaseNuGetPackage`。在这里，我们跳过仓库的检出步骤，下载步骤将下载我们在前一个构建阶段发布的`packages`构件。然后，`NuGetCommand`任务将预发布包发布到
    Azure DevOps 中的内部源，称为`Test`：
- en: '[PRE183]'
  id: totrans-517
  prefs: []
  type: TYPE_PRE
  zh: '[PRE183]'
- en: '[PRE184]'
  id: totrans-518
  prefs: []
  type: TYPE_PRE
  zh: '[PRE184]'
- en: '[PRE185]'
  id: totrans-519
  prefs: []
  type: TYPE_PRE
  zh: '[PRE185]'
- en: '[PRE186]'
  id: totrans-520
  prefs: []
  type: TYPE_PRE
  zh: '[PRE186]'
- en: '[PRE187]'
  id: totrans-521
  prefs: []
  type: TYPE_PRE
  zh: '[PRE187]'
- en: '[PRE188]'
  id: totrans-522
  prefs: []
  type: TYPE_PRE
  zh: '[PRE188]'
- en: '[PRE189]'
  id: totrans-523
  prefs: []
  type: TYPE_PRE
  zh: '[PRE189]'
- en: '[PRE190]'
  id: totrans-524
  prefs: []
  type: TYPE_PRE
  zh: '[PRE190]'
- en: '[PRE191]'
  id: totrans-525
  prefs: []
  type: TYPE_PRE
  zh: '[PRE191]'
- en: '[PRE192]'
  id: totrans-526
  prefs: []
  type: TYPE_PRE
  zh: '[PRE192]'
- en: '[PRE193]'
  id: totrans-527
  prefs: []
  type: TYPE_PRE
  zh: '[PRE193]'
- en: '[PRE194]'
  id: totrans-528
  prefs: []
  type: TYPE_PRE
  zh: '[PRE194]'
- en: '[PRE195]'
  id: totrans-529
  prefs: []
  type: TYPE_PRE
  zh: '[PRE195]'
- en: '[PRE196]'
  id: totrans-530
  prefs: []
  type: TYPE_PRE
  zh: '[PRE196]'
- en: '[PRE197]'
  id: totrans-531
  prefs: []
  type: TYPE_PRE
  zh: '[PRE197]'
- en: '[PRE198]'
  id: totrans-532
  prefs: []
  type: TYPE_PRE
  zh: '[PRE198]'
- en: '[PRE199]'
  id: totrans-533
  prefs: []
  type: TYPE_PRE
  zh: '[PRE199]'
- en: '[PRE200]'
  id: totrans-534
  prefs: []
  type: TYPE_PRE
  zh: '[PRE200]'
- en: '[PRE201]'
  id: totrans-535
  prefs: []
  type: TYPE_PRE
  zh: '[PRE201]'
- en: 'Now, we have to define the third stage, called `PublishReleaseNuGetPackage`,
    which creates the release version of our package for NuGet:'
  id: totrans-536
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们需要定义第三个阶段，称为`PublishReleaseNuGetPackage`，该阶段用于为 NuGet 创建我们的包的发布版本：
- en: '[PRE202]'
  id: totrans-537
  prefs: []
  type: TYPE_PRE
  zh: '[PRE202]'
- en: '[PRE203]'
  id: totrans-538
  prefs: []
  type: TYPE_PRE
  zh: '[PRE203]'
- en: '[PRE204]'
  id: totrans-539
  prefs: []
  type: TYPE_PRE
  zh: '[PRE204]'
- en: '[PRE205]'
  id: totrans-540
  prefs: []
  type: TYPE_PRE
  zh: '[PRE205]'
- en: '[PRE206]'
  id: totrans-541
  prefs: []
  type: TYPE_PRE
  zh: '[PRE206]'
- en: '[PRE207]'
  id: totrans-542
  prefs: []
  type: TYPE_PRE
  zh: '[PRE207]'
- en: '[PRE208]'
  id: totrans-543
  prefs: []
  type: TYPE_PRE
  zh: '[PRE208]'
- en: '[PRE209]'
  id: totrans-544
  prefs: []
  type: TYPE_PRE
  zh: '[PRE209]'
- en: '[PRE210]'
  id: totrans-545
  prefs: []
  type: TYPE_PRE
  zh: '[PRE210]'
- en: '[PRE211]'
  id: totrans-546
  prefs: []
  type: TYPE_PRE
  zh: '[PRE211]'
- en: '[PRE212]'
  id: totrans-547
  prefs: []
  type: TYPE_PRE
  zh: '[PRE212]'
- en: '[PRE213]'
  id: totrans-548
  prefs: []
  type: TYPE_PRE
  zh: '[PRE213]'
- en: '[PRE214]'
  id: totrans-549
  prefs: []
  type: TYPE_PRE
  zh: '[PRE214]'
- en: '[PRE215]'
  id: totrans-550
  prefs: []
  type: TYPE_PRE
  zh: '[PRE215]'
- en: '[PRE216]'
  id: totrans-551
  prefs: []
  type: TYPE_PRE
  zh: '[PRE216]'
- en: '[PRE217]'
  id: totrans-552
  prefs: []
  type: TYPE_PRE
  zh: '[PRE217]'
- en: '[PRE218]'
  id: totrans-553
  prefs: []
  type: TYPE_PRE
  zh: '[PRE218]'
- en: '[PRE219]'
  id: totrans-554
  prefs: []
  type: TYPE_PRE
  zh: '[PRE219]'
- en: '[PRE220]'
  id: totrans-555
  prefs: []
  type: TYPE_PRE
  zh: '[PRE220]'
- en: '[PRE221]'
  id: totrans-556
  prefs: []
  type: TYPE_PRE
  zh: '[PRE221]'
- en: This stage uses a deployment job to publish the package to the configured environment
    (here, this is called `nuget-org`). An environment is a collection of resources
    inside a pipeline.
  id: totrans-557
  prefs: []
  type: TYPE_NORMAL
  zh: 这个阶段使用部署作业将包发布到配置的环境（在这里，称为`nuget-org`）。环境是管道内资源的集合。
- en: In the `NuGetCommand` task, we specify the package to push and that the feed
    where we're pushing the package to is external (`nuGetFeedType`). The feed is
    retrieved by using the `publishFeedCredentials` property, set to the name of the
    service connection we created.
  id: totrans-558
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `NuGetCommand` 任务中，我们指定了要推送的包，并且指定了我们推送包的源是外部的（`nuGetFeedType`）。通过使用`publishFeedCredentials`属性来获取该源，该属性设置为我们创建的服务连接名称。
- en: 'For this stage, we have created a new environment:'
  id: totrans-559
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个阶段，我们创建了一个新的环境：
- en: '![Figure 4.41 – Creating a new environment'
  id: totrans-560
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.41 – 创建一个新环境'
- en: '](img/B16392_04_041.jpg)'
  id: totrans-561
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_041.jpg)'
- en: Figure 4.41 – Creating a new environment
  id: totrans-562
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.41 – 创建一个新环境
- en: 'Once the environment has been created, in order to publish it to NuGet, you
    need to create a new service connection by going to **Project Settings** | **Service
    Connections** | **Create Service Connection**, selecting **NuGet** from the list
    of available service connection types, and then configuring the connections according
    to your NuGet account:'
  id: totrans-563
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦环境创建完成，为了将其发布到 NuGet，您需要通过以下路径创建一个新的服务连接：**项目设置** | **服务连接** | **创建服务连接**，从可用服务连接类型的列表中选择**NuGet**，然后根据您的
    NuGet 账户配置连接：
- en: '![Figure 4.42 – New NuGet service connection'
  id: totrans-564
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.42 – 新的 NuGet 服务连接'
- en: '](img/B16392_04_042.jpg)'
  id: totrans-565
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_042.jpg)'
- en: Figure 4.42 – New NuGet service connection
  id: totrans-566
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.42 – 新的 NuGet 服务连接
- en: 'With that, we have created a multi-stage build pipeline. When the pipeline
    is executed and all the stages terminate successfully, you will see a results
    diagram that looks as follows:'
  id: totrans-567
  prefs: []
  type: TYPE_NORMAL
  zh: 至此，我们已经创建了一个多阶段构建管道。当管道执行并且所有阶段都成功终止时，您将看到如下所示的结果图：
- en: '![Figure 4.43 – Multi-stage build pipeline executed'
  id: totrans-568
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.43 – 执行的多阶段构建管道'
- en: '](img/B16392_04_043.jpg)'
  id: totrans-569
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_043.jpg)'
- en: Figure 4.43 – Multi-stage build pipeline executed
  id: totrans-570
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.43 – 执行的多阶段构建管道
- en: Now that we have understood what a multi-stage pipeline is, we'll create some
    pipelines with GitHub repositories in the next section.
  id: totrans-571
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经理解了什么是多阶段管道，接下来我们将在下一部分中使用 GitHub 仓库创建一些管道。
- en: Building a pipeline with GitHub repositories
  id: totrans-572
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 GitHub 仓库构建管道
- en: GitHub is one of the most popular platforms for source control management and
    often, it's quite common to have scenarios where the code is stored inside a GitHub
    repository and you want to use Azure DevOps for managing CI/CD.
  id: totrans-573
  prefs: []
  type: TYPE_NORMAL
  zh: GitHub 是最流行的源代码管理平台之一，通常情况下，会有许多场景，其中代码存储在 GitHub 仓库中，而您希望使用 Azure DevOps 来管理
    CI/CD。
- en: 'By using Azure DevOps and the Azure Pipeline service, you can also create pipelines
    for a repository stored on GitHub, thus triggering a build pipeline on every commit
    in a branch inside the GitHub repository. We will do this by following these steps:'
  id: totrans-574
  prefs: []
  type: TYPE_NORMAL
  zh: 通过使用 Azure DevOps 和 Azure Pipeline 服务，您还可以为存储在 GitHub 上的仓库创建管道，从而在 GitHub 仓库的每次提交时触发构建管道。我们将通过以下步骤来实现：
- en: To use Azure Pipelines to build your GitHub repository, you need to add the
    `Azure Pipelines`. Select the **Azure Pipelines** extension and click on **Set
    up a plan**, as shown in the following screenshot:![Figure 4.44 – Azure Pipelines
    on GitHub – setup
  id: totrans-575
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要使用 Azure Pipelines 构建您的 GitHub 仓库，您需要添加`Azure Pipelines`。选择**Azure Pipelines**扩展并点击**设置计划**，如以下截图所示：![图
    4.44 – GitHub 上的 Azure Pipelines – 设置
- en: '](img/B16392_04_044.jpg)'
  id: totrans-576
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_044.jpg)'
- en: Figure 4.44 – Azure Pipelines on GitHub – setup
  id: totrans-577
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 4.44 – GitHub 上的 Azure Pipelines – 设置
- en: Select the **Free** plan, click the **Install it for free** button, and then
    click **Complete order and begin installation**.
  id: totrans-578
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**免费**计划，点击**免费安装**按钮，然后点击**完成订单并开始安装**。
- en: Now, the Azure Pipelines installation will ask you if this app should be available
    for all your repositories or only for selected repositories. Select the desired
    option and click on **Install**:![Figure 4.45 – Azure Pipelines on GitHub – installation
  id: totrans-579
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，Azure Pipelines 安装程序会询问您该应用程序是否应该对所有仓库可用，还是仅对选定的仓库可用。选择所需的选项，然后点击**安装**：![图
    4.45 – GitHub 上的 Azure Pipelines – 安装
- en: '](img/B16392_04_045.jpg)'
  id: totrans-580
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_045.jpg)'
- en: Figure 4.45 – Azure Pipelines on GitHub – installation
  id: totrans-581
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 4.45 – GitHub 上的 Azure Pipelines – 安装
- en: You will now be redirected to Azure DevOps, where you can create a new project
    (or select an existing one) for handling the build process. Here, I'm going to
    create a new project:![Figure 4.46 – Setting up your Azure Pipelines project](img/B16392_04_046.jpg)
  id: totrans-582
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您现在将被重定向到Azure DevOps，在那里您可以创建一个新项目（或选择现有项目）来处理构建过程。在这里，我将创建一个新项目：![图4.46 –
    设置您的Azure Pipelines项目](img/B16392_04_046.jpg)
- en: Figure 4.46 – Setting up your Azure Pipelines project
  id: totrans-583
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图4.46 – 设置您的Azure Pipelines项目
- en: Now, you need to authorize Azure Pipelines so that it can access your GitHub
    account:![Figure 4.47 – Authorizing Azure Pipelines to access GitHub
  id: totrans-584
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，您需要授权Azure Pipelines以访问您的GitHub账户：![图4.47 – 授权Azure Pipelines访问GitHub
- en: '](img/B16392_04_047.jpg)'
  id: totrans-585
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_047.jpg)'
- en: Figure 4.47 – Authorizing Azure Pipelines to access GitHub
  id: totrans-586
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图4.47 – 授权Azure Pipelines访问GitHub
- en: 'When the necessary authorization is given, the project will be created for
    you on Azure DevOps and the pipeline creation process will start. You''ll be immediately
    prompted to select a GitHub repository for the build from the list of available
    GitHub repositories in your account:'
  id: totrans-587
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 给定必要的授权后，将为您在Azure DevOps上创建项目，并启动管道创建过程。您将立即被提示从账户中的可用GitHub存储库列表中选择一个用于构建的GitHub存储库：
- en: '![Figure 4.48 – Selecting a GitHub repository'
  id: totrans-588
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图4.48 – 选择GitHub存储库'
- en: '](img/B16392_04_048.jpg)'
  id: totrans-589
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_048.jpg)'
- en: Figure 4.48 – Selecting a GitHub repository
  id: totrans-590
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图4.48 – 选择GitHub存储库
- en: Here, I'm selecting a repository where I have an Azure Function project. As
    you can see, Azure Pipelines has recognized my project and proposed a set of available
    templates for the pipeline (but you can also start from a blank template or from
    a YAML file that you have in any branch of the repository). Here, I will select
    `azure-pipelines.yml`) inside your GitHub repository:![Figure 4.50 – multi.stage
    YAML pipeline definition
  id: totrans-591
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在这里，我正在选择一个我有Azure函数项目的存储库。正如您所见，Azure Pipelines已识别出我的项目，并为管道提供了一组可用模板（但您也可以从空白模板或存储库任何分支中的YAML文件开始）。在这里，我将选择`azure-pipelines.yml`)
    在您的GitHub存储库内：![图4.50 – 多阶段YAML管道定义
- en: '](img/B16392_04_050.jpg)'
  id: totrans-592
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_050.jpg)'
- en: Figure 4.50 – multi.stage YAML pipeline definition
  id: totrans-593
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图4.50 – 多阶段YAML管道定义
- en: This pipeline is triggered on every commit on the master branch.
  id: totrans-594
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此管道在主分支上的每次提交时触发。
- en: Click the **Save and run** button. Here, the pipeline will be queued and waiting
    for an agent, then executed.
  id: totrans-595
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击**保存并运行**按钮。在这里，管道将排队等待一个代理，然后执行。
- en: Every time you commit code inside your GitHub repository, the build pipeline
    on Azure DevOps will be triggered automatically.
  id: totrans-596
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 每次在您的GitHub存储库中提交代码时，Azure DevOps上的构建管道将自动触发。
- en: If you're building a public repository on GitHub, it's quite useful to show
    all your users that the code inside this repository has been checked and tested
    with a build pipeline. Then, you can show the result of the build. You can do
    that by placing a badge in your repository.
  id: totrans-597
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您在GitHub上构建一个公共存储库，展示这个存储库中的代码已经通过构建管道检查和测试是非常有用的。然后，您可以展示构建的结果。您可以通过在存储库中放置一个徽章来实现这一点。
- en: A badge is a dynamically generated image that reflects the status of a build
    (never built, success, or fail) and it's hosted on Azure DevOps.
  id: totrans-598
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 徽章是一个动态生成的图像，反映了构建的状态（从未构建、成功或失败），并且它托管在Azure DevOps上。
- en: To do so, select your pipeline in Azure DevOps, click on the three dots on the
    right, and select **Status badge**:![Figure 4.51 – Status badge definition
  id: totrans-599
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为此，请在Azure DevOps中选择您的管道，在右侧点击三个点，然后选择**状态徽章**：![图4.51 – 状态徽章定义
- en: '](img/B16392_04_051.jpg)'
  id: totrans-600
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_04_051.jpg)'
- en: Figure 4.51 – Status badge definition
  id: totrans-601
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图4.51 – 状态徽章定义
- en: 'From here, you can copy the `Readme.md` file on your GitHub repository:'
  id: totrans-602
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从这里，您可以复制`Readme.md`文件到您的GitHub存储库中：
- en: '![Figure 4.52 – Build status badge markdown'
  id: totrans-603
  prefs: []
  type: TYPE_NORMAL
  zh: '![图4.52 – 构建状态徽章markdown'
- en: '](img/B16392_04_052.jpg)'
  id: totrans-604
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_052.jpg)'
- en: Figure 4.52 – Build status badge markdown
  id: totrans-605
  prefs: []
  type: TYPE_NORMAL
  zh: 图4.52 – 构建状态徽章markdown
- en: 'Every time a user accesses your repository, they will be able to see the status
    of the latest build via a graphical badge:'
  id: totrans-606
  prefs: []
  type: TYPE_NORMAL
  zh: 每当用户访问您的存储库时，他们将能够通过图形徽章看到最新构建的状态：
- en: '![Figure 4.53 – Build pipeline Status badge'
  id: totrans-607
  prefs: []
  type: TYPE_NORMAL
  zh: '![图4.53 – 构建管道状态徽章'
- en: '](img/B16392_04_053.jpg)'
  id: totrans-608
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_053.jpg)'
- en: Figure 4.53 – Build pipeline Status badge
  id: totrans-609
  prefs: []
  type: TYPE_NORMAL
  zh: 图4.53 – 构建管道状态徽章
- en: Next, let's look at how to execute jobs in parallel.
  id: totrans-610
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，让我们看看如何并行执行作业。
- en: Executing jobs in parallel in an Azure Pipeline
  id: totrans-611
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在Azure Pipeline中并行执行作业
- en: Within an Azure Pipeline, you can also execute jobs in parallel. Each job can
    be independent of other jobs and can also be executed on a different agent. This
    will allow you to speed up your build time and improve your pipeline's performance.
  id: totrans-612
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure 流水线中，你还可以并行执行任务。每个任务可以独立于其他任务执行，也可以在不同的代理上执行。这将帮助你加速构建时间并提高流水线的性能。
- en: As an example of how to handle parallel jobs in a pipeline, consider a simple
    pipeline where you have to execute three PowerShell scripts called **Task 1**,
    **Task 2**, and **Final Task**. **Task 1** and **Task 2** can be executed in parallel,
    while **Final Task** can only be executed when the previous two tasks are completed.
  id: totrans-613
  prefs: []
  type: TYPE_NORMAL
  zh: 作为如何在流水线中处理并行任务的示例，考虑一个简单的流水线，其中你需要执行三个 PowerShell 脚本，分别叫做**任务 1**、**任务 2**和**最终任务**。**任务
    1**和**任务 2**可以并行执行，而**最终任务**只能在前两个任务完成后执行。
- en: 'When you start creating a new pipeline (I''m using the classic editor here
    for simplicity), Azure DevOps creates an agent job (here, this is called **Agent
    Job 1**). You can add your task to this agent. By selecting the agent job, you
    can specify the agent pool where this task runs. Here, I want this task to be
    executed on a Microsoft-hosted agent pool:'
  id: totrans-614
  prefs: []
  type: TYPE_NORMAL
  zh: 当你开始创建一个新的流水线时（为了简单起见，我这里使用经典编辑器），Azure DevOps 会创建一个代理任务（这里称为**代理任务 1**）。你可以将任务添加到此代理上。通过选择代理任务，你可以指定该任务运行的代理池。在这里，我希望这个任务在
    Microsoft 托管的代理池上执行：
- en: '![Figure 4.54 – Agent specification'
  id: totrans-615
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.54 – 代理规格'
- en: '](img/B16392_04_054.jpg)'
  id: totrans-616
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_054.jpg)'
- en: Figure 4.54 – Agent specification
  id: totrans-617
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.54 – 代理规格
- en: 'Then, to add a new agent pool to your pipeline (for executing the other task
    independently), click the three dots beside the pipeline and select **Add an agent
    job**:'
  id: totrans-618
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，为了将新的代理池添加到你的流水线中（用于独立执行其他任务），点击流水线旁边的三个点并选择**添加代理任务**：
- en: '![Figure 4.55 – Add an agent job'
  id: totrans-619
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.55 – 添加代理任务'
- en: '](img/B16392_04_055.jpg)'
  id: totrans-620
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_055.jpg)'
- en: Figure 4.55 – Add an agent job
  id: totrans-621
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.55 – 添加代理任务
- en: 'Now, we''ll add a second agent job (here, this is called **Agent job 2**) that
    runs on a self-hosted agent. This job will execute the **Task 2** PowerShell script:'
  id: totrans-622
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们将添加第二个代理任务（这里称为**代理任务 2**），它运行在自托管代理上。这个任务将执行**任务 2**的 PowerShell 脚本：
- en: '![Figure 4.56 – Agent selection'
  id: totrans-623
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.56 – 代理选择'
- en: '](img/B16392_04_056.jpg)'
  id: totrans-624
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_056.jpg)'
- en: Figure 4.56 – Agent selection
  id: totrans-625
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.56 – 代理选择
- en: 'Finally, we''ll add a new agent job (here, this is called **Agent Job 3)**
    to execute the **Final Task** that will run on a Microsoft-hosted agent. However,
    this job has dependencies from **Agent Job 1** and **Agent Job 2**:'
  id: totrans-626
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们将添加一个新的代理任务（这里称为**代理任务 3**），来执行将在 Microsoft 托管代理上运行的**最终任务**。然而，这个任务依赖于**代理任务
    1**和**代理任务 2**：
- en: '![Figure 4.57 – Agent job dependencies'
  id: totrans-627
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 4.57 – 代理任务依赖关系'
- en: '](img/B16392_04_057.jpg)'
  id: totrans-628
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_04_057.jpg)'
- en: Figure 4.57 – Agent job dependencies
  id: totrans-629
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4.57 – 代理任务依赖关系
- en: In this way, the first two tasks start in parallel and the final job will wait
    until the two previous tasks are executed.
  id: totrans-630
  prefs: []
  type: TYPE_NORMAL
  zh: 这样，前两个任务将并行启动，最终任务将在前两个任务执行完毕后开始执行。
- en: 'For more information about parallel jobs in an Azure pipeline, I recommend
    that you check out this page:'
  id: totrans-631
  prefs: []
  type: TYPE_NORMAL
  zh: 关于 Azure 流水线中的并行任务，建议你查看以下页面以获取更多信息：
- en: '[https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml)'
  id: totrans-632
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml](https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml)'
- en: Agents on Azure Container Instances
  id: totrans-633
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 运行在 Azure 容器实例上的代理
- en: If standard Microsoft-hosted agents don't fit your needs (requirements, performance,
    and so on), there's also the possibility to create a self-hosted agent for Azure
    DevOps that runs inside a Docker container on the **Azure Container Instances**
    (**ACI**) service.
  id: totrans-634
  prefs: []
  type: TYPE_NORMAL
  zh: 如果标准的 Microsoft 托管代理无法满足你的需求（例如要求、性能等），你还可以为 Azure DevOps 创建一个自托管代理，该代理在**Azure
    容器实例**（**ACI**）服务中的 Docker 容器内运行。
- en: You can create a build agent running on Azure Container Instances by using a
    custom image or by reusing one of Microsoft's available images.pipe
  id: totrans-635
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过使用自定义镜像或重新使用 Microsoft 提供的镜像来创建一个运行在 Azure 容器实例上的构建代理。
- en: To create a build agent running on ACI, you need to create a **personal access
    token** for your Azure DevOps organization. To do so, from your Azure DevOps organization
    home page, open the user settings (top-right corner) and select **Personal access
    tokens**.
  id: totrans-636
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建一个运行在 ACI 上的构建代理，你需要为你的 Azure DevOps 组织创建一个**个人访问令牌**。为此，请从你的 Azure DevOps
    组织主页，打开用户设置（右上角），然后选择**个人访问令牌**。
- en: 'When you have the personal access token for your agent, you can create an agent
    on ACI by executing the following command from the Azure CLI (after connecting
    to your Azure subscription):'
  id: totrans-637
  prefs: []
  type: TYPE_NORMAL
  zh: 当您拥有代理的个人访问令牌时，您可以通过执行以下命令从 Azure CLI 创建 ACI 上的代理（连接到 Azure 订阅后）：
- en: '[PRE222]'
  id: totrans-638
  prefs: []
  type: TYPE_PRE
  zh: '[PRE222]'
- en: 'Here, we have the following:'
  id: totrans-639
  prefs: []
  type: TYPE_NORMAL
  zh: 这里我们有以下内容：
- en: '`RESOURCE_GROUP_NAME` is the name of your resource group in Azure where this
    resource will be created.'
  id: totrans-640
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`RESOURCE_GROUP_NAME` 是您在 Azure 中创建此资源时所用的资源组名称。'
- en: '`CONTAINER_NAME` is the name of the ACI container.'
  id: totrans-641
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`CONTAINER_NAME` 是 ACI 容器的名称。'
- en: '`AZURE_DEVOPS_ACCOUNT_NAME` is the name of your Azure DevOps account.'
  id: totrans-642
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AZURE_DEVOPS_ACCOUNT_NAME` 是您的 Azure DevOps 账户名称。'
- en: '`PERSONAL_ACCESS_TOKEN` is the personal access token you created previously.'
  id: totrans-643
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PERSONAL_ACCESS_TOKEN` 是您之前创建的个人访问令牌。'
- en: '`AGENT_NAME` is the name of the build agent that you want to create. This will
    be displayed on Azure DevOps.'
  id: totrans-644
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AGENT_NAME` 是您要创建的构建代理的名称。它将显示在 Azure DevOps 上。'
- en: 'In this command, there are also other two important parameters:'
  id: totrans-645
  prefs: []
  type: TYPE_NORMAL
  zh: 在此命令中，还有另外两个重要参数：
- en: '`--image` is used to select the name of the Azure Pipelines image for creating
    your agent, as described here: [https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent).'
  id: totrans-646
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--image` 用于选择用于创建代理的 Azure Pipelines 镜像名称，具体描述请参见此处：[https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent](https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent)。'
- en: '`VSTS_POOL` is used to select the agent pool for your build agent.'
  id: totrans-647
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`VSTS_POOL` 用于选择构建代理的代理池。'
- en: Remember that you can start and stop an ACI instance by using the `az container
    stop` and `az container start` commands. This can help you save money.
  id: totrans-648
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，您可以通过使用 `az container stop` 和 `az container start` 命令来启动和停止 ACI 实例。这可以帮助您节省开支。
- en: Using container jobs in Azure Pipelines
  id: totrans-649
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 Azure Pipelines 中使用容器作业
- en: In this chapter, we saw that when you create a pipeline, you define jobs, and
    that when the pipeline is executed, these jobs runs on the host machine where
    the agent is installed.
  id: totrans-650
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们看到，当您创建管道时，您会定义作业，并且当管道执行时，这些作业将在安装代理的主机上运行。
- en: If you're using Windows or Linux agents, you can also run a job inside a container
    (in an isolated way from the host). To run a job inside a container, you need
    to have Docker installed on the agent and your pipeline must have permission to
    access the Docker daemon. If you're using Microsoft-hosted agents, running jobs
    in containers is actually supported on the `windows-2019` and `ubuntu-16.04` pool
    images.
  id: totrans-651
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您使用的是 Windows 或 Linux 代理，您还可以在容器中运行作业（与主机隔离）。要在容器中运行作业，您需要在代理上安装 Docker，并且您的管道必须具有访问
    Docker 守护程序的权限。如果您使用的是 Microsoft 托管的代理，实际上在 `windows-2019` 和 `ubuntu-16.04` 池镜像中支持在容器中运行作业。
- en: 'As an example, this is a YAML definition for using a container job in a Windows
    pipeline:'
  id: totrans-652
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，这是一个在 Windows 管道中使用容器作业的 YAML 定义：
- en: '[PRE223]'
  id: totrans-653
  prefs: []
  type: TYPE_PRE
  zh: '[PRE223]'
- en: '[PRE224]'
  id: totrans-654
  prefs: []
  type: TYPE_PRE
  zh: '[PRE224]'
- en: '[PRE225]'
  id: totrans-655
  prefs: []
  type: TYPE_PRE
  zh: '[PRE225]'
- en: '[PRE226]'
  id: totrans-656
  prefs: []
  type: TYPE_PRE
  zh: '[PRE226]'
- en: '[PRE227]'
  id: totrans-657
  prefs: []
  type: TYPE_PRE
  zh: '[PRE227]'
- en: '[PRE228]'
  id: totrans-658
  prefs: []
  type: TYPE_PRE
  zh: '[PRE228]'
- en: '[PRE229]'
  id: totrans-659
  prefs: []
  type: TYPE_PRE
  zh: '[PRE229]'
- en: '[PRE230]'
  id: totrans-660
  prefs: []
  type: TYPE_PRE
  zh: '[PRE230]'
- en: '[PRE231]'
  id: totrans-661
  prefs: []
  type: TYPE_PRE
  zh: '[PRE231]'
- en: As we mentioned previously, to run a job inside a Windows container, you need
    to use the `windows-2019` image pool. It's required that the kernel version of
    the host and the container match, so here, we're using the `ltsc2019` tag to retrieve
    the container's image.
  id: totrans-662
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们之前提到的，要在 Windows 容器中运行作业，您需要使用 `windows-2019` 镜像池。要求主机和容器的内核版本匹配，因此在这里，我们使用
    `ltsc2019` 标签来获取容器的镜像。
- en: 'For a Linux-based pipeline, you need to use the `ubuntu-16.04` image:'
  id: totrans-663
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基于 Linux 的管道，您需要使用 `ubuntu-16.04` 镜像：
- en: '[PRE232]'
  id: totrans-664
  prefs: []
  type: TYPE_PRE
  zh: '[PRE232]'
- en: '[PRE233]'
  id: totrans-665
  prefs: []
  type: TYPE_PRE
  zh: '[PRE233]'
- en: '[PRE234]'
  id: totrans-666
  prefs: []
  type: TYPE_PRE
  zh: '[PRE234]'
- en: '[PRE235]'
  id: totrans-667
  prefs: []
  type: TYPE_PRE
  zh: '[PRE235]'
- en: '[PRE236]'
  id: totrans-668
  prefs: []
  type: TYPE_PRE
  zh: '[PRE236]'
- en: As you can see, the pipeline creates a container based on the selected image
    and runs the command (steps) inside that container.
  id: totrans-669
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所见，管道根据所选镜像创建一个容器，并在该容器内运行命令（步骤）。
- en: Summary
  id: totrans-670
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we provided an overview of the Azure Pipelines service and
    we saw how to implement a CI/CD process by using Azure DevOps. We also saw how
    to create a pipeline for code hosted in a repository by using the graphical interface
    and by using YAML, as well as how to use and create build agents. We then looked
    at how to create a build pipeline by using the classic editor and by using a YAML
    definition. We also saw an example of a multi-stage pipeline and how to use Azure
    DevOps pipelines to build code inside a GitHub repository, before looking at how
    to use parallel tasks in a build pipeline to improve build performance. Finally,
    we learned how to create a build agent on Azure Container Instances and how to
    use a container's jobs.
  id: totrans-671
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们概述了 Azure Pipelines 服务，并展示了如何使用 Azure DevOps 实现 CI/CD 流程。我们还展示了如何通过图形界面和
    YAML 创建托管在仓库中的代码流水线，以及如何使用和创建构建代理。接着，我们了解了如何使用经典编辑器和 YAML 定义创建构建流水线。我们还展示了一个多阶段流水线的示例，以及如何使用
    Azure DevOps 流水线在 GitHub 仓库中构建代码，随后学习了如何在构建流水线中使用并行任务来提高构建性能。最后，我们学习了如何在 Azure
    容器实例中创建构建代理，并如何使用容器的作业。
- en: In the next chapter, we'll learn how to execute quality tests for our code base
    in a build pipeline.
  id: totrans-672
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章，我们将学习如何在构建流水线中执行代码库的质量测试。
