<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer231">&#13;
			<p id="_idParaDest-127" class="chapter-number"><a id="_idTextAnchor140"/>Chapter 6:</p>&#13;
			<h1 id="_idParaDest-128"><a id="_idTextAnchor141"/>Hosting Your Own Azure Pipeline Agent</h1>&#13;
			<p>In the previous two chapters, we looked at setting up continuous integration through Azure Pipelines while using Microsoft-hosted agents. In this chapter, we'll be building a self-hosted agent and updating the pipeline to use our own agent, rather than using the Microsoft-hosted one.</p>&#13;
			<p>We will first look at the types of pipeline agents available and then dive into the technical specifications of setting up the agent pools. We will also look at how you can use VM scale sets for large-scale Azure DevOps projects.</p>&#13;
			<p>We'll be covering the following topics: </p>&#13;
			<ul>&#13;
				<li>Azure pipeline agent overview</li>&#13;
				<li>Understanding the types of agents in Azure Pipelines</li>&#13;
				<li>Planning and setting up your own pipeline agent in Azure</li>&#13;
				<li>Updating your Azure pipeline to use your self-hosted agent</li>&#13;
				<li>Using containers as your self-hosted agents</li>&#13;
				<li>Planning for scale – using Azure VM scale sets as self-hosted agents</li>&#13;
			</ul>&#13;
			<h1 id="_idParaDest-129"><a id="_idTextAnchor142"/>Technical requirements</h1>&#13;
			<p>To follow this chapter, you need to have an active Azure DevOps organization and an Azure subscription to create a VM. </p>&#13;
			<p><strong class="bold">Getting the project pre-requisites ready</strong>: This section requires you to have the <strong class="bold">PartsUnlimited</strong> project ready in your own DevOps organization. If you are continuing from the previous chapter, <a href="B16392_05_Final_JM_ePub.xhtml#_idTextAnchor123"><em class="italic">Chapter 5</em></a>, <em class="italic">Running Quality Tests in a Build Pipeline</em>, you should have it already.</p>&#13;
			<p>If you do not have the project ready in your DevOps org, you can import it using Azure DevOps Demo Generator – <a href="https://azuredevopsdemogenerator.azurewebsites.net/">https://azuredevopsdemogenerator.azurewebsites.net/</a>:</p>&#13;
			<ol>&#13;
				<li>Log in to the <strong class="bold">Azure DevOps Demo Generator</strong> website.</li>&#13;
				<li>Enter a project name and select your <strong class="bold">DevOps organization</strong>. </li>&#13;
				<li>Click on <strong class="bold">Choose Template</strong> and find <strong class="bold">PartsUnlimited</strong>.</li>&#13;
				<li>Once you're ready, click <strong class="bold">Create Project</strong>: <div id="_idContainer200" class="IMG---Figure"><img src="Images/Figure_6.01_B16392.jpg" alt="Figure 6.1 – Creating a sample DevOps project&#13;&#10;"/></div><p class="figure-caption">Figure 6.1 – Creating a sample DevOps project</p><p>It will take a couple of minutes for the project to be imported; you can monitor the progress using the progress bar displayed.</p></li>&#13;
				<li>Upon completion, click on <strong class="bold">Navigate to project</strong>:</li>&#13;
			</ol>&#13;
			<div>&#13;
				<div id="_idContainer201" class="IMG---Figure">&#13;
					<img src="Images/Figure_6.02_B16392.jpg" alt="Figure 6.2 – Project successfully created&#13;&#10;"/>&#13;
				</div>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 6.2 – Project successfully created</p>&#13;
			<p>We'll be using this project throughout this chapter.</p>&#13;
			<h1 id="_idParaDest-130"><a id="_idTextAnchor143"/>Azure pipeline agent overview</h1>&#13;
			<p>An Azure pipeline <a id="_idIndexMarker416"/>agent is the component responsible for executing the tasks defined in the pipeline definition. This agent typically runs inside a VM or container and includes the pre-requisites required for the pipeline to run successfully. </p>&#13;
			<p>In most cases, you'll need to have an agent in order to run the pipeline. As your project size and the number of developers grows, you will need to have more agents to support the scale. </p>&#13;
			<p>Each execution of a pipeline initiates a job on one of the agents, and one agent can only run one job at a time. Azure pipeline agents can be hosted in the cloud or on-premises in one of the following compute infrastructures:</p>&#13;
			<ul>&#13;
				<li>Server or client host (physical or virtual)</li>&#13;
				<li>Containers</li>&#13;
				<li>Azure VM scale sets (preview)</li>&#13;
			</ul>&#13;
			<p>Azure pipeline <a id="_idIndexMarker417"/>agents are grouped into <strong class="bold">agent pools</strong>. You can create as many agent pools as you require.</p>&#13;
			<p class="callout-heading">Important note</p>&#13;
			<p class="callout">Azure Pipelines <a id="_idIndexMarker418"/>supports running basic tasks, such as invoking the REST API or Azure Function without the need to have any agents. Please refer to <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&amp;tabs=yaml#server-jobs">https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&amp;tabs=yaml#server-jobs</a> for more details about agentless execution of Azure Pipelines. </p>&#13;
			<h1 id="_idParaDest-131"><a id="_idTextAnchor144"/>Understanding the types of agents in Azure Pipelines</h1>&#13;
			<p>Azure <a id="_idIndexMarker419"/>Pipelines offers two types of agents: </p>&#13;
			<ul>&#13;
				<li>Microsoft-hosted agents</li>&#13;
				<li>Self-hosted agents</li>&#13;
			</ul>&#13;
			<p>Let's look at them in detail.</p>&#13;
			<h2 id="_idParaDest-132"><a id="_idTextAnchor145"/>Microsoft-hosted agents</h2>&#13;
			<p>Microsoft-hosted <a id="_idIndexMarker420"/>agents are fully managed VMs, deployed <a id="_idIndexMarker421"/>and managed by Microsoft. You can choose to use a Microsoft-hosted agent with no additional pre-requisites or configurations. Microsoft-hosted agents are the simplest and are available at no additional cost. </p>&#13;
			<p>Every time you execute a pipeline, you get a new VM for running the job, and it's discarded after one use. </p>&#13;
			<h2 id="_idParaDest-133"><a id="_idTextAnchor146"/>Self-hosted agents</h2>&#13;
			<p>Self-hosted <a id="_idIndexMarker422"/>agents are servers owned by you, running in any cloud platform or data center <a id="_idIndexMarker423"/>owned by you. Self-hosted agents are preferred due to various reasons, including security, scalability, and performance. </p>&#13;
			<p>You can configure your self-hosted agent to have the dependencies pre-installed, which will help you decrease the time for your pipeline execution.</p>&#13;
			<p>Choosing <a id="_idIndexMarker424"/>between a Microsoft-hosted agent and self-hosted agents depends on various factors, such as the following:</p>&#13;
			<ul>&#13;
				<li>The size of the code base</li>&#13;
				<li>The number of developers</li>&#13;
				<li>The build and release frequency</li>&#13;
				<li>The dependencies and packages required for the build process</li>&#13;
				<li>Security and compliance requirements</li>&#13;
				<li>Performance </li>&#13;
			</ul>&#13;
			<p>If your code base is small and the build pipeline is optimized, it's better to use Microsoft-hosted agents as it won't take much time to download all the dependencies on the fly. However, if you have a large code base with numerous amounts of dependencies, using a self-hosted agent will be a better option as you can eliminate various build pre-creation tasks from the pipeline by configuring them in your self-hosted environment in advance. Self-hosted agents would be the only option in the case of highly secure and customized build pipelines that interact with other services running in your network. If you need more CPU and memory <a id="_idIndexMarker425"/>than what is provided with Microsoft-hosted agents, you can use self-hosted agents with your customized sizing.</p>&#13;
			<p>It is <a id="_idIndexMarker426"/>recommended to start with Microsoft-hosted agents and move to self-hosted at a later stage when the Microsoft-hosted agents become a bottleneck in your build and release process. </p>&#13;
			<h1 id="_idParaDest-134"><a id="_idTextAnchor147"/>Planning and setting up your self-hosted Azure pipeline agent </h1>&#13;
			<p>In order <a id="_idIndexMarker427"/>to use a self-hosted agent with Azure Pipelines, you <a id="_idIndexMarker428"/>will need to set up a machine <a id="_idIndexMarker429"/>and configure it for your pipeline <a id="_idIndexMarker430"/>requirements. Typically, you would choose an OS version best suited for your project, considering the framework, libraries, and build tools compatibility.</p>&#13;
			<p>For the purpose of this demonstration, we'll be setting up a VM in Azure and will configure it to use a self-hosted agent. You can choose to host your agent server in any cloud or on-premises environment. </p>&#13;
			<h2 id="_idParaDest-135"><a id="_idTextAnchor148"/>Choosing the right OS/image for the agent VM</h2>&#13;
			<p>The first <a id="_idIndexMarker431"/>decision you take while setting up the VM is choosing the OS/image for the server depending on your target deployment. If you are deploying in an on-premises environment, you may just select one of the supported OS versions (such as Windows Server 2016) and install the necessary software. In the case of cloud deployments, you have multiple options provided in the form of images, which come in various combinations of OS version and pre-installed tools.</p>&#13;
			<p>It is advised that you have the agent VM specifications planned with your developers to have them best suited for your project needs. Here is a recommended approach:</p>&#13;
			<ol>&#13;
				<li value="1">Identify whether your application is built to run on Windows, Linux, or macOS. If it's cross-platform, choose the one that runs it best and has support for the build tools you're using. </li>&#13;
				<li>List down the underlying frameworks and external libraries/components used with their versions.</li>&#13;
				<li>Select the latest version of the OS version from the top-level OS selected in <em class="italic">step 1</em>.</li>&#13;
				<li>Identify <a id="_idIndexMarker432"/>whether it is compatible and supported by the <strong class="bold">original equipment manufacturers</strong> (<strong class="bold">OEMs</strong>) for all the dependencies listed in <em class="italic">step 2</em>.</li>&#13;
				<li>Keep going one version down at a time and select the one that is compatible for all the required dependencies for your project.</li>&#13;
			</ol>&#13;
			<p>Based on the specifications identified in this process, you can choose to start with a vanilla OS and install your required frameworks and build tools, or choose a pre-created image in the cloud.</p>&#13;
			<h2 id="_idParaDest-136"><a id="_idTextAnchor149"/>OS support and pre-requisites for installing an Azure Pipelines agent</h2>&#13;
			<p>Azure <a id="_idIndexMarker433"/>supports various OS versions to use as a self-hosted agent; based <a id="_idIndexMarker434"/>on the OS you choose, there is a set of pre-requisites you'll need to complete before you can install the Azure Pipelines agent on your host.</p>&#13;
			<h3>Supported OSes</h3>&#13;
			<p>The <a id="_idIndexMarker435"/>following list shows the supported OSes:</p>&#13;
			<ul>&#13;
				<li>Windows-based:<p>  a) Windows 7, 8.1, or 10 (if you're using a client OS)</p><p>  b) Windows Server 2008 R2 SP1 or higher (Windows Server OS)</p></li>&#13;
				<li>Linux-based:<p>  a) CentOS 7, 6 </p><p>  b) Debian 9</p><p>  c) Fedora 30, 29</p><p>  d) Linux Mint 18, 17</p><p>  e) openSUSE 42.3 or later</p><p>  f) Oracle Linux 7</p><p>  g) Red Hat Enterprise Linux 8, 7, 6 </p><p>  h) SUSE Enterprise Linux 12 SP2 or later</p><p>  i) Ubuntu 18.04, 16.04</p></li>&#13;
				<li>ARM32:<p>  a) Debian 9</p><p>  b) Ubuntu 18.04</p></li>&#13;
				<li>macOS-based:<p>      a) macOS Sierra (10.12) or higher</p></li>&#13;
			</ul>&#13;
			<h3>Pre-requisite software</h3>&#13;
			<p>Based <a id="_idIndexMarker436"/>on the OS you choose, you will have to install the following pre-requisites before you can set up the host as an Azure pipeline agent:</p>&#13;
			<ul>&#13;
				<li>Windows-based:<p>  a) PowerShell 3.0 or higher</p><p>  b) .NET Framework 4.6.2 or higher</p></li>&#13;
				<li>Linux/ARM/macOS-based:<p>  a) Git 2.9.0 or higher.</p><p>  b) RHEL 6 and CentOS 6 require installing the specialized RHEL.6-x64 version of the agent.</p></li>&#13;
			</ul>&#13;
			<p>The agent installer for Linux includes a script to auto-install the required pre-requisite. You can complete the <a id="_idIndexMarker437"/>pre-requisite by running <strong class="source-inline">./bin/installdependencies.sh</strong> , which is available in the downloaded agent directory. The downloading of the agent is covered in the following sections of this chapter.</p>&#13;
			<p class="callout-heading">Important note</p>&#13;
			<p class="callout">Please note that the preceding pre-requisites are just to install the Azure Pipelines agent on the host; based on your application development requirements, you may need to install additional tools, such as Visual Studio build tools, a Subversion client, and any other frameworks that your application might need.</p>&#13;
			<p>Now that we have understood the pre-requisites, we will create an agent VM for our sample project, <strong class="bold">PartsUnlimited</strong>.</p>&#13;
			<h2 id="_idParaDest-137"><a id="_idTextAnchor150"/>Creating a VM in Azure for your project</h2>&#13;
			<p>The <strong class="bold">PartsUnlimited</strong> project is built using .NET Framework 4.5 and Visual Studio as the primary IDE tool. You can <a id="_idIndexMarker438"/>review that by browsing through the repository in the <strong class="bold">PartsUnlimited</strong> project in your Azure DevOps. </p>&#13;
			<p>Looking at that, our best bet would be to use a Visual Studio-based server OS. Let's look in Azure to explore our options here:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to the Azure portal and click <strong class="bold">+ Create a resource</strong>.</li>&#13;
				<li>Search for <strong class="bold">Visual Studio</strong> and select the <strong class="bold">Visual Studio images for Azure</strong> option:<div id="_idContainer202" class="IMG---Figure"><img src="Images/Figure_6.03_B16392.jpg" alt="Figure 6.3 – Visual Studio in the Azure portal&#13;&#10;"/></div><p class="figure-caption">Figure 6.3 – Visual Studio in the Azure portal</p></li>&#13;
				<li>Now, you'll be able to select from the various combinations available. We'll go with <strong class="bold">Visual Studio community 2017 on Windows Server 2016(x64)</strong>: <div id="_idContainer203" class="IMG---Figure"><img src="Images/Figure_6.04_B16392.jpg" alt="Figure 6.4 – Visual Studio images available in Azure&#13;&#10;"/></div><p class="figure-caption">Figure 6.4 – Visual Studio images available in Azure</p><p class="callout-heading">Important note</p><p class="callout">Visual Studio 2019-based images are available in the Azure portal directly in the search results.</p></li>&#13;
				<li>Click <strong class="bold">Create</strong> to <a id="_idIndexMarker439"/>start creating a VM. Choose the required subscription, resource group, and other settings based on your preference. </li>&#13;
				<li>In further pages, you can modify the settings to use a pre-created virtual network, as well as customize the storage settings and other management aspects. Please review the documentation to explore more on VM creation in Azure.<p class="callout-heading">Important note</p><p class="callout">Please <a id="_idIndexMarker440"/>follow the Microsoft docs to learn more about creating a VM in Azure: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal</a>.</p></li>&#13;
				<li>Log in to the VM upon creation and install the required pre-requisites.</li>&#13;
			</ol>&#13;
			<p>Now that we have the VM ready, we'll set it up as an Azure Pipelines agent for our project. </p>&#13;
			<h2 id="_idParaDest-138"><a id="_idTextAnchor151"/>Setting up the build agent</h2>&#13;
			<p>In this <a id="_idIndexMarker441"/>section, we'll configure the newly created VM to use as a self-hosted pipeline agent. </p>&#13;
			<h3>Setting up the agent pool in Azure DevOps</h3>&#13;
			<p>You can organize your agents in Azure DevOps as <strong class="bold">agent pools</strong>. <strong class="bold">Agent pools</strong> are a collection of your self-hosted <a id="_idIndexMarker442"/>agents; they help you organize and manage the agents at the pool level, rather than managing them individually.</p>&#13;
			<p><strong class="bold">Agent pools</strong> are managed at the organization level and can be used by multiple projects at the same time. Let's create an <strong class="bold">agent pool</strong> to get started:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to Azure DevOps and click on <strong class="bold">Organization settings</strong>:<div id="_idContainer204" class="IMG---Figure"><img src="Images/Figure_6.05_B16392.jpg" alt="Figure 6.5 – Azure DevOps Organization settings&#13;&#10;"/></div><p class="figure-caption">Figure 6.5 – Azure DevOps Organization settings</p></li>&#13;
				<li>Click on <strong class="bold">Agent pools</strong> under <strong class="bold">Pipelines</strong>:<div id="_idContainer205" class="IMG---Figure"><img src="Images/Figure_6.06_B16392.jpg" alt="Figure 6.6 – Azure DevOps Agent pools&#13;&#10;"/></div><p class="figure-caption">Figure 6.6 – Azure DevOps Agent pools</p></li>&#13;
				<li>You will see that there are two default agent pools created. Click on <strong class="bold">Add pool</strong> to create a new pool:<div id="_idContainer206" class="IMG---Figure"><img src="Images/Figure_6.07_B16392.jpg" alt="Figure 6.7 – Azure DevOps – adding an agent pool&#13;&#10;"/></div><p class="figure-caption">Figure 6.7 – Azure DevOps – adding an agent pool</p></li>&#13;
				<li>Provide the pool type, name, description, and pipeline permissions. Under the permissions option, you can choose to make this pool available to all pipelines and projects at once. Click <strong class="bold">Create</strong> once you're ready:<p>a) --<strong class="bold">Pool type</strong>: <strong class="bold">Self-hosted</strong></p><p>b) --<strong class="bold">Name</strong> and <strong class="bold">Description</strong>: Give a meaningful name that you can use to refer to later:</p><div id="_idContainer207" class="IMG---Figure"><img src="Images/Figure_6.08_B16392.jpg" alt="Figure 6.8 – Azure DevOps – adding agent pool configuration&#13;&#10;"/></div><p class="figure-caption">Figure 6.8 – Azure DevOps – adding agent pool configuration</p></li>&#13;
				<li>Your agent pool should be listed under <strong class="bold">Agent pools</strong> now. </li>&#13;
			</ol>&#13;
			<p>We will <a id="_idIndexMarker443"/>now set up an access token for the agent VM to be able to authenticate with Azure DevOps. </p>&#13;
			<h3>Setting up an access token for agent communication</h3>&#13;
			<p>In this <a id="_idIndexMarker444"/>task, you will create a personal access token that will be used by the Azure Pipelines agent to communicate with your Azure DevOps organization:</p>&#13;
			<ol>&#13;
				<li value="1">Sign in to your Azure DevOps organization with the admin user account.</li>&#13;
				<li>Go to your user profile and click <strong class="bold">Personal access tokens</strong>:<div id="_idContainer208" class="IMG---Figure"><img src="Images/Figure_6.09_B16392.jpg" alt="Figure 6.9 – Personal access token&#13;&#10;"/></div><p class="figure-caption"> </p><p class="figure-caption">Figure 6.9 – Personal access token</p></li>&#13;
				<li>Click on <strong class="bold">New token</strong>.</li>&#13;
				<li>Provide the token specifications as given here:<p>--<strong class="bold">Name</strong>: <strong class="bold">Self-Hosted Agent Token</strong>.</p><p>--<strong class="bold">Organization</strong>: Your Azure DevOps organization.</p><p>--<strong class="bold">Expiration</strong>: You can choose a date as per your choice. This is only for a one-time setup; you do <strong class="bold">not</strong> need to re-configure the agent once this token expires. </p><p>--<strong class="bold">Scope</strong>: <strong class="bold">Custom defined</strong>. </p></li>&#13;
				<li>On <strong class="bold">Scope</strong>, it is <a id="_idIndexMarker445"/>recommended to only give the permissions required to manage the agents. Click on <strong class="bold">Show all scope</strong> and select both the <strong class="bold">Read</strong> and <strong class="bold">Read &amp; manage</strong> permissions:<div id="_idContainer209" class="IMG---Figure"><img src="Images/Figure_6.10_B16392.jpg" alt="Figure 6.10 – Agent pool access&#13;&#10;"/></div><p class="figure-caption">Figure 6.10 – Agent pool access</p></li>&#13;
				<li>Review all the settings and click <strong class="bold">Create</strong>:<div id="_idContainer210" class="IMG---Figure"><img src="Images/Figure_6.11_B16392.jpg" alt="Figure 6.11 – Creating a personal access token for the agent pool&#13;&#10;"/></div><p class="figure-caption">Figure 6.11 – Creating a personal access token for the agent pool</p></li>&#13;
				<li>Once you click <strong class="bold">Create</strong>, Azure DevOps will display the personal access token. Please copy the token and save <a id="_idIndexMarker446"/>it in a secure location. If you happen to lose this token, you must create a new token for setting up new agents. <p>We will use this token when setting up the Azure Pipelines agent.</p><p class="callout-heading">Important note</p><p class="callout">You will <a id="_idIndexMarker447"/>need to give additional permissions when creating a token if you plan to use deployment groups (more information here: <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops</a>).</p></li>&#13;
			</ol>&#13;
			<p>Now that we have completed the agent pool setup in Azure DevOps, we can start installing the agent in the VM we created earlier. </p>&#13;
			<h3>Installing Azure Pipelines agents</h3>&#13;
			<p>You are now ready to install the Azure Pipelines agent on your VMs that you created earlier. Let's download the Azure <a id="_idIndexMarker448"/>Pipelines agent. Before you start, please log in to the VM created earlier using <strong class="bold">Remote desktop</strong>:</p>&#13;
			<ol>&#13;
				<li value="1">In your Azure DevOps account, browse to <strong class="bold">Organization Settings</strong> &gt; <strong class="bold">Agent Pools</strong>.</li>&#13;
				<li>Select your newly created agent pool and click on <strong class="bold">New agent</strong>:<div id="_idContainer211" class="IMG---Figure"><img src="Images/Figure_6.12_B16392.jpg" alt="Figure 6.12 – Add agent&#13;&#10;"/></div><p class="figure-caption">Figure 6.12 – Add agent</p></li>&#13;
				<li>On the next page, you can download the agent installer based on the OS and architecture (x64/x32). In our example, we're using a Windows Server 2016-based VM. We'll choose Windows and the x64 architecture. You can also copy the download URL and use it to download the agent directly inside your self-hosted agent machine. You can also choose to follow the installation steps given in the Azure DevOps portal based on the OS for your agent machine:<div id="_idContainer212" class="IMG---Figure"><img src="Images/Figure_6.13_B16392.jpg" alt="Figure 6.13 – Agent commands&#13;&#10;"/></div><p class="figure-caption">Figure 6.13 – Agent commands</p><p class="callout-heading">Tip</p><p class="callout">If you are unable to download the agent file on your Visual Studio machine, you can use a different browser than <a id="_idIndexMarker449"/>Internet Explorer or disable <strong class="bold">Enhanced IE Security</strong> configuration from the server manager. You can refer to <a href="https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/">https://www.wintips.org/how-to-disable-internet-explorer-enhanced-security-configuration-in-server-2016/</a> to learn how to disable enhanced Internet Explorer security configuration. </p></li>&#13;
				<li>Launch <a id="_idIndexMarker450"/>an elevated PowerShell window and change to the <strong class="source-inline">C:</strong> directory root by running the <strong class="source-inline">cd C:\</strong> command:<div id="_idContainer213" class="IMG---Figure"><img src="Images/Figure_6.14_B16392.jpg" alt="Figure 6.14 – Change directory&#13;&#10;"/></div><p class="figure-caption">Figure 6.14 – Change directory</p></li>&#13;
				<li>Run the following PowerShell commands to create an agent directory on the <strong class="source-inline">C</strong> drive and extract the agent files to the new directory. Please note that you may have to change the filename/path depending on the version of the agent you've downloaded and the directory where you saved the downloaded file:<p class="source-code"><strong class="bold">mkdir agent ; cd agent</strong></p><p class="source-code"><strong class="bold">Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$HOME\Downloads\vsts-agent-win-x64-2.171.1.zip", "$PWD")</strong></p></li>&#13;
				<li>It will take a minute or two to extract the files. Please browse to the new directory once it's completed. You should see files as displayed in the following screenshot:<div id="_idContainer214" class="IMG---Figure"><img src="Images/Figure_6.15_B16392.jpg" alt="Figure 6.15 – Agent files&#13;&#10;"/></div><p class="figure-caption">Figure 6.15 – Agent files</p></li>&#13;
				<li>You can run the Azure pipeline agent in two modes:<p>--<strong class="bold">Run Once</strong>: This will run the agent manually using the <strong class="source-inline">run</strong> batch file stored in the agent directory. Your agent will stop responding to pipelines if you stop the interactive authentication.</p><p>--<strong class="bold">Run as Service</strong>: In this version, you configure the agent to run as a Windows service that will remain online all the time and auto-start on reboot. This is the recommended setup for production scenarios. </p></li>&#13;
				<li>Let's <a id="_idIndexMarker451"/>configure the agent to run as a service. In your PowerShell window, run <strong class="source-inline">.\config.cmd</strong>.<p>This will ask a series of questions about your Azure DevOps organization. </p></li>&#13;
				<li>Enter <a id="_idIndexMarker452"/>your Azure DevOps organization as the server URL. Typically, this would be <a href="https://dev.azure.com/YourOrganizationName">https://dev.azure.com/YourOrganizationName</a>.</li>&#13;
				<li>Press <em class="italic">Enter</em> to select <strong class="bold">PAT</strong> (<strong class="bold">Personal access token</strong>) as the authentication mechanism for Azure DevOps. </li>&#13;
				<li>Provide <a id="_idIndexMarker453"/>your personal access token generated earlier. </li>&#13;
				<li>Provide the agent pool name you created earlier.</li>&#13;
				<li>Provide a name for this agent.</li>&#13;
				<li>Provide a working directory for the agent to choose as default.</li>&#13;
				<li>Finally, press <em class="italic">Y</em> and hit <em class="italic">Enter</em> to configure to run the agent as a Windows service. </li>&#13;
				<li>You can accept the default account to run the service. </li>&#13;
				<li>This will complete the agent setup; at the end, you should see a message stating that the services are started successfully:</li>&#13;
			</ol>&#13;
			<div>&#13;
				<div id="_idContainer215" class="IMG---Figure">&#13;
					<img src="Images/Figure_6.16_B16392.jpg" alt="Figure 6.16 – Installing the agent&#13;&#10;"/>&#13;
				</div>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 6.16 – Installing the agent</p>&#13;
			<p>Now, if you look under your agent pool in the Azure DevOps portal, you should see this agent listed:</p>&#13;
			<div>&#13;
				<div id="_idContainer216" class="IMG---Figure">&#13;
					<img src="Images/Figure_6.17_B16392.jpg" alt="Figure 6.17 – Azure Pipelines agent listed&#13; &#10;"/>&#13;
				</div>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 6.17 – Azure Pipelines agent listed</p>&#13;
			<p>You now <a id="_idIndexMarker454"/>have a ready-to-use, self-hosted agent for your Azure pipelines! This self-hosted agent can be used to run your Azure pipeline jobs, and you can add as many agents as you want in a similar fashion. You may have various types of hosted agents in one pool; the appropriate agent for the job is automatically selected based on the pipeline requirements, or you can select an agent specifically at execution time. Typically, in a large environment, you'd pre-create an image of an agent server so that it is faster to provision additional agents whenever needed. In the next section, we will update our pipeline to leverage this newly set-up self-hosted agent. Please refer to this documentation <a id="_idIndexMarker455"/>if you wish to use a Linux-based hosted agent: <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops</a>. </p>&#13;
			<p>Refer <a id="_idIndexMarker456"/>to the following link for macOS-based agents: <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-osx?view=azure-devops</a>.</p>&#13;
			<p class="callout-heading">Important note</p>&#13;
			<p class="callout">If your self-hosted agent machine is behind a network firewall or proxy, you must define the proxy address while <a id="_idIndexMarker457"/>installing the Azure pipeline agent. You can do that by specifying the proxy URL, username, and password with a config command: </p>&#13;
			<p class="callout"><strong class="source-inline">./config.cmd --proxyurl http://127.0.0.1:8888 --proxyusername "myuser" --proxypassword "mypass"</strong></p>&#13;
			<h1 id="_idParaDest-139"><a id="_idTextAnchor152"/>Updating your Azure pipeline to use self-hosted agents</h1>&#13;
			<p>In this <a id="_idIndexMarker458"/>section, we'll take the Azure pipeline scenario covered <a id="_idIndexMarker459"/>in the last chapters (<strong class="bold">PartsUnlimited</strong>) and modify it to use our newly created self-hosted agent. This will enable us to use our self-hosted agent to run the pipelines, rather than using Microsoft-provided agents. </p>&#13;
			<h2 id="_idParaDest-140"><a id="_idTextAnchor153"/>Preparing your self-hosted agent to build the Parts Unlimited project</h2>&#13;
			<p>Before we <a id="_idIndexMarker460"/>can start using the self-hosted agent, we must prepare it to support building our sample project, <strong class="bold">PartsUnlimited</strong>. The <strong class="bold">PartsUnlimited</strong> project is built using Visual Studio leveraging .NET Framework, Azure development tools and .NET Core, Node.js, and so on. In order to use our self-hosted agent for building the solution, we must install the required dependencies prior to running the pipeline jobs:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to your self-hosted agent VM.</li>&#13;
				<li>Download the Visual Studio build tools with this link: <a href="https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&amp;rel=16">https://visualstudio.microsoft.com/thank-you-downloading-visual-studio/?sku=BuildTools&amp;rel=16</a>.<p> This will launch Visual Studio Installer.</p></li>&#13;
				<li>Select <strong class="bold">ASP.Net and Web Development</strong> and <strong class="bold">Azure Development</strong>.</li>&#13;
				<li>Click <strong class="bold">Modify</strong>. This will start installing the required framework and tools.</li>&#13;
				<li>Once <a id="_idIndexMarker461"/>this is completed, please download and install .NET Core 2.2. You can download it from this link: <a href="https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer">https://dotnet.microsoft.com/download/dotnet-core/thank-you/sdk-2.2.110-windows-x64-installer</a>.<p>You can find all the .NET downloads here: <a href="https://dotnet.microsoft.com/download">https://dotnet.microsoft.com/download</a>.</p></li>&#13;
				<li>Install Azure PowerShell by running the following commands in an elevated PowerShell window:<p class="source-code"><strong class="bold">[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12</strong></p><p class="source-code"><strong class="bold">Install-Module AzureRM -AllowClobber</strong></p></li>&#13;
				<li>Install Node.js version 6.x from <a href="https://nodejs.org/download/release/v6.12.3">https://nodejs.org/download/release/v6.12.3</a>. You can download the file named <strong class="source-inline">node-v6.12.3-x64.msi</strong> and install it using the interactive installer.</li>&#13;
			</ol>&#13;
			<p>Your host is now ready to build the <strong class="bold">PartsUnlimited</strong> solution. </p>&#13;
			<h2 id="_idParaDest-141"><a id="_idTextAnchor154"/>Running the Azure pipeline </h2>&#13;
			<p>In this <a id="_idIndexMarker462"/>task, we'll now run the pipeline job to build the <strong class="bold">PartsUnlimited</strong> solution using our own self-hosted agents:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to the <strong class="bold">Azure DevOps</strong> portal and browse to the <strong class="bold">PartsUnlimited</strong> project.</li>&#13;
				<li>Browse to <strong class="bold">Pipelines</strong>:<div id="_idContainer217" class="IMG---Figure"><img src="Images/Figure_6.18_B16392.jpg" alt="Figure 6.18 – Azure Pipelines &#13;&#10;"/></div><p class="figure-caption">Figure 6.18 – Azure Pipelines </p></li>&#13;
				<li>Open the pre-created pipeline named <strong class="source-inline">PartsUnlimitedE2E</strong>.</li>&#13;
				<li>Click on <strong class="bold">Edit Pipeline</strong>. </li>&#13;
				<li>In the pipeline, change the <strong class="bold">agent pool</strong> to your newly created agent pool:<div id="_idContainer218" class="IMG---Figure"><img src="Images/Figure_6.19_B16392.jpg" alt="Figure 6.19 – Selecting an agent pool for the pipeline&#13;&#10;"/></div><p class="figure-caption">Figure 6.19 – Selecting an agent pool for the pipeline</p></li>&#13;
				<li>Save <a id="_idIndexMarker463"/>the pipeline. You can also choose to run it after saving by selecting <strong class="bold">Save &amp; queue</strong>:<div id="_idContainer219" class="IMG---Figure"><img src="Images/Figure_6.20_B16392.jpg" alt="Figure 6.20 – Saving the pipeline&#13;&#10;"/></div><p class="figure-caption">Figure 6.20 – Saving the pipeline</p></li>&#13;
				<li>Now, we are ready to execute the pipeline. Click on <strong class="bold">Run pipeline</strong>:<div id="_idContainer220" class="IMG---Figure"><img src="Images/Figure_6.21_B16392.jpg" alt="Figure 6.21 – Running the pipeline&#13;&#10;"/></div><p class="figure-caption">Figure 6.21 – Running the pipeline</p></li>&#13;
				<li>Under <strong class="bold">Agent pool</strong>, change <a id="_idIndexMarker464"/>the pool name to the agent pool you configured in the previous section and click <strong class="bold">Run</strong>: <div id="_idContainer221" class="IMG---Figure"><img src="Images/Figure_6.22_B16392.jpg" alt="Figure 6.22 – The Run pipeline wizard&#13;&#10;"/></div><p class="figure-caption">Figure 6.22 – The Run pipeline wizard</p></li>&#13;
				<li>This <a id="_idIndexMarker465"/>will start executing the pipeline job on your self-hosted agent. This may take a few minutes to complete:<div id="_idContainer222" class="IMG---Figure"><img src="Images/Figure_6.23_B16392.jpg" alt="Figure 6.23 – The Azure pipeline Jobs logs&#13;&#10;"/></div><p class="figure-caption">Figure 6.23 – The Azure pipeline Jobs logs</p></li>&#13;
				<li>You can click on the job name to view the logs in real time. </li>&#13;
			</ol>&#13;
			<p>You've now <a id="_idIndexMarker466"/>completed setting up an Azure pipeline, which is using a VM-based self-hosted pipeline agent for running the jobs. </p>&#13;
			<h1 id="_idParaDest-142"><a id="_idTextAnchor155"/>Using containers as self-hosted agents</h1>&#13;
			<p>Azure Pipelines <a id="_idIndexMarker467"/>supports using Docker <a id="_idIndexMarker468"/>containers as the compute target for running pipeline jobs. You can use both Windows containers (Windows Server Core/Nano Server) and Linux containers (Ubuntu) to host your agents.</p>&#13;
			<p>In order to connect the container to your Azure DevOps organization, you'll need to pass a few environment variables, such as the agent pool name, personal access token, and so on. </p>&#13;
			<h2 id="_idParaDest-143"><a id="_idTextAnchor156"/>Setting up Windows containers as Azure pipeline agents</h2>&#13;
			<p>In order <a id="_idIndexMarker469"/>to use Windows containers as Azure pipeline <a id="_idIndexMarker470"/>agents, you need to build the container image first and then run it with your Azure DevOps organization environment variables. Let's look at the process.</p>&#13;
			<h3>Building the container image</h3>&#13;
			<p>Follow <a id="_idIndexMarker471"/>these steps to build the container image:</p>&#13;
			<ol>&#13;
				<li value="1">Launch Command Prompt and run the following commands:<p class="source-code"><strong class="bold">mkdir C:\dockeragent</strong></p><p class="source-code"><strong class="bold">cd C:\dockeragent</strong></p></li>&#13;
				<li>Create a new file named <strong class="source-inline">Dockerfile</strong> (no extension) and update it with the following content. You can use Notepad to open the file:<p class="source-code"><strong class="bold">FROM mcr.microsoft.com/windows/servercore:ltsc2019</strong></p><p class="source-code"><strong class="bold">WORKDIR /azp</strong></p><p class="source-code"><strong class="bold">COPY start.ps1 .</strong></p><p class="source-code"><strong class="bold">CMD powershell .\start.ps1</strong></p></li>&#13;
				<li>Create <a id="_idIndexMarker472"/>a new PowerShell file with <a id="_idIndexMarker473"/>the name <strong class="source-inline">start.ps1</strong> and copy the content from here: <a href="https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1">https://github.com/PacktPublishing/Learning-Azure-DevOps---B16392/blob/master/Chapter-6/start.ps1</a>. </li>&#13;
				<li>Run the following command to build the container image:<p class="source-code"><strong class="bold">docker build -t dockeragent:latest.</strong></p></li>&#13;
			</ol>&#13;
			<p>Your container image is now ready to use. You can use <strong class="source-inline">dockeragent</strong> as the image name to refer to this image. Optionally, you can save this image in your container repository.</p>&#13;
			<h3>Running the Azure Pipelines agent container</h3>&#13;
			<p>Now that <a id="_idIndexMarker474"/>you have a <a id="_idIndexMarker475"/>container image ready, you can use it as the pipeline agent by running the container.</p>&#13;
			<p>Launch a Command Prompt window and run the following command. Be sure to update the Azure DevOps organization URL, token, and agent name:</p>&#13;
			<p class="source-code">docker run -e AZP_URL=&lt;Azure DevOps instance&gt; -e AZP_TOKEN=&lt;PAT token&gt; -e AZP_AGENT_NAME=mydockeragent dockeragent:latest</p>&#13;
			<p>Your container-based Azure pipeline agent is now ready to use. If you want to use a container for one job and re-create it every time, you can use the <strong class="source-inline">–-once</strong> flag to use one <a id="_idIndexMarker476"/>container for running one job <strong class="bold">only</strong> and use a container orchestrator such as Kubernetes to re-create the container as soon as <a id="_idIndexMarker477"/>it finishes executing the current job. </p>&#13;
			<p class="callout-heading">Important note</p>&#13;
			<p class="callout">Refer to the Microsoft docs – <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/">https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/</a> – for additional details about Windows containers.</p>&#13;
			<p>In the <a id="_idIndexMarker478"/>next section, we'll take a look at setting up Linux-based containers as Azure Pipelines agents. </p>&#13;
			<h2 id="_idParaDest-144"><a id="_idTextAnchor157"/>Setting up Linux containers as Azure Pipelines agents</h2>&#13;
			<p>In order to <a id="_idIndexMarker479"/>use Linux containers <a id="_idIndexMarker480"/>as Azure pipeline agents, you can either use the Docker image published by Microsoft on Docker Hub or build your own Docker image. </p>&#13;
			<p>Microsoft's <a id="_idIndexMarker481"/>Azure pipeline agent image is available here: <a href="https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent">https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent</a>. You can directly run this image with environment variables, including information about your Azure DevOps organization:</p>&#13;
			<p class="source-code">docker run \</p>&#13;
			<p class="source-code">  -e VSTS_ACCOUNT=&lt;name&gt; \</p>&#13;
			<p class="source-code">  -e VSTS_TOKEN=&lt;pat&gt; \</p>&#13;
			<p class="source-code">  -it mcr.microsoft.com/azure-pipelines/vsts-agent</p>&#13;
			<p>Alternatively, you can also choose to build your own Docker image to use for your Pipelines agents. The process is similar to building an image for Windows containers. Please <a id="_idIndexMarker482"/>refer to the Microsoft docs here – <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops</a> – for reference to the <a id="_idIndexMarker483"/>entry point script.</p>&#13;
			<h2 id="_idParaDest-145"><a id="_idTextAnchor158"/>Using Azure Container Instances as agents</h2>&#13;
			<p><strong class="bold">Azure Container Instances</strong> (<strong class="bold">ACI</strong>) is <a id="_idIndexMarker484"/>a managed service to run Windows and Linux containers in the Azure cloud. If standard Microsoft-hosted agents don't fit your needs (requirements, performances, and so on) and you <a id="_idIndexMarker485"/>do not have sufficient infrastructure to host the container on-premises, you can use ACI to create a self-hosted agent for Azure DevOps.</p>&#13;
			<p>You can create a build agent running on ACI by using a custom image or reusing one of Microsoft's images that are available.</p>&#13;
			<p>You'll need the Azure DevOps account name, personal access token, and agent name to run an Azure pipeline agent in ACI. When you have the required details, you can create an agent on ACI by executing the following command from the Azure CLI (after connecting to your Azure subscription):</p>&#13;
			<p class="source-code">az container create -g RESOURCE_GROUP_NAME -n CONTAINER_NAME --image mcr.microsoft.com/azure-pipelines/vsts-agent --cpu 1 --memory 7 --environment-variables VSTS_ACCOUNT=AZURE_DEVOPS_ACCOUNT_NAME VSTS_TOKEN=PERSONAL_ACCESS_TOKEN VSTS_AGENT=AGENT_NAME VSTS_POOL=Default</p>&#13;
			<p>Here, we have the following:</p>&#13;
			<ul>&#13;
				<li><strong class="source-inline">RESOURCE_GROUP_NAME</strong> is the name of your resource group in Azure where you want to create this resource.</li>&#13;
				<li><strong class="source-inline">CONTAINER_NAME</strong> is the name of the ACI container name.</li>&#13;
				<li><strong class="source-inline">AZURE_DEVOPS_ACCOUNT_NAME</strong> is the name of your Azure DevOps account.</li>&#13;
				<li><strong class="source-inline">PERSONAL_ACCESS_TOKEN</strong> is the personal access token previously created.</li>&#13;
				<li><strong class="source-inline">AGENT_NAME</strong> is the name of the build agent that you want to create and that will be displayed on Azure DevOps.</li>&#13;
			</ul>&#13;
			<p>In this <a id="_idIndexMarker486"/>command, there are also other two important parameters:</p>&#13;
			<ul>&#13;
				<li>The <strong class="source-inline">--image</strong> parameter is used to select the name of the Azure Pipelines image for creating your agent, as described here: <a href="https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent">https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent</a>.</li>&#13;
				<li>The VSTS_POOL parameter is used to select the agent pool for your build agent.</li>&#13;
			</ul>&#13;
			<p>Remember that you can start and stop an ACI instance by using the <strong class="source-inline">az container stop</strong> and <strong class="source-inline">az container start</strong> commands, and this can help you save money.</p>&#13;
			<p>Let's take a look at some of the additional environment variables you can use with Azure pipeline agent-based containers. </p>&#13;
			<h2 id="_idParaDest-146"><a id="_idTextAnchor159"/>Environment variables</h2>&#13;
			<p>Azure DevOps <a id="_idIndexMarker487"/>pipeline agents running on containers can be customized further by using additional environment variables. The environment variables and their purposes are described as follows: </p>&#13;
			<ul>&#13;
				<li><strong class="source-inline">AZP_URL</strong>: The URL of the Azure DevOps organization</li>&#13;
				<li><strong class="source-inline">AZP_TOKEN</strong>: Personal access token</li>&#13;
				<li><strong class="source-inline">AZP_AGENT_NAME</strong>: The name of your Azure pipeline agent</li>&#13;
				<li><strong class="source-inline">AZP_POOL</strong>: Agent pool name (default value is <strong class="source-inline">Default</strong>)</li>&#13;
				<li><strong class="source-inline">AZP_WORK</strong>: Work directory (default value is <strong class="source-inline">_work</strong>)</li>&#13;
			</ul>&#13;
			<p>In this section, we learned about using containers as your Azure pipeline agents for executing your pipeline jobs. </p>&#13;
			<p>Planning for scale – Azure VM scale sets as Azure pipeline agents</p>&#13;
			<p>Azure VM scale <a id="_idIndexMarker488"/>sets are an Azure service that allow you to create and manage hundreds of identical VMs with the ability to automatically or manually scale the number of VMs. Azure VM scale sets can be used as Azure pipeline agents in a large-scale project where you need elastic capacity based on your Azure pipeline job execution workload.</p>&#13;
			<p>Azure VM scale sets support up to 1,000 VMs in one scale set.</p>&#13;
			<h2 id="_idParaDest-147"><a id="_idTextAnchor160"/>Planning for scale</h2>&#13;
			<p>Azure VM <a id="_idIndexMarker489"/>scale set-based agents can be auto-scaled based on your Azure Pipelines jobs demand at a given time. There are several reasons why scale set agents can be a better option, rather than using dedicated agents: </p>&#13;
			<ul>&#13;
				<li>You need more computer power (CPU and memory) at a certain time and this requirement fluctuates based on workload.</li>&#13;
				<li>Microsoft-hosted agents are not able to meet your pipeline requirements.</li>&#13;
				<li>Your job runs for a long time or takes time to complete.</li>&#13;
				<li>You wish to use the same agent for various jobs consecutively to take advantage of caching and so on.</li>&#13;
				<li>You don't want to run dedicated agents all the time as these incur costs.</li>&#13;
				<li>You want to regularly update the image of VMs running jobs.</li>&#13;
			</ul>&#13;
			<p>Azure VM scale sets can automatically increase/decrease the number of pipeline agents available based on the current demand of Azure Pipelines. This helps you save money, as well as supports your scaling requirements.</p>&#13;
			<h2 id="_idParaDest-148"><a id="_idTextAnchor161"/>Creating an Azure VM scale set</h2>&#13;
			<p>In this <a id="_idIndexMarker490"/>section, we'll create an Azure VM scale set to use as an Azure pipeline agent. Please note that Azure Pipelines requires the scale set to be created with certain configurations, so you may not be able to use an existing scale set:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to the Azure portal and click on <strong class="bold">+ Create a resource</strong>.</li>&#13;
				<li>Search for <strong class="source-inline">Virtual machine scale set</strong>:<div id="_idContainer223" class="IMG---Figure"><img src="Images/Figure_6.24_B16392.jpg" alt="Figure 6.24 – A VM scale set in the Azure portal&#13;&#10;"/></div><p class="figure-caption">Figure 6.24 – A VM scale set in the Azure portal</p></li>&#13;
				<li>Click <strong class="bold">Create</strong>.</li>&#13;
				<li>Fill in <a id="_idIndexMarker491"/>the values as described here:<p>--<strong class="bold">Subscription</strong>: Choose the subscription on which you wish to deploy this scale set. </p><p>--<strong class="bold">Resource group</strong>: Choose an existing resource group or create a new one.</p><p>--<strong class="bold">Virtual machine scale set name</strong>: Identifier of your choice.</p><p>--<strong class="bold">Region</strong>: The Azure region of your choice; it is recommended to choose the one closest to you.</p><p>--<strong class="bold">Availability zone</strong>: Recommended to choose all three for high availability. </p><p>--<strong class="bold">Image</strong>: Choose a supported Windows or Linux image for the Azure Pipelines agent. </p><p>--<strong class="bold">Azure Spot instance</strong>: Can help in minimizing cost. Refer to <a href="https://azure.microsoft.com/en-us/pricing/spot/">https://azure.microsoft.com/en-us/pricing/spot/</a> for details.</p><p>--<strong class="bold">Size</strong>: The <a id="_idIndexMarker492"/>VM size for your agents.</p><p>--<strong class="bold">Authentication</strong>: Username/password or SSH key:</p><div id="_idContainer224" class="IMG---Figure"><img src="Images/Figure_6.25_B16392.jpg" alt="Figure 6.25 – Creating a VM scale set&#13;&#10;"/></div><p class="figure-caption">Figure 6.25 – Creating a VM scale set</p></li>&#13;
				<li>Click <strong class="bold">Next: Disks &gt;</strong>.</li>&#13;
				<li>You can customize the disk performance tier and encryption settings, and add additional disks if required. If you're unsure, accept the defaults and click <strong class="bold">Next</strong>.</li>&#13;
				<li>On the networking page, you can choose to connect the scale set to an existing virtual network if your scale set needs to access any of your network resources securely. Please ensure that <strong class="bold">Use a load balancer</strong> is set to <strong class="bold">No</strong> for the Azure Pipelines scale set. Once configured, click <strong class="bold">Next</strong>:<div id="_idContainer225" class="IMG---Figure"><img src="Images/Figure_6.26_B16392.jpg" alt="Figure 6.26 – Azure VM scale set load balancing settings&#13;&#10;"/></div><p class="figure-caption">Figure 6.26 – Azure VM scale set load balancing settings</p></li>&#13;
				<li>On <strong class="bold">Scaling</strong>, provide <a id="_idIndexMarker493"/>an initial instance count and keep <strong class="bold">Scaling policy</strong> to <strong class="bold">Manual</strong>. Leave the other settings as the default and click <strong class="bold">Next</strong>:<div id="_idContainer226" class="IMG---Figure"><img src="Images/Figure_6.27_B16392.jpg" alt="Figure 6.27 – Scale set settings&#13;&#10;"/></div><p class="figure-caption">Figure 6.27 – Scale set settings</p></li>&#13;
				<li>On <strong class="bold">Management</strong>, ensure that <strong class="bold">Upgrade mode</strong> is set to <strong class="bold">Manual</strong>. Leave the other settings as the default and click <strong class="bold">Next</strong>:<div id="_idContainer227" class="IMG---Figure"><img src="Images/Figure_6.28_B16392.jpg" alt="Figure 6.28 – Scale set upgrade policy&#13;&#10;"/></div><p class="figure-caption">Figure 6.28 – Scale set upgrade policy</p></li>&#13;
				<li>On the <strong class="bold">Health and Advanced Setting</strong> page, optionally change any settings you want to customize for your environment. Click <strong class="bold">Review and Create</strong> once you're ready to start creating the scale set.</li>&#13;
				<li>Once the validation is successful, click <strong class="bold">Create</strong> to start the deployment. </li>&#13;
			</ol>&#13;
			<p>It may <a id="_idIndexMarker494"/>take a few minutes for the deployment to complete. Please wait while the deployment finishes. One the VM scale set is ready, we'll set it up to be used as an Azure Pipelines agent.</p>&#13;
			<h2 id="_idParaDest-149"><a id="_idTextAnchor162"/>Setting up Azure pipeline agents with VM scale set</h2>&#13;
			<p>In the <a id="_idIndexMarker495"/>last section, we created a VM scale set. Now, we will set that up as an Azure pipeline agent:</p>&#13;
			<ol>&#13;
				<li value="1">Log in to your Azure DevOps organization and browse to <strong class="bold">Project Settings</strong> &gt; <strong class="bold">Agent Pools</strong>.</li>&#13;
				<li>Click on <strong class="bold">Add Pool</strong>.</li>&#13;
				<li>Fill in the values as defined here:<p>--<strong class="bold">Pool Type</strong>: Virtual machine scale set</p><p>--<strong class="bold">Project for Service Connections</strong>: Choose your Azure DevOps project</p><p>--<strong class="bold">Azure Subscription</strong>: Select the Azure subscription where you created the VM scale set:</p><div id="_idContainer228" class="IMG---Figure"><img src="Images/Figure_6.29_B16392.jpg" alt="Figure 6.29 – Adding an agent pool for the scale set&#13;&#10;"/></div><p class="figure-caption">Figure 6.29 – Adding an agent pool for the scale set</p></li>&#13;
				<li>Click <strong class="bold">Authorize</strong> to enable access to your Azure subscription. You may be asked to log in to your Azure account in this process.</li>&#13;
				<li>Once <a id="_idIndexMarker496"/>authenticated, select an existing VM scale set and fill in the values as described here:<p>--The name and description of your choice for this agent pool.</p><p>--Optionally, configure the scale set to delete the VM after each execution.</p><p>--The maximum number of VMs.</p><p>--The number of agents to keep as standby. While this can help you in completing jobs quickly, it may increase your Azure cost.</p></li>&#13;
				<li>Click <strong class="bold">Create</strong> once you have filled in all the values:<div id="_idContainer229" class="IMG---Figure"><img src="Images/Figure_6.30_B16392.jpg" alt="Figure 6.30 – Creating a scale set-based agent pool&#13;&#10;"/></div><p class="figure-caption">Figure 6.30 – Creating a scale set-based agent pool</p></li>&#13;
				<li>Your <a id="_idIndexMarker497"/>agent pool creation will now start. Please note that it may take around 15 minutes before your agent pool is ready to take up the jobs. You should see the agents live in your agent pool upon completion:</li>&#13;
			</ol>&#13;
			<div>&#13;
				<div id="_idContainer230" class="IMG---Figure">&#13;
					<img src="Images/Figure_6.31_B16392.jpg" alt="Figure 6.31 – Agents&#13;&#10;"/>&#13;
				</div>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 6.31 – Agents</p>&#13;
			<p>Once your agent pool is ready, you can update your Azure pipeline to start using this pool <a id="_idIndexMarker498"/>for job execution. </p>&#13;
			<h1 id="_idParaDest-150"><a id="_idTextAnchor163"/>Summary</h1>&#13;
			<p>In this chapter, we looked at using Microsoft-hosted agents and self-hosted agents to run your Azure pipeline jobs. We dug deep into the process of setting up a self-hosted agent and updated our pipelines to use the self-hosted agent.</p>&#13;
			<p>We also looked at how you can use Docker containers, Azure container instances, and Azure VM scale sets as your Azure pipeline agents. With this chapter, you should be able to plan and implement the appropriate pipeline agent solution for your projects </p>&#13;
			<p>In the next chapter, we'll learn about Artifacts in Azure DevOps.</p>&#13;
		</div>&#13;
	</div></body></html>