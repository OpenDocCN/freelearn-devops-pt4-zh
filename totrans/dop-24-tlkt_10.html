<html><head></head><body>
<div class="calibre6">
<h2 id="chartmuseum" class="calibre16">Packaging Kubernetes Applications</h2>

<aside class="tip">
    <p class="calibre3">Using YAML files to install or upgrade applications in a Kubernetes cluster works well only for static definitions. The moment we need to change an aspect of an application we are bound to discover the need for templating and packaging mechanisms.</p>

</aside>

<p class="calibre3">We faced quite a few challenges thus far. The good news is that we managed to solve most of them. The bad news is that, in some cases, our solutions felt sub-optimum (politically correct way to say <em class="calibre17">horrible</em>).</p>

<p class="calibre3">We spent a bit of time trying to define Jenkins resources while we were in the <a href="part0009.html#sts">Deploying Stateful Applications At Scale</a> chapter. That was a good exercise that can be characterized as a learning experience, but there’s still some work in front of us to make it a truly useful definition. The primary issue with our Jenkins definition is that it is still not automated. We can spin up a master, but we still have to go through the setup wizard manually. Once we’re done with the setup, we’d need to install some plugins, and we’d need to change its configuration. Before we go down that road, we might want to explore whether others already did that work for us. If we’d look for, let’s say, a Java library that would help us solve a particular problem with our application, we’d probably look for a Maven repository. Maybe there is something similar for Kubernetes applications. Perhaps there is a community-maintained repository with installation solutions for commonly used tools. We’ll make it our mission to find such a place.</p>

<p class="calibre3">Another problem we faced was customization of our YAML files. As a minimum, we’ll need to specify different image tag every time we deploy a release. In the <a href="part0011.html#manual-cd">Defining Continuous Deployment</a> chapter, we had to use <code class="calibre19">sed</code> to modify definitions before sending them through <code class="calibre19">kubectl</code> to Kube API. While that worked, I’m sure that you’ll agree that commands like <code class="calibre19">sed -e "s@:latest@:1.7@g"</code> are not very intuitive. They look and feel awkward. To make things more complicated, image tags are rarely the only things that change from one deployment to another. We might need to change domains or paths of our Ingress controllers to accommodate the needs of having our applications deployed to different environments (e.g., staging and production). The same can be said for the number of replicas and many other things that define what we want to install. Using concatenated <code class="calibre19">sed</code> command can quickly become complicated, and it is not very user-friendly. Sure, we could modify YAML every time we, for example, make a new release. We could also create different definitions for each environment we’re planning to use. But, we won’t do that. That would only result in duplication and maintenance nightmare. We already have two YAML files for the <code class="calibre19">go-demo-3</code> application (one for testing and the other for production). If we continue down that route, we might end up with ten, twenty, or even more variations of the same definitions. We might also be forced to change it with every commit of our code so that the tag is always up to date. That road is not the one we’ll take. It leads towards a cliff. What we need is a templating mechanism that will allow us to modify definitions before sending them to Kube API.</p>

<p class="calibre3">The last issue we’ll try to solve in this chapter is the need to describe our applications and the possible changes others might apply to them before installing them inside a cluster. Truth be told, that is already possible. Anyone can read our YAML files to deduce what constitutes the application. Anyone could take one of our YAML files and modify it to suit their own needs. In some cases that might be challenging even for someone experienced with Kubernetes. However, our primary concern is related to those who are not Kubernetes ninjas. We cannot expect everyone in our organization to spend a year learning Kubernetes only so that they can deploy applications. On the other hand, we do want to provide that ability to everyone. We want to empower everyone. When faced with the need for everyone to use Kubernetes and the fact that not everyone will be a Kubernetes expert, it becomes apparent that we need a more descriptive, easier to customize, and more user-friendly way to discover and deploy applications.</p>

<p class="calibre3">We’ll try to tackle those and a few other issues in this chapter. We’ll try to find a place where community contributes with definitions of commonly used applications (e.g., Jenkins). We’ll seek for a templating mechanism that will allow us to customize our applications before installing them. Finally, we’ll try to find a way to better document our definitions. We’ll try to make it so simple that even those who don’t know Kubernetes can safely deploy applications to a cluster. What we need is a Kubernetes equivalent of package managers like <em class="calibre17">apt</em>, <em class="calibre17">yum</em>, <em class="calibre17">apk</em>, <a href="https://brew.sh/">Homebrew</a>, or <a href="https://chocolatey.org/">Chocolatey</a>, combined with the ability to document our packages in a way that anyone can use them.</p>

<p class="calibre3">I’ll save you from searching for a solution and reveal it right away. We’ll explore <a href="https://helm.sh/">Helm</a> as the missing piece that will make our deployments customizable and user-friendly. If we are lucky, it might even turn out to be the solution that will save us from reinventing the wheel with commonly used applications.</p>

<p class="calibre3">Before we proceed, we’ll need a cluster. It’s time to get our hands dirty.</p>

<h3 id="leanpub-auto-creating-a-cluster-3" class="calibre20">Creating A Cluster</h3>

<p class="calibre3">It’s hands-on time again. We’ll need to go back to the local copy of the <a href="https://github.com/vfarcic/k8s-specs">vfarcic/k8s-specs</a> repository and pull the latest version.</p>

<aside class="information">
    <p class="calibre3">All the commands from this chapter are available in the <a href="https://gist.github.com/84adc5ad977f5c1a682bed524b781e0c">04-helm.sh</a> Gist.</p>

</aside>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">cd</code> k8s-specs
<code class="lineno">2 </code>
<code class="lineno">3 </code>git pull
</pre></div>

</figure>

<p class="calibre3">Just as in the previous chapters, we’ll need a cluster if we are to execute hands-on exercises. The rules are still the same. You can continue using the same cluster as before, or you can switch to a different Kubernetes flavor. You can keep using one of the Kubernetes distributions listed below, or be adventurous and try something different. If you go with the latter, please let me know how it went, and I’ll test it myself and incorporate it into the list.</p>

<p class="calibre3">Cluster requirements in this chapter are the same as in the previous. We’ll need at least 3 CPUs and 3 GB RAM if running a single-node cluster, and slightly more if those resources are spread across multiple nodes.</p>

<p class="calibre3">For your convenience, the Gists and the specs we used in the previous chapter are available here as well.</p>

<ul class="calibre21">
  <li class="calibre15">
<a href="https://gist.github.com/bf08bce43a26c7299b6bd365037eb074">docker4mac-3cpu.sh</a>: <strong class="calibre18">Docker for Mac</strong> with 3 CPUs, 3 GB RAM, and with nginx Ingress.</li>
  <li class="calibre15">
<a href="https://gist.github.com/871b5d7742ea6c10469812018c308798">minikube-3cpu.sh</a>: <strong class="calibre18">minikube</strong> with 3 CPUs, 3 GB RAM, and with <code class="calibre19">ingress</code>, <code class="calibre19">storage-provisioner</code>, and <code class="calibre19">default-storageclass</code> addons enabled.</li>
  <li class="calibre15">
<a href="https://gist.github.com/2a3e4ee9cb86d4a5a65cd3e4397f48fd">kops.sh</a>: <strong class="calibre18">kops in AWS</strong> with 3 t2.small masters and 2 t2.medium nodes spread in three availability zones, and with nginx Ingress (assumes that the prerequisites are set through <a href="part0018.html#appendix-b">Appendix B</a>).</li>
  <li class="calibre15">
<a href="https://gist.github.com/2074633688a85ef3f887769b726066df">minishift-3cpu.sh</a>: <strong class="calibre18">minishift</strong> with 3 CPUs, 3 GB RAM, and version 1.16+.</li>
  <li class="calibre15">
<a href="https://gist.github.com/e3a2be59b0294438707b6b48adeb1a68">gke-2cpu.sh</a>: <strong class="calibre18">Google Kubernetes Engine (GKE)</strong> with 3 n1-highcpu-2 (2 CPUs, 1.8 GB RAM) nodes (one in each zone), and with nginx Ingress controller running on top of the “standard” one that comes with GKE. We’ll use nginx Ingress for compatibility with other platforms. Feel free to modify the YAML files if you prefer NOT to install nginx Ingress.</li>
  <li class="calibre15">
<a href="https://gist.github.com/5496f79a3886be794cc317c6f8dd7083">eks.sh</a>: <strong class="calibre18">Elastic Kubernetes Service (EKS)</strong> with 2 t2.medium nodes, with <strong class="calibre18">nginx Ingress</strong> controller, and with a <strong class="calibre18">default StorageClass</strong>.</li>
</ul>

<p class="calibre3">With a cluster up-and-running, we can proceed with an introduction to Helm.</p>

<h3 id="leanpub-auto-what-is-helm" class="calibre20">What Is Helm?</h3>

<p class="calibre3">I will not explain about Helm. I won’t even give you the elevator pitch. I’ll only say that it is a project with a big and healthy community, that it is a member of <a href="https://www.cncf.io/">Cloud Native Computing Foundation (CNCF)</a>, and that it has the backing of big guys like Google, Microsoft, and a few others. For everything else, you’ll need to follow the exercises. They’ll lead us towards an understanding of the project, and they will hopefully help us in our goal to refine our continuous deployment pipeline.</p>

<p class="calibre3">The first step is to install it.</p>

<h3 id="leanpub-auto-installing-helm" class="calibre20">Installing Helm</h3>

<p class="calibre3">Helm is a client/server type of application. We’ll start with a client. Once we have it running, we’ll use it to install the server (Tiller) inside our newly created cluster.</p>

<p class="calibre3">The Helm client is a command line utility responsible for the local development of Charts, managing repositories, and interaction with the Tiller. Tiller server, on the other hand, runs inside a Kubernetes cluster and interacts with Kube API. It listens for incoming requests from the Helm client, combines Charts and configuration values to build a release, installs Charts and tracks subsequent releases, and is in charge of upgrading and uninstalling Charts through interaction with Kube API.</p>

<aside class="information">
    <p class="calibre3">Do not get too attached to Tiller. Helm v3 will remove the server component and operate fully from the client side. At the time of this writing (June 2018), it is still unknown when will v3 reach GA.</p>

</aside>

<p class="calibre3">I’m sure that this brief explanation is more confusing than helpful. Worry not. Everything will be explained soon through examples. For now, we’ll focus on installing Helm and Tiller.</p>

<p class="calibre3">If you are a <strong class="calibre18">MacOS user</strong>, please use <a href="https://brew.sh/">Homebrew</a> to install Helm. The command is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>brew install kubernetes-helm
</pre></div>

</figure>

<p class="calibre3">If you are a <strong class="calibre18">Windows user</strong>, please use <a href="https://chocolatey.org/">Chocolatey</a> to install Helm. The command is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>choco install kubernetes-helm
</pre></div>

</figure>

<p class="calibre3">Finally, if you are neither Windows nor MacOS user, you must be running <strong class="calibre18">Linux</strong>. Please go to the <a href="https://github.com/kubernetes/helm/releases">releases</a> page, download <code class="calibre19">tar.gz</code> file, unpack it, and move the binary to <code class="calibre19">/usr/local/bin/</code>.</p>

<p class="calibre3">If you already have Helm installed, please make sure that it is newer than 2.8.2. That version, and probably a few versions before, was failing on Docker For Mac/Windows.</p>

<p class="calibre3">Once you’re done installing (or upgrading) Helm, please execute <code class="calibre19">helm help</code> to verify that it is working.</p>

<p class="calibre3">We are about to install <em class="calibre17">Tiller</em>. It’ll run inside our cluster. Just as <code class="calibre19">kubectl</code> is a client that communicates with Kube API, <code class="calibre19">helm</code> will propagate our wishes to <code class="calibre19">tiller</code> which, in turn, will issue requests to Kube API.</p>

<p class="calibre3">It should come as no surprise that Tiller will be yet another Pod in our cluster. As such, you should already know that we’ll need a ServiceAccount that will allow it to establish communication with Kube API. Since we hope to use Helm for all our installation in Kubernetes, we should give that ServiceAccount very generous permissions across the whole cluster.</p>

<p class="calibre3">Let’s take a look at the definition of a ServiceAccount we’ll create for Tiller.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/tiller-rbac.yml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">apiVersion</code><code class="calibre19">:</code> <code class="calibre19">v1</code>
<code class="lineno"> 2 </code><code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">ServiceAccount</code>
<code class="lineno"> 3 </code><code class="calibre19">metadata</code><code class="calibre19">:</code>
<code class="lineno"> 4 </code>  <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">tiller</code>
<code class="lineno"> 5 </code>  <code class="calibre19">namespace</code><code class="calibre19">:</code> <code class="calibre19">kube-system</code>
<code class="lineno"> 6 </code>
<code class="lineno"> 7 </code><code class="nn">---</code>
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code><code class="calibre19">apiVersion</code><code class="calibre19">:</code> <code class="calibre19">rbac.authorization.k8s.io/v1beta1</code>
<code class="lineno">10 </code><code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">ClusterRoleBinding</code>
<code class="lineno">11 </code><code class="calibre19">metadata</code><code class="calibre19">:</code>
<code class="lineno">12 </code>  <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">tiller</code>
<code class="lineno">13 </code><code class="calibre19">roleRef</code><code class="calibre19">:</code>
<code class="lineno">14 </code>  <code class="calibre19">apiGroup</code><code class="calibre19">:</code> <code class="calibre19">rbac.authorization.k8s.io</code>
<code class="lineno">15 </code>  <code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">ClusterRole</code>
<code class="lineno">16 </code>  <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">cluster-admin</code>
<code class="lineno">17 </code><code class="calibre19">subjects</code><code class="calibre19">:</code>
<code class="lineno">18 </code>  <code class="calibre19">-</code> <code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">ServiceAccount</code>
<code class="lineno">19 </code>    <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">tiller</code>
<code class="lineno">20 </code>    <code class="calibre19">namespace</code><code class="calibre19">:</code> <code class="calibre19">kube-system</code>
</pre></div>

</figure>

<p class="calibre3">Since by now you are an expert in ServiceAccounts, there should be no need for a detailed explanation of the definition. We’re creating a ServiceAccount called <code class="calibre19">tiller</code> in the <code class="calibre19">kube-system</code> Namespace, and we are assigning it ClusterRole <code class="calibre19">cluster-admin</code>. In other words, the account will be able to execute any operation anywhere inside the cluster.</p>

<p class="calibre3">You might be thinking that having such broad permissions might seem dangerous, and you would be right. Only a handful of people should have the user permissions to operate inside <code class="calibre19">kube-system</code> Namespace. On the other hand, we can expect much wider circle of people being able to use Helm. We’ll solve that problem later in one of the next chapters. For now, we’ll focus only on how Helm works, and get back to the permissions issue later.</p>

<p class="calibre3">Let’s create the ServiceAccount.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl create <code class="se">\</code>
<code class="lineno">2 </code>    -f helm/tiller-rbac.yml <code class="se">\</code>
<code class="lineno">3 </code>    --record --save-config
</pre></div>

</figure>

<p class="calibre3">We can see from the output that both the ServiceAccount and the ClusterRoleBinding were created.</p>

<p class="calibre3">Now that we have the ServiceAccount that gives Helm full permissions to manage any Kubernetes resource, we can proceed and install Tiller.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm init --service-account tiller
<code class="lineno">2 </code>
<code class="lineno">3 </code>kubectl -n kube-system <code class="se">\</code>
<code class="lineno">4 </code>    rollout status deploy tiller-deploy
</pre></div>

</figure>

<p class="calibre3">We used <code class="calibre19">helm init</code> to create the server component called <code class="calibre19">tiller</code>. Since our cluster uses RBAC and all the processes require authentication and permissions to communicate with Kube API, we added <code class="calibre19">--service-account tiller</code> argument. It’ll attach the ServiceAccount to the <code class="calibre19">tiller</code> Pod.</p>

<p class="calibre3">The latter command waits until the Deployment is rolled out.</p>

<p class="calibre3">We could have specified <code class="calibre19">--tiller-namespace</code> argument to deploy it to a specific Namespace. That ability will come in handy in one of the next chapters. For now, we omitted that argument, so Tiller was installed in the <code class="calibre19">kube-system</code> Namespace by default. To be on the safe side, we’ll list the Pods to confirm that it is indeed running.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n kube-system get pods
</pre></div>

</figure>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME              READY STATUS  RESTARTS AGE
<code class="lineno">2 </code>...
<code class="lineno">3 </code>tiller-deploy-... 1/1   Running 0        59s
</pre></div>

</figure>

<p class="calibre3">Helm already has a single repository pre-configured. For those of you who just installed Helm for the first time, the repository is up-to-date. On the other hand, if you happen to have Helm from before, you might want to update the repository references by executing the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm repo update
</pre></div>

</figure>

<p class="calibre3">The only thing left is to search for our favorite application hoping that it is available in the Helm repository.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm search
</pre></div>

</figure>

<p class="calibre3">The output, limited to the last few entries, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>...
<code class="lineno">2 </code>stable/weave-scope 0.9.2 1.6.5 A Helm chart for the Weave Scope cluster visual...
<code class="lineno">3 </code>stable/wordpress   1.0.7 4.9.6 Web publishing platform for building blogs and ...
<code class="lineno">4 </code>stable/zeppelin    1.0.1 0.7.2 Web-based notebook that enables data-driven, in...
<code class="lineno">5 </code>stable/zetcd       0.1.9 0.0.3 CoreOS zetcd Helm chart for Kubernetes            
</pre></div>

</figure>

<p class="calibre3">We can see that the default repository already contains quite a few commonly used applications. It is the repository that contains the official Kubernetes Charts which are carefully curated and well maintained. Later on, in one of the next chapters, we’ll add more repositories to our local Helm installation. For now, we just need Jenkins, which happens to be one of the official Charts.</p>

<p class="calibre3">I already mentioned Charts a few times. You’ll find out what they are soon. For now, all you should know is that a Chart defines everything an application needs to run in a Kubernetes cluster.</p>

<h3 id="leanpub-auto-installing-helm-charts" class="calibre20">Installing Helm Charts</h3>

<p class="calibre3">The first thing we’ll do is to confirm that Jenkins indeed exists in the official Helm repository. We could do that by executing <code class="calibre19">helm search</code> (again) and going through all the available Charts. However, the list is pretty big and growing by the day. We’ll filter the search to narrow down the output.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm search jenkins
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME           CHART VERSION APP VERSION DESCRIPTION                                \
<code class="lineno">2 </code>       
<code class="lineno">3 </code>stable/jenkins 0.16.1        2.107       Open source continuous integration server. \
<code class="lineno">4 </code>It s...
</pre></div>

</figure>

<p class="calibre3">We can see that the repository contains <code class="calibre19">stable/jenkins</code> chart based on Jenkins version 2.107.</p>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-13" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">Helm will try to install Jenkins Chart with the process in a container running as user 0. By default, that is not allowed in OpenShift. We’ll skip discussing the best approach to correct the permissions in OpenShift. I’ll assume you already know how to set the permissions on the per-Pod basis. Instead, we’ll do the simplest fix. Please execute the command that follows to allow the creation of restricted Pods to run as any user.</p>

  <p class="calibre3"><code class="calibre19">oc patch scc restricted -p '{"runAsUser":{"type": "RunAsAny"}}'</code></p>

</aside>

<p class="calibre3">We’ll install Jenkins with the default values first. If that works as expected, we’ll try to adapt it to our needs later on.</p>

<p class="calibre3">Now that we know (through <code class="calibre19">search</code>) that the name of the Chart is <code class="calibre19">stable/jenkins</code>, all we need to do is execute <code class="calibre19">helm install</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm install stable/jenkins <code class="se">\</code>
<code class="lineno">2 </code>    --name jenkins <code class="se">\</code>
<code class="lineno">3 </code>    --namespace jenkins
</pre></div>

</figure>

<p class="calibre3">We instructed Helm to install <code class="calibre19">stable/jenkins</code> with the name <code class="calibre19">jenkins</code>, and inside the Namespace also called <code class="calibre19">jenkins</code>.</p>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">NAME</code><code class="o">:</code>   <code class="calibre19">jenkins</code>
<code class="lineno"> 2 </code><code class="calibre19">LAST</code> <code class="calibre19">DEPLOYED</code><code class="o">:</code> <code class="calibre19">Sun</code> <code class="calibre19">May</code> <code class="o">...</code>
<code class="lineno"> 3 </code><code class="calibre19">NAMESPACE</code><code class="o">:</code> <code class="calibre19">jenkins</code>
<code class="lineno"> 4 </code><code class="calibre19">STATUS</code><code class="o">:</code> <code class="calibre19">DEPLOYED</code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="calibre19">RESOURCES</code><code class="o">:</code>
<code class="lineno"> 7 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">Service</code>
<code class="lineno"> 8 </code><code class="calibre19">NAME</code>          <code class="calibre19">TYPE</code>         <code class="calibre19">CLUSTER</code><code class="o">-</code><code class="calibre19">IP</code>     <code class="calibre19">EXTERNAL</code><code class="o">-</code><code class="calibre19">IP</code> <code class="calibre19">PORT</code><code class="o">(</code><code class="calibre19">S</code><code class="o">)</code>        <code class="calibre19">AGE</code>
<code class="lineno"> 9 </code><code class="calibre19">jenkins</code><code class="o">-</code><code class="calibre19">agent</code> <code class="calibre19">ClusterIP</code>    <code class="o">10.111</code><code class="o">.</code><code class="o">123.174</code> <code class="o">&lt;</code><code class="calibre19">none</code><code class="o">&gt;</code>      <code class="o">50000</code><code class="o">/</code><code class="calibre19">TCP</code>      <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">10 </code><code class="calibre19">jenkins</code>       <code class="calibre19">LoadBalancer</code> <code class="o">10.110</code><code class="o">.</code><code class="o">48.57</code>   <code class="calibre19">localhost</code>   <code class="o">8080</code><code class="o">:</code><code class="o">31294</code><code class="o">/</code><code class="calibre19">TCP</code> <code class="o">0</code><code class="calibre19">s</code>
<code class="lineno">11 </code>
<code class="lineno">12 </code><code class="o">==&gt;</code> <code class="calibre19">v1beta1</code><code class="o">/</code><code class="calibre19">Deployment</code>
<code class="lineno">13 </code><code class="calibre19">NAME</code>    <code class="calibre19">DESIRED</code> <code class="calibre19">CURRENT</code> <code class="calibre19">UP</code><code class="o">-</code><code class="calibre19">TO</code><code class="o">-</code><code class="calibre19">DATE</code> <code class="calibre19">AVAILABLE</code> <code class="calibre19">AGE</code>
<code class="lineno">14 </code><code class="calibre19">jenkins</code> <code class="o">1</code>       <code class="o">1</code>       <code class="o">1</code>          <code class="o">0</code>         <code class="o">0</code><code class="calibre19">s</code>
<code class="lineno">15 </code>
<code class="lineno">16 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">Pod</code><code class="o">(</code><code class="calibre19">related</code><code class="o">)</code>
<code class="lineno">17 </code><code class="calibre19">NAME</code>        <code class="calibre19">READY</code> <code class="calibre19">STATUS</code>   <code class="calibre19">RESTARTS</code> <code class="calibre19">AGE</code>
<code class="lineno">18 </code><code class="calibre19">jenkins</code><code class="o">-...</code> <code class="o">0</code><code class="sr">/1   Init:0/</code><code class="o">1</code> <code class="o">0</code>        <code class="o">0</code><code class="calibre19">s</code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">Secret</code>
<code class="lineno">21 </code><code class="calibre19">NAME</code>    <code class="calibre19">TYPE</code>   <code class="calibre19">DATA</code> <code class="calibre19">AGE</code>
<code class="lineno">22 </code><code class="calibre19">jenkins</code> <code class="calibre19">Opaque</code> <code class="o">2</code>    <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">23 </code>
<code class="lineno">24 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">ConfigMap</code>
<code class="lineno">25 </code><code class="calibre19">NAME</code>          <code class="calibre19">DATA</code> <code class="calibre19">AGE</code>
<code class="lineno">26 </code><code class="calibre19">jenkins</code>       <code class="o">4</code>    <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">27 </code><code class="calibre19">jenkins</code><code class="o">-</code><code class="calibre19">tests</code> <code class="o">1</code>    <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">28 </code>
<code class="lineno">29 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">PersistentVolumeClaim</code>
<code class="lineno">30 </code><code class="calibre19">NAME</code>    <code class="calibre19">STATUS</code> <code class="calibre19">VOLUME</code>  <code class="calibre19">CAPACITY</code> <code class="calibre19">ACCESS</code> <code class="calibre19">MODES</code> <code class="calibre19">STORAGECLASS</code> <code class="calibre19">AGE</code>
<code class="lineno">31 </code><code class="calibre19">jenkins</code> <code class="calibre19">Bound</code>  <code class="calibre19">pvc</code><code class="o">-...</code> <code class="o">8</code><code class="calibre19">Gi</code>      <code class="calibre19">RWO</code>          <code class="calibre19">gp2</code>          <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">32 </code>
<code class="lineno">33 </code>
<code class="lineno">34 </code><code class="calibre19">NOTES</code><code class="o">:</code>
<code class="lineno">35 </code><code class="o">1</code><code class="o">.</code> <code class="calibre19">Get</code> <code class="calibre19">your</code> <code class="s">'admin'</code> <code class="calibre19">user</code> <code class="calibre19">password</code> <code class="calibre19">by</code> <code class="calibre19">running</code><code class="o">:</code>
<code class="lineno">36 </code>  <code class="calibre19">printf</code> <code class="calibre19">$</code><code class="o">(</code><code class="calibre19">kubectl</code> <code class="k">get</code> <code class="calibre19">secret</code> <code class="o">--</code><code class="k">namespace</code> <code class="calibre19">jenkins</code> <code class="calibre19">jenkins</code> <code class="o">-</code><code class="calibre19">o</code> <code class="calibre19">jsonpath</code><code class="o">=</code><code class="s">"{.data.jenkin\</code>
<code class="lineno">37 </code><code class="s">s-admin-password}"</code> <code class="o">|</code> <code class="calibre19">base64</code> <code class="o">--</code><code class="calibre19">decode</code><code class="o">);</code><code class="calibre19">echo</code>
<code class="lineno">38 </code><code class="o">2</code><code class="o">.</code> <code class="calibre19">Get</code> <code class="calibre19">the</code> <code class="calibre19">Jenkins</code> <code class="calibre19">URL</code> <code class="calibre19">to</code> <code class="calibre19">visit</code> <code class="calibre19">by</code> <code class="calibre19">running</code> <code class="calibre19">these</code> <code class="calibre19">commands</code> <code class="k">in</code> <code class="calibre19">the</code> <code class="calibre19">same</code> <code class="calibre19">shell</code><code class="o">:</code>
<code class="lineno">39 </code>  <code class="calibre19">NOTE</code><code class="o">:</code> <code class="calibre19">It</code> <code class="calibre19">may</code> <code class="calibre19">take</code> <code class="calibre19">a</code> <code class="calibre19">few</code> <code class="calibre19">minutes</code> <code class="k">for</code> <code class="calibre19">the</code> <code class="calibre19">LoadBalancer</code> <code class="calibre19">IP</code> <code class="calibre19">to</code> <code class="calibre19">be</code> <code class="calibre19">available</code><code class="o">.</code>
<code class="lineno">40 </code>        <code class="calibre19">You</code> <code class="calibre19">can</code> <code class="calibre19">watch</code> <code class="calibre19">the</code> <code class="calibre19">status</code> <code class="calibre19">of</code> <code class="calibre19">by</code> <code class="calibre19">running</code> <code class="s">'kubectl get svc --namespace jenkins \</code>
<code class="lineno">41 </code><code class="s">-w jenkins'</code>
<code class="lineno">42 </code>  <code class="calibre19">export</code> <code class="calibre19">SERVICE_IP</code><code class="o">=</code><code class="calibre19">$</code><code class="o">(</code><code class="calibre19">kubectl</code> <code class="k">get</code> <code class="calibre19">svc</code> <code class="o">--</code><code class="k">namespace</code> <code class="calibre19">jenkins</code> <code class="calibre19">jenkins</code> <code class="o">--</code><code class="calibre19">template</code> <code class="s">"{{ ran\</code>
<code class="lineno">43 </code><code class="s">ge (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}"</code><code class="o">)</code>
<code class="lineno">44 </code>  <code class="calibre19">echo</code> <code class="calibre19">http</code><code class="o">://</code><code class="calibre19">$SERVICE_IP</code><code class="o">:</code><code class="o">8080</code><code class="o">/</code><code class="calibre19">login</code>
<code class="lineno">45 </code>
<code class="lineno">46 </code><code class="o">3</code><code class="o">.</code> <code class="calibre19">Login</code> <code class="k">with</code> <code class="calibre19">the</code> <code class="calibre19">password</code> <code class="calibre19">from</code> <code class="calibre19">step</code> <code class="o">1</code> <code class="calibre19">and</code> <code class="calibre19">the</code> <code class="calibre19">username</code><code class="o">:</code> <code class="calibre19">admin</code>
<code class="lineno">47 </code>
<code class="lineno">48 </code><code class="calibre19">For</code> <code class="calibre19">more</code> <code class="calibre19">information</code> <code class="calibre19">on</code> <code class="calibre19">running</code> <code class="calibre19">Jenkins</code> <code class="calibre19">on</code> <code class="calibre19">Kubernetes</code><code class="o">,</code> <code class="calibre19">visit</code><code class="o">:</code>
<code class="lineno">49 </code><code class="calibre19">https</code><code class="o">://</code><code class="calibre19">cloud</code><code class="o">.</code><code class="na">google</code><code class="o">.</code><code class="na">com</code><code class="sr">/solutions/</code><code class="calibre19">jenkins</code><code class="o">-</code><code class="calibre19">on</code><code class="o">-</code><code class="calibre19">container</code><code class="o">-</code><code class="calibre19">engine</code>
</pre></div>

</figure>

<p class="calibre3">At the top of the output, we can see some general information like the name we gave to the installed Chart (<code class="calibre19">jenkins</code>), when it was deployed, what the Namespace is, and the status.</p>

<p class="calibre3">Below the general information is the list of the installed resources. We can see that the Chart installed two services; one for the master and the other for the agents. Below is the Deployment and the Pod. It also created a Secret that holds the administrative username and password. We’ll use it soon. Further on, we can see that it created two ConfigMaps. One (<code class="calibre19">jenkins</code>) holds all the configurations Jenkins might need. Later on, when we customize it, the data in this ConfigMap will reflect those changes. The second ConfigMap (<code class="calibre19">jenkins-tests</code>) is, at the moment, used only to provide a command used for executing liveness and readiness probes. Finally, we can see that a PersistentVolumeClass was created as well, thus making our Jenkins fault tolerant without losing its state.</p>

<p class="calibre3">Don’t worry if you feel overwhelmed. We’ll do a couple of iterations of the Jenkins installation process, and that will give us plenty of opportunities to explore this Chart in more details. If you are impatient, please <code class="calibre19">describe</code> any of those resources to get more insight into what’s installed.</p>

<p class="calibre3">One thing worthwhile commenting right away is the type of the <code class="calibre19">jenkins</code> Service. It is, by default, set to <code class="calibre19">LoadBalancer</code>. We did not explore that type in <a href="https://amzn.to/2GvzDjy">The DevOps 2.3 Toolkit: Kubernetes</a>, primarily because the book is, for the most part, based on minikube.</p>

<p class="calibre3">On cloud providers which support external load balancers, setting the type field to <code class="calibre19">LoadBalancer</code> will provision an external load balancer for the Service. The actual creation of the load balancer happens asynchronously, and information about the provisioned balancer is published in the Serviceâ€™s <code class="calibre19">status.loadBalancer</code> field.</p>

<p class="calibre3">When a Service is of the <code class="calibre19">LoadBalancer</code> type, it publishes a random port just as if it is the <code class="calibre19">NodePort</code> type. The additional feature is that it also communicates that change to the external load balancer (LB) which, in turn, should open a port as well. In most cases, the port opened in the external LB will be the same as the Service’s <code class="calibre19">TargetPort</code>. For example, if the <code class="calibre19">TargetPort</code> of a Service is <code class="calibre19">8080</code> and the published port is <code class="calibre19">32456</code>, the external LB will be configured to accept traffic on the port <code class="calibre19">8080</code>, and it will forward traffic to one of the healthy nodes on the port <code class="calibre19">32456</code>. From there on, requests will be picked up by the Service and the standard process of forwarding it further towards the replicas will be initiated. From user’s perspective, it seems as if the published port is the same as the <code class="calibre19">TargetPort</code>.</p>

<p class="calibre3">The problem is that not all load balancers and hosting vendors support the <code class="calibre19">LoadBalancer</code> type, so we’ll have to change it to <code class="calibre19">NodePort</code> in some of the cases. Those changes will be outlined as notes specific to the Kubernetes flavor.</p>

<p class="calibre3">Going back to the Helm output…</p>

<p class="calibre3">At the bottom of the output, we can see the post-installation instructions provided by the authors of the Chart. In our case, those instructions tell us how to retrieve the administrative password from the Secret, how to open Jenkins in a browser, and how to log in.</p>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minikube-users-4" class="calibre22">A note to minikube users</h3>

  <p class="calibre3">If you go back to the output, you’ll notice that the type of the <code class="calibre19">jenkins</code> Service is <code class="calibre19">LoadBalancer</code>. Since we do not have a load balancer in front of our minikube cluster, that type will not work, and we should change it to <code class="calibre19">NodePort</code>. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">helm upgrade jenkins stable/jenkins --set Master.ServiceType=NodePort</code></p>

  <p class="calibre3">We haven’t explained the <code class="calibre19">upgrade</code> process just yet. For now, just note that we changed the Service type to <code class="calibre19">NodePort</code>.</p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-14" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">OpenShift requires Routes to make services accessible outside the cluster. To make things more complicated, they are not part of “standard Kubernetes” so we’ll need to create one using <code class="calibre19">oc</code>. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">oc -n jenkins create route edge --service jenkins --insecure-policy Allow</code></p>

  <p class="calibre3">That command created an <code class="calibre19">edge</code> Router tied to the <code class="calibre19">jenkins</code> Service. Since we do not have SSL certificates for HTTPS communication, we also specified that it is OK to use insecure policy which will allow us to access Jenkins through plain HTTP.</p>

</aside>

<p class="calibre3">Next, we’ll wait until <code class="calibre19">jenkins</code> Deployment is rolled out.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deploy jenkins
</pre></div>

</figure>

<aside class="warning">
    <p class="calibre3">The <code class="calibre19">rollout status</code> command might exit with the <code class="calibre19">error: watch closed before Until timeout</code> message. Don’t panic. Jenkins might need more time to initialize than that command’s timeout. If that happens, wait until Jenkins Pod is running.</p>

</aside>

<p class="calibre3">We are almost ready to open Jenkins in a browser. But, before we do that, we need to retrieve the hostname (or IP) through which we can access our first Helm install.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">ADDR</code><code class="o">=</code><code class="k">$(</code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    get svc jenkins <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.status.loadBalancer.ingress[0].hostname}"</code><code class="k">)</code>:8080
</pre></div>

</figure>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minikube-users-5" class="calibre22">A note to minikube users</h3>

  <p class="calibre3">Unlike some other Kubernetes flavors (e.g., AWS with kops), minikube does not have a hostname automatically assigned to us through an external load balancer. We’ll have to retrieve the IP of our minikube cluster and the port published when we changed the <code class="calibre19">jenkins</code> service to <code class="calibre19">NodePort</code>. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(minikube ip):$(kubectl -n jenkins get svc jenkins -o jsonpath="{.spec.ports[0].nodePort}")</code></p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-gke-users-11" class="calibre22">A note to GKE users</h3>

  <p class="calibre3">Unlike some other Kubernetes flavors (e.g., AWS with kops), GKE does not have a hostname automatically assigned to us through an external load balancer. Instead, we got the IP of Google’s LB. We’ll have to get that IP. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(kubectl -n jenkins get svc jenkins -o jsonpath="{.status.loadBalancer.ingress[0].ip}"):8080</code></p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-15" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">Unlike all other Kubernetes flavors, OpenShift does not use Ingress. We’ll have to retrieve the address from the <code class="calibre19">jenkins</code> Route we created previously. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(oc -n jenkins get route jenkins -o jsonpath="{.status.ingress[0].host}")</code></p>

</aside>

<p class="calibre3">To be on the safe side, we’ll <code class="calibre19">echo</code> the address we retrieved and confirm that it looks valid.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">echo</code> <code class="nv">$ADDR</code>
</pre></div>

</figure>

<p class="calibre3">The format of the output will differ from one Kubernetes flavor to another. In case of AWS with kops, it should be similar to the one that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>...us-east-2.elb.amazonaws.com
</pre></div>

</figure>

<p class="calibre3">Now we can finally open Jenkins. We won’t do much with it. Our goal, for now, is only to confirm that it is up-and-running.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>open <code class="s">"http://</code><code class="nv">$ADDR</code><code class="s">"</code>
</pre></div>

</figure>

<aside class="warning">
    <p class="calibre3">Remember that if you are a <strong class="calibre18">Windows user</strong>, you’ll have to replace <code class="calibre19">open</code> with <code class="calibre19">echo</code>, copy the output, and paste it into a new tab of your browser of choice.</p>

</aside>

<p class="calibre3">You should be presented with the login screen. There is no setup wizard indicating that this Helm chart already configured Jenkins with some sensible default values. That means that, among other things, the Chart created a user with a password during the automatic setup. We need to discover it.</p>

<p class="calibre3">Fortunately, we already saw from the <code class="calibre19">helm install</code> output that we should retrieve the password by retrieving the <code class="calibre19">jenkins-admin-password</code> entry from the <code class="calibre19">jenkins</code> secret. If you need to refresh your memory, please scroll back to the output, or ignore it all together and execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>     get secret jenkins <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.data.jenkins-admin-password}"</code> <code class="se">\</code>
<code class="lineno">4 </code>    <code class="calibre19">|</code> base64 --decode<code class="calibre19">;</code> <code class="nb">echo</code>
</pre></div>

</figure>

<p class="calibre3">The output should be a random set of characters similar to the one that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>shP7Fcsb9g
</pre></div>

</figure>

<p class="calibre3">Please copy the output and return to Jenkins` login screen in your browser. Type <em class="calibre17">admin</em> into the <em class="calibre17">User</em> field, paste the copied output into the <em class="calibre17">Password</em> field and click the <em class="calibre17">log in</em> button.</p>

<p class="calibre3">Mission accomplished. Jenkins is up-and-running without us spending any time writing YAML file with all the resources. It was set up automatically with the administrative user and probably quite a few other goodies. We’ll get to them later. For now, we’ll “play” with a few other <code class="calibre19">helm</code> commands that might come in handy.</p>

<p class="calibre3">If you are ever unsure about the details behind one of the Helm Charts, you can execute <code class="calibre19">helm inspect</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm inspect stable/jenkins
</pre></div>

</figure>

<p class="calibre3">The output of the <code class="calibre19">inspect</code> command is too big to be presented in a book. It contains all the information you might need before installing an application (in this case Jenkins).</p>

<p class="calibre3">If you prefer to go through the available Charts visually, you might want to visit <a href="https://kubeapps.com/">Kubeapps</a> project hosted by <a href="https://bitnami.com/">bitnami</a>. Click on the <em class="calibre17">Explore Apps</em> button, and you’ll be sent to the hub with the list of all the official Charts. If you search for Jenkins, you’ll end up on the <a href="https://hub.kubeapps.com/charts/stable/jenkins">page with the Chart’s details</a>. You’ll notice that the info in that page is the same as the output of the <code class="calibre19">inspect</code> command.</p>

<p class="calibre3">We won’t go back to <a href="https://kubeapps.com/">Kubeapps</a> since I prefer command line over UIs. A firm grip on the command line helps a lot when it comes to automation, which happens to be the goal of this book.</p>

<p class="calibre3">With time, the number of the Charts running in your cluster will increase, and you might be in need to list them. You can do that with the <code class="calibre19">ls</code> command.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm ls
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME    REVISION UPDATED     STATUS   CHART          NAMESPACE
<code class="lineno">2 </code>jenkins 1        Thu May ... DEPLOYED jenkins-0.16.1 jenkins
</pre></div>

</figure>

<p class="calibre3">There is not much to look at right now since we have only one Chart. Just remember that the command exists. It’ll come in handy later on.</p>

<p class="calibre3">If you need to see the details behind one of the installed Charts, please use the <code class="calibre19">status</code> command.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm status jenkins
</pre></div>

</figure>

<p class="calibre3">The output should be very similar to the one you saw when we installed the Chart. The only difference is that this time all the Pods are running.</p>

<p class="calibre3">Tiller obviously stores the information about the installed Charts somewhere. Unlike most other applications that tend to save their state on disk, or replicate data across multiple instances, tiller uses Kubernetes ConfgMaps to preserve its state.</p>

<p class="calibre3">Let’s take a look at the ConfigMaps in the <code class="calibre19">kube-system</code> Namespace where tiller is running.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n kube-system get cm
</pre></div>

</figure>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME       DATA AGE
<code class="lineno">2 </code>...
<code class="lineno">3 </code>jenkins.v1 1    25m
<code class="lineno">4 </code>...
</pre></div>

</figure>

<p class="calibre3">We can see that there is a config named <code class="calibre19">jenkins.v1</code>. We did not explore revisions just yet. For now, only assume that each new installation of a Chart is version 1.</p>

<p class="calibre3">Let’s take a look at the contents of the ConfigMap.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n kube-system <code class="se">\</code>
<code class="lineno">2 </code>    describe cm jenkins.v1
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">Name</code><code class="calibre19">:</code>        <code class="calibre19">jenkins</code><code class="calibre19">.</code><code class="calibre19">v1</code>
<code class="lineno"> 2 </code><code class="calibre19">Namespace</code><code class="calibre19">:</code>   <code class="calibre19">kube</code><code class="o">-</code><code class="calibre19">system</code>
<code class="lineno"> 3 </code><code class="calibre19">Labels</code><code class="calibre19">:</code>      <code class="calibre19">MODIFIED_AT</code><code class="o">=</code><code class="o">1527424681</code>
<code class="lineno"> 4 </code>             <code class="calibre19">NAME</code><code class="o">=</code><code class="calibre19">jenkins</code>
<code class="lineno"> 5 </code>             <code class="calibre19">OWNER</code><code class="o">=</code><code class="calibre19">TILLER</code>
<code class="lineno"> 6 </code>             <code class="calibre19">STATUS</code><code class="o">=</code><code class="calibre19">DEPLOYED</code>
<code class="lineno"> 7 </code>             <code class="calibre19">VERSION</code><code class="o">=</code><code class="o">1</code>
<code class="lineno"> 8 </code><code class="calibre19">Annotations</code><code class="calibre19">:</code> <code class="o">&lt;</code><code class="calibre19">none</code><code class="o">&gt;</code>
<code class="lineno"> 9 </code>
<code class="lineno">10 </code><code class="calibre19">Data</code>
<code class="lineno">11 </code><code class="o">====</code>
<code class="lineno">12 </code><code class="calibre19">release</code><code class="calibre19">:</code>
<code class="lineno">13 </code><code class="o">----</code>
<code class="lineno">14 </code><code class="o">[</code><code class="calibre19">ENCRYPTED</code> <code class="calibre19">RELEASE</code> <code class="calibre19">INFO</code><code class="o">]</code>
<code class="lineno">15 </code><code class="calibre19">Events</code><code class="calibre19">:</code>  <code class="o">&lt;</code><code class="calibre19">none</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre3">I replaced the content of the release Data with <code class="calibre19">[ENCRYPTED RELEASE INFO]</code> since it is too big to be presented in the book. The release contains all the info tiller used to create the first <code class="calibre19">jenkins</code> release. It is encrypted as a security precaution.</p>

<p class="calibre3">We’re finished exploring our Jenkins installation, so our next step is to remove it.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete jenkins
</pre></div>

</figure>

<p class="calibre3">The output shows that the <code class="calibre19">release "jenkins"</code> was <code class="calibre19">deleted</code>.</p>

<p class="calibre3">Since this is the first time we deleted a Helm Chart, we might just as well confirm that all the resources were indeed removed.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins get all
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME           READY STATUS      RESTARTS AGE
<code class="lineno">2 </code>po/jenkins-... 0/1   Terminating 0        5m
</pre></div>

</figure>

<p class="calibre3">Everything is gone except the Pod that is still <code class="calibre19">terminating</code>. Soon it will disappear as well, and there will be no trace of Jenkins anywhere in the cluster. At least, that’s what we’re hoping for.</p>

<p class="calibre3">Let’s check the status of the <code class="calibre19">jenkins</code> Chart.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm status jenkins
</pre></div>

</figure>

<p class="calibre3">The relevant parts of the output are as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>LAST DEPLOYED: Thu May 24 11:46:38 2018
<code class="lineno">2 </code>NAMESPACE: jenkins
<code class="lineno">3 </code>STATUS: DELETED
<code class="lineno">4 </code>
<code class="lineno">5 </code>...
</pre></div>

</figure>

<p class="calibre3">If you expected an empty output or an error stating that <code class="calibre19">jenkins</code> does not exist, you were wrong. The Chart is still in the system, only this time its status is <code class="calibre19">DELETED</code>. You’ll notice that all the resources are gone though.</p>

<p class="calibre3">When we execute <code class="calibre19">helm delete [THE_NAME_OF_A_CHART]</code>, we are only removing the Kubernetes resources. The Chart is still in the system. We could, for example, revert the <code class="calibre19">delete</code> action and return to the previous state with Jenkins up-and-running again.</p>

<p class="calibre3">If you want to delete not only the Kubernetes resources created by the Chart but also the Chart itself, please add <code class="calibre19">--purge</code> argument.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete jenkins --purge
</pre></div>

</figure>

<p class="calibre3">The output is still the same as before. It states that the <code class="calibre19">release "jenkins"</code> was <code class="calibre19">deleted</code>.</p>

<p class="calibre3">Let’s check the status now after we purged the system.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm status jenkins
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="calibre19">Error</code><code class="o">:</code> <code class="calibre19">getting</code> <code class="calibre19">deployed</code> <code class="calibre19">release</code> <code class="s">"jenkins"</code><code class="o">:</code> <code class="calibre19">release</code><code class="o">:</code> <code class="s">"jenkins"</code> <code class="calibre19">not</code> <code class="calibre19">found</code>
</pre></div>

</figure>

<p class="calibre3">This time, everything was removed, and <code class="calibre19">helm</code> cannot find the <code class="calibre19">jenkins</code> Chart anymore.</p>

<h3 id="leanpub-auto-customizing-helm-installations" class="calibre20">Customizing Helm Installations</h3>

<p class="calibre3">We’ll almost never install a Chart as we did. Even though the default values do often make a lot of sense, there is always something we need to tweak to make an application behave as we expect.</p>

<p class="calibre3">What if we do not want the Jenkins tag predefined in the Chart? What if for some reason we want to deploy Jenkins <code class="calibre19">2.112-alpine</code>? There must be a sensible way to change the tag of the <code class="calibre19">stable/jenkins</code> Chart.</p>

<p class="calibre3">Helm allows us to modify installation through variables. All we need to do is to find out which variables are available.</p>

<p class="calibre3">Besides visiting project’s documentation, we can retrieve the available values through the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm inspect values stable/jenkins
</pre></div>

</figure>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>...
<code class="lineno">2 </code>Master:
<code class="lineno">3 </code>  Name: jenkins-master
<code class="lineno">4 </code>  Image: "jenkins/jenkins"
<code class="lineno">5 </code>  ImageTag: "lts"
<code class="lineno">6 </code>  ...
</pre></div>

</figure>

<p class="calibre3">We can see that within the <code class="calibre19">Master</code> section there is a variable <code class="calibre19">ImageTag</code>. The name of the variable should be, in this case, sufficiently self-explanatory. If we need more information, we can always inspect the Chart.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm inspect stable/jenkins
</pre></div>

</figure>

<p class="calibre3">I encourage you to read the whole output at some later moment. For now, we care only about the <code class="calibre19">ImageTag</code>.</p>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>...
<code class="lineno">2 </code>| Parameter         | Description      | Default |
<code class="lineno">3 </code>| ----------------- | ---------------- | ------- |
<code class="lineno">4 </code>...
<code class="lineno">5 </code>| `Master.ImageTag` | Master image tag | `lts`   |
<code class="lineno">6 </code>...
</pre></div>

</figure>

<p class="calibre3">That did not provide much more info. Still, we do not really need more than that. We can assume that <code class="calibre19">Master.ImageTag</code> will allow us to replace the default value <code class="calibre19">lts</code> with <code class="calibre19">2.112-alpine</code>.</p>

<p class="calibre3">If we go through the documentation, we’ll discover that one of the ways to overwrite the default values is through the <code class="calibre19">--set</code> argument. Let’s give it a try.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm install stable/jenkins <code class="se">\</code>
<code class="lineno">2 </code>    --name jenkins <code class="se">\</code>
<code class="lineno">3 </code>    --namespace jenkins <code class="se">\</code>
<code class="lineno">4 </code>    --set Master.ImageTag<code class="o">=</code><code class="o">2</code>.112-alpine
</pre></div>

</figure>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minikube-users-6" class="calibre22">A note to minikube users</h3>

  <p class="calibre3">We still need to change the <code class="calibre19">jenkins</code> Service type to <code class="calibre19">NodePort</code>. Since this is specific to minikube, I did not want to include it in the command we just executed. Instead, we’ll run the same command as before. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">helm upgrade jenkins stable/jenkins --set Master.ServiceType=NodePort --reuse-values</code></p>

  <p class="calibre3">We still did not go through the <code class="calibre19">upgrade</code> process. For now, just note that we changed the Service type to <code class="calibre19">NodePort</code>.</p>

  <p class="calibre3">Alternatively, you can <code class="calibre19">delete</code> the chart and install it again but, this time, the <code class="calibre19">--set Master.ServiceType=NodePort</code> argument needs to be added to <code class="calibre19">helm install</code>.</p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-16" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">The Route we created earlier still exists, so we do not need to create it again.</p>

</aside>

<p class="calibre3">The output of the <code class="calibre19">helm install</code> command is almost the same as when we executed it the first time, so there’s probably no need to go through it again. Instead, we’ll wait until <code class="calibre19">jenkins</code> rolls out.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deployment jenkins
</pre></div>

</figure>

<p class="calibre3">Now that the Deployment rolled out, we are almost ready to test whether the change of the variable had any effect. First, we need to get the Jenkins address. We’ll retrieve it in the same way as before, so there’s no need to lengthy explanation.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">ADDR</code><code class="o">=</code><code class="k">$(</code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    get svc jenkins <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.status.loadBalancer.ingress[0].hostname}"</code><code class="k">)</code>:8080
</pre></div>

</figure>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minikube-users-7" class="calibre22">A note to minikube users</h3>

  <p class="calibre3">As a reminder, the command to retrieve the address from minikube is as follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(minikube ip):$(kubectl -n jenkins get svc jenkins -o jsonpath="{.spec.ports[0].nodePort}")</code></p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-gke-users-12" class="calibre22">A note to GKE users</h3>

  <p class="calibre3">As a reminder, the command to retrieve the address from GKE is as follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(kubectl -n jenkins get svc jenkins -o jsonpath="{.status.loadBalancer.ingress[0].ip}"):8080</code></p>

</aside>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-17" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">As a reminder, the command to retrieve the address from the OpenShift route is as follows.</p>

  <p class="calibre3"><code class="calibre19">ADDR=$(oc -n jenkins get route jenkins -o jsonpath="{.status.ingress[0].host}")</code></p>

</aside>

<p class="calibre3">As a precaution, please output the <code class="calibre19">ADDR</code> variable and check whether the address looks correct.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">echo</code> <code class="nv">$ADDR</code>
</pre></div>

</figure>

<p class="calibre3">Now we can open Jenkins UI.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>open <code class="s">"http://</code><code class="nv">$ADDR</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">This time there is no need even to log in. All we need to do is to check whether changing the tag worked. Please observe the version in the bottom-right corner of the screen. If should be <em class="calibre17">Jenkins ver. 2.112</em>.</p>

<p class="calibre3">Let’s imagine that some time passed and we decided to upgrade our Jenkins from <em class="calibre17">2.112</em> to <em class="calibre17">2.116</em>. We go through the documentation and discover that there is the <code class="calibre19">upgrade</code> command we can leverage.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm upgrade jenkins stable/jenkins <code class="se">\</code>
<code class="lineno">2 </code>    --set Master.ImageTag<code class="o">=</code><code class="o">2</code>.116-alpine <code class="se">\</code>
<code class="lineno">3 </code>    --reuse-values
</pre></div>

</figure>

<p class="calibre3">This time we did not specify the Namespace, but we did set the <code class="calibre19">--reuse-values</code> argument. With it, the upgrade will maintain all the values used the last time we installed or upgraded the Chart. The result is an upgrade of the Kubernetes resources so that they comply with our desire to change the tag, and leave everything else intact.</p>

<p class="calibre3">The output of the <code class="calibre19">upgrade</code> command, limited to the first few lines, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>Release "jenkins" has been upgraded. Happy Helming!
<code class="lineno">2 </code>LAST DEPLOYED: Thu May 24 12:51:03 2018
<code class="lineno">3 </code>NAMESPACE: jenkins
<code class="lineno">4 </code>STATUS: DEPLOYED
<code class="lineno">5 </code>...
</pre></div>

</figure>

<p class="calibre3">We can see that the release was upgraded.</p>

<p class="calibre3">To be on the safe side, we’ll describe the <code class="calibre19">jenkins</code> Deployment and confirm that the image is indeed <code class="calibre19">2.116-alpine</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    describe deployment jenkins
</pre></div>

</figure>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="calibre19">Name</code><code class="calibre19">:</code>              <code class="calibre19">jenkins</code>
<code class="lineno">2 </code><code class="calibre19">Namespace</code><code class="calibre19">:</code>         <code class="calibre19">jenkins</code>
<code class="lineno">3 </code><code class="calibre19">...</code>
<code class="lineno">4 </code><code class="calibre19">Pod</code> <code class="calibre19">Template</code><code class="calibre19">:</code>
<code class="lineno">5 </code>  <code class="calibre19">...</code>
<code class="lineno">6 </code>  <code class="calibre19">Containers</code><code class="calibre19">:</code>
<code class="lineno">7 </code>   <code class="calibre19">jenkins</code><code class="calibre19">:</code>
<code class="lineno">8 </code>    <code class="calibre19">Image</code><code class="calibre19">:</code> <code class="calibre19">jenkins</code><code class="o">/</code><code class="calibre19">jenkins</code><code class="calibre19">:</code><code class="o">2.116</code><code class="o">-</code><code class="calibre19">alpine</code>
<code class="lineno">9 </code>    <code class="calibre19">...</code>
</pre></div>

</figure>

<p class="calibre3">The image was indeed updated to the tag <code class="calibre19">2.116-alpine</code>.</p>

<p class="calibre3">To satisfy my paranoid nature, we’ll also open Jenkins UI and confirm the version there. But, before we do that, we need to wait until the update rolls out.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deployment jenkins
</pre></div>

</figure>

<p class="calibre3">Now we can open Jenkins UI.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>open <code class="s">"http://</code><code class="nv">$ADDR</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">Please note the version in the bottom-right corner of the screen. It should say <em class="calibre17">Jenkins ver. 2.116</em>.</p>

<h3 id="leanpub-auto-rolling-back-helm-revisions" class="calibre20">Rolling Back Helm Revisions</h3>

<p class="calibre3">No matter how we deploy our applications and no matter how much we trust our validations, the truth is that sooner or later we’ll have to roll back. That is especially true with third-party applications. While we could roll forward faulty applications we developed, the same is often not an option with those that are not in our control. If there is a problem and we cannot fix it fast, the only alternative is to roll back.</p>

<p class="calibre3">Fortunately, Helm provides a mechanism to roll back. Before we try it out, let’s take a look at the list of the Charts we installed so far.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm list
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME    REVISION UPDATED     STATUS   CHART          NAMESPACE
<code class="lineno">2 </code>jenkins 2        Thu May ... DEPLOYED jenkins-0.16.1 jenkins  
</pre></div>

</figure>

<p class="calibre3">As expected, we have only one Chart running in our cluster. The critical piece of information is that it is the second revision. First, we installed the Chart with Jenkins version 2.112, and then we upgraded it to 2.116.</p>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minikube-users-8" class="calibre22">A note to minikube users</h3>

  <p class="calibre3">You’ll see <code class="calibre19">3</code> revisions in your output. We executed <code class="calibre19">helm upgrade</code> after the initial install to change the type of the <code class="calibre19">jenkins</code> Service to <code class="calibre19">NodePort</code>.</p>

</aside>

<p class="calibre3">We can roll back to the previous version (<code class="calibre19">2.112</code>) by executing <code class="calibre19">helm rollback jenkins 1</code>. That would roll back from the revision <code class="calibre19">2</code> to whatever was defined as the revision <code class="calibre19">1</code>. However, in most cases that is unpractical. Most of our rollbacks are likely to be executed through our CD or CDP processes. In those cases, it might be too complicated for us to find out what was the previous release number.</p>

<p class="calibre3">Luckily, there is an undocumented feature that allows us to roll back to the previous version without explicitly setting up the revision number. By the time you read this, the feature might become documented. I was about to start working on it and submit a pull request. Luckily, while going through the code, I saw that it’s already there.</p>

<p class="calibre3">Please execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm rollback jenkins <code class="o">0</code>
</pre></div>

</figure>

<p class="calibre3">By specifying <code class="calibre19">0</code> as the revision number, Helm will roll back to the previous version. It’s as easy as that.</p>

<p class="calibre3">We got the visual confirmation in the form of the “<code class="calibre19">Rollback was a success! Happy Helming!</code>” message.</p>

<p class="calibre3">Let’s take a look at the current situation.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm list
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NAME   	REVISION UPDATED     STATUS   CHART          NAMESPACE
<code class="lineno">2 </code>jenkins	3        Thu May ... DEPLOYED jenkins-0.16.1 jenkins  
</pre></div>

</figure>

<p class="calibre3">We can see that even though we issued a rollback, Helm created a new revision <code class="calibre19">3</code>. There’s no need to panic. Every change is a new revision, even when a change means re-applying definition from one of the previous releases.</p>

<p class="calibre3">To be on the safe side, we’ll go back to Jenkins UI and confirm that we are using version <code class="calibre19">2.112</code> again.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deployment jenkins
<code class="lineno">3 </code>
<code class="lineno">4 </code>open <code class="s">"http://</code><code class="nv">$ADDR</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">We waited until Jenkins rolled out, and opened it in our favorite browser. If we look at the version information located in the bottom-right corner of the screen, we are bound to discover that it is <em class="calibre17">Jenkins ver. 2.112</em> once again.</p>

<p class="calibre3">We are about to start over one more time, so our next step it to purge Jenkins.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete jenkins --purge
</pre></div>

</figure>

<h3 id="leanpub-auto-using-yaml-values-to-customize-helm-installations" class="calibre20">Using YAML Values To Customize Helm Installations</h3>

<p class="calibre3">We managed to customize Jenkins by setting <code class="calibre19">ImageTag</code>. What if we’d like to set CPU and memory. We should also add Ingress, and that would require a few annotations. If we add Ingress, we might want to change the Service type to ClusterIP and set HostName to our domain. We should also make sure that RBAC is used. Finally, the plugins that come with the Chart are probably not all the plugins we need.</p>

<p class="calibre3">Applying all those changes through <code class="calibre19">--set</code> arguments would end up as a very long command and would constitute an undocumented installation. We’ll have to change the tactic and switch to <code class="calibre19">--values</code>. But before we do all that, we need to generate a domain we’ll use with our cluster.</p>

<p class="calibre3">We’ll use <a href="http://nip.io">nip.io</a> to generate valid domains. The service provides a wildcard DNS for any IP address. It extracts IP from the nip.io subdomain and sends it back in the response. For example, if we generate 192.168.99.100.nip.io, it’ll be resolved to 192.168.99.100. We can even add sub-sub domains like something.192.168.99.100.nip.io, and it would still be resolved to 192.168.99.100. It’s a simple and awesome service that quickly became an indispensable part of my toolbox.</p>

<p class="calibre3">The service will be handy with Ingress since it will allow us to generate separate domains for each application, instead of resorting to paths which, as you will see, are unsupported by many Charts. If our cluster is accessible through <em class="calibre17">192.168.99.100</em>, we can have <em class="calibre17">jenkins.192.168.99.100.nip.io</em> and <em class="calibre17">go-demo-3.192.168.99.100.nip.io</em>.</p>

<p class="calibre3">We could use <a href="http://xip.io">xip.ip</a> instead. For the end-users, there is no significant difference between the two. The main reason why we’ll use nip.io instead of xip.io is integration with some of the tool. Minishift, for example, comes with Routes pre-configured to use nip.io.</p>

<aside class="information">
    <p class="calibre3">Do NOT use <code class="calibre19">nip.io</code>, <code class="calibre19">xip.io</code>, or similar services for production. They are not a substitute for “real” domains, but a convenient way to generate them for testing purposes when your corporate domains are not easily accessible.</p>

</aside>

<p class="calibre3">First things first… We need to find out the IP of our cluster, or the external LB if it is available. The commands that follow will differ from one cluster type to another.</p>

<aside class="information">
    <p class="calibre3">Feel free to skip the sections that follow if you already know how to get the IP of your cluster’s entry point.</p>

</aside>

<p class="calibre3">If your cluster is running in <strong class="calibre18">AWS</strong> and was created with <strong class="calibre18">kops</strong>, we’ll need to retrieve the hostname from the Ingress Service, and extract the IP from it. Please execute the commands that follow.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">LB_HOST</code><code class="o">=</code><code class="k">$(</code>kubectl -n kube-ingress <code class="se">\</code>
<code class="lineno">2 </code>    get svc ingress-nginx <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.status.loadBalancer.ingress[0].hostname}"</code><code class="k">)</code>
<code class="lineno">4 </code>
<code class="lineno">5 </code><code class="nv">LB_IP</code><code class="o">=</code><code class="s">"</code><code class="k">$(</code>dig +short <code class="nv">$LB_HOST</code> <code class="se">\</code>
<code class="lineno">6 </code>    <code class="calibre19">|</code> tail -n <code class="o">1</code><code class="k">)</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">If your cluster is running in <strong class="calibre18">AWS</strong> and was created as <strong class="calibre18">EKS</strong>, we’ll need to retrieve the hostname from the Ingress Service, and extract the IP from it. Please execute the commands that follow.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">LB_HOST</code><code class="o">=</code><code class="k">$(</code>kubectl -n ingress-nginx <code class="se">\</code>
<code class="lineno">2 </code>    get svc ingress-nginx <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.status.loadBalancer.ingress[0].hostname}"</code><code class="k">)</code>
<code class="lineno">4 </code>
<code class="lineno">5 </code><code class="nv">LB_IP</code><code class="o">=</code><code class="s">"</code><code class="k">$(</code>dig +short <code class="nv">$LB_HOST</code> <code class="se">\</code>
<code class="lineno">6 </code>    <code class="calibre19">|</code> tail -n <code class="o">1</code><code class="k">)</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">If your cluster is running in <strong class="calibre18">Docker For Mac/Windows</strong>, the IP is <code class="calibre19">127.0.0.1</code> and all you have to do is assign it to the environment variable <code class="calibre19">LB_IP</code>. Please execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">LB_IP</code><code class="o">=</code><code class="s">"127.0.0.1"</code>
</pre></div>

</figure>

<p class="calibre3">If your cluster is running in <strong class="calibre18">minikube</strong>, the IP can be retrieved using <code class="calibre19">minikube ip</code> command. Please execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">LB_IP</code><code class="o">=</code><code class="s">"</code><code class="k">$(</code>minikube ip<code class="k">)</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">If your cluster is running in <strong class="calibre18">GKE</strong>, the IP can be retrieved from the Ingress Service. Please execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">LB_IP</code><code class="o">=</code><code class="k">$(</code>kubectl -n ingress-nginx <code class="se">\</code>
<code class="lineno">2 </code>    get svc ingress-nginx <code class="se">\</code>
<code class="lineno">3 </code>    -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s">"{.status.loadBalancer.ingress[0].ip}"</code><code class="k">)</code>
</pre></div>

</figure>

<p class="calibre3">Next, we’ll output the retrieved IP to confirm that the commands worked, and generate a sub-domain <code class="calibre19">jenkins</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">echo</code> <code class="nv">$LB_IP</code>
<code class="lineno">2 </code>
<code class="lineno">3 </code><code class="nv">HOST</code><code class="o">=</code><code class="s">"jenkins.</code><code class="nv">$LB_IP</code><code class="s">.nip.io"</code>
<code class="lineno">4 </code>
<code class="lineno">5 </code><code class="nb">echo</code> <code class="nv">$HOST</code>
</pre></div>

</figure>

<p class="calibre3">The output of the second <code class="calibre19">echo</code> command should be similar to the one that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>jenkins.192.168.99.100.nip.io
</pre></div>

</figure>

<p class="calibre3"><em class="calibre17">nip.io</em> will resolve that address to <code class="calibre19">192.168.99.100</code>, and we’ll have a unique domain for our Jenkins installation. That way we can stop using different paths to distinguish applications in Ingress config. Domains work much better. Many Helm charts do not even have the option to configure unique request paths and assume that Ingress will be configured with a unique domain.</p>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-18" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">I did not forget about you. You already have a valid domain in the <code class="calibre19">ADDR</code> variable. All we have to do is assign it to the <code class="calibre19">HOST</code> variable. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">HOST=$ADDR &amp;&amp; echo $HOST</code></p>

  <p class="calibre3">The output should be similar to <code class="calibre19">jenkins.192.168.99.100.nip.io</code>.</p>

</aside>

<p class="calibre3">Now that we have a valid <code class="calibre19">jenkins.*</code> domain, we can try to figure out how to apply all the changes we discussed.</p>

<p class="calibre3">We already learned that we can inspect all the available values using <code class="calibre19">helm inspect</code> command. Let’s take another look.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm inspect values stable/jenkins
</pre></div>

</figure>

<p class="calibre3">The output, limited to the relevant parts, is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">Master</code><code class="calibre19">:</code>
<code class="lineno"> 2 </code>  <code class="calibre19">Name</code><code class="calibre19">:</code> <code class="calibre19">jenkins-master</code>
<code class="lineno"> 3 </code>  <code class="calibre19">Image</code><code class="calibre19">:</code> <code class="s">"jenkins/jenkins"</code>
<code class="lineno"> 4 </code>  <code class="calibre19">ImageTag</code><code class="calibre19">:</code> <code class="s">"lts"</code>
<code class="lineno"> 5 </code>  <code class="calibre19">...</code>
<code class="lineno"> 6 </code>  <code class="calibre19">Cpu</code><code class="calibre19">:</code> <code class="s">"200m"</code>
<code class="lineno"> 7 </code>  <code class="calibre19">Memory</code><code class="calibre19">:</code> <code class="s">"256Mi"</code>
<code class="lineno"> 8 </code>  <code class="calibre19">...</code>
<code class="lineno"> 9 </code>  <code class="calibre19">ServiceType</code><code class="calibre19">:</code> <code class="calibre19">LoadBalancer</code>
<code class="lineno">10 </code>  <code class="c"># Master Service annotations</code>
<code class="lineno">11 </code>  <code class="calibre19">ServiceAnnotations</code><code class="calibre19">:</code> <code class="calibre19">{}</code>
<code class="lineno">12 </code>  <code class="calibre19">...</code>
<code class="lineno">13 </code>  <code class="c"># HostName: jenkins.cluster.local</code>
<code class="lineno">14 </code>  <code class="calibre19">...</code>
<code class="lineno">15 </code>  <code class="calibre19">InstallPlugins</code><code class="calibre19">:</code>
<code class="lineno">16 </code>    <code class="calibre19">-</code> <code class="calibre19">kubernetes:1.1</code>
<code class="lineno">17 </code>    <code class="calibre19">-</code> <code class="calibre19">workflow-aggregator:2.5</code>
<code class="lineno">18 </code>    <code class="calibre19">-</code> <code class="calibre19">workflow-job:2.15</code>
<code class="lineno">19 </code>    <code class="calibre19">-</code> <code class="calibre19">credentials-binding:1.13</code>
<code class="lineno">20 </code>    <code class="calibre19">-</code> <code class="calibre19">git:3.6.4</code>
<code class="lineno">21 </code>  <code class="calibre19">...</code>
<code class="lineno">22 </code>  <code class="calibre19">Ingress</code><code class="calibre19">:</code>
<code class="lineno">23 </code>    <code class="calibre19">ApiVersion</code><code class="calibre19">:</code> <code class="calibre19">extensions/v1beta1</code>
<code class="lineno">24 </code>    <code class="calibre19">Annotations</code><code class="calibre19">:</code>
<code class="lineno">25 </code>    <code class="calibre19">...</code>
<code class="lineno">26 </code><code class="nn">...</code>
<code class="lineno">27 </code><code class="calibre19">rbac</code><code class="calibre19">:</code>
<code class="lineno">28 </code>  <code class="calibre19">install</code><code class="calibre19">:</code> <code class="calibre19">false</code>
<code class="lineno">29 </code>  <code class="calibre19">...</code>
</pre></div>

</figure>

<p class="calibre3">Everything we need to accomplish our new requirements is available through the values. Some of them are already filled with defaults, while others are commented. When we look at all those values, it becomes clear that it would be unpractical to try to re-define them all through <code class="calibre19">--set</code> arguments. We’ll use <code class="calibre19">--values</code> instead. It will allow us to specify the values in a file.</p>

<p class="calibre3">I already prepared a YAML file with the values that will fulfill our requirements, so let’s take a quick look at them.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/jenkins-values.yml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">Master</code><code class="calibre19">:</code>
<code class="lineno"> 2 </code>  <code class="calibre19">ImageTag</code><code class="calibre19">:</code> <code class="s">"2.116-alpine"</code>
<code class="lineno"> 3 </code>  <code class="calibre19">Cpu</code><code class="calibre19">:</code> <code class="s">"500m"</code>
<code class="lineno"> 4 </code>  <code class="calibre19">Memory</code><code class="calibre19">:</code> <code class="s">"500Mi"</code>
<code class="lineno"> 5 </code>  <code class="calibre19">ServiceType</code><code class="calibre19">:</code> <code class="calibre19">ClusterIP</code>
<code class="lineno"> 6 </code>  <code class="calibre19">ServiceAnnotations</code><code class="calibre19">:</code>
<code class="lineno"> 7 </code>    <code class="calibre19">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</code><code class="calibre19">:</code> <code class="calibre19">http</code>
<code class="lineno"> 8 </code>  <code class="calibre19">InstallPlugins</code><code class="calibre19">:</code>
<code class="lineno"> 9 </code>    <code class="calibre19">-</code> <code class="calibre19">blueocean:1.5.0</code>
<code class="lineno">10 </code>    <code class="calibre19">-</code> <code class="calibre19">credentials:2.1.16</code>
<code class="lineno">11 </code>    <code class="calibre19">-</code> <code class="calibre19">ec2:1.39</code>
<code class="lineno">12 </code>    <code class="calibre19">-</code> <code class="calibre19">git:3.8.0</code>
<code class="lineno">13 </code>    <code class="calibre19">-</code> <code class="calibre19">git-client:2.7.1</code>
<code class="lineno">14 </code>    <code class="calibre19">-</code> <code class="calibre19">github:1.29.0</code>
<code class="lineno">15 </code>    <code class="calibre19">-</code> <code class="calibre19">kubernetes:1.5.2</code>
<code class="lineno">16 </code>    <code class="calibre19">-</code> <code class="calibre19">pipeline-utility-steps:2.0.2</code>
<code class="lineno">17 </code>    <code class="calibre19">-</code> <code class="calibre19">script-security:1.43</code>
<code class="lineno">18 </code>    <code class="calibre19">-</code> <code class="calibre19">slack:2.3</code>
<code class="lineno">19 </code>    <code class="calibre19">-</code> <code class="calibre19">thinBackup:1.9</code>
<code class="lineno">20 </code>    <code class="calibre19">-</code> <code class="calibre19">workflow-aggregator:2.5</code>
<code class="lineno">21 </code>  <code class="calibre19">Ingress</code><code class="calibre19">:</code>
<code class="lineno">22 </code>    <code class="calibre19">Annotations</code><code class="calibre19">:</code>
<code class="lineno">23 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">24 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/proxy-body-size</code><code class="calibre19">:</code> <code class="calibre19">50m</code>
<code class="lineno">25 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/proxy-request-buffering</code><code class="calibre19">:</code> <code class="s">"off"</code>
<code class="lineno">26 </code>      <code class="calibre19">ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">27 </code>      <code class="calibre19">ingress.kubernetes.io/proxy-body-size</code><code class="calibre19">:</code> <code class="calibre19">50m</code>
<code class="lineno">28 </code>      <code class="calibre19">ingress.kubernetes.io/proxy-request-buffering</code><code class="calibre19">:</code> <code class="s">"off"</code>
<code class="lineno">29 </code>  <code class="calibre19">HostName</code><code class="calibre19">:</code> <code class="calibre19">jenkins.acme.com</code>
<code class="lineno">30 </code><code class="calibre19">rbac</code><code class="calibre19">:</code>
<code class="lineno">31 </code>  <code class="calibre19">install</code><code class="calibre19">:</code> <code class="calibre19">true</code>
</pre></div>

</figure>

<p class="calibre3">As you can see, the variables in that file follow the same format as those we output through the <code class="calibre19">helm inspect values</code> command. The only difference is in values, and the fact that <code class="calibre19">helm/jenkins-values.yml</code> contains only those that we are planning to change.</p>

<p class="calibre3">We defined that the <code class="calibre19">ImageTag</code> should be fixed to <code class="calibre19">2.116-alpine</code>.</p>

<p class="calibre3">We specified that our Jenkins master will need half a CPU and 500 MB RAM. The default values of 0.2 CPU and 256 MB RAM are probably not enough. What we set is also low, but since we’re not going to run any serious load (at least not yet), what we re-defined should be enough.</p>

<p class="calibre3">The service was changed to <code class="calibre19">ClusterIP</code> to better accommodate Ingress resource we’re defining further down.</p>

<p class="calibre3">If you are not using AWS, you can ignore <code class="calibre19">ServiceAnnotations</code>. They’re telling ELB to use HTTP protocol.</p>

<p class="calibre3">Further down, we are defining the plugins we’ll use throughout the book. Their usefulness will become evident in the next chapters.</p>

<p class="calibre3">The values in the <code class="calibre19">Ingress</code> section are defining the annotations that tell Ingress not to redirect HTTP requests to HTTPS (we don’t have SSL certificates), as well as a few other less important options. We set both the old style (<code class="calibre19">ingress.kubernetes.io</code>) and the new style (<code class="calibre19">nginx.ingress.kubernetes.io</code>) of defining NGINX Ingress. That way it’ll work no matter which Ingress version you’re using. The <code class="calibre19">HostName</code> is set to a value that apparently does not exist. I could not know in advance what will be your hostname, so we’ll overwrite it later on.</p>

<p class="calibre3">Finally, we set <code class="calibre19">rbac.install</code> to <code class="calibre19">true</code> so that the Chart knows that it should set the proper permissions.</p>

<p class="calibre3">Having all those variables defined at once might be a bit overwhelming. You might want to go through the <a href="https://hub.kubeapps.com/charts/stable/jenkins">Jenkins Chart documentation</a> for more info. In some cases, documentation alone is not enough, and I often end up going through the files that form the chart. You’ll get a grip on them with time. For now, the important thing to observe is that we can re-define any number of variables through a YAML file.</p>

<p class="calibre3">Let’s install the Chart with those variables.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm install stable/jenkins <code class="se">\</code>
<code class="lineno">2 </code>    --name jenkins <code class="se">\</code>
<code class="lineno">3 </code>    --namespace jenkins <code class="se">\</code>
<code class="lineno">4 </code>    --values helm/jenkins-values.yml <code class="se">\</code>
<code class="lineno">5 </code>    --set Master.HostName<code class="o">=</code><code class="nv">$HOST</code>
</pre></div>

</figure>

<p class="calibre3">We used the <code class="calibre19">--values</code> argument to pass the contents of the <code class="calibre19">helm/jenkins-values.yml</code>. Since we had to overwrite the <code class="calibre19">HostName</code>, we used <code class="calibre19">--set</code>. If the same value is defined through <code class="calibre19">--values</code> and <code class="calibre19">--set</code>, the latter always takes precedence.</p>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-19" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">The values define Ingress which does not exist in your cluster. If we’d create a set of values specific to OpenShift, we would not define Ingress. However, since those values are supposed to work in any Kubernetes cluster, we left them intact. Given that Ingress controller does not exist, Ingress resources will have no effect, so it’s safe to leave those values.</p>

</aside>

<p class="calibre3">Next, we’ll wait for <code class="calibre19">jenkins</code> Deployment to roll out and open its UI in a browser.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n jenkins <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deployment jenkins
<code class="lineno">3 </code>
<code class="lineno">4 </code>open <code class="s">"http://</code><code class="nv">$HOST</code><code class="s">"</code>
</pre></div>

</figure>

<p class="calibre3">The fact that we opened Jenkins through a domain defined as Ingress (or Route in case of OpenShift) tells us that the values were indeed used. We can double check those currently defined for the installed Chart with the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm get values jenkins
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">Master</code><code class="calibre19">:</code>
<code class="lineno"> 2 </code>  <code class="calibre19">Cpu</code><code class="calibre19">:</code> <code class="calibre19">500m</code>
<code class="lineno"> 3 </code>  <code class="calibre19">HostName</code><code class="calibre19">:</code> <code class="calibre19">jenkins.18.220.212.56.nip.io</code>
<code class="lineno"> 4 </code>  <code class="calibre19">ImageTag</code><code class="calibre19">:</code> <code class="calibre19">2.116-alpine</code>
<code class="lineno"> 5 </code>  <code class="calibre19">Ingress</code><code class="calibre19">:</code>
<code class="lineno"> 6 </code>    <code class="calibre19">Annotations</code><code class="calibre19">:</code>
<code class="lineno"> 7 </code>      <code class="calibre19">ingress.kubernetes.io/proxy-body-size</code><code class="calibre19">:</code> <code class="calibre19">50m</code>
<code class="lineno"> 8 </code>      <code class="calibre19">ingress.kubernetes.io/proxy-request-buffering</code><code class="calibre19">:</code> <code class="s">"off"</code>
<code class="lineno"> 9 </code>      <code class="calibre19">ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">10 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/proxy-body-size</code><code class="calibre19">:</code> <code class="calibre19">50m</code>
<code class="lineno">11 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/proxy-request-buffering</code><code class="calibre19">:</code> <code class="s">"off"</code>
<code class="lineno">12 </code>      <code class="calibre19">nginx.ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">13 </code>  <code class="calibre19">InstallPlugins</code><code class="calibre19">:</code>
<code class="lineno">14 </code>  <code class="calibre19">-</code> <code class="calibre19">blueocean:1.5.0</code>
<code class="lineno">15 </code>  <code class="calibre19">-</code> <code class="calibre19">credentials:2.1.16</code>
<code class="lineno">16 </code>  <code class="calibre19">-</code> <code class="calibre19">ec2:1.39</code>
<code class="lineno">17 </code>  <code class="calibre19">-</code> <code class="calibre19">git:3.8.0</code>
<code class="lineno">18 </code>  <code class="calibre19">-</code> <code class="calibre19">git-client:2.7.1</code>
<code class="lineno">19 </code>  <code class="calibre19">-</code> <code class="calibre19">github:1.29.0</code>
<code class="lineno">20 </code>  <code class="calibre19">-</code> <code class="calibre19">kubernetes:1.5.2</code>
<code class="lineno">21 </code>  <code class="calibre19">-</code> <code class="calibre19">pipeline-utility-steps:2.0.2</code>
<code class="lineno">22 </code>  <code class="calibre19">-</code> <code class="calibre19">script-security:1.43</code>
<code class="lineno">23 </code>  <code class="calibre19">-</code> <code class="calibre19">slack:2.3</code>
<code class="lineno">24 </code>  <code class="calibre19">-</code> <code class="calibre19">thinBackup:1.9</code>
<code class="lineno">25 </code>  <code class="calibre19">-</code> <code class="calibre19">workflow-aggregator:2.5</code>
<code class="lineno">26 </code>  <code class="calibre19">Memory</code><code class="calibre19">:</code> <code class="calibre19">500Mi</code>
<code class="lineno">27 </code>  <code class="calibre19">ServiceAnnotations</code><code class="calibre19">:</code>
<code class="lineno">28 </code>    <code class="calibre19">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</code><code class="calibre19">:</code> <code class="calibre19">http</code>
<code class="lineno">29 </code>  <code class="calibre19">ServiceType</code><code class="calibre19">:</code> <code class="calibre19">ClusterIP</code>
<code class="lineno">30 </code><code class="calibre19">rbac</code><code class="calibre19">:</code>
<code class="lineno">31 </code>  <code class="calibre19">install</code><code class="calibre19">:</code> <code class="calibre19">true</code>
</pre></div>

</figure>

<p class="calibre3">Even though the order is slightly different, we can easily confirm that the values are the same as those we defined in <code class="calibre19">helm/jenkins-values.yml</code>. The exception is the <code class="calibre19">HostName</code> which was overwritten through the <code class="calibre19">--set</code> argument.</p>

<p class="calibre3">Now that we explored how to use Helm to deploy publicly available Charts, we’ll turn our attention towards development. Can we leverage the power behind Charts for our applications?</p>

<p class="calibre3">Before we proceed, please delete the Chart we installed as well as the <code class="calibre19">jenkins</code> Namespace.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete jenkins --purge
<code class="lineno">2 </code>
<code class="lineno">3 </code>kubectl delete ns jenkins
</pre></div>

</figure>

<h3 id="leanpub-auto-creating-helm-charts" class="calibre20">Creating Helm Charts</h3>

<p class="calibre3">Our next goal is to create a Chart for the <em class="calibre17">go-demo-3</em> application. We’ll use the fork you created in the previous chapter.</p>

<p class="calibre3">First, we’ll move into the fork’s directory.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">cd</code> ../go-demo-3
</pre></div>

</figure>

<p class="calibre3">To be on the safe side, we’ll push the changes you might have made in the previous chapter and then we’ll sync your fork with the upstream repository. That way we’ll guarantee that you have all the changes I might have made.</p>

<p class="calibre3">You probably already know how to push your changes and how to sync with the upstream repository. In case you don’t, the commands are as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code>git add .
<code class="lineno"> 2 </code>
<code class="lineno"> 3 </code>git commit -m <code class="se">\</code>
<code class="lineno"> 4 </code>    <code class="s">"Defining Continuous Deployment chapter"</code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code>git push
<code class="lineno"> 7 </code>
<code class="lineno"> 8 </code>git remote add upstream <code class="se">\</code>
<code class="lineno"> 9 </code>    https://github.com/vfarcic/go-demo-3.git
<code class="lineno">10 </code>
<code class="lineno">11 </code>git fetch upstream
<code class="lineno">12 </code>
<code class="lineno">13 </code>git checkout master
<code class="lineno">14 </code>
<code class="lineno">15 </code>git merge upstream/master
</pre></div>

</figure>

<p class="calibre3">We pushed the changes we made in the previous chapter, we fetched the upstream repository <em class="calibre17">vfarcic/go-demo-3</em>, and we merged the latest code from it. Now we are ready to create our first Chart.</p>

<p class="calibre3">Even though we could create a Chart from scratch by creating a specific folder structure and the required files, we’ll take a shortcut and create a sample Chart that can be modified later to suit our needs.</p>

<p class="calibre3">We won’t start with a Chart for the <em class="calibre17">go-demo-3</em> application. Instead, we’ll create a creatively named Chart <em class="calibre17">my-app</em> that we’ll use to get a basic understanding of the commands we can use to create and manage our Charts. Once we’re familiar with the process, we’ll switch to <em class="calibre17">go-demo-3</em>.</p>

<p class="calibre3">Here we go.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm create my-app
<code class="lineno">2 </code>
<code class="lineno">3 </code>ls -1 my-app
</pre></div>

</figure>

<p class="calibre3">The first command created a Chart named <em class="calibre17">my-app</em>, and the second listed the files and the directories that form the new Chart.</p>

<p class="calibre3">The output of the latter command is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>Chart.yaml
<code class="lineno">2 </code>charts
<code class="lineno">3 </code>templates
<code class="lineno">4 </code>values.yaml
</pre></div>

</figure>

<p class="calibre3">We will not go into the details behind each of those files and directories just yet. For now, just note that a Chart consists of files and directories that follow certain naming conventions.</p>

<p class="calibre3">If our Chart has dependencies, we could download them with the <code class="calibre19">dependency update</code> command.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm dependency update my-app
</pre></div>

</figure>

<p class="calibre3">The output shows that <code class="calibre19">no requirements</code> were <code class="calibre19">found in .../go-demo-3/my-app/charts</code>. That makes sense because we did not yet declare any dependencies. For now, just remember that they can be downloaded or updated.</p>

<p class="calibre3">Once we’re done with defining the Chart of an application, we can package it.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm package my-app
</pre></div>

</figure>

<p class="calibre3">We can see from the output that Helm <code class="calibre19">successfully packaged chart and saved it to: .../go-demo-3/my-app-0.1.0.tgz</code>. We do not yet have a repository for our Charts. We’ll work on that in the next chapter.</p>

<p class="calibre3">If we are unsure whether we made a mistake in our Chart, we can validate it by executing <code class="calibre19">lint</code> command.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm lint my-app
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>==&gt; Linting my-app
<code class="lineno">2 </code>[INFO] Chart.yaml: icon is recommended
<code class="lineno">3 </code>
<code class="lineno">4 </code>1 chart(s) linted, no failures
</pre></div>

</figure>

<p class="calibre3">We can see that our Chart contains no failures, at least not those based on syntax. That should come as no surprise since we did not even modify the sample Chart Helm created for us.</p>

<p class="calibre3">Charts can be installed using a Chart repository (e.g., <code class="calibre19">stable/jenkins</code>), a local Chart archive (e.g., <code class="calibre19">my-app-0.1.0.tgz</code>), an unpacked Chart directory (e.g., <code class="calibre19">my-app</code>), or a full URL (e.g., <code class="calibre19">https://acme.com/charts/my-app-0.1.0.tgz</code>). So far we used Chart repository to install Jenkins. We’ll switch to the local archive option to install <code class="calibre19">my-app</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm install ./my-app-0.1.0.tgz <code class="se">\</code>
<code class="lineno">2 </code>    --name my-app
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">NAME</code><code class="o">:</code>   <code class="calibre19">my</code><code class="o">-</code><code class="calibre19">app</code>
<code class="lineno"> 2 </code><code class="calibre19">LAST</code> <code class="calibre19">DEPLOYED</code><code class="o">:</code> <code class="calibre19">Thu</code> <code class="calibre19">May</code> <code class="o">24</code> <code class="o">13</code><code class="o">:</code><code class="o">43</code><code class="o">:</code><code class="o">17</code> <code class="o">2018</code>
<code class="lineno"> 3 </code><code class="calibre19">NAMESPACE</code><code class="o">:</code> <code class="k">default</code>
<code class="lineno"> 4 </code><code class="calibre19">STATUS</code><code class="o">:</code> <code class="calibre19">DEPLOYED</code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="calibre19">RESOURCES</code><code class="o">:</code>
<code class="lineno"> 7 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">Service</code>
<code class="lineno"> 8 </code><code class="calibre19">NAME</code>   <code class="calibre19">TYPE</code>      <code class="calibre19">CLUSTER</code><code class="o">-</code><code class="calibre19">IP</code>     <code class="calibre19">EXTERNAL</code><code class="o">-</code><code class="calibre19">IP</code> <code class="calibre19">PORT</code><code class="o">(</code><code class="calibre19">S</code><code class="o">)</code> <code class="calibre19">AGE</code>
<code class="lineno"> 9 </code><code class="calibre19">my</code><code class="o">-</code><code class="calibre19">app</code> <code class="calibre19">ClusterIP</code> <code class="o">100.65</code><code class="o">.</code><code class="o">227.236</code> <code class="o">&lt;</code><code class="calibre19">none</code><code class="o">&gt;</code>      <code class="o">80</code><code class="o">/</code><code class="calibre19">TCP</code>  <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">10 </code>
<code class="lineno">11 </code><code class="o">==&gt;</code> <code class="calibre19">v1beta2</code><code class="o">/</code><code class="calibre19">Deployment</code>
<code class="lineno">12 </code><code class="calibre19">NAME</code>   <code class="calibre19">DESIRED</code> <code class="calibre19">CURRENT</code> <code class="calibre19">UP</code><code class="o">-</code><code class="calibre19">TO</code><code class="o">-</code><code class="calibre19">DATE</code> <code class="calibre19">AVAILABLE</code> <code class="calibre19">AGE</code>
<code class="lineno">13 </code><code class="calibre19">my</code><code class="o">-</code><code class="calibre19">app</code> <code class="o">1</code>       <code class="o">1</code>       <code class="o">1</code>          <code class="o">0</code>         <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">14 </code>
<code class="lineno">15 </code><code class="o">==&gt;</code> <code class="calibre19">v1</code><code class="o">/</code><code class="calibre19">Pod</code><code class="o">(</code><code class="calibre19">related</code><code class="o">)</code>
<code class="lineno">16 </code><code class="calibre19">NAME</code>                    <code class="calibre19">READY</code> <code class="calibre19">STATUS</code>            <code class="calibre19">RESTARTS</code> <code class="calibre19">AGE</code>
<code class="lineno">17 </code><code class="calibre19">my</code><code class="o">-</code><code class="calibre19">app</code><code class="o">-</code><code class="o">7</code><code class="calibre19">f4d66bf86</code><code class="o">-</code><code class="calibre19">dns28</code> <code class="o">0</code><code class="o">/</code><code class="o">1</code>   <code class="calibre19">ContainerCreating</code> <code class="o">0</code>        <code class="o">1</code><code class="calibre19">s</code>
<code class="lineno">18 </code>
<code class="lineno">19 </code>
<code class="lineno">20 </code><code class="calibre19">NOTES</code><code class="o">:</code>
<code class="lineno">21 </code><code class="o">1</code><code class="o">.</code> <code class="calibre19">Get</code> <code class="calibre19">the</code> <code class="calibre19">application</code> <code class="calibre19">URL</code> <code class="calibre19">by</code> <code class="calibre19">running</code> <code class="calibre19">these</code> <code class="calibre19">commands</code><code class="o">:</code>
<code class="lineno">22 </code>  <code class="calibre19">export</code> <code class="calibre19">POD_NAME</code><code class="o">=</code><code class="calibre19">$</code><code class="o">(</code><code class="calibre19">kubectl</code> <code class="k">get</code> <code class="calibre19">pods</code> <code class="o">--</code><code class="k">namespace</code> <code class="k">default</code> <code class="o">-</code><code class="calibre19">l</code> <code class="s">"app=my-app,release=my-a\</code>
<code class="lineno">23 </code><code class="s">pp"</code> <code class="o">-</code><code class="calibre19">o</code> <code class="calibre19">jsonpath</code><code class="o">=</code><code class="s">"{.items[0].metadata.name}"</code><code class="o">)</code>
<code class="lineno">24 </code>  <code class="calibre19">echo</code> <code class="s">"Visit http://127.0.0.1:8080 to use your application"</code>
<code class="lineno">25 </code>  <code class="calibre19">kubectl</code> <code class="calibre19">port</code><code class="o">-</code><code class="calibre19">forward</code> <code class="calibre19">$POD_NAME</code> <code class="o">8080</code><code class="o">:</code><code class="o">80</code>
</pre></div>

</figure>

<p class="calibre3">The sample application is a straightforward one with a Service and a Deployment. There’s not much to say about it. We used it only to explore the basic commands for creating and managing Charts. We’ll delete everything we did and start over with a more serious example.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete my-app --purge
<code class="lineno">2 </code>
<code class="lineno">3 </code>rm -rf my-app
<code class="lineno">4 </code>
<code class="lineno">5 </code>rm -rf my-app-0.1.0.tgz
</pre></div>

</figure>

<p class="calibre3">We deleted the Chart from the cluster, as well as the local directory and the archive we created earlier. The time has come to apply the knowledge we obtained and explore the format of the files that constitute a Chart. We’ll switch to the <em class="calibre17">go-demo-3</em> application next.</p>

<h3 id="leanpub-auto-exploring-files-that-constitute-a-chart" class="calibre20">Exploring Files That Constitute A Chart</h3>

<p class="calibre3">I prepared a Chart that defines the <em class="calibre17">go-demo-3</em> application. We’ll use it to get familiar with writing Charts. Even if we choose to use Helm only for third-party applications, familiarity with Chart files is a must since we might have to look at them to better understand the application we want to install.</p>

<p class="calibre3">The files are located in <code class="calibre19">helm/go-demo-3</code> directory inside the repository. Let’s take a look at what we have.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>ls -1 helm/go-demo-3
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>Chart.yaml
<code class="lineno">2 </code>LICENSE
<code class="lineno">3 </code>README.md
<code class="lineno">4 </code>templates
<code class="lineno">5 </code>values.yaml
</pre></div>

</figure>

<p class="calibre3">A chart is organized as a collection of files inside a directory. The directory name is the name of the Chart (without versioning information). So, a Chart that describes <em class="calibre17">go-demo-3</em> is stored in the directory with the same name.</p>

<p class="calibre3">The first file we’ll explore is <em class="calibre17">Chart.yml</em>. It is a mandatory file with a combination of compulsory and optional fields.</p>

<p class="calibre3">Let’s take a closer look.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/Chart.yaml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">go-demo-3</code>
<code class="lineno"> 2 </code><code class="calibre19">version</code><code class="calibre19">:</code> <code class="calibre19">0.0.1</code>
<code class="lineno"> 3 </code><code class="calibre19">apiVersion</code><code class="calibre19">:</code> <code class="calibre19">v1</code>
<code class="lineno"> 4 </code><code class="calibre19">description</code><code class="calibre19">:</code> <code class="calibre19">A silly demo based on API written in Go and MongoDB</code>
<code class="lineno"> 5 </code><code class="calibre19">keywords</code><code class="calibre19">:</code>
<code class="lineno"> 6 </code><code class="calibre19">-</code> <code class="calibre19">api</code>
<code class="lineno"> 7 </code><code class="calibre19">-</code> <code class="calibre19">backend</code>
<code class="lineno"> 8 </code><code class="calibre19">-</code> <code class="calibre19">go</code>
<code class="lineno"> 9 </code><code class="calibre19">-</code> <code class="calibre19">database</code>
<code class="lineno">10 </code><code class="calibre19">-</code> <code class="calibre19">mongodb</code>
<code class="lineno">11 </code><code class="calibre19">home</code><code class="calibre19">:</code> <code class="calibre19">http://www.devopstoolkitseries.com/</code>
<code class="lineno">12 </code><code class="calibre19">sources</code><code class="calibre19">:</code>
<code class="lineno">13 </code><code class="calibre19">-</code> <code class="calibre19">https://github.com/vfarcic/go-demo-3</code>
<code class="lineno">14 </code><code class="calibre19">maintainers</code><code class="calibre19">:</code>
<code class="lineno">15 </code><code class="calibre19">-</code> <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">Viktor Farcic</code>
<code class="lineno">16 </code>  <code class="calibre19">email</code><code class="calibre19">:</code> <code class="calibre19">viktor@farcic.com</code>
</pre></div>

</figure>

<p class="calibre3">The <code class="calibre19">name</code>, <code class="calibre19">version</code>, and <code class="calibre19">apiVersion</code> are mandatory fields. All the others are optional.</p>

<p class="calibre3">Even though most of the fields should be self-explanatory, we’ll go through each of them just in case.</p>

<p class="calibre3">The <code class="calibre19">name</code> is the name of the Chart, and the <code class="calibre19">version</code> is the version. That’s obvious, isn’t it? The critical thing to note is that versions must follow <a href="http://semver.org/">SemVer 2</a> standard. The full identification of a Chart package in a repository is always a combination of a name and a version. If we package this Chart, its name would be <em class="calibre17">go-demo-3-0.0.1.tgz</em>. The <code class="calibre19">apiVersion</code> is the version of the Helm API and, at this moment, the only supported value is <code class="calibre19">v1</code>.</p>

<p class="calibre3">The rest of the fields are mostly informational. You should be able to understand their meaning so I won’t bother you with lengthy explanations.</p>

<p class="calibre3">The next in line is the LICENSE file.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/LICENSE
</pre></div>

</figure>

<p class="calibre3">The first few lines of the output are as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>The MIT License (MIT)
<code class="lineno">2 </code>
<code class="lineno">3 </code>Copyright (c) 2018 Viktor Farcic
<code class="lineno">4 </code>
<code class="lineno">5 </code>Permission is hereby granted, free ...
</pre></div>

</figure>

<p class="calibre3">The <em class="calibre17">go-demo-3</em> application is licensed as MIT. It’s up to you to decide which license you’ll use, if any.</p>

<p class="calibre3">README.md is used to describe the application.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/README.md
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>This is just a silly demo.
</pre></div>

</figure>

<p class="calibre3">I was too lazy to write a proper description. You shouldn’t be. As a rule of thumb, README.md should contain a description of the application, a list of the pre-requisites and the requirements, a description of the options available through values.yaml, and anything else you might deem important. As the extension suggests, it should be written in Markdown format.</p>

<p class="calibre3">Now we are getting to the critical part.</p>

<p class="calibre3">The values that can be used to customize the installation are defined in <code class="calibre19">values.yaml</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/values.yaml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">replicaCount</code><code class="calibre19">:</code> <code class="calibre19">3</code>
<code class="lineno"> 2 </code><code class="calibre19">dbReplicaCount</code><code class="calibre19">:</code> <code class="calibre19">3</code>
<code class="lineno"> 3 </code><code class="calibre19">image</code><code class="calibre19">:</code>
<code class="lineno"> 4 </code>  <code class="calibre19">tag</code><code class="calibre19">:</code> <code class="calibre19">latest</code>
<code class="lineno"> 5 </code>  <code class="calibre19">dbTag</code><code class="calibre19">:</code> <code class="calibre19">3.3</code>
<code class="lineno"> 6 </code><code class="calibre19">ingress</code><code class="calibre19">:</code>
<code class="lineno"> 7 </code>  <code class="calibre19">enabled</code><code class="calibre19">:</code> <code class="calibre19">true</code>
<code class="lineno"> 8 </code>  <code class="calibre19">host</code><code class="calibre19">:</code> <code class="calibre19">acme.com</code>
<code class="lineno"> 9 </code><code class="calibre19">service</code><code class="calibre19">:</code>
<code class="lineno">10 </code>  <code class="c"># Change to NodePort if ingress.enable=false</code>
<code class="lineno">11 </code>  <code class="calibre19">type</code><code class="calibre19">:</code> <code class="calibre19">ClusterIP</code>
<code class="lineno">12 </code><code class="calibre19">rbac</code><code class="calibre19">:</code>
<code class="lineno">13 </code>  <code class="calibre19">enabled</code><code class="calibre19">:</code> <code class="calibre19">true</code>
<code class="lineno">14 </code><code class="calibre19">resources</code><code class="calibre19">:</code>
<code class="lineno">15 </code>  <code class="calibre19">limits</code><code class="calibre19">:</code>
<code class="lineno">16 </code>   <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.2</code>
<code class="lineno">17 </code>   <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="calibre19">20Mi</code>
<code class="lineno">18 </code>  <code class="calibre19">requests</code><code class="calibre19">:</code>
<code class="lineno">19 </code>   <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.1</code>
<code class="lineno">20 </code>   <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="calibre19">10Mi</code>
<code class="lineno">21 </code><code class="calibre19">dbResources</code><code class="calibre19">:</code>
<code class="lineno">22 </code>  <code class="calibre19">limits</code><code class="calibre19">:</code>
<code class="lineno">23 </code>    <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="s">"200Mi"</code>
<code class="lineno">24 </code>    <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.2</code>
<code class="lineno">25 </code>  <code class="calibre19">requests</code><code class="calibre19">:</code>
<code class="lineno">26 </code>    <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="s">"100Mi"</code>
<code class="lineno">27 </code>    <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.1</code>
<code class="lineno">28 </code><code class="calibre19">dbPersistence</code><code class="calibre19">:</code>
<code class="lineno">29 </code>  <code class="c">## If defined, storageClassName: &lt;storageClass&gt;</code>
<code class="lineno">30 </code>  <code class="c">## If set to "-", storageClassName: "", which disables dynamic provisioning</code>
<code class="lineno">31 </code>  <code class="c">## If undefined (the default) or set to null, no storageClassName spec is</code>
<code class="lineno">32 </code>  <code class="c">##   set, choosing the default provisioner.  (gp2 on AWS, standard on</code>
<code class="lineno">33 </code>  <code class="c">##   GKE, AWS &amp; OpenStack)</code>
<code class="lineno">34 </code>  <code class="c">##</code>
<code class="lineno">35 </code>  <code class="c"># storageClass: "-"</code>
<code class="lineno">36 </code>  <code class="calibre19">accessMode</code><code class="calibre19">:</code> <code class="calibre19">ReadWriteOnce</code>
<code class="lineno">37 </code>  <code class="calibre19">size</code><code class="calibre19">:</code> <code class="calibre19">2Gi</code>
</pre></div>

</figure>

<p class="calibre3">As you can see, all the things that may vary from one <em class="calibre17">go-demo-3</em> installation to another are defined here. We can set how many replicas should be deployed for both the API and the DB. Tags of both can be changed as well. We can disable Ingress and change the host. We can change the type of the Service or disable RBAC. The resources are split into two groups, so that the API and the DB can be controlled separately. Finally, we can change database persistence by specifying the <code class="calibre19">storageClass</code>, the <code class="calibre19">accessMode</code>, or the <code class="calibre19">size</code>.</p>

<p class="calibre3">I should have described those values in more detail in <code class="calibre19">README.md</code>, but, as I already admitted, I was too lazy to do that. The alternative explanation of the lack of proper README is that we’ll go through the YAML files where those values are used, and everything will become much more apparent.</p>

<p class="calibre3">The important thing to note is that the values defined in that file are defaults that are used only if we do not overwrite them during the installation through <code class="calibre19">--set</code> or <code class="calibre19">--values</code> arguments.</p>

<p class="calibre3">The files that define all the resources are in the <code class="calibre19">templates</code> directory.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>ls -1 helm/go-demo-3/templates/
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>NOTES.txt
<code class="lineno">2 </code>_helpers.tpl
<code class="lineno">3 </code>deployment.yaml
<code class="lineno">4 </code>ing.yaml
<code class="lineno">5 </code>rbac.yaml
<code class="lineno">6 </code>sts.yaml
<code class="lineno">7 </code>svc.yaml
</pre></div>

</figure>

<p class="calibre3">The templates are written in <a href="https://golang.org/pkg/text/template/">Go template language</a> extended with add-on functions from <a href="https://github.com/Masterminds/sprig">Sprig library</a> and a few others specific to Helm. Don’t worry if you are new to Go. You will not need to learn it. For most use-cases, a few templating rules are more than enough for most of the use-cases. With time, you might decide to “go crazy” and learn everything templating offers. That time is not today.</p>

<p class="calibre3">When Helm renders the Chart, it’ll pass all the files in the <code class="calibre19">templates</code> directory through its templating engine.</p>

<p class="calibre3">Let’s take a look at the <code class="calibre19">NOTES.txt</code> file.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/templates/NOTES.txt
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">1. Wait until the applicaiton is rolled out:</code>
<code class="lineno"> 2 </code><code class="calibre19">  kubectl -n </code><code class="cp">{{</code> <code class="nv">.Release.Namespace</code> <code class="cp">}}</code><code class="calibre19"> rollout status deployment </code><code class="cp">{{</code> <code class="nv">template</code> <code class="s">"helm.fu\</code>
<code class="lineno"> 3 </code><code class="s">llname"</code> <code class="err">.</code> <code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 4 </code>
<code class="lineno"> 5 </code><code class="calibre19">2. Test the application by running these commands:</code>
<code class="lineno"> 6 </code><code class="cp">{{</code><code class="o">-</code> <code class="k">if</code> <code class="nv">.Values.ingress.enabled</code> <code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 7 </code><code class="calibre19">  curl http://</code><code class="cp">{{</code> <code class="nv">.Values.ingress.host</code> <code class="cp">}}</code><code class="calibre19">/demo/hello</code>
<code class="lineno"> 8 </code><code class="cp">{{</code><code class="o">-</code> <code class="k">else</code> <code class="k">if</code> <code class="nv">contains</code> <code class="s">"NodePort"</code> <code class="nv">.Values.service.type</code> <code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 9 </code><code class="calibre19">  export PORT=$(kubectl -n </code><code class="cp">{{</code> <code class="nv">.Release.Namespace</code> <code class="cp">}}</code><code class="calibre19"> get svc </code><code class="cp">{{</code> <code class="nv">template</code> <code class="s">"helm.fullna\</code>
<code class="lineno">10 </code><code class="s">me"</code> <code class="err">.</code> <code class="cp">}}</code><code class="calibre19"> -o jsonpath="{.spec.ports[0].nodePort}")</code>
<code class="lineno">11 </code>
<code class="lineno">12 </code><code class="calibre19">  # If you are running Docker for Mac/Windows</code>
<code class="lineno">13 </code><code class="calibre19">  export ADDR=localhost</code>
<code class="lineno">14 </code>
<code class="lineno">15 </code><code class="calibre19">  # If you are running minikube</code>
<code class="lineno">16 </code><code class="calibre19">  export ADDR=$(minikube ip)</code>
<code class="lineno">17 </code>
<code class="lineno">18 </code><code class="calibre19">  # If you are running anything else</code>
<code class="lineno">19 </code><code class="calibre19">  export ADDR=$(kubectl -n </code><code class="cp">{{</code> <code class="nv">.Release.Namespace</code> <code class="cp">}}</code><code class="calibre19"> get nodes -o jsonpath="{.items[0\</code>
<code class="lineno">20 </code><code class="calibre19">].status.addresses[0].address}")</code>
<code class="lineno">21 </code>
<code class="lineno">22 </code><code class="calibre19">  curl http://$NODE_IP:$PORT/demo/hello</code>
<code class="lineno">23 </code><code class="cp">{{</code><code class="o">-</code> <code class="k">else</code> <code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">24 </code><code class="calibre19">  If the application is running in OpenShift, please create a Route to enable access.</code>
<code class="lineno">25 </code>
<code class="lineno">26 </code><code class="calibre19">  For everyone else, you set ingress.enabled=false and service.type is not set to No\</code>
<code class="lineno">27 </code><code class="calibre19">dePort. The application cannot be accessed from outside the cluster.</code>
<code class="lineno">28 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">end</code> <code class="cp">}}</code><code class="calibre19"/>
</pre></div>

</figure>

<p class="calibre3">The content of the NOTES.txt file will be printed after the installation or upgrade. You already saw a similar one in action when we installed Jenkins. The instructions we received how to open it and how to retrieve the password came from the NOTES.txt file stored in Jenkins Chart.</p>

<p class="calibre3">That file is our first direct contact with Helm templating. You’ll notice that parts of it are inside <code class="calibre19">if/else</code> blocks. If we take a look at the second bullet, we can deduce that one set of instructions will be printed if <code class="calibre19">ingress</code> is <code class="calibre19">enabled</code>, another if the <code class="calibre19">type</code> of the Service is <code class="calibre19">NodePort</code>, and yet another if neither of the first two conditions is met.</p>

<p class="calibre3">Template snippets are always inside double curly braces (e.g., <code class="calibre19">{{</code> and <code class="calibre19">}}</code>). Inside them can be (often simple) logic like an <code class="calibre19">if</code> statement, as well as predefined and custom made function. An example of a custom made function is <code class="calibre19">{{ template "helm.fullname" . }}</code>. It is defined in <code class="calibre19">_helpers.tpl</code> file which we’ll explore soon.</p>

<p class="calibre3">Variables always start with a dot (<code class="calibre19">.</code>). Those coming from the <code class="calibre19">values.yaml</code> file are always prefixed with <code class="calibre19">.Values</code>. An example is <code class="calibre19">.Values.ingress.host</code> that defines the <code class="calibre19">host</code> that will be configured in our Ingress resource.</p>

<p class="calibre3">Helm also provides a set of pre-defined variables prefixed with <code class="calibre19">.Release</code>, <code class="calibre19">.Chart</code>, <code class="calibre19">.Files</code>, and <code class="calibre19">.Capabilities</code>. As an example, near the top of the NOTES.txt file is <code class="calibre19">{{ .Release.Namespace }}</code> snippet that will get converted to the Namespace into which we decided to install our Chart.</p>

<p class="calibre3">The full list of the pre-defined values is as follows (a copy of the official documentation).</p>

<ul class="calibre21">
  <li class="calibre15">
<code class="calibre19">Release.Name</code>: The name of the release (not the Chart)</li>
  <li class="calibre15">
<code class="calibre19">Release.Time</code>: The time the chart release was last updated. This will match the Last Released time on a Release object.</li>
  <li class="calibre15">
<code class="calibre19">Release.Namespace</code>: The Namespace the Chart was released to.</li>
  <li class="calibre15">
<code class="calibre19">Release.Service</code>: The service that conducted the release. Usually this is Tiller.</li>
  <li class="calibre15">
<code class="calibre19">Release.IsUpgrade</code>: This is set to <code class="calibre19">true</code> if the current operation is an upgrade or rollback.</li>
  <li class="calibre15">
<code class="calibre19">Release.IsInstall</code>: This is set to <code class="calibre19">true</code> if the current operation is an install.</li>
  <li class="calibre15">
<code class="calibre19">Release.Revision</code>: The revision number. It begins at 1, and increments with each helm upgrade.</li>
  <li class="calibre15">
<code class="calibre19">Chart</code>: The contents of the Chart.yaml. Thus, the Chart version is obtainable as Chart.Version and the maintainers are in Chart.Maintainers.</li>
  <li class="calibre15">
<code class="calibre19">Files</code>: A map-like object containing all non-special files in the Chart. This will not give you access to templates, but will give you access to additional files that are present (unless they are excluded using .helmignore). Files can be accessed using <code class="calibre19">{{index .Files "file.name"}}</code> or using the <code class="calibre19">{{.Files.Get name}}</code> or <code class="calibre19">{{.Files.GetString name}}</code> functions. You can also access the contents of the file as <code class="calibre19">[]byte</code> using <code class="calibre19">{{.Files.GetBytes}}</code>
</li>
  <li class="calibre15">
<code class="calibre19">Capabilities</code>: A map-like object that contains information about the versions of Kubernetes (<code class="calibre19">{{.Capabilities.KubeVersion}}</code>, Tiller (<code class="calibre19">{{.Capabilities.TillerVersion}}</code>, and the supported Kubernetes API versions (<code class="calibre19">{{.Capabilities.APIVersions.Has "batch/v1"}}</code>)</li>
</ul>

<p class="calibre3">You’ll also notice that our <code class="calibre19">if</code>, <code class="calibre19">else if</code>, <code class="calibre19">else</code>, and <code class="calibre19">end</code> statements start with a dash (<code class="calibre19">-</code>). That’s the Go template way of specifying that we want all empty space before the statement (when <code class="calibre19">-</code> is on the left) or after the statement (when <code class="calibre19">-</code> is on the right) to be removed.</p>

<p class="calibre3">There’s much more to Go templating that what we just explored. I’ll comment on other use-cases as they come. For now, this should be enough to get you going. You are free to consult <a href="https://golang.org/pkg/text/template/">template package documentation</a> for more info. For now, the critical thing to note is that we have the <code class="calibre19">NOTES.txt</code> file that will provide useful post-installation information to those who will use our Chart.</p>

<p class="calibre3">I mentioned <code class="calibre19">_helpers.tpl</code> as the source of custom functions and variables. Let’s take a look at it.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/templates/_helpers.tpl
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="cp">{{</code><code class="o">/*</code> <code class="nv">vim</code><code class="o">:</code> <code class="nv">set</code> <code class="nv">filetype</code><code class="o">=</code><code class="nv">mustache</code><code class="o">:</code> <code class="o">*/</code><code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 2 </code><code class="cp">{{</code><code class="o">/*</code>
<code class="lineno"> 3 </code><code class="nv">Expand</code> <code class="nv">the</code> <code class="nv">name</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">chart</code><code class="err">.</code>
<code class="lineno"> 4 </code><code class="o">*/</code><code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 5 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">define</code> <code class="s">"helm.name"</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 6 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">default</code> <code class="nv">.Chart.Name</code> <code class="nv">.Values.nameOverride</code> <code class="o">|</code> <code class="nf">trunc</code> <code class="o">63</code> <code class="o">|</code> <code class="nf">trimSuffix</code> <code class="s">"-"</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 7 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">end</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno"> 8 </code>
<code class="lineno"> 9 </code><code class="cp">{{</code><code class="o">/*</code>
<code class="lineno">10 </code><code class="nv">Create</code> <code class="nv">a</code> <code class="nv">default</code> <code class="nv">fully</code> <code class="nv">qualified</code> <code class="nv">app</code> <code class="nv">name</code><code class="err">.</code>
<code class="lineno">11 </code><code class="nv">We</code> <code class="nv">truncate</code> <code class="nv">at</code> <code class="o">63</code> <code class="nv">chars</code> <code class="nv">because</code> <code class="nv">some</code> <code class="nv">Kubernetes</code> <code class="nv">name</code> <code class="nv">fields</code> <code class="nv">are</code> <code class="nv">limited</code> <code class="nv">to</code> <code class="nv">this</code> <code class="o">(</code><code class="nv">by</code> <code class="err">\</code>
<code class="lineno">12 </code><code class="nv">the</code> <code class="nv">DNS</code> <code class="nv">naming</code> <code class="nv">spec</code><code class="o">)</code><code class="err">.</code>
<code class="lineno">13 </code><code class="nv">If</code> <code class="nv">release</code> <code class="nv">name</code> <code class="nv">contains</code> <code class="nv">chart</code> <code class="nv">name</code> <code class="nv">it</code> <code class="nv">will</code> <code class="nv">be</code> <code class="nv">used</code> <code class="k">as</code> <code class="nv">a</code> <code class="nv">full</code> <code class="nv">name</code><code class="err">.</code>
<code class="lineno">14 </code><code class="o">*/</code><code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">15 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">define</code> <code class="s">"helm.fullname"</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">16 </code><code class="cp">{{</code><code class="o">-</code> <code class="err">$</code><code class="nv">name</code> <code class="o">:=</code> <code class="nv">default</code> <code class="nv">.Chart.Name</code> <code class="nv">.Values.nameOverride</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">17 </code><code class="cp">{{</code><code class="o">-</code> <code class="k">if</code> <code class="nv">contains</code> <code class="err">$</code><code class="nv">name</code> <code class="nv">.Release.Name</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">18 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">.Release.Name</code> <code class="o">|</code> <code class="nf">trunc</code> <code class="o">63</code> <code class="o">|</code> <code class="nf">trimSuffix</code> <code class="s">"-"</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">19 </code><code class="cp">{{</code><code class="o">-</code> <code class="k">else</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">20 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">printf</code> <code class="s">"%s-%s"</code> <code class="nv">.Release.Name</code> <code class="err">$</code><code class="nv">name</code> <code class="o">|</code> <code class="nf">trunc</code> <code class="o">63</code> <code class="o">|</code> <code class="nf">trimSuffix</code> <code class="s">"-"</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">21 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">end</code> -<code class="cp">}}</code><code class="calibre19"/>
<code class="lineno">22 </code><code class="cp">{{</code><code class="o">-</code> <code class="nv">end</code> -<code class="cp">}}</code><code class="calibre19"/>
</pre></div>

</figure>

<p class="calibre3">That file is the exact copy of the <code class="calibre19">_helpers.tpl</code> file that was created with the <code class="calibre19">helm create</code> command that generated a sample Chart. You can extend it with your own functions. I didn’t. I kept it as-is. It consists of two functions with comments that describe them. The first (<code class="calibre19">helm.name</code>) returns the name of the chart trimmed to 63 characters which is the limitation for the size of some of the Kubernetes fields. The second function (<code class="calibre19">helm.fullname</code>) returns fully qualified name of the application. If you go back to the NOTES.txt file, you’ll notice that we are using <code class="calibre19">helm.fullname</code> in a few occasions. Later on, you’ll see that we’ll use it in quite a few other places.</p>

<p class="calibre3">Now that NOTES.txt and _helpers.tpl are out of the way, we can take a look at the first template that defines one of the Kubernetes resources.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/templates/deployment.yaml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">apiVersion</code><code class="calibre19">:</code> <code class="calibre19">apps/v1beta2</code>
<code class="lineno"> 2 </code><code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">Deployment</code>
<code class="lineno"> 3 </code><code class="calibre19">metadata</code><code class="calibre19">:</code>
<code class="lineno"> 4 </code>  <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.fullname" .</code> <code class="calibre19">}}</code>
<code class="lineno"> 5 </code>  <code class="calibre19">labels</code><code class="calibre19">:</code>
<code class="lineno"> 6 </code>    <code class="calibre19">app</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.name" .</code> <code class="calibre19">}}</code>
<code class="lineno"> 7 </code>    <code class="calibre19">chart</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Chart.Name</code> <code class="calibre19">}}</code><code class="calibre19">-{{ .Chart.Version | replace "+" "_" }}</code>
<code class="lineno"> 8 </code>    <code class="calibre19">release</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Name</code> <code class="calibre19">}}</code>
<code class="lineno"> 9 </code>    <code class="calibre19">heritage</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Service</code> <code class="calibre19">}}</code>
<code class="lineno">10 </code><code class="calibre19">spec</code><code class="calibre19">:</code>
<code class="lineno">11 </code>  <code class="calibre19">replicas</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Values.replicaCount</code> <code class="calibre19">}}</code>
<code class="lineno">12 </code>  <code class="calibre19">selector</code><code class="calibre19">:</code>
<code class="lineno">13 </code>    <code class="calibre19">matchLabels</code><code class="calibre19">:</code>
<code class="lineno">14 </code>      <code class="calibre19">app</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.name" .</code> <code class="calibre19">}}</code>
<code class="lineno">15 </code>      <code class="calibre19">release</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Name</code> <code class="calibre19">}}</code>
<code class="lineno">16 </code>  <code class="calibre19">template</code><code class="calibre19">:</code>
<code class="lineno">17 </code>    <code class="calibre19">metadata</code><code class="calibre19">:</code>
<code class="lineno">18 </code>      <code class="calibre19">labels</code><code class="calibre19">:</code>
<code class="lineno">19 </code>        <code class="calibre19">app</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.name" .</code> <code class="calibre19">}}</code>
<code class="lineno">20 </code>        <code class="calibre19">release</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Name</code> <code class="calibre19">}}</code>
<code class="lineno">21 </code>    <code class="calibre19">spec</code><code class="calibre19">:</code>
<code class="lineno">22 </code>      <code class="calibre19">containers</code><code class="calibre19">:</code>
<code class="lineno">23 </code>      <code class="calibre19">-</code> <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">api</code>
<code class="lineno">24 </code>        <code class="calibre19">image</code><code class="calibre19">:</code> <code class="s">"vfarcic/go-demo-3:{{</code><code class="nv"> </code><code class="s">.Values.image.tag</code><code class="nv"> </code><code class="s">}}"</code>
<code class="lineno">25 </code>        <code class="calibre19">env</code><code class="calibre19">:</code>
<code class="lineno">26 </code>        <code class="calibre19">-</code> <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">DB</code>
<code class="lineno">27 </code>          <code class="calibre19">value</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.fullname" .</code> <code class="calibre19">}}</code><code class="calibre19">-db</code>
<code class="lineno">28 </code>        <code class="calibre19">readinessProbe</code><code class="calibre19">:</code>
<code class="lineno">29 </code>          <code class="calibre19">httpGet</code><code class="calibre19">:</code>
<code class="lineno">30 </code>            <code class="calibre19">path</code><code class="calibre19">:</code> <code class="calibre19">/demo/hello</code>
<code class="lineno">31 </code>            <code class="calibre19">port</code><code class="calibre19">:</code> <code class="calibre19">8080</code>
<code class="lineno">32 </code>          <code class="calibre19">periodSeconds</code><code class="calibre19">:</code> <code class="calibre19">1</code>
<code class="lineno">33 </code>        <code class="calibre19">livenessProbe</code><code class="calibre19">:</code>
<code class="lineno">34 </code>          <code class="calibre19">httpGet</code><code class="calibre19">:</code>
<code class="lineno">35 </code>            <code class="calibre19">path</code><code class="calibre19">:</code> <code class="calibre19">/demo/hello</code>
<code class="lineno">36 </code>            <code class="calibre19">port</code><code class="calibre19">:</code> <code class="calibre19">8080</code>
<code class="lineno">37 </code>        <code class="calibre19">resources</code><code class="calibre19">:</code>
<code class="lineno">38 </code><code class="calibre19">{{</code> <code class="nv">toYaml .Values.resources | indent 10</code> <code class="calibre19">}}</code>
</pre></div>

</figure>

<p class="calibre3">That file defines the Deployment of the <em class="calibre17">go-demo-3</em> API. The first thing I did was to copy the definition from the YAML file we used in the previous chapters. Afterwards, I replaced parts of it with functions and variables. The <code class="calibre19">name</code>, for example, is now <code class="calibre19">{{ template "helm.fullname" . }}</code>, which guarantees that this Deployment will have a unique name. The rest of the file follows the same logic. Some things are using pre-defined values like <code class="calibre19">{{ .Chart.Name }}</code> and <code class="calibre19">{{ .Release.Name }}</code>, while others are using those from the <code class="calibre19">values.yaml</code>. An example of the latter is <code class="calibre19">{{ .Values.replicaCount }}</code>.</p>

<p class="calibre3">The last line contains a syntax we haven’t seen before. <code class="calibre19">{{ toYaml .Values.resources | indent 10 }}</code> will take all the entries from the <code class="calibre19">resources</code> field in the <code class="calibre19">values.yaml</code>, and convert them to YAML format. Since the final YAML needs to be correctly indented, we piped the output to <code class="calibre19">indent 10</code>. Since the <code class="calibre19">resources:</code> section of <code class="calibre19">deployment.yaml</code> is indented by eight spaces, indenting the entries from <code class="calibre19">resources</code> in <code class="calibre19">values.yaml</code> by ten will put them just two spaces inside it.</p>

<p class="calibre3">Let’s take a look at one more template.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>cat helm/go-demo-3/templates/ing.yaml
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">{{</code><code class="nv">- if .Values.ingress.enabled -</code><code class="calibre19">}}</code>
<code class="lineno"> 2 </code><code class="calibre19">{{</code><code class="nv">- $serviceName</code> <code class="calibre19">:</code><code class="nv">= include "helm.fullname" . -</code><code class="calibre19">}}</code>
<code class="lineno"> 3 </code><code class="calibre19">apiVersion</code><code class="calibre19">:</code> <code class="calibre19">extensions/v1beta1</code>
<code class="lineno"> 4 </code><code class="calibre19">kind</code><code class="calibre19">:</code> <code class="calibre19">Ingress</code>
<code class="lineno"> 5 </code><code class="calibre19">metadata</code><code class="calibre19">:</code>
<code class="lineno"> 6 </code>  <code class="calibre19">name</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.fullname" .</code> <code class="calibre19">}}</code>
<code class="lineno"> 7 </code>  <code class="calibre19">labels</code><code class="calibre19">:</code>
<code class="lineno"> 8 </code>    <code class="calibre19">app</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">template "helm.name" .</code> <code class="calibre19">}}</code>
<code class="lineno"> 9 </code>    <code class="calibre19">chart</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Chart.Name</code> <code class="calibre19">}}</code><code class="calibre19">-{{ .Chart.Version | replace "+" "_" }}</code>
<code class="lineno">10 </code>    <code class="calibre19">release</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Name</code> <code class="calibre19">}}</code>
<code class="lineno">11 </code>    <code class="calibre19">heritage</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Release.Service</code> <code class="calibre19">}}</code>
<code class="lineno">12 </code>  <code class="calibre19">annotations</code><code class="calibre19">:</code>
<code class="lineno">13 </code>    <code class="calibre19">ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">14 </code>    <code class="calibre19">nginx.ingress.kubernetes.io/ssl-redirect</code><code class="calibre19">:</code> <code class="s">"false"</code>
<code class="lineno">15 </code><code class="calibre19">spec</code><code class="calibre19">:</code>
<code class="lineno">16 </code>  <code class="calibre19">rules</code><code class="calibre19">:</code>
<code class="lineno">17 </code>  <code class="calibre19">-</code> <code class="calibre19">http</code><code class="calibre19">:</code>
<code class="lineno">18 </code>      <code class="calibre19">paths</code><code class="calibre19">:</code>
<code class="lineno">19 </code>      <code class="calibre19">-</code> <code class="calibre19">backend</code><code class="calibre19">:</code>
<code class="lineno">20 </code>          <code class="calibre19">serviceName</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">$serviceName</code> <code class="calibre19">}}</code>
<code class="lineno">21 </code>          <code class="calibre19">servicePort</code><code class="calibre19">:</code> <code class="calibre19">8080</code>
<code class="lineno">22 </code>    <code class="calibre19">host</code><code class="calibre19">:</code> <code class="calibre19">{{</code> <code class="nv">.Values.ingress.host</code> <code class="calibre19">}}</code>
<code class="lineno">23 </code><code class="calibre19">{{</code><code class="nv">- end -</code><code class="calibre19">}}</code>
</pre></div>

</figure>

<p class="calibre3">That YAML defines the Ingress resource that makes the API Deployment accessible through its Service. Most of the values are the same as in the Deployment. There’s only one difference worthwhile commenting.</p>

<p class="calibre3">The whole YAML is enveloped in the <code class="calibre19">{{- if .Values.ingress.enabled -}}</code> statement. The resource will be installed only if <code class="calibre19">ingress.enabled</code> value is set to <code class="calibre19">true</code>. Since that is already the default value in <code class="calibre19">values.yaml</code>, we’ll have to explicitly disable it if we do not want Ingress.</p>

<p class="calibre3">Feel free to explore the rest of the templates. They are following the same logic as the two we just described.</p>

<p class="calibre3">There’s one potentially significant file we did not define. We have not created <code class="calibre19">requirements.yaml</code> for <em class="calibre17">go-demo-3</em>. We did not need any. We will use it though in one of the next chapters, so I’ll save the explanation for later.</p>

<p class="calibre3">Now that we went through the files that constitute the <em class="calibre17">go-demo-3</em> Chart, we should <code class="calibre19">lint</code> it to confirm that the format does not contain any apparent issues.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm lint helm/go-demo-3
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>==&gt; Linting helm/go-demo-3
<code class="lineno">2 </code>[INFO] Chart.yaml: icon is recommended
<code class="lineno">3 </code>
<code class="lineno">4 </code>1 chart(s) linted, no failures
</pre></div>

</figure>

<p class="calibre3">If we ignore the complaint that the icon is not defined, our Chart seems to be defined correctly, and we can create a package.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm package helm/go-demo-3 -d helm
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>Successfully packaged chart and saved it to: helm/go-demo-3-0.0.1.tgz
</pre></div>

</figure>

<p class="calibre3">The <code class="calibre19">-d</code> argument is new. It specified that we want to create a package in <code class="calibre19">helm</code> directory.</p>

<p class="calibre3">We will not use the package just yet. For now, I wanted to make sure that you remember that we can create it.</p>

<h3 id="leanpub-auto-upgrading-charts" class="calibre20">Upgrading Charts</h3>

<p class="calibre3">We are about to install the <em class="calibre17">go-demo-3</em> Chart. You should already be familiar with the commands, so you can consider this as an exercise that aims to solidify what you already learned. There will be one difference when compared to the commands we executed earlier. It’ll prove to be a simple, and yet an important one for our continuous deployment processes.</p>

<p class="calibre3">We’ll start by inspecting the values.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm inspect values helm/go-demo-3
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">replicaCount</code><code class="calibre19">:</code> <code class="calibre19">3</code>
<code class="lineno"> 2 </code><code class="calibre19">dbReplicaCount</code><code class="calibre19">:</code> <code class="calibre19">3</code>
<code class="lineno"> 3 </code><code class="calibre19">image</code><code class="calibre19">:</code>
<code class="lineno"> 4 </code>  <code class="calibre19">tag</code><code class="calibre19">:</code> <code class="calibre19">latest</code>
<code class="lineno"> 5 </code>  <code class="calibre19">dbTag</code><code class="calibre19">:</code> <code class="calibre19">3.3</code>
<code class="lineno"> 6 </code><code class="calibre19">ingress</code><code class="calibre19">:</code>
<code class="lineno"> 7 </code>  <code class="calibre19">enabled</code><code class="calibre19">:</code> <code class="calibre19">true</code>
<code class="lineno"> 8 </code>  <code class="calibre19">host</code><code class="calibre19">:</code> <code class="calibre19">acme.com</code>
<code class="lineno"> 9 </code><code class="calibre19">route</code><code class="calibre19">:</code>
<code class="lineno">10 </code>  <code class="calibre19">enabled</code><code class="calibre19">:</code> <code class="calibre19">true</code>
<code class="lineno">11 </code><code class="calibre19">service</code><code class="calibre19">:</code>
<code class="lineno">12 </code>  <code class="c"># Change to NodePort if ingress.enable=false</code>
<code class="lineno">13 </code>  <code class="calibre19">type</code><code class="calibre19">:</code> <code class="calibre19">ClusterIP</code>
<code class="lineno">14 </code><code class="calibre19">rbac</code><code class="calibre19">:</code>
<code class="lineno">15 </code>  <code class="calibre19">enabled</code><code class="calibre19">:</code> <code class="calibre19">true</code>
<code class="lineno">16 </code><code class="calibre19">resources</code><code class="calibre19">:</code>
<code class="lineno">17 </code>  <code class="calibre19">limits</code><code class="calibre19">:</code>
<code class="lineno">18 </code>   <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.2</code>
<code class="lineno">19 </code>   <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="calibre19">20Mi</code>
<code class="lineno">20 </code>  <code class="calibre19">requests</code><code class="calibre19">:</code>
<code class="lineno">21 </code>   <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.1</code>
<code class="lineno">22 </code>   <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="calibre19">10Mi</code>
<code class="lineno">23 </code><code class="calibre19">dbResources</code><code class="calibre19">:</code>
<code class="lineno">24 </code>  <code class="calibre19">limits</code><code class="calibre19">:</code>
<code class="lineno">25 </code>    <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="s">"200Mi"</code>
<code class="lineno">26 </code>    <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.2</code>
<code class="lineno">27 </code>  <code class="calibre19">requests</code><code class="calibre19">:</code>
<code class="lineno">28 </code>    <code class="calibre19">memory</code><code class="calibre19">:</code> <code class="s">"100Mi"</code>
<code class="lineno">29 </code>    <code class="calibre19">cpu</code><code class="calibre19">:</code> <code class="calibre19">0.1</code>
<code class="lineno">30 </code><code class="calibre19">dbPersistence</code><code class="calibre19">:</code>
<code class="lineno">31 </code>  <code class="c">## If defined, storageClassName: &lt;storageClass&gt;</code>
<code class="lineno">32 </code>  <code class="c">## If set to "-", storageClassName: "", which disables dynamic provisioning</code>
<code class="lineno">33 </code>  <code class="c">## If undefined (the default) or set to null, no storageClassName spec is</code>
<code class="lineno">34 </code>  <code class="c">##   set, choosing the default provisioner.  (gp2 on AWS, standard on</code>
<code class="lineno">35 </code>  <code class="c">##   GKE, AWS &amp; OpenStack)</code>
<code class="lineno">36 </code>  <code class="c">##</code>
<code class="lineno">37 </code>  <code class="c"># storageClass: "-"</code>
<code class="lineno">38 </code>  <code class="calibre19">accessMode</code><code class="calibre19">:</code> <code class="calibre19">ReadWriteOnce</code>
<code class="lineno">39 </code>  <code class="calibre19">size</code><code class="calibre19">:</code> <code class="calibre19">2Gi</code>
</pre></div>

</figure>

<p class="calibre3">We are almost ready to install the application. The only thing we’re missing is the host we’ll use for the application.</p>

<p class="calibre3">You’ll find two commands below. Please execute only one of those depending on your Kubernetes flavor.</p>

<p class="calibre3">If you are <strong class="calibre18">NOT</strong> using <strong class="calibre18">minishift</strong>, please execute the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">HOST</code><code class="o">=</code><code class="s">"go-demo-3.</code><code class="nv">$LB_IP</code><code class="s">.nip.io"</code>
</pre></div>

</figure>

<p class="calibre3">If you are using minishift, you can retrieve the host with the command that follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nv">HOST</code><code class="o">=</code><code class="s">"go-demo-3-go-demo-3.</code><code class="k">$(</code>minishift ip<code class="k">)</code><code class="s">.nip.io"</code>
</pre></div>

</figure>

<p class="calibre3">No matter how you retrieved the host, we’ll output it so that we can confirm that it looks OK.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code><code class="nb">echo</code> <code class="nv">$HOST</code>
</pre></div>

</figure>

<p class="calibre3">In my case, the output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>go-demo-3.192.168.99.100.nip.io
</pre></div>

</figure>

<p class="calibre3">Now we are finally ready to install the Chart. However, we won’t use <code class="calibre19">helm install</code> as before. We’ll use <code class="calibre19">upgrade</code> instead.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm upgrade -i <code class="se">\</code>
<code class="lineno">2 </code>    go-demo-3 helm/go-demo-3 <code class="se">\</code>
<code class="lineno">3 </code>    --namespace go-demo-3 <code class="se">\</code>
<code class="lineno">4 </code>    --set image.tag<code class="o">=</code><code class="o">1</code>.0 <code class="se">\</code>
<code class="lineno">5 </code>    --set ingress.host<code class="o">=</code><code class="nv">$HOST</code> <code class="se">\</code>
<code class="lineno">6 </code>    --reuse-values
</pre></div>

</figure>

<p class="calibre3">The reason we are using <code class="calibre19">helm upgrade</code> this time lies in the fact that we are practicing the commands we hope to use inside our CDP processes. Given that we want to use the same process no matter whether it’s the first release (install) or those that follow (upgrade). It would be silly to have <code class="calibre19">if/else</code> statements that would determine whether it is the first release and thus execute the install, or to go with an upgrade. We are going with a much simpler solution. We will always upgrade the Chart. The trick is in the <code class="calibre19">-i</code> argument that can be translated to “install unless a release by the same name doesn’t already exist.”</p>

<p class="calibre3">The next two arguments are the name of the Chart (<code class="calibre19">go-demo-3</code>) and the path to the Chart (<code class="calibre19">helm/go-demo-3</code>). By using the path to the directory with the Chart, we are experiencing yet another way to supply the Chart files. In the next chapter will switch to using <code class="calibre19">tgz</code> packages.</p>

<p class="calibre3">The rest of the arguments are making sure that the correct tag is used (<code class="calibre19">1.0</code>), that Ingress is using the desired host, and that the values that might have been used in the previous upgrades are still the same (<code class="calibre19">--reuse-values</code>).</p>

<p class="calibre3">If this command is used in the continuous deployment processes, we would need to set the tag explicitly through the <code class="calibre19">--set</code> argument to ensure that the correct image is used. The host, on the other hand, is static and unlikely to change often (if ever). We would be better of defining it in <code class="calibre19">values.yaml</code>. However, since I could not predict what will be your host, we had to define it as the <code class="calibre19">--set</code> argument.</p>

<p class="calibre3">Please note that minishift does not support Ingress (at least not by default). So, it was created, but it has no effect. I thought that it is a better option than to use different commands for OpenShift than for the rest of the flavors. If minishift is your choice, feel free to add <code class="calibre19">--set ingress.enable=false</code> to the previous command.</p>

<p class="calibre3">The output of the <code class="calibre19">upgrade</code> is the same as if we executed <code class="calibre19">install</code> (resources are removed for brevity).</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno"> 1 </code><code class="calibre19">NAME</code><code class="o">:</code>   <code class="calibre19">go</code><code class="o">-</code><code class="calibre19">demo</code><code class="o">-</code><code class="o">3</code>
<code class="lineno"> 2 </code><code class="calibre19">LAST</code> <code class="calibre19">DEPLOYED</code><code class="o">:</code> <code class="calibre19">Fri</code> <code class="calibre19">May</code> <code class="o">25</code> <code class="o">14</code><code class="o">:</code><code class="o">40</code><code class="o">:</code><code class="o">31</code> <code class="o">2018</code>
<code class="lineno"> 3 </code><code class="calibre19">NAMESPACE</code><code class="o">:</code> <code class="calibre19">go</code><code class="o">-</code><code class="calibre19">demo</code><code class="o">-</code><code class="o">3</code>
<code class="lineno"> 4 </code><code class="calibre19">STATUS</code><code class="o">:</code> <code class="calibre19">DEPLOYED</code>
<code class="lineno"> 5 </code>
<code class="lineno"> 6 </code><code class="o">...</code>
<code class="lineno"> 7 </code>
<code class="lineno"> 8 </code><code class="calibre19">NOTES</code><code class="o">:</code>
<code class="lineno"> 9 </code><code class="o">1</code><code class="o">.</code> <code class="calibre19">Wait</code> <code class="calibre19">until</code> <code class="calibre19">the</code> <code class="calibre19">application</code> <code class="k">is</code> <code class="calibre19">rolled</code> <code class="calibre19">out</code><code class="o">:</code>
<code class="lineno">10 </code>  <code class="calibre19">kubectl</code> <code class="o">-</code><code class="calibre19">n</code> <code class="calibre19">go</code><code class="o">-</code><code class="calibre19">demo</code><code class="o">-</code><code class="o">3</code> <code class="calibre19">rollout</code> <code class="calibre19">status</code> <code class="calibre19">deployment</code> <code class="calibre19">go</code><code class="o">-</code><code class="calibre19">demo</code><code class="o">-</code><code class="o">3</code>
<code class="lineno">11 </code>
<code class="lineno">12 </code><code class="o">2</code><code class="o">.</code> <code class="calibre19">Test</code> <code class="calibre19">the</code> <code class="calibre19">application</code> <code class="calibre19">by</code> <code class="calibre19">running</code> <code class="calibre19">these</code> <code class="calibre19">commands</code><code class="o">:</code>
<code class="lineno">13 </code>  <code class="calibre19">curl</code> <code class="calibre19">http</code><code class="o">://</code><code class="calibre19">go</code><code class="o">-</code><code class="calibre19">demo</code><code class="o">-</code><code class="o">3.18</code><code class="o">.</code><code class="o">222.53</code><code class="o">.</code><code class="o">124</code><code class="o">.</code><code class="na">nip</code><code class="o">.</code><code class="na">io</code><code class="sr">/demo/</code><code class="calibre19">hello</code>
</pre></div>

</figure>

<aside class="warning">
    <h3 id="leanpub-auto-a-note-to-minishift-users-20" class="calibre22">A note to minishift users</h3>

  <p class="calibre3">We’ll need to create a Route separately from the Helm Chart, just as we did with Jenkins. Please execute the command that follows.</p>

  <p class="calibre3"><code class="calibre19">oc -n go-demo-3 create route edge --service go-demo-3 --insecure-policy Allow</code></p>

</aside>

<p class="calibre3">We’ll wait until the Deployment rolls out before proceeding.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>kubectl -n go-demo-3 <code class="se">\</code>
<code class="lineno">2 </code>    rollout status deployment go-demo-3
</pre></div>

</figure>

<p class="calibre3">The output is as follows.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>Waiting for rollout to finish: 0 of 3 updated replicas are available...
<code class="lineno">2 </code>Waiting for rollout to finish: 1 of 3 updated replicas are available...
<code class="lineno">3 </code>Waiting for rollout to finish: 2 of 3 updated replicas are available...
<code class="lineno">4 </code>deployment "go-demo-3" successfully rolled out
</pre></div>

</figure>

<p class="calibre3">Now we can confirm that the application is indeed working by sending a <code class="calibre19">curl</code> request.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>curl http://<code class="nv">$HOST</code>/demo/hello
</pre></div>

</figure>

<p class="calibre3">The output should display the familiar <code class="calibre19">hello, world!</code> message, thus confirming that the application is indeed running and that it is accessible through the host we defined in Ingress (or Route in case of minishift).</p>

<p class="calibre3">Let’s imagine that some time passed since we installed the first release, that someone pushed a change to the master branch, that we already run all our tests, that we built a new image, and that we pushed it to Docker Hub. In that hypothetical situation, our next step would be to execute another <code class="calibre19">helm upgrade</code>.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm upgrade -i <code class="se">\</code>
<code class="lineno">2 </code>    go-demo-3 helm/go-demo-3 <code class="se">\</code>
<code class="lineno">3 </code>    --namespace go-demo-3 <code class="se">\</code>
<code class="lineno">4 </code>    --set image.tag<code class="o">=</code><code class="o">2</code>.0 <code class="se">\</code>
<code class="lineno">5 </code>    --reuse-values
</pre></div>

</figure>

<p class="calibre3">When compared with the previous command, the difference is in the tag. This time we set it to <code class="calibre19">2.0</code>. We also removed <code class="calibre19">--set ingress.host=$HOST</code> argument. Since we have <code class="calibre19">--reuse-values</code>, all those used in the previous release will be maintained.</p>

<p class="calibre3">There’s probably no need to further validations (e.g., wait for it to roll out and send a <code class="calibre19">curl</code> request). All that’s left is to remove the Chart and delete the Namespace. We’re done with the hands-on exercises.</p>

<figure class="code">
<div class="highlight"><pre class="calibre24"><code class="calibre19"/><code class="lineno">1 </code>helm delete go-demo-3 --purge
<code class="lineno">2 </code>
<code class="lineno">3 </code>kubectl delete ns go-demo-3
</pre></div>

</figure>

<h3 id="leanpub-auto-helm-vs-openshift-templates" class="calibre20">Helm vs. OpenShift Templates</h3>

<p class="calibre3">I could give you a lengthy comparison between Helm and OpenShift templates. I won’t do that. The reason is simple. Helm is the de-facto standard for installing applications. It’s the most widely used, and its adoption is going through the roof. Among the similar tools, it has the biggest community, it has the most applications available, and it is becoming adopted by more software vendors than any other solution. The exception is RedHat. They created OpenShift templates long before Helm came into being. Helm borrowed many of its concepts, improved them, and added a few additional features. When we add to that the fact that OpenShift templates work only on OpenShift, the decision which one to use is pretty straightforward. Helm wins, unless you chose OpenShift as your Kubernetes flavor. In that case, the choice is harder to make. On the one hand, Routes and a few other OpenShift-specific types of resources cannot be defined (easily) in Helm. On the other hand, it is likely that OpenShift will switch to Helm at some moment. So, you might just as well jump into Helm right away.</p>

<p class="calibre3">I must give a big thumbs up to RedHat for paving the way towards some of the Kubernetes resources that are in use today. They created Routes when Ingress did not exist. They developed OpenShift templates before Helm was created. Both Ingress and Helm were heavily influenced by their counterparts in OpenShift. There are quite a few other similar examples.</p>

<p class="calibre3">The problem is that RedHat does not want to let go of the things they pioneered. They stick with Routes, even though Ingress become standard. If Routes provide more features than, let’s say, nginx Ingress controller, they could still maintain them as OpenShift Ingress (or whatever would be the name). Routes are not the only example. They continue forcing OpenShift templates, even though it’s clear that Helm is the de-facto standard. By not switching to the standards that they pioneered, they are making their platform incompatible with others. In the previous chapters, we experienced the pain Routes cause when trying to define YAML files that should work on all other Kubernetes flavors. Now we experienced the same problem with Helm.</p>

<p class="calibre3">If you chose OpenShift, it’s up to you to decide whether to use Helm or OpenShift templates. Both choices have pros and cons. Personally, one of the things that attract me the most with Kubernetes is the promise that our applications can run on any hosting solution and on any Kubernetes flavor. RedHat is breaking that promise. It’s not that I don’t expect different solutions to come up with new things that distinguish them from the competition. I do. OpenShift has quite a few of those. But, it also has features that have equally good or better equivalents that are part of Kubernetes core or widely accepted by the community. Helm is one of those that are better than their counterpart in OpenShift.</p>

<p class="calibre3">We’ll continue using Helm throughout the rest of the book. If you do choose to stick with OpenShift templates, you’ll have to do a few modifications to the examples. The good news is that those changes should be relatively easy to make. I believe that you won’t have a problem adapting.</p>

<h3 id="leanpub-auto-what-now-3" class="calibre20">What Now?</h3>

<p class="calibre3">We have a couple of problems left to solve. We did not yet figure out how to store the Helm charts in a way that they can be easily retrieved and used by others. We’ll tackle that issue in the next chapter.</p>

<p class="calibre3">I suggest you take a rest. You deserve it. If you do feel that way, please destroy the cluster. Otherwise, jump to the next chapter right away. The choice is yours.</p>



</div>
</body></html>