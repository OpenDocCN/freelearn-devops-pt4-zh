<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer026">
			<h1 id="_idParaDest-57"><em class="italic"><a id="_idTextAnchor115"/>Chapter 2</em>: Deploying the Datadog Agent</h1>
			<p>In the previous chapter, we learned that the cornerstone of a monitoring tool is the group of metrics that helps to check the health of the production system. The primary tasks of the monitoring tool are to collect metric values periodically as time series data and to alert on issues based on the thresholds set for each metric. </p>
			<p>The common method used by monitoring tools to collect such data is to run an agent process close to where the software application runs, be it on a bare-metal server, virtual machine, or container. This would enable the monitoring agent to collect metric values directly by querying the software application and the infrastructure where it runs. </p>
			<p>Datadog collects such data in various ways and like other monitoring tools, it also provides an agent. The agent gathers monitoring data from the local environment and uploads that to the Datadog SaaS backend in the cloud. In this chapter, we will learn how the Datadog Agent is configured to run in production environments.</p>
			<p>This chapter will cover the following topics:</p>
			<ul>
				<li>Installing the Datadog Agent</li>
				<li>Agent components</li>
				<li>Agent as a container</li>
				<li>Deploying the agent – use cases</li>
				<li>Advanced agent configuration</li>
			</ul>
			<h1 id="_idParaDest-58"><a id="_idTextAnchor116"/>Technical requirements</h1>
			<p>To try out the examples mentioned in this book, you need to have the following tools and resources:</p>
			<ul>
				<li>An Ubuntu 18.04 environment with Bash shell. The Datadog Agent can be installed on a variety of operating systems and Ubuntu is chosen only as a sample environment.</li>
				<li>A Datadog account and a user with admin-level access.</li>
				<li>Docker</li>
			</ul>
			<h1 id="_idParaDest-59"><a id="_idTextAnchor117"/>Installing the Datadog Agent</h1>
			<p>The Datadog Agent can be <a id="_idIndexMarker181"/>configured to run in multiple ways for it to monitor the infrastructure and the processes, including microservices in the environment where it runs. It can run at the host level and as a microservice and the actual configuration would usually depend on how the application software is deployed.</p>
			<h2 id="_idParaDest-60"><a id="_idTextAnchor118"/>Runtime configurations</h2>
			<p>There are multiple ways you can <a id="_idIndexMarker182"/>deploy the Datadog Agent in runtime environments to collect events and data, and such configurations depend largely on how the applications are deployed. For example, if all the applications run directly on the host, then the Datadog Agent is run directly on the host as well. Let's look at the common runtime configurations.  </p>
			<p>The Datadog Agent can be configured to run in three different ways locally, as illustrated in the diagrams shown as follows. In all the cases, the agent also collects data on the infrastructure health in addition to collecting application-specific metrics:</p>
			<ul>
				<li><strong class="bold">As a service on the host monitoring application processes</strong>: In this case, the Datadog Agent service monitors one or more application processes or services running on the same host:<div id="_idContainer015" class="IMG---Figure"><img src="Images/Figure_2.1_B16483.jpg" alt="Figure 2.1 – The Datadog Agent as a service on the host monitoring services&#13;&#10;" width="603" height="406"/></div></li>
			</ul>
			<p class="figure-caption"><a id="_idTextAnchor119"/></p>
			<p class="figure-caption">Figure 2.1 – The Datadog Agent as a service on the host monitoring services</p>
			<ul>
				<li><strong class="bold">As a service on the Docker host monitoring application containers</strong>: In this case, the software application is <a id="_idIndexMarker183"/>deployed as containers on the Docker host and the Datadog Agent runs directly on the host, monitoring the health of the containers and the application:</li>
			</ul>
			<div>
				<div id="_idContainer016" class="IMG---Figure">
					<img src="Images/Figure_2.2_B16483.jpg" alt="Figure 2.2 – The Datadog Agent as a service on the host monitoring microservices&#13;&#10;" width="620" height="480"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.2 – The Datadog Agent as a service on the host monitoring microservices</p>
			<ul>
				<li><strong class="bold">As a container on the Docker host monitoring application containers</strong>: In this configuration, both the <a id="_idIndexMarker184"/>Datadog Agent and the application are run in containers on the Docker host:</li>
			</ul>
			<div>
				<div id="_idContainer017" class="IMG---Figure">
					<img src="Images/Figure_2.3_B16483.jpg" alt="Figure 2.3 – The Datadog Agent as a microservice monitoring other microservices&#13;&#10;" width="491" height="568"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.3 – The Datadog Agent as a microservice monitoring other microservices</p>
			<p>A real-life configuration <a id="_idIndexMarker185"/>might be a little more nuanced, but these basic configurations provide core ideas on how the Datadog Agent can be deployed to collect monitoring data:</p>
			<div>
				<div id="_idContainer018" class="IMG---Figure">
					<img src="Images/Figure_2.4_B16483.jpg" alt="Figure 2.4 – The Datadog Agent communicates with its SaaS backend&#13;&#10;" width="355" height="641"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.4 – The Datadog Agent communicates with its SaaS backend</p>
			<p>In all these <a id="_idIndexMarker186"/>three configurations and their variations, the Datadog Agent should be able to connect to the Datadog SaaS backend through the company network and internet, to upload the metrics collected locally. Therefore, configuring the company network firewall to enable the traffic going out from the Datadog Agent is a prerequisite for it to be operational. While this network access is allowed by default in most environments, in some restrictive situations, configuring the network suitably is a requirement for rolling out Datadog. </p>
			<p>In general, if the application software is deployed as microservices, it is better to also deploy the Datadog Agent as a microservice. Likewise, in a non-microservice environment, the Datadog Agent is run directly on the hosts. Maintenance tasks such as version upgrades are very easy if the agent is deployed as a microservice, which is the preferred method in a compatible environment.<a id="_idTextAnchor120"/> </p>
			<h2 id="_idParaDest-61"><a id="_idTextAnchor121"/>Steps for installing the agent</h2>
			<p>Datadog supports a <a id="_idIndexMarker187"/>wide variety of client platforms where the agent can be run, such as Windows, Kubernetes, Docker, and all the popular Linux distributions, such as Ubuntu, CentOS, and Red Hat Enterprise Linux. As an example, we will look at how the agent is installed on an Ubuntu host. On other operating systems, the steps are similar with changes specific to platform differences accounted for.</p>
			<p>Before an agent can be installed, you should sign up for a Datadog account. Datadog allows you to try out most of its features for free for a 2-week trial period. Once you have access to an account, you will get <a id="_idIndexMarker188"/>access to an <strong class="bold">API key</strong> for that account. When an agent is installed, the API key has to be specified and that's how the Datadog SaaS backend correlates the agent traffic to a customer account.</p>
			<p>For the sample steps, we will use Datadog Agent 7. Older versions are also supported, and version-specific steps can be found in the official documentation.</p>
			<p>On Linux distributions, the installation step involves just one command that can be executed from the command line. To obtain the command, you can follow these steps on the Datadog dashboard:</p>
			<ol>
				<li> Click on the <strong class="bold">Integrations</strong> main menu, and then select <strong class="bold">Agent</strong>:<div id="_idContainer019" class="IMG---Figure"><img src="Images/Figure_2.5_B16483.jpg" alt="Figure 2.5 – Agent menu for obtaining installation steps&#13;&#10;" width="1064" height="713"/></div><p class="figure-caption">Figure 2.5 – Agent menu for obtaining installation steps</p></li>
				<li>On the left pane, the <a id="_idIndexMarker189"/>target operating system can be selected to view the command that can be used to install the agent on that platform:</li>
			</ol>
			<div>
				<div id="_idContainer020" class="IMG---Figure">
					<img src="Images/Figure_2.6_B16483.jpg" alt="Figure 2.6 – Target platform-specific steps for installation&#13;&#10;" width="1179" height="348"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.6 – Target platform-specific steps for installation</p>
			<p>As you can see, for Ubuntu we have a command similar to this:</p>
			<p class="source-code">DD_AGENT_MAJOR_VERSION=7 DD_API_KEY=&lt;DATADOG_API_KEY&gt; bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/scripts/install_script.sh)"</p>
			<p>Basically, this command sets two environment variables pointing to the Datadog Agent version to be installed and the API key, downloads the install script, and executes it. </p>
			<p>Installation of the Datadog Agent directly on a host machine is as simple as that. We will see how it can be deployed as a container later.</p>
			<p>Once the <a id="_idIndexMarker190"/>agent is installed successfully, it will try to connect to the Datadog backend. The corresponding host will be listed on the dashboard under <strong class="bold">Infrastructure</strong> | <strong class="bold">Host Map</strong> and <strong class="bold">Infrastructure List</strong> if the agent is able to connect to the backend. This is a method to quickly verify whether an agent is operational at any time.</p>
			<p>On Linux platforms, the logs related to the installation process are available in the <strong class="source-inline">dd_agent.log</strong> log file, which can be found in the current directory where the install script is run. If the installation process fails, it will provide pointers on what has gone wrong. The agent log files are available under the <strong class="source-inline">/var/log/datadog</strong> directory.</p>
			<p>As mentioned earlier, the steps for installing the Datadog Agent on a specific operating system can be obtained by navigating to the <strong class="bold">Integrations</strong> | <strong class="bold">Agent</strong> window. The supported operating systems and platforms are listed on the left pane, and by clicking on the required one, you can get the steps, as shown in <em class="italic">Figure 2.6</em> for Ubun<a id="_idTextAnchor122"/>tu.</p>
			<h1 id="_idParaDest-62"><a id="_idTextAnchor123"/>Agent components</h1>
			<p>The Datadog Agent is a service that is composed of <a id="_idIndexMarker191"/>multiple component processes doing specific tasks. Let's look at those in detail to understand the workings of the Datadog Agent.</p>
			<p>On Ubuntu systems, the Datadog Agent service is named <strong class="source-inline">datadog-agent</strong>. The runtime status of this service can be checked and maintained using the system command service like any other service.</p>
			<p>The <strong class="source-inline">/etc/datadog-agent</strong> directory has all the configuration files related to the Datadog Agent running on that machine. The YAML <strong class="source-inline">/etc/datadog-agent/datadog.yaml</strong> file is the main configuration file. If any change is made to this file, the Datadog service needs to be restarted for those changes to take effect.</p>
			<p>The <strong class="source-inline">/etc/datadog-agent/conf.d/</strong> directory contains configuration files related to the integrations that are run on that host. We will see the configuration requirements for integrations and how they are installed in <a href="B16483_09_Final_VK_ePub.xhtml#_idTextAnchor261"><em class="italic">Chapter 9</em></a>, <em class="italic">Integrating with Platform Components</em>, which is dedicated to discussing integrating Datadog with cloud platform applications.</p>
			<p>There are three main components in the Datadog Agent service:</p>
			<ul>
				<li><strong class="bold">Collector</strong>: As the name suggests, the <a id="_idIndexMarker192"/>Collector collects the system metrics every 15 seconds. The collection frequency can be <a id="_idIndexMarker193"/>different for other types of metric types and the Datadog documentation provides that information. </li>
				<li><strong class="bold">Forwarder</strong>: The metrics collected <a id="_idIndexMarker194"/>locally are sent over HTTPS to the Datadog backend by the Forwarder. To optimize the <a id="_idIndexMarker195"/>communication, the metrics collected are buffered in memory prior to shipping them to the backend.</li>
				<li><strong class="bold">DogStatsD</strong>: StatsD is a general-purpose <a id="_idIndexMarker196"/>metrics collection and aggregation daemon that runs on port <strong class="source-inline">8125</strong> by default. StatsD is a <a id="_idIndexMarker197"/>popular interface offered by monitoring tools for integrating with external systems. DogStatsD is an implementation of StatsD by Datadog and it is available as a component of the Datadog Agent. We will see later in this book how StatsD can be used to implement lightweight but very effective integrations.</li>
			</ul>
			<p>Besides these three components, there are optional processes that can be started by specifying them in the <strong class="source-inline">datadog.yaml</strong> file:</p>
			<ul>
				<li><strong class="bold">APM agent</strong>: This process is needed to support the APM feature and it should be run if the APM feature is used.</li>
				<li><strong class="bold">Process agent</strong>: To collect details on the live processes running on the host, this component of the Datadog Agent process needs to be enabled.</li>
				<li><strong class="bold">Agent UI</strong>: The Datadog Agent also provides a UI component that runs directly on the host where the Datadog Agent is running. This is not a popular option; the information about a <a id="_idIndexMarker198"/>host is usually looked up on the main dashboard, which provides complete insight into your infrastructure and the applications running on it. However, it could be used for ad hoc purposes, for example, troubleshooting on consumer platforms such as macOS a<a id="_idTextAnchor124"/>nd Windows.</li>
			</ul>
			<h1 id="_idParaDest-63"><a id="_idTextAnchor125"/>Agent as a container</h1>
			<p>As mentioned earlier, the Datadog Agent <a id="_idIndexMarker199"/>can be installed as a container on a Docker host. Though the actual options might differ, the following is a sample command that explains how the Datadog Agent is started up as a container:</p>
			<p class="source-code">DOCKER_CONTENT_TRUST=1 docker run -d --name dd-agent -v /var/run/docker.sock:/var/run/docker.sock:ro -v /proc/:/host/proc/:ro -v /sys/fs/cgroup/:/host/sys/fs/cgroup:ro -e DD_API_KEY=&lt;DATADOG_API_KEY&gt; datadog/agent:7 </p>
			<p class="source-code">               </p>
			<p>The Docker image of Datadog Agent 7 is pulled from Docker Hub in this example.</p>
			<p>When the agent is installed on the host, you have seen that <strong class="source-inline">datadog.yaml</strong> is used to set the configuration items. With a Docker image, that option is not directly available. However, any custom changes in it could be done by setting the corresponding environment variables. For example, in this example, <strong class="source-inline">api_key</strong> is set by passing the <strong class="source-inline">DD_API_ KEY</strong> environment variable. In a Kubernetes cluster, the Datadog Agent is installed as a DaemonSet, and that configuration will ensure that the agent container is deployed on all the nodes in the cluster. <strong class="source-inline">DD_API_KEY</strong> is specified as a Kubernetes secret. Datadog provides multiple templates for creating the Kubernetes manifest that can be used for deploying Datadog in your cluster. <strong class="source-inline">kubectl</strong> is used to configure and deploy the Dat<a id="_idTextAnchor126"/>adog Agent. </p>
			<h1 id="_idParaDest-64"><a id="_idTextAnchor127"/>Deploying the agent – use cases</h1>
			<p>At the beginning of this chapter, we <a id="_idIndexMarker200"/>looked at multiple runtime configurations possible for running the Datadog Agent. In this section, we will explore a few use cases in which such options <a id="_idTextAnchor128"/>are utilized.</p>
			<h2 id="_idParaDest-65"><a id="_idTextAnchor129"/>All on the hosts</h2>
			<p>This is a classic configuration in <a id="_idIndexMarker201"/>which both the Datadog Agent and the application software run directly on the hosts. The hosts could be bare-metal or virtual machines. An agent will run on every host, reporting events and metrics into the Datadog backend.</p>
			<p>The deployment can be done using the following automated or semi-automated methods. In a real-life production environment, installing the Datadog Agent manually on hosts might be impractical or might not scale up:</p>
			<ul>
				<li>The Datadog Agent can be baked into the machine image used to boot up a bare-metal machine or spin up a virtual machine. For example, in AWS, the agent can be preinstalled and preconfigured <a id="_idIndexMarker202"/>for the target environment in the <strong class="bold">Amazon Machine Image</strong> (<strong class="bold">AMI</strong>).</li>
				<li>Use an orchestration and configuration management tool such as Ansible to deploy the agent on multiple machines parallelly so the deployment task will scale operationally.</li>
			</ul>
			<p>In a public cloud environment, the preferred method is always using a machine image because the hosts can be spun up and shut down on demand using features such as autoscaling. In such scenarios, a semi-automated method such as using Ansible is not viable. However, Ansible can be used to generate machine images and related confi<a id="_idTextAnchor130"/>guration tasks.</p>
			<h2 id="_idParaDest-66"><a id="_idTextAnchor131"/>Agent on the host monitoring containers</h2>
			<p>Running the <a id="_idIndexMarker203"/>Datadog Agent directly on the <a id="_idIndexMarker204"/>host is simple and flexible and it might make sense to use that configuration for some operational requirements. The Datadog Agent can be deployed as discussed before, but additional configuration changes are needed for the agent to discover and monitor the containers running on the host.</p>
			<p>The containers are ephemeral in nature and that dynamicity must be accounted for in monitoring as well. The Datadog Agent <a id="_idIndexMarker205"/>uses the <strong class="bold">Autodiscovery</strong> feature to identify and monitor containers.</p>
			<p>The easiest way to start <a id="_idIndexMarker206"/>monitoring containers running on the host, in this configuration, is to enable Docker integration. Though the <a id="_idIndexMarker207"/>specific steps to do that could be slightly different on different target operating system platforms, the following example of enabling it on Ubuntu 18.04 provides the general steps involved:</p>
			<ol>
				<li value="1">On the Datadog UI, navigate to <strong class="bold">Integrations</strong> | <strong class="bold">Integrations</strong>, and then search for Docker:<div id="_idContainer021" class="IMG---Figure"><img src="Images/Figure_2.7_B16483.jpg" alt="Figure 2.7 – Searching for Docker integration&#13;&#10;" width="763" height="693"/></div><p class="figure-caption">Figure 2.7 – Searching for Docker integration</p></li>
				<li>Under the Docker icon, click on the <strong class="bold">install</strong> link to complete the installation step on the backend.</li>
				<li>To obtain the configuration steps on the host side, where the containers are running, click on the <strong class="bold">configure</strong> link on the Docker icon. That will open a window with all the required information, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer022" class="IMG---Figure">
					<img src="Images/Figure_2.8_B16483.jpg" alt="Figure 2.8 – Steps to enable Docker integration&#13;&#10;" width="989" height="688"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.8 – Steps to enable Docker integration</p>
			<p>The steps <a id="_idIndexMarker208"/>provided in the <strong class="bold">Configuration</strong> tab are executed on the hosts to complete container monitoring on the <a id="_idIndexMarker209"/>hosts. We will see how that is done soon. The Docker-specific metrics that would be available through this integration are listed in the <strong class="bold">Metrics</strong> tab.</p>
			<p>The following are the steps to be run on each Docker host:</p>
			<ol>
				<li value="1">Add user <strong class="source-inline">dd-agent</strong> to the <strong class="source-inline">docker</strong> operating system group:<p class="source-code"><strong class="bold">usermod -a -G docker dd-agent</strong></p></li>
				<li>There will be a sample configuration file under <strong class="source-inline">/etc/datadog-agent/conf.d/docker.d/conf.yaml.example</strong>. Copy or rename this file to <strong class="source-inline">conf.yaml</strong> and add the following settings:<p class="source-code">init_config:</p><p class="source-code">instances:</p><p class="source-code">    - url: "unix://var/run/docker.sock"</p><p class="source-code">      new_tag_names: true</p></li>
				<li>Restart the Datadog Agent:<p class="source-code">service datadog-agent restart</p><p>To verify whether the <a id="_idIndexMarker210"/>Docker integration <a id="_idIndexMarker211"/>works on a host, you can look up the <strong class="bold">Containers</strong> dashboard from the <strong class="bold">Infrastructure</strong> main menu, as shown in the following screenshot:</p><div id="_idContainer023" class="IMG---Figure"><img src="Images/Figure_2.9_B16483.jpg" alt="Figure 2.9 – Autodiscovery of Docker containers&#13;&#10;" width="1047" height="642"/></div><p class="figure-caption"> </p><p class="figure-caption">Figure 2.9 – Autodiscovery of Docker containers</p><p>On the <strong class="bold">Containers</strong> dashboard, search for a specific host by entering the hostname in the <strong class="bold">Filter by</strong> field, as shown in the preceding screenshot. </p></li>
				<li>By enabling the Docker integration, Docker-specific metrics that are prefixed with <strong class="source-inline">docker.*</strong> are available for use. The Docker metrics can be looked up in the <strong class="bold">Metrics Explorer</strong>, as shown in the following screenshot: <div id="_idContainer024" class="IMG---Figure"><img src="Images/Figure_2.10_B16483.jpg" alt="Figure 2.10 – Looking up Docker metrics&#13;&#10;" width="883" height="406"/></div><p class="figure-caption">Figure 2.10 – Looking up Docker metrics</p><p>In the example in <em class="italic">Figure 2.10</em>, the <strong class="source-inline">docker.containers.running</strong> metric is used to look up the <a id="_idIndexMarker212"/>number of containers running on the <strong class="source-inline">i-021b5a51fbdfe237b</strong> host when the <a id="_idIndexMarker213"/>Docker integration has been enabled. To do that, navigate to <strong class="bold">Metrrics</strong> | <strong class="bold">Metrics Explorer</strong> from the Datadog UI and enter <strong class="source-inline">docker.containers.running</strong> in the <strong class="bold">Graph</strong> field and the hostname in the <strong class="bold">Over</strong> field. </p><p>The complete list of Docker-specific metrics are listed under the <strong class="bold">Metrics</strong> tab on the Docker integration page, as shown in the following screenshot:</p><div id="_idContainer025" class="IMG---Figure"><img src="Images/Figure_2.11_B16483.jpg" alt="Figure 2.11 – List of Docker metrics&#13;&#10;" width="1062" height="716"/></div><p class="figure-caption">Figure 2.11 – List of Docker metrics</p><p>Enabling Docker integration will provide only Docker-specific metrics. The specific application, Redis, in this example, might be publishing metrics also. To enable that, you need to follow steps similar to what we saw for enabling Docker. </p></li>
				<li>On the <a id="_idIndexMarker214"/>host machine, the <a id="_idIndexMarker215"/>sample configuration file, <strong class="source-inline">/etc/datadog-agent/conf.d/redisdb.d/conf.yaml.example</strong>, can be renamed or copied to <strong class="source-inline">/etc/datadog-agent/conf.d/redisdb.d/conf.yaml</strong>, and then restart the Datadog Agent to complete the configuration.<p>If the integration works, you will be able to query for the related metrics in the <strong class="bold">Metrics Explorer</strong> as we saw with the example of Docker. Likewise, for Redis, you can check for metrics prefixed with <strong class="source-inline">redis.*</strong>.</p><p>If some steps fail, you cannot readily verify the enabling of integration on a host using the preceding method. One way to check for that is by looking at the output of the Datadog Agent status by running the following command: </p><p class="source-code"><strong class="bold">sudo datadog-agent status </strong></p></li>
				<li>In the output, look for the <a id="_idIndexMarker216"/>integration of interest. In this example, we looked at Docker and Redis and the following <a id="_idIndexMarker217"/>mentions of those are in the output:<p class="source-code">docker</p><p class="source-code">    ------</p><p class="source-code">      Instance ID: docker [OK]</p><p class="source-code">      Configuration Source: file:/etc/datadog-agent/conf.d/docker.d/conf.yaml</p><p class="source-code">      Total Runs: 1</p><p class="source-code">      Metric Samples: Last Run: 21, Total: 21</p><p class="source-code">      Events: Last Run: 0, Total: 0</p><p class="source-code">      Service Checks: Last Run: 1, Total: 1</p><p class="source-code">      Average Execution Time : 63ms</p><p class="source-code">      Last Execution Date : 2020-08-28 07:52:01.000000 UTC</p><p class="source-code">      Last Successful Execution Date : 2020-08-28 07:52:01.000000 UTC</p><p class="source-code">    redisdb (3.0.0)</p><p class="source-code">    ---------------</p><p class="source-code">      Instance ID: redisdb:fbcb8b58205c97ee [OK]</p><p class="source-code">      Configuration Source: file:/etc/datadog-agent/conf.d/redisdb.d/conf.yaml</p><p class="source-code">      Total Runs: 1</p><p class="source-code">      Metric Samples: Last Run: 33, Total: 33</p><p class="source-code">      Events: Last Run: 0, Total: 0</p><p class="source-code">      Service Checks: Last Run: 1, Total: 1</p><p class="source-code">      Average Execution Time : 91ms</p><p class="source-code">      Last Execution Date : 2020-08-28 07:52:08.000000 UTC</p><p class="source-code">      Last Successful Execution Date : 2020-08-28 07:52:08.000000 UTC</p><p class="source-code">      metadata:</p><p class="source-code">        version.major: 2</p><p class="source-code">        version.minor: 8</p><p class="source-code">        version.patch: 23</p><p class="source-code">        version.raw: 2.8.23</p><p class="source-code">        version.scheme: semver</p></li>
			</ol>
			<p>If there are issues, you will see error messages under the related sections.</p>
			<p>The deployment <a id="_idIndexMarker218"/>strategy involves baking in the Datadog Agent and the configuration files relevant to your environment on a <a id="_idIndexMarker219"/>machine image, such as AMI in AWS. To get all the relevant metrics published to Datadog from the containers running on a host, a customized Datadog Agent configuration file and configuration files related to various integrations similar to those we have <a id="_idTextAnchor132"/>in the examples are needed. </p>
			<h2 id="_idParaDest-67"><a id="_idTextAnchor133"/>Agent running as a container</h2>
			<p>This is the preferred configuration of running the agent when the software application is deployed as containers. The <a id="_idIndexMarker220"/>agent could be deployed as a container on the Docker host or as a service in a Kubernetes cluster. We discussed earlier how the agent is deployed in these scenarios.</p>
			<p>As the Datadog Agent is deployed as a container, there is no need to include that in the machine image used for <a id="_idIndexMarker221"/>spinning up the Docker nodes. This adds operational flexibility as there would not be any need to update the machine image for rolling out or upgra<a id="_idTextAnchor134"/>ding the Datadog Agent used. </p>
			<h1 id="_idParaDest-68"><a id="_idTextAnchor135"/>Advanced agent configuration</h1>
			<p>The main Datadog agent configuration file, <strong class="source-inline">datadog.yaml</strong>, can be updated to meet your specific monitoring requirements. By default, only <strong class="source-inline">api_key</strong> is set in it. A <strong class="source-inline">datadog.yaml</strong> file used in a real-life environment would have more options set.</p>
			<p>We will see some of the <a id="_idIndexMarker222"/>important configuration items that are usually leveraged to fine-tune the monitoring infrastructure:</p>
			<ul>
				<li><strong class="source-inline">proxy</strong>: If the outbound traffic to the internet has to go through a proxy, this option needs to be configured. Typical proxy settings for <strong class="source-inline">http</strong>, <strong class="source-inline">https</strong>, and <strong class="source-inline">no_proxy</strong> are supported.</li>
				<li><strong class="source-inline">hostname</strong>: If a specific hostname has to be used for reporting, it is set using this option. By default, the hostname is auto-detected using tools available at the operating system level.</li>
				<li><strong class="source-inline">tags</strong>: A very important option that is always used to tag the metrics reported by the agent. Multiple key/value pairs can be specified. </li>
				<li><strong class="source-inline">collect_ec2_tags</strong>: By enabling this option, the AWS EC2 node tags can be collected as host tags.</li>
				<li><strong class="source-inline">config_providers</strong>: To enable autodiscovery of containers created from a specific Docker image, the related configurations must be provided here.</li>
				<li><strong class="source-inline">docker_labels_as_tags</strong> and <strong class="source-inline">docker_env_as_tags</strong>: These configuration items can be used to extract Docker labels and environment variables as tags on metrics collected from related containers. <p>Similar tagging options are available with Kubernetes also by using <strong class="source-inline">kubernetes_pod_labels_as_tags</strong> and <strong class="source-inline">kuber<a id="_idTextAnchor136"/>netes_pod_annotations_as_tags</strong>.</p></li>
			</ul>
			<h1 id="_idParaDest-69"><a id="_idTextAnchor137"/>Best practices</h1>
			<p>As you have seen, there are multiple ways to install and configure the Datadog Agent, and, for someone new to Datadog, it could be daunting to determine how the agent can be rolled out and fine-tuned efficiently to meet the monitoring requirements. However, there are a few things that are <a id="_idIndexMarker223"/>obvious as best practices, and let's summarize those here:</p>
			<ul>
				<li>If the agent is installed on the host, plan to include it in the machine image used to spin up or boot the host.</li>
				<li>Set up Ansible playbooks or similar tools to make ad hoc changes to the Datadog Agent on the host. This is not recommended for some complex infrastructure environments, especially where bare-metal servers are used, so some in-place change might be needed.</li>
				<li>When containers are to be monitored, plan to deploy the agent also as a container.</li>
				<li>Plan to collect tags from underlying infrastructure components such as Docker and Kubernetes by suitably configuring the agent. </li>
			</ul>
			<h1 id="_idParaDest-70"><a id="_idTextAnchor138"/>Summary</h1>
			<p>The Datadog Agent can be used for monitoring both classic and microservices-based environments that are built on a variety of cloud platforms and operating systems. To collect and publish monitoring metrics into its SaaS backend, an agent needs to be run on the local environment. The agent could be run directly on the host machine, as a container on a Docker host, or as a service in a microservice orchestration framework such as Kubernetes. This chapter looked at various configuration options available for deploying the Datadog Agent and typical use cases.</p>
			<p>In the next chapter, we will look at key features of the Datadog UI. Though most of the changes can be done using APIs, the Datadog UI is a handy tool for both users and administrators to get a view into Datadog's backend, especially the custom dashboards that provide visual insights into the state of infrastructure and the application software system.</p>
		</div>
	</div></body></html>