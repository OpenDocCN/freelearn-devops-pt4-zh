<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer155">
			<h1 id="_idParaDest-204"><em class="italic"><a id="_idTextAnchor385"/>Chapter 12</em>: Monitoring Containers</h1>
			<p>The monitoring of containers has been briefly covered earlier in the book. However, the adoption of microservices-based architecture to build applications and the ever-increasing use of containers to deploy such applications demands a dedicated chapter like this. Monitoring applications are trying to support advances in this space, and Datadog has been adding new features as well.</p>
			<p>In this chapter, you will learn about the important Datadog features related to monitoring containers. Specifically, the following topics will be covered:</p>
			<ul>
				<li>Collecting Docker logs</li>
				<li>Monitoring Kubernetes</li>
				<li>Using Live Containers</li>
				<li>Viewing logs using Live Tail</li>
				<li>Searching container data</li>
			</ul>
			<h1 id="_idParaDest-205"><a id="_idTextAnchor386"/>Technical requirements</h1>
			<p>To try out the examples mentioned in this chapter, you need to have an environment where the Datadog Agent is deployed on either Docker or Kubernetes. The examples were developed in the following environments:</p>
			<ul>
				<li><strong class="bold">Docker</strong>: <strong class="bold">Docker Desktop 3.2.2</strong> running on a MacBook Pro. Any environment that has the latest version of Docker would be compatible.</li>
				<li><strong class="bold">Kubernetes</strong>: Single-node <strong class="source-inline">minikube v1.18.1</strong> running on a MacBook Pro. To try out the examples, any Kubernetes environment that has <strong class="source-inline">kubectl</strong> <strong class="source-inline">v1.20.0</strong> or higher can be used.</li>
			</ul>
			<p>The examples might even work with older versions of Docker and Kubernetes; you are encouraged to try out the examples on their respective most recent versions.</p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor387"/>Collecting Docker logs</h1>
			<p>In <a href="B16483_02_Final_VK_ePub.xhtml#_idTextAnchor115"><em class="italic">Chapter 2</em></a>, <em class="italic">Deploying the Datadog Agent</em>, you learned how to monitor Docker-based <a id="_idIndexMarker712"/>containers as part of the infrastructure. By configuring the Datadog Agent appropriately, information about the running Docker containers, the <strong class="source-inline">metrics.*</strong> group of metrics, can be obtained and the health of containers can be monitored. The application logs from a container are typically written to the <strong class="source-inline">stdout</strong> and <strong class="source-inline">stderr</strong> streams. In this section, let's look at how application logs can be collected by configuring the Datadog Agent and the corresponding Docker image.</p>
			<p>The preferred method to collect logs from a container is to run the Datadog Agent as a container on the same Docker host. Though the actual command line to start the Datadog Agent container can be slightly different depending on the target operating system, on a Unix-like system such as macOS or Linux it would be as follows:</p>
			<p class="source-code">$ docker run -d --name datadog-agent \</p>
			<p class="source-code">           -e DD_API_KEY=DATADOG-API-KEY  \</p>
			<p class="source-code">           -e DD_LOGS_ENABLED=true \</p>
			<p class="source-code">           -e DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true \</p>
			<p class="source-code">           -e DD_CONTAINER_EXCLUDE="name:datadog-agent" \</p>
			<p class="source-code">           -v /var/run/docker.sock:/var/run/docker.sock:ro \</p>
			<p class="source-code">           -v /proc/:/host/proc/:ro \</p>
			<p class="source-code">           -v /opt/datadog-agent/run:/opt/datadog-agent/run:rw \</p>
			<p class="source-code">           -v /sys/fs/cgroup/:/host/sys/fs/cgroup:ro \</p>
			<p class="source-code">           gcr.io/datadoghq/agent:latest</p>
			<p>Note that <strong class="source-inline">DATADOG-API-KEY</strong> must be replaced with a valid API key associated with a Datadog user account.</p>
			<p>Upon successfully running the Datadog Agent container, you should be able to verify it from the command line as follows:</p>
			<p class="source-code">$ docker ps</p>
			<p class="source-code">CONTAINER ID        IMAGE                           COMMAND                   CREATED             STATUS                  PORTS                  NAMES</p>
			<p class="source-code">2689f209fc16        gcr.io/datadoghq/agent:latest   "/init"                  29 hours ago        Up 29 hours (healthy)   8125/udp, 8126/tcp     datadog-agent</p>
			<p>There <a id="_idIndexMarker713"/>could also be other containers running on the host, but look for the Datadog Agent container labeled <strong class="source-inline">datadog-agent</strong>.</p>
			<p>To check whether the Datadog Agent service is able to collect logs from other containers, you can run any other containers that generate logs. For the example here, we can try running an NGINX container as follows:</p>
			<p class="source-code">$ docker run -it --rm -d -p 8080:80 --name web nginx</p>
			<p>This command will run an NGINX container labeled <strong class="source-inline">web</strong>, a name that we can use later in the Datadog dashboards to locate this container. Also, the container port will be mapped to port <strong class="source-inline">8080</strong> on the Docker host machine.</p>
			<p>The output of the preceding command is not provided here for brevity, but you can check if it's up and running as follows:</p>
			<p class="source-code">$ docker ps </p>
			<p class="source-code">CONTAINER ID        IMAGE                           COMMAND                   CREATED             STATUS                  PORTS                  NAMES</p>
			<p class="source-code">53cd9cae287d        nginx                           "/docker-entrypoint.…"   28 hours ago        Up 28 hours              0.0.0.0:8080-&gt;80/tcp   web</p>
			<p class="source-code">2689f209fc16        gcr.io/datadoghq/agent:latest   "/init"                  29 hours ago        Up 29 hours (healthy)   8125/udp, 8126/tcp     datadog-agent</p>
			<p>Look at the name of the container and the port mapping; this enables you to access the NGINX service on port <strong class="source-inline">8080</strong> on the host machine, even though the service runs on port <strong class="source-inline">80</strong> in the container.</p>
			<p>Also, you can access the NGINX service on a web browser using the URL <strong class="source-inline">http://localhost:8080</strong> (or using an IP address or <strong class="source-inline">CNAME</strong> in place of localhost if the service is accessed from a remote host). The service could also be accessed using a command-line tool such as <strong class="source-inline">curl</strong>. You need to do this to generate some logs to see them being collected by the Datadog Agent.</p>
			<p>Now let's see<a id="_idIndexMarker714"/> how the logs can be viewed using the Datadog UI. By navigating to <strong class="bold">Infrastructure</strong> | <strong class="bold">Containers</strong>, you can get to the <strong class="bold">Containers</strong> dashboard, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer146" class="IMG---Figure">
					<img src="Images/Figure_12.1_B16483.jpg" alt="Figure 12.1 – Listing containers&#13;&#10;" width="1650" height="598"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1 – Listing containers</p>
			<p>Look for the name of the container that you want to check for the logs. In this sample case, it's <strong class="bold">web</strong>, and you can double-click on it to open the following dialog. Select the <strong class="bold">Logs</strong> tab in the dropdown, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer147" class="IMG---Figure">
					<img src="Images/Figure_12.2_B16483.jpg" alt="Figure 12.2 – Logs collected from a container&#13;&#10;" width="1510" height="1189"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.2 – Logs collected from a container</p>
			<p>As you can see, the<a id="_idIndexMarker715"/> logs displayed can be filtered down to a time window such as the past 15 minutes, as set in the example. To generate new logs, just access the URL using a web browser or <strong class="source-inline">curl</strong>.</p>
			<p>The logs can also be viewed in a better interface provided<a id="_idIndexMarker716"/> by <strong class="bold">Log Explorer</strong>. The dialog specified in <em class="italic">Figure 12.2</em> provides a link to launch Log Explorer, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer148" class="IMG---Figure">
					<img src="Images/Figure_12.3_B16483.jpg" alt="Figure 12.3 – Link to Log Explorer&#13;&#10;" width="1605" height="359"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.3 – Link to Log Explorer</p>
			<p>By clicking on<a id="_idIndexMarker717"/> the link <strong class="bold">Open in Log Explorer</strong>, as shown in <em class="italic">Figure 12.3</em>, the <strong class="bold">Log Explorer</strong> dashboard can be launched, and the interface will be as in the following screenshot:</p>
			<div>
				<div id="_idContainer149" class="IMG---Figure">
					<img src="Images/Figure_12.4_B16483.jpg" alt="Figure 12.4 – Log Explorer&#13;&#10;" width="1650" height="708"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.4 – Log Explorer</p>
			<p>This<a id="_idIndexMarker718"/> interface is very <a id="_idIndexMarker719"/>similar to that provided by industry-standard log <a id="_idIndexMarker720"/>aggregation tools such as <strong class="bold">Splunk</strong>, <strong class="bold">Sumo Logic</strong>, and the <strong class="bold">ELK Stack</strong>.</p>
			<p>In this example, you have learned how to capture logs from containers and publish them to Datadog by running the Datadog Agent, also as a container, on the same Docker host. If you have the option to customize the Docker image that is used to run the container, the image can be instrumented to capture the container logs better. In the following example, you will learn how NGINX logs integration is enabled on a container.</p>
			<p>The main <a id="_idIndexMarker721"/>step involved is to label the Docker image for log collection, as done in the following <strong class="bold">Dockerfile</strong>, which is <a id="_idIndexMarker722"/>used to build a custom version of the NGINX image that was used in the previous example:</p>
			<ol>
				<li>Create a Dockerfile in the current directory as follows, build a custom version NGINX image, and launch a container using it:<p class="source-code"><strong class="bold">$ cat Dockerfile</strong></p><p class="source-code"><strong class="bold">FROM nginx:latest</strong></p><p class="source-code"><strong class="bold">LABEL "com.datadoghq.ad.logs"='[{"source": "nginx", "service": "webapp-custom"}]'</strong></p></li>
				<li>Build the Docker image:<p class="source-code"><strong class="bold">$ docker build -t nginx-custom .</strong></p></li>
				<li>Verify whether the Docker image has been successfully built:<p class="source-code"><strong class="bold">$ docker images|grep custom</strong></p><p class="source-code"><strong class="bold">nginx-custom                                           latest              b8121cf4a3fe        29 minutes ago      133MB</strong></p></li>
				<li>Launch the custom-built NGINX container:<p class="source-code"><strong class="bold">$ docker run -it --rm -d -p 8080:80 --name web-custom nginx-custom</strong></p><p class="source-code"><strong class="bold">59162bf7694cd146166c040263d73afea934eb8081c63875f17e28228</strong></p><p class="source-code"><strong class="bold">48b4b16</strong></p></li>
				<li>Check whether the NGINX container is running:<p class="source-code"><strong class="bold">$ docker ps | grep custom</strong></p><p class="source-code"><strong class="bold">59162bf7694c        nginx-custom                    "/docker-entrypoint.…"   41 minutes ago      Up 41 minutes          0.0.0.0:8080-&gt;80/tcp   web-custom</strong></p></li>
				<li>Verify<a id="_idIndexMarker723"/> whether you can access the container on port <strong class="source-inline">8080</strong> on the Docker host:<p class="source-code"><strong class="bold">$ curl -I http://localhost:8080</strong></p><p class="source-code"><strong class="bold">HTTP/1.1 200 OK</strong></p><p class="source-code"><strong class="bold">Server: nginx/1.19.8</strong></p><p class="source-code"><strong class="bold">Date: Wed, 17 Mar 2021 05:55:45 GMT</strong></p><p class="source-code"><strong class="bold">Content-Type: text/html</strong></p><p class="source-code"><strong class="bold">Content-Length: 612</strong></p><p class="source-code"><strong class="bold">Last-Modified: Tue, 09 Mar 2021 15:27:51 GMT</strong></p><p class="source-code"><strong class="bold">Connection: keep-alive</strong></p><p class="source-code"><strong class="bold">ETag: "604793f7-264"</strong></p><p class="source-code"><strong class="bold">Accept-Ranges: bytes</strong></p></li>
			</ol>
			<p>If all the previous steps were successful, then you can check whether Datadog is capturing the logs.</p>
			<p>To verify that the logs are collected, the container logs can be looked up on the Datadog Containers dashboard as you have seen earlier:</p>
			<ol>
				<li value="1">Navigate to <strong class="bold">Infrastructure</strong> | <strong class="bold">Containers</strong>.</li>
				<li>Double-click on the <strong class="bold">nginx-custom</strong> container.</li>
				<li>Look for log entries under the <strong class="bold">Logs</strong> tab.</li>
				<li>Alternatively, <strong class="bold">Log Explorer</strong> can also be used to search the logs as you learned in the previous example.</li>
			</ol>
			<p>You have learned that the containers running on a Docker host can be monitored using Datadog at both the infrastructure and application levels, and specifically, how to collect application logs from a container in this section. Kubernetes is becoming the default platform for deploying microservices lately, and in the next section, you will learn how to use Datadog to monitor containers that run on Kube<a id="_idTextAnchor388"/>rnetes.</p>
			<h1 id="_idParaDest-207"><a id="_idTextAnchor389"/>Monitoring Kubernetes</h1>
			<p>Docker<a id="_idIndexMarker724"/> can be used for both packaging and running microservices, and you have seen examples of that in the previous section. However, that is only one of the packaging solutions available for microservices. Kubernetes is a platform for running microservices that are packaged using tools such as Docker. It provides a vast number of features to orchestrate and maintain the deployment of a microservices-based software system. Practically, it can be considered an operating system for microservices.</p>
			<p>Kubernetes environments can be set up on a wide variety of infrastructures, starting from your laptop for testing purposes through clusters of several machines in a data center. However, the <a id="_idIndexMarker725"/>most popular option to run Kubernetes is using the managed<a id="_idIndexMarker726"/> services available on public cloud platforms such as <strong class="bold">Elastic Kubernetes Service</strong> (<strong class="bold">EKS</strong>) on AWS, <strong class="bold">Google Kubernetes Engine</strong> (<strong class="bold">GKE</strong>), and <strong class="bold">Azure Container Service</strong> (<strong class="bold">AKS</strong>). Regardless of the underlying <a id="_idIndexMarker727"/>infrastructure, Kubernetes can be accessed and used uniformly using tools such as <strong class="source-inline">kubectl</strong>. In this section, you will learn how to deploy the Datadog Agent to monitor containers running in a Kubernetes environment.</p>
			<p>To test the steps provided here, a <strong class="source-inline">minikube</strong>-based Kubernetes environment that runs on a personal computer was used. The details of setting up <strong class="source-inline">minikube</strong> can be found here: <a href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a>. The steps to deploy Datadog are applicable in any Kubernetes environment and you can try them out anywhere regardless of the underlying Kubernetes infrastructure.</p>
			<p>Monitoring Kubernetes has two parts – monitoring the Kubernetes cluster itself, and monitoring the microservices that run in the containers orchestrated by Kubernetes. The first is infrastructure monitoring and the latter is application monitoring. For Datadog to access the related monitoring information, the Datadog Agent must be installed as one of the containers in the Kubernetes cluster, supported by Kubernetes resources define<a id="_idTextAnchor390"/>d for that.</p>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor391"/>Installing the Datadog Agent</h2>
			<p>The<a id="_idIndexMarker728"/> Datadog Agent is installed as a <strong class="bold">DaemonSet</strong> on all the nodes in a Kubernetes cluster so that logs, traces, and<a id="_idIndexMarker729"/> metrics from each node can be collected and pushed to the Datadog backend. The actual implementation would be different in a larger environment, as the Kubernetes platform and the types of services it runs can be vastly different in a real-life scenario. Let's look at the general steps by doing a sample installation:</p>
			<ol>
				<li value="1">Download the sample YAML file to create <strong class="source-inline">ClusterRole</strong> for <strong class="source-inline">datadog-agent</strong>:<p class="source-code"><strong class="bold">$ wget https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrole.yaml</strong></p></li>
				<li>Add the following code snippet to the end of the <strong class="source-inline">clusterrole.yaml</strong> file. This might not be needed in the latest versions of Kubernetes:<p class="source-code"><strong class="bold">- apiGroups:  </strong></p><p class="source-code"><strong class="bold">  - "apps"</strong></p><p class="source-code"><strong class="bold">  resources:</strong></p><p class="source-code"><strong class="bold">  - deployments</strong></p><p class="source-code"><strong class="bold">  - replicasets</strong></p><p class="source-code"><strong class="bold">  - pods</strong></p><p class="source-code"><strong class="bold">  - nodes</strong></p><p class="source-code"><strong class="bold">  - services</strong></p><p class="source-code"><strong class="bold">  verbs:</strong></p><p class="source-code"><strong class="bold">  - list</strong></p><p class="source-code"><strong class="bold">  - get</strong></p><p class="source-code"><strong class="bold">  - watch</strong></p></li>
				<li>Create <strong class="source-inline">ClusterRole</strong> for <strong class="source-inline">datadog-agent</strong>:<p class="source-code"><strong class="bold">$ kubectl apply -f clusterrole.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl get clusterroles |grep datadog-agent</strong></p><p class="source-code"><strong class="bold">datadog-agent     2021-03-18T07:32:49Z</strong></p></li>
				<li>Download<a id="_idIndexMarker730"/> the sample YAML file to create <strong class="source-inline">ServiceAccount</strong> for <strong class="source-inline">datadog-agent</strong> and then provision that:<p class="source-code"><strong class="bold">$ wget https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/serviceaccount.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl apply -f serviceaccount.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl get serviceaccounts |grep datadog-agent</strong></p><p class="source-code"><strong class="bold">datadog-agent   1         23h</strong></p></li>
				<li>Download the sample YAML file for creating <strong class="source-inline">ClusterRoleBinding datadog-agent</strong>, which links to the <strong class="source-inline">ClusterRole</strong> and <strong class="source-inline">ServiceAccount</strong> resources set up in the previous steps:<p class="source-code"><strong class="bold">$ wget https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrolebinding.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl apply -f clusterrolebinding.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl get clusterrolebindings |grep datadog-agent</strong></p><p class="source-code"><strong class="bold">datadog-agent     ClusterRole/datadog-agent           23h</strong></p></li>
				<li>Create a secret for the API key:<p class="source-code"><strong class="bold">$ kubectl create secret generic datadog-agent --from-literal api-key="API-KEY" --namespace="default"</strong></p><p class="source-code"><strong class="bold">$ kubectl get secrets |grep datadog-agent</strong></p><p class="source-code"><strong class="bold">datadog-agent       Opaque         1      26h</strong></p></li>
				<li>Download <a id="_idIndexMarker731"/>a sample manifest to deploy a Datadog Agent that suits your requirements. The complete list is available at <a href="https://docs.datadoghq.com/agent/kubernetes/?tab=daemonset">https://docs.datadoghq.com/agent/kubernetes/?tab=daemonset</a>. For the purposes of this sample deployment, a manifest that supports the enabling of logs and metrics is used:<p class="source-code"><strong class="bold">$ wget https://docs.datadoghq.com/resources/yaml/datadog-agent-logs.yaml</strong></p></li>
				<li>Update the sample Datadog Agent manifest with the following changes.<p>In the section for the <strong class="source-inline">datadog-agent</strong> secret resource, update the <strong class="source-inline">api-key</strong> field with the base64-encoded value of a valid API key. The encoding can be done in different ways, and there are online tools available for these ways. It can be done reliably on the command line using <strong class="source-inline">openssl</strong> if that is available in your working environment:</p><p class="source-code"><strong class="bold">$ echo -n 'API-KEY' | openssl base64</strong></p><p class="source-code"><strong class="bold">Y2Q1YmM5NjAzYmMyM2EyZDk3YmViMTxyzajc1ZjdiMTE=</strong></p></li>
				<li>Add the following environment variables to the container section for the Agent:<p class="source-code"><strong class="bold">  env:</strong></p><p class="source-code"><strong class="bold">            - name: DD_KUBELET_TLS_VERIFY</strong></p><p class="source-code"><strong class="bold">              value: "false"</strong></p><p class="source-code"><strong class="bold">            - name: DD_SITE</strong></p><p class="source-code"><strong class="bold">              value: "datadoghq.com"</strong></p><p class="source-code"><strong class="bold">- name: DD_LOGS_ENABLED</strong></p><p class="source-code"><strong class="bold">              value: "true"</strong></p><p class="source-code"><strong class="bold">            - name: DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL</strong></p><p class="source-code"><strong class="bold">              value: "true"</strong></p><p class="source-code"><strong class="bold">            - name: DD_LOGS_CONFIG_K8S_CONTAINER_USE_FILE</strong></p><p class="source-code"><strong class="bold">              value: "true"</strong></p><p>It may not be required to set <strong class="source-inline">DD_KUBELET_TLS_VERIFY</strong> to <strong class="source-inline">false</strong> on all Kubernetes platforms, so it's optional.</p></li>
				<li>Deploy <a id="_idIndexMarker732"/>the Datadog Agent DaemonSet:<p class="source-code"><strong class="bold">$ kubectl apply -f datadog-agent-logs.yaml</strong></p><p class="source-code"><strong class="bold">$ kubectl get daemonset</strong></p><p class="source-code"><strong class="bold">NAME DESIRED  CURRENT READY UP-TO-DATE  AVAILABLE  NODE SELECTOR AGE</strong></p><p class="source-code"><strong class="bold">datadog-agent 1   1    1    1   1       kubernetes.io/os=linux   25h</strong></p></li>
			</ol>
			<p>The Kubernetes resources that have been created in the previous steps could be looked up and verified using Kubernetes Dashboard as well. For example, if all the preceding steps were successful, you will be able to see the <strong class="source-inline">datadog-agent</strong> Pod listed with the status as <strong class="source-inline">Running</strong>, as in the following screenshot:</p>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="Images/Figure_12.5_B16483.jpg" alt="Figure 12.5 – The datadog-agent Pod listed on Kubernetes Dashboard&#13;&#10;" width="1650" height="653"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.5 – The datadog-agent Pod listed on Kubernetes Dashboard</p>
			<p>Likewise, other resources related to deploying the Datadog Agent can also be looked up on Kubernetes <a id="_idIndexMarker733"/>Dashboard, and they can be managed from there.</p>
			<p>After the Datadog Agent is deployed successfully, you will be able to see the Kubernetes infrastructure resources and the containers running in the cluster on the <strong class="bold">Containers</strong> dashboard, as in the following screenshot:</p>
			<div>
				<div id="_idContainer151" class="IMG---Figure">
					<img src="Images/Figure_12.6_B16483.jpg" alt="Figure 12.6 – Kubernetes resources and containers&#13;&#10;" width="1650" height="769"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.6 – Kubernetes resources and containers</p>
			<p>By clicking on the container of interest, logs and metrics related to that container can be viewed on the <strong class="bold">Containers</strong> dashboard as you learned in the previous section, including the access available to the <strong class="bold">Log Explorer</strong> dashboard.</p>
			<p>The<a id="_idIndexMarker734"/> option to view Kubernetes platform resources such as <strong class="bold">Pods</strong>, <strong class="bold">Deployments</strong>, <strong class="bold">ReplicaSets</strong>, <strong class="bold">Services</strong>, and <strong class="bold">Nodes</strong> is similar to that available on Kubernetes Dashboard. However, having those resources tracked by Datadog provides the option to monitor those resources using Datadog too.</p>
			<p>We have already learned how Datadog can be used to monitor live containers with the help of integrations with Docker and Kubernetes. In the next section, you will learn more about that feature in the contex<a id="_idTextAnchor392"/>t of Kubernetes.</p>
			<h1 id="_idParaDest-209"><a id="_idTextAnchor393"/>Using Live Containers</h1>
			<p>Live Containers<a id="_idIndexMarker735"/> is a Datadog feature that provides insights into the workings of live containers. As you know, Kubernetes has become an industry standard for orchestrating containers, and that is not limited to Docker. Docker is only one of the tools available to package and run microservices. Though Docker is still the dominant containerization platform, there are tools like <strong class="bold">CoreOS rkt</strong> that <a id="_idIndexMarker736"/>could be used with Kubernetes, and this trend has gained momentum.</p>
			<p>Kubernetes is a complex platform and so monitoring the Kubernetes platform itself, besides the containers it runs, is also equally important. Though native applications such as Kubernetes Dashboard are the tools of choice for monitoring a Kubernetes cluster manually, Datadog's platform monitoring features help to consolidate monitoring on one platform and to automate it.</p>
			<p>When a Kubernetes cluster is fully configured for the Datadog Agent to publish both cluster-level and application-level information, the <strong class="bold">Containers</strong> dashboard would look like that in <em class="italic">Figure 12.6</em>. By clicking on the containers and Kubernetes resources, you can look up the related info live at any time.</p>
			<p>To be able to get the information captured from the Kubernetes cluster published to Datadog, the cluster needs to be configured. Some of those configurations were already discussed in the previous section, but it's worth going over some of the important points that were not discussed or not covered in detail:</p>
			<ul>
				<li>The Datadog Agent container should have the following environment variable defined:<p class="source-code"><strong class="bold">- name: DD_ORCHESTRATOR_EXPLORER_ENABLED</strong></p><p class="source-code"><strong class="bold">    value: "true"</strong></p></li>
				<li>The Datadog Agent <strong class="source-inline">ClusterRole</strong> should have permissions set for Live Containers to collect information on Kubernetes resources. That requirement was discussed in the previous section, related to the setting up of the <strong class="source-inline">clusterrole.yaml</strong> file.</li>
				<li>The process <a id="_idIndexMarker737"/>agent container must be run with the following environment variables set:<p class="source-code"><strong class="bold">- name: DD_ORCHESTRATOR_EXPLORER_ENABLED</strong></p><p class="source-code"><strong class="bold">  value: "true"</strong></p><p class="source-code"><strong class="bold">- name: DD_ORCHESTRATOR_CLUSTER_ID</strong></p><p class="source-code"><strong class="bold">  valueFrom:</strong></p><p class="source-code"><strong class="bold">    configMapKeyRef:</strong></p><p class="source-code"><strong class="bold">      name: datadog-cluster-id</strong></p><p class="source-code"><strong class="bold">      key: id</strong></p></li>
				<li>Set the <strong class="source-inline">DD_CLUSTER_NAME</strong> environment variable for both <strong class="source-inline">agent</strong> and <strong class="source-inline">process-agent</strong>:<p class="source-code"><strong class="bold">- name: DD_CLUSTER_NAME</strong></p><p class="source-code"><strong class="bold">  value: "&lt;YOUR_CLUSTER_NAME&gt;"</strong></p><p class="source-code"><strong class="bold">The cluster name can be obtained from the Kubernetes configuration file.</strong></p></li>
			</ul>
			<p>On the <strong class="bold">Containers</strong> dashboard, information about various Kubernetes resources such as Nodes, Services, Deployments, and Pods is also listed. Usually, such details are looked up and managed from the Kubernetes Dashboard UI, but having them available on the Datadog <strong class="bold">Containers</strong> dashboard can be handy, as such information can then be gathered from multiple Kubernetes clusters at one location.</p>
			<p>In the <strong class="bold">Logs</strong> tab of both the <strong class="bold">Containers</strong> and <strong class="bold">Log Explorer</strong> dashboards, you might have already noticed the <strong class="bold">Live Tail</strong> option. Let's get some more details on that feature i<a id="_idTextAnchor394"/>n the next section.</p>
			<h1 id="_idParaDest-210"><a id="_idTextAnchor395"/>Viewing logs using Live Tail</h1>
			<p>Datadog's <strong class="bold">Live Tail</strong> feature <a id="_idIndexMarker738"/>makes the logs available on the logs dashboards as soon as they are available in the backend. It's inspired by the Unix shell command <strong class="source-inline">tail</strong>, which continuously puts out any additions to a log file that it tracks. The advantage with <strong class="bold">Live Tail</strong> is that updates to a set of similar log files from multiple sources can be tracked on one dashboard.</p>
			<p>The <strong class="bold">Live Tail</strong> option is available on the <strong class="bold">Containers</strong> dashboard as in the following screenshot:</p>
			<div>
				<div id="_idContainer152" class="IMG---Figure">
					<img src="Images/Figure_12.7_B16483.jpg" alt="Figure 12.7 – The Live Tail option to view logs in real time &#13;&#10;" width="1506" height="385"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.7 – The Live Tail option to view logs in real time </p>
			<p><strong class="bold">Log Explorer</strong> also has a <strong class="bold">Live Tail</strong> option available as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer153" class="IMG---Figure">
					<img src="Images/Figure_12.8_B16483.jpg" alt="Figure 12.8 – Live Tail on Log Explorer &#13;&#10;" width="1650" height="663"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.8 – Live Tail on Log Explorer </p>
			<p>In this section, you<a id="_idIndexMarker739"/> have learned how the <strong class="bold">Live Tail</strong> option can be useful in terms of looking at the logs and reporting on them on a regular basis. In the next section, you will learn how to search a vast number of logs that would be collected from containers and use the insights for m<a id="_idTextAnchor396"/>onitoring purposes.</p>
			<h1 id="_idParaDest-211"><a id="_idTextAnchor397"/>Searching container data</h1>
			<p>So far, our focus has<a id="_idIndexMarker740"/> been to collect information from containers and the infrastructure they run on, and publish that to the Datadog backend. Various Datadog dashboards, especially <strong class="bold">Live Containers</strong> and <strong class="bold">Log Explorer</strong>, presented that information for user consumption. In a real-life environment where Datadog would be publishing copious amounts of monitoring information, it could easily become a little overwhelming to process such a huge volume of data. The solution is to use methods of searching for information using keywords and tags, and you will learn how to do that in this section.</p>
			<p>Keywords can be used to search for containers on the <strong class="bold">Live Containers</strong> dashboard and they will match with container names, IDs, and image names. For example, in the following screenshot, the container ID is looked up:</p>
			<div>
				<div id="_idContainer154" class="IMG---Figure">
					<img src="Images/Figure_12.9_B16483.jpg" alt="Figure 12.9 – Searching for a container using the container ID&#13;&#10;" width="1650" height="566"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.9 – Searching for a container using the container ID</p>
			<p>The result can be<a id="_idIndexMarker741"/> further filtered and/or grouped by using tags. The containers could also be filtered using tags without using a keyword.</p>
			<p>The keyword search can be more than just for simple strings. It can be compounded using Boolean operators such as <strong class="source-inline">AND</strong>, <strong class="source-inline">OR</strong>, and <strong class="source-inline">NOT</strong>. For example, <strong class="source-inline">apache OR nginx</strong> will return a list of containers that have <strong class="source-inline">apache</strong> or <strong class="source-inline">nginx</strong> present in the fields supported by the search, such as the field for the name of a container. Parentheses can be used to create more complex constructs for searching.</p>
			<p>Like containers, Kubernetes cluster resources such as <strong class="bold">Pods</strong>, <strong class="bold">ReplicaSets</strong>, <strong class="bold">Deployments</strong>, and <strong class="bold">Services</strong> could also be searched and filtered using keywords and tags on the Live Containers dashboard.</p>
			<p>Now let's look at best practices related to monitoring containers <a id="_idTextAnchor398"/>in the next section.</p>
			<h1 id="_idParaDest-212"><a id="_idTextAnchor399"/>Best practices</h1>
			<p>The following are some <a id="_idIndexMarker742"/>of the best practices to be followed while monitoring containers using Datadog:</p>
			<ul>
				<li>Run the Datadog Agent as a container for the easy discovery of application containers and flexibility. Even if the Datadog Agent may have to be run at the host level for some reason, running it as a container on the same host might be acceptable considering the operational benefits that it brings.</li>
				<li>In a Kubernetes environment, don't try to access container logs directly via Docker integration; instead, install the Datadog Agent on the Kubernetes cluster and configure it to collect logs.</li>
				<li>Though <strong class="source-inline">kubectl</strong> and<a id="_idIndexMarker743"/> Kubernetes Dashboard can be used to view Kubernetes cluster resources, making those available in Datadog will help to increase the visibility of their av<a id="_idTextAnchor400"/>ailability and health.</li>
			</ul>
			<h1 id="_idParaDest-213"><a id="_idTextAnchor401"/>Summary</h1>
			<p>In this chapter, you have learned how containers can be monitored using Datadog with the help of integrations available for Docker and Kubernetes. You have also learned how to search the container information and container logs once such information is collected by Datadog. After reading this chapter and trying out the samples provided in it, you are prepared to use Datadog to monitor containers that run in both Docker and Kubernetes environments.</p>
			<p>Log aggregation, indexing, and search is a major area in monitoring and there are major initiatives around in the industry, such as the <strong class="bold">ELK Stack</strong>, <strong class="bold">Splunk</strong>, and <strong class="bold">Sumo Logic</strong>. Datadog also offers a solution, and you will learn about that in the next chapter.</p>
		</div>
	</div></body></html>