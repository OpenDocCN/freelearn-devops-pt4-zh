<html><head></head><body>
		<div id="_idContainer063">
			<h1 id="_idParaDest-111"><em class="italic"><a id="_idTextAnchor110"/>Chapter 5</em>: Managing Source Code Using Cloud Source Repositories</h1>
			<p>The first section of this book (consisting of four chapters) focused on exploring the concepts of <strong class="bold">Site Reliability Engineering</strong> (<strong class="bold">SRE</strong>) in depth. This included SRE technical practices, understanding monitoring and alerting to target reliability, and insights into building SRE teams by applying SRE cultural practices.</p>
			<p>This second section of the book explores GCP's constructs in depth to implement a CI/CD pipeline with a focus on the following core areas:</p>
			<ul>
				<li>Managing source code using Cloud Source Repositories</li>
				<li>Building and creating container images using Cloud Build</li>
				<li>Pushing container images and artifacts using Container Registry</li>
				<li>Orchestrating containers and deploying workloads using Google Kubernetes Engine </li>
			</ul>
			<p>Source code management is the first step in a <strong class="bold">Continuous Integration</strong> (<strong class="bold">CI</strong>) flow. Code is stored in a source code repository; a common repository that stores code and allows developers to make code changes (if required in isolation) and merge changes from multiple contributors into a single common stream. The most common examples of a source code repository include GitHub and Bitbucket. <strong class="bold">Cloud Source Repositories</strong> (<strong class="bold">CSR</strong>) is a service from Google Cloud that provides the functionality of source code management through private Git repositories and easily integrates to several Google Cloud services such as Cloud Build, Cloud Monitoring, and Cloud Logging. </p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li><strong class="bold">Key features</strong>: Managed private Git repository, one-way sync with external repositories, universal code search, and native integration with other <strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) services.</li>
				<li><strong class="bold">First steps</strong>: Create a first repository via the console or the <strong class="bold">Command-Line Interface</strong> (<strong class="bold">CLI</strong>) and add files to the repository. </li>
				<li><strong class="bold">One-way sync from GitHub/Bitbucket to CSR: </strong>Option to add a repository by connecting to an external repository and perform near real-time one-way sync.</li>
				<li><strong class="bold">Common operations</strong>: Browse repositories, browse files, perform universal code search, detect security keys, and assign the right access controls.</li>
				<li><strong class="bold">Hands-on lab</strong>: Step-by-step instructions to integrate CSR with Cloud Functions.</li>
			</ul>
			<h1 id="_idParaDest-112"><a id="_idTextAnchor111"/>Technical requirements</h1>
			<p>There are four main technical requirements:</p>
			<ul>
				<li>A valid GCP account to get hands-on with GCP services: <a href="https://cloud.google.com/free">https://cloud.google.com/free</a>.</li>
				<li>Install Google Cloud SDK: https://cloud.google.com/sdk/docs/quickstart.</li>
				<li>Install Git: <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">https://git-scm.com/book/en/v2/Getting-Started-Installing-Git</a>.</li>
				<li>Alternatively, it is possible to skip the previous two and instead install Cloud Shell, which includes Google Cloud SDK as well as Git: <a href="https://cloud.google.com/shell">https://cloud.google.com/shell</a>. </li>
			</ul>
			<h1 id="_idParaDest-113"><a id="_idTextAnchor112"/>Introducing the key features</h1>
			<p>CSR is a service<a id="_idIndexMarker508"/> from Google Cloud to manage source code. CSR provides Git version control and supports the collaborative development of any application or service. Key features include the following:</p>
			<ul>
				<li><strong class="bold">Fully managed private Git repository</strong>: This feature implies that there is no need to manage the infrastructure required to host the source code repository. Developers can instead focus on building, testing, deploying, and debugging code.</li>
				<li><strong class="bold">Provides one-way sync with GitHub and Bitbucket</strong>: In situations where developers use either GitHub or Bitbucket as their primary cloud source repository, enabling integration with other GCP services such as App Engine, Cloud Functions, Cloud Monitoring, and Cloud Logging is not as straight forward in comparison to using GCP's CSR. For example, it easy to deploy code to a serverless service in GCP such as Cloud Functions from CSR directly then GitHub or Bitbucket instead. In addition, the one-way sync feature performs a one-way mirror, essentially making a near real-time copy of a repository from GitHub or Bitbucket into GCP's CSR. This facilitates the ease of native integration with GCP services.</li>
				<li><strong class="bold">Includes universal code search</strong>: This feature allows you to perform a code search within the code source repository or across repositories. Search can also be scoped to a specific project or repository or even a specific directory.</li>
				<li><strong class="bold">Integration with GCP services</strong>: This feature allows native integration with multiple GCP services such as Cloud Build, Cloud Operations, Cloud Functions, and Cloud Run. For example, the logs related to operations against CSR are automatically sent to Cloud Logging. The user, however, requires <a id="_idIndexMarker509"/><a id="_idIndexMarker510"/>relevant <strong class="bold">Identity Access Management</strong> (<strong class="bold">IAM</strong>) roles to access Cloud Logging in order to view logs related to CSR.<p class="callout-heading">Identity Access Management (IAM)</p><p class="callout">IAM is a framework of roles and policies to ensure users and applications have the required access to resources specifically recommended within the principles of least privilege.</p></li>
			</ul>
			<p>Each of the previously mentioned features will be discussed in detail later in this chapter. The upcoming section details the step-by-step process involved to create and access a repository in CSR.</p>
			<p>First steps – creating and accessing a repository in CSR</p>
			<p>One of the first steps to <a id="_idIndexMarker511"/><a id="_idIndexMarker512"/>perform while working with CSR is to actually create a repository and add files to it. Given that CSR is a managed repository, the user need not manage the space required to host the repository<a id="_idIndexMarker513"/><a id="_idIndexMarker514"/> or the computational power required to maintain or run operations against the repository.</p>
			<p>In this section, we will see <a id="_idIndexMarker515"/><a id="_idIndexMarker516"/>how we can create a repository in CSR from Google Cloud Console and the command line. In addition, we'll learn how<a id="_idIndexMarker517"/><a id="_idIndexMarker518"/> to add files to a branch in an empty repository and then merge to the master. Let's get started.</p>
			<h2 id="_idParaDest-114"><a id="_idTextAnchor113"/>Creating a repository via Google Cloud Console</h2>
			<p>The following is a <a id="_idIndexMarker519"/><a id="_idIndexMarker520"/>step-by-step process to create <a id="_idIndexMarker521"/><a id="_idIndexMarker522"/>our first repository in CSR through Google Cloud Console:</p>
			<ol>
				<li>Enable the CSR API (<em class="italic">Figure 5.1</em>) by navigating to the <strong class="bold">Library</strong> sub-section under the <strong class="bold">APIs &amp; Services</strong> section:<div id="_idContainer041" class="IMG---Figure"><img src="image/B15587_05_01.jpg" alt="Figure 5.1 – Enabling the CSR API&#13;&#10;"/></div><p class="figure-caption">Figure 5.1 – Enabling the CSR API</p></li>
				<li>Navigate to <strong class="bold">Source Repositories</strong> within GCP and select the <strong class="bold">Get Started</strong> option. The system will display a prompt (<em class="italic">Figure 5.2</em>) and provide an option to create a repository. However, if a repository already exists in CSR, skip to <em class="italic">step 3</em> and use the <strong class="bold">Add a Repository</strong> option instead:<div id="_idContainer042" class="IMG---Figure"><img src="image/B15587_05_02.jpg" alt="Figure 5.2 – Option to create your first repository&#13;&#10;"/></div><p class="figure-caption">Figure 5.2 – Option to create your first repository</p></li>
				<li>The system will <a id="_idIndexMarker523"/><a id="_idIndexMarker524"/>prompt to add a repository by providing two options (<em class="italic">Figure 5.3</em>) – to either create a new repository <a id="_idIndexMarker525"/><a id="_idIndexMarker526"/>or connect to an external repository. In this case, select the option to create a new repository:<div id="_idContainer043" class="IMG---Figure"><img src="image/B15587_05_03.jpg" alt="Figure 5.3 – Option to create a new repository&#13;&#10;"/></div><p class="figure-caption">Figure 5.3 – Option to create a new repository</p></li>
				<li>Create a repository by entering a repository name. Additionally, select a project under which the<a id="_idIndexMarker527"/><a id="_idIndexMarker528"/> repository should <a id="_idIndexMarker529"/><a id="_idIndexMarker530"/>be created (<em class="italic">Figure 5.4</em>):</li>
			</ol>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/B15587_05_04.jpg" alt="Figure 5.4 – Creating a new repository&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.4 – Creating a new repository</p>
			<p>This will create a new repository from the console. However, there will be situations where it is required to create a repository through scripts and that means through the command line. This is specifically recommended when automation is at the forefront and the goal is to eliminate toil. The upcoming topic details how to create a repository via the CLI.</p>
			<h2 id="_idParaDest-115"><a id="_idTextAnchor114"/>Creating a repository via the CLI</h2>
			<p>To create a cloud source <a id="_idIndexMarker531"/><a id="_idIndexMarker532"/>repository via the command line or CLI, execute the following commands. It is required to either install <a id="_idIndexMarker533"/><a id="_idIndexMarker534"/>Google Cloud SDK or use Google Cloud Shell:</p>
			<p class="source-code"># Enable the Cloud Source Repository API</p>
			<p class="source-code">gcloud services enable sourcerepo.googleapis.com</p>
			<p class="source-code"># Create a repository</p>
			<p class="source-code">gcloud source repos create my-first-csr --project $GOOGLE_CLOUD_PROJECT ops-2021</p>
			<p>The preceding steps will create a new repository from the CLI. Essentially, the new repository created in CSR from either the console or the CLI will be an empty repository. The next topic will detail how to add files to a repository in CSR.</p>
			<h2 id="_idParaDest-116"><a id="_idTextAnchor115"/>Adding files to a repository in CSR</h2>
			<p>Once a repository <a id="_idIndexMarker535"/>is created, developers can create a branch and make their changes inside that branch. These changes can then be merged into the master once confirmed. This is a multi-step process (as detailed in the <a id="_idIndexMarker536"/><a id="_idIndexMarker537"/>following procedure) that could be executed from the user's terminal window with Google Cloud SDK installed or via Google Cloud Shell from the user's choice of browser: </p>
			<ol>
				<li value="1">Clone the repository to a local Git repository:<p class="source-code"><strong class="bold">gcloud source repos clone my-first-csr --project=$GOOGLE_CLOUD_PROJECT</strong></p></li>
				<li>Switch to the new local Git repository:<p class="source-code"><strong class="bold">cd my-first-csr</strong></p></li>
				<li>Create a new branch:<p class="source-code"><strong class="bold">git checkout -b my-first-csr-branch</strong></p></li>
				<li>Add a file to the new branch:<p class="source-code"><strong class="bold">touch hello.txt</strong></p><p class="source-code"><strong class="bold">git add hello.txt</strong></p></li>
				<li>Commit changes of the new file to the branch:<p class="source-code"><strong class="bold">git commit -m "My first commit!!"</strong></p></li>
				<li>Push changes to the branch:<p class="source-code"><strong class="bold">git push --set-upstream origin my-first-csr-branch</strong></p></li>
				<li>Create a master branch (as this is the first check into <strong class="source-inline">master</strong>):<p class="source-code"><strong class="bold">     git checkout -b master</strong></p></li>
				<li>Merge the branch to <strong class="source-inline">master</strong>:<p class="source-code"><strong class="bold">     git push --set-upstream origin master</strong></p></li>
			</ol>
			<p>This completes this section and you can now create an empty repository and subsequently add files to a working branch and then check into the master. However, there will be situations where the user can <a id="_idIndexMarker538"/><a id="_idIndexMarker539"/>work with either an existing repository in GCP's CSR or external source repositories in GitHub/Bitbucket. Either way, the process to clone an existing<a id="_idIndexMarker540"/><a id="_idIndexMarker541"/> repository is the same. In addition, CSR allows one-way sync from external repositories such as GitHub/Bitbucket. All these details will be covered in the next section.</p>
			<h1 id="_idParaDest-117"><a id="_idTextAnchor116"/>One-way sync from GitHub/Bitbucket to CSR</h1>
			<p>CSR provides an option to add a<a id="_idIndexMarker542"/><a id="_idIndexMarker543"/> repository by connecting to an external repository and perform near real-time one-way sync. Currently, GitHub<a id="_idIndexMarker544"/><a id="_idIndexMarker545"/> and Bitbucket are the only supported external source repositories.</p>
			<p>The following is the step-by-step process to create a repository in CSR by connecting to an external GitHub repository (similar steps will apply to a Bitbucket-based repository):</p>
			<ol>
				<li value="1">Navigate to <strong class="bold">Source Repositories</strong> in Google Cloud Console and select the <strong class="bold">Add Repository</strong> option.</li>
				<li>Select the option to connect to an external repository (<em class="italic">Figure 5.5</em>):<div id="_idContainer045" class="IMG---Figure"><img src="image/B15587_05_05.jpg" alt="Figure 5.5 – Option to connect to an external repository&#13;&#10;"/></div><p class="figure-caption">Figure 5.5 – Option to connect to an external repository</p></li>
				<li>Select an appropriate project and an external Git provider (<strong class="bold">GitHub</strong> in this case) and authorize the selected GCP<a id="_idIndexMarker546"/><a id="_idIndexMarker547"/> project to store third-party <a id="_idIndexMarker548"/><a id="_idIndexMarker549"/>authentication credentials in order to enable connected repository services (<em class="italic">Figure 5.6</em>):<div id="_idContainer046" class="IMG---Figure"><img src="image/B15587_05_06.jpg" alt="Figure 5.6 – Connecting to GitHub&#13;&#10;"/></div><p class="figure-caption">Figure 5.6 – Connecting to GitHub</p></li>
				<li>Enter <a id="_idIndexMarker550"/><a id="_idIndexMarker551"/>your GitHub credentials and <a id="_idIndexMarker552"/><a id="_idIndexMarker553"/>authorize GCP to access the provided GitHub account (<em class="italic">Figure 5.7</em>):<div id="_idContainer047" class="IMG---Figure"><img src="image/B15587_05_07.jpg" alt="Figure 5.7 – Authorizing GCP to access GitHub&#13;&#10;"/></div><p class="figure-caption">Figure 5.7 – Authorizing GCP to access GitHub</p></li>
				<li>Once authorized, select the GitHub<a id="_idIndexMarker554"/><a id="_idIndexMarker555"/> repo that needs to be synced with CSR and then select the <strong class="bold">Connect selected repository</strong> <a id="_idIndexMarker556"/><a id="_idIndexMarker557"/>action (<em class="italic">Figure 5.8</em>):<div id="_idContainer048" class="IMG---Figure"><img src="image/B15587_05_08.jpg" alt="Figure 5.8 – Connecting GCR to the selected GitHub repository&#13;&#10;"/></div><p class="figure-caption">Figure 5.8 – Connecting GCR to the selected GitHub repository</p></li>
				<li>The following prompt (<em class="italic">Figure 5.9</em>) will be displayed once the connection is established between the GitHub repo and GCP's CSR. The first-time sync might take some time, but <a id="_idIndexMarker558"/><a id="_idIndexMarker559"/>subsequent syncs are near real-time:<div id="_idContainer049" class="IMG---Figure"><img src="image/B15587_05_09.jpg" alt="Figure 5.9 – Confirmation that one-way sync is established with GitHub&#13;&#10;"/></div><p class="figure-caption">Figure 5.9 – Confirmation that one-way sync is established with GitHub</p></li>
				<li>The contents of the GitHub repo will eventually sync up with CSR and that also includes the commit history and any other available metadata (<em class="italic">Figure 5.10</em>):<div id="_idContainer050" class="IMG---Figure"><img src="image/B15587_05_10.jpg" alt="Figure 5.10 – Contents of the newly added GitHub repository&#13;&#10;"/></div><p class="figure-caption">Figure 5.10 – Contents of the newly added GitHub repository</p></li>
				<li>If the user adds a new file to the GitHub repo, then a near real-time one-way sync will be performed by CSR. The commit along with the recent changes will reflect in CSR against the relevant project. <em class="italic">Figure 5.11</em> highlights the new commit history:<div id="_idContainer051" class="IMG---Figure"><img src="image/B15587_05_11.jpg" alt="Figure 5.11 – Updating the commit history post a near real-time one-way sync&#13;&#10;"/></div><p class="figure-caption">Figure 5.11 – Updating the commit history post a near real-time one-way sync</p></li>
				<li>If there is a need to perform <a id="_idIndexMarker560"/><a id="_idIndexMarker561"/>forced sync from an<a id="_idIndexMarker562"/><a id="_idIndexMarker563"/> external repository to CSR or disconnect the external repository from CSR, navigate to the repository settings in GCP to find the appropriate options (<em class="italic">Figure 5.12</em>):</li>
			</ol>
			<div>
				<div id="_idContainer052" class="IMG---Figure">
					<img src="image/B15587_05_12.jpg" alt="Figure 5.12 – Repository settings to force a sync or disconnect from GitHub&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.12 – Repository settings to force a sync or disconnect from GitHub</p>
			<p>This completes the detailed step-by-step process of establishing one-way sync with external repositories such as GitHub/Bitbucket. The next section dives into some common operations that a user can perform in CSR, such as browsing repositories and files and performing universal code search.</p>
			<h1 id="_idParaDest-118"><a id="_idTextAnchor117"/>Common operations in CSR</h1>
			<p>This section details the <a id="_idIndexMarker564"/><a id="_idIndexMarker565"/>common operations that could be performed in CSR. The options include the following:</p>
			<ul>
				<li>Browse repositories.</li>
				<li>Browse files.</li>
				<li>Perform a universal code search.</li>
				<li>Detect security keys.</li>
				<li>Assign access controls.</li>
			</ul>
			<p>Let's go through them in detail starting with the browsing repositories option.</p>
			<h2 id="_idParaDest-119"><a id="_idTextAnchor118"/>Browsing repositories</h2>
			<p>There are two specific views to <a id="_idIndexMarker566"/><a id="_idIndexMarker567"/>browse repositories. These views are represented across two tabs:</p>
			<ul>
				<li><strong class="bold">All repositories</strong></li>
				<li><strong class="bold">My source</strong></li>
			</ul>
			<h3>All repositories</h3>
			<p>CSR shows a consolidated view of all available <a id="_idIndexMarker568"/><a id="_idIndexMarker569"/>repositories across projects that the current user has access to. The combination of repository name and project ID forms a unique tuple.</p>
			<p>The user can also mark repositories of choice (typically the most important or most constantly used) with a star. All starred repositories will show up under the <strong class="bold">My source</strong> tab to provide quick access to specific repositories (<em class="italic">Figure 5.13</em>):</p>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="image/B15587_05_13.jpg" alt="Figure 5.13 – List of repositories listed under All repositories&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.13 – List of repositories listed under All repositories</p>
			<p>Users can perform three specific operations against any repository displayed under the <strong class="bold">All repositories</strong> tab (refer to the green square box in <em class="italic">Figure 5.13</em>, in the following order):</p>
			<ul>
				<li><strong class="bold">Settings</strong>: This option allows the user to edit settings.</li>
				<li><strong class="bold">Clone</strong>: This option provides details required to clone the repository.</li>
				<li><strong class="bold">Permissions</strong>: This option allows you to control access to a repository either at the level of a user or a group or <a id="_idIndexMarker570"/><a id="_idIndexMarker571"/>service account.</li>
			</ul>
			<p>The user can access a repository by selecting a repository of choice from the list view or they can pick one from the tree view (via the drop-down control for <strong class="bold">All repositories</strong>).</p>
			<h3>My source</h3>
			<p>The repositories that are <a id="_idIndexMarker572"/><a id="_idIndexMarker573"/>starred in the <strong class="bold">All repositories</strong> section are listed to provide quick access to a user-selected subset. Additionally, recently viewed repositories (that may or may not be starred) are also listed and can be accessed with a click (<em class="italic">Figure 5.14</em>):</p>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="image/B15587_05_14.jpg" alt="Figure 5.14 – Contents of My source displaying starred and recently viewed repositories&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.14 – Contents of My source displaying starred and recently viewed repositories</p>
			<p>This concludes the details on how a user can browse through the repositories in CSR. The next topic focuses on browsing files within a specific repository.</p>
			<p>Browsing files</p>
			<p>Once a user <a id="_idIndexMarker574"/><a id="_idIndexMarker575"/>selects a repository to browse, the default view switches to the master branch. The user can view the list of files through a tree-like structure (on the left-hand side) and selecting any file will display the contents of the file (on the right-hand side). The user can also edit a file by using the <strong class="bold">Edit code in Cloud Shell</strong> option. At this point, the file will be opened in the Cloud Shell Editor (<em class="italic">Figure 5.15</em>) using the credentials associated with the project. The authentication happens automatically with no additional login:</p>
			<div>
				<div id="_idContainer055" class="IMG---Figure">
					<img src="image/B15587_05_15.jpg" alt="Figure 5.15 – Options to view/edit file contents&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.15 – Options to view/edit file contents</p>
			<p>The user can also switch to an existing branch by selecting the branch of choice (<em class="italic">Figure 5.16</em>). In addition, the user can view files by a specific tag or commit:</p>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="image/B15587_05_16.jpg" alt="Figure 5.16 – Options to switch branch or browse files by tag or commit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.16 – Options to switch branch or browse files by tag or commit</p>
			<p>If a user wants to view historical changes for a specific file, then they can view the change information either through the <strong class="bold">Blame</strong> panel (on the top right-hand side) or through the <strong class="bold">History</strong> sub-section (<em class="italic">Figure 5.17</em>):</p>
			<div>
				<div id="_idContainer057" class="IMG---Figure">
					<img src="image/B15587_05_17.jpg" alt="Figure 5.17 – Historical change information for a specific file in CSR&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.17 – Historical change information for a specific file in CSR</p>
			<p>This concludes the details on <a id="_idIndexMarker576"/><a id="_idIndexMarker577"/>how a user can browse through files within a specific repository. The next topic focuses on how a user can perform a universal code search within a repository or across repositories in CSR. </p>
			<h2 id="_idParaDest-120"><a id="_idTextAnchor119"/>Performing a universal code search</h2>
			<p>CSR provides the ability to <a id="_idIndexMarker578"/><a id="_idIndexMarker579"/>search code snippets or files through the search box located on the CSR console. The user can search by <a id="_idIndexMarker580"/><a id="_idIndexMarker581"/>typing text (preferably within double quotes) or by using regular expressions.</p>
			<p>The scope of the search can be set to one of four possible levels (<em class="italic">Figure 5.18</em>):</p>
			<ul>
				<li><strong class="bold">Everything</strong>: Search across all repositories that the user has access to.</li>
				<li><strong class="bold">This project</strong>: Search across all repositories in the current project.</li>
				<li><strong class="bold">This repository</strong>: Search across the current repository.</li>
				<li><strong class="bold">This directory</strong>: Search across the current directory:</li>
			</ul>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="image/B15587_05_18.jpg" alt="Figure 5.18 – Possible scopes to perform universal code search&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.18 – Possible scopes to perform universal code search</p>
			<p>The next topic covers the possible ways to perform a code search based on different filter criteria and their respective syntaxes.</p>
			<h3>Search filters</h3>
			<p>The following table lists some search filters that can be used to search for code:</p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="image/B15587_05_Table_5.1.jpg" alt=""/>
				</div>
			</div>
			<p>This concludes<a id="_idIndexMarker582"/><a id="_idIndexMarker583"/> the details <a id="_idIndexMarker584"/><a id="_idIndexMarker585"/>on how a user can perform a universal code search. The next topic focuses on a specific feature in CSR that can specifically enforce a policy to detect security keys when a user attempts to make a code commit.</p>
			<h2 id="_idParaDest-121"><a id="_idTextAnchor120"/>Detecting security keys</h2>
			<p>CSR provides <a id="_idIndexMarker586"/><a id="_idIndexMarker587"/>options to detect whether security keys are stored in a repository. If this feature is enabled, CSR will enforce this check when a user is trying to push code into the repository either to a branch or master. If the contents of the file include a security key, then the code will not be pushed, and the user will be notified. </p>
			<p>Currently, CSR can be set up to check for the following types of security keys:</p>
			<ul>
				<li>Service account credentials in JSON format</li>
				<li>PEM-encoded private keys</li>
			</ul>
			<p>The following commands will provide the ability to enable, disable, or override security key detection:</p>
			<p class="source-code"># To enable security key detection</p>
			<p class="source-code">gcloud source project-configs update --enable-pushblock</p>
			<p class="source-code"># To disable security key detection</p>
			<p class="source-code">gcloud source project-configs update --disable-pushblock</p>
			<p class="source-code"># To override security key detection at a commit level</p>
			<p class="source-code">git push -o nokeycheck</p>
			<p>This concludes the details <a id="_idIndexMarker588"/><a id="_idIndexMarker589"/>on how security keys can be detected during a code commit. The next topic focuses on the required access controls to perform operations in CSR.</p>
			<h2 id="_idParaDest-122"><a id="_idTextAnchor121"/>Assigning access controls</h2>
			<p>Access to repositories<a id="_idIndexMarker590"/><a id="_idIndexMarker591"/> can be assigned at either the project level or the repository level. If a user is assigned a specific role at the project level, then that role will be applied to the user for all repositories in that project. However, if a user is assigned a specific role for a specific repository, then it only applies to that repository.</p>
			<p>The following table summarizes the critical IAM roles required to access or perform actions on CSR:</p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/B15587_05_Table_5.2.jpg" alt=""/>
				</div>
			</div>
			<p>The next topic provides information on how cross-account project access can be set up.</p>
			<h3>Cross-account project access</h3>
			<p>If a user is part of project A but needs to access <a id="_idIndexMarker592"/>a specific repository in project B, then the user should be given the Source Repository Reader/Writer/Admin role, depending on the intended scope of the user from project A against a specific repository in project B. This can be achieved through the <strong class="bold">Permissions</strong> section under the repository settings.</p>
			<p>This concludes the details on access controls specific to CSR. This also brings us to the end of a major section focused on <a id="_idIndexMarker593"/><a id="_idIndexMarker594"/>common operations that users can perform in CSR. The upcoming section is a hands-on lab where a cloud function is deployed using the code hosted in a cloud source repository.</p>
			<h1 id="_idParaDest-123"><a id="_idTextAnchor122"/>Hands-on lab – integrating with Cloud Functions</h1>
			<p>The objective of this hands-on lab is to demonstrate<a id="_idIndexMarker595"/><a id="_idIndexMarker596"/> the integration between a GCP compute service such as Cloud Functions with CSR. The intent is to illustrate how code can be deployed in Cloud Functions by pulling the code hosted from CSR. The following is a summary of the steps at a high level:</p>
			<ol>
				<li value="1">Add code to an existing repository through the Cloud Shell Editor. </li>
				<li>Push code from the Cloud Shell Editor (local repository) into CSR.</li>
				<li>Create a cloud function and deploy code from the repository in CSR.</li>
			</ol>
			<h2 id="_idParaDest-124"><a id="_idTextAnchor123"/>Adding code to an existing repository through the Cloud Shell Editor</h2>
			<p>This sub-section specifically focuses on <a id="_idIndexMarker597"/><a id="_idIndexMarker598"/>adding code to an existing repository. Developers typically use their favorite editors to make code changes. The following shows the usage of GCP's Cloud Shell Editor, an online development environment that supports cloud-native development through the Cloud Code plugin along with language support for Go, Java, .NET, Python, and Node.js:   </p>
			<ol>
				<li value="1">Navigate to <strong class="bold">Source Repositories</strong> in the GCP console.</li>
				<li>Navigate to the repository of choice where you want to add code. You can use the <strong class="source-inline">my-first-csr</strong> repository that was previously created.</li>
				<li>Select the <strong class="bold">Edit in Cloud Shell</strong> action. This opens the code in the Cloud Shell Editor and also clones the code from CSR into a local repository under the Cloud Shell console.</li>
				<li>Add a new code file called <strong class="source-inline">main.py</strong>. Copy the contents of this file from <a href="https://github.com/PacktPublishing/Google-Cloud-Platform-for-DevOps-Engineers/blob/main/cloud-build/">https://github.com/PacktPublishing/Google-Cloud-Platform-for-DevOps-Engineers/blob/main/cloud-build/main.py</a>.</li>
				<li>Save the code file.</li>
			</ol>
			<p>Once the code is edited and added, the next step is to push the code into CSR. This will be covered as the next topic.</p>
			<h2 id="_idParaDest-125"><a id="_idTextAnchor124"/>Pushing code from the Cloud Shell Editor (local repository) into CSR</h2>
			<p>This sub-section specifically focuses <a id="_idIndexMarker599"/><a id="_idIndexMarker600"/>on pushing code from a local repository of the Cloud Shell Editor into CSR. A terminal can be opened within Cloud Shell to provide command-line instructions. A command-line approach to push code is elaborated on in the following procedure:</p>
			<ol>
				<li value="1">Switch to the console window in the Cloud Shell Editor.</li>
				<li>Perform Git operations to add the new file and commit the changes:<p class="source-code"><strong class="bold"># Add new code file to the repository</strong></p><p class="source-code"><strong class="bold">git add main.py</strong></p><p class="source-code"><strong class="bold"># Commit the changes to the repository</strong></p><p class="source-code"><strong class="bold">git commit -m "Adding main.py"</strong></p></li>
				<li>Push the local repository created in the Cloud Shell Editor with the new changes into the repository hosted in CSR. Indicate the appropriate project (after <strong class="source-inline">/p</strong>) and the destination repository in CSR (after <strong class="source-inline">/r</strong>):<p class="source-code"><strong class="bold"># Add local repository in Cloud Shell Editor as remote</strong></p><p class="source-code"><strong class="bold">git remote add google \</strong></p><p class="source-code"><strong class="bold">https://source.developers.google.com/p/gcp-devops-2021/r/my-first-csr </strong></p><p class="source-code"><strong class="bold"># The above will create a remote repository with changes from the local repository</strong></p><p class="source-code"><strong class="bold"># Push code to Cloud Source Repositories</strong></p><p class="source-code"><strong class="bold">git push --all google</strong></p><p class="source-code"><strong class="bold"># The above git push command will push the changes in the remote repository with specific project and repository name to google cloud source repositories</strong></p></li>
				<li>Navigate to the target repository (for example, <strong class="source-inline">my-first-csr</strong>) in CSR to view the newly added Python file, <strong class="source-inline">main.py</strong>.</li>
			</ol>
			<p>Once the code is pushed to CSR from the remote branch, the code will be available in the master and is now ready to be deployed into any compute option of choice. The next topic illustrates the steps involved to download source code from CSR and deploy it into GCP's serverless compute option: Cloud Functions. </p>
			<h2 id="_idParaDest-126"><a id="_idTextAnchor125"/>Creating a cloud function and deploying code from the repository in CSR</h2>
			<p>This sub-section specifically<a id="_idIndexMarker601"/><a id="_idIndexMarker602"/> illustrates how CSR can integrate with other GCP compute options such as Cloud<a id="_idIndexMarker603"/><a id="_idIndexMarker604"/> Functions:    </p>
			<ol>
				<li value="1">Navigate to <strong class="bold">Cloud Functions</strong> in the GCP console.</li>
				<li>Select the option to create a function (if a function is created for the very first time in a project, then this action will enable the Cloud Functions API).</li>
				<li>Enter a function name of your choice and select a region, trigger type, and authentication mode. Save the options and continue. The following are examples:<p>a) <strong class="bold">Function name</strong>: <strong class="source-inline">my-first-csr</strong></p><p>b) <strong class="bold">Region</strong>: <strong class="source-inline">us-central1</strong></p><p>c) <strong class="bold">Trigger type</strong>: <strong class="source-inline">HTTP</strong></p><p>d) <strong class="bold">Authentication</strong>: <strong class="source-inline">Allow unauthenticated invocations</strong></p></li>
				<li>Set the runtime as <strong class="bold">Python 3.8</strong> and the source code option as <strong class="bold">Cloud Source Repository</strong>.</li>
				<li>Enter details related to the repository from which the code needs to be deployed and select the <strong class="bold">Deploy</strong> action (<em class="italic">Figure 5.19</em>):<p>a) <strong class="bold">Entry point</strong>: Should be the name of the function that needs to be invoked by Cloud Functions. In this example, enter <strong class="source-inline">hello_world</strong> as the value. </p><p>b) <strong class="bold">Repository</strong>: Should be the name of the repository in CSR where the source code is present. In this example, enter <strong class="source-inline">my-first-csr</strong> as the value. </p><p>c) <strong class="bold">Branch name</strong>: Should be the branch where the code is present. In this example, enter <strong class="source-inline">master</strong> as the value. </p><p>d) <strong class="bold">Directory with source code</strong>: Should be the directory path where the function mentioned as the entry point exists. In this example, enter <strong class="source-inline">/</strong> as the value:</p><div id="_idContainer061" class="IMG---Figure"><img src="image/B15587_05_19.jpg" alt="Figure 5.19 – Configuring the cloud source repository as the source code option&#13;&#10;"/></div><p class="figure-caption">Figure 5.19 – Configuring the cloud source repository as the source code option</p></li>
				<li>The function will <a id="_idIndexMarker605"/><a id="_idIndexMarker606"/>be successfully deployed (<em class="italic">Figure 5.20</em>). The function can be tested either using the <strong class="bold">Test Function</strong> option under <strong class="bold">Actions</strong> in the<a id="_idIndexMarker607"/><a id="_idIndexMarker608"/> list page or through the trigger URL specified under the <strong class="bold">Details</strong> section of the cloud function:</li>
			</ol>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="image/B15587_05_20.jpg" alt="Figure 5.20 – Cloud function successfully deployed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.20 – Cloud function successfully deployed</p>
			<p>This completes a detai<a id="_idTextAnchor126"/>led lab where the user makes a code change using GCP's Cloud Shell Editor, pushes to a repository using GCP's CSR, and deploys code to one of GCP's compute options such as Cloud Functions.</p>
			<h1 id="_idParaDest-127"><a id="_idTextAnchor127"/>Summary</h1>
			<p>In this chapter, we discussed the service from Google Cloud to manage source code and provide Git version control to support collaborative development. This is the first key building block in the process of establishing a CI/CD process. In addition, we discussed various operations that can be performed in CSR along with a hands-on lab demonstrating native integration of CSR with Cloud Functions. The next chapter will focus on the services from Google Cloud required to build code, create image artifacts, and manage artifacts. These services include Cloud Build and Container Registry.</p>
			<p>Points to remember</p>
			<p>The following are some important points to remember:</p>
			<ul>
				<li>CSR is a fully managed private Git repository.</li>
				<li>CSR provides one-way sync with GitHub and Bitbucket.</li>
				<li>CSR provides a feature for universal code search and the search can be set either for a specific project, a specific repository, a specific directory, or everything.</li>
				<li>CSR can be set up to detect security keys. The currently supported types are service account credentials in JSON format and PEM-encoded private keys.</li>
				<li>CSR provides a feature to override security key detection at a commit level.</li>
				<li>Source Repository Reader/Writer/Admin are the supported access controls.</li>
			</ul>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor128"/>Further reading</h1>
			<p>For more information on GCP's Cloud Source Repositories, refer to the following:</p>
			<ul>
				<li><strong class="bold">Cloud Source Repositories</strong>: <a href="https://cloud.google.com/source-repositories ">https://cloud.google.com/source-repositories</a></li>
			</ul>
			<h1 id="_idParaDest-129"><a id="_idTextAnchor129"/>Practice test</h1>
			<p>Answer the following questions:</p>
			<ol>
				<li value="1">Select the command that can be used to create a new repository in CSR called <strong class="source-inline">my-first-csr</strong> through the CLI:<p>a) <strong class="source-inline">gcloud create source repos my-first-csr</strong></p><p>b) <strong class="source-inline">gcloud source repos create my-first-csr</strong></p><p>c) <strong class="source-inline">gcloud create source repos my-first-csr</strong></p><p>d) <strong class="source-inline">gcloud source repo create my-first-csr</strong></p></li>
				<li>Which of the following options allows one-way sync with CSR?<p>a) GitHub</p><p>b) Bitbucket</p><p>c) None of the above</p><p>d) Options <em class="italic">a</em> and <em class="italic">b</em></p></li>
				<li>Select the frequency of one-way sync from supported repository types to CSR:<p>a) Every 5 minutes</p><p>b) Configurable</p><p>c) Real-time</p><p>d) Near real-time</p></li>
				<li>Which of the following is not a supported search filter in CSR?<p>a) Search file contents</p><p>b) Search by language</p><p>c) Search by function</p><p>d) Search by including terms</p></li>
				<li>If the <strong class="bold">Detect Security Keys</strong> CSR feature is enabled, then when will CSR enforce this check?<p>a) When a file is created</p><p>b) <strong class="source-inline">git add</strong></p><p>c) <strong class="source-inline">git push</strong></p><p>d) <strong class="source-inline">git commit</strong></p></li>
				<li>Select the command to override security key detection at a commit level:<p>a) <strong class="source-inline">git push -o keycheck</strong></p><p>b) <strong class="source-inline">git push -o nokeycheck</strong></p><p>c) <strong class="source-inline">git push -o anykeycheck</strong></p><p>d) <strong class="source-inline">git push -o nonekeycheck</strong></p></li>
				<li>Select two commands to enable and disable security key detection:<p>a) <strong class="source-inline">gcloud source project-configs update --enable-codeblock</strong></p><p>b) <strong class="source-inline">gcloud source project-configs update --enable-pushblock</strong></p><p>c) <strong class="source-inline">gcloud source project-configs update --disable-codeblock</strong></p><p>d) <strong class="source-inline">gcloud source project-configs update --disable-pushblock</strong></p></li>
				<li>Which out of the following is not a valid access control with respect to CSR?<p>a) Source Repository Reader</p><p>b) Source Repository Writer</p><p>c) Source Repository Editor</p><p>d) Source Repository Admin</p></li>
				<li>Which out of the following access controls can update a repository but cannot create one?<p>a) Source Repository Reader</p><p>b) Source Repository Writer</p><p>c) Source Repository Editor</p><p>d) Source Repository Admin</p></li>
				<li>Which out of the following access controls can update repository configurations?<p>a) Source Repository Reader</p><p>b) Source Repository Writer</p><p>c) Source Repository Editor</p><p>d) Source Repository Admin</p></li>
			</ol>
			<h1 id="_idParaDest-130"><a id="_idTextAnchor130"/>Answers</h1>
			<ol>
				<li value="1">(b) – <strong class="source-inline">gcloud source repos create "my-first-csr"</strong></li>
				<li>(d) – Options <em class="italic">a</em> and <em class="italic">b</em></li>
				<li>(d) – Near real-time</li>
				<li>(d) – Search by including terms</li>
				<li>(d) – <strong class="source-inline">git commit</strong></li>
				<li>(b) – <strong class="source-inline">git push -o nokeycheck</strong> </li>
				<li>(b) – <strong class="source-inline">gcloud source project-configs update --enable-pushblock</strong> and (d) – <strong class="source-inline">gcloud source project-configs update --disable-pushblock</strong></li>
				<li>(c) – Source Repository Editor</li>
				<li>(b) – Source Repository Writer</li>
				<li>(d) – Source Repository Admin</li>
			</ol>
		</div>
	</body></html>