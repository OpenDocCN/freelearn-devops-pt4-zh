<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Configuring Vagrant Using a Vagrantfile</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will focus on configuring Vagrant by using Vagrantfiles. We will focus on the key aspects of a Vagrantfile, such as its structure and syntax. At the end of this section, we will have covered the following topics:</p>
<ul class="calibre10">
<li class="calibre11">Understanding Vagrantfiles</li>
<li class="calibre11">Creating a Vagrantfile</li>
<li class="calibre11">Vagrantfile structure and syntax</li>
<li class="calibre11">Troubleshooting a Vagrantfile</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding Vagrantfiles</h1>
                
            
            <article>
                
<p class="calibre2">A Vagrantfile is the main way of configuring a Vagrant environment. This file has no extension as such; it is simply found on your system as <kbd class="calibre12">Vagrantfile</kbd> , not <kbd class="calibre12">.Vagrantfile</kbd> or <kbd class="calibre12">vagrantfile.Vagrantfile</kbd>.</p>
<p class="calibre2">Using a Vagrantfile allows you to manage your Vagrant environment dependencies and settings. It is a best practice to have one Vagrantfile per Vagrant project, and to include the Vagrantfile in your source control.</p>
<p class="calibre2">One of the main benefits of using a Vagrantfile is the ability to share that file with any other developer that has Vagrant installed. They will be able to simply run the <kbd class="calibre12">vagrant up</kbd> command to pull in any dependencies, such as boxes, and to set up any configuration to get the same Vagrant environment up and running as you.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a Vagrantfile</h1>
                
            
            <article>
                
<p class="calibre2">Before we create our own Vagrantfile, let's first create and move into a new directory. In this example, we will create a new directory called <kbd class="calibre12">vagrantfiletest</kbd> to keep things simple! Run the following commands in the given order:</p>
<ol class="calibre13">
<li value="1" class="calibre11"><kbd class="calibre12">mkdir vagrantfiletest</kbd></li>
<li value="2" class="calibre11"><kbd class="calibre12">cd vagrantfiletest</kbd></li>
<li value="3" class="calibre11"><kbd class="calibre12">vagrant init</kbd></li>
</ol>
<p class="calibre2">By using the <kbd class="calibre12">vagrant init</kbd> command, we have now initialized a new Vagrantfile in our current <kbd class="calibre12">vagrantfiletest</kbd> directory, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00045.jpeg" class="calibre47"/></div>
<p class="calibre2">The default Vagrantfile has a basic structure to get you started. If you wish to create a very minimal shell then you can run either the <kbd class="calibre12">vagrant init --minimal</kbd> or the <kbd class="calibre12">vagrant init -m</kbd> command, either of which will generate a very basic Vagrantfile with no comments or additional settings, as follows:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/> config.vm.box = "base"<br class="title-page-name"/> end</pre>
<p class="calibre2">Now let's move on to the next section and learn more about a Vagrantfile's syntax.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrantfile syntax</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre6">A Vagrantfile uses the Ruby language syntax but no knowledge of Ruby is required. It is a simple, expressive, and easy-to-understand language when using the Vagrantfile. In most cases you will simply be setting a variable and a value, such as </span><kbd class="calibre12">config.vm.box = "ubuntu/trusty64"</kbd><span class="calibre6"> , which sets the box to </span><kbd class="calibre12">ubuntu/trusty64</kbd><span class="calibre6">, the 64-bit version of Ubuntu 14.04.</span></p>
<p class="calibre2">A Vagrantfile configuration is contained within the <kbd class="calibre12">configure</kbd> block. The first line is <kbd class="calibre12">Vagrant.configure("2") do |config|</kbd> and the last line is <kbd class="calibre12">end</kbd>. Within this block we can define all sorts of values, such as the Vagrant box, networking, filesystems, provisioning, and more. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrantfile options</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will cover the various sections that are available to configure in a Vagrantfile. You will learn how to configure the virtual machine directly, configure the provider (VirtualBox), and configure how Vagrant will connect to your machine via SSH or any other communicator.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant machine configuration (config.vm)</h1>
                
            
            <article>
                
<p class="calibre2">Using the <kbd class="calibre12">config.vm</kbd> namespace, we will look at configuring certain parts of the Vagrant machine, such as box information and miscellaneous settings including synced folders, provision, and providers. The configurable elements are as follows:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.vm.boot_timeout</kbd> is used to specify (in seconds) how long Vagrant will wait for the machine to start up and become available for use. The default time is 300 seconds.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box</kbd> is used to set a specific box for the machine. You can reference a box already installed on your system or a shorthand syntax box name from the Vagrant cloud, such as <kbd class="calibre12">ubuntu/trusty64</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_check_update</kbd> is used by Vagrant to check whether the box you have selected or the box being used by the current machine is up to date. The default setting is <kbd class="calibre12">true</kbd> but only certain box types can be checked for an update – mainly Vagrant cloud boxes. If an update is found during the Vagrant startup process, a yellow message will be displayed on the screen to the user.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_checksum</kbd> is used to compare the checksum of a box and a given checksum; if they do not match then it will throw an error. Vagrant will only perform this check when a box needs to be downloaded. This value requires the <kbd class="calibre12">config.vm.box_download_checksum_type</kbd> value to be set.</li>
</ul>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_checksum_type</kbd> is the checksum hash type used when comparing checksum values used by the <kbd class="calibre12">config.vm.box_download_checksum</kbd> value. There are a few supported options here, and they are <kbd class="calibre12">md5</kbd>, <kbd class="calibre12">sha1</kbd>, and <kbd class="calibre12">sha256</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_client_cert</kbd> is used to supply a path to a client certificate that is used when downloading a box. There is no default value for this setting.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_ca_cert</kbd> is used to supply the path to a CA certificate bundle that is used when downloading a box directly. The default value for this uses the Mozilla CA certificate bundle.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_ca_path</kbd> is used to supply a path to a directory containing CA certificates when downloading a box directly. Similarly, the default value used is the Mozilla CA certificate bundle.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_insecure</kbd> is used to validate SSL certificates from the server. If <kbd class="calibre12">true</kbd> is set then no validation will be done. If the box URL is HTTPS then the SSL certificates will be verified.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_download_location_trusted</kbd> is used to trust all redirects when the value is set to <kbd class="calibre12">true</kbd>. The default process is for Vagrant to trust the initial request, using any specified credentials.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_url</kbd> is used to set a specific box URL. This is similar to <kbd class="calibre12">config.vm.box</kbd> but it does not support the shorthand Vagrant cloud syntax for box names; if <kbd class="calibre12">config.vm.box</kbd> has been set in the Vagrantfile, you do not need to specify a value here. The value specified can be a single URL or multiple URLs that will be tried in order. If you have already configured other settings such as certificates, they will be applied to all URLs supplied. The Vagrantfile does also support local files using the <kbd class="calibre12">file://</kbd> abbreviation and scheme.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.box_version</kbd> is used to specify what box version to use. This value supports constraints separated by commas such as (greater than and equal to) &gt;= 0.2 and &lt; 2.0 (less than), where Vagrant would look for a box version that's between 0.2 and less then 2.0 . Vagrant will try and get the latest box version within these constraints. The default value used is &gt;= 0, which signifies the latest version available.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.communicator</kbd> is used to set the communicator type that connects to the guest box. The default value is <kbd class="calibre12">ssh</kbd> but it is recommended that Windows guests use <kbd class="calibre12">winrm</kbd>.</li>
</ul>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.vm.graceful_halt_timeout</kbd> is used to set the time (in seconds) that Vagrant will wait for the machine to halt. This applies when the <kbd class="calibre12">vagrant halt</kbd> command is used, and the default value is 60 seconds.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.guest</kbd> is used to set the guest OS that will be running within the machine. Vagrant will attempt to auto-detect the correct OS used. This information is required to perform certain OS-specific values such as network configuration. The default value for this is <kbd class="calibre12">:linux</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.hostname</kbd> is used to set a hostname for a machine. The value should be provided as a string, for example <kbd class="calibre12">elite</kbd>. The default value is <kbd class="calibre12">nil</kbd>, which means that Vagrant will not manage the hostname. This hostname (if it's a provider) will be set during boot.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.network</kbd> is used to set the machine's network options. There are quite a few options available for this setting, and they will be covered in a later chapter. Some of the main options include <kbd class="calibre12">forwarded_port</kbd>, <kbd class="calibre12">private_network</kbd>, and <kbd class="calibre12">public_network</kbd>.  Each option has various sub-values or sub-options that you can set.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.post_up_message</kbd> is used to display a message to the user after the <kbd class="calibre12">vagrant up</kbd> command is run. This is similar to a message of the day found on servers or other pieces of software that you can log into.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.provider</kbd> is a configuration block used to set provider-specific values. Each provider supports different values but you can have multiple configuration blocks that target different providers. As we are using VirtualBox as our provider, we can set specific values such as <kbd class="calibre12">memory</kbd>, which sets the RAM, <kbd class="calibre12">cpus</kbd>, which sets the CPU core count, and <kbd class="calibre12">gui</kbd>, which when set to <kbd class="calibre12">true</kbd> will actually open the Vagrant machine in a GUI so you can interact with it.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.provision</kbd> is used to specify a provisioner that can install and configure software during the creation process. This is quite an advanced topic and something we will cover in later chapters. Certain providers supported are Chef, Ansible, Puppet, and a standard script.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.synced_folder</kbd> is used to configure synced folders between your host machine and the guest machine. This will allow you to create or edit a file on your system (in the synced folder) and have that change made and become visible in the Vagrant machine.</li>
<li class="calibre11"><kbd class="calibre12">config.vm.usable_port_range</kbd> is used to specify a port range that Vagrant can use. The default value or port range is <kbd class="calibre12">220..2250</kbd>. Vagrant will use these values for any port collisions that happen.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant SSH configuration (config.ssh)</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre6">Using the </span><kbd class="calibre12">config.ssh</kbd><span class="calibre6"> namespace we will look at configuring Vagrant so it connects to a guest machine using SSH. Here, we will look at certain values such as SSH username, password, ports, and keys, as follows:<br class="calibre5"/></span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.ssh.username</kbd> is used to set the username that Vagrant will use when trying to connect via SSH. The default username is <kbd class="calibre12">vagrant</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.password</kbd> is used to set the password that Vagrant will use when trying to connect via SSH. </li>
<li class="calibre11"><kbd class="calibre12">config.ssh.host</kbd> is used to set the hostname or IP address used when SSHing in. This value is often left blank by default as the provider can auto-detect the correct value.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.port</kbd> is used to set the port used for SSHing into. The default value used is 22.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.guest_port</kbd> is used to set the port number that SSH will run on on the guest machine. Vagrant can use this along with <kbd class="calibre12">config.ssh.port</kbd> to intelligently connect to the correct SSH port. This is often used if there is a forwarded port.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.private_key_path</kbd> is used to set the path to a private key that you want to use when connecting to a machine. The default value is an insecure key that Vagrant and many public boxes use.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.keys_only</kbd> is used when you wish to use Vagrant-provided SSH keys. The default setting is <kbd class="calibre12">true</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.verify_host_key</kbd> is used to perform host-key validation. The default value is <kbd class="calibre12">false</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.forward_agent</kbd> is used to enable agent forwarding over SSH. The default value is <kbd class="calibre12">false</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.forward_x11</kbd> is used to enable X11 forwarding over SSH. The default value is <kbd class="calibre12">false</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.forward_env</kbd> is used to supply an array of host environment variables to the guest machine.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.insert_key</kbd> is used when <kbd class="calibre12">true</kbd> (as per the default setting) to insert a new keypair to use with SSH, replacing the insecure, default Vagrant keypair. When set to <kbd class="calibre12">true</kbd>, this value is also used with the <kbd class="calibre12">config.ssh.password</kbd> option.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.proxy_command</kbd> is used to proxy a command-line command through SSH via <kbd class="calibre12">stdin</kbd>. </li>
</ul>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.ssh.pty</kbd> is not recommended unless you really need to use it. This option, when set to <kbd class="calibre12">true</kbd>, will use <kbd class="calibre12">pty</kbd> for provisioning. <kbd class="calibre12">pty</kbd> can break certain parts of Vagrant so be wary when using it.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.keep_alive</kbd> will send keep alive packets via SSH every 5 seconds to keep the connection alive when the value is set to <kbd class="calibre12">true</kbd>.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.shell</kbd> is used to set the shell you wish to use when running SSH commands from Vagrant.</li>
<li class="calibre11"><kbd class="calibre12">config.ssh.export_command_template</kbd> is the template used when generating environment variables in the active session.</li>
<li class="calibre11"><span><kbd class="calibre12">config.ssh.sudo_command</kbd> is used to set the command when running a <kbd class="calibre12">sudo</kbd> command. The default value is <kbd class="calibre12">sudo -E -H %c</kbd>, where <kbd class="calibre12">%c</kbd> is replaced by the command to run.</span></li>
<li class="calibre11"><span><kbd class="calibre12">config.ssh.compression</kbd> is used to send a compression setting when connecting via SSH if the value is set to <kbd class="calibre12">true</kbd>. To disable this, set the value to <kbd class="calibre12">false</kbd>.</span></li>
<li class="calibre11"><span><kbd class="calibre12">config.ssh.dsa_authentication</kbd> is used to send the DSA authentication setting when connecting via SSH if the value is set to <kbd class="calibre12">true</kbd>. To disable this, set the value to <kbd class="calibre12">false</kbd>.</span></li>
<li class="calibre11"><span><kbd class="calibre12">config.ssh.extra_args</kbd> is used to pass additional commands into the SSH executable. It supports a single value or an array of values. This can be sent to enable more advanced actions with SSH, such as reverse tunneling.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant settings (config.vagrant)</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre6">Using the </span><kbd class="calibre12">config.vagrant</kbd><span class="calibre6"> namespace we will look at configuring Vagrant specifically. There are not many options available within this namespace compared to the others we have already looked at. The commands for the <kbd class="calibre12">config.vagrant</kbd> namespace are as follows:<br class="calibre5"/></span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">config.vagrant.host</kbd> is used to set the host machine that is running Vagrant. The default value is <kbd class="calibre12">:detect</kbd>, which allows Vagrant to intelligently auto-detect the host. Certain features Vagrant offers are host-specific and this value is only recommended to be changed if auto-detection fails.</li>
<li class="calibre11"><kbd class="calibre12">config.vagrant.sensitive</kbd> is used to supply a list or array of items that will not be displayed in Vagrant's output or logged output. These values are often passwords or keys.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Other Vagrantfile settings</h1>
                
            
            <article>
                
<p class="calibre2">There are two other namespace settings that you can configure in the Vagrantfile. We will not be focusing on these in detail in this book, but the following section will offer an overview.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">WinRM settings (config.winrm)</h1>
                
            
            <article>
                
<p class="calibre2">The <kbd class="calibre12">config.winrm</kbd> namespace is used to configure Vagrant when using a Windows guest machine. To use these settings, you must set your <kbd class="calibre12">config.vm.communicator</kbd> setting to <kbd class="calibre12">winrm</kbd>.</p>
<p class="calibre2">There are around 12 different configuration options available, which include <kbd class="calibre12">config.winrm.username</kbd>, <kbd class="calibre12">config.winrm.password</kbd>, <kbd class="calibre12">config.winrm.port</kbd>, and <kbd class="calibre12">config.winrm.transport</kbd>. Using the <kbd class="calibre12">config.winrm</kbd> namespace gives you much more control over how Vagrant behaves when using a Windows guest machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">WinSSH settings (config.ssh and config.winssh)</h1>
                
            
            <article>
                
<p class="calibre2">This uses the <kbd class="calibre12">config.ssh</kbd> namespace, similar to namespaces we discussed earlier. This uses the WinSSH software, which is used for the Windows-native port of OpenSSH. Vagrant's official documentation states that WinSSH is in the <em class="calibre16">pre-release</em> stage and is therefore not yet production-ready.</p>
<p class="calibre2">There are around 17 different options available, which are a mixture of the <kbd class="calibre12">config.ssh</kbd> and <kbd class="calibre12">config.winssh</kbd> namespace, these include: <span class="calibre6"><kbd class="calibre12">config.ssh.username</kbd>, <kbd class="calibre12">config.ssh.password</kbd>, <kbd class="calibre12">config.winssh.forward_agent</kbd>, <kbd class="calibre12">config.winssh.upload_directory</kbd> , and <kbd class="calibre12">config.winssh.export_command_template</kbd>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Troubleshooting a Vagrantfile</h1>
                
            
            <article>
                
<p class="calibre2">A Vagrantfile can be quite a complex collection of configuration options. There are multiple options, such as basic string values, configuration blocks, array values, and much more. It can be quite common to write out a Vagrantfile, go to run <kbd class="calibre12">vagrant up</kbd> or a similar command, and be faced with an error.</p>
<p class="calibre2">An example of a Vagrant error after running the <kbd class="calibre12">vagrant up</kbd> command is as follows:</p>
<div class="cdpaligncenter"><img src="../images/00046.jpeg" class="calibre48"/></div>
<p class="calibre2">Let's dissect the error in the preceding screenshot. The first clue is a reference to the line number <kbd class="calibre12">Vagrantfile:24</kbd>; in other words, line 24 of the Vagrantfile. This error also gives us the type of error: <kbd class="calibre12">syntax error, unexpected tIDENTIFIER, expecting keyword_end # accessing "localhost:8080" will access port on</kbd>. This could mean that a config block or loop has no end value set, or we have tried to set an incomplete variable.</p>
<p class="calibre2">An easy way to check a Vagrantfile after making any changes and trying to run or provision a Vagrant machine is by using the <kbd class="calibre12">vagrant validate</kbd> command. In the following screenshot, you can see that we still get the same error and output from Vagrant even with the <kbd class="calibre12">vagrant validate</kbd> command:</p>
<div class="cdpaligncenter"><img src="../images/00047.jpeg" class="calibre49"/></div>
<p class="calibre2"/>
<p class="calibre2">Now let's open up the Vagrantfile and take a closer look at line 24, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img class="alignnone11" src="../images/00048.jpeg"/></div>
<p class="calibre2">Looking at line 24, we can see the value # <kbd class="calibre12">accessing "localhost:8080" will access port 80 on</kbd> mentioned in the error. Now, although this is a comment, we can see that the <kbd class="calibre12">localhost:8080</kbd> value is exposed because it is wrapped in double quotes (<kbd class="calibre12">"</kbd>). If we trace back towards the beginning of the file, we should come across line 15, which looks a little odd. Here, we can see the value is <kbd class="calibre12">config.vm.box = "base</kbd> but there is no closing double quote.</p>
<p class="calibre2"/>
<p class="calibre2">So, let's add a double quote to the end of this line, save the file, and run the <kbd class="calibre12">vagrant validate</kbd> command:</p>
<div class="cdpaligncenter"><img src="../images/00049.jpeg" class="calibre50"/></div>
<p class="calibre2">Great! As you can see in the preceding screenshot, we have successfully found the error and fixed it.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we looked at how to configure Vagrant using the Vagrantfile. We also looked at various parts of the Vagrantfile, such as how to create one, its supported commands, options, and values, its syntax and layout, and how to troubleshoot it when there is an issue. In the coming chapters, we will be using the Vagrantfile more to focus on specific areas of Vagrant, such as provisioning.</p>
<p class="calibre2">In <a target="_blank" href="part0171.html#532G60-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 6</a>, <em class="calibre16">Networking in Vagrant</em>, we will look at networking in Vagrant. In it, we will learn about the three main types of networking configurations: port-forwarding, public networks, and private networks.</p>


            </article>

            
        </section>
    </body></html>