<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Networking in Vagrant</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will be focusing on networking in Vagrant. By the end of this chapter, you will have a good understanding of the different networking options available in Vagrant. You will be able to configure networking in Vagrant using simple methods, such as port-forwarding, or set custom IP addresses using public and private networking.</p>
<p class="calibre2">Here are the three networking types present in Vagrant that you will learn about in this chapter:</p>
<ul class="calibre10">
<li class="calibre11">Port-forwarding</li>
<li class="calibre11">Private networking</li>
<li class="calibre11">Public networking</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Port-forwarding</h1>
                
            
            <article>
                
<p class="calibre2">A powerful yet simple way to configure networking in Vagrant is to use port-forwarding. This does not require any advanced knowledge or configuration on your part.</p>
<p class="calibre2">Port-forwarding is the action of linking a port on your host machine to a port on the guest machine. It is as simple as that, but can be really powerful as it allows you to get up and running quickly. </p>
<p class="calibre2">The following are the steps to configure port-forwarding:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Open up our Vagrantfile. We'll start with a very basic Vagrantfile by using the <kbd class="calibre12">ubuntu/xenial64</kbd> box and a basic shell provision script to install the nginx web server:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00050.jpeg" class="calibre51"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre11">Once you've saved the Vagrantfile, run the <kbd class="calibre12">vagrant up</kbd> command:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00051.jpeg" class="calibre52"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre11">Once the box has completed installing nginx and is up and running, open your web browser and try navigating to <kbd class="calibre12">localhost:8080</kbd>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00052.jpeg" class="calibre53"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">nginx should be available (possibly not on <kbd class="calibre12">port 8080</kbd>), but as you can see, we cannot access it. This is because we have not yet set up port-forwarding. If we access localhost from inside the Vagrant machine, we should be able to access it.</li>
</ol>
<ol start="5" class="calibre13">
<li value="5" class="calibre11">Run the <kbd class="calibre12">vagrant ssh</kbd> command. Once in the Vagrant machine, run the <kbd class="calibre12">curl localhost</kbd> command. This should return the nginx default page in HTML code:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00053.jpeg" class="calibre54"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre11">Let's set up port forwarding so we can access this page from the host machine (outside Vagrant).</li>
</ol>
<ol start="7" class="calibre13">
<li value="7" class="calibre11">Exit out of the machine and open up your Vagrantfile again. In the following code (you can see it on line 8 of the following screenshot) <span>–</span> <kbd class="calibre12">config.vm.network "forwarded_port", guest: 80, host: 8080</kbd>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00054.jpeg" class="calibre55"/></div>
<p class="calibre56">Let's break down the line that we just added into the Vagrantfile. First of all, we are calling the <kbd class="calibre12">config.vm.network</kbd> namespace to tell Vagrant that we want to change the network settings. The first argument we are passing in is <kbd class="calibre12">forwarded_port</kbd>, followed by two different port numbers. The first port is the port number that we will be accessing inside the guest/Vagrant machine. In the preceding example, we will be accessing port 80, which is generally the default port for a website/web server. The final argument is the host port, which is the port that we connect to from our host. In our example, it would be <kbd class="calibre12">8080</kbd>, and via URL we could access it at <kbd class="calibre12">http://localhost:8080</kbd>, which would connect to Vagrant and access the machine's <kbd class="calibre12">port 80</kbd>.</p>
<ol start="8" class="calibre13">
<li value="8" class="calibre11">Save the Vagranfile and run the <kbd class="calibre12">vagrant reload --provision</kbd> command.</li>
</ol>
<ol start="9" class="calibre13">
<li value="9" class="calibre11">This will restart the Vagrant machine and force provisioning to run again. You'll see, at the bottom of the following screenshot, that it now includes our new port in the <kbd class="calibre12">default: Forwarding ports...</kbd> section:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00055.jpeg" class="calibre57"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre11">Once the Vagrant machine is finished provisioning and is up and running, try to open <kbd class="calibre12">localhost:8080</kbd> in your browser:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00056.jpeg" class="calibre58"/></div>
<p class="calibre56">You should see the <span class="calibre6">Welcome to nginx!</span> default page. Congratulations! You have successfully configured port-forwarding on your Vagrant box.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Port-forwarding notes</h1>
                
            
            <article>
                
<p class="calibre2">When using the port-forwarding option within the Vagrantfile, there are a few tips you can use.</p>
<p class="calibre2">If you wish to forward multiple ports, simply create a new line and add the new guest/host ports. This could get messy if you have lots of ports to manage. At this point, it may be worth looking into the public and private networking options later in this chapter.</p>
<p class="calibre2">There are more options/parameters that you can use with this configuration:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">auto_correct</kbd>: Used for port-collision. If set to <kbd class="calibre12">true</kbd>, Vagrant will check to see whether it collides with a port already being used. If one is found, Vagrant will change the port number automatically.</li>
<li class="calibre11"><kbd class="calibre12">guest_ip</kbd>: The IP address of the guest that you wish to bind to the forwarded port.</li>
<li class="calibre11"><kbd class="calibre12">host_ip</kbd>: The IP address of the host that you wish to bind to the forwarded port.</li>
<li class="calibre11"><kbd class="calibre12">protocol</kbd>: The protocol allowed through the forwarded port. You may supply <kbd class="calibre12">udp</kbd> or <kbd class="calibre12">tcp</kbd> as options.</li>
<li class="calibre11"><kbd class="calibre12">id</kbd>: The rule name visible in VirtualBox. This would be formatted as <em class="calibre18">[protocol][guest]</em>, for example <kbd class="calibre12">udp111</kbd>.</li>
</ul>
<p class="calibre2">These arguments are optional. However, you are required to specify the <kbd class="calibre12">guest</kbd> and <kbd class="calibre12">host</kbd> port values.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Private networking</h1>
                
            
            <article>
                
<p class="calibre2">Private networking allows your Vagrant machine to be assigned and accessed via a private address space IP address. An example of a private IP address would be one you may have seen on your local area network, such as <kbd class="calibre12">192.168.1.2</kbd>.</p>
<p class="calibre2">Using this method can enable less restriction when accessing your Vagrant machine compared to port forwarding, since, by default, you can access any available port on that local IP address.</p>
<p class="calibre2">To use private networking, there are two main options. You can allow the IP address to be assigned by the <strong class="calibre4">Dynamic Host Configuration Protocol</strong> (<strong class="calibre4">DHCP</strong>) or you can choose one manually by adding in a static IP address.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">DHCP</h1>
                
            
            <article>
                
<p class="calibre2">Follow these step to use the DHCP option:</p>
<ol class="calibre13">
<li value="1" class="calibre11">You must select <kbd class="calibre12">dhcp</kbd> as the value for the <kbd class="calibre12">type</kbd> parameter. Within your Vagrantfile, add the following line to enable DHCP private networking:</li>
</ol>
<pre class="calibre59"><strong class="calibre1">config.vm.network "private_network", type: "dhcp"</strong></pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre11">When you save the Vagrantfile, you can run <kbd class="calibre12">vagrant up --provision</kbd> to see the changes:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00057.jpeg" class="calibre60"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre11">To find out the IP address of the newly-upped Vagrant machine, we must SSH into the machine itself.</li>
<li value="4" class="calibre11">Run the <kbd class="calibre12">vagrant ssh</kbd> command. Once in the Vagrant machine, run the <kbd class="calibre12">ifconfig</kbd> command (this networking command will depend on the operating system). Here is an example output:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00058.jpeg" class="calibre61"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre11">In the <kbd class="calibre12">enp0s8</kbd> section, you can see there is a red underlined value starting with <kbd class="calibre12">inet addr:</kbd>. This is the private IP address that our Vagrant machine is using. The value is <kbd class="calibre12">172.28.128.3</kbd>. Let's see whether we can now access the machine via this IP address.</li>
<li value="6" class="calibre11">Open an internet browser on your host machine and type in the IP address that was returned inside your Vagrant machine.</li>
</ol>
<div class="packt_infobox">You should still have nginx running on <kbd class="calibre62">port 80</kbd> inside the Vagrant machine to see the results.</div>
<ol start="7" class="calibre13">
<li value="7" class="calibre11">The following is an example of me navigating to that private IP address and seeing the nginx web server default page that was served from inside the Vagrant machine:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00059.jpeg" class="calibre63"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Static IP</h1>
                
            
            <article>
                
<p class="calibre2">To use the static IP option:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Enter a private address space IP address as the value for the <kbd class="calibre12">ip</kbd> parameter. Within your Vagrantfile, add the following line to enable static IP private networking:</li>
</ol>
<pre class="calibre59"><strong class="calibre1">config.vm.network "private_network", ip: "10.10.10.10"</strong></pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre11">When you save the Vagrantfile, run <kbd class="calibre12">vagrant up --provision</kbd> to force the changes. To confirm that your changes have been made, enter the <kbd class="calibre12">10.10.10.10</kbd> IP address into your internet browser on your host machine to see whether you get the nginx homepage:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00060.jpeg" class="calibre64"/></div>
<ol start="3" class="calibre13">
<li class="cdpalignleft1" value="3">You can also <kbd class="calibre12">vagrant ssh</kbd> into the machine, run the <kbd class="calibre12">ifconfig</kbd> command (this is OS-dependant), and look for that IP address in the returned values:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00061.jpeg" class="calibre65"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">When using the (static IP) option with private networking, there is an optional parameter you can supply. The <kbd class="calibre12">auto_config</kbd> parameter allows you to enable or disable auto-configuration. If you wish to manually configure the network interface, you can disable it using the <kbd class="calibre12">false</kbd> value:</li>
</ol>
<pre class="calibre59"><strong class="calibre1">config.vm.network "private_network", ip: "10.10.10.10", auto_config: false</strong></pre>
<p class="calibre56">I've found that in certain circumstances, sometimes you have to disable <kbd class="calibre12">auto_config</kbd> to get the static IP address to work.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">IPv6</h1>
                
            
            <article>
                
<p class="calibre2">You can also specify an IPv6 address using a similar format in your Vagrantfile:</p>
<pre class="calibre17"><strong class="calibre1">config.vm.network "private_network", ip: "fd12:3456:789a:1::1"</strong></pre>
<p class="calibre2">Using an IPv6 address is not supported by the DHCP option and must be supported by your host machine/network adapter. It is worth mentioning that the default subnet for IPv6 is <kbd class="calibre12">/64</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Public networking</h1>
                
            
            <article>
                
<p class="calibre2">Public networking in Vagrant can be quite a confusing concept. In essence, it is private networking, but Vagrant will attempt to allow public access from outside your host machine (if your provider and machine will allow it) instead of just allowing access from inside the host machine.</p>
<p class="calibre2">By performing the following steps, you should be able to access your Vagrant machine via an IP address from another device on your local network. Make sure that you have nginx installed so you know when you have successfully connected via HTTP to the IP address. I have been able to view the nginx default page using my smartphone on the same local network. If you were to use the <kbd class="calibre12">private_networking</kbd> option, this would not work and my smartphone would not be able to load a page or find the device, which would result in a timeout.</p>
<p class="calibre2">There are two main ways to set up public networking: you can use DHCP or manually assign a static IP address.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">DHCP</h1>
                
            
            <article>
                
<p class="calibre2">The fastest and easiest way to get started with public networking is to allow DHCP to assign an IP address to the Vagrant machine:</p>
<ol class="calibre13">
<li value="1" class="calibre11">In your Vagrantfile, use <kbd class="calibre12">config.vm.network "public_network"</kbd> to get it started.</li>
</ol>
<div class="packt_tip">There is no need to specify the <kbd class="calibre62">type</kbd> parameter like you would in the private networking DHCP configuration.</div>
<ol start="2" class="calibre13">
<li value="2" class="calibre11">Run the <kbd class="calibre12">vagrant up --provision</kbd> command to get the Vagrant machine up and running. As we are using a public network, you will be prompted to select a bridged network interface. Depending on your requirements and some possible trial and error, choose one. I will select the first option, <kbd class="calibre12">1) en0: (Wi-Fi) Airport</kbd>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00062.jpeg" class="calibre66"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre11"><span>To find out the IP address of the newly-upped Vagrant machine, we must SSH into the machine itself. Run the </span><kbd class="calibre12">vagrant ssh</kbd><span> command. Once in the Vagrant machine, run the </span><kbd class="calibre12">ifconfig</kbd><span> command (this networking command will depend on the operating system).</span></li>
</ol>
<p class="calibre56">There is an optional parameter that can be supplied when using DHCP. This is the <em class="calibre16">DHCP assigned default route</em>. In certain cases, this option may be required.</p>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">An example of this parameter would be adding <kbd class="calibre12">config.vm.network "public_network", use_dhcp_assigned_default_route: true</kbd> <span>into your Vagrantfile.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Static IP</h1>
                
            
            <article>
                
<p class="calibre2">Configuring a static IP address of your choice with public networking is fairly straightforward. You must supply the <kbd class="calibre12">ip</kbd> parameter in the Vagrantfile and add in the IP address you wish to use. Here is an example of the configuration in my Vagrantfile:</p>
<pre class="calibre17"><strong class="calibre1">config.vm.network "public_network", ip: "192.168.1.123"</strong></pre>
<p class="calibre2">Save your Vagrantfile and run the<span class="calibre6"> </span><kbd class="calibre12">vagrant up --provision</kbd><span class="calibre6"> </span>command to get the Vagrant machine up and running. As we are using a public network, you will be prompted to select a bridged network interface. Depending on your requirements and some possible trial and error then choose one. I <span class="calibre6">will select the first option, </span><kbd class="calibre12">1) en0: (Wi-Fi) Airport</kbd><span class="calibre6">:</span></p>
<div class="cdpaligncenter"><img src="../images/00063.jpeg" class="calibre67"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Network bridge</h1>
                
            
            <article>
                
<p class="calibre2">As you've seen in the public network DHCP and static IP address, when you run the <kbd class="calibre12">vagrant up</kbd> or <kbd class="calibre12">vagrant up --provision</kbd> command, you will be asked to select which network bridge to use. To avoid this step, you can supply the default network bridge in the Vagrantfile as an additional parameter: <kbd class="calibre12">config.vm.network "public_network", bridge: "en0: Wi-Fi (AirPort)"</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we looked at how to configure and manage networking in Vagrant. We focused on the three main types available: port-forwarding, private networking, and public networking. You should now be able to configure Vagrant to match your networking needs.</p>
<p class="calibre2">In <a target="_blank" href="part0183.html#5EGMU0-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 7</a>, <em class="calibre16">Multi-Machine</em>, we'll look at Vagrant's multi-machine feature. This cool feature allows us to configure and provision multiple Vagrant machines from one Vagrantfile config. We'll create a real-world scenario of having multiple Vagrant machines <span class="calibre6">–</span> one will act as a load balancer that distributes HTTP traffic between two Vagrant boxes and a web server.</p>


            </article>

            
        </section>
    </body></html>