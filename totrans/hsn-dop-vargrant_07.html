<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Multi-Machine</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, you will learn about Vagrant's multi-machine feature. We will walk through various aspects of multi-machine, and by the end of this chapter you should have a good understanding of the following topics:</p>
<ul class="calibre10">
<li class="calibre11">An introduction to Vagrant multi-machine</li>
<li class="calibre11">Multi-machine configuration in the Vagrantfile</li>
<li class="calibre11">Connecting multi-machines via networking</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">An introduction to Vagrant multi-machine</h1>
                
            
            <article>
                
<p class="calibre2">Using Vagrant's multi-machine feature, you can easily manage multiple Vagrant machines in one Vagrantfile. This can be useful if you wish to model your test environment in a similar way to your production environment. You can easily separate servers such as web servers, file servers, and database servers.</p>
<p class="calibre2">In this section, we will look at using multi-machine in the two following use cases:</p>
<ul class="calibre10">
<li class="calibre11">In the first use case, we will look at managing three Vagrant machines. Here, we will create a basic load balancing setup, where one machine will distribute traffic between two machines that serve up a website.</li>
<li class="calibre11">In the second use case, we will be managing two Vagrant machines. We will create a web-based machine that serves a website and another machine, which runs a MySQL database. The web machine will communicate with the database machine to display data on the web page.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Load balancing with Vagrant multi-machine</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we are going to be using nginx to act as an HTTP load balancer that will distribute traffic between two nginx web machines. We will be using the round robin method of load balancing, which evenly distributes incoming traffic.</p>
<p class="calibre2">First, let's set up our Vagrantfile to contain the three machines before installing nginx with the Ubuntu 16.04 64-bit OS.</p>
<p class="calibre2">To get started, let's create a minimal Vagrantfile by running the <kbd class="calibre12">vagrant init -m</kbd> command. After that, let's edit the Vagrantfile and create three config areas as follows:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>    # Configure load balancer machine<br class="title-page-name"/>     config.vm.define "lb1" do |lb1|<br class="title-page-name"/>    end<br class="title-page-name"/>    # Configure first web machine<br class="title-page-name"/>     config.vm.define "web1" do |web1|<br class="title-page-name"/>     end<br class="title-page-name"/>    # Configure second web machine<br class="title-page-name"/>     config.vm.define "web2" do |web2|<br class="title-page-name"/>    end<br class="title-page-name"/> end</pre>
<p class="calibre2">Our Vagrantfile should now have the main <kbd class="calibre12">|config|</kbd> block, which encapsulates all of the code and the three <kbd class="calibre12">define</kbd> blocks within that. Multi-machine is incredibly easy to set up in Vagrant; all you have to do is define a new machine and then configure that machine within the block.</p>
<p class="calibre2">When defining a new block you must give the new machine a name that will become its reference during configuration. The first machine I have set up is named <kbd class="calibre12">lb1</kbd>, which simply stands for load balancer 1. This convention can help when working with a large Vagrantfile and multiple machines; it can also be useful when working on a team where multiple developers are using and viewing a Vagrantfile.</p>
<p class="calibre2">To define a new machine, input the following two lines of code:</p>
<pre class="calibre17">config.vm.define "lb1" do |lb1|<br class="title-page-name"/> end</pre>
<p class="calibre2">This machine is now ready to configure! If we run <kbd class="calibre12">vagrant up</kbd>, nothing will happen because the box has no values – there is no box, networking, provisioning, or file handling defined.</p>
<p class="calibre2">Let's start configuring our load balancer machine by setting a box and an IP address. This can be done by accessing the <kbd class="calibre12">lb1</kbd> namespace within our config block, as follows:</p>
<pre class="calibre17">config.vm.define "lb1" do |lb1|<br class="title-page-name"/>     lb1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>     lb1.vm.network "private_network", ip: "10.0.0.10"<br class="title-page-name"/> end</pre>
<p class="calibre2">As you can see in the preceding example, we have set the <kbd class="calibre12">lb1.vm.box</kbd> and <kbd class="calibre12">lb1.vm.network</kbd> values. Let's now do this for our two web machines, but let's set a different IP address so we can access them separately and avoid conflicts, as follows:</p>
<pre class="calibre17"> config.vm.define "web1" do |web1|<br class="title-page-name"/>     web1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>     web1.vm.network "private_network", ip: "10.0.0.11"<br class="title-page-name"/> end<br class="title-page-name"/> config.vm.define "web2" do |web2|<br class="title-page-name"/>     web2.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>     web2.vm.network "private_network", ip: "10.0.0.12"<br class="title-page-name"/> end</pre>
<p class="calibre2">We now have three Vagrant machines configured, but before we can launch and test them, we need to provision them with nginx and configure nginx for our load balancing setup.</p>
<p class="calibre2">Let's create two shell scripts to provision our machines. (We will cover shell scripting in more depth in later chapters; we are using it here to help demonstrate how it works within a multi-machine environment.)</p>
<p class="calibre2">In the directory where your <kbd class="calibre12">Vagrantfile</kbd> is, create a <kbd class="calibre12">lb.sh</kbd> file and an <kbd class="calibre12">web.sh</kbd> file.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">lb.sh</h1>
                
            
            <article>
                
<p class="calibre2">Let's focus on the <kbd class="calibre12">lb.sh</kbd> file first. Add the following lines as the file's contents:</p>
<pre class="calibre17">#!/bin/bash<br class="title-page-name"/>echo 'Starting Provision: lb1'<br class="title-page-name"/> sudo apt-get update<br class="title-page-name"/> sudo apt-get install -y nginx<br class="title-page-name"/> sudo service nginx stop<br class="title-page-name"/> sudo rm -rf /etc/nginx/sites-enabled/default<br class="title-page-name"/> sudo touch /etc/nginx/sites-enabled/default<br class="title-page-name"/> echo "upstream testapp {<br class="title-page-name"/>     server 10.0.0.11;<br class="title-page-name"/>     server 10.0.0.12;<br class="title-page-name"/> }<br class="title-page-name"/>server {<br class="title-page-name"/>     listen 80 default_server;<br class="title-page-name"/>     listen [::]:80 default_server ipv6only=on;<br class="title-page-name"/>    root /usr/share/nginx/html;<br class="title-page-name"/>     index index.html index.htm;<br class="title-page-name"/>    # Make site accessible from http://localhost/<br class="title-page-name"/>     server_name localhost;<br class="title-page-name"/>    location / {<br class="title-page-name"/>         proxy_pass http://testapp;<br class="title-page-name"/>     }<br class="title-page-name"/>}" &gt;&gt; /etc/nginx/sites-enabled/default<br class="title-page-name"/> sudo service nginx start<br class="title-page-name"/> echo "Machine: lb1" &gt; /var/www/html/index.html<br class="title-page-name"/> echo 'Provision lb1 complete'</pre>
<p class="calibre2">There's quite a bit going on in the preceding snippet, so let's break it down.</p>
<p class="calibre2">In the first part, we are declaring the program location that should run this script (<kbd class="calibre12">bin</kbd>/<kbd class="calibre12">bash</kbd>) after the shebang (<kbd class="calibre12">#!</kbd>).</p>
<p class="calibre2">In lines 2-7, we are updating Ubuntu, installing nginx, and deleting the default nginx configuration file.</p>
<p class="calibre2">In lines 8-22, we are inserting a new config as the default nginx config, which essentially setes up the load balancing and sets our available web servers as <kbd class="calibre12">10.0.0.11</kbd> and <kbd class="calibre12">10.0.0.12</kbd>.</p>
<p class="calibre2">In lines 23-25, we are starting up the nginx service (which will read our new default config file and apply those settings), setting up the default index HTML file, and finishing the provision.</p>
<p class="calibre2">We <kbd class="calibre12">echo</kbd> out <kbd class="calibre12">Starting Provision: lb1</kbd> and <kbd class="calibre12">Provision lb1 complete</kbd> at both the beginning and end of the provision script. This is not necessary, but when you run the <kbd class="calibre12">vagrant up --provision</kbd> command you will see these echoed into the terminal, which can be useful when you are trying to understand what is happening and what stage of the provision process you are at.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">web.sh</h1>
                
            
            <article>
                
<p class="calibre2">Let's now create our <kbd class="calibre12">web.sh</kbd> bash script, which will handle the provisioning of our web servers. This script is much simpler than the load balancer script we created earlier, as follows:</p>
<pre class="calibre17">#!/bin/bash<br class="title-page-name"/>echo 'Starting Provision: web'$1<br class="title-page-name"/> sudo apt-get update<br class="title-page-name"/> sudo apt-get install -y nginx<br class="title-page-name"/> echo "&lt;h1&gt;Machine: web"$1 "&lt;/h1&gt;" &gt; /var/www/html/index.html<br class="title-page-name"/> echo 'Provision web'$1 'complete'</pre>
<p class="calibre2">Again, in the preceding snippet, we are echoing out the progress at the beginning and end of our provision progress. In lines 2-4 we are updating Ubuntu and installing nginx. In line 5 we are overwriting the default index HTML file with a basic title, which will help us differentiate between the two web servers.</p>
<p class="calibre2">In this script you will notice the use of <kbd class="calibre12">$1</kbd>. This is a variable in bash and references the first argument. Later on in this section you will learn how to pass an argument into the shell script, as this will help us differentiate between web server 1 and web server 2.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant multi-machine shell provisioning</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have our <kbd class="calibre12">lb.sh</kbd> and <kbd class="calibre12">web.sh</kbd> provisioning scripts set up, let's add them into our Vagrantfile so we're ready to set up and test our load balancing app.</p>
<p class="calibre2">The following code block is a finished copy of our Vagrantfile:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>    # Configure load balancer machine<br class="title-page-name"/>     config.vm.define "lb1" do |lb1|<br class="title-page-name"/>         lb1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         lb1.vm.network "private_network", ip: "10.0.0.10"<br class="title-page-name"/>         lb1.vm.provision :shell do |shell|<br class="title-page-name"/>             shell.path = "lb.sh"<br class="title-page-name"/>         end<br class="title-page-name"/>     end<br class="title-page-name"/>    # Configure first web machine<br class="title-page-name"/>     config.vm.define "web1" do |web1|<br class="title-page-name"/>         web1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         web1.vm.network "private_network", ip: "10.0.0.11"<br class="title-page-name"/>         web1.vm.provision :shell do |shell|<br class="title-page-name"/>             shell.args = "1"<br class="title-page-name"/>             shell.path = "web.sh"<br class="title-page-name"/>        end<br class="title-page-name"/>    end<br class="title-page-name"/>    # Configure second web machine<br class="title-page-name"/>     config.vm.define "web2" do |web2|<br class="title-page-name"/>         web2.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         web2.vm.network "private_network", ip: "10.0.0.12"<br class="title-page-name"/>         web2.vm.provision :shell do |shell|<br class="title-page-name"/>             shell.args = "2"<br class="title-page-name"/>             shell.path = "web.sh"<br class="title-page-name"/>        end<br class="title-page-name"/>     end<br class="title-page-name"/>end</pre>
<p class="calibre2">We can provision a box by using the <kbd class="calibre12">.vm.provision</kbd> namespace. In the preceding example, you can see that we are passing our arguments into <kbd class="calibre12">web1</kbd> and <kbd class="calibre12">web2</kbd> using the <kbd class="calibre12">shell.args</kbd> value. These will then be accessible inside our <kbd class="calibre12">web.sh</kbd> script.</p>
<p class="calibre2">Now, save your Vagrantfile and run the <kbd class="calibre12">vagrant up --provision</kbd> command to start running and provisioning the machines. You'll notice that the booting process takes much longer as there are now three machines to manage instead of the usual one.</p>
<p class="calibre2">During the booting process you should notice our echo statements at different points of the provisioning process, as shown in the following screenshots:</p>
<div class="cdpaligncenter"><img class="alignnone12" src="../images/00064.gif"/></div>
<div class="title-page-name"><span>In the preceding screenshot, you'll see the <kbd class="calibre12">lb1</kbd> provisioner has started. In the following screenshot you'll see that the <kbd class="calibre12">web2</kbd> provisioner has completed</span>:</div>
<div class="cdpaligncenter"><img src="../images/00065.jpeg" class="calibre68"/></div>
<p class="calibre2">When the Vagrant machines have finished booting, we can move on and test out the load balancer. To do this, we set the IP address for the load balancer to <kbd class="calibre12">10.0.0.10</kbd> and open it in a browser. You should see one of the web server machines, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00066.jpeg" class="calibre69"/></div>
<p class="calibre2">Now, if you refresh the page, the load balancer should send your request to the other web server machine, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00067.jpeg" class="calibre70"/></div>
<p class="calibre2">If you keep refreshing the page, you will be bounced between the two web servers. You can also go to one of the web machines directly be accessing them via their own IP addresses. If you visit <kbd class="calibre12">10.0.0.11</kbd> in your web browser, for example, you will only see the web server 1 machine, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00068.jpeg" class="calibre71"/></div>
<p class="calibre2">Congratulations! You have successfully configured a multi-machine Vagrant environment using a basic HTTP load balancing setup. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">multi-machine SSH</h1>
                
            
            <article>
                
<p class="calibre2">Now that your machines are up and running, you may want to SSH into them to make and test some changes. To do this, we can run the <kbd class="calibre12">vagrant ssh</kbd> command. This will give us an error, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00069.jpeg" class="calibre72"/></div>
<p class="calibre2">Here, we must specify a machine name, otherwise the <kbd class="calibre12">ssh</kbd> command won't know which machine we want to connect to. The names to supply are the ones we defined in the Vagrantfile, for example, <kbd class="calibre12">lb1</kbd>, <kbd class="calibre12">web1</kbd>, or <kbd class="calibre12">web2</kbd>. Let's now SSH into the load balancing machine by running the <kbd class="calibre12">vagrant ssh lb1</kbd> command, as follows:</p>
<div class="cdpaligncenter"><img src="../images/00070.jpeg" class="calibre73"/></div>
<p class="calibre2">You can now manage each machine individually via SSH.</p>
<p class="calibre2">Let's complete the machine life cycle by halting and destroying the machines. We can halt all three machines by running the <kbd class="calibre12">vagrant halt</kbd> command, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00071.jpeg" class="calibre74"/></div>
<p class="calibre2">Next, if you wish to do so, you can destroy your machines to free up system memory. Run the <kbd class="calibre12">vagrant destroy -f</kbd> command. In our example, we are using the <kbd class="calibre12">-f</kbd> flag to force the machines' destruction; otherwise, we will be prompted for confirmation for each machine. Run the following command:</p>
<div class="cdpaligncenter"><img src="../images/00072.jpeg" class="calibre75"/></div>
<p class="calibre2">As you can see in the preceding screenshot, the command tells Vagrant to loop through each machine and destroy them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Web server and database setup with Vagrant multi-machine</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will use Vagrant's multi-machine feature to create a traditional web server and database setup. We will install our web server (nginx and PHP) on one machine and our database server (MySQL) on another.</p>
<p class="calibre2">This setup is simpler than the one in the previous section, but it should still help to reinforce how to set up and manage Vagrant multi-machine.</p>
<p class="calibre2">First, let's create a new Vagrantfile in a new folder. We will create two machines to get started, as follows:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>    # Configure web server machine<br class="title-page-name"/>     config.vm.define "web1" do |web1|<br class="title-page-name"/>         web1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         web1.vm.network "private_network", ip: "10.0.0.50"<br class="title-page-name"/>         web1.vm.provision :shell do |shell|<br class="title-page-name"/>             shell.path = "web.sh"<br class="title-page-name"/>         end<br class="title-page-name"/>     end<br class="title-page-name"/>    # Configure database server machine<br class="title-page-name"/>     config.vm.define "db1" do |db1|<br class="title-page-name"/>         db1.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         db1.vm.network "private_network", ip: "10.0.0.51"<br class="title-page-name"/>         db1.vm.provision :shell do |shell|<br class="title-page-name"/>             shell.path = "db.sh"<br class="title-page-name"/>         end<br class="title-page-name"/>     end<br class="title-page-name"/>end</pre>
<p class="calibre2">Again, we will be using shell provisioning for these machines. We will be using the Ubuntu 16.04 box with private networking, and each machine will get its own private IP address.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">web.sh</h1>
                
            
            <article>
                
<p class="calibre2">Let's now create our web server provision script to install nginx and PHP. Inside the <kbd class="calibre12">web.sh</kbd> file, we input the following code:</p>
<pre class="calibre17">#!/bin/bash<br class="title-page-name"/>echo 'Starting Provision: web server'<br class="title-page-name"/> sudo apt-get update<br class="title-page-name"/> sudo apt-get install -y nginx<br class="title-page-name"/> touch /var/www/html/index.php<br class="title-page-name"/> sudo apt-get install -y php-fpm php-mysql<br class="title-page-name"/> echo 'Provision web server complete'</pre>
<p class="calibre2">We will need to log into the machine to make some configuration changes manually, but the preceding snippet will give us a good start.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">db.sh</h1>
                
            
            <article>
                
<p class="calibre2">We can now create our database server provision script to install MySQL. Inside the <kbd class="calibre12">db.sh</kbd> file, we input the following code:</p>
<pre class="calibre17">#!/bin/bash<br class="title-page-name"/>echo 'Starting Provision: database server'<br class="title-page-name"/> sudo apt-get update<br class="title-page-name"/> echo 'Provision database server complete'</pre>
<p class="calibre2">This stage will also require some manual configuration, which we can do by logging into the database machine.</p>
<p class="calibre2">Let's now start up our Vagrant machines by running the <kbd class="calibre12">vagrant up --provision</kbd> command. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Nginx and PHP configuration</h1>
                
            
            <article>
                
<p class="calibre2">Let's now configure Nginx and PHP on our web server machine. Log into the machine by running the <kbd class="calibre12">vagrant ssh web1</kbd> command.</p>
<p class="calibre2">Once logged in, we need to finish configuring nginx. This can be done by editing the default config file with the following command:</p>
<pre class="calibre17"><strong class="calibre1">sudo nano /etc/nginx/sites-available/default</strong></pre>
<p class="calibre2">We now need to add PHP into this file to allow nginx to handle PHP files and code. The first line we need to edit is the index file list, so find the following line:</p>
<pre class="calibre17">index index.html index.htm index.nginx-debian.html;</pre>
<p class="calibre2">Chanage it to this:</p>
<pre class="calibre17">index index.php index.html index.htm index.nginx-debian.html;</pre>
<p class="calibre2">The final change we need to perform is to add the PHP handling. This requires us to edit a block inside the main <kbd class="calibre12">server {}</kbd> block. The following snippet is the code we need to edit:</p>
<pre class="calibre17"> #location ~ \.php$ {<br class="title-page-name"/> #    include snippets/fastcgi-php.conf;<br class="title-page-name"/> #<br class="title-page-name"/> #    # With php7.0-cgi alone:<br class="title-page-name"/> #    fastcgi_pass 127.0.0.1:9000;<br class="title-page-name"/> #    # With php7.0-fpm:<br class="title-page-name"/> #    fastcgi_pass unix:/run/php/php7.0-fpm.sock;<br class="title-page-name"/> #}</pre>
<p class="calibre2">Change the preceding snippet to the following:</p>
<pre class="calibre17">location ~ \.php$ {<br class="title-page-name"/>     include snippets/fastcgi-php.conf;<br class="title-page-name"/>    # With php7.0-fpm:<br class="title-page-name"/>     fastcgi_pass unix:/run/php/php7.0-fpm.sock;<br class="title-page-name"/> }</pre>
<p class="calibre2">Now save and close the file. If you want to, you can use the <kbd class="calibre12">sudo nginx -t</kbd> command to test the code and syntax of the config file you have just edited. A successful message is as follows:</p>
<div class="cdpaligncenter"><img class="alignnone13" src="../images/00073.jpeg"/></div>
<p class="calibre2">Let's now restart nginx to apply the new settings; to do so, run the following command:</p>
<pre class="calibre17"><strong class="calibre1">sudo systemctl reload nginx</strong></pre>
<p class="calibre2">To confirm PHP has been installed and is working, create a <kbd class="calibre12">test.php</kbd> file within the <kbd class="calibre12">/var/www/html/</kbd> directory. Within the <kbd class="calibre12">test.php</kbd> file, add the following lines:</p>
<pre class="calibre17">&lt;?php<br class="title-page-name"/>phpinfo();<br class="title-page-name"/>?&gt;</pre>
<p class="calibre2">Save the file and in your web browser on your host machine, open <kbd class="calibre12">http://10.0.0.50/test.php</kbd> . You should now see the PHP info page, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img class="alignnone14" src="../images/00074.jpeg"/></div>
<p class="calibre2">While we're here, we should go back into the <kbd class="calibre12">test.php</kbd> file and edit its contents. So, we are now going to create a basic PHP script that connects to our MySQL database and retrieves some data. Edit the file to contain the following snippets:</p>
<pre class="calibre17">&lt;?php<br class="title-page-name"/>$conn = new mysqli("10.0.0.51", "external", "password", "VagrantDatabase");<br class="title-page-name"/>$result = $conn-&gt;query("SELECT VagrantText FROM VagrantTable WHERE VagrantId = 1");<br class="title-page-name"/>while($row = $result-&gt;fetch_assoc()) {<br class="title-page-name"/>     echo $row['VagrantText'];<br class="title-page-name"/> }<br class="title-page-name"/>?&gt;</pre>
<div class="packt_infobox">This is a very basic script to help get you started. This script is not secure and does not necessarily follow the PHP best practices. It would not be recommended to use this script in a production environment.</div>
<p class="calibre2">Before we can continue, we must set up the MySQL server on our other Vagrant machine; otherwise, the PHP script will fail as there is no database available.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">MySQL configuration</h1>
                
            
            <article>
                
<p class="calibre2">Let's finish our setup by installing and configuring the MySQL database. At the end of this section, you should see the final working code, as well as your web server accessing the database server via PHP.</p>
<div class="packt_infobox">It is not recommended to use this setup in a production environment. We are not following security best practices but are instead setting things up with basic configuration.</div>
<div class="title-page-name"><span>Follow these steps to configure the MySQL database:</span></div>
<ol class="calibre13">
<li value="1" class="calibre11">First, let's SSH into the database machine by running the <kbd class="calibre12">vagrant ssh db1</kbd> command.</li>
<li value="2" class="calibre11">Now install MySQL by running the following command: <kbd class="calibre12">run <span>sudo apt-get install mysql-server</span></kbd><span>.</span></li>
</ol>
<p class="calibre2">You'll now be asked to set a root password. This can be anything as we are not using this as a production environment. You will then be asked to repeat and confirm the root password.</p>
<p class="calibre2">You can now log into MySQL via the terminal by running <kbd class="calibre12">mysql -u root -p</kbd>. Enter the root password that you just set.</p>
<p class="calibre2">We must now create a basic MySQL user that has the correct privileges to access the database outside of the localhost address and network. Without this, we would not be able to access the database from the <kbd class="calibre12">web1</kbd> machine, so run the following commands:</p>
<pre class="calibre17"><strong class="calibre1">CREATE USER 'external'@'localhost' IDENTIFIED BY 'password';</strong><br class="title-page-name"/><strong class="calibre1">GRANT ALL PRIVILEGES ON *.* TO 'external'@'localhost' WITH GRANT OPTION;</strong><br class="title-page-name"/><strong class="calibre1">CREATE USER 'external'@'%' IDENTIFIED BY 'password';</strong><br class="title-page-name"/><strong class="calibre1">GRANT ALL PRIVILEGES ON *.* TO 'external'@'%' WITH GRANT OPTION;</strong><br class="title-page-name"/><strong class="calibre1">FLUSH PRIVILEGES;</strong></pre>
<p class="calibre2">We can now create a table and enter some test data, which will be accessed via PHP on the <kbd class="calibre12">web1</kbd> machine. Run the following commands to create a new database, a new table, and insert some data:</p>
<pre class="calibre17"><strong class="calibre1">CREATE DATABASE VagrantDatabase;</strong><br class="title-page-name"/><strong class="calibre1">USE VagrantDatabase;</strong><br class="title-page-name"/><strong class="calibre1">CREATE TABLE VagrantTable (VagrantId int, VagrantText varchar(255));</strong><br class="title-page-name"/><strong class="calibre1">INSERT INTO VagrantTable (VagrantId, VagrantText) VALUES (1, "This text is from MySQL");</strong></pre>
<p class="calibre2">You can now exit the MySQL CLI tool. We must now configure one last MySQL setting that will allow connections from our web1 machine. We need to edit the <kbd class="calibre12">mysqld.cnf</kbd> config file, which can be done by running the following command:</p>
<pre class="calibre17"><strong class="calibre1">sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf</strong></pre>
<p class="calibre2">Look for the following line:</p>
<pre class="calibre17">bind_address = 127.0.0.1 </pre>
<p class="calibre2">Change it to the following:</p>
<pre class="calibre17">bind_address = 0.0.0.0</pre>
<p class="calibre2">You can now save the file and run the following command. This will restart MySQL so it is using the new configuration:</p>
<pre class="calibre17"><strong class="calibre1">sudo service mysql restart</strong></pre>
<p class="calibre2">We can now exit the MySQL CLI and visit <kbd class="calibre12">http://10.0.0.50/test.php</kbd> to access our database, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img class="alignnone15" src="../images/00075.jpeg"/></div>
<p class="calibre2">Congratulations! You have successfully set up Vagrant multi-machine so it uses two machines as a web server and database architecture.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we learned about Vagrant's multi-machine feature and created two use cases: load balancing with three machines and a web server and database architecture with two machines.</p>
<p class="calibre2">In <span class="calibre6"><a target="_blank" href="part0196.html#5QTE80-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 8</a>,</span> <em class="calibre16"><span class="calibre6">Exploring Vagrant Plugins and Syncing Files</span></em>, we will learn about Vagrant plugins and how to sync files between a host machine and a Vagrant guest machine.</p>


            </article>

            
        </section>
    </body></html>