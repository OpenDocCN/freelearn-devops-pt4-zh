- en: Multi-Machine
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn about Vagrant''s multi-machine feature. We
    will walk through various aspects of multi-machine, and by the end of this chapter
    you should have a good understanding of the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: An introduction to Vagrant multi-machine
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Multi-machine configuration in the Vagrantfile
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Connecting multi-machines via networking
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An introduction to Vagrant multi-machine
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Using Vagrant's multi-machine feature, you can easily manage multiple Vagrant
    machines in one Vagrantfile. This can be useful if you wish to model your test
    environment in a similar way to your production environment. You can easily separate
    servers such as web servers, file servers, and database servers.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this section, we will look at using multi-machine in the two following use
    cases:'
  prefs: []
  type: TYPE_NORMAL
- en: In the first use case, we will look at managing three Vagrant machines. Here,
    we will create a basic load balancing setup, where one machine will distribute
    traffic between two machines that serve up a website.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In the second use case, we will be managing two Vagrant machines. We will create
    a web-based machine that serves a website and another machine, which runs a MySQL
    database. The web machine will communicate with the database machine to display
    data on the web page.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Load balancing with Vagrant multi-machine
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we are going to be using nginx to act as an HTTP load balancer
    that will distribute traffic between two nginx web machines. We will be using
    the round robin method of load balancing, which evenly distributes incoming traffic.
  prefs: []
  type: TYPE_NORMAL
- en: First, let's set up our Vagrantfile to contain the three machines before installing
    nginx with the Ubuntu 16.04 64-bit OS.
  prefs: []
  type: TYPE_NORMAL
- en: 'To get started, let''s create a minimal Vagrantfile by running the `vagrant
    init -m` command. After that, let''s edit the Vagrantfile and create three config
    areas as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Our Vagrantfile should now have the main `|config|` block, which encapsulates
    all of the code and the three `define` blocks within that. Multi-machine is incredibly
    easy to set up in Vagrant; all you have to do is define a new machine and then
    configure that machine within the block.
  prefs: []
  type: TYPE_NORMAL
- en: When defining a new block you must give the new machine a name that will become
    its reference during configuration. The first machine I have set up is named `lb1`,
    which simply stands for load balancer 1\. This convention can help when working
    with a large Vagrantfile and multiple machines; it can also be useful when working
    on a team where multiple developers are using and viewing a Vagrantfile.
  prefs: []
  type: TYPE_NORMAL
- en: 'To define a new machine, input the following two lines of code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: This machine is now ready to configure! If we run `vagrant up`, nothing will
    happen because the box has no values – there is no box, networking, provisioning,
    or file handling defined.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s start configuring our load balancer machine by setting a box and an
    IP address. This can be done by accessing the `lb1` namespace within our config
    block, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'As you can see in the preceding example, we have set the `lb1.vm.box` and `lb1.vm.network`
    values. Let''s now do this for our two web machines, but let''s set a different
    IP address so we can access them separately and avoid conflicts, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: We now have three Vagrant machines configured, but before we can launch and
    test them, we need to provision them with nginx and configure nginx for our load
    balancing setup.
  prefs: []
  type: TYPE_NORMAL
- en: Let's create two shell scripts to provision our machines. (We will cover shell
    scripting in more depth in later chapters; we are using it here to help demonstrate
    how it works within a multi-machine environment.)
  prefs: []
  type: TYPE_NORMAL
- en: In the directory where your `Vagrantfile` is, create a `lb.sh` file and an `web.sh`
    file.
  prefs: []
  type: TYPE_NORMAL
- en: lb.sh
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s focus on the `lb.sh` file first. Add the following lines as the file''s
    contents:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: There's quite a bit going on in the preceding snippet, so let's break it down.
  prefs: []
  type: TYPE_NORMAL
- en: In the first part, we are declaring the program location that should run this
    script (`bin`/`bash`) after the shebang (`#!`).
  prefs: []
  type: TYPE_NORMAL
- en: In lines 2-7, we are updating Ubuntu, installing nginx, and deleting the default
    nginx configuration file.
  prefs: []
  type: TYPE_NORMAL
- en: In lines 8-22, we are inserting a new config as the default nginx config, which
    essentially setes up the load balancing and sets our available web servers as
    `10.0.0.11` and `10.0.0.12`.
  prefs: []
  type: TYPE_NORMAL
- en: In lines 23-25, we are starting up the nginx service (which will read our new
    default config file and apply those settings), setting up the default index HTML
    file, and finishing the provision.
  prefs: []
  type: TYPE_NORMAL
- en: 'We `echo` out `Starting Provision: lb1` and `Provision lb1 complete` at both
    the beginning and end of the provision script. This is not necessary, but when
    you run the `vagrant up --provision` command you will see these echoed into the
    terminal, which can be useful when you are trying to understand what is happening
    and what stage of the provision process you are at.'
  prefs: []
  type: TYPE_NORMAL
- en: web.sh
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s now create our `web.sh` bash script, which will handle the provisioning
    of our web servers. This script is much simpler than the load balancer script
    we created earlier, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Again, in the preceding snippet, we are echoing out the progress at the beginning
    and end of our provision progress. In lines 2-4 we are updating Ubuntu and installing
    nginx. In line 5 we are overwriting the default index HTML file with a basic title,
    which will help us differentiate between the two web servers.
  prefs: []
  type: TYPE_NORMAL
- en: In this script you will notice the use of `$1`. This is a variable in bash and
    references the first argument. Later on in this section you will learn how to
    pass an argument into the shell script, as this will help us differentiate between
    web server 1 and web server 2.
  prefs: []
  type: TYPE_NORMAL
- en: Vagrant multi-machine shell provisioning
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that we have our `lb.sh` and `web.sh` provisioning scripts set up, let's
    add them into our Vagrantfile so we're ready to set up and test our load balancing
    app.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following code block is a finished copy of our Vagrantfile:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: We can provision a box by using the `.vm.provision` namespace. In the preceding
    example, you can see that we are passing our arguments into `web1` and `web2`
    using the `shell.args` value. These will then be accessible inside our `web.sh`
    script.
  prefs: []
  type: TYPE_NORMAL
- en: Now, save your Vagrantfile and run the `vagrant up --provision` command to start
    running and provisioning the machines. You'll notice that the booting process
    takes much longer as there are now three machines to manage instead of the usual
    one.
  prefs: []
  type: TYPE_NORMAL
- en: 'During the booting process you should notice our echo statements at different
    points of the provisioning process, as shown in the following screenshots:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00064.gif)'
  prefs: []
  type: TYPE_IMG
- en: 'In the preceding screenshot, you''ll see the `lb1` provisioner has started.
    In the following screenshot you''ll see that the `web2` provisioner has completed:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00065.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'When the Vagrant machines have finished booting, we can move on and test out
    the load balancer. To do this, we set the IP address for the load balancer to
    `10.0.0.10` and open it in a browser. You should see one of the web server machines,
    as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00066.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'Now, if you refresh the page, the load balancer should send your request to
    the other web server machine, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00067.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'If you keep refreshing the page, you will be bounced between the two web servers.
    You can also go to one of the web machines directly be accessing them via their
    own IP addresses. If you visit `10.0.0.11` in your web browser, for example, you
    will only see the web server 1 machine, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00068.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Congratulations! You have successfully configured a multi-machine Vagrant environment
    using a basic HTTP load balancing setup.
  prefs: []
  type: TYPE_NORMAL
- en: multi-machine SSH
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that your machines are up and running, you may want to SSH into them to
    make and test some changes. To do this, we can run the `vagrant ssh` command.
    This will give us an error, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00069.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'Here, we must specify a machine name, otherwise the `ssh` command won''t know
    which machine we want to connect to. The names to supply are the ones we defined
    in the Vagrantfile, for example, `lb1`, `web1`, or `web2`. Let''s now SSH into
    the load balancing machine by running the `vagrant ssh lb1` command, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00070.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: You can now manage each machine individually via SSH.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s complete the machine life cycle by halting and destroying the machines.
    We can halt all three machines by running the `vagrant halt` command, as shown
    in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00071.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'Next, if you wish to do so, you can destroy your machines to free up system
    memory. Run the `vagrant destroy -f` command. In our example, we are using the
    `-f` flag to force the machines'' destruction; otherwise, we will be prompted
    for confirmation for each machine. Run the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00072.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: As you can see in the preceding screenshot, the command tells Vagrant to loop
    through each machine and destroy them.
  prefs: []
  type: TYPE_NORMAL
- en: Web server and database setup with Vagrant multi-machine
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we will use Vagrant's multi-machine feature to create a traditional
    web server and database setup. We will install our web server (nginx and PHP)
    on one machine and our database server (MySQL) on another.
  prefs: []
  type: TYPE_NORMAL
- en: This setup is simpler than the one in the previous section, but it should still
    help to reinforce how to set up and manage Vagrant multi-machine.
  prefs: []
  type: TYPE_NORMAL
- en: 'First, let''s create a new Vagrantfile in a new folder. We will create two
    machines to get started, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: Again, we will be using shell provisioning for these machines. We will be using
    the Ubuntu 16.04 box with private networking, and each machine will get its own
    private IP address.
  prefs: []
  type: TYPE_NORMAL
- en: web.sh
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Let''s now create our web server provision script to install nginx and PHP.
    Inside the `web.sh` file, we input the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: We will need to log into the machine to make some configuration changes manually,
    but the preceding snippet will give us a good start.
  prefs: []
  type: TYPE_NORMAL
- en: db.sh
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We can now create our database server provision script to install MySQL. Inside
    the `db.sh` file, we input the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: This stage will also require some manual configuration, which we can do by logging
    into the database machine.
  prefs: []
  type: TYPE_NORMAL
- en: Let's now start up our Vagrant machines by running the `vagrant up --provision`
    command.
  prefs: []
  type: TYPE_NORMAL
- en: Nginx and PHP configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let's now configure Nginx and PHP on our web server machine. Log into the machine
    by running the `vagrant ssh web1` command.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once logged in, we need to finish configuring nginx. This can be done by editing
    the default config file with the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'We now need to add PHP into this file to allow nginx to handle PHP files and
    code. The first line we need to edit is the index file list, so find the following
    line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Chanage it to this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'The final change we need to perform is to add the PHP handling. This requires
    us to edit a block inside the main `server {}` block. The following snippet is
    the code we need to edit:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Change the preceding snippet to the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Now save and close the file. If you want to, you can use the `sudo nginx -t`
    command to test the code and syntax of the config file you have just edited. A
    successful message is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00073.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'Let''s now restart nginx to apply the new settings; to do so, run the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'To confirm PHP has been installed and is working, create a `test.php` file
    within the `/var/www/html/` directory. Within the `test.php` file, add the following
    lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'Save the file and in your web browser on your host machine, open `http://10.0.0.50/test.php`
    . You should now see the PHP info page, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00074.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'While we''re here, we should go back into the `test.php` file and edit its
    contents. So, we are now going to create a basic PHP script that connects to our
    MySQL database and retrieves some data. Edit the file to contain the following
    snippets:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: This is a very basic script to help get you started. This script is not secure
    and does not necessarily follow the PHP best practices. It would not be recommended
    to use this script in a production environment.
  prefs: []
  type: TYPE_NORMAL
- en: Before we can continue, we must set up the MySQL server on our other Vagrant
    machine; otherwise, the PHP script will fail as there is no database available.
  prefs: []
  type: TYPE_NORMAL
- en: MySQL configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let's finish our setup by installing and configuring the MySQL database. At
    the end of this section, you should see the final working code, as well as your
    web server accessing the database server via PHP.
  prefs: []
  type: TYPE_NORMAL
- en: It is not recommended to use this setup in a production environment. We are
    not following security best practices but are instead setting things up with basic
    configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 'Follow these steps to configure the MySQL database:'
  prefs: []
  type: TYPE_NORMAL
- en: First, let's SSH into the database machine by running the `vagrant ssh db1`
    command.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Now install MySQL by running the following command: `run sudo apt-get install
    mysql-server`.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You'll now be asked to set a root password. This can be anything as we are not
    using this as a production environment. You will then be asked to repeat and confirm
    the root password.
  prefs: []
  type: TYPE_NORMAL
- en: You can now log into MySQL via the terminal by running `mysql -u root -p`. Enter
    the root password that you just set.
  prefs: []
  type: TYPE_NORMAL
- en: 'We must now create a basic MySQL user that has the correct privileges to access
    the database outside of the localhost address and network. Without this, we would
    not be able to access the database from the `web1` machine, so run the following
    commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'We can now create a table and enter some test data, which will be accessed
    via PHP on the `web1` machine. Run the following commands to create a new database,
    a new table, and insert some data:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'You can now exit the MySQL CLI tool. We must now configure one last MySQL setting
    that will allow connections from our web1 machine. We need to edit the `mysqld.cnf`
    config file, which can be done by running the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'Look for the following line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'Change it to the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'You can now save the file and run the following command. This will restart
    MySQL so it is using the new configuration:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'We can now exit the MySQL CLI and visit `http://10.0.0.50/test.php` to access
    our database, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/00075.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Congratulations! You have successfully set up Vagrant multi-machine so it uses
    two machines as a web server and database architecture.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we learned about Vagrant''s multi-machine feature and created
    two use cases: load balancing with three machines and a web server and database
    architecture with two machines.'
  prefs: []
  type: TYPE_NORMAL
- en: In [Chapter 8](part0196.html#5QTE80-d86fec2f29de42f086efd11bc5538d9c), *Exploring
    Vagrant Plugins and Syncing Files*, we will learn about Vagrant plugins and how
    to sync files between a host machine and a Vagrant guest machine.
  prefs: []
  type: TYPE_NORMAL
