<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Shell Scripts - Provisioning</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we are going to look at Vagrant provisioning. We will focus on basic concepts and also on shell-script provisioning. By the end of this chapter, you will have a good understanding of:</p>
<ul class="calibre10">
<li class="calibre11">Vagrant provisioning</li>
<li class="calibre11">Understanding configuration management</li>
<li class="calibre11">Vagrant provisioning with a file</li>
<li class="calibre11">Vagrant shell provisioning</li>
<li class="calibre11">Vagrant inline scripts, external scripts, and script arguments</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introduction to Vagrant provisioning</h1>
                
            
            <article>
                
<p class="calibre2">The idea of provisioning within Vagrant is to create a script that prepares and installs software onto the Vagrant machine. Provisioning can be done inline in the Vagrantfile using a shell provisioner or external file. Provisioning happens during the <em class="calibre16">vagrant up</em> process as the machine is being created.</p>
<p class="calibre2">When provisioning a Vagrant machine, there are a number of options:</p>
<ul class="calibre10">
<li class="calibre11">Install software</li>
<li class="calibre11">Alter configurations</li>
<li class="calibre11">Operating-system-level changes</li>
<li class="calibre11">System settings</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding configuration management</h1>
                
            
            <article>
                
<p class="calibre2">In later chapters, we will learn more about using configuration-management tools with Vagrant for provisioning. While talking about Vagrant provisioning, this will be a good introduction to configuration management.</p>
<p class="calibre2">Configuration-management tools include Chef, Ansible, and Salt. We will be focusing on these three tools. Configuration management is essentially another word for provisioning and is used to set a machine to a desired state <span class="calibre6">–</span> this could be installing software or configuring certain settings.</p>
<p class="calibre2">Configuration-management tools often have a special file type or syntax that is used. We will be focusing on the following software:</p>
<ul class="calibre10">
<li class="calibre11"><strong class="calibre1">Ansible</strong> (uses playbooks)</li>
<li class="calibre11"><strong class="calibre1">Chef</strong> (uses cookbooks)</li>
<li class="calibre11"><strong class="calibre1">Docker</strong> (uses images)</li>
<li class="calibre11"><strong class="calibre1">Puppet</strong> (uses manifests)</li>
<li class="calibre11"><strong class="calibre1">Salt</strong> (uses states)</li>
</ul>
<p class="calibre2">Configuration management is often used when a more powerful and flexible option is needed in your development and deployment process. A benefit of using configuration-management tools is the separation of concerns. Essentially, you don't rely on Vagrant to handle too much during the process in case you have any issues or you want the flexibility of being able to change which configuration-management tool you use. This could be a company decision due to budget or security.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Basic usage of Vagrant provisioning</h1>
                
            
            <article>
                
<p class="calibre2">To get started with provisioning our Vagrant machine, let's create a new Vagrantfile. We can do this by running the <kbd class="calibre12">vagrant init -m</kbd> command.</p>
<p class="calibre2">Within our Vagrantfile, we can define a provisioning block by using the <kbd class="calibre12">config.vm.provision</kbd> code and pass in a value to declare what type of provisioner we will be using. In the following example, we will be using the shell type:</p>
<pre class="calibre17">config.vm.provision "shell"</pre>
<p class="calibre2">Using the shell provisioner, you can then define additional values inline:</p>
<pre class="calibre17">config.vm.provision "shell", inline "sudo apt-get update -y"</pre>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">Or use a configuration block, where we define our shell value within pipe characters:</p>
<pre class="calibre17">config.vm.provision "shell" do |shell|<br class="title-page-name"/>     shell.inline = "sudo apt-get update -y"<br class="title-page-name"/> end</pre>
<p class="calibre2">Both options would, in this example, update the system packages. Using the configuration block method is much easier to read, as each value can have its own line.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant provisioning commands</h1>
                
            
            <article>
                
<p class="calibre2">Once you've created your provisioner values, it's time to apply those changes to your Vagrant machine. There are a few options:</p>
<ul class="calibre10">
<li class="calibre11"><span>When you run the </span><kbd class="calibre12">vagrant up</kbd><span> command for the first time, your machine will read the Vagrantfile and run the provisioner script. </span></li>
<li class="calibre11">If you have a machine that has been halted or you want to force a provision, you can run <kbd class="calibre12">vagrant up --provision</kbd> to enable provisioning.</li>
<li class="calibre11">You can also use the <kbd class="calibre12">--no-provision</kbd> flag to disable provisioning.</li>
<li class="calibre11">Within the provision the config block, you can set a key of <kbd class="calibre12">run</kbd> and a value of <kbd class="calibre12">always</kbd>, which will force the provisioner script to run every time a machine is started up. An example of this would be <kbd class="calibre12">config.vm.provision "shell", inline: "sudo apt-get update -y", run: "always"</kbd>.</li>
</ul>
<p class="calibre2">The final option will only work if the <kbd class="calibre12">--no-provision</kbd> flag has not been set.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant provisioning with a file</h1>
                
            
            <article>
                
<p class="calibre2">The Vagrant file option gives you an easy way to copy a file from your host machine onto the Vagrant machine during the startup process.</p>
<p class="calibre2">This can be a great way of uploading a configuration file that would otherwise need to be created by the software or possibly required before the software can start working. An example of this would be an <kbd class="calibre12">.env</kbd> file that holds environment variables, such as database-connection details or special keys.</p>
<p class="calibre2">There are two options available <span class="calibre6">–</span> you can copy/upload a single file or an entire directory from your host machine to the guest Vagrant machine.</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">When using this option, we set the provision option to <kbd class="calibre12">file</kbd> in our Vagrantfile, for example:</p>
<pre class="calibre17">config.vm.provision "file"</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Single file</h1>
                
            
            <article>
                
<p class="calibre2">Uploading a file from the host machine to the guest machine is quick and easy. We just need to set the provision type as <kbd class="calibre12">file</kbd>, the source as the file on our host, and the destination as:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>     config.vm.provision "file", source: "secret.env", destination: "secret.env"<br class="title-page-name"/> end</pre>
<p class="calibre2">This will copy our <kbd class="calibre12">secret.env</kbd> file into the home folder of our Vagrant guest machine.</p>
<p class="calibre2">If that <kbd class="calibre12">secret.env</kbd> file does not exist, Vagrant will throw an error during the startup process:</p>
<p class="cdpaligncenter1"><img class="alignnone33" src="../images/00094.jpeg"/></p>
<p class="calibre2">If the file does exist, then you will see something similar to the following in your console during the startup process:</p>
<p class="cdpaligncenter1"><img class="alignnone34" src="../images/00095.jpeg"/></p>
<p class="calibre2">And after running the <kbd class="calibre12">vagrant ssh</kbd> command and connecting to the guest machine, we can run the <kbd class="calibre12">ls</kbd> command to list the files within the directory. We will now see the <kbd class="calibre12">secret.env</kbd> file:</p>
<p class="cdpaligncenter1"><img class="alignnone35" src="../images/00096.jpeg"/></p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Directory</h1>
                
            
            <article>
                
<p class="calibre2">Another option is to upload a directory of files and folders from your host machine into your guest machine. This can be useful if you require multiple assets, such as images or configuration files, in a separate and managed way.</p>
<p class="calibre2">It's very similar to the file option when adding this option into our Vagrantfile:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>     config.vm.provision "file", source: "secretfolder", destination: "$HOME/newsecretfolder"<br class="title-page-name"/> end</pre>
<p class="calibre2">We set our source value to be a folder within the current Vagrant directory. You can specify an absolute path if the folder is located elsewhere on your host system.</p>
<p class="calibre2">The destination folder can use the <kbd class="calibre12">$HOME</kbd> variable to create the new folder in the home folder of our guest machine. This folder can have the same name or a new name on the guest machine. It depends on your requirements.</p>
<p class="calibre2">We can run the <kbd class="calibre12">vagrant up --provision</kbd> command to start up the Vagrant machine. We will see the message again in the output during the process:</p>
<p class="cdpaligncenter1"><img class="alignnone34" src="../images/00097.jpeg"/></p>
<p class="calibre2">Once the machine is up-and-running, we can run the <kbd class="calibre12">vagrant ssh</kbd> command machine and run the <kbd class="calibre12">ls</kbd> command. We will then see the folder in the home directory. If we run the <kbd class="calibre12">ls newsecretfolder/</kbd> command to view the contents of our new folder, we will see the <kbd class="calibre12">secret.env</kbd> file:</p>
<p class="cdpaligncenter1"><img class="alignnone36" src="../images/00098.jpeg"/></p>
<div class="packt_infobox">Please note<strong class="calibre76">:</strong> When using this option compared to the synced folder featured, any changes made on the host/local machine will not be reflected on the guest machine.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Vagrant Shell provisioner</h1>
                
            
            <article>
                
<p class="calibre2">We've seen how to use a basic shell provisioner, but depending on your setup and required environment, you may have quite a large, complex provisioner script. This script may require arguments or environment variables, or may be linked to an external resource hosted elsewhere.</p>
<p class="calibre2">In this section, we will look at the many options available when using shell as a Vagrant provisioner. This is often used by beginners but can be very powerful and flexible, especially if you do not want to set up configuration-management tools such as Chef and Ansible.</p>
<p class="calibre2">When using the shell provisioner, there are optional configuration settings available:</p>
<ul class="calibre10">
<li class="calibre11"><strong class="calibre1">args</strong>: These are arguments that you specify for use by the provisioning script. This can be a string or an array of values.</li>
<li class="calibre11"><strong class="calibre1">env</strong>: This is a list of key-value pairs (hash) as environment variables to the script.</li>
<li class="calibre11"><strong class="calibre1">binary</strong>: Vagrant by default replaces Windows line endings with Unix line endings, unless you change this value to true.</li>
<li class="calibre11"><strong class="calibre1">privileged</strong>: This allows you to change whether the script will be run by a privileged user, such as <kbd class="calibre12">sudo</kbd>. The default value is true.</li>
<li class="calibre11"><strong class="calibre1">upload_path</strong>: This is the path on the guest machine that the script will be uploaded to. The SSH user account must have access to write to that folder/file location, otherwise this will fail.</li>
<li class="calibre11"><strong class="calibre1">keep_color</strong>: Vagrant currently outputs success messages in green and error messages in red. If you change this value to false, this behavior will be stopped.</li>
<li class="calibre11"><strong class="calibre1">name</strong>: This can be used to identify the provisioner output if there are many different provisioners running in the process.</li>
<li class="calibre11"><strong class="calibre1">powershell_args</strong>: These are arguments that can be passed to the provisioner if you are using PowerShell on Windows.</li>
<li class="calibre11"><strong class="calibre1">powershell_elevated_interactive</strong>: This is used when trying to elevate a script in interactive mode on Windows. You must enable auto-login on Windows and the user must be logged in for this to work.</li>
<li class="calibre11"><strong class="calibre1">md5</strong>: The MD5 value (checksum) is used to verify downloaded shell files.</li>
<li class="calibre11"><strong class="calibre1">sha1</strong>: The SHA1 value (checksum) is used to verify downloaded shell files.</li>
<li class="calibre11"><strong class="calibre1">sensitive</strong>: If you specify values in the <kbd class="calibre12">env</kbd> option, it will mark these as sensitive and not show them in the output.</li>
</ul>
<p class="calibre2">We'll focus on inline scripts, external scrips, and script arguments.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Inline Scripts</h1>
                
            
            <article>
                
<p class="calibre2">We've briefly touched upon inline scripts, but there are more options available that can be added into the configuration for provisioning.</p>
<p class="calibre2">You can run a script inline using the following syntax:</p>
<pre class="calibre17">config.vm.provision "shell", inline: "sudo apt-get update -y &amp;&amp; echo updating finished"</pre>
<p class="calibre2">Or you could create a variable outside the block and use that variable for a cleaner and easier-to-read format:</p>
<pre class="calibre17">$shellscript = &lt;&lt;-SCRIPT<br class="title-page-name"/> sudo apt-get update -y<br class="title-page-name"/> echo updating finished<br class="title-page-name"/> SCRIPT<br class="title-page-name"/><br class="title-page-name"/>config.vm.provision "shell", inline: $shellscript</pre>
<p class="calibre2">You can experiment with both options and see what works best for you. You may find that, when working on a development team, they already have a syntax you must follow when creating and editing Vagrantfiles.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">External scripts</h1>
                
            
            <article>
                
<p class="calibre2">Another option when using shell provisioning is to use external scripts. This can be a good way to keep your script separate, which means it's easier to manage and helps keep your Vagrantfile tidy.</p>
<p class="calibre2">To use an external script, we can use the following syntax:</p>
<pre class="calibre17">config.vm.provision "shell", path: "[FILELOCATION]"</pre>
<p class="calibre2">In the preceding example, the <kbd class="calibre12">"[FILELOCATION]"</kbd> placeholder could be one of two different options:</p>
<ul class="calibre10">
<li class="calibre11">A local script on your machine; an example value would be <kbd class="calibre12">script.sh</kbd></li>
<li class="calibre11">A remote script hosted externally; an example value would be <kbd class="calibre12">https://example.com/dev/script.sh</kbd></li>
</ul>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">One benefit of using a remote script is that anyone who is using that Vagrantfile to run a specific machine configuration will always get the most up-to-date version. If you are on a team of developers and a change is made to the provisioner script, all of the other developers just need to run the <kbd class="calibre12">vagrant up --provision</kbd> command and will then be using the same machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Script arguments</h1>
                
            
            <article>
                
<p class="calibre2">Another great feature of shell provisioning is the option of using arguments. These are values that can be passed in as variables and can be easier to manage when data is dynamic.</p>
<p class="calibre2">Script arguments can be passed in as a string or as an array. A string is useful when only one argument is required and an array is useful when multiple arguments are required.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Script argument – string</h1>
                
            
            <article>
                
<p class="calibre2">The following is a syntax example when using a string script argument in your Vagrantfile:</p>
<pre class="calibre17">config.vm.provision :shell do |shell|<br class="title-page-name"/>     shell.inline = "echo $1"<br class="title-page-name"/>     shell.args = "'this is a test'"<br class="title-page-name"/> end</pre>
<p class="calibre2">When the <em class="calibre16">vagrant up</em> process hits the provisioning stage, we will see an output echoed onto the screen with a value of <kbd class="calibre12">this is a test</kbd>:</p>
<p class="cdpaligncenter1"><img class="alignnone37" src="../images/00099.jpeg"/></p>
<div class="packt_infobox">Please note: You must remember to properly escape your string. In this case, we are wrapping the string within single quotes. The system would essentially see the 'this is a test' echo, which would not throw any errors.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Script argument – array</h1>
                
            
            <article>
                
<p class="calibre2">Here is the syntax example when using an array script argument in your Vagrantfile:</p>
<pre class="calibre17">config.vm.provision :shell do |shell|<br class="title-page-name"/>     shell.inline = "echo $1 $2"<br class="title-page-name"/>     shell.args = ["this is", "a test"]<br class="title-page-name"/> end</pre>
<p class="calibre2">Similarly to the string argument option, when this provisioner is started within the <em class="calibre16">vagrant up</em> process, we will see an output echoed on the screen with a value of <kbd class="calibre12">this is a test</kbd>:</p>
<p class="cdpaligncenter1"><img class="alignnone38" src="../images/00100.jpeg"/></p>
<div class="packt_infobox">Please note: It's not necessary to quote the individual values in the array. It is still recommended you escape any special characters to minimize any errors.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we learned about Vagrant provisioning and configuration management. We provisioned a Vagrant machine using the basic usage type, file type, and shell type using inline and external scripts with arguments.</p>
<p class="calibre2">In <a target="_blank" href="part0230.html#6RB1C0-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 10</a>, <em class="calibre16">Ansible - Using Ansible to Provision a Vagrant Box</em>, we will learn more about the Ansible configuration-management tool, and use that to provision a Vagrant machine. We will learn how to use Ansible and Ansible playbooks, including the syntax.</p>


            </article>

            
        </section>
    </body></html>