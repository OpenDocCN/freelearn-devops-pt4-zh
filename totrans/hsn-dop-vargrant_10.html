<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Ansible - Using Ansible to Provision a Vagrant Box</h1>
                
            
            <article>
                
<p class="calibre2">In the second part in our provisioning series, we will be learning about Ansible and how to use it to provision a Vagrant machine. The following are the topics we're going to cover in this chapter:</p>
<ul class="calibre10">
<li class="calibre11">Understanding Ansible</li>
<li class="calibre11">Installing Ansible on macOS</li>
<li class="calibre11">Provisioning Vagrant using Ansible on the host machine</li>
<li class="calibre11">Provisioning Vagrant using Ansible on the guest machine</li>
<li class="calibre11">Ansible Playbooks</li>
</ul>
<p class="calibre2">By the end of this chapter, you will feel confident using Ansible to provision Vagrant machines. You will have a good understanding of how Ansible works and will have links to Vagrant, and will be able to use Ansible on both the host machine and Vagrant machine by using Playbooks to configure exactly what you need.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding Ansible</h1>
                
            
            <article>
                
<p class="calibre2">Ansible is an open source piece of software used to make <em class="calibre16">IT automation simple</em> and offers <em class="calibre16">automation for everyone</em>. Ansible is a tool used for configuration management, software provisioning, and application deployment. It's a powerful tool that offers many features. These features include the following:</p>
<ul class="calibre10">
<li class="calibre11">It can run locally on the host or guest machine</li>
<li class="calibre11">It has an extensive plugin ecosystem</li>
<li class="calibre11">It can orchestrate infrastructure using many cloud providers</li>
<li class="calibre11">It can be installed on many different operating systems</li>
<li class="calibre11">It has simple inventory management</li>
</ul>
<ul class="calibre10">
<li class="calibre11">It has simple and powerful automation with Playbooks</li>
<li class="calibre11">Well-written and extensive documentation</li>
</ul>
<p class="calibre2">Ansible offers a minimal approach to provisioning your software with an easy to learn syntax and is built to be reliable and secure. We'll learn more about Ansible as we work through this chapter by installing it, creating and testing Playbooks, and provisioning a Vagrant machine.</p>
<p class="calibre2">Some more interesting facts about Ansible are that it is part of Red Hat, it is written in Python and PowerShell, its first release was in February 2012, and there is a web-based interface called Ansible Tower that can be used to make managing Ansible even easier.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Installing Ansible</h1>
                
            
            <article>
                
<p class="calibre2">In this first part, we will learn how to install Ansible on our host machine, which in this instance is the macOS. Later in this chapter, we will learn how to install Ansible on Ubuntu, which will be running inside our guest Vagrant machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Installing Ansible on macOS High Sierra (version 10.13)</h1>
                
            
            <article>
                
<p class="calibre2">Before we can start provisioning our Vagrant machine using Ansible, we first need to install it on our host machine. We won't look at any advanced installations <span class="calibre6">– </span>just the basics to get Ansible up and running on our machine. If you are using another operating system, then please feel free to use the excellent Ansible docs available at <a href="https://docs.ansible.com/" class="calibre9">https://docs.ansible.com/</a>:</p>
<ol class="calibre13">
<li value="1" class="calibre11">We first need to visit the <span>Installation Guide</span> page at <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" class="calibre9">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</a>.</li>
<li value="2" class="calibre11">There is a list of supported operating systems, but we need to click on the <span>Latest Releases on macOS</span> section.</li>
<li value="3" class="calibre11">Here, we will see that the preferred option is to install Ansible via <kbd class="calibre12">pip</kbd>.</li>
<li value="4" class="calibre11">You can check to see whether you have pip installed by running <kbd class="calibre12">pip -v</kbd>:</li>
</ol>
<p class="cdpaligncenter1"><img class="cdpalignleft2" src="../images/00101.jpeg"/></p>
<ol start="5" class="calibre13">
<li value="5" class="calibre11">If you do not have it installed, then you can run the <kbd class="calibre12">sudo easy_install pip</kbd> command:</li>
</ol>
<p class="cdpaligncenter1"><img class="alignnone39" src="../images/00102.jpeg"/><br class="calibre5"/>
<br class="calibre5"/>
You'll need to enter your system password as the command requires <kbd class="calibre12">sudo</kbd>.</p>
<ol start="6" class="calibre13">
<li value="6" class="calibre11">You can now install Ansible by running the <kbd class="calibre12">sudo pip install ansible</kbd> command:</li>
</ol>
<p class="cdpaligncenter2"><img class="alignnone40" src="../images/00103.jpeg"/><br class="calibre5"/>
<br class="calibre5"/>
Again, you will need to enter your system password as the command requires <kbd class="calibre12">sudo</kbd>.</p>
<ol start="7" class="calibre13">
<li value="7" class="calibre11">Finally, we can check that Ansible has been successfully installed by running the <kbd class="calibre12">ansible --version</kbd> command:</li>
</ol>
<p class="cdpaligncenter1"><img class="alignnone41" src="../images/00104.jpeg"/></p>
<p class="calibre56">You can see that I have the latest version installed: 2.6.3.</p>
<p class="calibre2">Congratulations <span class="calibre6">– y</span>ou have successfully installed Ansible! We can now start to configure and provision our Vagrant machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning Vagrant using Ansible</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will look at two different ways of provisioning Vagrant with Ansible. The first will involve running Ansible on our host (macOS) machine and the second will involve running Ansible on our guest (Ubuntu) machine running inside Vagrant.</p>
<div class="packt_infobox"><strong class="calibre76">Please Note:</strong> We will be using the ubuntu/xenial64 box and the version number is <kbd class="calibre62">virtualbox, 20180510.0.0</kbd>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning Vagrant using Ansible on the host machine</h1>
                
            
            <article>
                
<p class="calibre2">Let's set up a basic Vagrant environment and provision it using Ansible from our host machine. We'll learn how to configure Ansible in the Vagrantfile and install software into our Vagrant guest machine running Ubuntu:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Let's create a new Vagrantfile in a new directory to start afresh. We can run the <kbd class="calibre12">vagrant init -m</kbd> command to do this.</li>
<li value="2" class="calibre11">In our Vagrant file, we'll set the box as Ubuntu by adding in the <kbd class="calibre12">config.vm.box = "ubuntu/xenial64"</kbd> line and also the networking line:</li>
</ol>
<pre class="calibre59">config.vm.network "private_network", ip: "10.10.10.10"</pre>
<ol start="3" class="calibre13">
<li value="3" class="calibre11">We can now create a <kbd class="calibre12">provision</kbd> block:</li>
</ol>
<pre class="calibre59">  config.vm.provision "shell", inline: "sudo apt-get update; sudo ln -sf /usr/bin/python3 /usr/bin/python"   <br class="title-page-name"/>  config.vm.provision "ansible" do |ans|    ans.playbook = "vagrant_playbook.yml"<br class="title-page-name"/> end</pre>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">Save the Vagrant file and exit your text editor.</li>
</ol>
<p class="calibre2">If you now run the <kbd class="calibre12">vagrant up --provision</kbd> command, you will see an error during the final provisioning stage:</p>
<p class="cdpaligncenter1"><span class="calibre6"><img class="alignnone42" src="../images/00105.jpeg"/><br class="calibre5"/></span></p>
<p class="calibre2">This is because Ansible and Vagrant cannot find the playbook <kbd class="calibre12">vagrant_playbook.yml</kbd>. In the same directory as your Vagrantfile, we will now create our playbook file.</p>
<p class="calibre2">Add in the following code (we'll go through this later so that you know exactly what it does):</p>
<pre class="calibre17">---<br class="title-page-name"/> -<br class="title-page-name"/>  hosts: all<br class="title-page-name"/>  sudo: true<br class="title-page-name"/>  tasks:<br class="title-page-name"/>   -<br class="title-page-name"/>    apt: "name=nginx state=latest"<br class="title-page-name"/>    name: "ensure nginx is at the latest version"<br class="title-page-name"/>   -<br class="title-page-name"/>    name: "start nginx"<br class="title-page-name"/>    service:<br class="title-page-name"/>     name: nginx<br class="title-page-name"/>     state: started</pre>
<div class="packt_infobox">Please note: The Playbook file is very strict with regards to its formatting and syntax. You may only use spaces and not tabs in the YAML file. If you have any issues, try removing all spaces and adding natural indent spaces (1 space for top level, 2 spaces for child, and so on). You can use a YAML code/syntax validator tool online (T<span class="calibre77">his is the website/tool that I used: </span><a href="http://www.yamllint.com/" target="_blank" class="calibre78">http://www.yamllint.com</a>).<br class="calibre79"/>
This markup will install the latest version of Nginx onto the Vagrant machine. It will then start the Nginx service so that it will be up and running, ready to use. You may need to run the <kbd class="calibre62">vagrant destroy -f</kbd> command first if you already have a machine running.</div>
<p class="calibre2">Run the <kbd class="calibre12">vagrant up --provision</kbd> command to start the startup process and get Ansible running. You'll see a lot of new coloured output at the provisioning stage, and this will be Ansible installing and configuring Nginx.</p>
<p class="calibre2">The provisioner will start running <kbd class="calibre12">ansible_local</kbd> as we specified in the Vagrantfile:</p>
<p class="cdpaligncenter1"><img class="alignnone43" src="../images/00106.jpeg"/></p>
<p class="calibre2">It will then run the ansible-playbook handler:</p>
<p class="cdpaligncenter1"><img src="../images/00107.jpeg" class="calibre80"/></p>
<p class="cdpalignleft3">Finally, you will see an overview of what Ansible has done (or sometimes not done, which results in a red failure). We can see here that the green <kbd class="calibre12">ok=3</kbd> value means that 3 items have been run successfully, and the yellow <kbd class="calibre12">changed=1</kbd> value means that one item has been changed successfully:</p>
<p class="cdpaligncenter1"><span class="calibre6"><img class="alignnone44" src="../images/00108.jpeg"/><br class="calibre5"/></span></p>
<p class="calibre2">We should now be able to access our Vagrant machine using the IP address of <kbd class="calibre12">10.10.10.10</kbd> as we set the networking config in the Vagrantfile.</p>
<p class="calibre2">Open up your browser to that IP address and you should see the default Nginx welcome screen:</p>
<p class="cdpaligncenter1"><img class="alignnone45" src="../images/00109.jpeg"/></p>
<p class="calibre2">Congratulations! You have successfully installed Nginx using Ansible to provision Vagrant from your host machine. We covered quite a lot here, but in the next section we will learn more about playbooks.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning Vagrant using Ansible on the guest machine</h1>
                
            
            <article>
                
<p class="calibre2">Now that we've successfully provisioned our Vagrant machine and installed the Nginx service using the host method, we can learn how to provision Vagrant using Ansible on the guest (Vagrant) machine.</p>
<p class="calibre2">This method is much simpler as it allows everything to be done within the guest machine. You do not require any additional software on your host machine. Vagrant will intelligently try and install Ansible on the guest machine if it cannot be found or accessed.</p>
<p class="calibre2">The following steps are similar to the previous steps, but we'll be adding some additional configuration into our Vagrantfile:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Run the <kbd class="calibre12">vagrant init -m</kbd> command to create a new Vagrantfile (you may need to clear our the current directory or use a new, empty directory if you have followed the previous steps).</li>
<li value="2" class="calibre11">In our Vagrant file, we'll set the box to be Ubuntu by adding in the<span> </span><kbd class="calibre12">config.vm.box = "ubuntu/xenial64"</kbd> line and also the networking line:</li>
</ol>
<pre class="calibre59"> <span>config.vm.network "private_network", ip: "10.10.10.10"</span></pre>
<ol start="3" class="calibre13">
<li value="3" class="calibre11">We can now create a <kbd class="calibre12">provision</kbd> block:</li>
</ol>
<pre class="calibre59"> config.vm.provision "ansible_local" do |ans|<br class="title-page-name"/>       ans.playbook = "vagrant_playbook.yml"<br class="title-page-name"/>       ans.install = true<br class="title-page-name"/>       ans.install_mode = "pip"<br class="title-page-name"/> end</pre>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">Save the Vagrantfile and run the <kbd class="calibre12">vagrant up --provision</kbd> command to get the Vagrant machine up and running.</li>
</ol>
<p class="calibre2">We'll see a similar process here until Vagrant gets to the provisioning stage. Our guest machine does not have Ansible installed, so it will start to install it. We can see the <kbd class="calibre12">ansible_local</kbd> provisioner being used here:</p>
<p class="cdpaligncenter1"><img class="alignnone46" src="../images/00110.jpeg"/></p>
<p class="calibre2">Since we stated that the install mode would be <kbd class="calibre12">pip</kbd> in our Vagrantfile, the pip package manager will now be installed onto our guest machine:</p>
<p class="cdpaligncenter1"><img class="alignnone47" src="../images/00111.jpeg"/></p>
<p class="calibre2">The Vagrant provisioner will now find and run the Ansible Playbook:</p>
<p class="cdpaligncenter1"><img class="alignnone48" src="../images/00112.jpeg"/></p>
<p class="calibre2">Ansible will now run within the guest machine to install the contents of the Playbook. We can see in the following screenshot that Nginx was installed and started successfully, and that we had no failed elements:</p>
<p class="cdpaligncenter1"><img class="alignnone49" src="../images/00113.jpeg"/></p>
<p class="calibre2">We can now visit <kbd class="calibre12">10.10.10.10</kbd> in our web browser and see the Nginx default page. This will confirm that Nginx has been installed successfully and that the service is running:</p>
<p class="cdpaligncenter1"><img class="alignnone50" src="../images/00114.jpeg"/></p>
<p class="calibre2"><span class="calibre6">Let's now SSH into the Vagrant guest machine by running the</span> <kbd class="calibre12">vagrant ssh</kbd> <span class="calibre6">command. Once connected, we can run the</span> <kbd class="calibre12">ansible --version</kbd> <span class="calibre6">command to confirm that Ansible has been installed on our guest system:</span></p>
<p class="cdpaligncenter1"><img class="alignnone51" src="../images/00115.jpeg"/></p>
<p class="calibre2">We can see that the Ansible version that has been installed is 2.6.3. Within our Vagrantfile, we have used some additional Ansible values, which we will learn more about in the next section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Additional Ansible options</h1>
                
            
            <article>
                
<p class="calibre2">Vagrant supports additional options when using Ansible and Ansible local as a provisioner. These options allow you to add extra functionality and customization to the provisioning process.</p>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioner – Ansible</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we'll look at what additional options can be used with the Ansible provisioner:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">ask_become_pass</kbd>: When set to true (boolean), it will prompt for a password when using the become <kbd class="calibre12">sudo</kbd> option in Ansible.</li>
<li class="calibre11"><kbd class="calibre12">ask_sudo_pass</kbd><span>: This is essentially ask_become_pass, but will be phased out in future versions of Vagrant. It's used for backward compatibility.</span></li>
<li class="calibre11"><kbd class="calibre12">ask_vault_pass</kbd> <span>: When set to true (boolean), it will force Ansible to prompt for a vault password. Ansible Vault is used to keep sensitive data and passwords encrypted so that you don't have to worry about them being visible in plain text in a Playbook.</span></li>
<li class="calibre11"><kbd class="calibre12">force_remote_user</kbd><span>: This will require Vagrant to set the <kbd class="calibre12">ansible_ssh_user</kbd> in the inventory. Ansible will use the <kbd class="calibre12">config.ssh.username</kbd> value from the Vagrantfile instead of using the <kbd class="calibre12">remote_user</kbd> parameters in the Ansible Playbook.</span></li>
<li class="calibre11"><kbd class="calibre12">host_key_checking</kbd><span>: This option will require Ansible to enable SSH host key checking.</span></li>
<li class="calibre11"><kbd class="calibre12">raw_ssh_args</kbd><span>: This option can be used in order to apply a list of OpenSSH client options. The value is typically an array of strings.</span></li>
</ul>
<div class="packt_infobox">Please note: It's worth checking out the official Vagrant and Ansible documentation for more in-depth explanations of these options and to find out whether there is anything that you may require but are not quite sure of the name or how it's applied.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioner – Ansible local</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we'll look at what additional options can be used with the Ansible local Provisioner:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">install</kbd>: This option is enabled by default and will attempt to install Ansible on the guest system if it cannot be found/run. </li>
<li class="calibre11"><kbd class="calibre12">install_mode</kbd><span>: This option allows you to choose how Ansible is to be installed on the guest system. You can choose default, <kbd class="calibre12">pip</kbd>, or <kbd class="calibre12">pip_args_only</kbd>. The default option will attempt to use the guest operating system's package manager. The pip option will use the Python package manager. The <kbd class="calibre12">pip_args_only</kbd> option works similarly to the pip option, but does not allow Vagrant to automatically set pip options. </span></li>
</ul>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">pip_args</kbd><span>: This option is used when the <kbd class="calibre12">install_mode</kbd> is set to use pip. It allows you to pass pip arguments into the command line.</span></li>
<li class="calibre11"><kbd class="calibre12">provisioning_path</kbd><span>: This is a path to the directory where Ansible files are stored. Commands such as <kbd class="calibre12">ansible-playbook</kbd> are run from this location.</span></li>
<li class="calibre11"><kbd class="calibre12">tmp_path</kbd><span>: This is an absolute path on the guest machine where files can be stored temporarily by the Ansible local provisioner.</span></li>
</ul>
<div class="packt_infobox">Please note:<span class="calibre77"> It's worth checking out the official Vagrant and Ansible documentation for more in-depth explanations for these options and to find out whether there is anything that you may require but are not quite sure of the name or how it's applied.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Ansible Playbooks</h1>
                
            
            <article>
                
<p class="calibre2">An Ansible Playbook is a configuration file used by Ansible. You can think of it as a Vagrantfile for Vagrant. It uses the YAML (Yet Another Markup Language) markup language as the syntax and is easily readable:</p>
<pre class="calibre17">---<br class="title-page-name"/> - hosts: all<br class="title-page-name"/>     sudo: yes<br class="title-page-name"/>     tasks:<br class="title-page-name"/>         - name: ensure nginx is at the latest version<br class="title-page-name"/>             apt: name=nginx state=latest<br class="title-page-name"/>         - name: start nginx<br class="title-page-name"/>             service:<br class="title-page-name"/>                 name: nginx<br class="title-page-name"/>                 state: started</pre>
<p class="calibre2">Let's look at the example playbook we created in the previous section, shown here in the above code block, and dissect it to get a better understanding of what it all means:</p>
<ul class="calibre10">
<li class="calibre11">The first line is always three dashes to signify the beginning of the file.</li>
<li class="calibre11">We must then define which hosts this applies to. These can often be defined in the Ansible inventory file by setting a value such as [db] and supplying an IP address for that node.</li>
<li class="calibre11">We then set the <kbd class="calibre12">sudo</kbd> value to <kbd class="calibre12">yes</kbd> as we require sudo/root privileges to install Nginx on the Vagrant guest machine.</li>
<li class="calibre11">We then move into the tasks section, which is what we want Ansible to do <span>–</span> the provisioning stage. We'll separate each task with a name section. This describes what we want the task to do, for example, <kbd class="calibre12">start nginx</kbd>.</li>
</ul>
<p class="calibre2"/>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11">Within a task, we can define the actions. In our first one called <kbd class="calibre12">apt</kbd>, we are calling the package manager (apt-get) to install the latest version of the Nginx package.</li>
<li class="calibre11">We then move to our final task which makes sure the <span>Nginx </span>service has been started.</li>
</ul>
<p class="calibre2">I hope you can see from this example that Ansible Playbooks are very easy to read and work down in a logical flow. You'll come across much more complex Playbooks and some similar ones compared to this example, but always follow the indentation within each block to get a better understanding of what each section does.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we learned how to provision Vagrant using Ansible on the host and guest machine. We've also learned what Ansible is and about Ansible Playbooks. If you use Ansible in your company, then I would recommend trying it with Vagrant to help with your development workflow.</p>
<p class="calibre2">In <a target="_blank" href="part0257.html#7L30I0-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 12</a>, <em class="calibre16">Docker - Using Docker with Vagrant</em>, we will be continuing our series on provisioning by learning about Chef and how to use that configuration management tool to provision Vagrant. We will look at multiple Chef options (solo and client) and learn about Chef cookbooks.</p>


            </article>

            
        </section>
    </body></html>