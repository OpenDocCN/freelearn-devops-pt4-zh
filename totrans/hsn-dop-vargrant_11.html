<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Chef - Using Chef to Provision a Vagrant Box</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will continue our series on provisioning Vagrant by using popular DevOps configuration management tools. We will be focusing on Chef and will cover the following topics:</p>
<ul class="calibre10">
<li class="calibre11">Understanding Chef</li>
<li class="calibre11">Chef Cookbook</li>
<li class="calibre11">Installing Chef on macOS</li>
<li class="calibre11">Using Chef Solo to provision a Vagrant machine</li>
<li class="calibre11">Using Chef Client to provision a Vagrant machine</li>
</ul>
<p class="calibre2">At the end of this chapter, you will have a good understanding of what Chef is and the components that make it work. You will feel confident in using Chef to provision a Vagrant machine, whether that be on the host or on the Vagrant machine itself. You'll understand how to create a Cookbook, which can be a very powerful and flexible tool, so that you can manage your machine's state.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding Chef</h1>
                
            
            <article>
                
<p class="calibre2">Chef is a popular configuration management tool used to configure and maintain servers. It was created by the company named Chef and is written in Ruby and Erlang. It was initially released in January 2009 and is offered in two different versions <span class="calibre6">–</span> free (open source) and paid (enterprise).</p>
<p class="calibre2">Chef supports and integrates with many cloud platforms such as Amazon EC2, OpenStack, Rackspace, and Microsoft Azure. Chef can be run in solo mode (no dependencies) or in client/server mode, where the client communicates with the server and sends information about the node that it's installed on.</p>
<p class="calibre2">Chef uses Cookbooks and recipes as part of its configuration, which we will focus on in the next section. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Chef Cookbook</h1>
                
            
            <article>
                
<p class="calibre2">Chef uses Cookbooks as a key element in its processes and they are used to describe the desired state of your node/server. </p>
<p class="calibre2">A Chef Cookbook is an important part of configuring machines when using Chef. It describes the desired state of the machine. This is similar to using Playbooks in Ansible. The Chef Cookbook contains five key elements, which all have their own part to play:</p>
<ul class="calibre10">
<li class="calibre11">Recipes</li>
<li class="calibre11">Templates</li>
<li class="calibre11">Attribute values</li>
<li class="calibre11">Extensions</li>
<li class="calibre11">File distributors</li>
</ul>
<p class="calibre2">These elements are often pieces of metadata that work together to create an overview of the machine. Let's dive deeper into these five elements to learn more about them.</p>
<div class="packt_infobox">When speaking about a node, we are referring to a machine <span class="calibre77">–</span> whether physical or virtual. The node could be a computer, server, network device, or another machine.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Recipes</h1>
                
            
            <article>
                
<p class="calibre2">A recipe is a key part of the Cookbook. It's used to detail what exactly should happen with a node. It's similar to a Vagrantfile when setting the state for a Vagrant virtual machine. </p>
<p class="calibre2">The recipe is written in Ruby and must be added onto the node's run list, which will then allow the node to run that recipe. A Cookbook can use one or more recipes or rely on outside recipes, too.</p>
<p class="calibre2">A recipe's main aim is to manage resources. A resource could be a software package, service, users, groups, files, directories, cron jobs, and more.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Templates</h1>
                
            
            <article>
                
<p class="calibre2">Templates are a specific type of file that includes embedded Ruby. These files use the <kbd class="calibre12">.erb</kbd> extension and can be used to create dynamic configuration files.</p>
<p class="calibre2">These files can access attribute values (which you will learn about in the next section). This is like using variables in the files and not having to hard-code the settings. You could have multiple templates referencing the same attribute and, when one changes, it will change the value in all of the template files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Attribute values</h1>
                
            
            <article>
                
<p class="calibre2">Attribute values in Chef are essentially settings. They are often displayed as key value pairs. These settings can be used inside the Cookbook.</p>
<p class="calibre2">Attributes are set in the <kbd class="calibre12">attributes</kbd> subdirectory of the Cookbook and can then be referenced in other parts of the Cookbook. Attributes can be set at the top (Cookbook) level but can also be overwritten at the node level by any node-specific settings/attributes.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Extensions</h1>
                
            
            <article>
                
<p class="calibre2">These are simply extensions to Chef such as libraries and custom resources. These can also be referred to as <em class="calibre16">tools</em>, which you can learn more about in the <em class="calibre16">Chef Supermarket</em> section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">File distributors</h1>
                
            
            <article>
                
<p class="calibre2">Static files are used to contain simple configurations. They are placed within the file's subdirectory and are often moved onto the node by a recipe. These files are likely to not be changed and can be thought of as simple, non-dynamic templates.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Chef Supermarket</h1>
                
            
            <article>
                
<p class="calibre2">If you are looking for a specific Cookbook/piece of software, then you can use the Chef Supermarket. You can think of the Chef Supermarket like HashiCorp's Vagrant Cloud. It hosts Cookbooks for you to view and download. The Supermarket is easy to use and offers a simple, fast user interface. Their main feature is the easy-to-use search facility.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Search</h1>
                
            
            <article>
                
<p class="calibre2">If you are looking for a specific Cookbook or just want to see what's available, then you can use the powerful search function. It offers a full text search and a filter to help narrow down the results. You can use the search by visiting the Chef Supermarket home page via the following link: <a href="https://supermarket.chef.io/" class="calibre9">https://supermarket.chef.io/</a>:</p>
<p class="cdpaligncenter1"><img src="../images/00116.jpeg" class="calibre81"/></p>
<p class="calibre2">In the preceding screenshot, you can see the <kbd class="calibre12">Search</kbd> feature. You can search for specific software packages such as nginx, or something more general to see what is available, such as <kbd class="calibre12">web server</kbd>.</p>
<p class="calibre2">There are two options when narrowing down your search. The first option is that you can use the <span class="calibre6">Advanced Options</span> search option, which can be found underneath the search bar, to the right:</p>
<p class="cdpaligncenter1"><img class="alignnone52" src="../images/00117.jpeg"/></p>
<p class="calibre2">In the preceding screenshot, you see the <span class="calibre6">Advanced Options</span> expanded menu, which allows you to filter the search by <span class="calibre6">Badges</span> and/or <span class="calibre6">Selected Supported Platforms</span>. You can also use the text search bar at the bottom to search for a specific platform if it's not available in the list.</p>
<p class="calibre2">There is currently only one <span class="calibre6">Badge</span> option available, which is <span class="calibre6">partner</span>. This option searches for Chef partner Cookbooks, which are Cookbooks that have been hand-picked by the Chef engineering team or created by them. We'll look at the other filter option here:</p>
<p class="cdpaligncenter1"><img class="alignnone53" src="../images/00118.jpeg"/></p>
<p class="calibre2">To the left of the search bar, you can select the type you wish to search. There are currently two options <span class="calibre6">– </span><span class="calibre6">Cookbooks</span> and <span class="calibre6">Tools</span>. The default is Cookbooks, and this will search through the available Cookbooks. The Tools option will search through the Chef tools that are available. Tools are pieces of software that can be used alongside Chef <span class="calibre6">–</span> these are not plugins as such, but add-ons:</p>
<p class="cdpaligncenter1"><img class="alignnone54" src="../images/00119.jpeg"/></p>
<p class="calibre2"/>
<p class="calibre2">In the preceding screenshot, we are searching for <kbd class="calibre12">nginx</kbd>, which is the web server. You can see that it has found 43 Cookbooks and you have the option to sort by <span class="calibre6">Most Followed</span> and <span class="calibre6">Recently Updated</span>. You will see some important information such as the Cookbook version, last update date/time, supported platform, code to install, and follower count.</p>
<p class="calibre2">You can click on the Cookbook name (in this case, <kbd class="calibre12">nginx</kbd>) to get more information about the Cookbook:</p>
<p class="cdpaligncenter1"><img src="../images/00120.jpeg" class="calibre30"/></p>
<p class="calibre2">In the preceding screenshot, you can see the Cookbook page. It includes more information, which includes the Cookbook creator/maintainer(s) and gives a detailed readme file. There are other bits of information such as dependencies, change log, installation instructions/options, and more.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning Vagrant with Chef</h1>
                
            
            <article>
                
<p class="calibre2">There are four different ways to use Chef to provision a Vagrant machine that Vagrant supports. This means that Chef has the most options in Vagrant when it comes to provisioning. The four options are as follows:</p>
<ul class="calibre10">
<li class="calibre11">Chef Solo</li>
<li class="calibre11">Chef Zero</li>
<li class="calibre11">Chef Client</li>
<li class="calibre11">Chef Apply</li>
</ul>
<p class="calibre2">In this chapter, we will be focusing on Chef Solo and Chef Client. This will give you a good mixture of provisioning on the host machine and the Vagrant machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Installing Chef on macOS</h1>
                
            
            <article>
                
<p class="calibre2">Before we can begin using Chef, we will first need to install it. We'll learn how to install Chef on the macOS operating system (the High Sierra 10.13 version).</p>
<p class="calibre2">We'll be installing the Chef DK (development kit), which includes all of the dependencies, utilities, and the main Chef software. The list of installed software includes the following:</p>
<ul class="calibre10">
<li class="calibre11">Chef client</li>
<li class="calibre11">OpenSSL</li>
<li class="calibre11">Embedded Ruby</li>
<li class="calibre11">RubyGems</li>
<li class="calibre11">Command-line utilites</li>
<li class="calibre11">Key value stores</li>
<li class="calibre11">Parsers</li>
<li class="calibre11">Utilities</li>
<li class="calibre11">Libraries</li>
<li class="calibre11">Community tools such as Kitchen and ChefSpec</li>
</ul>
<div class="packt_infobox">Please Note: The Apple XCode software package is required before you are able to install Chef.</div>
<p class="calibre2">Let's now install and test Chef on our system:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Go to the Chef DK downloads page (the following is a link to the macOS section: <a href="https://downloads.chef.io/chefdk#mac_os_x" class="calibre9">https://downloads.chef.io/chefdk#mac_os_x</a>).</li>
<li class="cdpalignleft1" value="2">Find the version you are currently running on your system and click the orange <span>Download</span> button, as follows:</li>
</ol>
<p class="cdpaligncenter1"><img src="../images/00121.jpeg" class="calibre82"/></p>
<ol start="3" class="calibre13">
<li value="3" class="calibre11">Run the <kbd class="calibre12">.dmg</kbd> file installer. You'll need to first run the installer file. Click on the <kbd class="calibre12">.pkg</kbd> file to run it.</li>
<li value="4" class="calibre11">The installer will run and you'll be prompted to move through the six steps. Please follow these. We will not be changing any values during this installation:</li>
</ol>
<p class="cdpaligncenter1"><img src="../images/00122.jpeg" class="calibre83"/></p>
<ol start="5" class="calibre13">
<li value="5" class="calibre11">Once complete, you should see the <em class="calibre18">green tick</em> success screen. Close this window by clicking on the <span>Close</span> button. This will then allow you to move the installer package into the trash.</li>
<li value="6" class="calibre11">To confirm that Chef has been installed, open a terminal window and run the <kbd class="calibre12">chef -v</kbd> command, which should list the Chef version and other dependencies:</li>
</ol>
<p class="cdpaligncenter1"><img src="../images/00123.jpeg" class="calibre30"/><span class="calibre6"><br class="calibre5"/></span></p>
<p class="calibre2">As you can see, there are many pieces of software running with Chef. There is the DK version, the chef-client version, the kitchen version, and more. Knowing these versions can come in handy if you have to debug any issues (with specific pieces of software) in the future.</p>
<p class="calibre2">Congratulations! You now have Chef installed on your system. Let's now look at provisioning a Vagrant machine using Chef.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using Chef Solo to provision a Vagrant machine</h1>
                
            
            <article>
                
<p class="calibre2">Similar to previous chapters, we will stick with our example of installing the nginx web server on our Vagrant machine. Although this is a simple example, it does allow us to use a popular piece of software and configure networking, and is a simple way of seeing if it was a success.</p>
<p class="calibre2">Using Chef Solo as a provisioner for Vagrant is a quick and easy way to get started with Chef. It has no dependencies (apart from Chef itself) and can be used by beginners or advanced users.</p>
<p class="calibre2">We'll first need to create our Vagrantfile by running the <kbd class="calibre12">vagrant init -m</kbd> command. </p>
<p class="calibre2">Inside our Vagrantfile, let's specify the box and networking for the IP address. Let's also specify our provisioner and configure chef-solo while we are inside the Vagrantfile. Your finished file should look like the following:</p>
<pre class="calibre17">Vagrant.configure("2") do |config|<br class="title-page-name"/>     config.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>     config.vm.network "private_network", ip: "10.10.10.10"<br class="title-page-name"/>     config.vm.provision "chef_solo" do |ch|<br class="title-page-name"/>         ch.add_recipe "nginx"<br class="title-page-name"/>     end<br class="title-page-name"/> end</pre>
<p class="calibre2">We have set <kbd class="calibre12">config.vm.provision</kbd> to <kbd class="calibre12">chef_solo</kbd> and within this block we are setting the <kbd class="calibre12">add_recipe</kbd> value to <kbd class="calibre12">nginx</kbd>. This means that we are telling Vagrant to specifically use the <kbd class="calibre12">nginx</kbd> recipe. Vagrant will look inside the <kbd class="calibre12">cookbooks</kbd> folder, which is in the root of our project (where the Vagrantfile is).</p>
<p class="calibre2">Before we can run the Vagrant machine, we need to do some Chef groundwork. Here, we are going to create the <kbd class="calibre12">nginx</kbd> recipe. We'll use the official nginx Cookbook from the Chef Supermarket, which can be found  via the following link: <a href="https://supermarket.chef.io/cookbooks/nginx" class="calibre9">https://supermarket.chef.io/cookbooks/nginx</a>. </p>
<p class="calibre2">Be default, Vagrant will look for a <kbd class="calibre12">cookbooks</kbd> directory inside the project root (where the Vagrantfile is located). Let's first create this folder on our host by running the <kbd class="calibre12">mkdir cookbooks</kbd> command. Let's now move into this directory by running the <kbd class="calibre12">cd cookbooks</kbd> command in our terminal.</p>
<p class="calibre2">To satisfy the supermarket command, we'll need a local git repository. Let's create a basic repository and commit to get started. Run the following commands to achieve the minimum requirements:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">git init</kbd></li>
<li class="calibre11"><kbd class="calibre12">touch null</kbd></li>
<li class="calibre11"><kbd class="calibre12">git add -A</kbd></li>
<li class="calibre11"><kbd class="calibre12">git commit -m 'null'</kbd></li>
</ul>
<p class="calibre2">Let's install this recipe using the <kbd class="calibre12">knife</kbd> command-line utility that we installed earlier. On the supermarket page, we can see two commands. Let's run the <kbd class="calibre12">install</kbd> command:</p>
<pre class="calibre17">knife supermarket install nginx --cookbook-path .</pre>
<p class="calibre2">This should install the <kbd class="calibre12">nginx</kbd> Cookbook (folder) into your Cookbooks <kbd class="calibre12">directory</kbd>. We can confirm this by running the <kbd class="calibre12">ls</kbd> and <kbd class="calibre12">ls cookbooks</kbd> commands inside our project directory:</p>
<p class="cdpaligncenter1"><img src="../images/00124.jpeg" class="calibre30"/></p>
<p class="calibre2">Let's now run the <kbd class="calibre12">vagrant up --provision</kbd> command (back in the root directory, not in the Cookbooks directory) to start and provision the Vagrant machine. During the provision stage, you should see the <kbd class="calibre12">Running chef-solo...</kbd> message, which means that the provisioner has started. You will now see lots of green output, which is Chef starting up, installing the dependencies, and running the nginx Cookbook. The <kbd class="calibre12">nginx</kbd> service (once installed) should start running automatically:</p>
<p class="cdpaligncenter1"><img src="../images/00125.jpeg" class="calibre84"/></p>
<p class="calibre2">If you now visit <a href="http://10.10.10.10" class="calibre9"><kbd class="calibre85">http://10.10.10.10</kbd></a> in your browser, you should see nginx's default page:</p>
<p class="cdpaligncenter1"><img src="../images/00126.jpeg" class="calibre86"/></p>
<p class="calibre2">Congratulations! You have successfully installed nginx onto a Vagrant machine using the Chef Solo provisioner.</p>
<div class="packt_infobox">This was a simple example of using Chef Solo with Vagrant. Please do not be fooled into thinking this technique isn't powerful. You can experiment with far more complicated Cookbooks.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using Chef Client to provision a Vagrant machine</h1>
                
            
            <article>
                
<p class="calibre2">Although the <em class="calibre16">Chef Client</em> provisioner can be seen as the advanced option, it's actually much simpler and quicker to set up than the <em class="calibre16">Chef Solo</em> provisioner, which we looked at in the previous section.</p>
<p class="calibre2">The reason why the Chef Client provisioner is simpler and quicker is that it is just a client. It's essentially a zombie which does not think for itself. It uses a Chef Server to get its commands and Cookbook files. When managing a large infrastructure, using this Client-to-Server method can be a much easier way than having to manage multiple nodes separately.</p>
<p class="calibre2">We won't cover how to set up a Chef Server in this book, as it's beyond its scope, but you can learn more from the official Chef documentation website here: <a href="https://docs.chef.io/install_server.html" class="calibre9">https://docs.chef.io/install_server.html</a>.</p>
<p class="calibre2">There isn't much to cover in this section, since the Chef Server handles the main bulk of the work, but there are some configuration settings we can add in the Vagrantfile. The following is an example of the provision block (inside the Vagrantfile):</p>
<pre class="calibre17">config.vm.provision "chef_client" do |ch|<br class="title-page-name"/>     ch.chef_server_url = "https://www.examplechefserver.com"<br class="title-page-name"/>     ch.validation_key_path = "cert.pem"<br class="title-page-name"/> end</pre>
<p class="calibre2">We are using two new keys here: <kbd class="calibre12">chef_server_url</kbd> and <kbd class="calibre12">validation_key_path</kbd> <span class="calibre6">–</span> both of which are required to connect the Vagrant machine (in this instance, the node) to the Chef Server.</p>
<p class="calibre2">We must set the Chef Server's URL and the path to the validation key (a <kbd class="calibre12">.pem</kbd> file). This will then register the Vagrant machine as a node, download the run list (recipes), and then provision the machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we learned about provisioning a Vagrant machine with Chef. We did this by using Chef Cookbooks to create a recipe which controls which software to install onto the Vagrant machine using either Chef Solo or Chef Client.</p>
<p class="calibre2">In <a target="_blank" href="part0257.html#7L30I0-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 12</a>, <em class="calibre16">Docker - Using Docker with Vagrant</em>, we will learn how to use Docker to provision a Vagrant machine. We will learn about Docker images, containers, and the Docker hub. We will then explore the multiple Docker options that are available when provisioning a Vagrant machine.</p>


            </article>

            
        </section>
    </body></html>