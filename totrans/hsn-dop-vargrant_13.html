<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Puppet - Using Puppet to Provision a Vagrant Box</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will continue with provisioning and learn how to provision a Vagrant machine using the Puppet software. In this chapter, you will learn about the following topics:</p>
<ul class="calibre10">
<li class="calibre11">Understanding Puppet</li>
<li class="calibre11">What Puppet apply and Puppet agent are</li>
<li class="calibre11">What the Puppet manifest is</li>
<li class="calibre11">How to provision a Vagrant machine with Puppet</li>
</ul>
<p class="calibre2"><span class="calibre6">At the end of this chapter, you will have a good understanding of how Puppet works with Vagrant to provision machines.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding Puppet</h1>
                
            
            <article>
                
<p class="calibre2">Puppet is a configuration management tool that is used for deploying, configuring, and managing nodes (servers).</p>
<p class="calibre2">Puppet was released by Luke Kanies in 2005. It was written in C++, and Clojure and runs on Linux, Unix, and Windows. The current version is 5.5.3 and was released in July 2018. Puppet as a software falls into the infrastructure as code category, which means that you configure and make changes using code and configuration files. Puppet uses manifest files to help configure nodes/servers (we'll learn more about this in a later section).</p>
<p class="calibre2"/>
<p class="calibre2">Puppet uses a pull configuration (master and slave) architecture in which the nodes (Puppet agent) poll the master server for configuration files and changes. There is a four-step life cycle in this master/slave process:</p>
<ol class="calibre13">
<li value="1" class="calibre11">The node sends facts about itself to the master server.</li>
<li value="2" class="calibre11">The master server uses these facts to compile a catalog as to how the node should be configured. It then sends the catalog back to the node.</li>
<li value="3" class="calibre11">The node uses the catalog to configure itself to the desired state, as described in the manifest file.</li>
<li value="4" class="calibre11">The node now sends a report to the master with any changes or errors. These reports can then be seen in the Puppet dashboard.</li>
</ol>
<p class="calibre2">Puppet also supports a multi-master architecture to reduce downtime and offer high availability. When a master server falls over or faces any issues, another master server can take its place. Puppet agents will then poll this new master server for any configuration changes.</p>
<p class="calibre2">As part of the configuration process, there are multiple steps that Puppet takes to transform code in configuration files and configure a node into a desired state.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Resources</h1>
                
            
            <article>
                
<p class="calibre2">Puppet configuration often starts with a resource. You can think of a resource as code that describes the desired state of part of the node. This could be a specific package that needs to be installed such as nginx.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Manifest</h1>
                
            
            <article>
                
<p class="calibre2">A Puppet program is know as a manifest. A manifest contains Puppet configuration code and has the <kbd class="calibre12">.pp</kbd> file extension. These blocks of code are the resources that we spoke about in the previous section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Compile</h1>
                
            
            <article>
                
<p class="calibre2">The compile process is when the Puppet master takes the manifest files and compiles them into a catalog. This catalog is then used by the nodes for provisioning and to reach the desired state.</p>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Catalogs</h1>
                
            
            <article>
                
<p class="calibre2">A Puppet catalog is a document that has been created by the master server. It is created by compiling the Puppet manifest file. It can handle multiple manifest files, too. The catalog is then used by the node to set the desired system state.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Apply</h1>
                
            
            <article>
                
<p class="calibre2">If a node/server has a catalog, then it must apply that configuration to itself. This is the process of installing any necessary files, services, and software. It allows the node to reach the desired state.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Desired state</h1>
                
            
            <article>
                
<p class="calibre2">When speaking about Puppet and provisioning,  you will hear about the <em class="calibre16">desired state</em>. In terms of Puppet, it simply means that the node/server has been completely provisioned and is now in the correct state. The software and services have been installed and are running correctly.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Puppet apply and Puppet agent</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will learn more about the two Puppet provisioning options available in Vagrant—<kbd class="calibre12">puppet apply</kbd> and <kbd class="calibre12">puppet agent</kbd>. <span class="calibre6">In the following section</span>, we will use both of these options to provision our own Vagrant machine.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Puppet apply</h1>
                
            
            <article>
                
<p class="calibre2">Using the Puppet apply option to provision a Vagrant machine allows you to use Puppet without the need for a Puppet master. It works by calling the <kbd class="calibre12">puppet apply</kbd> command on the guest machine. This can be useful for testing Puppet configurations if you do not have a Puppet master or you just need to get up and running quickly.</p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Options</h1>
                
            
            <article>
                
<p class="calibre2">There are 14 different options available when using Puppet apply in Vagrant. These options are to be applied in your Vagrantfile and can help give you more control over the Puppet provisioner:</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">binary_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>: <kbd class="calibre12">string</kbd></p>
<p class="calibre87"><strong class="calibre4">Description</strong>: This is a path on the guest to the Puppet's bin directory.</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">facter</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>: <kbd class="calibre12">hash</kbd></p>
<p class="calibre87"><strong class="calibre4">Description</strong>: This is a hash of available facter variables (also know as facts).</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">hiera_config_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> string</span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the path (on the host) to the hiera configuration.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">manifest_file</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the name of the manifest file that Puppet will use. The default is <kbd class="calibre12">default.pp</kbd></span>.</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">manifests_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the path to the directory where the manifest files are. The default is <kbd class="calibre12">manifests</kbd></span>.</p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">module_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd>/<kbd class="calibre12">array of strings</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This can be a path or paths to the directory (on the host) that contains any Puppet modules.</span></p>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">environment</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the name of the Puppet environment.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">environment_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is a path to the directory (on the host) which contains environment files.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">environment_variables</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">hash</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is a set of environment variables (in a string of key/value pairs) which are to be used before Puppet apply runs.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">options</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">array of strings</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> These are options that can be passed into the Puppet executable when Puppet is running.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">synced_folder_type</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This option allows you to specify what types of synced folder to use. This will use the synced folder type by default.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">synced_folder_args</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">array</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is an array of arguments (values) that are passed to the folder sync. You can send specific arguments depending on the type of synced folder that you have chosen (see the preceding option).</span></p>
<p class="calibre2"/>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">temp_dir</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the directory (on the guest machine) where any Puppet run data will be stored, such as manifest files.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">working_directory</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the working directory (on the guest machine) when Puppet is running.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Puppet agent</h1>
                
            
            <article>
                
<p class="calibre2">When using the Puppet agent to provision a Vagrant machine, you will need a Puppet master server to connect to. The master server will provide modules and manifests for the node to use. This provisioner works by using the <kbd class="calibre12">puppet agent</kbd> command, which is supplied by Puppet.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Options</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre6">There are seven different options available when using Puppet apply in Vagrant. These options are to be applied in your Vagrantfile and can help give you more control over the Puppet provisioner:</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">binary_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is a path on the guest to the Puppet's bin directory.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">client_cert_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the path to the client certificate for the node. The default value is nothing, which means that no client certificate will be uploaded.</span></p>
<p class="calibre2"/>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">client_private_key_path</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the path to the client key for the node. The default value is nothing, which means that no client key will be uploaded.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">facter</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">hash</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is a hash of available facter variables (also know as facts).</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">options</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd>/<kbd class="calibre12">array</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> These are options that can be passed to Puppet when the puppet agent command is ran.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">puppet_node</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> string</span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the name that you wish to give the node. If no value is set, then Vagrant will attempt to use the hostname (if set in the Vagrantfile) or fall back to the name of the box used.</span></p>
<ul class="calibre10">
<li class="calibre11"><kbd class="calibre12">puppet_server</kbd>:</li>
</ul>
<p class="calibre87"><strong class="calibre4">Type</strong>:<span class="calibre6"> <kbd class="calibre12">string</kbd></span></p>
<p class="calibre87"><strong class="calibre4">Description</strong>:<span class="calibre6"> This is the hostname of the Puppet server. If no value is set, then the default value will be set to <kbd class="calibre12">puppet</kbd>.</span></p>
<p class="calibre87"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Puppet Manifest example and syntax</h1>
                
            
            <article>
                
<p class="calibre2">A manifest is a Puppet program. It is made up of code that tells Puppet what to do, such as executing commands, installing software, and running services. A manifest file or multiple manifest files are one of the main part(s) of a module. A manifest file uses the <kbd class="calibre12">.pp</kbd> file extension and can be found in the <kbd class="calibre12">manifests</kbd> folder.</p>
<p class="calibre2">There are various sections found in a manifest file, such as exec, package, service, and file. Let's dive into the syntax of a manifest file.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Syntax</h1>
                
            
            <article>
                
<p class="calibre2">The manifest file is taken up with declaring resources which can be grouped into classes. The manifest file uses a domain-specific language called Puppet, which is similar to YAML or Ruby (when writing a Vagrantfile).</p>
<p class="calibre2">Here is an example manifest that installs and runs the nginx web server. Let's create a new manifest and call it  <kbd class="calibre12">nginx.pp</kbd>:</p>
<pre class="calibre17">package { "nginx":<br class="title-page-name"/>     ensure =&gt; installed<br class="title-page-name"/> }<br class="title-page-name"/> <br class="title-page-name"/> service { "nginx":<br class="title-page-name"/>     require =&gt; Package["nginx"],<br class="title-page-name"/>     ensure =&gt; running,<br class="title-page-name"/>     enable =&gt; true<br class="title-page-name"/> }</pre>
<p class="calibre2">There are a few things to note in the preceding example. Each resource (section) starts with the category. We are using two categories <span class="calibre6">–</span> package and service. In a resource block, we wrap the values within curly parentheses, <kbd class="calibre12">{}</kbd>, and we then reference the name (<kbd class="calibre12">nginx</kbd>) and set the values we require. </p>
<p class="calibre2">There are a few keywords that we are using in the resource blocks <span class="calibre6">–</span> ensure, require, and enable. These keywords help describe what should happen for the node to reach a desired state. The <kbd class="calibre12">ensure</kbd> keyword is used to ensure that the package or service is doing what you want it to, such as installing or running. The <kbd class="calibre12">require</kbd> keyword is used when a specific resource relies on another resource. In the service resource, we are using the keyword <kbd class="calibre12">enable</kbd>, which allows us to specify if a service is active or not. It can be useful if you need to temporarily disable a service while testing.</p>
<p class="calibre2">You can add comments into the manifest file by using the hashtag/pound symbol. The following is an example:</p>
<pre class="calibre17"># This comment wont be parsed by Puppet but it will be useful for other developers/DevOps</pre>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning with Puppet</h1>
                
            
            <article>
                
<p class="calibre2">Let's get to the exciting part! We will now use Puppet apply and Puppet agent to provision a Vagrant machine. We'll look at both options and install the nginx web server. We'll configure it using the Vagrantfile as a base but also add in Puppet-specific configuration such as manifests.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning with Puppet apply</h1>
                
            
            <article>
                
<p class="calibre2">The Puppet apply provision option in Vagrant allows you to get up and running quickly with Puppet. You do not require a separate Puppet master server when using this option. Let's get started:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Create a new directory for this project and move into it.</li>
<li value="2" class="calibre11">Create a directory and call it <kbd class="calibre12">manifests</kbd>.</li>
<li value="3" class="calibre11">In the manifests folder, create a manifest file called <kbd class="calibre12">nginx.pp</kbd>. Inside this file, we'll insert the following instructions:</li>
</ol>
<pre class="calibre59"> package { "nginx":<br class="title-page-name"/>     ensure =&gt; installed<br class="title-page-name"/> }<br class="title-page-name"/> service { "nginx":<br class="title-page-name"/>     require =&gt; Package["nginx"],<br class="title-page-name"/>     ensure =&gt; running,<br class="title-page-name"/>     enable =&gt; true<br class="title-page-name"/> }</pre>
<p class="calibre56">Let's break down this manifest file. First of all, we are executing the <kbd class="calibre12">apt-get update</kbd> command to update packages in Ubuntu. We then install the nginx package, which is started as a service. We ensure that it's running and enabled.</p>
<ol start="4" class="calibre13">
<li value="4" class="calibre11">Back to Vagrant. Let's run the <kbd class="calibre12">vagrant init -m</kbd> command to create a minimal Vagrantfile.</li>
<li value="5" class="calibre11">Let's add some configuration into the Vagrantfile:</li>
</ol>
<pre class="calibre59"> Vagrant.configure("2") do |config|<br class="title-page-name"/>     config.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>     config.vm.network "private_network", ip: "11.11.11.11"<br class="title-page-name"/>     config.vm.provision "shell", :inline =&gt; &lt;&lt;-SHELL<br class="title-page-name"/>         apt-get update<br class="title-page-name"/>         apt-get install -y puppet<br class="title-page-name"/>     SHELL<br class="title-page-name"/>     config.vm.provision "puppet" do |pup|<br class="title-page-name"/>         pup.manifest_file = "nginx.pp"<br class="title-page-name"/>     end<br class="title-page-name"/> end</pre>
<p class="calibre56">Let's break the Vagrantfile down. We first set the box to use Ubuntu Xenial 64 Bit, and then set the network to use a private network and a static IP address of <kbd class="calibre12">11.11.11.11</kbd>. We need to install Puppet onto the guest machine, otherwise you will receive this error:</p>
<p class="cdpaligncenter1"><img class="alignnone68" src="../images/00140.jpeg"/></p>
<p class="calibre56">To bypass this error, we are using the <kbd class="calibre12">shell</kbd> provisioner to first update the packages and then install the Puppet software on our Ubuntu box. Once this has completed, then the Puppet provisioner will begin. It will install and start running nginx:</p>
<p class="cdpaligncenter1"><img class="alignnone69" src="../images/00141.jpeg"/></p>
<p class="calibre56">The preceding screenshot shows the shell provisioner. In the following screenshot, you can see the Puppet provisioner:</p>
<p class="cdpaligncenter1"><img class="alignnone70" src="../images/00142.jpeg"/></p>
<ol start="6" class="calibre13">
<li value="6" class="calibre11"><span>Once complete, visit</span> <kbd class="calibre12">http://11.11.11.11</kbd> <span>in your browser, where you should see nginx's default page:</span></li>
</ol>
<p class="cdpaligncenter1"><img class="alignnone71" src="../images/00143.jpeg"/></p>
<p class="calibre87">We can also check that Puppet is running on the Vagrant machine by SSH-ing in using the <kbd class="calibre12">vagrant ssh</kbd> command. Once in, run the <kbd class="calibre12">puppet help</kbd> command. We should see output similar to what's shown in the following screenshot:</p>
<p class="cdpaligncenter1"><img class="alignnone72" src="../images/00144.jpeg"/></p>
<p class="calibre2">Congratulations! You have successfully provisioned a Vagrant machine using Puppet apply. You have created a Vagrantfile and a Puppet manifest file, installed nginx, and tested that the service is running correctly.</p>
<p class="calibre2">This is a fairly simple example, but Puppet is actually a very flexible and powerful provisioner. There is a lot you can do with Puppet and Vagrant. I would recommend that you experiment and learn more by testing out some of the options that are available.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Provisioning with Puppet agent</h1>
                
            
            <article>
                
<p class="calibre2">The second option when using Puppet as a provisioner is Puppet agent. Although this option has an added layer of complexity (the need for a Puppet master server), there is less configuration needed locally when it comes to Vagrant. We will not create a manifest file or any Puppet-related configuration on the host machine. It will all be handled by the Puppet master server.</p>
<p class="calibre2">The Puppet agent merely acts as a client which receives its commands from the server. In the following example, we are going to create a multi-machine setup that provisions Puppet master and Puppet agent machines:</p>
<ol class="calibre13">
<li value="1" class="calibre11">Let's first create a new directory and move into that. I'm going to call mine <kbd class="calibre12">vagrant-puppet-agent</kbd> and use the following comments to create and move it: </li>
</ol>
<pre class="calibre59"><strong class="calibre1"> mkdir vagrant-puppet-agent &amp;&amp; cd vagrant-puppet-agent</strong></pre>
<ol start="2" class="calibre13">
<li class="calibre11" value="2">In our new directory, we can create a Vagrantfile by running the <kbd class="calibre12">vagrant init -m</kbd> command.</li>
<li class="calibre11" value="3">We now need to edit our Vagrantfile, which requires quite a bit of configuration. Not all of this is required for using the <kbd class="calibre12">puppet_server</kbd>/Puppet agent provision option, but we are also creating a Puppet master server:</li>
</ol>
<pre class="calibre59">Vagrant.configure("2") do |config|<br class="title-page-name"/>     config.vm.box = "ubuntu/xenial64"<br class="title-page-name"/>         # Puppet master configuration<br class="title-page-name"/>         config.vm.define "puppetmaster" do |pm|<br class="title-page-name"/> <br class="title-page-name"/>                 pm.vm.provider "virtualbox" do |v|<br class="title-page-name"/>                         v.memory = 2048<br class="title-page-name"/>                         v.cpus = 2<br class="title-page-name"/>                 end<br class="title-page-name"/> <br class="title-page-name"/>                 pm.vm.network "private_network", ip: "10.10.10.11"<br class="title-page-name"/> <br class="title-page-name"/>                 pm.vm.provision "shell", :inline =&gt; &lt;&lt;-SHELL<br class="title-page-name"/>                         sudo echo "10.10.10.11 master.example.com" | sudo tee -a /etc/hosts<br class="title-page-name"/>                         sudo echo "10.10.10.12 node.example.com" | sudo tee -a /etc/hosts<br class="title-page-name"/>                         wget https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb<br class="title-page-name"/>                         sudo dpkg -i puppetlabs-release-pc1-xenial.deb<br class="title-page-name"/>                         sudo apt-get update -y<br class="title-page-name"/>                         sudo apt-get install -y puppetserver<br class="title-page-name"/>                         sudo awk '{sub(/-Xms2g -Xmx2g -XX:MaxPermSize=256m/,"-Xms512m -Xmx512m")}1'                   /etc/default/puppetserver &gt; tmp.txt &amp;&amp; mv tmp.txt /etc/default/puppetserver<br class="title-page-name"/>                         sudo echo "*" | sudo tee -a /etc/puppetlabs/puppet/autosign.conf<br class="title-page-name"/>                         sudo echo "autosign = true" | sudo tee -a /etc/puppetlabs/puppet/puppet.conf<br class="title-page-name"/>                         sudo echo "certname=master.example.com" | sudo tee -a /etc/puppetlabs/puppet/puppet.conf<br class="title-page-name"/>                         sudo echo "[agent]" | sudo tee -a /etc/puppetlabs/puppet/puppet.conf<br class="title-page-name"/>                         sudo echo "certname=node.example.com" | sudo tee -a /etc/puppetlabs/puppet/puppet.conf<br class="title-page-name"/>                         sudo echo "exec { 'apt-get update': path =&gt; '/usr/bin' } package { "nginx": ensure =&gt; installed } service { "nginx": require =&gt; Package["nginx"], ensure =&gt; running, enable =&gt; true }" | sudo tee -a /etc/puppetlabs/code/environments/production/manifests/default.pp<br class="title-page-name"/>                         sudo systemctl enable puppetserver<br class="title-page-name"/>                         sudo systemctl start puppetserver<br class="title-page-name"/>                 SHELL<br class="title-page-name"/>         end<br class="title-page-name"/> <br class="title-page-name"/>         # Puppet Node configuration<br class="title-page-name"/>         config.vm.define "pnode" do |pn|<br class="title-page-name"/> <br class="title-page-name"/>                 pn.vm.network "private_network", ip: "10.10.10.12"<br class="title-page-name"/> <br class="title-page-name"/>                 pn.vm.provision "shell", :inline =&gt; &lt;&lt;-SHELL<br class="title-page-name"/>                 sudo echo "10.10.10.11 master.example.com" | sudo tee -a /etc/hosts<br class="title-page-name"/>                 sudo echo "10.10.10.12 node.example.com" | sudo tee -a /etc/hosts<br class="title-page-name"/>                 apt-get update<br class="title-page-name"/>                 apt-get install -y puppet<br class="title-page-name"/>                 sudo puppet agent --enable<br class="title-page-name"/>                 sudo echo "autosign = true" | sudo tee -a /etc/puppet/puppet.conf<br class="title-page-name"/>                 sudo echo "certname=master.example.com" | sudo tee -a /etc/puppet/puppet.conf<br class="title-page-name"/>                 sudo echo "[agent]" | sudo tee -a /etc/puppet/puppet.conf<br class="title-page-name"/>                 sudo echo "certname=node.example.com" | sudo tee -a /etc/puppet/puppet.conf<br class="title-page-name"/>         SHELL<br class="title-page-name"/> <br class="title-page-name"/>         pn.vm.provision "puppet_server" do |pup|<br class="title-page-name"/>                 pup.puppet_node = "nginxplease"<br class="title-page-name"/>                 pup.puppet_server = "master.example.com"<br class="title-page-name"/>                 pup.options = "--verbose --waitforcert 10"<br class="title-page-name"/>         end<br class="title-page-name"/> <br class="title-page-name"/>     end<br class="title-page-name"/> end</pre>
<p class="calibre2">This is the largest Vagrantfile we've created so far, but it covers a lot of configuration and it creats multiple Vagrant machines. Let's break it down:</p>
<ol class="calibre13">
<li value="1" class="calibre11">We first set the box to use Ubuntu Xenial 64 Bit (this will apply to both machines as it's outside their configuration blocks).</li>
<li value="2" class="calibre11">Secondly, we define a <kbd class="calibre12">puppetmaster</kbd> block, which is used to configure the Puppet master machine. In this block, there is a large amount of custom configuration. Some of these parts are used to help suppress errors and may not always be needed. We need a powerful machine to meet the minimum requirements, so we will set the RAM memory and CPU count. We then create a shell provisioner, which installs the Puppet server software and makes various configuration changes to multiple files.</li>
<li value="3" class="calibre11">Thirdly, we define a <kbd class="calibre12">pnode</kbd> configuration block, which is used to configure the Puppet node/agent machine. We use the shell provisioner to install Puppet and make some configuration changes to multiple files. We also set the provisioner to use <kbd class="calibre12">puppet_server</kbd>, which is also known as Puppet agent. We set the node name, server host, and some additional options, which are to be sent to the command when Puppet is run.</li>
<li class="calibre11" value="4">Let's now run the <kbd class="calibre12">vagrant up --provision</kbd> command. This will take some time as it must first configure the Puppet master machine and then the Puppet agent machine.</li>
</ol>
<p class="calibre56">During the <kbd class="calibre12">up</kbd><span class="calibre6"> process, you will see lots of out-put</span> <span class="calibre6">–</span> <span class="calibre6">mainly green, but some red, too. Don't worry too much about the red as it's not so much an error in our scenario as another level of output. Green is the output from the Vagrant machine, while red might be output from the Puppet master running within the Vagrant machine.</span></p>
<p class="calibre2"/>
<ol start="5" class="calibre13">
<li value="5" class="calibre11">We'll first see the Puppet master provisioner begin. During this process, we'll also see the output from our <kbd class="calibre12">echo</kbd> statement, which is adding two records into the <kbd class="calibre12">/etc/hosts</kbd> file:</li>
</ol>
<p class="cdpaligncenter1"><img class="alignnone73" src="../images/00145.jpeg"/></p>
<p class="calibre56">Nearing the end of provisioning the Puppet master, we will see more output while we add additional information into the <kbd class="calibre12">puppet.conf</kbd> file. In red, we can see the Puppet master's output as it starts the service:</p>
<p class="cdpaligncenter1"><img class="alignnone74" src="../images/00146.jpeg"/></p>
<ol start="6" class="calibre13">
<li value="6" class="calibre11">We now start provisioning the second Vagrant machine, which is acting as our client/node in this example and using the Vagrant provision option for <kbd class="calibre12">puppet_server</kbd>. We'll see the node create and cache an SSL certificate:</li>
</ol>
<p class="cdpaligncenter1"><img class="alignnone75" src="../images/00147.jpeg"/></p>
<p class="calibre56">At the end of the node's provisioning, we will see it <kbd class="calibre12">retrieving pluginfacts</kbd> and then <kbd class="calibre12">applying configuration</kbd>. It will create a YAML file with the state and then it will use the catalog to reach a <kbd class="calibre12">desired state</kbd>. In the following screenshot, we can see that this was achieved in a swift 7.14 seconds:</p>
<p class="cdpaligncenter1"><img class="alignnone76" src="../images/00148.jpeg"/></p>
<p class="calibre2">Now, let's check to make sure that our Puppet configuration has worked correctly and that we now have a node in the desired state (running nginx). Visit <kbd class="calibre12">http://10.10.10.12</kbd> in your browser. You should see nginx's default page:</p>
<p class="cdpaligncenter1"><img class="alignnone77" src="../images/00149.jpeg"/></p>
<p class="calibre2">We can also SSH into the machines individually to see their state. Run the <kbd class="calibre12">vagrant status</kbd> command to view each machine's status and their name (as we need this for the SSH command):</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="cdpaligncenter1"><img class="alignnone78" src="../images/00150.jpeg"/></p>
<p class="calibre2">Let's first SSH into the Puppet master by running the <kbd class="calibre12">vagrant ssh puppetmaster</kbd> command. Once in, run the <kbd class="calibre12">puppetserver --version</kbd> command to confirm that everything is running fine and to see what the current version is:</p>
<p class="cdpaligncenter1"><img class="alignnone79" src="../images/00151.jpeg"/></p>
<p class="calibre2"><span class="calibre6">Let's now SSH into the Puppet node/agent by running the </span><kbd class="calibre12">vagrant ssh pnode</kbd><span class="calibre6"> command. Once in, run the </span><kbd class="calibre12">puppet --version</kbd><span class="calibre6"> command to confirm that everything is running fine and to see what the current version is:</span></p>
<p class="cdpaligncenter1"><img class="alignnone80" src="../images/00152.jpeg"/></p>
<p class="calibre2">If you wish to stop both machines, then run the <kbd class="calibre12">vagrant halt</kbd> command. By doing this, you can delete the machine states and any associated files by running the <kbd class="calibre12">vagrant destroy</kbd> command.</p>
<p class="calibre2">Congratulations! You have successfully provisioned a Vagrant machine using the Puppet agent option. We have created a traditional Puppet setup of the server and client by using the multi machine option in Vagrant, along with various provisioning and networking options.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we have learned all about Puppet and how to use it as a provisioner for Vagrant machines. We have also learned about the two supported provisioning methods of Puppet apply and Puppet agent.</p>
<p class="calibre2">In <a target="_blank" href="part0305.html#92RRI0-d86fec2f29de42f086efd11bc5538d9c" class="calibre9">Chapter 14</a>, <em class="calibre16">Salt - Using Salt to Provision a Vagrant Box</em>, we will focus on another provisioner supported by Vagrant. We’ll learn about Salt and how it can be used to provision Vagrant machines. You’ll get a good understanding of Salt as well as Salt states.</p>


            </article>

            
        </section>
    </body></html>