<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Installing GitLab</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will discuss several ways of installing GitLab. We will start with the recommended way of installing GitLab on your own machine, using the omnibus installer. Secondly, we will show how to do a complete install from the GitLab source files. This will all take place on the Debian platform. Then, we will move to a more modern way of running an application, by showing you how to use a Kubernetes orchestrator). Finally, we will demonstrate installation using the cloud platform, DigitalOcean. They have predefined GitLab images that are internally configured using the omnibus installer.</p>
<p>In this chapter, the <span>following</span> points will be covered:</p>
<ul>
<li class="mce-root"><span>Installing using omnibus packages</span></li>
<li>Running from source files</li>
<li>Using GitLab from Docker</li>
<li>Deploying GitLab using Kubernetes</li>
<li>Creating droplets on DigitalOcean</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p><span>For managing omnibus installations, there is one central configuration file called <kbd>gitlab.rb</kbd>. You need to create it or copy an example. There is a template available that you can find at <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template</a>. It is not updated after upgrades. In large parts of this chapter, I will quote and discuss parts of this file.</span></p>
<p><span>To follow along with the instructions in this chapter, please download the Git repository available on GitHub: <a href="https://github.com/PacktPublishing/Mastering-GitLab-12/tree/master/Chapter02">https://github.com/PacktPublishing/Mastering-GitLab-12/tree/master/Chapter02</a>.</span></p>
<p>Although GitLab can be installed on a variety of platforms, in this chapter we choose Debian 9 to show you how it's done. You can download Debian from <a href="http://debian.org">http://debian.org</a>.</p>
<p class="mce-root"/>
<p><span>We will require the following tools as well:</span></p>
<ul>
<li><strong>Helm</strong>: <a href="https://helm.sh">https://helm.sh</a></li>
<li><strong>kubectl</strong>: <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installation requirements</h1>
                </header>
            
            <article>
                
<p>For all kinds of installs, there are firewall/traffic concerns. The basic firewall software for Linux is iptables, which is tightly connected to the Linux kernel. It is quite complicated to configure this, and there are other books for that. Fortunately, there are many user friendly programs available that let you manage the system firewall by interacting with iptables <em>for</em> you.</p>
<p><span>Linux UFW (Uncomplicated Firewall)</span> is such a frontend. Follow these instructions to open up your firewall if it is installed on your system.</p>
<p>Before you configure GitLab, you will need to ensure that your firewall rules are permissive enough to allow web traffic.</p>
<p>View the current status of your active firewall by executing the following command:</p>
<pre><strong>$sudo ufw status</strong><br/><strong> Status: active</strong><br/>  <br/><strong> To                         Action      From</strong><br/><strong> --                         ------      ----</strong><br/><strong> OpenSSH                    ALLOW       Anywhere                  </strong><br/><strong> OpenSSH (v6)               ALLOW       Anywhere (v6)</strong></pre>
<p>As you can see, the current rules allow SSH traffic through, but access to other services is restricted. Since GitLab is a web application, we should allow HTTP access. If you have a domain name associated with your GitLab server, GitLab can also request and enable a free TLS/SSL (Transport Layer Security/Secure Sockets Layer) certificate from the <strong>Let's Encrypt</strong> project to secure your installation. We'll want to allow HTTPS access as well in this case.</p>
<p>Since the protocol to port mapping for HTTP and HTTPS are available in the <kbd>/etc/services</kbd> file, we can allow that traffic in by name. If you didn't already have OpenSSH traffic enabled, you should allow that traffic now too:</p>
<pre><strong>$sudo ufw allow http</strong><br/><strong>$sudo ufw allow https</strong><br/><strong>$sudo ufw allow OpenSSH</strong></pre>
<p>If you check the <kbd>ufw status</kbd> command again, you should see access configured to at least these two services:</p>
<pre><strong>$sudo ufw status</strong><br/><strong>Status: active</strong><br/> <br/><strong> To                         Action      From</strong><br/><strong> --                         ------      ----</strong><br/><strong> OpenSSH                    ALLOW       Anywhere                  </strong><br/><strong> 80                         ALLOW       Anywhere                  </strong><br/><strong> 443                        ALLOW       Anywhere                  </strong><br/><strong> OpenSSH (v6)               ALLOW       Anywhere (v6)             </strong><br/><strong> 80 (v6)                    ALLOW       Anywhere (v6)             </strong><br/><strong> 443 (v6)                   ALLOW       Anywhere (v6)</strong></pre>
<p>The preceding output indicates that the GitLab web interface will be accessible once we configure the application.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing GitLab using omnibus packages</h1>
                </header>
            
            <article>
                
<p>There are several ways to install GitLab. The best way is to install it using the omnibus installer, a Chef-based configuration package. The installer software is actually a fork from a Chef project at <a href="https://github.com/chef/omnibus">https://github.com/chef/omnibus</a>. The reason for this being the best way to install it is that it takes care of a lot of boilerplate for you. There are a lot of details surrounding a GitLab installation and it is easy to make mistakes. Automating this via Chef omnibus eliminates a lot of complexity and possible errors. The installer can be used to install GitLab on several platforms:</p>
<ul>
<li>Ubuntu</li>
<li>Debian</li>
<li>CentOS (any Red Hat derivative)</li>
<li>OpenSUSE</li>
<li>Raspbian</li>
</ul>
<p>We will use Debian as an example in the section below 'Running the installer'.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Omnibus structure</h1>
                </header>
            
            <article>
                
<p>Globally, the omnibus package consists of the following:</p>
<ul>
<li class="mce-root">A project definition</li>
<li class="mce-root">Individual software definitions</li>
<li class="mce-root">A GitLab configuration template</li>
<li class="mce-root">Chef components such as cookbooks and attributes</li>
<li class="mce-root">Runit recipes for managing services</li>
<li class="mce-root">Tests</li>
<li class="mce-root">Last but not least, the <kbd>gitlab-ctl</kbd> commands</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Project definition</h1>
                </header>
            
            <article>
                
<p>This file contains metadata and describes details of the project, as well as the dependencies contained in the project. You can find it in the omnibus source code  at <kbd>config/projects/gitlab.rb</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Individual software definitions</h1>
                </header>
            
            <article>
                
<p>Found in the <kbd>config/software/</kbd> folder, it contains all of the software that is part of the omnibus install. For instance, if you want to use PostgreSQL (a relational database), you will find the configuration, the license, its dependencies, and instructions on how to build or get the software. Sometimes, a patch is needed and that will be incorporated too.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">A GitLab configuration template</h1>
                </header>
            
            <article>
                
<p>All configuration directives are read from a <kbd>/etc/gitlab/gitlab.rb</kbd> file, which should be placed on the destination system where omnibus is to be applied. There are a lot of settings you can manipulate using that file. The standard way to specify settings is by using the following:</p>
<pre>component['settings'] = $value eg. gitlab_rails['webhook_timeout'] = 10</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Chef components</h1>
                </header>
            
            <article>
                
<p>There are several <strong>Chef</strong> cookbooks that are part of GitLab omnibus and they may or may not be executed depending on the configuration you specify.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Runit recipe</h1>
                </header>
            
            <article>
                
<p>GitLab has chosen <strong>runit</strong> (<a href="https://wiki.archlinux.org/index.php/Runit">https://wiki.archlinux.org/index.php/Runit</a>) as the process supervisor that handles all of the services that are installed with the omnibus-gitlab package. On install, it determines which init system is used and it makes sure it is called appropriately during boot. It manages the stopping, starting, reloading, and enabling of services.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Tests</h1>
                </header>
            
            <article>
                
<p><span>The omnibus-gitlab repository uses ChefSpec to test (behavior driven testing framework) its cookbooks. Tests may, for example, look for files that should be there and conditions after running a command. Normally, these tests only matter if you are changing the source code (<a href="https://gitlab.com/gitlab-org/omnibus-gitlab/">https://gitlab.com/gitlab-org/omnibus-gitlab/</a>) of the omnibus-gitlab installer. You will find these in the <kbd>spec</kbd> folder. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">gitlab-ctl commands</h1>
                </header>
            
            <article>
                
<div>
<p><span>This is the most import command when using the omnibus-gitlab package. It is available after running the installer. </span><span>This tool can be used to manage general things such as the starting/stopping/reloading of all omnibus-gitlab provided services, but it also provides a vital function in applying changes in the <kbd>gitlab.rb</kbd> configuration file. Never forget to apply changes with the following command:</span></p>
</div>
<pre><strong>gitlab-ctl reconfigure</strong></pre>
<p>The main commands are as follows:</p>
<ul>
<li><kbd>help</kbd> (help about commands)</li>
<li><kbd>cleanse</kbd> (delete all the data and reset the situation)</li>
<li><kbd>show-config</kbd> (show what configuration is to be created)</li>
<li><kbd>uninstall</kbd> (stop all processes and remove the managing process service)</li>
</ul>
<p>And the service management commands <span>are as follows</span>:</p>
<ul>
<li><span><kbd>hup</kbd> (send a service or all the hangup signals)</span></li>
<li><span><kbd>kill</kbd> (send a service or all the kill signals)</span></li>
<li><span><kbd>start</kbd>/<kbd>restart</kbd>/<kbd>stop</kbd> (send a service or all the commands)</span></li>
<li><span><kbd>status</kbd> (test and report the status of the service specified or all services)</span></li>
<li><span><kbd>tail</kbd> (watch the logs of all services)</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrade using the omnibus-gitlab package</h1>
                </header>
            
            <article>
                
<p>Normally if you deploy the package on an existing installation it will automatically upgrade components that are installed. For GitLab 12 the PostgreSQL database will be automatically upgraded to version 10.7 unless you create a file called  <kbd>/etc/gitlab/disable-postgresql-upgrade</kbd>. Always read the release notes for special instructions when upgrading. For version 12 they are here<strong>: <a href="https://docs.gitlab.com/omnibus/update/gitlab_12_changes.html">https://docs.gitlab.com/omnibus/update/gitlab_12_changes.html</a><a href="https://docs.gitlab.com/omnibus/update/gitlab_12_changes.html">.</a></strong></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running the installer</h1>
                </header>
            
            <article>
                
<p>Below we will show you how to run the<span> omnibus-gitlab install on Debian Linux. </span>Before we can run the package installer, we need to prepare some things:</p>
<ol>
<li>We need to set the internationalization settings and install some packages (curl, openssh-server en the default ssl root certificates):</li>
</ol>
<pre style="padding-left: 60px"><strong>sudo apt-get update <br/>export LANGUAGE=en_US.UTF-8<br/>export LANG=en_US.UTF-8<br/>export LC_ALL=en_US.UTF-8<br/>sudo locale-gen en_US.UTF-8</strong><br/><strong>sudo apt-get install -y curl openssh-server ca-certificates</strong> </pre>
<ol start="2">
<li>When using GitLab, it is also important to configure email for notifications. Usually, this is done via Postfix, but you can use another solution and point GitLab to it (external SMTP (Simple Mail Transfer Protocol)):</li>
</ol>
<pre class="command" style="padding-left: 60px"><strong>sudo apt-get install -y postfix</strong> </pre>
<ol start="3">
<li>The best option is to choose <span class="packt_screen">Internet Site</span> when asked and use your external host name as mail name. For the rest, accept the defaults.</li>
<li>Add the GitLab package repository and install the package.</li>
<li>Using the following  <kbd>curl</kbd> command, you install the GitLab package repository and initiate an installation by downloading a package:</li>
</ol>
<pre class="command" style="padding-left: 60px"><strong>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash</strong> </pre>
<ol start="6">
<li>The next step is to really execute the package install step. You can set the <kbd>EXTERNAL_URL</kbd> <span>variable </span>to the URL of your new GitLab instance. If you specify a https:// url the installer will try to use Let's Encrypt for generating a certificate. This service is free to use (<a href="https://letsencrypt.org/">https://letsencrypt.org/</a>), but requires a valid hostname (it is validated) and an incoming port 80, which is reachable from the internet. You can also specify a normal http:// url in which case Let's Encrypt is not used. The install command is as follows:</li>
</ol>
<pre class="command" style="padding-left: 60px"><strong> sudo EXTERNAL_URL="http://gitlab.example.com" apt-get install gitlab-ee </strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Browsing to the external URL and login</h1>
                </header>
            
            <article>
                
<p>If it is the first time you are using it, you will be presented with a password reset form. You can specify the password for the initial admin account, and after the password is saved, you will be sent to the login screen. Log in with the admin credentials that you just chose.</p>
<p><span><span>Extensive information and instructions on what to do next and configuring GitLab are included in the following chapter.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running from source</h1>
                </header>
            
            <article>
                
<p>When installing from source, make sure you have reviewed the latest installation guides for your platform for the GitLab branch you want (for example, 12-0). The instructions in this book will ultimately be out of date. Furthermore, if you run into an issue, you can try to find an answer on the GitLab forum: <a href="https://forum.gitlab.com/c/troubleshooting">https://forum.gitlab.com/c/troubleshooting</a>. If the problem turns out to be a bug or unwanted behavior by GitLab, you can open an issue at <a href="https://gitlab.com/gitlab-org/gitlab-ce/issues">https://gitlab.com/gitlab-org/gitlab-ce/issues</a>. The following sections will feature the exact installation instructions for a Debian version.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Operating system – Debian 9</h1>
                </header>
            
            <article>
                
<p>Here, you will find the instructions for installing GitLab on a Debian-based Linux. Debian is one of the oldest Linux distributions and was created about 25 years ago. The foundation behind it has always had a firm principle to only include open source GPL (General Public License) software. The package management system in use, <kbd>apt</kbd>, combined with good package maintainers, ensured good quality throughout the years. Their use of a process to determine which components should be included created a very clean product.</p>
<p>Debian became a <em>basic</em> distribution that others <em>forked</em> and expanded upon. In 2016, there were about 125 Debian-based distributions.</p>
<p>The following install instructions were created for and tested on Debian operating systems. For installing on Red Hat Enterprise Linux (RHEL) or its sister operating system, the Community Enterprise Operating System (CentOS), we recommend using the omnibus packages.</p>
<p>The following instructions should work for most people. Many people run into permission problems because they have changed the location of directories or run services as a different user.</p>
<p>First, we will start explaining which basic software packages you need to install in preparation for installing GitLab. Then, we'll touch on the installation of the required programming languages. </p>
<p>Once, these steps are successful, we'll continue the installation by preparing the SQL database and the memory database for GitLab. </p>
<p>Finally, we'll start the installation of the GitLab application components.</p>
<p>You will have to edit several configuration files as part of the installation. Make sure you have a working editor. The most common one is <kbd>vim</kbd> (people will disagree), and you can install it like this:</p>
<pre><strong>sudo apt-get install -y vim</strong><br/><strong>sudo update-alternatives --set editor /usr/bin/vim.basic</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Required basic software packages</h1>
                </header>
            
            <article>
                
<p><span>First, set the locale to your preference (I use English UTF-8 , which is 8-bit Unicode Transformation Format). These settings are by default not present on my Debian system:</span></p>
<pre style="padding-left: 60px"><strong>export LANGUAGE=en_US.UTF-8<br/>export LANG=en_US.UTF-8<br/>export LC_ALL=en_US.UTF-8<br/>sudo locale-gen en_US.UTF-8</strong></pre>
<p>The, install the required<span> </span>software<span> </span>using the following command:</p>
<pre><strong>sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libre2-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate rsync python-docutils pkg-config cmake wget</strong></pre>
<p>Make sure you have the right version of Git installed. Install Git using the following command:</p>
<pre><strong>sudo apt-get install -y git-core</strong></pre>
<p>Make sure the version of Git is 2.9.5 or higher:</p>
<pre><strong>git --version</strong></pre>
<p>Install a mail server, but don't use Exim. It makes more sense to use Postfix:</p>
<pre><strong>sudo apt-get install -y postfix</strong></pre>
<p>Then, select <span class="packt_screen">Internet Site</span> and press <em>Enter</em> to confirm the hostname.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Required programming languages</h1>
                </header>
            
            <article>
                
<p>GitLab needs several programming languages in order to function. You need to install them in order to use all the features.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Ruby</h1>
                </header>
            
            <article>
                
<p>As GitLab is still mainly written in Ruby, we need to install that language. Remove the old Ruby 1.8 if present in the OS:</p>
<pre><strong>sudo apt-get remove ruby1.8</strong></pre>
<p>Download the latest Ruby, check the signature and compile it:</p>
<pre><strong>$ wget https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.3.tar.gz<br/><span class="s1">$ shasum ruby-2.6.3.tar.gz <br/></span></strong><span class="s1"><strong>2347ed6ca5490a104ebd5684d2b9b5eefa6cd33c<span class="Apple-converted-space">  </span>ruby-2.6.3.tar.gz<br/>$ tar xvzf ruby-2.6.3.tar.gz</strong><br/>..<br/></span><strong>$ cd ruby-2.6.3</strong><br/><strong>$ ./configure --disable-install-rdoc</strong><br/><strong>$ make</strong><br/><strong>$ sudo make install</strong></pre>
<p>After installation is finished, check the version:</p>
<pre><strong>$ruby -v</strong><br/><strong>ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-linux]</strong></pre>
<p>Then, install the Bundler Gem:</p>
<pre><strong>$ sudo gem install bundler --no-document --version '&lt; 2'</strong><br/><strong>Fetching: bundler-1.17.3.gem (100%)</strong><br/><strong>Successfully installed bundler-1.17.3</strong><br/><strong>1 gem installed</strong></pre>
<p>Now, the basic installation of Ruby is complete.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Go</h1>
                </header>
            
            <article>
                
<p>The newer parts of GitLab are written in Go (sometimes called Golang). These parts have been in GitLab since version 8.0, so we need this language compiler too in order to run newer versions of GitLab. It is best to download the latest version of Go here: <a href="https://golang.org">https://golang.org</a>. After download make sure the checksum is correct (for the linux-amd64 page  for go 11.10 it is <kbd><span>aefaa228b68641e266d1f23f1d95dba33f17552ba132878b65bb798ffa37</span></kbd><span><kbd>e6d0</kbd></span>. We install it in the <kbd>/usr/local/bin</kbd> location:</p>
<pre><strong>$ wget https://dl.google.com/go/go1.11.10.linux-amd64.tar.gz</strong><br/><strong>$ <span class="s1">shasum<span class="Apple-converted-space">  </span>-a256 go1.11.10.linux-amd64.tar.gz<br/></span><span class="s1">aefaa228b68641e266d1f23f1d95dba33f17552ba132878b65bb798ffa37e6d0<span class="Apple-converted-space">  </span>go1.11.10.linux-amd64.tar.gz</span></strong><br/><strong>$ sudo tar -C /usr/local -xzf go1.11.10.linux-amd64.tar.gz</strong><br/><strong>$ sudo ln -sf /usr/local/go/bin/{go,godoc,gofmt} /usr/local/bin/</strong><br/><strong>$ rm go1.11.10.linux-amd64.tar.gz</strong><br/> <br/><strong>$ go version</strong><br/><strong>go version go1.11.10 linux/amd64</strong></pre>
<p>Currently<span>, Go supports eight different hardware instructions sets, so you have some choice. You can find downloads for platforms other than 64-bit Linux on the </span>Go download page, which is located at <a href="https://golang.org/dl/">https://golang.org/dl/</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Node.js</h1>
                </header>
            
            <article>
                
<p>GitLab uses <span>Node.js</span><span> to compile JavaScript, and Yarn is used for the dependency management of JavaScript components. Because these tools evolve quickly (there are regular new versions), you should really check the current requirements at <a href="https://about.gitlab.com/">https://about.gitlab.com/</a>. As of April 2019, the supported version of Node.js should be ≥ 8.10.0, and Yarn should be ≥ v1.10.0.</span></p>
<p>Because the versions in the Linux distributions are typically behind, you should install from the source. The following code block shows how this is done:</p>
<pre><strong> $ curl --location https://deb.nodesource.com/setup_12.x | sudo bash -</strong><br/><strong> $ sudo apt-get install -y nodejs</strong><br/><strong> $ node -v</strong><br/><strong> v12.6.0</strong><br/> <br/><strong> $ curl --silent --show-error https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -<br/></strong>  OK<br/><strong> $ echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee \<br/> /etc/apt/sources.list.d/yarn.list</strong><br/><strong> $ sudo apt-get update</strong><br/><strong> $ sudo apt-get install yarn<br/></strong> ...<br/> <br/><strong> $ yarn -v</strong><br/><strong> 1.17.3</strong></pre>
<p>You can find more information about Yarn at <a href="https://yarnpkg.com/en/docs">https://yarnpkg.com/en/docs</a>. The Node.js documentation can be found at <a href="https://nodejs.org/en/docs/">https://nodejs.org/en/docs/</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">System users</h1>
                </header>
            
            <article>
                
<p>Create a Git user for GitLab that has no login shell and provide a common name in the GECOs field (GECOS = old Unix age printers):</p>
<pre><strong>$ sudo adduser --disabled-login --gecos 'GitLab user' git</strong><br/><strong>Adding user `git' ...</strong><br/><strong>Adding new group `git' (1001) ...</strong><br/><strong>Adding new user `git' (1001) with group `git' ...</strong><br/><strong>Creating home directory `/home/git' ...</strong><br/><strong>Copying files from `/etc/skel' ...</strong></pre>
<p>The result is a user being added named <kbd>git</kbd>, with a group called <kbd>git</kbd>, an established home directory, and some template files copied to the home directory from <kbd>/etc/skel</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">SQL database</h1>
                </header>
            
            <article>
                
<p>You really should use a PostgreSQL database, as explained in <a href="384dcfd9-ef7f-470d-89dc-3af7502a2d09.xhtml">Chapter 1</a>, <em>Introducing the GitLab Architecture</em>. For MySQL (a different SQL database), check the MySQL setup guide.</p>
<p>Install the database packages using the following command:</p>
<pre><strong>$ sudo apt-get install -y postgresql postgresql-client libpq-dev postgresql-contrib</strong><br/> <br/><strong>Setting up postgresql (9.6+181+deb9u2) ...</strong><br/><strong>Setting up postgresql-client (9.6+181+deb9u2) ...</strong><br/><strong>Setting up postgresql-contrib-9.6 (9.6.10-0+deb9u1) ...</strong><br/><strong>Setting up postgresql-contrib (9.6+181+deb9u2) ...</strong><br/><strong>Processing triggers for systemd (232-25+deb9u4) ...</strong><br/><strong>Processing triggers for libc-bin (2.24-11+deb9u3) ...</strong></pre>
<p>Start the Database Engine:</p>
<pre><strong>$ sudo service postgresql start</strong></pre>
<p>Create a database user for GitLab:</p>
<pre><strong>$ sudo -u postgres psql -d template1 -c "CREATE USER git CREATEDB;"<br/>CREATE ROLE</strong></pre>
<p>Create the <kbd>pg_trgm</kbd> extension (required for GitLab 8.6+):</p>
<pre><strong>$ sudo -u postgres psql -d template1 -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"<br/> CREATE EXTENSION</strong></pre>
<p>Create the GitLab production database and grant all privileges on the database:</p>
<pre><strong>$ sudo -u postgres psql -d template1 -c "CREATE DATABASE gitlabhq_production OWNER git;"<br/> CREATE DATABASE</strong></pre>
<p>Try connecting to the new database with the new user:</p>
<pre><strong>$ sudo -u git -H psql -d gitlabhq_production</strong><br/><strong>Postgresql (9.4.22) Type “help” for help.</strong><br/><strong>gitlabhq_production=&gt;</strong></pre>
<p>Check whether the <kbd>pg_trgm</kbd> extension is enabled by pasting or typing this in the database console:</p>
<pre><strong> SELECT true AS enabled</strong><br/><strong> FROM pg_available_extensions</strong><br/><strong> WHERE name = 'pg_trgm'</strong><br/><strong> AND installed_version IS NOT NULL;</strong></pre>
<p>If the extension is enabled, this will produce the following output:</p>
<pre class="mce-root"><strong><span><span>enabled<br/>-------<br/></span></span>t </strong><br/><strong>(1 row)</strong> </pre>
<p>Now, we set the database password:</p>
<pre class="mce-root"><strong>gitlabhq_production=&gt; \password git</strong><br/><strong>Enter new password: &lt;type a password&gt;</strong><br/><strong>Enter it again: &lt;type again this password&gt;</strong><br/><strong>gitlabhq_production=&gt;</strong> <strong>\q</strong></pre>
<p class="mce-root">Quit the database console with <kbd>\q</kbd>. Save this password for later use for yourself when you configure the GitLab installation.</p>
<p><span>Create an entry in the PostgreSQL main configuration file:</span></p>
<pre><strong><span>$ vi /etc/postgresql/9.6/main/postgresql.conf</span></strong></pre>
<p>Change the listen address to <kbd>*</kbd>, or change the IP if it now says localhost and uncomment:</p>
<pre><strong><span>listen_addresses = '*'</span></strong></pre>
<p class="mce-root">Create an entry in the PostgreSQL host file:</p>
<pre class="p1"><strong><span class="s1">$ sudo vi /etc/postgresql/9.6/main/pg_hba.conf</span></strong></pre>
<p>Add a line such as this:</p>
<pre class="p1"><strong><span class="s1">host gitlabhq_production git &lt;ip of gitlab server&gt;/32 md5</span></strong></pre>
<p>After saving the host file, restart the database instance for the settings to take effect:</p>
<pre class="mce-root"><strong>$ sudo service postgresql restart</strong></pre>
<p>The database is now ready for GitLab.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Redis memory database</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we talked about Redis and how the program works.</p>
<p>We need at least v2.8 of Redis for the installation of GitLab. It can be easily installed on Debian with <kbd>apt</kbd>:</p>
<pre><strong>$ sudo apt-get install redis-server</strong></pre>
<p>Configure Redis to use sockets:</p>
<pre><strong>$ sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig</strong></pre>
<p>Disable Redis listening on <strong>Transmission Control Protocol</strong> (<strong>TCP</strong>) by setting <kbd>port</kbd> to <kbd>0</kbd>:</p>
<pre><strong>$ sudo sed 's/^port .*/port 0/' /etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf</strong></pre>
<p>Enable the Redis socket for the default path on Debian and similar distributions:</p>
<pre><strong>$ sudo echo 'unixsocket /var/run/redis/redis.sock' | sudo tee -a /etc/redis/redis.conf</strong></pre>
<p>Grant permission to the socket to all members of the Redis group:</p>
<pre><strong>$ sudo echo 'unixsocketperm 770' | sudo tee -a /etc/redis/redis.conf</strong></pre>
<p>Create the directory that contains the socket (if it exists it's ok):</p>
<pre><strong><span class="nb">$ </span><span class="nb">sudo mkdir</span><span> /var/run/red</span><span>is</span></strong><br/><strong>$ sudo chown redis:redis /var/run/redis </strong><br/><strong>$ sudo chmod 755 /var/run/redis</strong></pre>
<p>Persist the directory that contains the socket, if applicable:</p>
<pre> <br/><strong>   echo 'd  /var/run/redis  0755  redis  redis  10d  -' | sudo tee -a /etc/tmpfiles.d/redis.conf</strong><br/><strong> fi</strong></pre>
<p>Activate the changes to <kbd>redis.conf</kbd>:</p>
<pre><strong>$ sudo service redis-server restart</strong></pre>
<p>Add Git to the Redis group:</p>
<pre><strong>$ sudo usermod -aG redis git</strong></pre>
<p>We now have a functional Redis server to be used with GitLab.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab</h1>
                </header>
            
            <article>
                
<p>We'll install GitLab in the home directory of the <kbd>git</kbd> <span>user:</span></p>
<pre><strong>$ cd /home/git</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p>Clone the source:</p>
<pre><strong>$ sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 12-0-stable gitlab</strong><br/><strong> Cloning into 'gitlab'...</strong><br/><strong> remote: Enumerating objects: 1234071, done.</strong><br/><strong> remote: Counting objects: 100% (1234071/1234071), done.</strong><br/><strong> remote: Compressing objects: 100% (369844/369844), done.</strong><br/><strong> remote: Total 1234071 (delta 937064), reused 1101079 (delta 849256)</strong><br/><strong> Receiving objects: 100% (1234071/1234071), 529.69 MiB | 5.58 MiB/s, done.</strong><br/><strong> Resolving deltas: 100% (937064/937064), done.</strong></pre>
<p>Go to the GitLab installation folder:</p>
<pre><strong>$ cd /home/git/gitlab</strong></pre>
<p>Copy the <span>example</span> GitLab config:</p>
<pre><strong>$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml</strong></pre>
<p>Update the GitLab configuration file and follow the directions at the top of the file:</p>
<pre><strong>$ sudo -u git -H editor config/gitlab.yml</strong></pre>
<p>Copy the example secrets file:</p>
<pre><strong>$ sudo -u git -H cp config/secrets.yml.example config/secrets.yml</strong><br/><strong>$ sudo -u git -H chmod 0600 config/secrets.yml</strong></pre>
<p>Make sure GitLab can write to the <kbd>log/</kbd> and <kbd>tmp/</kbd> directories:</p>
<pre><strong>$ sudo chown -R git log/</strong><br/><strong>$ sudo chown -R git tmp/</strong><br/><strong>$ sudo chmod -R u+rwX,go-w log/</strong><br/><strong>$ sudo chmod -R u+rwX tmp/</strong></pre>
<p>Make sure GitLab can write to the <kbd>tmp/pids/</kbd> and <kbd>tmp/sockets/</kbd> directories:</p>
<pre><strong>$ sudo chmod -R u+rwX tmp/pids/</strong><br/><strong>$ sudo chmod -R u+rwX tmp/sockets/</strong></pre>
<p>Create the <kbd>public/uploads/</kbd> directory:</p>
<pre><strong>$ sudo -u git -H mkdir public/uploads/</strong></pre>
<p>Make sure that only the GitLab user has access to the <kbd>public/uploads/</kbd> directory, now that files in <kbd>public/uploads</kbd> are served by GitLab-Workhorse:</p>
<pre><strong>$ sudo chmod 0700 public/uploads</strong></pre>
<p>Change the permissions of the directory where CI job traces are stored:</p>
<pre><strong>$ sudo chmod -R u+rwX builds/</strong></pre>
<p>Change the permissions of the directory where CI artifacts are stored:</p>
<pre><strong>$ sudo chmod -R u+rwX shared/artifacts/</strong></pre>
<p>Change the permissions of the directory where GitLab pages are stored:</p>
<pre><strong>$ sudo chmod -R ug+rwX shared/pages/</strong></pre>
<p>Copy the example Unicorn configuration:</p>
<pre><strong>$ sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb</strong></pre>
<p>Find the number of cores:</p>
<pre><strong>$ nproc</strong></pre>
<p>Enable cluster mode if you expect to have a high load instance. Set the number of workers to at least the number of cores. For example, change the amount of workers to 3 for a 2 GB RAM server:</p>
<pre><strong>$ sudo -u git -H editor config/unicorn.rb</strong></pre>
<p>Copy the example Rack attack configuration:</p>
<pre><strong>$ sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb</strong></pre>
<p>Configuration of Git global settings for Git user <kbd>autocrlf</kbd> is needed for the web editor:</p>
<pre><strong>$ sudo -u git -H git config --global core.autocrlf input</strong></pre>
<p>Disable <kbd>git gc –auto</kbd> because GitLab already runs <kbd>git gc</kbd> when needed:</p>
<pre><strong>$ sudo -u git -H git config --global gc.auto 0</strong></pre>
<p>Enable packfile bitmaps:</p>
<pre><strong>$ sudo -u git -H git config --global repack.writeBitmaps true</strong></pre>
<p>Enable push options:</p>
<pre><strong>$ sudo -u git -H git config --global receive.advertisePushOptions true</strong></pre>
<p>Configure the Redis connection settings:</p>
<pre><strong>$ sudo -u git -H cp config/resque.yml.example config/resque.yml</strong></pre>
<p>Change the Redis socket path if you are not using the default Debian configuration:</p>
<pre><strong>$ sudo -u git -H editor config/resque.yml</strong></pre>
<p>Configure the GitLab database settings by copying the template for PostgreSQL to <kbd>database.yml</kbd>:</p>
<pre><strong>$ sudo -u git cp config/database.yml.postgresql config/database.yml</strong></pre>
<p class="mce-root">Now, update <kbd>config/database.yml</kbd>:</p>
<pre><strong>$ sudo -u git -H editor config/database.yml</strong></pre>
<p>At the very least, the lines to change are as follows:</p>
<pre><strong>password: "&lt;your secure password&gt;"</strong><br/><strong>host: &lt;your postgres host&gt;</strong></pre>
<p><span><span><kbd>"&lt;your secure password"</kbd> </span></span>is the password you created earlier, in the <em>SQL database</em> section of this chapter! The host is the hostname or IP address of your PostgreSQL database server.</p>
<p>Make <kbd>config/database.yml</kbd> readable to Git only:</p>
<pre><strong>$ sudo -u git -H chmod o-rwx config/database.yml</strong></pre>
<p class="mce-root">Install RubyGems (expect a lot of output):</p>
<pre><strong>$sudo -u git -H bundle install --deployment --without development test mysql aws kerberos<br/>...</strong></pre>
<p>The core GitLab application is now installed on the system. We need other components as well, such as GitLab Shell, GitLab Workhorse, and Gitaly. They will be explained in the next sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing GitLab Shell</h1>
                </header>
            
            <article>
                
<p>GitLab Shell is SSH access and repository management software developed specially for GitLab. You can install it as follows:</p>
<pre><strong>$ sudo -u git -H bundle exec rake gitlab:shell:install REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production SKIP_STORAGE_VALIDATION=true</strong></pre>
<p>By default, the <kbd>gitlab-shell</kbd> configuration is generated from your main GitLab configuration. You can review (and modify) the <kbd>gitlab-shell</kbd> configuration as follows:</p>
<pre><strong>$ sudo -u git -H editor /home/git/gitlab-shell/config.yml</strong></pre>
<p>Starting the service will be executed later.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing GitLab-Workhorse</h1>
                </header>
            
            <article>
                
<p>GitLab-Workhorse uses GNU (Gnu's Not Unix) make. The following command line will install GitLab-Workhorse in <kbd>/home/git/gitlab-workhorse</kbd>, which is the recommended location:</p>
<pre><strong>$ sudo -u git -H bundle exec rake "gitlab:workhorse:install[/home/git/gitlab-workhorse]" RAILS_ENV=production</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing Gitaly</h1>
                </header>
            
            <article>
                
<p>Fetch the Gitaly source with Git and compile with Go:</p>
<pre><strong>$ sudo -u git -H bundle exec rake "gitlab:gitaly:install[/home/git/gitaly,/home/git/repositories]" RAILS_ENV=production</strong></pre>
<p>Restrict Gitaly socket access:</p>
<pre><strong>$ sudo chmod 0700 /home/git/gitlab/tmp/sockets/private</strong><br/><strong>$ sudo chown git /home/git/gitlab/tmp/sockets/private</strong></pre>
<p>If you are using non-default settings, you need to update <kbd>config.toml</kbd>:</p>
<pre><strong>$ cd /home/git/gitaly</strong><br/><strong>$ sudo -u git -H editor config.toml</strong></pre>
<p>Make sure Gitaly is started:</p>
<pre><strong>$ sudo -u git bash -c "/home/git/gitlab/bin/daemon_with_pidfile /home/git/gitlab/tmp/pids//gitaly.pid /home/git/gitaly/gitaly /home/git/gitaly/config.toml &gt;&gt; /home/git/gitlab/log/gitaly.log 2&gt;&amp;1 &amp;"</strong></pre>
<p>Take a look at <kbd>/home/git/gitlab/log/gitaly.log</kbd> for errors and check whether Gitaly processes are in the <kbd>ps -ax</kbd> process list. It should run.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Initializing the database and activating advanced features</h1>
                </header>
            
            <article>
                
<p>Use the following command to initialize the database and activate advanced features:</p>
<pre><strong>$ cd /home/git/gitlab<br/>$ sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production force=yes</strong></pre>
<p>When done, you will see the following:</p>
<pre><strong>‘Administrator account created:'</strong></pre>
<p>You can continue the installation and eventually start GitLab, then the first person who accesses the login page will be given the option to supply a new admin password. This is probably not what you want, so there is a command to set this before starting. You have to supply the password, email, and variable to override the database check to make it work (answer yes to the prompt)<strong>:</strong></p>
<pre><strong>sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=yourpassword GITLAB_ROOT_EMAIL=youremail@gmail.com DISABLE_DATABASE_ENVIRONMENT_CHECK=1</strong></pre>
<p><span>So, if you don't set the password (and it is set to the default one), please wait to expose GitLab to the public internet until the installation is done and you've logged into the server the first time. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Final steps for preparing the system</h1>
                </header>
            
            <article>
                
<p>There are a few actions left before we start the GitLab application. </p>
<p>Back up your secrets file (where GitLab stores encryption keys):</p>
<pre><strong>sudo cp config/secrets.yml /to/somewhere/safe</strong></pre>
<p>Install the System V init script:</p>
<pre><strong>sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab</strong></pre>
<p>Active GitLab at boot time:</p>
<pre><strong>sudo update-rc.d gitlab defaults 21</strong></pre>
<p>Make sure log files are rotated frequently (to safe disk space):</p>
<pre><strong>sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab</strong></pre>
<p>Check whether GitLab and its environment<span> </span><span>a</span><span>re set correctly:</span></p>
<pre><strong>$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production</strong></pre>
<p>You will get an output such as the following:</p>
<pre><strong>System information</strong><br/><strong>System: Debian 9.8</strong><br/><strong>Current User: git</strong><br/><strong>Using RVM: no</strong><br/><strong>Ruby Version: 2.5.5p157</strong><br/><strong>Gem Version: 2.7.6.2</strong><br/><strong>Bundler Version:1.17.3</strong><br/><strong>Rake Version: 12.3.2</strong><br/><strong>Redis Version: 3.2.6</strong><br/><strong>Git Version: 2.11.0</strong><br/><strong>..</strong></pre>
<p>Everything on the system is configured to run GitLab and to make it survive a reboot.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Preparing to serve</h1>
                </header>
            
            <article>
                
<p>We are almost ready to start GitLab. First, we need to prepare the frontend to serve content.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Compiling GetText PO files</h1>
                </header>
            
            <article>
                
<p>Use the following command to compile GetText PO (portable object) files. This takes care of handling string values in different languages (you will see comparable output):</p>
<pre><strong>$sudo -u git -H bundle exec rake gettext:compile RAILS_ENV=production</strong><br/><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/ja</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/eo</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/zh_HK</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/fil_PH</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/ar_SA</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/en</strong><br/><strong>..</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Compiling assets</h1>
                </header>
            
            <article>
                
<p><span>Use the following command to compile assets with Yarn (receiving similar output):</span></p>
<pre><strong>$sudo -u git -H yarn install --production --pure-lockfile</strong><br/><strong>yarn install v1.15.2</strong><br/><strong>[1/5] Validating package.json...</strong><br/><strong>[2/5] Resolving packages...</strong><br/><strong>...</strong><br/><strong>Done in 48.37s.</strong></pre>
<p>Finally, use the following command to compile the last assets (similar output):</p>
<pre><strong>$sudo -u git -H bundle exec rake gitlab:assets:compile RAILS_ENV=production NODE_ENV=production</strong><br/><strong>warning Resolution field "ts-jest@24.0.0" is incompatible with requested version "ts-jest@^23.10.5" </strong><br/><strong>`yarn:check` finished in 4.2137985 seconds</strong><br/><strong>Created app.js in /home/git/gitlab/app/assets/javascripts/locale/ja</strong><br/><strong>...</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Starting your GitLab instance</h1>
                </header>
            
            <article>
                
<p>Use the following command to start your GitLab instance:</p>
<pre><strong>sudo service gitlab start</strong></pre>
<p>Or use the following command:</p>
<pre><strong>sudo /etc/init.d/gitlab restart</strong></pre>
<p>If successful, you should see output similar to the following when retrieving the status:</p>
<pre><strong>root@93d7eb73dce6:/home/git/gitlab# sudo service gitlab status</strong><br/><strong>Starting GitLab Unicorn</strong><br/><strong>Starting GitLab Sidekiq</strong><br/><strong>Starting GitLab Workhorse</strong><br/><strong>Gitaly is already running with pid 2877, not restarting</strong><br/><strong>The GitLab Unicorn web server with pid 5240 is running.</strong><br/><strong>The GitLab Sidekiq job dispatcher with pid 5312 is running.</strong><br/><strong>The GitLab Workhorse with pid 5290 is running.</strong><br/><strong>Gitaly with pid 2877 is running.</strong><br/><strong>GitLab and all its components are up and running.</strong></pre>
<p>The main application is running, so now, we need to put NGINX in front as a reverse proxy.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">NGINX</h1>
                </header>
            
            <article>
                
<p>The role of this component in the GitLab architecture is well described in <a href="384dcfd9-ef7f-470d-89dc-3af7502a2d09.xhtml">Chapter 1</a>, <em>Introducing the GitLab Architecture</em>. It functions as a reverse proxy, and buffers HTTP requests from clients before they are sent to the Unicorn application server. The default NGINX that comes with Debian is too old for use with GitLab. That is why we have to install a newer one (&gt; 1.12.1).</p>
<p>Add a public repository key and an <kbd>apt</kbd> repository URL for <span>NGINX</span> so we can install the NGINX package via <kbd>apt-get</kbd>:</p>
<pre><strong>#key </strong><br/><strong>$ cd /tmp/ &amp;&amp; wget http://nginx.org/keys/nginx_signing.key </strong><br/><strong>sudo apt-key add nginx_signing.key </strong><br/><strong>#repo </strong><br/><strong>$ sudo bash -c 'echo "deb http://nginx.org/packages/mainline/debian/ stretch nginx" &gt; /etc/apt/sources.list.d/nginx.list' </strong><br/><strong>$ sudo apt-get update</strong></pre>
<p>Now, install the latest NGINX:</p>
<pre><strong>$ sudo apt-get install -y nginx</strong></pre>
<p>Copy the GitLab custom NGINX configuration files that are in our GitLab installation folder to the NGINX configuration folder:</p>
<pre><strong>$ cd /home/gitlab/gitlab;sudo cp lib/support/nginx/gitlab /etc/nginx/conf.d/gitlab.conf</strong> </pre>
<p>Change settings if needed (for example, change the <kbd>server_name YOUR_SERVER_FQDN</kbd> line to the DNS name of your GitLab application server):</p>
<pre><strong>$ sudo editor </strong><strong>/etc/nginx/conf.d/gitlab.conf</strong> </pre>
<p>Delete the default NGINX configuration file:</p>
<pre><strong>$ sudo rm -f /etc/nginx/conf.d/default*</strong></pre>
<p>Restart NGINX to activate the configuration:</p>
<pre><strong>sudo service nginx restart</strong></pre>
<p>In case of any errors, look in <kbd>/var/log/nginx/gitlab_error.log</kbd>. Now, you should find GitLab running.</p>
<p>Go to your new GitLab application server in your web browser for your first GitLab login. Remember that if you did not create a password earlier at <kbd>Run gitlab:setup</kbd>, you will be presented with a form to provide a password for the administrator account. The default <kbd>username = 'root'</kbd> can be changed later. You can set up the password now and log in again to start doing work! </p>
<p>The installation is finished!</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using it from Docker</h1>
                </header>
            
            <article>
                
<p class="mce-root">The future is in containers. It has been said for years, and now it is almost fact. Running applications in containers provides many advantages. It requires much less operating system overhead because containers share the capacity of the underlying operating system. GitLab provides GitLab Docker images via Docker Hub, the central registry on the internet for official Docker images.</p>
<p class="mce-root">Both GitLab CE and EE are available and are called <kbd>gitlab/gitlab-ce</kbd> and <kbd>gitlab/gitlab-ee</kbd>. GitLab Docker images are feature complete images of GitLab and they run all the services in a single container.</p>
<p class="mce-root">Containers can run in different environments, but let's start with the following:</p>
<ul>
<li class="mce-root">Run the image in Docker Engine directly.</li>
<li class="mce-root">Run GitLab using <kbd>docker-compose</kbd>.</li>
</ul>
<p class="mce-root">You really need Docker software for this. See the official installation docs (<a href="https://tuleap-documentation.readthedocs.io/en/latest/developer-guide/quick-start/install-docker.html">https://tuleap-documentation.readthedocs.io/en/latest/developer-guide/quick-start/install-docker.html</a>) for how to install it.</p>
<p class="mce-root">Docker is not officially supported <span>on Windows</span>. You might encounter problems with volume permissions and other unknown issues. Try at your own risk and maybe find help on <strong>Internet Relay Chat</strong> (<strong>IRC</strong>) in the forums.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Running the image directly</h1>
                </header>
            
            <article>
                
<p class="mce-root">Before running the image, make sure you have a directory available for storing configuration, logs, and data (or be prepared to lose data). Normally, we create directories in our home folder, but a better idea is to use the <strong>Filesystem Hierarchy Standard</strong> (<strong>FHS</strong>), a community supported standard of where to put stuff. <kbd>/src</kbd> seems perfect for storing container data (see <a href="http://tldp.org/LDP/Linux-Filesystem-Hierarchy/html/srv.html">http://tldp.org/LDP/Linux-Filesystem-Hierarchy/html/srv.html</a>). GitLab also uses this convention in their samples.</p>
<p class="mce-root">The GitLab container uses host-mounted volumes to store persistent data:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td><strong><span>Local directory</span></strong></td>
<td><strong><span>Container location</span></strong></td>
<td><strong><span>Purpose</span></strong></td>
</tr>
<tr>
<td><kbd><span>/srv/gitlab/data</span></kbd></td>
<td><kbd><span>/var/opt/gitlab/data</span></kbd></td>
<td><span>For storing application data.</span></td>
</tr>
<tr>
<td><kbd><span>/srv/gitlab/logs</span></kbd></td>
<td><kbd><span>/var/log/gitlab</span></kbd></td>
<td><span>For storing logs.</span></td>
</tr>
<tr>
<td><kbd><span>/srv/gitlab/config</span></kbd></td>
<td><kbd><span>/etc/gitlab</span></kbd></td>
<td><span>For storing the GitLab configuration files.</span></td>
</tr>
</tbody>
</table>
<p> </p>
<p class="mce-root">If you want to use other local directories, that is fine, but the container locations are needed for GitLab to function correctly.</p>
<p class="mce-root">Now, run the <kbd>gitlab-ce</kbd> image:</p>
<pre class="mce-root"><strong>sudo docker run \</strong><br/><strong> --hostname gitlab.joustie.nl \</strong><br/><strong> --publish 443:443 --publish 80:80 --publish 22:22 \</strong><br/><strong> --name gitlab \</strong><br/><strong> --volume /srv/gitlab/config:/etc/gitlab \</strong><br/><strong> --volume /srv/gitlab/logs:/var/log/gitlab \</strong><br/><strong> --volume /srv/gitlab/data:/var/opt/gitlab \</strong><br/><strong> gitlab/gitlab-ce:latest</strong></pre>
<p class="mce-root">Running it this way will run it in the foreground and you'll be able to see the console. You can add <kbd>--detach</kbd> to run the image in the background.</p>
<p class="mce-root">Starting with <kbd>--publish</kbd> (or <kbd>-p</kbd> for short) will make<span> the </span><span>ports</span> required to access SSH, HTTP, and HTTPS  available. All GitLab data will be stored as subdirectories of <kbd>/srv/gitlab/</kbd>.</p>
<p class="mce-root">Adding <kbd>--restart always \</kbd> as an option will make the container automatically start after a system reboot.</p>
<p class="mce-root">If you're on SELinux and don't want it cause permission problems, you can put  '<kbd>Z </kbd>'after your volumes (<kbd>--volume /srv/gitlab/data:/var/opt/gitlab:Z</kbd>). Docker will then execute a shell command: <kbd>chcon -Rt svirt_sandbox_file_t</kbd> for that location.</p>
<p class="mce-root">You can check whether the container is running with the following:</p>
<pre class="mce-root"><strong>docker ps</strong></pre>
<p>You should see a list of running containers, including one that is named <kbd>gitlab</kbd>. In this example, you can now access this container at <a href="http://gitlab.joustie.nl">http://gitlab.joustie.nl</a><a href="http://gitlab.joustie.nl">.</a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring GitLab after startup</h1>
                </header>
            
            <article>
                
<p>Because the containers provided by GitLab use the official omnibus package, all configuration actions are centered around the <kbd>gitlab.rb</kbd> file.</p>
<p class="mce-root">The software inside the container is provisioned using the omnibus GitLab install, so that means <kbd>/etc/gitlab/gitlab.rb</kbd> is used inside the container. You can edit the file by entering the container with a shell:</p>
<pre class="mce-root"><strong>sudo docker exec -it gitlab /bin/bash</strong></pre>
<p class="mce-root">Another way is to directly edit the <kbd>gitlab.rb</kbd> file in a Docker command:</p>
<pre class="mce-root"><strong>sudo docker exec -it gitlab vi /etc/gitlab/gitlab.rb</strong></pre>
<p class="mce-root">You will have to set <kbd>external_url</kbd> to something valid in the <kbd>gitlab.rb</kbd> file as well to make repository links in GitLab work correctly. When you are there, you can check other settings as well, such as enabling HTTPS, and very importantly, an SMTP server to use for mail. The Docker image does not have an SMTP server included.</p>
<p class="mce-root">When you are finished making the changes you want, you will have to restart the container to reconfigure GitLab (it does so every time at restart):</p>
<pre class="mce-root"><strong>sudo docker restart gitlab</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Starting the container with configuration settings as input</h1>
                </header>
            
            <article>
                
<p class="mce-root">You can start the GitLab container and let it configure itself at startup by adding the <kbd>GITLAB_OMNIBUS_CONFIG</kbd> environment variable to the <kbd>docker run</kbd> command.</p>
<p class="mce-root">Put any settings from <kbd>gitlab.rb</kbd> in it that you'd like and they will be loaded in the container start procedure before the internal <kbd>gitlab.rb</kbd> file. Some examples from the omnibus-gitlab template are as follows and you can add it as argument to docker:</p>
<pre class="mce-root"><strong>--env GITLAB_OMNIBUS_CONFIG="external_url '</strong><br/><strong>external_url 'GENERATED_EXTERNAL_URL' \</strong><br/><strong>gitlab_rails['smtp_enable'] = true \</strong><br/><strong>gitlab_rails['smtp_address'] = "smtp.server" \</strong><br/><strong>gitlab_rails['smtp_port'] = 465"</strong><br/><strong>gitlab_rails['gitlab_shell_ssh_port'] = 2222</strong></pre>
<p class="mce-root">Here's an example that sets the external URL and sets the SMTP server address while starting the container:</p>
<pre class="mce-root"><strong>sudo docker run --detach \</strong><br/><strong> --hostname gitlab.joustie.nl \</strong><br/><strong> --env GITLAB_OMNIBUS_CONFIG="external_url 'http://gitlab.joustie.nl'; gitlab_rails['smtp_address'] = "smtp.server" " \</strong><br/><strong> --publish 443:443 --publish 80:80 --publish 22:22 \</strong><br/><strong> --name gitlab \</strong><br/><strong> --restart always \</strong><br/><strong> --volume /srv/gitlab/config:/etc/gitlab \</strong><br/><strong> --volume /srv/gitlab/logs:/var/log/gitlab \</strong><br/><strong> --volume /srv/gitlab/data:/var/opt/gitlab \</strong><br/><strong> gitlab/gitlab-ce:latest</strong></pre>
<p class="mce-root">You can add more environment variables, which are documented here: <a href="https://docs.gitlab.com/ee/administration/environment_variables.html">https://docs.gitlab.com/ee/administration/environment_variables.html</a>.</p>
<p class="mce-root">It can take some time for the container to be operational. After starting and configuring, GitLab is reachable via your browser at <kbd>https://localhost</kbd>.</p>
<p class="mce-root">The first time you see the GitLab login page, an admin password has to be set up. After you have chosen one and submitted it, you can use it to log in.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading GitLab</h1>
                </header>
            
            <article>
                
<p class="mce-root">Even in a container, upgrading GitLab is sometimes necessary. The easy way is as follows:</p>
<ol>
<li class="mce-root">Stop the currently active container:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>sudo docker stop gitlab (or sha)</strong></pre>
<ol start="2">
<li class="mce-root">Remove the existing instance:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>sudo docker rm gitlab (or sha)</strong></pre>
<ol start="3">
<li class="mce-root">Pull the new image:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>sudo docker pull gitlab/gitlab-ce:latest</strong></pre>
<ol start="4">
<li class="mce-root">Recreate the container in the same way as earlier:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>sudo docker run --detach \</strong><br/><strong>--hostname gitlab.joustie.nl \</strong><br/><strong>--publish 443:443 --publish 80:80 --publish 22:22 \</strong><br/><strong>--name gitlab \</strong><br/><strong>--restart always \</strong><br/><strong>--volume /srv/gitlab/config:/etc/gitlab \</strong><br/><strong>--volume /srv/gitlab/logs:/var/log/gitlab \</strong><br/><strong>--volume /srv/gitlab/data:/var/opt/gitlab \</strong><br/><strong>gitlab/gitlab-ce:latest</strong></pre>
<p class="mce-root">When the container starts again, it will reconfigure and update itself (it will perform a <kbd>gitlab-ctl reconfigure</kbd>).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Run GitLab CE on a different IP address</h1>
                </header>
            
            <article>
                
<p class="mce-root">Using the same <kbd>--publish</kbd> <span>mechanism, </span>you can specify not only the port but also the IP address that Docker will use.</p>
<p class="mce-root">To run the latest GitLab CE on IP-address <kbd>192.168.1.1</kbd>, use the following command:</p>
<pre class="mce-root"><strong>sudo docker run --detach \</strong><br/><strong> --hostname gitlab.joustie.nl \</strong><br/><strong> --publish 192.168.1.1:443:443 \</strong><br/><strong> --publish 192.168.1.1:80:80 \</strong><br/><strong> --publish 192.168.1.1:22:22 \</strong><br/><strong> --name gitlab \</strong><br/><strong> --restart always \</strong><br/><strong> --volume /srv/gitlab/config:/etc/gitlab \</strong><br/><strong> --volume /srv/gitlab/logs:/var/log/gitlab \</strong><br/><strong> --volume /srv/gitlab/data:/var/opt/gitlab \</strong><br/><strong> gitlab/gitlab-ce:latest</strong></pre>
<p class="mce-root">Now, GitLab is accessible at <kbd>http://192.168.1.1</kbd> and <kbd>https://192.168.1.1</kbd>. A <kbd>docker-compose.yml</kbd> example that uses different ports can be found in the <em>Install GitLab using Docker Compose</em> section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Debugging the container</h1>
                </header>
            
            <article>
                
<p class="mce-root">Sometimes, a container does not behave the way you expect it to. How can you debug this?<br/>
First, you can check the container logs:</p>
<pre class="mce-root"><strong>sudo docker logs gitlab</strong></pre>
<p class="mce-root">Enter the running container:</p>
<pre class="mce-root"><strong>sudo docker exec -it gitlab /bin/bash</strong></pre>
<p class="mce-root">You now have root access to the GitLab container and you can view the situation as if you were in a VM running omnibus-gitlab.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Install GitLab using Docker Compose</h1>
                </header>
            
            <article>
                
<p class="mce-root">Docker Compose is used to run multiple containers as a single service. By using this tool, you can easily manage your Docker-based GitLab installation. It can be used to configure, install, and upgrade the service. It is Python-based and can be installed from <a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a>.</p>
<p class="mce-root">If you have installed Docker Compose, or already have it on your system, you can build your service.</p>
<p class="mce-root">Create a <kbd>docker-compose.yml</kbd> file (or download an example):</p>
<pre class="mce-root"><strong>web:</strong><br/><strong> image: 'gitlab/gitlab-ce:latest'</strong><br/><strong> restart: always</strong><br/><strong> hostname: 'gitlab.joustie.nl'</strong><br/><strong> environment:</strong><br/><strong> GITLAB_OMNIBUS_CONFIG: |</strong><br/><strong> external_url 'https://gitlab.joustie.nl'</strong><br/><strong> ports:</strong><br/><strong> - '80:8080'</strong><br/><strong> - '443:4443'</strong><br/><strong> - '22:2222'</strong><br/><strong> volumes:</strong><br/><strong> - '/srv/gitlab/config:/etc/gitlab'</strong><br/><strong> - '/srv/gitlab/logs:/var/log/gitlab'</strong><br/><strong> - '/srv/gitlab/data:/var/opt/gitlab'</strong></pre>
<p class="mce-root">Check the port settings. This is the same as using <kbd>--publish 80:9090</kbd> or <kbd>-p 2224:22</kbd> with pure <kbd>docker</kbd> and not <kbd>docker-compose</kbd>.</p>
<p class="mce-root">Make sure you are in the same directory as <kbd>docker-compose.yml</kbd> and run the following:</p>
<pre class="mce-root"><strong>docker-compose up -d</strong> </pre>
<p class="mce-root">GitLab will start and run an omnibus-gitlab reconfigure during boot to set up GitLab. To add more configuration settings at startup, follow the instructions mentioned previously to add directives to the <kbd>GITLAB_OMNIBUS_CONFIG</kbd> variable.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updating GitLab using Docker Compose</h1>
                </header>
            
            <article>
                
<p>We have seen several ways to run Docker containers. You can run them standalone (plain Docker), or create sets of containers that can work together with services (Docker Compose). The next step is to orchestrate containers.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying GitLab using Kubernetes</h1>
                </header>
            
            <article>
                
<p class="mce-root">After some years of uncertainty, Google's <strong>Kubernetes</strong> has emerged as the premier container orchestration tool. Every major cloud vendor has integration for its API. This does not automatically mean that it works the same everywhere. Because the product has been developing so quickly, you will notice differences.</p>
<p class="mce-root">The fastest way to deploy GitLab on a Kubernetes cluster is by using Helm charts. Avoiding the management of each separate resource on a cluster, <strong>Helm</strong> bundles these resources in an application model: a chart. It works like a package management system in which applications are registered. Information on how to install, configure, and upgrade this application is contained in this package.</p>
<p class="mce-root">Helm consists of a server called <strong>Tiller</strong>, which that lives in the Kubernetes cluster, and Helm, the command-line client that talks to the Tiller server.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab Runner Helm chart</h1>
                </header>
            
            <article>
                
<p class="mce-root">With this chart, you can create scalable GitLab Runners. It will use the Kubernetes executor. When it receives a new job to process from GitLab CI, a new pod will be created in a specified namespace.</p>
<p class="mce-root">First, add the Helm repository:</p>
<pre class="mce-root"><strong>helm repo add gitlab https://charts.gitlab.io helm init</strong></pre>
<p class="mce-root">Before you can start this Runner, you need to create a <kbd>.yml</kbd> file with parameters (we named it <kbd>values.yml</kbd>). There is a template available at <a href="https://gitlab.com/charts/gitlab-runner/blob/master/values.yaml">https://gitlab.com/charts/gitlab-runner/blob/master/values.yaml</a>. The settings are explained in the template file.</p>
<p>The minimum you should fill in is as follows:</p>
<pre>gitlabUrl: https://gitlab.home.joustie.nl/<br/>runnerRegistrationToken: "dE47NAgHgnFRpdd23RiDJ9JOSzBH40mxqLa1B42Ds5eb94ZWebhPydPt9n"</pre>
<p class="mce-root">After the configuration of <kbd>values.yml</kbd>, you can start the deployment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying of a GitLab Runner to Kubernetes</h1>
                </header>
            
            <article>
                
<p>Initiate the deployment with the following command <span>(replace <kbd>yournamespace</kbd> with something you prefer):</span></p>
<pre class="mce-root"><strong>helm install --namespace yournamespace --name gitlab-runner -f values.yml gitlab/gitlab-runner</strong></pre>
<p>After a short time, you should find your Runner listed in the <em>Runners</em> section of the administration pages in GitLab.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab Helm chart</h1>
                </header>
            
            <article>
                
<p class="mce-root">This is the official and recommended way to install GitLab on a cloud native environment. This chart contains all the necessary components to get started, and you can scale up deployments easily. This specific chart is the optimal way to run GitLab in a Kubernetes cluster.</p>
<p class="mce-root">The default deployment includes the following:</p>
<ul>
<li class="mce-root"><strong>Core GitLab components</strong>:
<ul>
<li><strong>Unicorn</strong>: The pre-forking Ruby on Rails web server</li>
<li><strong>GitLab Shell</strong>: The Ruby wrapper around Git on the server, enabling <strong>Git-over-SSH</strong></li>
<li><strong>GitLab Workhorse</strong>: The smart reverse proxy, taking on big HTTP-requests</li>
<li><strong>Registry</strong>: The GitLab container registry</li>
<li><strong>Sidekiq</strong>: The backend services for GitLab, taking care of merge requests, emails, and <span>other asynchronous jobs</span></li>
<li><strong>Gitaly</strong>: The storage layer abstraction for Git operations</li>
</ul>
</li>
<li><strong>Extra optional dependencies</strong>:
<ul>
<li><strong>Redis</strong>: The caching key value store, database multi-tool can speed up processing</li>
<li><strong>Minio</strong>: An object storage server with an Amazon S3 compatible interface</li>
</ul>
</li>
<li class="mce-root"><strong>Bonus material</strong>:
<ul>
<li><strong>An autoscaling, unprivileged GitLab Runner using the Kubernetes executor</strong>: If you run GitLab through Kubernetes, a dedicated GitLab runner is part of the design.</li>
<li><strong>Automatically provisioned SSL via Let's Encrypt</strong>: When you provide Kubernetes with an administrator and a domain name, the Let's Encrypt automation builtin can setup SSL for you.</li>
</ul>
</li>
</ul>
<p class="mce-root">As with the GitLab Docker image, the GitLab chart is a feature completed for the core product and takes a few minutes to deploy. Deploying GitLab using the Helm chart takes 5 to 10 minutes depending on your hardware or service location. It is also possible to run certain components outside of the Kubernetes cluster; this is also what you do in production, normally. It is better to keep your application state out of the cluster.</p>
<p>These are the requirements for deploying GitLab to Kubernetes:</p>
<ul>
<li>You need Helm version  &gt;2.9 and <kbd>kubectl</kbd> &gt;1.8 (about 1 minor release version difference with your cluster).</li>
<li>A Kubernetes cluster using version &gt;1.8 with a minimum of 6 vCPUs and 16 GB RAM.</li>
<li>The cluster can be a Google GKE, Amazon EKS, or Microsoft AKS-based cluster, or a local one using Minikube, for example.</li>
</ul>
<ul>
<li>You should be able to easily configure  a wildcard DNS entry for your domain (for example, <kbd>*.example.com</kbd>) and an external IP.</li>
<li>You can connect and log in to the cluster.</li>
<li>A configured and initialized Helm Tiller running.</li>
</ul>
<p>To make sure Helm is configured and initialized, run the following command:</p>
<pre><strong><span>$ helm repo add gitlab https://charts.gitlab.io/</span></strong><br/><strong><span>$ helm repo update</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying GitLab to Kubernetes</h1>
                </header>
            
            <article>
                
<p class="mce-root">To deploy GitLab, the following three parameters are required:</p>
<ul>
<li><kbd>global.host.domain</kbd>: Should point to your wildcard DNS domain</li>
<li><kbd>global.hosts.externalIP</kbd>: The external IP address for the cluster</li>
<li><kbd>certmanager-issues.email</kbd>: The email address that is used for issuing certificates (Let's Encrypt)</li>
</ul>
<p class="mce-root">So, when you only have a few parameters such as these, just run the command:</p>
<pre class="mce-root"><strong>$ helm upgrade --install gitlab gitlab/gitlab \</strong><br/><strong>--timeout 600 \</strong><br/><strong>--set global.hosts.domain=home.joustie.nl \</strong><br/><strong>--set global.hosts.externalIP=&lt;your external ip&gt; \</strong><br/><strong>--set certmanager-issuer.email=admin@joustie.nl</strong></pre>
<p>You can also run a deployment using a <kbd>values.yml</kbd> file, just like the GitLab Runners chart. You can find examples at <a href="https://gitlab.com/charts/gitlab/tree/master/examples">https://gitlab.com/charts/gitlab/tree/master/examples</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Monitoring the deployment</h1>
                </header>
            
            <article>
                
<p>After running the <kbd>helm upgrade --install</kbd> command, it can take several minutes before output is returned. It should look a bit like the following:</p>
<pre class="mce-root"><strong>Release "gitlab" does not exist. Installing it now.</strong><br/><strong>NAME: gitlab</strong><br/><strong>LAST DEPLOYED: Wed Jan 2 12:31:31 2019</strong><br/><strong>NAMESPACE: default</strong><br/><strong>STATUS: DEPLOYED</strong><br/><strong>RESOURCES:</strong><br/><strong>==&gt; v1/PersistentVolumeClaim</strong><br/><strong>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE</strong><br/><strong>gitlab-minio Bound pvc-fc207fb5-0e81-11e9-b9ef-025000000001 10Gi RWO hostpath 9s</strong><br/><strong>gitlab-postgresql Bound pvc-fc2158a3-0e81-11e9-b9ef-025000000001 8Gi RWO hostpath 9s</strong><br/><strong>gitlab-prometheus-server Bound pvc-fc2240b5-0e81-11e9-b9ef-025000000001 8Gi RWO hostpath 9s</strong><br/><strong>gitlab-redis Bound pvc-fc236cfb-0e81-11e9-b9ef-025000000001 5Gi RWO hostpath 9s</strong></pre>
<p>Afterwards (or during the deployment in another session), you can issue a <kbd>helm status gitlab</kbd> command to see info about the deployment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Initial login</h1>
                </header>
            
            <article>
                
<p>If everything went well, you will find your installation by adding GitLab to your wildcard DNS name, in the case of our preceding example, <kbd>gitlab.home.joustie.nl</kbd>.</p>
<p>We have not yet specified a root password for the initial administrator user in GitLab. During the deployment on Kubernetes, a random password was automatically created. You can fetch this password with the following command from Terminal (replace <kbd>name</kbd> with your deployment name; for us, it is <kbd>gitlab</kbd>):</p>
<pre class="mce-root"><strong>kubectl get secret &lt;name&gt;-gitlab-initial-root-password -ojsonpath={.data.password} | base64 --decode ; echo</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Outgoing email</h1>
                </header>
            
            <article>
                
<p><span>If you do not specify it, there is no outgoing email enabled. You have to enable it by specifying some settings. The following is the <kbd>install</kbd> command if you set the options right away:</span></p>
<pre class="mce-root"><strong>$ helm upgrade --install gitlab gitlab/gitlab \</strong><br/><strong> --timeout 600 \</strong><br/><strong> --set global.hosts.domain=home.joustie.nl \</strong><br/><strong> --set global.hosts.externalIP=&lt;your external ip&gt; \</strong><br/><strong> --set certmanager-issuer.email=admin@joustie.nl \</strong><br/><strong> --set global.smtp.enabled=true \</strong><br/><strong> --set global.smtp.address=smtp.xs4all.nl \</strong><br/><strong> --set global.smtp.port=25</strong></pre>
<p>Also, make sure there is no firewall preventing traffic in between. Clusters on <strong>Google Kubernetes Engine</strong> (<strong><span>GKE</span></strong>) have their SMTP ports blocked by default.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updating GitLab using the Helm chart</h1>
                </header>
            
            <article>
                
<p class="mce-root">Once your GitLab chart is installed, configuration changes and chart updates should be done using the Helm upgrade.</p>
<p>If you would like to upgrade GitLab or change settings, use the following procedure:</p>
<pre class="mce-root"><strong>#update the chart</strong><br/><strong>helm repo add gitlab https://charts.gitlab.io/</strong><br/><strong>helm repo update</strong><br/><strong>#get the current values</strong><br/><strong>helm get values gitlab &gt; gitlab.yaml</strong></pre>
<p class="mce-root">Edit the <kbd>gitlab.yaml</kbd> file, looking at the possible values here: <a href="https://gitlab.com/charts/gitlab/blob/master/values.yaml">https://docs.gitlab.com/charts/installation/command-line-options.html</a>.</p>
<p class="mce-root">Save and apply the settings file:</p>
<pre class="mce-root"><strong>helm upgrade gitlab gitlab/gitlab -f gitlab.yaml</strong></pre>
<p>The command should return a lot of output, but it should mention the following:</p>
<pre class="p1"><strong><span class="s1">STATUS: DEPLOYED</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Uninstalling GitLab using the Helm chart</h1>
                </header>
            
            <article>
                
<p class="mce-root">To uninstall the GitLab chart, run the following:</p>
<pre class="mce-root"><strong>helm delete gitlab</strong></pre>
<p>You can run <kbd>helm status</kbd> afterwards to see if the action has been completed.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating droplets on DigitalOcean</h1>
                </header>
            
            <article>
                
<p><strong>DigitalOcean</strong> is a cloud provider, originating from New York. It has been a darling of developers for years. It offers an API, integrations, and affordable pricing to run your application workloads and VMs.</p>
<p>There are two ways of installing GitLab on DigitalOcean. You can create VMs (<strong>droplets</strong>) yourself and configure them using the omnibus installer or install them from source yourself. An even better way is to use the predefined GitLab droplet image that is already available on the site. When creating a droplet, you can specify this image.</p>
<p>When you log in to DigitalOcean, you can go to your droplets page and create a new one:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/17e0baa6-bf2d-4236-b120-12445d83cade.png"/></p>
<div>
<p>Determine the options for a droplet:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8c06f277-8177-4aab-a508-bb52fc4b6683.png"/></p>
</div>
<p class="CDPAlignLeft CDPAlign"><span>After logging in, you will be asked to set some options:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/97bd881e-0afb-4486-842e-8bb56139a0ef.png" style="width:35.50em;height:18.58em;"/></p>
<div>
<p>The droplet is ready. <span>The system will reboot and reconfigure itself.</span> If the login does not work, l<span>og in via SSH as a root to your droplet and execute the following command:</span></p>
</div>
<pre class="mce-root"><strong>tail -100 /var/log/gitlab_set_pass.log</strong></pre>
<p class="mce-root">Take a look at this:</p>
<pre class="mce-root"><strong>Could not create the default administrator account:</strong><br/><strong>–&gt; Password is too short (minimum is 8 characters)</strong></pre>
<p class="mce-root">If this is visible, we have to try to set the password again using one of the methods available in the omnibus package. Add the following line to the <kbd>/etc/gitlab/gitlab.rb</kbd> file:</p>
<pre class="mce-root"><strong>gitlab_rails[‘initial_root_password'] = ‘nonstandardpassword'</strong></pre>
<p class="mce-root">Then, execute the following in order to re-seed the database (it is empty, so that doesn't matter) and reset the admin password:</p>
<pre class="mce-root"><strong>gitlab-rake gitlab:setup</strong></pre>
<p class="mce-root">After some time, you should receive the following output:</p>
<pre class="mce-root"><strong>Administrator account created:</strong><br/><strong>login: root password: You'll be prompted to create one on your first visit.</strong><strong> </strong></pre>
<p class="mce-root">If you go to the URL of your new GitLab instance, you can set the password as shown:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c3d4d948-76fc-4e9d-bdec-e013a5a1a8ac.png" style="width:66.75em;height:29.33em;"/></p>
<p class="mce-root">Enjoy your GitLab!</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<div>
<p><span>In this chapter, we discussed the different ways of installing GitLab. The Linux platform was the chosen OS for which we provided instructions and examples. We started with the recommended way of installing for most organizations, using the omnibus package. </span></p>
<p><span>It is also possible to install GitLab from scratch and to run it from source. </span></p>
<p><span>It is also possible to run GitLab from a Docker container. We also showed you how to update Docker-based GitLab installs and gave an example of using Docker Compose to create a multi-container installation. </span><span>Finally, we talked about the fact that, when scaling, you probably would like several containers deployed and managed. We showed you how to achieve this with Kubernetes as the orchestration tool.</span></p>
<p>In the next chapter, we will dive into the process of configuring GitLab after the initial installation.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li><span>What is the recommended way of installing GitLab?</span></li>
<li><span>At the least, which ports do you need to open on your firewall?</span></li>
<li><span>On what platforms can you install GitLab using the omnibus package?</span></li>
<li><span>What is the basic administration command you use in an omnibus-based install?</span></li>
<li><span>What version of Git is the minimum you need on a source-based GitLab install?</span></li>
<li><span>What PostgreSQL extension do you need to enable for GitLab in a source-based GitLab install?</span></li>
<li><span>What is the name of the official GitLab CE Docker images?</span></li>
<li><span>What is the location of site-specific data according to <strong>Linux Filesystem Hierarchy</strong> (<strong>LFH</strong>)?</span></li>
<li><span>What programming language do you need to have installed to run Docker Compose?</span></li>
<li><span>What is the recommended way of deploying GitLab components to Kubernetes?</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li><span><em>Learn Docker - Fundamentals of Docker 18.x</em> by <em>Gabriel N. Schenker</em>: <a href="https://www.packtpub.com/in/networking-and-servers/learn-docker-fundamentals-docker-18x">https://www.packtpub.com/in/networking-and-servers/learn-docker-fundamentals-docker-18x</a></span></li>
<li><span><em>Develop and Operate Microservices on Kubernetes</em> by <em>Martin Helmich</em>: <a href="https://www.packtpub.com/in/virtualization-and-cloud/develop-and-operate-microservices-kubernetes-video">https://www.packtpub.com/in/virtualization-and-cloud/develop-and-operate-microservices-kubernetes-video</a></span></li>
<li><span>GitLab install documentation: <a href="https://about.gitlab.com/install/">https://about.gitlab.com/install/</a></span></li>
</ul>


            </article>

            
        </section>
    </body></html>