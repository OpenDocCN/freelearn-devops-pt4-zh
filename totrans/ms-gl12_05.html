<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Configuring GitLab from the Terminal</h1>
                </header>
            
            <article>
                
<p>After installing GitLab, you probably have a running instance. So, how do you manage it? In the previous chapter, we showed you the options that can be managed through the web interface. But there are many more options that can be set only through the configuration files on the server. You need to know how to configure the software in a regular terminal. This chapter will explain how this is achieved for the different types of GitLab installations.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Configuring omnibus installations from the terminal</li>
<li>Configuring source installations</li>
<li>Reconfiguring GitLab Docker containers</li>
<li>Changing GitLab in a Kubernetes environment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>For managing omnibus installations, there is one central configuration file called <kbd>gitlab.rb</kbd>. You need to create it or copy an example. There is a template available. You can find it at <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template</a>. It is not updated after upgrades. Throughout this chapter, we will quote and discuss parts of this file.</p>
<p>To follow along with the instructions in this chapter, please download the Git repository available at GitHub: <a href="https://github.com/PacktPublishing/Mastering-GitLab-12/tree/master/Chapter04" target="_blank">https://github.com/PacktPublishing/Mastering-GitLab-12/tree/master/Chapter04</a>.</p>
<p>You will also need the following:</p>
<ul>
<li><strong>Docker</strong>: <a href="https://www.docker.com">https://www.docker.com</a></li>
<li><strong>kubectl</strong>: <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring omnibus and GitLab installations from the terminal</h1>
                </header>
            
            <article>
                
<p>You can find the template for <kbd>gitlab.rb</kbd> at <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template</a>. It is not updated after upgrades.</p>
<p>You can also use omnibus or GitLab to implement <strong>high availability</strong> (<strong>HA</strong>) for your GitLab installation.</p>
<p>There is a part in <kbd>gitlab.rb</kbd> where you can define the role of the GitLab instance you are configuring. If there are no roles defined by default, omnibus will configure your server to host all the core components of GitLab.</p>
<p>For instance, add the following line of code if your instance will run as a Redis master, and have the Redis sentinel agent running:</p>
<pre> <strong>roles ['redis_sentinel_role', 'redis_master_role']</strong></pre>
<p>The following roles are available: </p>
<ul>
<li><kbd>redis_sentinel_role</kbd>: Enables the sentinel service only.</li>
<li><kbd>redis_master_role</kbd>: Enables Redis and monitoring, and allows you to configure the master password.</li>
<li><kbd>redis_slave_role</kbd>: Enables the Redis service and monitoring.</li>
<li><kbd>geo_primary_role</kbd>: Configures the database for replication and prepares the application server as <kbd>geo primary</kbd>.</li>
<li><kbd>geo_secondary_role</kbd>: Prepares the database for replication and sets the application up as <kbd>secondary geo</kbd>.</li>
<li><kbd>postgres_role</kbd>: Switches on the <kbd>postgresql</kbd>, <kbd>repmgr</kbd>, and <kbd>consul</kbd> services on the machine. Sets up only these components.</li>
<li><kbd>pgbouncer_role</kbd>: This role adds the PgBouncer software for the database load-balancing feature.</li>
</ul>
<p><span>After editing, you have to issue a <kbd>gitlab-ctl reconfigure</kbd> to apply the settings.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring source installations</h1>
                </header>
            
            <article>
                
<p>The main configuration file to change is <kbd>gitlab.yml</kbd>, which is usually found in <kbd>/home/git/gitlab/config</kbd>. It follows the <kbd>.yml</kbd> standard and this has several implications. The first one is that indentation is very important. If you just copy and paste configuration, you will find that it can mess up the file contents. Another important feature that is used in the <kbd>gitlab.yml</kbd> file is utilizing anchors and aliases (<strong>&amp;base</strong>) to specify different configuration targets. In practice, this means that the main configuration for all environments is specified in the <kbd>config</kbd> file <kbd>(production: &amp;base)</kbd>.</p>
<p>Below the <kbd>production: &amp;base</kbd> target , the other environments are specified, and they refer to <kbd>&amp;base</kbd> but override certain key-value pairs. How does GitLab know which environment information should be used? That is determined by the <kbd>RAILS_ENV</kbd> variable used when installing and starting GitLab.</p>
<p>We have put an example configuration file in repository of this book (<a href="https://github.com/PacktPublishing/Mastering-GitLab-12/blob/master/Chapter04/config_gitlab.yml.example">https://github.com/PacktPublishing/Mastering-GitLab-12/blob/master/Chapter04/config_gitlab.yml.example</a>).</p>
<p>The configuration file has several sections, and we'll run through them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab app settings</h1>
                </header>
            
            <article>
                
<p>This section of the configuration file is mainly used to define the global settings for the whole GitLab application.</p>
<p>The first settings you will encounter are mainly for the web server component (Unicorn). You can specify which FQDN to use for the hostname, the port on which to listen to, and whether to use HTTPS:</p>
<pre><strong>    host: localhost</strong><br/><strong>     port: 80 </strong><br/><strong>     https: false</strong></pre>
<p>You can set the port to <kbd>443</kbd> and HTTPS to true if you want to use HTTPS. If you have a different <kbd>ssh_host</kbd> in your setup, you can specify it as well (<span><span>If you want Git-SSH to run on the same server, that you don't need to specify this</span></span>):</p>
<pre><strong>    ssh_host: ssh.host_example.com</strong></pre>
<p>Furthermore, if you want to use relative URLs (<kbd>/mygitlab/</kbd> for instance):</p>
<pre><strong>  relative_url_root: /gitlab</strong></pre>
<p>You can also change the option regarding which OS-user to use for running the web server processes:</p>
<pre><strong>user: git</strong></pre>
<p>The next setting is about dates and times, and you can specify the timezone to be used throughout the entire application:</p>
<pre><strong> time_zone: 'UTC'</strong></pre>
<p>The next bundle of settings handles email. You can disable GitLab's use of email entirely or specify who the sender and the subject, among other things:</p>
<pre><strong>email_enabled: true</strong><br/><strong> email_from: example@example.com</strong><br/><strong> email_display_name: GitLab</strong><br/><strong> email_reply_to: noreply@example.com</strong><br/><strong> email_subject_suffix: ''</strong></pre>
<p class="mce-root">The next setting determines whether new users can create groups (be careful, as existing users retain this privilege).</p>
<pre class="mce-root">default_can_create_group: false</pre>
<p class="mce-root">If you want old users to be also stripped of this privilege, one way to do it is to use the Rails console:</p>
<pre><strong>irb(main):012:0&gt; @users.each do |u|</strong><br/><strong> irb(main):013:1*  u.can_create_group= false</strong><br/><strong> irb(main):014:1&gt; u.save</strong><br/><strong> irb(main):015:1&gt; end</strong></pre>
<p>The next option allows you the option to change your username. This is generally not recommended if you use another system such as <strong>Lightweight Directory Access Protocol</strong> (<strong><span>LDAP</span></strong>) for account management:</p>
<pre><strong>username_changing_enabled: false</strong></pre>
<p>The next set of options determines the style to be used for GitLab; I suggest you try them all (1-10):</p>
<pre><strong> # default_theme: 1 # default: 1</strong></pre>
<p>A nice feature that can automate your development workflow very efficiently is the automatic closing of issues by issuing a commit to the default project branch. You can use the following pattern to make the automation work. If it matches, it will be closed. The pattern is quite complicated, so we will use the code provided:</p>
<pre><strong>issue_closing_pattern: '\b((?:[Cc]los(?:e[sd]?|ing)|\b[Ff]ix(?:e[sd]|ing)?|\b[Rr]esolv(?:e[sd]?|ing)|\b[Ii]mplement(?:s|ed|ing)?)(:?) +(?:(?:issues? +)?%{issue_ref}(?:(?:, *| +and +)?)|([A-Z][A-Z0-9_]+-\d+))+)'</strong></pre>
<p>We could, for example, use the following commit message:</p>
<pre><strong> Fix #122 and Closes groupx/bestproject#1000.</strong><br/><strong> Also  important for #10 and fixes #11, #229 and #188</strong><br/><strong> and https://gitlab.example.com/group/mything/issues/9999.</strong></pre>
<p>In the preceding example, <kbd>#122</kbd>, <kbd>#1000</kbd>, <kbd>#11</kbd>, <kbd>#229</kbd>, <kbd>#188</kbd>, and <kbd>#9999</kbd> will be automatically closed. Only <kbd>#10</kbd> will not be touched, because it does not match the pattern.</p>
<p>In GitLab, in each project you have some default capabilities, such as the possibility to create issues or a wiki in the project space. There is an option to disable or enable them by default:</p>
<pre><strong><span>default_projects_features:</span></strong><br/><strong>     issues: true</strong><br/><strong>     merge_requests: true</strong><br/><strong>     wiki: true</strong><br/><strong>     snippets: true</strong><br/><strong>     builds: true</strong><br/><strong>     container_registry: true</strong></pre>
<p>The CI/CD component of GitLab relies heavily on webhooks as its primary eventing mechanism over network boundaries. On slow networks, you may want to increase the timeout value of them to make them try harder:</p>
<pre><strong>webhook_timeout: 10</strong></pre>
<p>You can download the contents of a project, which are combined in a ZIP file. This creation of a ZIP file needs some temporary disk space, which you can define here, the repository downloads directory (relative path to the Rails directory):</p>
<pre><strong> repository_downloads_path: shared/cache/archive/</strong></pre>
<p>GitLab can also utilize an email client, which can get mail from an IMAP server, and parse the mail contents for issues and merge request IDs. If you set this up correctly, you can allow users to reply to notification emails, and the result will be added to the issue or the merge request. The first part is where you enable or disable the function:</p>
<pre><strong> incoming_email:</strong><br/><strong>   enabled: false</strong></pre>
<p>The second part is where you define the incoming email address that is used and what part of it is variable (every merge-request or issue number is a variable):</p>
<pre><strong>  address: "gitlab-incoming+%{key}@gmail.com"</strong></pre>
<p>The other settings mainly concern the IMAP server that is used along with the credentials and connection settings:</p>
<pre><strong>  user: "gitlab-incoming@gmail.com"</strong><br/><strong>   password: "[REDACTED]"</strong><br/><strong>   host: "imap.gmail.com"</strong><br/><strong>   port: 993</strong><br/><strong>   ssl: true</strong><br/><strong>   start_tls: false</strong><br/><strong> mailbox: "inbox"</strong><br/><strong>  idle_timeout: 60</strong></pre>
<p>These settings together enable incoming email for your GitLab instance.</p>
<p>This concludes the section in the configuration file that covers some general settings. The next section is about storing different kinds of files.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Storing big files</h1>
                </header>
            
            <article>
                
<p>The GitLab CI/CD components can build your software, and that results in build artifacts. They are sent back from the GitLab runners to the GitLab server. You can download them through the web UI. These artifacts are, by default, stored on the GitLab server in <kbd>shared/artifacts</kbd>. As the files can become quite large and numerous, it is also possible to store these artifacts somewhere else, where the GitLab server can fetch them when needed or redirect the request. You can set up object storage with Amazon S3, for example, to be used as a <span><span>big bucket to store files</span></span>.</p>
<p>By default GitLab it stores artifacts in the local shared path  <kbd>shared/artifact</kbd> on the server where GitLab is installed:</p>
<pre><strong>artifacts:</strong><br/><strong>   enabled: true</strong><br/><strong>   path: shared/artifacts</strong></pre>
<p>When comparing operations during merge requests, the <kbd>diffs</kbd> files are normally saved in the database when enabled. But when set to <kbd>true</kbd>, GitLab will save them in a shared path:</p>
<pre><strong> external_diffs:</strong><br/><strong>   enabled: true</strong><br/><strong>   storage_path: shared/external-diffs</strong></pre>
<p>In the same manner as the build artifacts and <kbd>diffs</kbd>, GitLab can store Git <strong><span>Large File Storage</span></strong> (<strong>LFS</strong>) objects in a different place, out of the project repository. A reference to this place is then inserted as a substitute in the project repository. This is a Git client extension, for which the server side necessities have been implemented in GitLab. (More info about Git LFS can be found at <a href="https://git-lfs.github.com/">https://git-lfs.github.com/</a>.) It can be enabled and given a path:</p>
<pre class="mce-root"><strong> lfs:</strong><br/><strong>    enabled: true</strong><br/><strong>    storage_path: shared/lfs-objects</strong></pre>
<p>Another possible use for object storage is to store <kbd>uploads</kbd>, such as attachments and avatars. We can enable this in GitLab to save space and use storage more efficiently:</p>
<pre><strong>uploads:</strong><br/><strong>    base_dir: uploads/-/system</strong></pre>
<p>There are more options for storage than only local. You can also store things as an object somewhere else.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using object storage</h1>
                </header>
            
            <article>
                
<p>A more efficient way of storing artifacts is by utilizing object storage. It can currently be used for <kbd>artifacts</kbd>, <kbd>lfs</kbd>, <kbd>uploads</kbd>, and <kbd>external_diffs</kbd> for merge requests. The trick is to add an <kbd>object_store:</kbd> part, which can have several options:</p>
<pre><strong>object_store:</strong><br/><strong>   enabled: true</strong><br/><strong>   remote_directory: artifacts</strong></pre>
<p>A direct upload avoids saving the file in transit and directly uploads to AWS another chosen object storage provider:</p>
<pre><strong>direct_upload: true</strong></pre>
<p>The next setting after <kbd>remote_directory</kbd> can limit the uploading of artifacts somewhat if they are first saved in GitLab:</p>
<pre><strong>background_upload: false </strong></pre>
<p>If you set <kbd>proxy_download</kbd> to <kbd>false</kbd>, you will get redirected to object storage when downloading, instead of being sent through a proxy connection:</p>
<pre><strong>proxy_download: false</strong></pre>
<p>There are some other specific settings regarding the connection to object storage. It has to do with the provider type and specific attributes of this provider. The credentials and the region are settings that have to be defined for most providers. The AWS signature version is for creating signed URLs, and you have the option of v2 or v4. The endpoint is fixed for AWS, but it can differ according to the provider. The path style refers to the resolving of the files. If it is set to <kbd>true</kbd>, it will be like <kbd>host/bucket_name/object</kbd>, but if it is set to <kbd>false</kbd>, it will be like <kbd>bucket_name.host/object</kbd>.</p>
<p>All settings under the connection section will look as follows:</p>
<pre><strong>connection:</strong><br/><strong>   provider: AWS  </strong><br/><strong>     aws_access_key_id: AWS_ACCESS_KEY_ID</strong><br/><strong>     aws_secret_access_key: AWS_SECRET_ACCESS_KEY</strong><br/><strong>     region: us-east-1</strong><br/><strong>     aws_signature_version: 4 </strong><br/><strong>     endpoint: 'https://s3.amazonaws.com' </strong><br/><strong>     path_style: true</strong></pre>
<p>So far, we have seen the different storage options for big files that can be part of CI jobs or repositories.</p>
<p>As you can see, there are many options to store different kinds of files. You can also publish certain files as web content using pages, and that is the subject of the next section<strong>.</strong></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab pages</h1>
                </header>
            
            <article>
                
<p><strong>GitLab pages</strong> is an extension <span><span>of</span></span> CI/CD where web content can be automatically built and deployed to a web server. You can publish static websites directly from a repository. There are several options to consider. To use the feature, but also if access control should be enabled and the path where the pages are stored.</p>
<p>The extension uses the GitLab pages daemon, which is written in Go and serves up content from the shared location. If you run it on the same server, you ideally run it on page 80 or 443, in case you have to add an IP to the GitLab server. It is possible to run it on a separate server, but you need to export the path from the GitLab server over the network to the host, which will run the GitLab pages daemon. </p>
<div class="packt_infobox">More information can be found at <a href="https://gitlab.com/gitlab-org/gitlab-pages">https://gitlab.com/gitlab-org/gitlab-pages</a>.</div>
<p>The first settings concerning GitLab pages are to enable or disable it completely, to enable or disable <kbd>access_control</kbd>, and you can set a path to the shared pages:</p>
<pre><strong>pages:</strong><br/><strong>   enabled: false</strong><br/><strong>   access_control: false</strong><br/><strong>   path: shared/pages</strong></pre>
<p>The following settings determine the properties of the server for GitLab pages:</p>
<pre><strong>  host: example.com</strong><br/><strong>   port: 80 </strong><br/><strong>   https: false </strong><br/><strong>   artifacts_server: true</strong><br/><strong>   external_http: ["1.1.1.1:80", "[2001::1]:80"] </strong><br/><strong>   external_https: ["1.1.1.1:443", "[2001::1]:443"]</strong></pre>
<p>The last setting defines the location of a socket for admin access:</p>
<pre><strong>admin:</strong><br/><strong>   address: unix:/home/git/gitlab/tmp/sockets/private/pages-admin.socket # TCP connections are supported too (e.g. tcp://host:port)</strong></pre>
<p>The settings for GitLab pages are complete.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Mattermost</h1>
                </header>
            
            <article>
                
<p>There are many integrations for GitLab available, but one very interesting one is <strong>Mattermost</strong>, a Slack-like chat collaboration tool. It was acquired by GitLab in 2017, and is now even integrated in the omnibus GitLab install. You can enable the ChatOps operation with this tool. In the settings, you can enable the specific button in GitLab:</p>
<pre><strong> mattermost:</strong><br/><strong>    enabled: false</strong><br/><strong>    host: 'https://mattermost.example.com'</strong></pre>
<p>By enabling this, you can use the <span class="packt_screen">A</span><span class="packt_screen">dd</span> button in GitLab in the service settings.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Gravatar</h1>
                </header>
            
            <article>
                
<p>The following code block defines settings for using avatars, which is by default <kbd>gravatar.com</kbd>. <strong>Gravatar</strong> is a <strong>Globally Recognized Avatar</strong>. An <em>avatar</em> is an image following you from site to site, and the G<span>ravatar </span>service originated from WordPress, where it was used for blogs. You can set the HTTP and HTTPS URL here:</p>
<pre><strong>gravatar: </strong><br/><strong>plain_url: “http://www.gravatar.com/avatar/%{hash}?s=%{size}&amp;d=identicon”</strong><br/><strong>ssl_url: “https://secure.gravatar.com/avatar/%{hash}?s=%{size}&amp;d=identicon”</strong></pre>
<p>Another example would be to set it to point to an Office 365 URL (you must be authenticated to Office 365 to use it):</p>
<pre><strong>gravatar: plain_url: “http://outlook.office365.com/owa/service.svc/s/GetPersonaPhoto?email=%{email}&amp;size=HR120x120”</strong><br/><strong>ssl_url: “http://outlook.office365.com/owa/service.svc/s/GetPersonaPhoto?email=%{email}&amp;size=HR120x120”</strong></pre>
<div class="packt_infobox">Another service that offers these services is <strong>Libreavatar</strong>. You can find find more info about this at <a href="https://wiki.libravatar.org/api/">https://wiki.libravatar.org/api/</a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Sidekiq</h1>
                </header>
            
            <article>
                
<p>The <strong>Sidekiq</strong> component of GitLab takes care of background jobs, and you can find more information about it in <a href="384dcfd9-ef7f-470d-89dc-3af7502a2d09.xhtml">Chapter 1</a>, <em>Introducing the GitLab Architecture</em>. Most of the configuration is done in the configuration file of Sidekiq itself, but there are some options in the <kbd>gitlab.yml</kbd> file you can define.</p>
<p>For instance, you can only define the <kbd>log_format</kbd> here and the cron jobs that will be run in Sidekiq:</p>
<pre><strong>## Sidekiq</strong><br/><strong> sidekiq:</strong><br/><strong>   log_format: default # (json is also supported)</strong></pre>
<p>In the Sidekiq background processing, there is also a job scheduler integrated, which, by default, runs a couple of jobs. The format of the schedule is just like cron on Unix systems. The most import jobs are listed as follows:</p>
<ul>
<li><kbd>stuck_ci_jobs_worker</kbd>: Set stuck jobs to state failed.</li>
<li><kbd>pipeline_schedule_worker</kbd>:  Execute scheduled triggers.</li>
<li><kbd>expire_build_artifacts_worker</kbd>: Remove expired build artifacts.</li>
<li><kbd>repository_check_worker</kbd>: Periodically run <kbd>git fsck</kbd> on all repositories.</li>
<li><kbd>ci_archive_traces_cron_worker</kbd>: Archive live traces that have not been archived yet.</li>
<li><kbd>admin_email_worker</kbd>: Send admin emails.</li>
<li><kbd>repository_archive_cache_worker</kbd>: Remove outdated repository archives.</li>
<li><kbd>pages_domain_verification_cron_worker</kbd>: Verify custom GitLab pages domains.</li>
<li><kbd>schedule_migrate_external_diffs_worker</kbd>: Periodically migrate <kbd>diffs</kbd> from the database to external storage.</li>
</ul>
<p>For GitLab <strong>Enterprise Edition</strong> (<strong>EE</strong>), several extra jobs are available, mainly ones that handle Geo synchronization and LDAP sync.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab Registry</h1>
                </header>
            
            <article>
                
<p>GitLab can function as a fully fledged container registry for Docker containers. You can set options for it in the following section.</p>
<p>The first option is basically the on or off switch:</p>
<pre class="mce-root"><strong>enabled: true<br/></strong></pre>
<p>The next option is the hostname, which it will set:</p>
<pre class="mce-root"><strong>host: registry.example.com</strong></pre>
<p class="mce-root">You can also define the network port it will listen on:</p>
<pre class="mce-root"><br/><strong>port: 5005</strong></pre>
<p>There is an internal address you can define that GitLab itself will connect to:</p>
<pre class="mce-root"><strong>api_url: http://localhost:5000/ </strong> </pre>
<p class="mce-root">The GitLab registry uses a keypair, the <kbd>rootcertbundle</kbd>, here is the private key location:<strong><br/></strong></p>
<pre class="mce-root"><strong>key: config/registry.key</strong></pre>
<p class="mce-root">Set the path that is used for storage:</p>
<pre class="mce-root"><strong>path: shared/registry</strong></pre>
<p class="mce-root">Set the name of the issuer of the certificate:</p>
<pre class="mce-root"><strong>issuer: gitlab-issuer</strong></pre>
<div class="packt_infobox">Further options can be found at <a href="https://docs.gitlab.com/ee/administration/container_registry.html">https://docs.gitlab.com/ee/administration/container_registry.html</a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">GitLab CI settings</h1>
                </header>
            
            <article>
                
<p>GitLab <strong>CI</strong> used to be a separate software component but is now firmly integrated into the GitLab backend.</p>
<p class="mce-root">There are three options to configure in the <kbd>gitlab.yml</kbd>:</p>
<ul>
<li class="mce-root"><kbd>all_broken_builds</kbd>: Only send an email if a build broke.</li>
<li class="mce-root"><kbd>add_pusher</kbd>: Also, add the user pushing the last version of the repository to the recipient list.</li>
</ul>
<ul>
<li class="mce-root"><kbd>builds_path</kbd>: The location where the build traces are stored.</li>
</ul>
<pre class="mce-root" style="padding-left: 60px"><strong>gitlab_ci:</strong><br/><strong> all_broken_builds: true</strong><br/><strong> add_pusher: true</strong><br/><strong> builds_path: builds/</strong></pre>
<p>Further configuration of GitLab CI is done from the web interface as you have seen in the previous chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Auth settings</h1>
                </header>
            
            <article>
                
<p>There are several authentication providers available for GitLab. The main on-premise one is the <strong>LDAP</strong> interface (to Active Directory, OpenLDAP).</p>
<p class="mce-root">The first part is the enabling of the feature:</p>
<pre class="mce-root"><strong>ldap:</strong><br/><strong>    enabled: false</strong></pre>
<p class="mce-root">The next part is the declaration of servers:</p>
<pre class="mce-root"><br/><strong>    servers:</strong><br/><strong>      main: </strong><br/><strong>        label: 'LDAP'</strong><br/><strong>        host: '_your_ldap_server'</strong><br/><strong>        port: 389 </strong><br/><strong>        uid: 'sAMAccountName' </strong><br/><strong>        bind_dn: '_the_full_dn_of_the_user_you_will_bind_with'</strong><br/><strong>        password: '_the_password_of_the_bind_user'</strong></pre>
<p>As you can see, we define a <kbd>label</kbd> and set up a <kbd>host</kbd> and <kbd>port</kbd>. We also give the <kbd>uid</kbd> attribute to use and a <kbd>password</kbd> and <kbd>bind_dn</kbd> (object or user used to attach to LDAP).</p>
<p>You can set options for SSL to enhance security:</p>
<pre><strong> encryption: 'start_tls'</strong><br/><strong>  verify_certificates: true</strong><br/><strong>  ssl_version: 'TLSv1_1'</strong></pre>
<p>Next up are some settings that belong to how login actions are handled and how timeouts are handled:</p>
<pre><strong>  timeout: 10</strong><br/><strong>   active_directory: true</strong><br/><strong>   allow_username_or_email_login: false</strong><br/><strong>   block_auto_created_users: false</strong></pre>
<p>GitLab needs to know where <span> it can find users from </span>in your LDAP tree and how to distinguish them from other objects or persons. You can set the LDAP base and a filter:</p>
<pre><strong>  base: 'ou=People,dc=gitlab,dc=example' or 'DC=mydomain,DC=com'</strong><br/><strong>   user_filter: '(&amp;(objectclass=user)(|(samaccountname=momo)(samaccountname=toto)))'</strong></pre>
<p>In the next part, you can determine which LDAP attributes you want to use in GitLab. It maps LDAP objects to GitLab objects:</p>
<pre>   <br/>        <strong> username: ['uid', 'userid', 'sAMAccountName']</strong><br/>        <strong> email:    ['mail', 'email', 'userPrincipalName']</strong><br/>        <strong> name:       'cn'</strong><br/>         <strong>first_name: 'givenName'</strong><br/>         <strong>last_name:  'sn'</strong><br/>         <strong>lowercase_usernames: false</strong></pre>
<p>If you have an enterprise license, you are entitled to define more than one LDAP server, which is often the case in a corporate environment. You can add a main label to a block of settings we filled in the preceding code block and create a new block with a new label:</p>
<pre><strong>    label:</strong><br/><strong>       host:</strong></pre>
<p>Besides LDAP, you can authenticate users with OAuth-enabled cloud providers. The first section of the settings deal with some general options, such as enabling the feature, how to handle information from those providers, and other behavioral aspects of the mechanism. The comments in the configuration file are very detailed about what the possibilities are.</p>
<p>The second part of the section allows you to define an OmniAuth provider. There are several examples mentioned, such as GitHub and Facebook and Auth0 (<a href="https://auth0.com/">https://auth0.com/</a>)<strong> </strong>(an identity management platform). Again, the configuration file offers a lot of explanation regarding how to configure this.</p>
<p>At the end of this configuration file section, there are two settings that are, in my opinion, not Auth settings, but they are important.</p>
<p>You can define a shared file storage path. GitLab uses shared file storage for some operations:</p>
<pre><strong>shared:</strong><br/><strong>   /mnt/gitlab</strong></pre>
<p>Here, you define settings for the Gitaly service. If you run it from the source, you should mention where you ran it from:</p>
<pre><strong>gitaly:</strong><br/><strong>   client_path: /home/git/gitaly/bin</strong><br/><strong>   token:</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Advanced settings</h1>
                </header>
            
            <article>
                
<p>I am not sure why there is an advanced section such as this in <kbd>gitlab.yml</kbd>, but the first options deal with repository settings. The main thing here is that you specify the path to the repositories shown as follows: </p>
<pre><strong>storages:  </strong><br/><strong> default:</strong><br/><strong> path: /home/git/repositories/</strong><br/><strong> gitaly_address: unix:/home/git/gitlab/tmp/sockets/private/gitaly.socket # </strong><br/><strong> gitaly_token: 'special token'  </strong></pre>
<p>There is always a <kbd>default</kbd> entry, and you can specify a <kbd>path</kbd> and a <kbd>gitaly_address</kbd> here (also in the form of <kbd>tcp://</kbd>). You can override the global <kbd>gitaly_token</kbd> here.</p>
<p class="mce-root">GitLab has a backup or restore facility. It is in the form of a rake task. For example, you can invoke a backup task like this:</p>
<pre class="mce-root"><strong>sudo -u git -H bundle exec rake gitlab:backup:create</strong></pre>
<p class="mce-root">The former command has options you can set via the configuration file. Once again, you can use the cloud to store files. GitLab imports cloud drivers for AWS, Google, OpenStack Swift, Rackspace, and Aliyun as well. A local driver is also available. The following is an example entry in <kbd>gitlab.yml</kbd>:</p>
<pre class="mce-root"><strong>## Backup settings</strong><br/><strong>backup:</strong><br/><strong> path: "tmp/backups"</strong> </pre>
<p class="mce-root">The GitLab shell is the primary component to provide Git-SSH connections, and when run from the source, you have to specify the path where it is installed. There is also a path set for hooks, which can execute when an event like a git push is fired (you can create your own hooks):</p>
<pre class="mce-root"><strong>gitlab_shell:</strong><br/><strong> path: /home/git/gitlab-shell/</strong><br/><strong> hooks_path: /home/git/gitlab-shell/hooks/</strong></pre>
<p class="mce-root"><span>You also have to define the file which contains  a secret. It is to be used when GitLab shell connects to the rails backend to verify access of the user that tries to do Git-SSH operations:</span></p>
<pre class="mce-root"><br/><strong># File that contains the secret key for verifying access for gitlab-shell.</strong><br/><strong> # Default is '.gitlab_shell_secret' relative to Rails.root (i.e. root of the GitLab app).</strong><br/><strong>secret_file: /home/git/gitlab/.gitlab_shell_secret</strong><br/><br/></pre>
<p class="mce-root">In the following code block, you see the definition of the key that is used by GitLab Workhorse to get access to the rails application.</p>
<pre class="mce-root"><strong>workhorse:</strong><br/><strong>secret_file: /home/git/gitlab/.gitlab_workhorse_secret</strong></pre>
<p class="mce-root">It is defined in the file <kbd>.gitlab_workhorse_secret</kbd> as follows <kbd><span>TJEf6HQcgkBjcLGVdZ4h6Y2PB89X1RGs/RsJ7FIfg6s=</span></kbd>.</p>
<p class="mce-root"><span>You have the option of changing to another Git version:</span><strong><br/></strong></p>
<pre class="mce-root"><strong>## Git settings</strong><br/><strong>git:</strong><br/><strong> bin_path: /usr/bin/git</strong></pre>
<p class="mce-root">The <kbd>webpack</kbd> program is used to compile and serve frontend assets such as <strong>Cascading Style Sheets</strong> (<strong>CSS</strong>), only to be used in development:</p>
<pre class="mce-root"><strong>## Webpack settings</strong><br/><strong>webpack:</strong><br/><strong> dev_server:</strong><br/><strong> enabled: true</strong><br/><strong> host: localhost</strong><br/><strong> port: 3001</strong></pre>
<p class="mce-root">The Prometheus endpoint that is built in also gathers data about Unicorn performance. It will sample the Unicorn Unix socket for that. Here, you can define the sampling rate. <span><span>You can also</span></span> define a whitelist for IPs allow to connect to the metrics endpoint:</p>
<pre class="mce-root"><strong># Built in monitoring settings</strong><br/><strong>monitoring:</strong><br/><strong> unicorn_sampler_interval: 10</strong><br/><strong> ip_whitelist:</strong><br/><strong>  - 127.0.0.0/8</strong></pre>
<p class="mce-root">Another built-in metrics provider, a <kbd>sidekiq</kbd> Prometheus exporter, is controlled from here:</p>
<pre class="mce-root"><strong>sidekiq_exporter:</strong><br/><strong> enabled: true</strong><br/><strong> address: localhost</strong><br/><strong> port: 3808</strong></pre>
<p>As you can see, the topics that are handled in this section are quite different, and I am not sure whether they should reside under advanced settings. There is also a<span> final section in the <kbd>gitlab.yml</kbd> file called <strong>extra customization</strong>. The most important part here is <kbd>rack_attack</kbd>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Rack Attack</h1>
                </header>
            
            <article>
                
<p>An import part of internet security nowadays are built-in throttling mechanisms to counter denial-of-service attacks. GitLab uses the Rack Attack Gem that can keep an eye on the number of requests coming from individual IPs. You can disable it here and set a whitelist and some thresholds:</p>
<pre><strong>rack_attack:</strong><br/><strong>   git_basic_auth:</strong><br/><strong>    enabled: true</strong><br/><strong>     ip_whitelist: ["127.0.0.1"]</strong><br/>     </pre>
<p>You can limit the number of Git HTTP authentication attempts:</p>
<pre><strong>maxretry: 10</strong></pre>
<p>After 60 seconds, t<span>he auth attempt counter </span><span>will be reset:</span></p>
<pre><strong>findtime: 60</strong></pre>
<p>You can also ban an IP for one hour (3,600 seconds); for example, after too many auth attempts:</p>
<pre><strong>bantime: 3600</strong></pre>
<p>We have reached the end of the <kbd>gitlab.yml</kbd> file. After restarting GitLab, the changes will become active. There are other ways of running GitLab. In the next section, we will take a look at configuring an instance in a Docker container.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Reconfiguring GitLab Docker containers</h1>
                </header>
            
            <article>
                
<p>The official containers from GitLab use the <kbd>omnibus-gitlab</kbd> package, so all the configuration is managed through the unique configuration file, <kbd>/etc/gitlab/gitlab.rb</kbd>.</p>
<p>Once the container is started, you can connect to it by starting a Bash session:</p>
<pre><strong>docker exec -it gitlab /bin/bash</strong></pre>
<p>You can now  edit <kbd>/etc/gitlab/gitlab.rb</kbd> inside the Docker container. Then you can run <kbd>gitlab-ctl reconfigure</kbd> after that to apply the changes.</p>
<p>A second way to configure the container is to start it up with a environment variable, <kbd>GITLAB_OMNIBUS_CONFIG</kbd>. This variable can contain the contents of a <kbd>gitlab.rb</kbd> file. These settings will not be persisted to the real file.</p>
<p>You could use the following code:</p>
<pre><strong>sudo docker run  \</strong><br/><strong> --hostname gitlab.joustie.nl \</strong><br/><strong> --env GITLAB_OMNIBUS_CONFIG="external_url 'http://gitlab.joustie.nl/'; gitlab_rails['lfs_enabled'] = true;" \</strong><br/><strong> --publish 443:444 --publish 80:81 --publish 22:2222 \</strong><br/><strong> --volume /srv/gitlab/config:/etc/gitlab \</strong><br/><strong> --volume /srv/gitlab/logs:/var/log/gitlab \</strong><br/><strong> --volume /srv/gitlab/data:/var/opt/gitlab \</strong><br/><strong> gitlab/gitlab-ce:latest</strong></pre>
<p>The container start-up process will always run <kbd>gitlab-ctl reconfigure</kbd>. This means the omnibus template settings you specify during container startup need to be explicitly set every time you spin up the container; otherwise, your container will reconfigure and you will lose the settings.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Changing GitLab in a Kubernetes environment</h1>
                </header>
            
            <article>
                
<p>Since GitLab for Kubernetes is configured by Helm charts, you need to configure all settings through that.</p>
<p>The options can be found here: <a href="https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md">https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md</a>.</p>
<p>For each set of options, some are required, and those that are not required have a default value.</p>
<p>In the next section, we will pick some of the options to change in a Kubernetes environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Basic configuration</h1>
                </header>
            
            <article>
                
<p>There are two required settings here: <kbd>global.hosts.domain</kbd> and <kbd>global.hosts.externalIP</kbd>. These should point to the host and IP where GitLab is to be served from. Another interesting set of these are as follows:</p>
<ul>
<li><kbd>global.psql.host</kbd></li>
<li><kbd>global.psql.password.secret</kbd></li>
<li><kbd>global.psql.password.key</kbd></li>
</ul>
<p>These contain information that point to an external Postgres instance.</p>
<p>Other options can be found in the command-line options URL at <a href="https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md">https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring TLS</h1>
                </header>
            
            <article>
                
<p>These options control the TLS configuration that is activated for GitLab. There are no required options, but if you don't want to use Let's Encrypt, set <kbd>global.ingress.configureCertmanager</kbd> to false.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring outgoing emails</h1>
                </header>
            
            <article>
                
<p>For outgoing email, there are several options such as the host of the incoming mail server—for example:</p>
<pre><strong>global.smtp.address (e.g. smtp.joustie.nl) with global.smtp.authentication="" (disable smtp authentication)</strong></pre>
<p>To set this configuration setting and enable it, you use the following command line:</p>
<pre><strong>helm upgrade   gitlab gitlab/gitlab \</strong><br/><strong>   --timeout 600 \</strong><br/><strong>   --set global.hosts.domain=kicks-ass.net \</strong><br/><strong>   --set global.hosts.externalIP=82.161.132.207 \</strong><br/><strong>   --set certmanager-issuer.email=joustie@gmail.com \</strong><br/><strong>   --set global.smtp.enabled=true \</strong><br/><strong>   --set global.smtp.address=smtp.joustie.nl \</strong><br/><strong>   --set global.smtp.authentication=""</strong></pre>
<p>If your SMTP server requires authentication, you need to add the credentials as an <kbd>–set</kbd> option and deploy the password also as a secret with the following:</p>
<pre><strong>kubectl create secret generic smtp-password --from-literal=password=yourpasswordhere</strong></pre>
<p>After you have issued the <kbd>helm upgrade</kbd> command, the <kbd>unicorn</kbd> and <kbd>sidekiq</kbd> components will automatically restart in the Kubernetes cluster.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Other settings</h1>
                </header>
            
            <article>
                
<p>Many other settings are available, and you can view them at <a href="https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md">https://gitlab.com/charts/gitlab/blob/master/doc/installation/command-line-options.md</a>.</p>
<p>Here are some examples:</p>
<ul>
<li><strong>Incoming Email configuration</strong>: GitLab can also handle incoming mail for the service desk feature.</li>
<li><strong>GitLab shell</strong>: You can provide settings for the GitLab shell.</li>
<li><strong>RBAC settings</strong>: You can describe Kubernetes <strong>Role Based Access Control</strong> (<strong>RBAC</strong>).</li>
</ul>
<ul>
<li><strong>Advanced nginx ingress configuration</strong>: Change the default ingress nginx settings for the cluster.</li>
<li><strong>Advanced in-cluster Redis configuration</strong>: Change the settings for the Redis cluster.</li>
<li><strong>Advanced registry configuration</strong>: Change the settings for the Docker registry that is running as a microservice.</li>
<li><strong>Advanced MinIO configuration</strong>: Change the settings for the MinIO object storage microservice.</li>
<li><strong>Advanced GitLab configuration</strong>: Change the advanced settings in GitLab.</li>
</ul>
<p> </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we discussed configuring an existing GitLab application instance. As we have seen in earlier chapters, the options are different, depending on the installation path you have chosen. An omnibus GitLab installation is relatively easy to configure. Just change the setting in <kbd>/etc/gitlab/gitlab.rb</kbd> and run <kbd>gitlab-ctl reconfigure</kbd>. Changing the settings in an installation from source requires a bit more attention, because the dependencies between the GitLab components aren't managed as they are with omnibus GitLab. Configuring the GitLab instance running inside the Docker containers is the same as the way you manage the omnibus GitLab installations.</p>
<p>In the next chapter, we will be exploring settings that should be altered in your GitHub and in GitLab to understand the procedure of importing and running the project.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What services are enabled when the <kbd>postgres_role</kbd> is chosen in <kbd>gitlab.rb</kbd>?</li>
<li>Where is <kbd>gitlab.yml</kbd> usually found?</li>
<li>What protocol is used for the incoming mail feature?</li>
<li>What does LFS stand for?</li>
<li>Which Open Source chat tool is tightly integrated with GitLab?</li>
<li>What license is needed to support LDAP groups?</li>
<li>What mechanism does GitLab provide to throttle web requests?</li>
<li>What tool do you need, besides Helm, to configure Kubernetes?</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li><em>Getting Started with Kubernetes - Third Edition</em> by <em>Jesse White</em> and <em>Jonathan Baier</em>: <a href="https://www.packtpub.com/virtualization-and-cloud/getting-started-kubernetes-third-edition">https://www.packtpub.com/virtualization-and-cloud/getting-started-kubernetes-third-edition</a></li>
<li><em>Develop and Operate Microservices on Kubernetes [Video]</em> by<em> Martin Helmich</em>: <a href="https://www.packtpub.com/virtualization-and-cloud/develop-and-operate-microservices-kubernetes-video">https://www.packtpub.com/virtualization-and-cloud/develop-and-operate-microservices-kubernetes-video</a></li>
<li><em>Docker Cookbook - Second Edition</em> by <em>Jeeva S. Chelladhurai</em>, <em>Ken Cochrane</em>, <em>Neependra Khare</em>: <a href="https://www.packtpub.com/virtualization-and-cloud/docker-cookbook-second-edition">https://www.packtpub.com/virtualization-and-cloud/docker-cookbook-second-edition</a></li>
</ul>


            </article>

            
        </section>
    </body></html>