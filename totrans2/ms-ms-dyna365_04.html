<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Online and Container-Based Sandboxes</h1>
                </header>
            
            <article>
                
<p class="mce-root">Dynamics 365 Business Central allows us to set up sandboxes for development and testing purposes. There are two general options for these sandboxes: online sandboxes (SaaS-based) and Docker-based sandboxes (self-deployed).</p>
<p class="mce-root">Online sandboxes can be created very easily because they run as a service, which is the same as Dynamics 365 Business Central production environments. The only requirement is an existing production tenant.</p>
<p class="mce-root">Docker-based sandboxes are based on Docker containers and can run either on Azure or on-premise.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Creating online sandboxes</li>
<li>The basics of Docker images and containers and how to work with them</li>
<li>Setting up local Docker environments</li>
<li>Mastering the <kbd>navcontainerhelper</kbd> PowerShell utility</li>
<li>Choosing the right Docker image for your development purposes</li>
<li>Creating your own Docker image</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating online sandboxes</h1>
                </header>
            
            <article>
                
<p><span>When subscribing to a trial tenant or directly purchasing Dynamics 365 Business Central, you also have the ability to create online sandbox environments.</span></p>
<p>You can create online sandboxes in two ways: from a production environment client and/or from Dynamics 365 Business Central Admin Center.</p>
<p class="mce-root"/>
<p>When creating them from a production environment, search (<em>Alt </em>+ <em>Q</em>) for <kbd>sandbox</kbd> and choose <span class="packt_screen">Sandbox Environment (Preview)</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e6b3dc6b-6bca-4200-a80d-94fd8e70de9e.png" style="width:47.08em;height:19.58em;"/></p>
<p>You will then be prompted to create a new sandbox environment or open or reset an existing sandbox. If there are no sandboxes and you choose open or reset, a new sandbox will be created. Online sandboxes that are created using a production environment client have the following properties:</p>
<ul>
<li>They are named <strong>sandbox</strong> by default and are also visible in the Dynamics 365 Business Central Admin Center.</li>
<li>They do not contain any customer data and just have data coming from a standard demo/evaluation Cronus company.</li>
</ul>
<p>It is very important to carefully read the Microsoft disclaimer when subscribing to an online sandbox tenant, and it's worth mentioning that this feature is still marked as being in preview:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8e6ad481-0c9e-4b72-96da-8328f05cbb65.png" style="width:38.58em;height:19.75em;"/></p>
<div class="packt_figref">
<p class="CDPAlignLeft CDPAlign">You can also create up to three sandbox environments from Dynamics 365 Business Central Admin Center. With the appropriate credentials, log into the Admin Center through a supported browser at <a href="https://businesscentral.dynamics.com/GUID/Admin">https:\\businesscentral.dynamics.com\GUID\Admin</a>, where <kbd>GUID</kbd> is the tenant ID of your environment.</p>
</div>
<p class="mce-root"><span><span>The following shows what it looks like in the Admin Center</span></span><span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a85a3108-4061-46d4-8907-28f1cf5f4d50.png"/></p>
<p>Click the <span class="packt_screen">New </span>button and then give the new online sandbox a valid name. Check the option for copying production data:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0e7e50d0-0ea4-41b1-9fbe-9dc1fc807f87.png" style="width:31.17em;height:38.67em;"/></p>
<p>After a while, your sandbox, with a copy of the production data, will be up and running and ready for testing and development tasks.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Online sandboxes–pros and cons</h1>
                </header>
            
            <article>
                
<p>According to the Microsoft disclaimer, online sandboxes are still a preview feature, and we recommend using them for demo purposes or spot development activities only. Online sandboxes have the following properties:</p>
<ul>
<li>They are supported by a different priority than production environments.</li>
<li>Tenants are created in Azure SQL Database S-level pools, which are less performant than production P-level pools.</li>
<li>They are still marked as Preview, so they are frequently subject to change.</li>
<li>During upgrades, currently all per-tenant extensions are uninstalled and you/your CSP partner are required to install them once again.</li>
</ul>
<p>You can find out more about the background of this by reading the following articles:</p>
<ul>
<li><a href="https://demiliani.com/2019/01/24/dynamics-365-business-central-tenant-upgrade-extensions-disappeared-in-sandbox-environment/">https://demiliani.com/2019/01/24/dynamics-365-business-central-tenant-upgrade-extensions-disappeared-in-sandbox-environment/<br/></a><a href="https://demiliani.com/2019/03/14/dynamics-365-business-central-online-sandbox-makes-you-crazy-maybe-remember-these-points/"/></li>
<li><a href="https://demiliani.com/2019/03/14/dynamics-365-business-central-online-sandbox-makes-you-crazy-maybe-remember-these-points/">https://demiliani.com/2019/03/14/dynamics-365-business-central-online-sandbox-makes-you-crazy-maybe-remember-these-points/<br/></a></li>
</ul>
<p>For professional development, container-based sandboxes are far more appropriate and we encourage you to use Docker-contained sandboxes in your company when developing either AppSource or per-tenant extensions.</p>
<p>From the online production environment, you can also search (<em>Alt </em>+ <em>Q</em>) for sandbox and click on <span class="packt_screen">Sandbox Environment (Container)</span>to easily set up an offline local or Azure-hosted Docker-contained sandbox.</p>
<p>You can find out more about this at<a href="https://demiliani.com/2018/03/29/d365bc-container-sandbox-environment/">https://demiliani.com/2018/03/29/d365bc-container-sandbox-environment/</a>.</p>
<p>Let's move on to the next section and learn how to work with Docker-based environments.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introducing Docker</h1>
                </header>
            
            <article>
                
<p>If you opt to use self-deployed sandboxes, they will be based on Docker. Docker is the leading cross-platform software container environment. Since this is a book about Dynamics 365 Business Central, this section will only be a quick introduction to Docker, but if you want to learn more, there are excellent learning resources in the official documentation by Docker (<a href="https://docs.docker.com/">https://docs.docker.com/</a>) and Microsoft (<a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/index">https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/index</a>), both of which are very good starting points.</p>
<p>Dynamics 365 Business Central runs <em>only</em> on Windows, so when you're looking for Docker documentation, make sure that it is intended for Windows. While most of Docker is platform-independent, there are some platform-specific sections as well.</p>
<p>In order to follow the content of the following sections, you need to know about the following Docker basics:</p>
<ul>
<li>A Docker image is like a pre-built template with the minimum amount of OS binaries, libraries, and application binaries needed. The image can be identified by a name, such as Business Central / Sandbox. The exact image version can be specified with a tag. For example, <kbd>1910-cu1-de</kbd>would give you the <strong>October 19 release</strong> (<strong>1910</strong>), <strong>CU 1</strong> (<strong>cu1</strong>), <strong>German version</strong> (<strong>de</strong>).</li>
<li>A Docker container is an instance of an image with an immutable base (the files that are in the image) and its changes on top. A container is not a <strong>virtual machine</strong> (<strong>VM</strong>). It doesn't have a GUI or anything you can connect to by using the <strong>Remote Desktop Protocol</strong> (<strong>RDP</strong>).</li>
<li>A Docker host is a (physical or virtual) machine where containers are running.</li>
<li>A Docker registry is a place where you and others can upload (push) and download (pull) images. Specifically, images can be downloaded from repositories that are part of the registry.</li>
</ul>
<p>All Dynamics 365 Business Central Docker images are available through the Microsoft Container Registry, which you can find at <a href="http://mcr.microsoft.com">http://mcr.microsoft.com</a>in the business central repository. It will be called <strong>sandbox</strong> or <strong>on-prem</strong>, so a typical address to pull a Dynamics 365 Business Central on-premise image from is <a href="http://mcr.microsoft.com/businesscentral/onprem:1810-cu5-de">mcr.microsoft.com/businesscentral/onprem:1810-cu5-de</a>.</p>
<p>For previews of new and upcoming releases, there is also a special repository called <kbd>bcinsider.azurecr.io</kbd>, but you need credentials to access it. Microsoft provides those credentials through the Ready to Go! program on collaborate (<a href="https://docs.microsoft.com/en-us/collaborate/">https://docs.microsoft.com/en-us/collaborate/</a>).</p>
<p>The scripts that are used to create and run the Dynamics 365 Business Central images are open source and available at <a href="https://github.com/Microsoft/nav-docker">https://github.com/Microsoft/nav-docker</a>.</p>
<p>It is also worth noting that while these images are called business central, they also contain a SQL Server for the database, an IIS for the <kbd>Web Client</kbd>, and file sharing by default.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Some base mechanisms when using Docker</h1>
                </header>
            
            <article>
                
<p>In the following sections, we will use a couple of mechanisms that cover most real-life scenarios. Let's go through each of them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Environment variables</h1>
                </header>
            
            <article>
                
<p>An environment variable is a way to parameterize a Docker container when it starts. Dynamics 365 Business Central images understand a lot of environments, for example, those used to set the authentication type or the username and password, or the SQL server and database you want to connect your Business Central Service Tier to. Environment variables are set using the <kbd>-e</kbd> parameter. If you need to set multiple environment variables, you can just use multiple <kbd>-e</kbd> parameters:</p>
<pre><strong>-e auth=Windows -e databaseserver=sql -e databasename=cronus</strong></pre>
<p>There is no list of all environment variables you can use to configure Dynamics 365 Business Central containers in line with your requirements, but the script for setting up those variables in the image is a good starting point, and the names of the variables give you a pretty good idea of what they do. You can find this script at <a href="https://github.com/Microsoft/nav-docker/blob/master/generic/Run/SetupVariables.ps1">https://github.com/Microsoft/nav-docker/blob/master/generic/Run/SetupVariables.ps1</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Volumes</h1>
                </header>
            
            <article>
                
<p>With volumes, you have a way to map folders on your Docker host to your container, for example, to give it access to binaries or other files it needs to run your solution.</p>
<p>If you are not using volumes and you remove a container, all the changes you make to the filesystem inside the container will be lost because they will have been removed, along with the container.</p>
<p>Volumes are set using the <kbd>-v</kbd> parameter, followed by the path of your host, a colon, and the path inside your container. If you want to map the <kbd>c:\data\containers</kbd>folder on your host to <kbd>c:\temp</kbd> inside of the container, you would write the following command:</p>
<pre><strong>-v c:\data\containers:c:\temp</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Networks and ports</h1>
                </header>
            
            <article>
                
<p>Docker lets you use different ways to connect your containers to the network. If you configure nothing else, it uses a so-called NAT network. This means that your containers get an IP address known only on the Docker host, which also makes them reachable on the host. As an alternative, you can create a so-called transparent network, which means that the container will share the network connection of the host and will try to get its own IP address using either DHCP for dynamic IP assignment or a static IP address you configure. If you have a transparent network called <kbd>transpNet</kbd>, you would instruct Docker to use it with the following command:</p>
<pre><strong>--network transpNet</strong></pre>
<p>Dynamics 365 Business Central images use all the standard ports, so you have <kbd>7045</kbd>-<kbd>7049</kbd> for the Business Central Service Tier services, <kbd>443</kbd> for HTTPS, <kbd>80</kbd> for HTTP for the <kbd>Web Client</kbd>, and <kbd>1443</kbd> for SQL. They also share some files through port <kbd>8080</kbd>, which is mapped to an IIS backend share.</p>
<p>If you don't want to use transparent networks but still want to make the ports available outside the Docker host, you can use a mechanism called port mapping with the<kbd>-p</kbd> parameter. With that, you can instruct Docker to make a port of the container that's available on the same or a different port of your host. If you want to make an HTTPS-based <kbd>Web Client</kbd> listening on port <kbd>443</kbd> available on port <kbd>4443</kbd> of your host, you would typically use the following command:</p>
<pre><strong>-p 4443:443</strong></pre>
<p>Since Dynamics 365 Business Central works a lot better if it knows which ports it is listening on, the best approach is to include <kbd>-e WebClientPort=4443</kbd>, which causes the <kbd>Web Client</kbd> to listen on that port instead of the standard port, <kbd>443</kbd>. Consequently, your port mapping parameter would be <kbd>-p 4443:4443</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Scenarios where Docker is especially useful for Dynamics 365 Business Central sandboxes</h1>
                </header>
            
            <article>
                
<p>There are a couple of scenarios where the use of Docker containers makes a lot of sense and can help solve common problems. Please note that, at the time of writing, there is no production support for Dynamics 365 Business Central running in a Docker container, so you can only use it for development and testing purposes. The scenarios that will be covered in this book are as follows:</p>
<ul>
<li><strong>Locally available scenarios</strong>: You want to run the sandboxes on your local sandbox or on your own virtual machine.</li>
<li><strong>Centrally available environments</strong>: The sandboxes are provided on a central environment and are administered by some kind of operations team.</li>
<li><strong>Containers hosted on Azure VMs</strong>: If you don't want or can't have a VM in your own datacenter, you can use Azure <strong>Infrastructure-as-a-Service</strong> (<strong>IaaS</strong>) to host your sandboxes.</li>
<li><strong>Serverless environments on Azure Container Instances</strong>: You can also use the <strong>Platform-as-a-Service</strong> (<strong>PaaS</strong>) offering of Azure Container Instances if you just want to run your containers without worrying about Docker itself.</li>
</ul>
<p>It is worth mentioning that there are other options, such as the <strong>Azure Kubernetes Service</strong> (<strong>AKS</strong>) or products from other cloud providers, but since Dynamics 365 Business Central tends to run with more Microsoft-oriented customers and Kubernetes only recently initiated support for Windows containers, they will not be covered here.</p>
<p>Docker is also very useful for automated builds in a <strong>Continuous Integration/Continuous Delivery</strong> (<strong>CI/CD</strong>) pipeline. This topic will be covered in depth in <a href="bc01dacb-fdbe-496b-82a0-e45d2435e574.xhtml">Chapter 11</a>, <em>Source Control Management and DevOps with Business Central</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Locally available environments using pure Docker commands</h1>
                </header>
            
            <article>
                
<p>Having your Dynamics 365 Business Central sandboxes local makes sense if you want to give the person working with them full control or if you need to use them offline. It will, however, require the person using it to understand at least the basics of Docker, which is not very complicated but may or may not suit your requirements.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Your first container</h1>
                </header>
            
            <article>
                
<p>The first step in running Dynamics 365 Business Central sandboxes is installing Docker. This is quite easy and documented at <a href="https://docs.docker.com/install/windows/docker-ee/">https://docs.docker.com/install/windows/docker-ee/</a>. Once you have done that, it's time to run your first container. Microsoft has provided a very helpful PowerShell module called <kbd>navcontainerhelper</kbd>, which eases the process of creating containers. However, to give you some basic understanding of the underlying mechanisms and how Dynamics 365 Business Central images work, it makes sense to look at a couple of easy examples with just Docker.</p>
<p>The most basic way to run a Dynamics 365 Business Central sandbox is by using the following command:</p>
<div>
<pre><strong>docker run -e accept_eula=y mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>This only works in what is called process isolation, which allows the container to use host resources such as memory as necessary. Depending on your configuration and whether you are running on an old version of Windows 10 or Docker, you may get an error stating that the container doesn't have enough memory. In that case, add <kbd>-m 3G</kbd> as a parameter, which will allow the container to reserve 3 GB of memory.</p>
<div class="packt_infobox">More on process isolation can be found at <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/hyperv-container">https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/hyperv-container</a>.</div>
<p>Note that this will, by default, pull the image based on Windows Server 2016. If you want to run the much smaller and therefore quicker image based on Windows Server 2019, you need to add what is called a tag; in this case, this will be <kbd>ltsc2019</kbd>. More details can be found in the <em>Choosing the right image</em> section:</p>
<div>
<pre><strong>docker run -e accept_eula=y mcr.microsoft.com/businesscentral/sandbox:ltsc2019</strong></pre></div>
<p>This instructs Docker to run a container using the specified image, that is, <kbd>mcr.microsoft.com/businesscentral/sandbox</kbd>. Running a container means that Docker checks whether that image has already been downloaded (pulled) and if not, it pulls it. If it is already available, or after Docker has downloaded the image for you, it creates a container for that image and starts it. You will see the output from the main process inside the console window where you ran that command.</p>
<p>With the <kbd>-e</kbd> parameter, you let Docker know that you want to set the <kbd>accept_eula=y</kbd> environment parameter inside the container, which means that you accept the <strong>End User License Agreement</strong> (<strong>EULA</strong>). This is necessary whenever you run a Dynamics 365 Business Central sandbox.</p>
<p>The following is the output of a <kbd>docker run</kbd> command where the image was not locally available:</p>
<div>
<pre><strong>docker run -e accept_eula=y -m 3G mcr.microsoft.com/businesscentral/sandbox</strong><br/><br/><strong>Unable to find image 'mcr.microsoft.com/businesscentral/sandbox:latest' locally</strong><br/><br/><strong>latest: Pulling from businesscentral/sandbox</strong><br/><br/><strong>3889bb8d808b: Already exists</strong><br/><br/><strong>…</strong><br/><br/><strong>6d7321cdab15: Already exists</strong><br/><strong>5c2abed3c0c2: Already exists</strong><br/><strong>0bc14e36adef: Pull complete</strong><br/><strong>4fd56667f5dc: Pull complete</strong><br/><strong>…</strong><br/><strong>4dd9d6309b80: Pull complete</strong><br/><strong>Digest: sha256:ca99037c70e1eedf21e8472a5d46efeb148dd46a7b16bdf2ddad864e2e4cb97c</strong><br/><strong>Status: Downloaded newer image for mcr.microsoft.com/businesscentral/sandbox:latest</strong><br/><strong>Initializing...</strong><br/><strong>Starting Container</strong><br/><strong>Hostname is 12cec5da3d89</strong><br/><strong>PublicDnsName is 12cec5da3d89</strong><br/><strong>Using NavUserPassword Authentication</strong><br/><strong>Starting Local SQL Server</strong><br/><strong>Starting Internet Information Server</strong><br/><strong>Creating Self Signed Certificate</strong><br/><strong>Self Signed Certificate Thumbprint 857B5A19C68D44BE3368CB96E2AFF6F540C0D957</strong><br/><strong>Modifying Service Tier Config File with Instance Specific Settings</strong><br/><strong>Starting Service Tier</strong><br/><strong>Registering event sources</strong><br/><strong>Creating DotNetCore Web Server Instance</strong><br/><strong>Enabling Financials User Experience</strong><br/><strong>Creating http download site</strong><br/><strong>Setting SA Password and enabling SA</strong><br/><strong>Creating admin as SQL User and add to sysadmin</strong><br/><strong>Creating SUPER user</strong><br/><strong>Container IP Address: 172.20.200.44</strong><br/><strong>Container Hostname  : 12cec5da3d89</strong><br/><strong>Container Dns Name  : 12cec5da3d89</strong><br/><strong>Web Client          : https://12cec5da3d89/BC/</strong><br/><strong>Admin Username      : admin</strong><br/><strong>Admin Password      : Fuwu1800</strong><br/><strong>Dev. Server         : https://12cec5da3d89</strong><br/><strong>Dev. ServerInstance : BC</strong><br/><strong>Files:</strong><br/><strong>http://12cec5da3d89:8080/al-4.0.192371.vsix</strong><br/><strong>http://12cec5da3d89:8080/certificate.cer</strong><br/><strong>Initialization took 164 seconds</strong><br/><strong>Ready for connections!</strong></pre>
<p>As you can see, the log output lets you know where you can reach the <kbd>Web Client</kbd> and the Development Server service (for connections with Visual Studio Code with the AL Language extension) for your container (use the IP address for now; more on that later) and which username and password to use.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Pulling new image versions</h1>
                </header>
            
            <article>
                
<p>Note that, by <span>default, Docker </span><span>doesn't check whether there is a new version of the image and tags you to try to download. If you want to make sure you have the current version, you can run the following command, which will always check if there is a newer image:</span></p>
<div>
<pre><strong>docker pull mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>If there is a new version available, it will download it and produce some output that looks similar to what you saw previously. If no new version is available, you will see the following:</p>
<div>
<pre><strong>docker pull mcr.microsoft.com/businesscentral/sandbox</strong><br/><strong>Using default tag: latest</strong><br/><strong>latest: Pulling from businesscentral/sandbox</strong><br/><strong>Digest: sha256:ca99037c70e1eedf21e8472a5d46efeb148dd46a7b16bdf2ddad864e2e4cb97c</strong><br/><strong>Status: Image is up to date for mcr.microsoft.com/businesscentral/sandbox:latest</strong></pre></div>
<p class="mce-root">We can also use more environment parameters<span>,</span> a volume, and port mapping to show you a more advanced example while using the mechanisms we introduced earlier:</p>
<div>
<pre><strong>docker run -e accept_eula=y -e usessl=n -v "c:\dev\addins:c:\program files\Microsoft\Dynamics Business Central\150\Service Tier\Add-ins\mine" -p 80:80 –name mycontainer mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>This achieves the following:</p>
<ul>
<li>It accepts the EULA and tells the image not to use SSL for the <kbd>Web Client</kbd> with the two <kbd>-e</kbd> parameters.</li>
<li>It maps a local folder, <kbd>c:\dev\addins</kbd>, to the <kbd>mine</kbd> subfolder of the <kbd>Add-Ins</kbd> folder of the Business Central Service Tier with the <kbd>-v</kbd> parameter.</li>
<li>It makes port <kbd>80</kbd> available as port <kbd>80</kbd> on your laptop with the <kbd>-p</kbd> parameter. You could also use<kbd>-p 8080:80</kbd>, which causes port <kbd>8080</kbd> on your laptop to go to port <kbd>80</kbd> on the container.</li>
<li>It names the container <kbd>mycontainer</kbd> so that you can easily refer to it with the <kbd>--name</kbd> parameter.</li>
</ul>
<p><span>Now that we have learned about running a local Docker environment, let's have a look at how to connect to an existing SQL Server instance.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Connecting to an existing SQL Server</h1>
                </header>
            
            <article>
                
<p>You can instruct the container to connect to an existing SQL Server and database instead of using the SQL Server inside the container, which will also mean that the SQL Server inside the container will not be started. This is needed if you want to connect multiple instances to the same database, but also makes a lot of sense if you want to run a lot of containers on the same host. Otherwise, you will have one SQL Server running per container, which will need a lot of resources.</p>
<p>In this section, I am assuming there is a SQL Server (in a container or not) called <kbd>sqlserver</kbd> running in your local environment where the Business Central container can reach it. I have a SQL user called <kbd>sqluser</kbd>with a password of <kbd>1SuperSecretPwd!</kbd>, who has the necessary rights to access a Business Central database called <kbd>FinancialsW1</kbd> on that server. For this scenario, the <kbd>docker run</kbd> command would look like this:</p>
<div>
<pre><strong>docker run -e accept_eula=y -e databaseServer=sqlserver -e databaseUsername=sqluser -e "databasePassword=1SuperSecretPwd!" -e databasename=FinancialsW1 mcr.microsoft.com/businesscentral/sandbox</strong></pre>
<p>We get the following output:</p>
<pre><strong>Initializing...</strong><br/><strong>Starting Container</strong><br/><strong>Hostname is c9658bdbe7f0</strong><br/><strong>PublicDnsName is c9658bdbe7f0</strong><br/><strong>Using NavUserPassword Authentication</strong><br/><strong>Starting Internet Information Server</strong><br/><strong>Import Encryption Key</strong><br/><strong>Creating Self Signed Certificate</strong><br/><strong>Self Signed Certificate Thumbprint 87B2FC05A437AFE41966A3E99EFC75A2C2CAD537</strong><br/><strong>Modifying Service Tier Config File with Instance Specific Settings</strong><br/><strong>Starting Service Tier</strong><br/><strong>Creating DotNetCore Web Server Instance</strong><br/><strong>Enabling Financials User Experience</strong><br/><strong>Creating http download site</strong><br/><strong>Creating Windows user admin</strong><br/><strong>Container IP Address: 172.26.151.47</strong><br/><strong>Container Hostname  : c9658bdbe7f0</strong><br/><strong>Container Dns Name  : c9658bdbe7f0</strong><br/><strong>Web Client          : https://c9658bdbe7f0/BC/</strong><br/><strong>Dev. Server         : https://c9658bdbe7f0</strong><br/><strong>Dev. ServerInstance : BC</strong><br/><strong>Files:</strong><br/><strong>http://c9658bdbe7f0:8080/al-4.0.192371.vsix</strong><br/><strong>http://c9658bdbe7f0:8080/certificate.cer</strong></pre>
<p>The following is the final output:</p>
<pre><strong>Initialization took 116 seconds</strong><br/><strong>Ready for connections!</strong></pre>
<p>Note that, in this case, the container will not create any users in the database because it assumes that, if you are using an existing database, you will also have existing users in that database. Also, note that the container will import its own encryption key into the database, which is used to encrypt passwords. So, if you want to connect multiple containers to the same database in that way, you need to make sure the encryption key is shared.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling your running containers with Docker cmdlets</h1>
                </header>
            
            <article>
                
<p>If you need to get a PowerShell session into a running container, you have two options:</p>
<ul>
<li>First, you can use <kbd>Enter-PSSession</kbd>, as if you were connecting to another computer, except you need to give it the full ID of the container instead of the machine name. The easiest way to get there is to use a subcommand querying Docker for that container. Entering a PS session for the <kbd>mycontainer</kbd> container would look like this:</li>
</ul>
<div>
<pre style="padding-left: 60px"><strong>Enter-PSSession -containerid (docker --no-trunc -qf "name=mycontainer")</strong></pre></div>
<p style="padding-left: 60px">The preceding statement <em>only</em> works when you're running as an administrator.</p>
<ul>
<li>The second option is to execute the <kbd>powershell</kbd> command on your container and instruct Docker to open an interactive Terminal for it. This would look as follows for the <kbd>mycontainer</kbd> container:</li>
</ul>
<div>
<pre style="padding-left: 60px"><strong>docker exec -ti mycontainer powershell</strong></pre></div>
<p>With both commands, you end up with a PowerShell session inside your container. If you want to run Business Central cmdlets, the easiest way is to call <kbd>c:\run\prompt.ps1</kbd>, which imports all the development and admin cmdlets.</p>
<p>To see all the currently running containers, you can write and execute <kbd>docker ps</kbd>, which gives you the following output:</p>
<pre><strong>docker ps</strong><br/><strong>CONTAINER ID        IMAGE                                        COMMAND                  CREATED             STATUS                       PORTS                                                NAMES</strong><br/><strong>12cec5da3d89        mcr.microsoft.com/businesscentral/sandbox    "powershell -Comma..."   22 minutes ago      Up 21 minutes (healthy)      80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   determined_shockley</strong><br/><strong>9518e7e456de        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   42 minutes ago      Up 41 minutes (healthy)      80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   testcont</strong><br/><strong>95959a311e54        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   About an hour ago   Up About an hour (healthy)   80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   RKOS-18111</strong><br/><strong>13057bf415cc        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   22 hours ago        Up 22 hours (healthy)        80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   VOEKOM</strong><br/><strong>0e7970ce5318        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   29 hours ago        Up 29 hours (healthy)        80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   Buchau</strong><br/><strong>6c1c44f170bb        mcr.microsoft.com/dynamicsnav:2017-cu22-at   "powershell -Comma..."   46 hours ago        Up 46 hours (healthy)        80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   syAToekom</strong></pre>
<div>
<p>To see all currently existing containers, you can use <kbd>docker ps -a</kbd>, which also includes exited and/or stopped containers (the output also shows a container with a status of <kbd>Exited</kbd>):</p>
</div>
<div>
<pre><strong>docker ps -a</strong><br/><strong>CONTAINER ID        IMAGE                                        COMMAND                  CREATED             STATUS                              PORTS                                                NAMES</strong><br/><strong>12cec5da3d89        mcr.microsoft.com/businesscentral/sandbox    "powershell -Comma..."   24 minutes ago      Exited (1073807364) 9 seconds ago                                                        determined_shockley</strong><br/><strong>9518e7e456de        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   43 minutes ago      Up 43 minutes (healthy)             80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   testcont</strong><br/><strong>95959a311e54        mcr.microsoft.com/dynamicsnav:2017-cu22-de   "powershell -Comma..."   About an hour ago   Up About an hour (healthy)          80/tcp, 443/tcp, 1433/tcp, 7045-7049/tcp, 8080/tcp   RKOS-18111</strong></pre></div>
<p>Stopping and starting containers is as easy as using <kbd>docker stop</kbd> and <kbd>docker start</kbd>, respectively. If you want to remove a container, you need to either stop (<kbd>docker stop</kbd>) and then remove it (<kbd>docker rm</kbd>) or use the <kbd>-f</kbd> parameter for <kbd>docker rm</kbd> to force the removal of the container, even if it's still running.</p>
<div class="packt_infobox">Be aware that removing a container means that all the files inside that container are gone and can't be restored.</div>
<p>If the command is successful, it only returns the name or ID of the container as you specified it:</p>
<div>
<pre><strong>docker rm -f 12</strong></pre>
<p>Note that you can address containers either with their name or with their ID. You don't need to specify the full ID; you just need enough characters from the beginning of the ID so that Docker can uniquely identify the container. Also, note that <kbd>docker ps</kbd> gives you a truncated ID for each container, and you can use <kbd>docker ps –no-trunc</kbd> to get the full ID.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating locally available environments using navcontainerhelper</h1>
                </header>
            
            <article>
                
<p>To make it easier to adopt and use Dynamics 365 Business Central Docker images, Microsoft has created a PowerShell Module called <kbd>navcontainerhelper</kbd>. It uses the same images and commands that you can use with pure Docker commands and, in a lot of places, you can see how the cmdlets translate to Docker commands. It also contains a very valuable collection of additional PowerShell scripts to help with common development, build, test, and release tasks in Dynamics 365 Business Central.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing navcontainerhelper and keeping it updated</h1>
                </header>
            
            <article>
                
<p>To use the <kbd>navcontainerhelper</kbd> module, you need to install it from the PowerShell gallery, as follows:</p>
<pre><strong>install-module navcontainerhelper -force</strong></pre>
<p>If there is a new version of <kbd>navcontainerhelper</kbd>(which, at the time of writing, happens at least every couple of weeks) with new helpful features and bug fixes, just run the following command:</p>
<pre><strong>update-module navcontainerhelper -force</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Your first container</h1>
                </header>
            
            <article>
                
<p>To follow the same examples as in the previous section, you will learn how to run your first container using <kbd>navcontainerhelper</kbd>. However, <kbd>navcontainerhelper</kbd> expects you to give it a name and make a conscious decision about authentication. If you don't provide any other parameters, it assumes that you want to use Windows authentication and asks for your password so that it can create a user with the same username and password inside the container. This also enables <strong>single-sign-on</strong> (<strong>SSO</strong>). Consider the following command:</p>
<div>
<pre><strong>New-NavContainer -accept_eula -imageName mcr.microsoft.com/businesscentral/sandbox mycontainer</strong><br/><br/><strong><span>NavContainerHelper is version 0.6.4.16<br/>NavContainerHelper is running as administrator<br/>Host is Microsoft Windows Server 2019 Datacenter - ltsc2019<br/>Docker Client Version is 19.03.2<br/>Docker Server Version is 19.03.2<br/>Pulling image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>latest-ltsc2019: Pulling from businesscentral/sandbox</span></strong><br/><strong>3889bb8d808b: Already exists</strong><br/><strong>e0718b11f512: Pulling fs layer</strong><br/><strong>…</strong><br/><strong><span>76a160cd3c52: Pull complete<br/>Digest: sha256:3eb2e9d87102c135c1b0c004523abbbe7bff53fc98fe5527a4e85e9ff198d1fd<br/>Status: Downloaded newer image for mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>Using image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>Creating Container mycontainer<br/>Version: 15.0.36626.37711-w1<br/>Style: sandbox<br/>Platform: 15.0.37582.0<br/>Generic Tag: 0.0.9.95</span><span><br/>Container OS Version: 10.0.17763.737 (ltsc2019)<br/>Host OS Version: 10.0.17763.678 (ltsc2019)<br/>Using locale en-US<br/>Using process isolation<br/>Disabling the standard eventlog dump to container log every 2 seconds (use -dumpEventLog to enable)<br/>Files in C:\ProgramData\NavContainerHelper\Extensions\mycontainer\my:<br/>- AdditionalOutput.ps1<br/>- MainLoop.ps1<br/>Creating container mycontainer from image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>db420a5aec3da0b94b2a466432c160f3a28bd7da5ed83d5ea683ee5e7bd330ff<br/>Waiting for container mycontainer to be ready</span></strong><br/><strong><span>Initializing...<br/>Starting Container<br/>Hostname is mycontainer<br/>PublicDnsName is mycontainer<br/>Using Windows Authentication<br/>Starting Local SQL Server<br/>Starting Internet Information Server<br/>Modifying Service Tier Config File with Instance Specific Settings<br/>Starting Service Tier</span></strong><br/><strong><span>Registering event sources<br/>Creating DotNetCore Web Server Instance<br/>Enabling Financials User Experience<br/>Creating http download site<br/>Creating Windows user tobias.fenster<br/>Setting SA Password and enabling SA<br/>Creating SUPER user</span></strong><br/><strong><span>Container IP Address: 172.23.237.104<br/>Container Hostname  : mycontainer<br/>Container Dns Name  : mycontainer<br/>Web Client          : http://mycontainer/BC/<br/>Dev. Server         : http://mycontainer<br/>Dev. ServerInstance : BC<br/></span></strong><br/><strong>Files:</strong><br/><strong>http://mycontainer:8080/al-4.0.192371.vsix</strong><br/><br/><strong>Initialization took 311 seconds</strong><br/><strong>Ready for connections!</strong><br/><strong>Reading CustomSettings.config from mycontainer</strong><br/><strong>Creating Desktop Shortcuts for mycontainer</strong><br/><strong>Container mycontainer successfully created</strong></pre></div>
<p>As you can see from the last couple of lines, <kbd>navcontainerhelper</kbd> even creates convenient desktop shortcuts. They allow you to access the <kbd>Web Client</kbd> or open a PowerShell or Command Prompt inside your container with a simple double-click. The shortcuts actually use the same <kbd>docker exec</kbd> command that you saw in the previous sections.</p>
<p class="mce-root"/>
<p><kbd>New-NavContainer</kbd> has a long list of parameters, which may either be just mappings for environment parameters or very helpful little functions. To give you an example, if you specify <kbd>-updateHosts</kbd>, then <kbd>navcontainerhelper</kbd> will add the name and IP address of the container to the hosts file on your laptop. This means that you don't need to use the IP address <span>– y</span>ou can use the container name as the address! There are, of course, ways to do this without <kbd>navcontainerhelper</kbd>, but none are as easy as specifying one single parameter in your startup command.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Pulling new image versions</h1>
                </header>
            
            <article>
                
<p>Pulling new images works exactly the same for <kbd>navcontainerhelper</kbd> as it does for plain Docker; there's no special command there. However, you can specify <kbd>-alwaysPull</kbd> as a parameter for your <kbd>New-NavContainer</kbd> command, which will <span>–</span>as the name clearly implies <span>–</span>always try to pull a new image version before running your container.</p>
<p>But <kbd>navcontainerhelper</kbd> actually adds more convenient optimizations automatically. If you do not specify <kbd>ltsc2016</kbd>or <kbd>ltsc2019</kbd>as part of your tag, it will determine the best container platform and use that. It also automatically determines whether process isolation is possible and sets the memory limit, if necessary, to 4 GB.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using more environment parameters, a volume, and port mapping</h1>
                </header>
            
            <article>
                
<p>As we mentioned previously, <kbd>New-NavContainer</kbd> provides a lot of parameters that just set environment parameters. We did the following in our previous example using plain <kbd>docker run</kbd>:</p>
<div>
<pre><strong>docker run -e accept_eula=y -e usessl=n -v "c:\dev\addins:c:\program files\microsoft\Dynamics NAV\150\Service Tier\Add-ins\mine" -p 80:80 –name mycontainer mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>To achieve the same in <kbd>navcontainerhelper</kbd>, we would use the following:</p>
<div>
<pre><strong>New-NavContainer -accept_eula -PublishPorts 80 -additionalParameters @('--volume c:\dev\addins:c:\program files\microsoft\Dynamics NAV\150\Service Tier\Add-ins\mine') -containerName mycontainer -imageName mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>Let's compare the features:</p>
<ul>
<li>Accepting the EULA is done with <kbd>-accept_eula</kbd>, and not using SSL is the default for <kbd>navcontainerhelper</kbd>.</li>
<li>The mapping of the local folder to the <kbd>Add-ins</kbd> folder in the container is done with the <kbd>-additionalParameters</kbd> parameter. This is the mechanism in <kbd>navcontainerhelper</kbd> that specifies any <kbd>docker run</kbd> parameter you may need that is not already covered.</li>
<li>Port mapping is done with the <kbd>-PublishPorts</kbd> parameter.</li>
<li>Naming the container is done with the <kbd>-containerName</kbd> parameter.</li>
</ul>
<p>Again, <kbd>navcontainerhelper</kbd> adds more automatically: <kbd>c:\programdata\navcontainerhelper</kbd> is always shared with the container as the same folder inside the container. Also, every container has its own folder at <kbd>c:\programdata\navcontainerhelper\extensions\&lt;containername&gt;</kbd>, and everything local to this container is placed there.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Connecting to an existing SQL Server</h1>
                </header>
            
            <article>
                
<p><kbd>navcontainerhelper</kbd> makes this task just a bit more convenient than using Docker directly. You need to specify the same parameters, but you can give it a credential object instead of putting the username and password in as clear text. As a reminder, the following is what the <kbd>docker run</kbd> command looks like:</p>
<div>
<pre><strong>docker run -e accept_eula=y -e databaseServer=sqlserver -e databaseUsername=sqluser -e "databasePassword=1SuperSecretPwd!" -e databasename=FinancialsW1 mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>The following is the same command but using <kbd>navcontainerhelper</kbd>. It will open a credential entry dialog where you can enter your SQL username and password. But instead of sharing the password as clear text in the environment variables, <kbd>navcontainerhelper</kbd> ensures that passwords are handled securely, as follows:</p>
<div>
<pre><strong>New-NavContainer -accept_eula -databaseServer sqlserver -databaseCredential (Get-Credential) -databaseName FinancialsW1 -imageName mcr.microsoft.com/businesscentral/sandbox:latest -containerName mycontainer -auth NavUserPassword</strong><br/><strong>cmdlet Get-Credential at command pipeline position 1</strong><br/><strong>Supply values for the following parameters:</strong><br/><strong>Credential</strong><br/><br/><strong><span>NavContainerHelper is version 0.6.4.16<br/>NavContainerHelper is running as administrator<br/>Host is Microsoft Windows Server 2019 Datacenter - ltsc2019<br/>Docker Client Version is 19.03.2<br/>Docker Server Version is 19.03.2<br/>Pulling image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>latest-ltsc2019: Pulling from businesscentral/sandbox</span></strong><br/><strong><span>3889bb8d808b: Already exists</span></strong><br/><strong><span>e0718b11f512: Pulling fs layer</span></strong><br/><strong><span>…</span></strong><br/><strong><span>76a160cd3c52: Pull complete<br/>Digest: sha256:3eb2e9d87102c135c1b0c004523abbbe7bff53fc98fe5527a4e85e9ff198d1fd<br/>Status: Downloaded newer image for mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>Using image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>Creating Container mycontainer<br/>Version: 15.0.36626.37711-w1<br/>Style: sandbox<br/>Platform: 15.0.37582.0<br/>Generic Tag: 0.0.9.95<br/>Container OS Version: 10.0.17763.737 (ltsc2019)<br/>Host OS Version: 10.0.17763.678 (ltsc2019)<br/>Using locale en-US<br/>Using process isolation<br/>Disabling the standard eventlog dump to container log every 2 seconds (use -dumpEventLog to enable)<br/>Files in C:\ProgramData\NavContainerHelper\Extensions\mycontainer\my:<br/>- AdditionalOutput.ps1<br/>- MainLoop.ps1<br/>Creating container mycontainer from image mcr.microsoft.com/businesscentral/sandbox:latest-ltsc2019<br/>db420a5aec3da0b94b2a466432c160f3a28bd7da5ed83d5ea683ee5e7bd330ff<br/>Waiting for container mycontainer to be ready</span></strong><br/><strong><span>Initializing...<br/>Starting Container<br/>Hostname is mycontainer<br/>PublicDnsName is mycontainer<br/>Using NavUserPassword Authentication<br/>Starting Internet Information Server<br/>Import Encryption Key<br/>Creating Self Signed Certificate<br/>Self Signed Certificate Thumbprint 583BDDBAB357DB4B4AB722284629195E27328B7E<br/>Modifying Service Tier Config File with Instance Specific Settings<br/>Starting Service Tier<br/>Creating DotNetCore Web Server Instance<br/>Enabling Financials User Experience<br/>Creating http download site<br/>Creating Windows user admin<br/></span><span>Setting SA Password and enabling SA<br/>Creating SUPER user</span></strong><br/><strong><span>Container IP Address: 172.23.237.104<br/>Container Hostname : mycontainer<br/>Container Dns Name : mycontainer<br/>Web Client : http://mycontainer/BC/<br/>Dev. Server : http://mycontainer<br/>Dev. ServerInstance : BC</span></strong><br/><br/><strong><span>Files:</span></strong><br/><strong><span>http://mycontainer:8080/al-4.0.192371.vsix</span></strong><br/><br/><strong><span>Initialization took 99 seconds</span></strong><br/><strong><span>Ready for connections!</span></strong><br/><strong><span>Reading CustomSettings.config from mycontainer</span></strong><br/><strong><span>Creating Desktop Shortcuts for mycontainer</span></strong><br/><strong><span>Container mycontainer successfully created</span></strong></pre></div>
<p>Note that the default authentication mechanism when using <kbd>docker run</kbd> is <kbd>NavUserPassword</kbd>, while the default for <kbd>navcontainerhelper</kbd> is Windows, so in order to achieve the same result, we need to specify that as well.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling your running containers with NavContainerHelper</h1>
                </header>
            
            <article>
                
<p>There is no special command in <kbd>navcontainerhelper</kbd> that lets you see your running containers, so you just use the same <kbd>docker ps</kbd> commands that were introduced in the previous section. There are commands for starting and stopping containers (<kbd>Start-NavContainer</kbd> and <kbd>Stop-NavContainer</kbd>, respectively), but they are very thin wrappers around <kbd>docker start</kbd> and <kbd>docker stop</kbd> with no additional benefits.</p>
<p>Removing containers, however, is done with <kbd>Remove-NavContainer</kbd>, which does a bit more: it cleans up the shortcuts and container-specific folders, and it removes entries in your hosts file if you specify <kbd>-updatehosts</kbd>.</p>
<p class="mce-root"/>
<p>There is also a command to get a session into your container called <kbd>Enter-NavContainer</kbd>. This gives you a PowerShell session inside your container with the added benefit of calling <kbd>c:\run\prompt.ps1</kbd>, which gives you all development and admin cmdlets immediately and a nicely formatted prompt so that you always know where you are. Consider the following command:</p>
<div>
<pre><strong>Enter-NavContainer mycontainer[MYCONTAINER]: PS C:\Run&gt; Get-NAVServerInstance</strong><br/><strong>ServerInstance : MicrosoftDynamicsNavServer$BC</strong><br/><strong>DisplayName    : Dynamics 365 Business Central Server [BC]</strong><br/><strong>State          : Running</strong><br/><strong>ServiceAccount : NT AUTHORITY\SYSTEM</strong><br/><strong>Version        : <span>15.0.37582.0</span></strong><br/><strong>Default : True</strong></pre></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Centrally available on-premise environments</h1>
                </header>
            
            <article>
                
<p>So far, we have only covered locally running containers but, depending on your scenario, you may want to set up one or multiple central VMs that are administered not by the developers and consultants but by an operations team. In this case, the same options that we explained previously exist, but you need to consider a couple of additional topics. You also need to decide whether you want a full self-service environment where a developer or consultant can self-provision a new sandbox or whether you want the operations team to handle creating and deleting the sandboxes.</p>
<p>If your operations team handles these operations, the only topic you need to think about is networking. You have the following two options to make your container ports available outside the Docker host:</p>
<ul>
<li>Port mapping lets you map container ports to host ports. However, this will become tedious over time as you need to find free ports for every container and tell your users which ports to use.</li>
<li>Transparent networking lets the container get its own IP address (static or DHCP) and keep the standard ports. This method works with a lot less maintenance. We will look at this in more detail now.</li>
</ul>
<p class="mce-root"/>
<p>So, creating a transparent network is quite easy. In the simplest scenario, you just write the following to create a transparent network called <kbd>transpNet</kbd>:</p>
<div>
<pre><strong>docker network create -d transparent transpNet</strong></pre></div>
<p>You can also set the subnet or IP range, but that is beyond the scope of this book. Check the online documentation for Docker or run <kbd>docker network create --help</kbd> to learn more about that. Telling a container to use a transparent network is also easy because there is a parameter called <kbd>--network</kbd>. Use it as follows when running pure Docker:</p>
<div>
<pre><strong>docker run -e accept_eula=y --network transpNet mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p><kbd>navcontainerhelper</kbd> doesn't have a specific network parameter on <kbd>New-NavContainer</kbd>at the time of writing, but you can use <kbd>-additionalParametersparameter</kbd> instead:</p>
<div>
<pre><strong>New-NavContainer -accept_eula -additionalParameters @('--network transpNet') -containerName mycontainer -imageName mcr.microsoft.com/businesscentral/sandbox</strong></pre></div>
<p>With that, your container will get its own IP address and you will probably be able to reach it by name from outside your Docker host as well. Please note that this very much depends on the setup of the network that your host is running in. It is similar to adding a new VM to the network and, depending on the security mechanisms that have been put in place by network administrators, this may not actually work without further setup.</p>
<p>If you want to have an environment where developers or consultants can create their own environments, you will have to solve two issues:</p>
<ul>
<li><strong>How would you like container handling to be done (create, start, stop, and delete actions)?</strong> You could allow your users to access the host through RDP or PowerShell, but then it becomes difficult to handle permissions. You can also use tools such as Portainer (<a href="https://portainer.io">https://portainer.io</a>), which is a GUI for handling containers. Here, users can manage their containers and you can, for example, create templates with predefined values for the container parameters. However, note that you won't be able to use <kbd>navcontainerhelper</kbd> in this scenario because that would mean running PowerShell scripts on your host. Another option is to create some kind of frontend application yourself, but that of course will take some time.</li>
<li><strong>How will users access the filesystem in your containers?</strong> It depends on your Dynamics 365 Business Central usage. Often, it is necessary to access the filesystem. If you are already running a full-cloud solution, this is not possible anyway, but if you still have on-premise customers, this may be an issue. The easiest solution is to always map a volume into your container, such as <kbd>c:\shared</kbd>, and allow users to access the folder on the host.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Containers hosted on Azure VMs</h1>
                </header>
            
            <article>
                
<p>If you want to run your sandboxes in Azure VMs, the challenges you face are almost the same as they are with centrally available sandboxes on an on-premise VM. However, you can take some shortcuts: Microsoft provides standard VM images with preinstalled Docker, such as Windows Server 2019 Datacenter with Containers, so you don't have to worry about that.</p>
<p>If you want to use <kbd>navcontainerhelper</kbd>, you need to install it, and then you are ready to go. An even quicker way is to use one of the quick start templates provided by Microsoft, such as <a href="http://aka.ms/getbc">http://aka.ms/getbc</a>. This will create an Azure VM, install Docker and <kbd>navcontainerhelper</kbd>, pull the latest Dynamics 365 Business Central image (defaulting to the on-premise image), and start it for you. And on top of that, you get a nice log showing you how all the magic that is happening is progressing. Afterward, you can use that VM to create additional sandboxes as you need them.</p>
<p>However, there is one issue in Azure VMs that makes handling them a bit more complicated: you can't use transparent networking. This makes sense for a number of reasons and likely won't change in the near future, so you have to consider other solutions. One would be port mapping, as we mentioned previously, but that also takes quite a lot of maintenance. The easiest way is to use a reverse proxy such as nginx or Traefik, but that is also beyond the scope of this book.</p>
<p>You can find a quick introduction on how to get started at<a href="https://www.axians-infoma.de/techblog/running-multiple-nav-bc-containers-on-an-azure-vm/">https://www.axians-infoma.de/techblog/running-multiple-nav-bc-containers-on-an-azure-vm/</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Choosing the right image</h1>
                </header>
            
            <article>
                
<p>Now that you know how to create and run your sandboxes, the only question is which version you want to use; making this decision may be quite complex. The basics for making a viable decision on that topic will be summarized in this section.</p>
<p class="mce-root"/>
<p>Officially, publicly released versions are always available on the registry (<kbd>mcr.microsoft.com</kbd>) with the following repositories and image names:</p>
<ul>
<li><kbd>mcr.microsoft.com/businesscentral/sandbox</kbd>: The sandbox image of the SaaS version of Dynamics 365 Business Central</li>
<li><kbd>mcr.microsoft.com/businesscentral/onprem</kbd>: The on-premise version of Dynamics 365 Business Central</li>
<li><kbd>mcr.microsoft.com/dynamicsnav</kbd>: The old Dynamics NAV product, starting from Dynamics NAV 2016</li>
</ul>
<p>Previews of unreleased versions are available on the <kbd>bcinsider.azurecr.io</kbd> registry with the following repositories and images names:</p>
<ul>
<li><kbd>bcinsider.azurecr.io/bcsandbox</kbd>: A preview of the next minor release of the SaaS version of Dynamics 365 Business Central</li>
<li><kbd>bcinsider.azurecr.io/bconprem</kbd>: A preview of the next minor release of the on-premise version of Dynamics 365 Business Central</li>
<li><kbd>bcinsider.azurecr.io/bcsandbox-master</kbd>: A preview of the next major release of the SaaS version of Dynamics 365 Business Central</li>
<li><kbd>bcinsider.azurecr.io/bconprem-master</kbd>: A preview of the next major release of the on-premise version of Dynamics 365 Business Central</li>
</ul>
<p>Note that, once again, you need login credentials for <kbd>bcinsider.azurecr.io</kbd>, which you can get from Microsoft's collaborate platform after you have registered for the Ready to Go! program.</p>
<p>When you have decided which image to use, you also need to decide on which tag to use, representing one of the specific releases by Microsoft. All images allow you to specify the language (<kbd>gb</kbd>, <kbd>de</kbd>, <kbd>dk</kbd>, and so on) and the base OS (<kbd>ltsc2016</kbd> for Windows Server 2016 and <kbd>ltsc2019</kbd> for Windows Server 2019). The released on-premise versions also allow you to use the same naming conventions that you can use with traditional installs by referencing them by their cumulative update name.</p>
<p>Consider the following examples, just to get some insight into the syntax:</p>
<ul>
<li>Dynamics 365 Business Central Fall 2018 (1810), CU 11, German version, based on Windows Server 2016:</li>
</ul>
<pre style="padding-left: 60px">mcr.microsoft.com/businesscentral/onprem:1810-cu11-de-ltsc2016</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<ul>
<li>Dynamics 365 Business Central Spring 2019 (1904), CU 5, Danish version, based on Windows Server 2019:</li>
</ul>
<pre style="padding-left: 60px">mcr.microsoft.com/businesscentral/onprem:1904-cu5-dk-ltsc2019</pre>
<ul>
<li>Dynamics 365 Business Central Fall 2019 (1910), CU 1, Australian version, based on Windows Server 2019:</li>
</ul>
<pre style="padding-left: 60px">mcr.microsoft.com/businesscentral/onprem:1910-cu1-au-ltsc2019</pre>
<ul>
<li>Dynamics NAV 2017, CU 28, British version, based on Windows Server 2019:</li>
</ul>
<pre style="padding-left: 60px">mcr.microsoft.com/businesscentral/dynamicsnav:2017-cu28-gb-ltsc2019</pre>
<p>The SaaS versions that have been released allow you to specify the update version instead of the cumulative update:</p>
<ul>
<li>Dynamics 365 Business Central SaaS Update 25, Spanish version, based on Windows Server 2016:</li>
</ul>
<pre style="padding-left: 60px">mcr.microsoft.com/businesscentral/sandbox:update25-es-ltsc2016</pre>
<p>The preview version allows you to only specify the language and the Windows Server version:</p>
<ul>
<li>The latest preview of the next minor release of the SaaS version of Dynamics 365 Business Central, German version, based on Windows Server 2019: <kbd>bcinsider.azurecr.io/bcsandbox:de-ltsc2019</kbd></li>
<li>The latest preview of the next major release of the on-premise version of Dynamics 365 Business Central, Danish version, based on Windows Server 2016: <kbd>bcinsider.azurecr.io/bconprem-master:dk-ltsc2016</kbd></li>
</ul>
<p>There are defaults if you don't specify everything, so <kbd>mcr.microsoft.com/businesscentral/onprem</kbd> will give you the latest cumulative update of the latest Dynamics 365 Business Central on-premise release, W1 version, based on Windows Server 2016. In order to avoid surprises, it almost always makes sense to specify as much as possible with tags.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Modifying scripts inside standard images</h1>
                </header>
            
            <article>
                
<p>As you have seen, Dynamics 365 Business Central container images have a lot of configuration options, giving you the possibility to change a lot of their behavior. However, if you ever run into a situation where you need to run a different container configuration setup, images have one more ace up their sleeve: you can override any script in the container.</p>
<p>The mechanism for this works by placing a script with the exact same name as the one you want to override into the <kbd>c:\run\my</kbd> folder in your container. The easiest way to do that is through a volume. Assuming that you have a folder such as <kbd>c:\bc-override</kbd> with an<kbd>AdditionalSetup.ps1</kbd> file, you can do the following:</p>
<div>
<pre><strong>docker run -e accept_eula=y -v c:\bc-override:c:\run\my mcr.microsoft.com/businesscentral/onprem</strong></pre></div>
<p>When the container gets to the place where <kbd>AdditionalSetup.ps1</kbd> is called, it checks whether a file with that name exists in <kbd>c:\run\my</kbd> and if so, calls it. If not, it calls the standard script with that name, which is stored in <kbd>c:\run</kbd>. This script may look as follows:</p>
<div>
<pre><strong>Write-Host "----- Hello from the override script <span>--------------------</span>"</strong></pre></div>
<p>If it does, you will get the following output when starting the container:</p>
<div>
<pre><strong>Initializing...</strong><br/><strong>Starting Container</strong><br/><strong>Hostname is 4e58d9587fb0</strong><br/><strong>PublicDnsName is 4e58d9587fb0</strong><br/><strong>Using NavUserPassword Authentication</strong><br/><strong>Starting Local SQL Server</strong><br/><strong>Starting Internet Information Server</strong><br/><strong>Creating Self Signed Certificate</strong><br/><strong>Self Signed Certificate Thumbprint 1462D57EE355D19018232160C396159313A20893</strong><br/><strong>Modifying Service Tier Config File with Instance Specific Settings</strong><br/><strong>Starting Service Tier</strong><br/><strong>Creating DotNetCore Web Server Instance</strong><br/><strong>Enabling Financials User Experience</strong><br/><strong>Creating http download site</strong><br/><strong>Creating Windows user admin</strong><br/><strong>Setting SA Password and enabling SA</strong><br/><strong>Creating admin as SQL User and add to sysadmin</strong><br/><strong>Creating SUPER user</strong><br/><strong>----- Hello from the override script --------------------</strong><br/><strong>Container IP Address: 172.26.148.48</strong><br/><strong>Container Hostname  : 4e58d9587fb0</strong><br/><strong>Container Dns Name  : 4e58d9587fb0</strong><br/><strong>Web Client          : https://4e58d9587fb0/BC/</strong><br/><strong>Admin Username      : admin</strong><br/><strong>Admin Password      : Rohy1060</strong><br/><strong>Dev. Server         : https://4e58d9587fb0</strong><br/><strong>Dev. ServerInstance : BC</strong><br/><strong>Files:</strong><br/><strong>http://4e58d9587fb0:8080/<span>al-4.0.192371.vsix</span></strong><br/><strong>http://4e58d9587fb0:8080/certificate.cer</strong><br/><strong>Initialization took 117 seconds</strong><br/><strong>Ready for connections!</strong></pre></div>
<p>Using the <kbd>navcontainerhelper</kbd> utility, you would call it like this:</p>
<div>
<pre><strong>New-NavContainer -accept_eula -imageName mcr.microsoft.com/businesscentral/sandbox -myScripts @("c:\bc-override\AdditionalSetup.ps1") mycontainer</strong></pre></div>
<p>Alternatively, since<kbd>navcontainerhelper</kbd> has a more convenient way of doing things, you can just add your PowerShell script code inline:</p>
<pre><strong>New-NavContainer -accept_eula -imageName mcr.microsoft.com/businesscentral/sandbox -myscripts @( @{ "AdditionalSetup.ps1" = "Write-Host ‘<span>----- Hello from the override script </span><span>--------------------</span>'" } ) mycontainer</strong></pre>
<p>With this very powerful feature, you can change every script in the container to suit your needs. To get an idea of what you can adjust, please check out <a href="https://github.com/Microsoft/nav-docker/tree/master/generic/Run">https://github.com/Microsoft/nav-docker/tree/master/generic/Run</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating your own images</h1>
                </header>
            
            <article>
                
<p>With the mechanism we just saw, we can change everything inside our containers. But what if you want to make sure that your colleagues, partners, or customers get exactly those same modifications without the need to get the my-scripts override right? Or what if you need some DLLs or other files inside your container and want to deliver them as part of your own image? The answer to that is building your own image, which, fortunately, is very easy as well.</p>
<p class="mce-root"/>
<p>Docker has a layering concept that makes an image a stack of layers. All you need to do is put your own layer on top of the standard image. You can do that by using a Dockerfile, which needs a reference to the standard image you want to extend and then the actions you want to take. Let's say you want to place some DLLs stored in <kbd>c:\bc\dlls</kbd> into the image <kbd>Add-ins</kbd> folder and put your own <kbd>AdditionalSetup.ps1</kbd> script from the <kbd>c:\bc\override</kbd> folder into the <kbd>c:\run</kbd> image folder. Your Dockerfile would look as follows, stored in the <kbd>c:\bc</kbd> folder:</p>
<pre><strong>FROM mcr.microsoft.com/businesscentral/sandbox</strong><br/><strong>COPY ["./dlls/*", "c:/Program Files/Microsoft Dynamics NAV/150/Service/Add-ins/"]</strong><br/><strong>COPY ./override/AdditionalSetup.ps1 c:/run/</strong></pre>
<p>To build this image, you need to run the <kbd>docker build</kbd> command in <kbd>c:\bc</kbd> and give your image a name using the <kbd>-t</kbd> parameter:</p>
<pre><strong>docker build -t myimage</strong></pre>
<p>The result will look something like the following:</p>
<div>
<pre><strong>Sending build context to Docker daemon 7.168kB</strong><br/><strong>Step 1/3 : FROM mcr.microsoft.com/businesscentral/sandbox</strong><br/><strong> ---&gt; 20f72db6c9a9</strong><br/><strong>Step 2/3 : COPY ./dlls/* c:/Program Files/Microsoft Dynamics NAV/150/Service/Add-ins/</strong><br/><strong>---&gt; f202642914a9</strong><br/><strong>Step 3/3 : COPY ./override/AdditionalSetup.ps1 c:/run/</strong><br/><strong> ---&gt; 1164c1273517</strong><br/><strong>Removing intermediate container e9070e72cbaa</strong><br/><strong>Successfully built 1164c1273517</strong><br/><strong>Successfully tagged myimage:latest</strong></pre></div>
<p>With that in place, you can use your image like any other image:</p>
<pre><strong>docker run -e accept_eula=y myimage</strong></pre>
<p>The way to share this image with others is via a <strong>Docker repository</strong>. For an image that's been built on top of the official Microsoft image, this will be done with a private repository. How to set that up is beyond the scope of this book, but <a href="https://docs.docker.com/registry/">https://docs.docker.com/registry/</a> is a good starting point if you want to learn more.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we learned about the basics of online and Docker-based sandboxes and how to use them optimally. We stressed the need to master the <span>fundamentals of </span>Docker and how to create a basic container from a Dynamics 365 Business Central image from an online repository.</p>
<p>With the skills you've acquired from this chapter, you should be able to create your own containers, choose the right image, and be familiar with the <kbd>navcontainerhelper</kbd> tool when it comes to handling your custom sandbox environment.</p>
<p>You should also be able to master Dockerfile formats and perform in-depth modifications of standard images by overriding scripts and creating your own Dynamics 365 Business Central sandbox baseline.</p>
<p>In the next chapter, we will start our development journey by learning about AL language fundamentals.</p>


            </article>

            
        </section>
    </body></html>