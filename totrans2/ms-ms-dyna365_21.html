<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Integrating Machine Learning into Dynamics 365 Business Central</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we gave <span>an overview of the Microsoft Power Platform, and we saw how to use Dynamics 365 Business Central with Flow and PowerApps to solve business tasks with zero coding.</span></p>
<p>In this chapter, we'll talk about a topic that has been emerging over the last few years: <strong>Machine Learning</strong> (<strong>ML</strong>) with Dynamics 365 Business Central. The year 2019 is the year of <strong>Artificial Intelligence</strong> (<strong>AI</strong>). You hear about AI everywhere. The world is telling us: <em>If you want to be on top, apply AI</em>. But what is AI? How does it differ from classical programming? What is going on behind the scenes?</p>
<p>The aim of this chapter is not for you to become a <span>true data scientist or ML master, but to get</span> a clear understanding of the basics of AI and some experience of how to embed AI into your Dynamics 365 Business Central projects.</p>
<p>In this chapter, we cover the following topics:</p>
<ul>
<li>What ML <span>is </span>and an overview of its main processes</li>
<li>Dynamics 365 Business Central ML Framework overview</li>
<li>Using ML in your Dynamics 365 Business Central applications</li>
<li>Understanding the Prediction API</li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What are AI and ML?</h1>
                </header>
            
            <article>
                
<p>AI consists of tasks that are characteristic of human intelligence, such as language and speech understanding, recognizing objects and sounds, and planning. The word <em>tasks</em> is used because, technically, you can complete these tasks with two different approaches: classical programming and ML.</p>
<p>At the beginning of 1990, some companies introduced <strong>Optical Character Recognition</strong> (<strong><span>OCR</span></strong>) <span>software</span>. They invested millions of dollars and hired hundreds of developers who wrote code to recognize handwritten text. This was classical programming with simple tools, such as <kbd>if-else</kbd>. The approach worked, but the result was quite poor. The accuracy was low and the number of mistakes was high.</p>
<p>Why did this approach fail? Because what is natural for a human brain is very difficult to be programmed.</p>
<p>So, how we can solve this task in another way? The answer is ML!</p>
<div class="packt_quote">"Machine learning is the process by which a machine (computer) is capable of showing behavior that has not been explicitly programmed into it"</div>
<div class="packt_quote CDPAlignRight CDPAlign">– Arthur Samuel, 1959                     </div>
<p>Or, in other words: computers learn from data to perform predictive analytics.</p>
<p>As you can see, instead of writing code, to create ML functions, we need something else: data.</p>
<p>So, let's cover this process in detail in the following sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">An overview of the ML process</h1>
                </header>
            
            <article>
                
<p>According to its definition, ML <span>is an application of AI that provides systems with the abili</span><span>ty to learn and improve on their own, from experience, and not by being explicitly programmed.</span></p>
<p>Here is the classic ML process. It's when you try to predict an answer based on answers from previous experience:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/58038a1b-78bd-4958-9ffe-875c0de8ddb4.png" style="width:42.25em;height:17.75em;"/></p>
<p>Let's go through the preceding diagram in detail:</p>
<ol>
<li><strong>Define a question</strong><span>: ML </span>is not a magic box. To get an answer, you should know the question, and you should build a model that will answer that exact question.</li>
</ol>
<p style="padding-left: 60px">Remember: the exact question is the key to the right answer!</p>
<ol start="2">
<li><strong>Find data</strong>: You should find data that will answer your question. The data, which, in (ML) terminology, is usually called a <em>dataset</em><span>, should be relevant, complete, exact, and sufficient. In this chapter, we will use Dynamics 365 Business Central as business-related data storage.</span></li>
<li>
<p><strong>Prepare your data</strong>: <span>To make the ML training process possible, you should join all of your tables in one table (dataset). You should define which field you want to predict (the label) and which fields influence the predictions (the features).</span></p>
</li>
<li>
<p><strong>Train the ML model</strong>: <span>During this step, you create ML models by applying a training dataset to the ML algorithm.</span></p>
</li>
<li>
<p><strong>Test your trained ML model</strong>:<strong> </strong><span>To understand the quality of predictions and to calculate ML model accuracy, you need also a</span> <em>test dataset</em><span>. The test</span><span> dataset should be different from the training dataset but have the same structure.</span></p>
</li>
</ol>
<p style="padding-left: 60px">For example, here is our training dataset:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 120px">
<p class="CDPAlignLeft CDPAlign"><strong>Date</strong></p>
</td>
<td style="width: 204px">
<p><strong>Sales Amount</strong></p>
</td>
</tr>
<tr>
<td style="width: 120px">
<p>01.11.17</p>
</td>
<td style="width: 204px">
<p>100</p>
</td>
</tr>
<tr>
<td style="width: 120px">
<p>18.11.17</p>
</td>
<td style="width: 204px">
<p>150</p>
</td>
</tr>
<tr>
<td style="width: 120px">
<p>08.12.17</p>
</td>
<td style="width: 204px">
<p>250</p>
</td>
</tr>
<tr>
<td style="width: 120px">
<p>17.12.17</p>
</td>
<td style="width: 204px">
<p>260</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">This is what we used to create the <kbd>F(day) = "sales amount"</kbd> <span>ML model</span><span>, </span>and here is our test dataset:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 87px">
<p><strong>Date</strong></p>
</td>
<td style="width: 209px">
<p><strong>Sales Amount</strong></p>
</td>
</tr>
<tr>
<td style="width: 87px">
<p>05.11.17</p>
</td>
<td style="width: 209px">
<p>140</p>
</td>
</tr>
<tr>
<td style="width: 87px">
<p>15.12.17</p>
</td>
<td style="width: 209px">
<p>240</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">We take features from <span><span>the test dataset </span></span>and apply them to our trained ML model to predict labels:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 59px">
<p><strong>Date</strong></p>
</td>
<td style="width: 202px">
<p><strong>Sales Amount</strong></p>
</td>
<td style="width: 212.2px">
<p><strong>Predicted Sales Amount</strong></p>
</td>
</tr>
<tr>
<td style="width: 59px">
<p>05.11.17</p>
</td>
<td style="width: 202px">
<p>140</p>
</td>
<td style="width: 212.2px">
<p>137</p>
</td>
</tr>
<tr>
<td style="width: 59px">
<p>15.12.17</p>
</td>
<td style="width: 202px">
<p>240</p>
</td>
<td style="width: 212.2px">
<p>245</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">Then, we compare <span class="packt_screen">Sales Amount</span> with <span class="packt_screen">Predicted Sales Amount</span> and get the model's accuracy:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p><strong>Date</strong></p>
</td>
<td>
<p><strong>Sales Amount</strong></p>
</td>
<td>
<p><strong>Predicted Sales Amount</strong></p>
</td>
<td>
<p><strong>Difference, %</strong></p>
</td>
</tr>
<tr>
<td>
<p>05.11.17</p>
</td>
<td>
<p>140</p>
</td>
<td>
<p>137</p>
</td>
<td>
<p>2.1%</p>
</td>
</tr>
<tr>
<td>
<p>15.12.17</p>
</td>
<td>
<p>240</p>
</td>
<td>
<p>245</p>
</td>
<td>
<p>2.1%</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">So, the accuracy of our model is 97.9%.</p>
<ol start="6">
<li><strong>Publish the ML model as a web service</strong>: When you are satisfied with the model's accuracy, you can publish your model as a web service and consume it from everywhere to predict the future from new features. If I call the published model for future dates, the results show predictions for future dates, as shown in the following table:</li>
</ol>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 60.8px">
<p><strong>Date</strong></p>
</td>
<td style="width: 187.2px">
<p><strong>Predicted Sales Amount</strong></p>
</td>
</tr>
<tr>
<td style="width: 60.8px">
<p>06.11.18</p>
</td>
<td style="width: 187.2px">
<p>115</p>
</td>
</tr>
<tr>
<td style="width: 60.8px">
<p>16.12.18</p>
</td>
<td style="width: 187.2px">
<p>255</p>
</td>
</tr>
</tbody>
</table>
<p class="mce-root"/>
<p class="mce-root"><span>With a well-trained ML model, you can easily get predictions using your data.</span></p>
<p>Next, let's see how the Business Central ML Framework works.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Understanding the Business Central ML Framework</h1>
                </header>
            
            <article>
                
<p>Building your own (custom) ML model from scratch could be complicated. It usually requires experience in Python, R, or services such as Azure ML Studio. If you don't want to invest in that but still want to use the power of AI with your data, you can use <strong>Dynamics 365 Business Central ML Framework</strong>.</p>
<p>Technically, it can be divided into four different frameworks:</p>
<ul>
<li>The Time Series API</li>
<li>The ML Prediction API</li>
<li>The custom Azure ML API</li>
<li>The custom Vision API</li>
</ul>
<p>Each framework is intended for its own task and uses different algorithms:</p>
<ul>
<li>For example, with the <strong>Time Series API</strong>, you can predict numbers (such as sales and quantities) with the power of regression algorithms just by knowing dates and numbers from the past.</li>
<li>With the <strong>ML Prediction API</strong>, you can predict classes, such as yes/no or colors.</li>
<li>The <strong>Custom Azure ML API</strong> allows you to connect to your custom model, built in <strong>Azure ML Studio</strong>.</li>
<li>The <strong>Custom Vision API</strong> allows you to connect to your custom model, built in <strong>Custom Vision</strong>.</li>
</ul>
<p>In the next sections, we will focus on the <strong>Time Series</strong> and <strong>ML Prediction APIs</strong>, as they are the simplest and don't require ML experience, but they're still powerful. </p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The Time Series API</h1>
                </header>
            
            <article>
                
<p>In this example, let's assume that you are the owner of a restaurant and you want to predict how many items from the menu your customers will order in the next 7 days.</p>
<p>You have the following <span>sales </span>history:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/89864f7f-b462-4f56-a816-bab64e31d69a.png"/></p>
<p>In this dataset, you have 38,325 rows and 11 columns. The sales history entries exist from January 10, 2015 to December 9, 2018. The dataset can be found at <a href="https://dkatsonpublicdatasource.blob.core.windows.net/machinelearning/AML-restaurant-sales-by-menu-item.csv">https://dkatsonpublicdatasource.blob.core.windows.net/machinelearning/AML-restaurant-sales-by-menu-item.csv</a>.</p>
<p>You can call the <strong>Time Series API</strong> using AL Language code to get predictions about <strong>orders</strong>. Then, we can check the quality of the predictions programmatically before displaying them to the end user. Let's see how to do this.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 1 – Downloading the dataset to Dynamics 365 Business Central</h1>
                </header>
            
            <article>
                
<p>Perform the following steps to download the dataset into Business Central:</p>
<ol>
<li>Create a new AL project in Visual Studio Code and clone this GitHub repository: <a href="https://github.com/dkatson/BC-ML-Framework">https://github.com/dkatson/BC-ML-Framework</a>. You will get a new <kbd>RestSalesEntry</kbd><span> table (and a page) where you can save this dataset, and a new codeunit,</span> <kbd>RefreshRestSales</kbd><span><span>, that will upload this dataset from an external source:</span></span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/cd3cfd6f-4880-47e0-ac13-9fab7a796498.png"/></p>
<ol start="2">
<li>When you publish this app, you'll see this page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f23c9c76-5fb8-4014-bcbb-e2c47de8b35e.png"/></p>
<ol start="3">
<li>Click on the <span class="packt_screen">Refresh restsales</span> button, and you will see this dataset inside Dynamics 365 Business Central:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d876af65-f6a0-4467-b82a-6fd70287319f.png"/></p>
<p>Now, you have data in place, but to make predictions, you need to have an ML model published as a web service, where you will send data to get predictions back. So, for this, we move to the second step.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 2 – Publishing a model as a web service from a public template</h1>
                </header>
            
            <article>
                
<p>With a few clicks, you can create a model from a public template and publish an endpoint that serves only your needs. Enter the following URL in your favorite browser:</p>
<p><a href="https://gallery.cortanaintelligence.com/Experiment/Forecasting-Model-for-Microsoft-Dynamics-365-for-Financials-1">https://gallery.cortanaintelligence.com/Experiment/Forecasting-Model-for-Microsoft-Dynamics-365-for-Financials-1</a> </p>
<p>This is a publicly available model prepared by the Microsoft ERP team and aimed at time series predictions:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4bfe2fd4-3cfe-4854-88b4-3178bd2ff72f.png"/></p>
<p>Now, follow these steps:</p>
<ol>
<li>Click on the <strong>Open in Studio</strong> button.</li>
<li>Choose <strong>Free Workspace</strong> or <strong>Standard Workspace</strong>.</li>
<li>Sign in to your Microsoft account.</li>
<li>Click the <strong>OK</strong> button to copy the experiment from the gallery.</li>
<li>Keep the default values in the <strong>Region</strong> and <strong>Workspace</strong> fields, unless you are an experienced user of Azure ML.</li>
<li>Click on the <strong>Run</strong> button at the bottom of the experiment canvas.</li>
<li>Click on the <strong>Deploy Web Service | Deploy Web Service (Classic)</strong> button at the bottom of the experiment canvas.</li>
</ol>
<p class="mce-root"/>
<p>The system deploys the Azure ML experiment as web services and provides a RESTful API that can be consumed by a wide range of devices and platforms, including Dynamics 365 Business Central:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/993ae2f5-3c19-4b87-a9db-f1cc821c79e3.png"/></p>
<p>When the deployment is finished, the web services dashboard opens.</p>
<p>Here, you can see the API key and two available APIs: <span class="packt_screen">Request/Response</span> and <span class="packt_screen">Batch Execution</span>. The current version of the Time Series API that is shipped with Dynamics 365 Business Central supports the Request/Response API. At the bottom of the API help page, you can find input and output definitions and code samples. However, the request URI is the only thing you need for this example.</p>
<p class="mce-root"/>
<p>Now, follow these steps:</p>
<ol>
<li>Copy and paste the API key in a text file to save it although you can also access it later.</li>
<li>Click on the <strong>Request/Response</strong> link to open the API help page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4657c5e4-8af4-4559-9f3e-f2ff9ab7f441.png"/></p>
<ol start="3">
<li>After that, copy and paste the request URI in a text file to save it although you can also access it later:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/03ad5ede-9667-4c66-bbf0-b5a3fc8b8ff1.png"/></p>
<p class="mce-root"/>
<p>That's it. This ML model, which can predict any figure, including <em>orders</em> (from our example) is now published, and you can call it from the Dynamics 365 Business Central Time Series API.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 3 – Sending your data from Business Central to the ML endpoint to get predictions</h1>
                </header>
            
            <article>
                
<p>The next step is to send the data to the endpoint to receive predictions. Let's see how that happens:</p>
<ol>
<li>Open your AL project in Visual Studio Code, cloned from <a href="https://github.com/dkatson/BC-ML-Framework">https://github.com/dkatson/BC-ML-Framework</a>, and switch to the <kbd>Time-Series-API</kbd> branch. Here, p<span>ress</span> <em>Ctrl</em> + <em>Shift</em> + <em>P</em> <span>and type</span> <kbd>checkout</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c1fc0bea-1b29-400a-9634-430d2d44e20e.png" style="width:36.67em;height:8.67em;"/></p>
<ol start="2">
<li>Now, select a branch:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f4953f68-f053-4762-a715-2d381842b84b.png" style="width:37.17em;height:10.58em;"/></p>
<p>This is the upgraded version of the restaurant example extension.</p>
<p>The differences between this and the previous one are as follows:</p>
<ul>
<li>Demonstration data (demo items and sales history) is loaded automatically when you install the app.</li>
<li>A new action appears in the Item Card – <kbd>Update Rest. Forecast</kbd>.</li>
</ul>
<p>Let's look at how it works.</p>
<p>There is a new codeunit called <kbd>Calculate Rest. Forecast</kbd> with the main function, <kbd>CalculateRestForecast</kbd>, and two additional functions, <kbd>getMLUri</kbd> and <kbd>getMLKey</kbd><em>. </em>Insert your URI and a key (copied from <em>step 2</em>) into these functions:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/02735bfa-4545-4539-96a8-f9952426e226.png"/></p>
<p class="mce-root"/>
<p>Let's investigate the <kbd>CalculateRestForecast</kbd> function's variables:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/31ed2dec-85bd-4d50-8964-de9990df2ef7.png"/></p>
<p>From the preceding screenshot, we understand the following:</p>
<ul>
<li><kbd>TimeSeriesMgt</kbd> is a time series library, which prepares the data, submits it to the Azure ML, and gets the prediction.</li>
<li><kbd>RestSalesEntry</kbd> is our history dataset, which we will use to prepare the data, and which we will send to the Azure ML web service to get the predictions.</li>
<li><kbd>TempTimeSeriesForecast</kbd> is prepared data that we will send to the Azure ML web service to get the predictions.</li>
<li><kbd>TimeSeriesModel</kbd> is the name (or combination) of regression algorithm(s) that will be applied to the prepared data inside of Azure ML web service to get predictions.</li>
<li><kbd>TempTimeSeriesBuffer</kbd> is our prediction that was received from the Azure ML web service.</li>
</ul>
<p>Let's investigate the <kbd>CalculateRestForecast</kbd> function's business logic. The whole task can be done with four functions from the <kbd>Time Series Management</kbd> variable. Here, <kbd>Initialize</kbd> is used to set up the connection:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bca0c9ef-6c5f-464f-ba86-12894f88eda2.png" style="width:35.33em;height:16.00em;"/></p>
<p>Now, prepare the historical data that you will use for predictions. In our case, we will predict <kbd>orders</kbd> by items, which means that one call to the ML web service will return <kbd>orders</kbd> predictions for one item. So, it makes sense to filter the sales history dataset by one item per call:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/46d4ee2a-6171-4fb5-bc26-53fa9547153a.png" style="width:39.08em;height:20.33em;"/></p>
<p class="mce-root"/>
<p><kbd>PrepareData</kbd> transforms any table data into a dataset that is ready for submission. Specify the source table and the field to be used for grouping. Remember that the Time Series API requires the date as the second grouping of fields. Choose a label —the field that you want to predict. It should contain numerical values<span>—</span>decimals or integers.</p>
<p>In our case, we will specify the <kbd>date</kbd> field from <kbd>RestSalesEntry</kbd> as a date, <kbd>menu_item_id</kbd> as a group field, and <kbd>orders</kbd> as a predictive field.</p>
<p>Also, we specify that <kbd>Period type</kbd> is equal to <kbd>day</kbd> (because we have historical transactions for each day), <kbd>start day</kbd> for the predictions will be the current <kbd>work date</kbd>, and the number of historical entries that will be used to calculate an <kbd>orders</kbd> prediction will be all of the entries we have:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/81b8bbc6-f425-447a-a69c-0fa20bf74a1f.png"/></p>
<div class="packt_infobox">The number of historical periods tells the system how many periods it should take from the past, starting from the forecast date. This means that if you have holes in your historic dataset, then it will also include them in the calculation.</div>
<p>In our case, our historical data finishes at 2018-12-09. And we want to forecast starting from 2019-01-05. We have a hole of about 6 months. That means that the <kbd>PrepareData</kbd> function will fill that hole with zero entries and, as a result, will exclude 6 months of historical data, starting from the beginning (2015-01-10):</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/dacc2060-f6a4-4d7d-8e1b-51b9b4e90d63.png"/></p>
<p>You can avoid that by playing with the <kbd>ObservationPeriod</kbd> parameter.</p>
<p>Once the data is prepared, you can read it and modify it before sending it to Azure Machine Learning Service. For example, here, we had a missing period in our <kbd>RestSalesEntry</kbd> dataset. During the <kbd>PrepareData</kbd> stage, there are system-generated zero (0) entries. If we send this dataset as is, Machine Learning Service will think that we had no sales for that period, and that will dramatically influence sales predictions for the future. To avoid that, we need to exclude zero entries from the prepared dataset:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/639a8f49-d5ce-4003-8c25-f4317d2bcd26.png" style="width:50.17em;height:35.67em;"/></p>
<p>The <kbd>Forecast</kbd> function sends the final prepared dataset to the Azure ML web service, which calculates the forecast according to specified parameters and returns the forecast result. Let's investigate the input parameters:</p>
<ul>
<li><kbd>ForecastingPeriods</kbd>:<em> </em>This is the<em> </em>number of days/months/years for the future forecast that you want to get—a specific period type equal to what you specified in the <kbd>PrepareData</kbd> function.</li>
<li><kbd>ConfidenceLevel</kbd>: This is the minimum probability of the forecast result. If you specify 0, it will use 80%, or you can specify the exact percentage. You can try different values and see how it will change. We don't recommend using a value higher than 95.</li>
<li><kbd>TimeSeriesModel</kbd><em>:</em> This is a statistical algorithm that is used by the Azure ML web service to create forecasts based on the prepared historical dataset you send. It could be ARIMA, ETS, or STL. It also could be a combination of ETS + ARIMA, ETS + STL, or all three.</li>
</ul>
<p>In our case, we will calculate an <kbd>orders</kbd> forecast for the next 7 days with a minimum probability of 80%, and we will apply all of the statistical algorithms and calculate the average result:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/60e941a5-7a45-4158-a09c-92730e5566d8.png"/></p>
<p><kbd>GetForecast</kbd> populates the <kbd>TempTimeSeriesForecast</kbd> table with the forecast results, which you can then use anywhere:</p>
<p class="mce-root"/>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0a926237-2226-4d2a-8395-57423b571a16.png"/></p>
<p>The simplest way to investigate the results is to create a list page with the <kbd>TempTimeSeriesForecast</kbd> table:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c6207ecd-0737-48df-a22e-ed3ee931bc05.png" style="width:41.67em;height:7.75em;"/></p>
<p>Let's publish this app and investigate the results. Go to the rice pudding item with the <span class="packt_screen">No. 2</span> field as <span class="packt_screen">34</span> and click on <span class="packt_screen">Actions | Item | Restaurant | Update Rest. Forecast</span><em>:</em></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/955643f6-523b-4978-b9ac-007450896279.png"/></p>
<p>The result will be stored in a temporary table and shown on the screen:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/70c1ee2d-7344-46bd-93f6-32c2b2d786a2.png"/></p>
<p class="mce-root"/>
<p>The delta is around 140%, which is quite big. The reason is that we calculated the forecast from April 2019, but our last entry in the past is from September 2018, as shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a8ac5949-ee3d-44ee-9bf7-10c396cf5146.png"/></p>
<p>If we change <span class="packt_screen">Work date</span> to September 24, 2018 (the day just after the last actual prediction we have) and run the forecast, we will see that the delta decreases to 65%:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f8162faf-ebce-4d78-accb-855f8a114002.png"/></p>
<p>But still, the delta percentage is quite big. Why? That's because of the lack of features used in the forecast.</p>
<p class="mce-root"/>
<p>Time series forecasts use only two features, <kbd>item no.</kbd> and <kbd>date</kbd>. But usually, it's required to use more features that influence a forecast.</p>
<p>After understanding how the Time Series API framework works, let's explore its Prediction API.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Understanding the ML Prediction API</h1>
                </header>
            
            <article>
                
<p>In the previous section, we trained an ML model based on the Time Series API. As there is a limit of only two features, the resulting model had poor accuracy. With the <strong>ML Prediction API</strong>, you can set as many features as you want. This approach gives you more flexibility and opportunities to experiment, allowing you to improve model quality by changing features and generating new features.</p>
<p>Also, the ML Prediction API allows you to train a custom ML model directly from AL.</p>
<p>If you are building an industry solution, you can add the <kbd>train-ml-model</kbd> function directly to your Dynamics 365 Business Central app.</p>
<p>The API is available in codeunit 2003, ML Prediction Management. Let's look at how it works.</p>
<p>In Visual Studio Code, open the project you cloned from <a href="https://github.com/dkatson/BC-ML-Framework">https://github.com/dkatson/BC-ML-Framework</a> and switch to the <kbd>Train-ML-Model-From-AL-API</kbd><strong> </strong><span>branch. </span>This is the upgraded version of the previously seen restaurant example extension.</p>
<p>The differences between this and the previous one are as follows:</p>
<ul>
<li>We don't use the Time Series API.</li>
<li>We train an ML model (with eight features) to get the <strong>orders</strong> forecasted directly from AL.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 1 – Publishing a general prediction model as a web service from a public template</h1>
                </header>
            
            <article>
                
<p>As a prerequisite for the training from the Business Central process, you still need to publish your general prediction ML web service into your Azure subscription.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"><span>Visit</span> <a href="https://gallery.azure.ai/Experiment/Prediction-Experiment-for-Dynamics-365-Business-Central">https://gallery.azure.ai/Experiment/Prediction-Experiment-for-Dynamics-365-Business-Central</a><span> in your favorite browser.</span></p>
<p>This is a publicly available model prepared by the Microsoft ERP team and was designed especially for ML prediction management use:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/14363075-e22e-4886-93c7-22a0d13c0c35.png"/></p>
<p>To publish it, follow these steps:</p>
<ol>
<li>Open this experiment in Azure ML Studio.</li>
<li>Run it, and then deploy it as a web service.</li>
<li>In the web service dashboard, copy the API key.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 2 – Training the ML model from AL</h1>
                </header>
            
            <article>
                
<p>In the Visual Studio Code project you cloned earlier, there is a table called <strong>Rest. ML Forecast Setup</strong> with two additional functions, <kbd>getMLUri</kbd> and <kbd>getMLKey</kbd><em>.</em></p>
<p>Insert your URI and a key (copied from the previous step) into these functions:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/093eea32-a7a7-4381-94d0-ea8be27d3b85.png"/></p>
<p>Open the <span class="packt_screen">Train Rest. Forecast ML</span> <span>codeunit</span><span> </span><span>and find the </span><kbd>Train()</kbd><em> </em><span>function</span><em>.</em> <span>Let's investigate how it works. The defined variables are as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7d79ad6a-b59b-42d6-ac90-13f89e46a955.png" style="width:28.50em;height:12.75em;"/></p>
<p class="mce-root"/>
<p>From the preceding screenshot, we observe the following:</p>
<ul>
<li><kbd>ML Prediction Management</kbd>: This is the main codeunit, which has functions to train, save, and use the ML model.</li>
<li><kbd>MyModel</kbd>: This is the trained model in coded text format.</li>
<li><kbd>MyModelQuality</kbd>: This is the quality of the trained model.</li>
<li><kbd>Setup</kbd>: This is the table where trained models are stored.</li>
<li><kbd>RestSalesEntry</kbd>: This is the historical data used to train an ML model.</li>
</ul>
<p>Specify connections to your published predictive ML web service, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/118bb55a-168b-4561-9ccb-216b7ce09953.png"/></p>
<p>Now, prepare historical data for the training process. You can filter data or add new columns.</p>
<p>The important things to note here are as follows:</p>
<ul>
<li>There should not be empty fields in the training dataset. If you have them, fill them with any value, such as <kbd>0</kbd> or <kbd>NA</kbd>.</li>
<li>If you have a <kbd>Date</kbd> field, split it into two fields (at least): day and month. Usually, the forecast depends on these fields, not on the date itself. The date format is not supported in this API.</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Consider the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c08662bb-b88a-4794-bebf-a25a39c5f80e.png" style="width:37.00em;height:12.58em;"/></p>
<p>Specify the features for the model. Here, you specify the fields that influence the predictions:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5694bbe6-90d7-4800-9ca4-a5a32a3ccbf6.png" style="width:40.33em;height:26.00em;"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p>Then, we specify the label. Here, you specify the fields that you are going to predict:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3951631c-a0a3-45b9-a868-50409b6b3137.png" style="width:42.50em;height:12.17em;"/></p>
<p>Next, we train the model. Here, you send a request to the web service with the historical data that's used for training. As a result, you will get a trained model in Base64 text format and the model quality:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a9c4d83a-4eb2-4879-a116-f411946cbee9.png" style="width:32.67em;height:8.00em;"/></p>
<p>Save your trained model. It will be used later, in the prediction process:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/19047403-80f2-47f9-858b-002323158d5a.png" style="width:31.08em;height:11.83em;"/></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 3 – Predicting using the trained model</h1>
                </header>
            
            <article>
                
<p>Open the <span class="packt_screen">Calculate Rest. Forecast ML</span> <span>codeunit </span>and find the <kbd>Predict()</kbd> <span>function</span>. Let's see how it works:</p>
<ol>
<li>Check that you have the trained model in place:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/dd68325c-ecd2-4af3-b6da-1208b7d44e91.png" style="width:18.17em;height:4.33em;"/></p>
<ol start="2">
<li>Specify the connection to your published predictive ML web service:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b4cff367-79cc-4ab5-9e12-16ad98e73c16.png" style="width:38.75em;height:3.75em;"/></p>
<ol start="3">
<li>Generate a temporary table with data (features), which will be used to get <strong>orders</strong> (predictions). The structure of this table should be the same as the table you used in the training process. Otherwise, the <kbd>Prediction</kbd> web service will not work properly.</li>
<li>Then, pass this table to the ML web service input. It's important to understand that predictions will be calculated for each record (row) of the passed table:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/cabb485a-ec5e-40c2-b69c-4b0ac559ddaf.png" style="width:24.58em;height:5.58em;"/></p>
<ol start="5">
<li>Specify which fields from the table will be the features. List them in the same order as when you trained the model. Otherwise, the <kbd>Prediction</kbd> web service will not work properly:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img style="font-size: 1em;width:37.17em;height:11.83em;" src="assets/a4f9cd12-f1dd-45b6-a48c-d48b2f93754b.png"/></p>
<ol start="6">
<li>Specify which field from the passed table will be a label. Use the same field that you used when you trained the model. You can <span>only </span>mention <span>one field </span>here:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/188fb2be-e7ea-4a4b-949f-4f1195f6b11a.png" style="width:36.25em;height:4.17em;"/></p>
<p>The ML Prediction API can make predictions using classification or regression algorithms. You don't control that. If the label field has a type of integer or decimal, then the regression tree algorithm, <kbd>annova</kbd>, will be applied. Otherwise, it will use a classification algorithm.</p>
<p>If you predict values using classification algorithms, then you can also specify a field to save the confidence percentage of the prediction. This isn't supported for the regression algorithm.</p>
<p>Predict values using the <kbd>Predict</kbd> function and pass the<span> trained ML model</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/35d9c6cd-09a1-453a-ad40-d895cf12ed5b.png" style="width:37.33em;height:8.00em;"/></p>
<p class="mce-root"/>
<p>Save the forecast result:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ea9a5723-30c9-4b1d-8ea8-b751cbcffbcc.png" style="width:42.42em;height:4.00em;"/></p>
<p>You now have forecast data to check.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 4 – Getting insights into how ML works</h1>
                </header>
            
            <article>
                
<p>When you get predictions from an ML web service, it's always interesting to understand why the model gives some results or makes those decisions. As the ML Prediction API uses tree-based ML algorithms, we can see the decision tree:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7d4df0a2-b6d6-40f7-9a86-d79666281368.png" style="width:39.08em;height:18.83em;"/></p>
<p>It's important to understand that the decision tree is an artifact of the trained model, not of the predictions made by the trained model.</p>
<p>Open the <span class="packt_screen">Train Rest. Forecast ML</span> <span>codeunit </span>and find the <kbd>DownloatPlotOfTheModel</kbd> <span>function</span><em>.</em> Let's see how it works:</p>
<ol>
<li>Connect to your published ML web service.</li>
<li>Get the <kbd>.pdf</kbd> file with the decision tree calling the <kbd>PlotModel</kbd> function. You will get it in Base64 text format.</li>
<li>Then<span>, use the </span><kbd>DownloadPlot</kbd> <span>function to save the</span> <kbd>.pdf</kbd> <span><span>file locally. If you don't need to save it, just skip this line of code:</span></span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7e5a3234-fd52-45be-8601-b77552e39d9b.png"/></p>
<p>You will have a plot of your ML model.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Step 5 – Publishing and running the forecast</h1>
                </header>
            
            <article>
                
<p>When you publish and run the forecast from the <span class="packt_screen">Item</span> card, you will get this screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a3dbad0a-1071-4241-b8b2-95b4785461c7.png"/></p>
<p class="mce-root"/>
<p>If you to compare the forecast results with the previous models, you will notice that this model gives worse results than the custom-built ML model, but better results than the Time Series API:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/82d3e4cc-1132-41ce-b791-c3d09d3e128d.png" style="width:63.08em;height:32.58em;"/></p>
<p>This section explained how ML prediction works and the steps involved in performing it.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we looked through the ML APIs available with Dynamics 365 Business Central. I've made a comparative analysis of the three ML APIs in the following table:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p><strong> </strong></p>
</td>
<td>
<p><strong>The Time Series API</strong></p>
</td>
<td>
<p><strong>The ML Prediction API</strong></p>
</td>
<td>
<p><strong>The Custom Azure ML API</strong></p>
</td>
</tr>
<tr>
<td>
<p><strong>ML Experience required</strong></p>
</td>
<td>
<p>Low</p>
</td>
<td>
<p>Medium</p>
</td>
<td>
<p>High</p>
</td>
</tr>
<tr>
<td>
<p><strong>ML Model</strong></p>
</td>
<td>
<p>Microsoft</p>
</td>
<td>
<p>Microsoft</p>
</td>
<td>
<p>Custom</p>
</td>
</tr>
<tr>
<td>
<p><strong>Data preparation level</strong></p>
</td>
<td>
<p>Low</p>
</td>
<td>
<p>Medium</p>
</td>
<td>
<p>High</p>
</td>
</tr>
<tr>
<td>
<p><strong>Max Features</strong></p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>Unlimited</p>
</td>
<td>
<p>Unlimited</p>
</td>
</tr>
<tr>
<td>
<p><strong>Training service</strong></p>
</td>
<td>
<p>-</p>
</td>
<td>
<p>Business Central</p>
</td>
<td>
<p>Azure ML Studio</p>
</td>
</tr>
<tr>
<td>
<p><strong>Trained model storage</strong></p>
</td>
<td>
<p>-</p>
</td>
<td>
<p>Business Central</p>
</td>
<td>
<p>Azure ML Studio</p>
</td>
</tr>
<tr>
<td>
<p><strong>ML Model quality</strong></p>
</td>
<td>
<p>Low</p>
</td>
<td>
<p>Medium</p>
</td>
<td>
<p>High</p>
</td>
</tr>
<tr>
<td>
<p><strong>ML Model usage level</strong></p>
</td>
<td>
<p>General</p>
</td>
<td>
<p>Industry</p>
</td>
<td>
<p>Company</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>The comparison is based on the example provided in this chapter. Use this table as a guide to help you to choose the best way of applying AI in your app.</p>
<p>As we learned here, building custom ML models is an art that requires creativity, time, and some math skills.</p>
<p>In the next chapter, we'll explore an architectural overview and look at the best practices of moving your existing ISV solutions to extensions.</p>


            </article>

            
        </section>
    </body></html>