<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Moving Existing ISV Solutions to the New Extension Model</h1>
                </header>
            
            <article>
                
<p>In this chapter, we'll focus on existing ISV solutions for Dynamics NAV (mainly based on the C/AL language). We'll also look at tips, tricks, and best practices to adopt when moving these solutions to Dynamics 365 Business Central and to the new extension programming paradigm.</p>
<p>The topics we will cover in this chapter are as follows:</p>
<ul>
<li>Architectural best practices for moving a C/AL solution to an extension-based one</li>
<li>Converting existing C/AL code into AL</li>
<li>Things to check and remember during a solution redesign for SaaS environments</li>
</ul>
<p>By the end of this chapter, you will have a better understanding of what steps are required to move an existing C/AL solution to AL, the architectural choices when converting a monolithic C/AL solution into extensions<span> (this will affect your final application and how you will sell it), and the tools that can help you in this migration process (code conversion tools). </span></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Preparing the transition from C/AL to AL and extensions</h1>
                </header>
            
            <article>
                
<p>Without a doubt, Dynamics NAV was one of the ERPs in the international market that had the most active community of partners and users. If you are a customer that would like to <span>implement </span>Dynamics NAV, it is really quite easy to find a custom solution that fits and is tailored to your business needs. To do this, just search through one of several add-ons that have been developed by partners or <strong>Independent Software Vendors</strong> (<strong>ISVs</strong>) over the years.</p>
<p>All these solutions are written using the C/AL language. Normally, they contain the following:</p>
<ul>
<li>New objects (objects that are created to satisfy a customer's business case)</li>
<li>Modified standard objects (objects from the standard application base code that have been modified to satisfy a customer's need)</li>
</ul>
<p>These solutions are always a monolithic solution (everything is packaged into a single codebase inside the database, where an object can reference all the other objects in the solution).</p>
<p>With Dynamics 365 Business Central, CSIDE Development Environment and the C/AL language are available only until <span>version </span>14.x and only for the on-premise world. From version 15 (wave 2), Microsoft has removed those developer tools, and so existing solutions must now be moved to AL and converted into the new extension model.</p>
<p>Moving an existing C/AL-based solution to AL extensions is not always just an easy <em>code conversion</em> process; normally, it requires a redesign and a rethink of the entire application (this is always the approach that's suggested by Microsoft).</p>
<p>When planning to move an existing C/AL solution to AL extensions, on the technical side, there are three main aspects to consider:</p>
<ul>
<li>How many extensions should I write to best split the C/AL solution?</li>
<li>How can I reuse my existing C/AL code?</li>
<li>What is allowed and not allowed when it comes to targeting a SaaS-based solution?</li>
</ul>
<p>In the upcoming sections, we will learn how these aspects affect the transition from an existing solution to the new programming model and to the new platform.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Planning the number of extensions to code</h1>
                </header>
            
            <article>
                
<p>As we mentioned in <a href="d8553d40-bf59-4aef-983c-89519ef30e29.xhtml">Chapter 5</a>, <em>Developing a Customized Solution for Dynamics 365 Business Central</em>, extension A cannot reference objects and methods exposed by extension B. This is only possible if extension A explicitly declares a dependency on extension B.</p>
<p>When moving an existing solution to extensions, you have two main choices:</p>
<ul>
<li>Create a single monolithic extension</li>
<li>Create N dependent extensions</li>
</ul>
<p>Let's explore these concepts in more detail.</p>
<p><span>A single monolithic extension is an easier choice since developers don't have to think about independent modules. Instead, they just create all the objects and business logic in a single giant AL extension project. In the end, there will be a single</span> <kbd>.app</kbd> <span>file that does the following:</span></p>
<ul>
<li>Adds new objects</li>
<li>Extends standard objects</li>
<li>Adds new business logic</li>
<li>Raises events</li>
<li>Subscribes to events raised by the standard business logic</li>
</ul>
<p class="mce-root"/>
<p>The following diagram shows this solution:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5c79b993-a83c-4495-aa8c-a33975d17a42.png" style="width:39.58em;height:25.92em;"/></p>
<p>Developers don't have to think about dependencies in this context (all the code is in a single object). However, the disadvantage of this solution is that even a small update of the extension (such as adding a little code change) requires unpublishing and publishing the entire application. <span>This simply means that we update an extension in Dynamics 365 Business Central: unpublish the old version and publish the new version.</span></p>
<p>Secondly, this is not a solution that can be split into and sold as modules. However, splitting your solution into N separate extensions is a good choice if you want to have a modular solution. When moving an existing C/AL solution to N separate extensions, you typically have the following:</p>
<ul>
<li>Independent or standalone extensions (modules that do not require dependencies from other modules)</li>
<li>Dependent extensions (modules that require dependencies from other modules)</li>
</ul>
<p class="mce-root"/>
<p>A diagram of this solution is as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8e552814-a180-45d0-ac5b-ef10fcb65078.png" style="width:39.50em;height:23.67em;"/></p>
<p>Here, extension A is an independent extension (it can only reference objects from the base module). Extension C depends on extension A, while extension B depends on A and C.</p>
<p>Dependencies have some advantages, such as the following:</p>
<ul>
<li>They help us structure more complex deployment scenarios</li>
<li>They improve code and business logic reusability (avoiding redundancy)</li>
<li>They increase maintenance</li>
<li>They enhance deployment flexibility</li>
</ul>
<p>The drawbacks of dependencies are as follows:</p>
<ul>
<li>When you publish the extensions, you must publish the extension that doesn't have any dependencies (the so-called master or parent extension) first. For example, if you try and publish an extension with dependencies first (a child), it will throw an error stating that object references do not exist in the database.</li>
<li>When you remove extensions, you must remove the dependent extensions first (such as a child) and subsequently the parent extension.</li>
</ul>
<p class="mce-root"/>
<p>So, <span>we may be wondering which is </span>the better option here.</p>
<p>This is the question that every Microsoft partner is currently asking themselves. There are no rules written in stone about this topic, and what you want to achieve in terms of object modularity, as well as your marketing strategy, depends a lot on your own existing solution.</p>
<p>A best practice and suggestion is to not skip or avoid dependencies. Moving an existing C/AL solution to N different dependent extensions is a good choice as it guarantees modularity and flexibility, but it is also recommended to not create too many micro-extensions. Developers should think about macro functionalities and try to isolate them into featured modules that can be installed when needed by customers.</p>
<p>An important thing to remember within this context is to always add events in order to let others hook your existing codebase.</p>
<p>Only by raising events (<em>integration</em> or <em>business</em> events) can you have a solution that can interact with other extensions that have been installed in the system and that can also be extended by third parties (other Microsoft partners).</p>
<p>In the next section, we'll learn how to speed up the conversion process (where possible!) of your existing C/AL-based solutions to AL.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Converting existing solutions into AL</h1>
                </header>
            
            <article>
                
<p>Many Microsoft partners that actually work with Dynamics NAV have developed a lot of custom solutions over the years (add-ons, customer solutions, and so on). In order to be ready for the new Dynamics 365 Business Central platform, these must be migrated to AL code.</p>
<p>If you have an existing codebase or an existing solution in place, the first thing you can do when it comes to moving this solution to the extensions world is to try to convert your C/AL objects into AL.</p>
<p>Please keep in mind that conversion is not always the best thing to do, but just a starting point (you can convert all new objects <span>as-is</span>, but you should pay attention and refactor the modified standard objects that your existing solution will certainly have).</p>
<p>So, how can <span>you </span><span>convert your C/AL solution into AL?</span></p>
<p class="mce-root"/>
<p>As we mentioned in <a href="81958c15-06a3-4a59-ae0c-0afa9413d6f9.xhtml">Chapter 7</a>, <em>Report Development with AL</em>, Dynamics 365 Business Central on-premise and Docker images come shipped with a tool that can easily help with converting C/AL objects into AL objects: <kbd>Txt2AL.exe</kbd>.</p>
<p>With this tool, you can specify a series of C/AL objects of any kind, export them in TXT format, and automatically convert them into AL format.</p>
<p>To proficiently use this tool, you should perform the following steps:</p>
<ol>
<li>Make an export of all the baseline object of your fresh database into a TXT file (called <kbd>MyBaseline.txt</kbd> here) using the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>finsql.exe Command=ExportToNewSyntax, File=MyBaseline.txt, Database="&lt;databasename&gt;", ServerName=&lt;servername&gt; ,Filter=Type=table;ID=&lt;tableID&gt;</strong></pre>
<div style="padding-left: 60px" class="packt_infobox"><span>Details of the </span>ExportToNewSyntax command can be found here: <a href="https://docs.microsoft.com/en-us/dynamics-nav/exporttonewsyntax">https://docs.microsoft.com/en-us/dynamics-nav/exporttonewsyntax</a>.</div>
<ol start="2">
<li>Import your C/AL solution into a newly created database, compile the objects, and export all new and/or modified objects into a TXT file (called, for example, <kbd>MyCustomObjects.txt</kbd>) using the preceding syntax.</li>
<li>Execute the <kbd>Set-ObjectPropertiesFromMenuSuite</kbd> cmdlet in order to have a conversion from the MenuSuite information to your pages and reports in the generated AL files (remember: MenuSuite objects are not available in Dynamics 365 Business Central).</li>
<li>Execute the <kbd>Compare-NAVApplicationObject</kbd> cmdlet to compare the base objects with the modified objects and to create the <kbd>.DELTA</kbd> files with the differences between them:</li>
</ol>
<pre style="padding-left: 60px"><strong>Compare-NAVApplicationObject -OriginalPath "C:\MyBaseline.txt " -ModifiedPath "C:\ MyCustomObjects.txt " -ExportToNewSyntax</strong></pre>
<ol start="5">
<li>Execute the <kbd>Txt2AL.exe</kbd> tool using the following syntax:</li>
</ol>
<pre style="padding-left: 60px"><strong>txt2al –source=&lt;DELTAFilePath&gt; --target=&lt;ALOutputFilesPath&gt; --rename --type --extensionStartId --injectDotNetAddIns --dotNetAddInsPackage --dotNetTypePrefix --translationFormat –addLegacyTranslationInfo</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The following table contains a description of all the <kbd>Txt2AL.exe</kbd> command parameters (some of them are optional). Let's look at how each one functions:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<thead>
<tr>
<td>
<p class="CDPAlignCenter CDPAlign"><strong>Parameter name</strong></p>
</td>
<td>
<p class="CDPAlignCenter CDPAlign"><strong>Description</strong></p>
</td>
</tr>
</thead>
<tbody>
<tr>
<td>
<p><kbd>--source=Path</kbd></p>
</td>
<td>
<p>The path of the folder containing the <kbd>.delta</kbd> files. This is a mandatory parameter.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--target=Path</kbd></p>
</td>
<td>
<p>The path of the folder that will contain the generated <kbd>.AL</kbd> files. This is a mandatory parameter.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--rename</kbd></p>
</td>
<td>
<p>If used, output files will be automatically renamed as the <kbd>.txt</kbd> objects.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--type=ObjectType</kbd></p>
</td>
<td>
<p>The type of object to convert. Allowed values include Codeunit, Table, Page, Report, Query, and XmlPort.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--extensionStartId</kbd></p>
</td>
<td>
<p>This permits you to define the starting ID of the generated extension objects (the default is 70,000,000). It will be incremented by 1 for each generated object.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--injectDotNetAddIns</kbd></p>
</td>
<td>
<p>This adds the definition of standard .NET add-ins (a set of add-ins embedded into the platform) in the resulting .NET package.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--dotNetAddInsPackage=Path</kbd></p>
</td>
<td>
<p>This specifies the path to an AL file containing a definition for a .NET package containing .NET type declarations that should be included in the .NET package definition produced by the conversion.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--dotNetTypePrefix</kbd></p>
</td>
<td>
<p>This allows you to define a prefix to be used for all .NET type aliases that are created during the conversion.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--translationFormat=ObjectType</kbd></p>
</td>
<td>
<p>This allows you to specify the translation file format. Allowed values include Xliff and Lcg.</p>
</td>
</tr>
<tr>
<td>
<p><kbd>--addLegacyTranslationInfo</kbd></p>
</td>
<td>
<p>This allows you to add information to the translation file. During conversion, XLIFF files from all the <kbd>CaptionML</kbd> properties in the app are extracted. If this switch is set, a comment is added in the generated XLIFF files that specify what the ID of the translation item would be in C/SIDE. This acts as a mapping that allows you to convert existing translation resources for your app.</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>Now that we've explained the tool for converting code from C/AL to AL (Txt2AL), how can we move our existing C/AL solution to the extension-based architecture (AL language) in a semi-automated way?</p>
<p>The first step, and good practice, is to move the existing C/AL solution that you have in place to the last <strong>Cumulative Update</strong> (<strong>CU</strong>) of the last Dynamics 365 Business Central version that supports the CSIDE Development Environment and C/AL language: Dynamics 365 Business Central Spring 2019 update (platform 14.x).</p>
<p>To showcase the semi-automated process, we will use Docker containers with the <em>NavContainerHelper</em> PowerShell library, which is available at <a href="https://github.com/microsoft/navcontainerhelper">https://github.com/microsoft/navcontainerhelper</a>.</p>
<p>Create a new Docker container with the Dynamics NAV version your C/AL solution is based on (in this example, we will use Dynamics NAV 2018 CU 16) and import the custom or modified TXT objects into this container. The script may look as follows:</p>
<pre># Environment Settings<br/>$auth = "NavUserPassword"<br/>$credential = New-Object pscredential 'admin', (ConvertTo-SecureString -String 'P@ssword1' -AsPlainText -Force)<br/>$licenseFile = "C:\temp\license.flf"<br/>$demoSolutionPath = "C:\ProgramData\NavContainerHelper\MyNAVSolution.txt"<br/><em><br/></em><em>New-NavContainer -accept_eula `<br/></em><em>                 -imageName "mcr.microsoft.com/dynamicsnav:2018-cu16" `<br/></em><em>                 -containerName "nav2018" `<br/></em><em>                 -licenseFile $licenseFile `<br/></em><em>                 -auth $auth `<br/></em><em>                 -Credential $Credential `<br/></em><em>                 -updateHosts `<br/></em><em>                 -includeCSide<br/><br/></em><em># Import and compile objects<br/></em><em>Import-ObjectsToNavContainer -containerName "nav2018" -objectsFile $demoSolutionPath<br/></em><em>Compile-ObjectsInNavContainer -containerName "nav2018" -filter "Modified=Yes"</em></pre>
<p>Now, run the following command:</p>
<pre><strong>Export-ModifiedObjectsAsDeltas -containerName "nav2018" -openFolder</strong></pre>
<p class="mce-root">This will open a local folder (typically <kbd>C:\ProgramData\NavContainerHelper\Extensions\nav2018\delta</kbd>) <span>that contains all the modifications to the base code (called <em>deltas</em>). </span>In particular, after running the preceding command, you will find two types of file <span>in this folder</span>:</p>
<ul>
<li><strong>.TXT</strong> files are your new objects (that you could use as-is).</li>
<li><strong>.DELTA</strong> files are the modified objects.</li>
</ul>
<p>You should always check the <kbd>.DELTA</kbd> files because they could contain some custom code modifications that aren't supported in AL anymore. An example of a non-supported customization could be the code that was previously inserted directly on a standard table trigger or written inside standard posting routines. This code must be moved and encapsulated inside event subscribers that have been natively raised by the Dynamics 365 Business Central platform (as we explained in <a href="d8553d40-bf59-4aef-983c-89519ef30e29.xhtml">Chapter 5</a><span>, </span><em>Developing a Customized Solution for Dynamics 365 Business Central</em>).</p>
<p>After this (mandatory) code refactoring, we need to create a Dynamics 365 Business Central container (here, this is called <kbd>d365bc</kbd>) and we need to import the object's deltas.</p>
<p>The script is as follows:</p>
<pre><em># Environment Settings<br/></em><em>$imageName = "mcr.microsoft.com/businesscentral/onprem:ltsc2019"</em><em>$auth = "NavUserPassword"<br/></em><em>$credential = New-Object pscredential 'admin', (ConvertTo-SecureString -String 'P@ssword1' -AsPlainText -Force)<br/></em><em>$licenseFile = "C:\temp\license.flf"<br/><br/></em><em># Create Dynamics 365 Business Central container<br/></em><em>New-NavContainer -accept_eula `<br/></em><em>                 -imageName $imageName `<br/></em><em>                 -containerName "d365bc" `<br/></em><em>                 -licenseFile "C:\temp\license.flf" `<br/></em><em>                 -auth $auth `<br/></em><em>                 -Credential $Credential `<br/></em><em>                 -updateHosts `<br/></em><em>                 -includeCSide<br/></em><em> <br/></em><em># Import and compile Delta files<br/></em><em>Import-DeltasToNavContainer -containerName "d365bc" -deltaFolder "C:\ProgramData\NavContainerHelper\Extensions\nav2018\delta"<br/></em><em>Compile-ObjectsInNavContainer -containerName "d365bc" -filter "Modified=Yes"</em></pre>
<p>Now, you have a container with your C/AL solution in it where you can test your code and (eventually) refactor it over and over again. The previously created NAV container can now be removed from your system by executing the following command:</p>
<pre><strong>Remove-NavContainer -containerName nav2018</strong></pre>
<p>Now, we're ready to work on our new AL-based solution.</p>
<p>We now have two possible scenarios when developing (or migrating an existing solution) an application for Dynamics 365 Business Central:</p>
<ul>
<li>C/AL to AL conversion (no modifications on standard base objects are required for supporting the SaaS version of the product)</li>
<li>C/AL to AL code customizations (base AL objects will be changed; this is only available for the on-premise world)</li>
</ul>
<p>In the upcoming sections, we will learn how to perform in these two <span>C/AL to AL </span>situations.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">C/AL to AL conversion</h1>
                </header>
            
            <article>
                
<p>Here, we need to create a Dynamics 365 Business Central development container with our AL solution. This container has no support for C/AL anymore. The script to create this container is as follows:</p>
<pre><em># Environment Settings<br/></em><em>$imageName = "mcr.microsoft.com/businesscentral/onprem-ltsc2019"<br/></em><em>$auth = "NavUserPassword"<br/></em><em>$credential = New-Object pscredential 'admin', (ConvertTo-SecureString -String 'P@ssword1' -AsPlainText -Force)<br/></em><em>$licenseFile = "C:\temp\license.flf"<br/></em><em> <br/></em><em># Create Business Central container<br/></em><em>New-NavContainer -accept_eula `<br/></em><em>                 -imageName $imageName `<br/></em><em>                 -containerName "d365bcdev" `<br/></em><em>                 -licenseFile $licenseFile `<br/></em><em>                 -auth $auth `<br/></em><em>                 -Credential $Credential `<br/></em><em>                 -updateHosts</em></pre>
<p>You now have a working Dynamics 365 Business Central container without the C/AL tools that we'll use in the upcoming steps.</p>
<p>Now, open Visual Studio Code, create a new AL project (<em>CTRL</em> + <em>Shift</em> + <em>P</em> and select <strong>AL:GO!</strong>), give it a name (here, it is called <kbd>MyALSolution</kbd>), and modify the <kbd>launch.json</kbd> file in your solution in order to connect to this container (here, this is called <kbd>d365bcdev</kbd>).</p>
<p>In PowerShell, execute the following command:</p>
<pre><strong>Convert-ModifiedObjectsToAl -containerName "d365bc" -sqlCredential $credential -alProjectFolder "C:\Packt\MyALSolution"</strong></pre>
<p>The <kbd>NavContainerHelper</kbd> module has a function called <kbd>Convert-ModifiedObjectsToAl</kbd> that allows you to export all the modified objects from the selected container (you can also apply filters to objects if needed) and then run the <kbd>Convert-Txt2Al</kbd> command on the resulting files. As a result of this command, you will have a folder (specified by the <kbd>-alProjectFolder</kbd> parameter) with many <kbd>.al</kbd> files that have been generated in the conversion from the base C/AL solution.</p>
<p>The output will not always <span>be</span><span> </span><span>100% perfect; you need a bit of refactoring and you need to add</span> <kbd>ApplicationArea</kbd> <span>and</span> <kbd>UsageCategory</kbd> <span>properties to your objects, but the major work has been done. </span>Now, you can compile your AL solution and deploy it on your <kbd>d365bcdev</kbd> container. Due to this, your solution is a 100% AL extension on Dynamics 365 Business Central.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">C/AL to AL code customizations</h1>
                </header>
            
            <article>
                
<p>When converting C/AL solutions into AL, you may also have cases where you are strictly forced to modify the standard AL code (we suggest avoiding this as much as possible because, if you modify Microsoft's base code, your solution cannot be moved to the Dynamics 365 Business Central SaaS environment). Let's get started:</p>
<ol>
<li>If this is what's happening to you, you can create a Dynamics 365 Business Central development container (<kbd>d365bcdev</kbd>) with the <kbd>-includeAL</kbd> option:</li>
</ol>
<pre style="padding-left: 60px"><em># Environment Settings<br/></em><em>$imageName = "mcr.microsoft.com/businesscentral/onprem-ltsc2019"<br/></em><em>$auth = "NavUserPassword"<br/></em><em>$credential = New-Object pscredential 'admin', (ConvertTo-SecureString -String 'P@ssword1' -AsPlainText -Force)<br/></em><em>$licenseFile = "C:\temp\license.flf"<br/></em><em> <br/></em><em># Create Business Central container<br/></em><em>New-NavContainer -accept_eula `<br/></em><em>                 -imageName $imageName `<br/></em><em>                 -containerName "d365bcdev" `<br/></em><em>                 -licenseFile $licenseFile `<br/></em><em>                 -auth $auth `<br/></em><em>                 -Credential $Credential `<br/></em><em>                 -updateHosts `<br/></em>                 <em>-includeAL</em></pre>
<p style="padding-left: 60px">When executing this command, you will find a folder with the baseline of the AL objects in a new folder called <kbd>Original-&lt;version&gt;-&lt;country&gt;-al</kbd> (for example, <kbd>C:\ProgramData\NavContainerHelper\Extensions\Original-14.0.29537.0-W1-al</kbd>).</p>
<ol start="2">
<li>Now, you can create a new AL project with all the base AL objects you obtained from the previous step. This can be done automatically by executing the following script:</li>
</ol>
<pre style="padding-left: 60px">Create-AlProjectFolderFromNavContainer -containerName "d365bcdev" -alProjectFolder "C:\ProgramData\NavContainerHelper\AL\MyALSolution" -useBaseLine -addGIT</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p style="padding-left: 60px">In the previous code, we're using the following two parameters:</p>
<ul>
<li style="list-style-type: none">
<ul>
<li>The <kbd>-useBaseline</kbd> option is used to copy the <kbd>.AL</kbd> base files into our AL solution project.</li>
<li>The <kbd>-addGit</kbd> option creates an offline Git repository of the folder and commits all the objects (you need to have Git installed).</li>
</ul>
</li>
</ul>
<ol start="3">
<li>Now, you can open this folder with Visual Studio Code and compile the solution without publishing (or using the <em>Ctrl</em> + <em>Shift</em> + <em>B</em> shortcut). This compilation process can take a few minutes. You can also compile the solution without opening Visual Studio Code by executing the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>Compile-AppInNavContainer -containerName "d365bcdev" -credential $credential -appProjectFolder "C:\ProgramData\NavContainerHelper\AL\MyALSolution"</strong></pre>
<p>You<span> </span><span>may see some deprecation warnings during compilation. After compilation, you need to commit these modifications to your local Git repository.</span></p>
<p>You now have a full AL app (with all the standard AL objects).</p>
<p>In the next step, you have to replace the C/AL objects in the container database with this newly compiled AL app. To do that, execute the following command:</p>
<pre><strong>Publish-NewApplicationToNavContainer -containerName "d365bcdev" -appDotNetPackagesFolder "C:\ProgramData\NavContainerHelper\AL\MyALSolution\.netpackages" -appFile "C:\ProgramData\NavContainerHelper\AL\MyALSolution\output\SD_myalapp_1.0.0.0.app" -credential $credential -useCleanDatabase</strong></pre>
<p><kbd>Publish-NewApplicationToNavContainer</kbd> is a cmdlet that uninstalls all the apps from the database, removes all C/AL objects, and uses the development endpoint of the container to publish the new <kbd>.app</kbd> file. We use the <kbd>-useCleanDatabase</kbd> flag to remove C/AL objects and uninstall the existing apps.</p>
<p class="mce-root"/>
<p>Now that you have a Docker container that runs a full AL base app, you need to import your AL custom solution (extension). To do this, execute the following command:</p>
<pre><strong>Convert-ModifiedObjectsToAl -containerName "d365bc" -sqlCredential $credential -doNotUseDeltas -alProjectFolder "C:\Packt\MyALSolution" -alFilePattern "*.al,*.xlf"</strong></pre>
<p>This will work on the container where you've previously imported your custom C/AL solution (here, this is called <kbd>d365bc</kbd>). Now, the conversion runs on all the objects (the full database, except for the report layout files).</p>
<p>After this step, you have a full base app that contains your custom objects and your modifications inside the standard <kbd>.AL</kbd> objects. You can now compile the objects and deploy them on your Dynamics 365 Business Central container for testing. You now have a code-customized AL solution (again, it is highly advisable to avoid this if possible).</p>
<p>These are the steps that are required if you wish to start a code conversion. As a general rule, remember to always take the SaaS environment as your reference and target point.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Upgrading from Dynamics 365 Business Central version 14 to version 15</h1>
                </header>
            
            <article>
                
<p>Microsoft's recommended path for migrating your solution to the new refactored Dynamics 365 Business Central version 15 is to start from your solution that was previously moved to version 14 (moving to version 14 and AL is the first step).</p>
<p class="mce-root"/>
<p>Microsoft's official migration path is represented in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3b8b45c6-8feb-4620-b96b-1a7d03c3b8af.png"/></p>
<div class="packt_infobox">More information on this can be found at <a href="https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-overview-v15">https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-overview-v15</a>.</div>
<p>To start a technical upgrade from a version 14 database to version 15, you can execute the following PowerShell command:</p>
<pre><strong>Invoke-NAVApplicationDatabaseConversion -DatabaseServer &lt;database server name&gt;\&lt;database server instance&gt; -DatabaseName "&lt;database name&gt;"</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p><span>The conversion updates the system tables of the database to the new schema (data structure) and provides the latest platform features and performance enhancements.</span></p>
<p>For migrating to version 15, detailed steps are described in the following official Microsoft pages:</p>
<ul>
<li>Upgrading an unmodified application to Dynamics 365 Business Central 2019 Release Wave 2: <a href="https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-unmodified-application">https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-unmodified-application</a>.</li>
<li>Technical Upgrade to Dynamics 365 Business Central 2019 Wave 2: <a href="https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-technical-upgrade-v14-v15">https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/upgrade/upgrade-technical-upgrade-v14-v15</a>.</li>
</ul>
<p>In the next section, we'll look at another important aspect to take into consideration when architecting solutions for the new Dynamics 365 Business Central platform: how to handle customer requests for customizations.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling customer-specific personalization's</h1>
                </header>
            
            <article>
                
<p>You've worked hard so far, and now your solution has finished moving from the old C/AL to the new extension's architecture. Now, a common business scenario occurs when you sell your solution to a customer: they want some specific customizations of your solution to satisfy their particular business needs. Here, we immediately have a problem: how can you handle customizations for your customers?</p>
<p class="mce-root"/>
<p>The extension model has some rules, and you need to absolutely avoid the situation represented in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6bdb7c85-5a7f-4c9c-8d01-a6d89d1c9dc8.png" style="width:31.17em;height:18.25em;"/></p>
<p>In the preceding diagram, we can see that EXT BASE is the standard solution and its base code is modified for every customer that acquires the solution.</p>
<p>You don't need to directly customize your extension code for every customer you have. Forking your solution's base code is absolutely a bad practice (it hurts the extension's principles; that is, the base code must never be changed).</p>
<p>What you need to do is represented in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b801ecb5-cf9f-4539-ac80-d1af396bfff7.png" style="width:30.08em;height:20.42em;"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Here, your extension's base code (called EXT BASE, in the preceding diagram) is the same for every customer. To handle customizations for each customer, you create a new extension for each customer (CUSTOM EXT, in the preceding diagram) that will be <em>dependent</em> on your base extension (it will be a new layer above the standard layer). This is a best practice and what the extension model wants: you don't modify base code, you <em>extend</em> base code. So, aside from these, what are the other solutions for extensions that we need to remember? Let's check them out.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Other things to remember</h1>
                </header>
            
            <article>
                
<p>When moving a solution to extensions, there are other things to remember and aspects that you need to handle or rethink. In the upcoming sections, you will find a summary of some of the most common ones.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling the MenuSuite</h1>
                </header>
            
            <article>
                
<p>With Dynamics NAV, pages and reports can be searched in the web client by adding them to a M<em>enuSuite</em> object (a standard object that defines the functional menu of the application). With Dynamics 365 Business Central, the <kbd>MenuSuite</kbd> object is not supported, and pages and reports can be searchable and visible by setting the <kbd>UsageCategory</kbd> and <kbd>ApplicationArea</kbd> properties.</p>
<p>If you convert objects from C/AL, you need to set these properties on the converted objects. You can automate the process of setting these properties on your objects by using a PowerShell module called <kbd>TransitionMenuSuiteObjectsForSearch.psm1</kbd>, which you can find on the Dynamics 365 Business Central DVD image.</p>
<p>You can import this module on PowerShell as follows:</p>
<pre><strong>Import-Module -Name c:\dvd\WindowsPowerShellScripts\WebSearch\TransitionMenuSuiteObjectsForSearch.psm1</strong></pre>
<p>Then, execute the following command:</p>
<pre><strong>Set-ObjectPropertiesFromMenuSuite -RoleTailoredClientFolder "C:\Program Files (x86)\Microsoft Dynamics NAV\140\RoleTailored Client" -DataBaseName "YourDatabase" -OutPutFolder "C:\temp"</strong></pre>
<p class="mce-root"/>
<p><span>Now, </span><kbd>UsageCategory</kbd><span> </span><span>and </span><kbd>ApplicationArea</kbd> <span>are set on all your converted objects.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">.NET variables and add-ins</h1>
                </header>
            
            <article>
                
<p>If your existing code uses .NET variables, these objects are not supported in a SaaS environment. If you want to use .NET on SaaS, you need to wrap your DLLs (or your .NET code) into an Azure function and call that function from your AL code. <a href="512b0690-f392-4f82-b006-cacdeec1bacc.xhtml">Chapter 6</a><span>, </span><em>Advanced AL Development</em>, and <a href="45e3cb96-0df4-43be-89d0-697822f4b159.xhtml">Chapter 13</a>, <em>Serverless Business Processes with Business Central and Azure</em>, show you how to handle these situations.</p>
<p>If your extension targets the on-premise world (<kbd>Target = Internal</kbd> in the <kbd>app.json</kbd> file), then you can use .NET assemblies in your AL code (but this code can never be moved into a SaaS environment). More information on how to use .NET variables in AL for the on-premise world can be found at <a href="https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/devenv-get-started-call-dotnet-from-al">https://docs.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/devenv-get-started-call-dotnet-from-al</a> and <a href="https://demiliani.com/2019/06/04/dynamics-365-business-central-using-dotnet-assemblies-on-a-docker-container-sandbox/">https://demiliani.com/2019/06/04/dynamics-365-business-central-using-dotnet-assemblies-on-a-docker-container-sandbox/</a>.</p>
<p>Another possible problem occurs if you have a solution that uses .NET visual add-ins, such as the following <span class="packt_screen">Sales Order</span> page:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/215a0c59-d19a-47fc-9fda-d4dd4c9a4dc2.png"/></p>
<p>The following is a custom <span class="packt_screen">Sales Order</span> page we have implemented that uses a .NET <span><strong>Windows Presentation Foundation</strong> </span>(<strong>WPF</strong>) add-in that's been declared in C/AL as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6212ecff-1f2c-43ab-9e5f-c1c22a769daa.png"/></p>
<p>To move this solution to Dynamics 365 Business Central, you need to remake the visual add-in as a JavaScript add-in, as described in <a href="512b0690-f392-4f82-b006-cacdeec1bacc.xhtml">Chapter 6</a><span>, </span><em>Advanced AL Development</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">File management</h1>
                </header>
            
            <article>
                
<p>With Dynamics 365 Business Central, files are only supported on-premises. If you're targeting the SaaS environment, you should handle files in a different way by using <em>Streams</em> (as described in <a href="512b0690-f392-4f82-b006-cacdeec1bacc.xhtml">Chapter 6</a>, <em>Advanced AL Development</em>, in the <em>Handling files</em> section) or by using <em>Azure Functions</em> for file storage (a complete solution is described in <a href="45e3cb96-0df4-43be-89d0-697822f4b159.xhtml">Chapter 13</a>, <em>Serverless Business Processes with Business Central and Azure</em>).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Printing</h1>
                </header>
            
            <article>
                
<p>Direct printing (sending a document to a printer on the local network directly) is not available in the SaaS environment. A possible solution to this problem is described here: <a href="https://demiliani.com/2019/01/29/dynamics-365-business-central-and-direct-printing/">https://demiliani.com/2019/01/29/dynamics-365-business-central-and-direct-printing/</a>.</p>
<p class="mce-root"/>
<p>Microsoft is <span>also</span><span> </span><span>working on supporting direct printing in the near future in the SaaS environment. The wave 2 release will have a new reporting event called</span> <kbd>OnDocumentReady</kbd><span>, which exposes a data stream and the context of a document. A document can then be picked up by an extension that can handle printing.</span></p>
<p>In the next section, we'll learn how the Dynamics 365 Business Central wave 2 release architecture could affect your extension's development in the near future.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Dynamics 365 Business Central wave 2 release changes</h1>
                </header>
            
            <article>
                
<p>Dynamics 365 Business Central Wave 2 release (platform 15) is AL- and web-client-only. You will not find support for C/AL and CSIDE anymore. Instead, if you go to<span> the </span><em>Extensions Management</em><span> </span>page in Dynamics 365 Business Central platform 15, you will find the following two Microsoft extensions:</p>
<ul>
<li><strong>Base Application</strong><span> </span>(version 15.0.&lt;build&gt;.0): This extension contains all the business logic that was moved to AL.</li>
<li><strong>System Application</strong><span> </span>(version 15.0.&lt;build&gt;.0): This extension handles the system layer.</li>
</ul>
<p>In addition to simplifying the entire codebase, the main benefits of this new structure are that you can <span>move away from code customizations and start making vertical or horizontal solutions based on the Dynamics 365 Business Central platform. </span>You can set up a staging environment and practice with the breaking changes that will be introduced officially in the new version by following these two official articles:</p>
<ul>
<li><a href="https://freddysblog.com/2019/07/31/preview-of-dynamics-365-business-central-2019-release-wave-2/">https://freddysblog.com/2019/07/31/preview-of-dynamics-365-business-central-2019-release-wave-2/</a></li>
<li><a href="https://freddysblog.com/2019/08/02/organizing-your-al-files/">https://freddysblog.com/2019/08/02/organizing-your-al-files/</a></li>
</ul>
<p class="mce-root"><span>All the new extensions that you will create for Dynamics 365 Business Central must be dependent on these Microsoft apps. In Visual Studio Code, when you start a new extension project, you need to add the following dependencies to your extension's </span><kbd>app.json</kbd><span> file:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/cd5c9587-9274-4420-ad9b-b567ee02e403.png" style="width:30.42em;height:37.00em;"/></p>
<p>Those dependencies will be automatically added if you select <strong>4.0</strong> as the target platform in Visual Studio Code.</p>
<p>After that, you can download symbols from your environment and start coding:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b4784bfd-5470-48ae-93c3-74d86a979dc5.png" style="width:21.67em;height:16.08em;"/></p>
<p>This is the recommended way to develop extensions for the SaaS and the on-premise world.</p>
<p><span>In</span> the Dynamics 365 Business Central wave 2 <span>release, Microsoft permits you to also </span><span>modify</span><span> </span><span>the base code (now, it's full AL converted) and the links at the beginning of this section explain how to extract the .al files to a local folder and start working on those files to create your new custom </span><em>BaseApp.</em></p>
<p>As an example, here, I'm directly modifying the standard <em>Sales-Post</em> codeunit by adding a custom function:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d0272c1a-d4c7-4e33-8c51-fa27c6c47e7d.png"/></p>
<p class="mce-root"/>
<p>More information on how to modify the <em>Base Application</em> can be found here: <a href="https://demiliani.com/2019/09/24/dynamics-365-business-central-wave-2-customizing-the-base-application/">https://demiliani.com/2019/09/24/dynamics-365-business-central-wave-2-customizing-the-base-application/</a>.</p>
<p>As we mentioned previously, in many sources by community experts, <em>just because you can, it doesn't mean you should</em>. Modifying base code is actually permitted to help partners move solutions to AL and the new platform as soon as possible, but, in the long term, on-premise will follow cloud rules, so Microsoft's base code modifications may <span>become</span><span> </span><span>more restricted in the future.</span></p>
<p>With the new platform, you can also build extensions on top of the <em>System Application</em> itself. Just remove the dependency from the <em>BaseApp,</em> download some symbols, and<em> </em>you're ready to go. As shown in the following screenshot, now, you have only downloaded two app packages (no BaseApp):</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2b366d94-43f0-4e54-b17b-9f17826d977f.png"/></p>
<p>Now, you can start coding an extension that depends only on the <em>System Application</em>.</p>
<p>The <em>System Application</em> is actually a work in progress and could change in the future (new modules will be added). The latest version is always available on GitHub at <a href="https://github.com/Microsoft/alappextensions">https://github.com/Microsoft/alappextensions</a>.</p>
<p>As you've seen in this section, from the Dynamics 365 Business Central 15.x platform, all the base code has been moved to AL and you need to create extensions with AL and Visual Studio Code, starting with the Microsoft Base and System apps.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we looked at the best practices of moving an existing monolithic C/AL solution to the new extension architecture and to the AL language. We also saw the best practices of architecting your solution, such as how to convert existing C/AL code into AL in a semi-automatic</span> way, and how to handle commo<span>n problems during the migration phase of your existing solution.</span></p>
<p>Toward the end of this chapter, you learned how to migrate to the new Dynamics 365 Business Central platform and the best practices to adopt when starting a project for a new solution. Now, you have a clear vision of the tools to use to migrate existing code to AL and the steps that are required to start this migration activity.</p>
<p>In the next chapter, we'll learn how third-party tools can help us work with AL and extensions, and also help us move our existing solutions to the new Dynamics 365 Business Central architecture.</p>


            </article>

            
        </section>
    </body></html>