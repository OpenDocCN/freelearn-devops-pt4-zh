<html><head></head><body>
        <section>

                            <header class="header-title chapter-title">
                    Using the Terraform CLI
                </header>
            
            <article>
                
<p class="mce-root">Terraform is an <strong>Infrastructure as Code</strong> (<strong>IaC</strong>) tool that consists of two linked elements: the Terraform configuration, written in <strong>HashiCorp Configuration Language</strong> (<strong>HCL</strong>), which describes the infrastructure we want to provision, and the Terraform client tool, which will analyze and execute our Terraform configuration. In the previous two chapters, we have studied a variety of recipes on writing Terraform configuration using variables, functions, and expressions of HCL.</p>
<p class="mce-root">In this chapter, we will focus on the use of Terraform with its command lines and options. We will discuss how to have the code well presented, the destruction of resources, and the use of workspaces. Then we will learn how to import already existing resources, the taint functionality, and finally, we will see how to generate a dependency graph and debug the execution of Terraform.</p>
<p>We will cover the following recipes in this chapter:</p>
<ul>
<li>Keeping your Terraform configuration clean</li>
<li>Validating the code syntax</li>
<li>Destroying infrastructure resources</li>
<li>Using workspaces for managing environments</li>
<li>Importing existing resources</li>
<li>Exporting the output in JSON</li>
<li>Tainting resources</li>
<li>Generating the graph dependencies</li>
<li>Debugging the Terraform execution</li>
</ul>
<h1 id="uuid-91cc874c-705b-48d3-9c5e-911bd5a2f886">Technical requirements</h1>
<p><span>Contrary to the previous two chapters, the code examples provided in this chapter are not fundamental, since we will focus on the execution of Terraform command lines.</span></p>
<div class="packt_infobox">In this chapter<span>, to provide Terraform configuration samples, we will manage resources in Azure cloud; it is obvious that this also applies to all other Terraform providers. If you want to apply these recipes and don't have an Azure account, you can create an Azure account for free at this site:</span> <a href="https://azure.microsoft.com/en-us/free/">https://azure.microsoft.com/en-us/free/</a>.</div>
<p><span>T</span><span>he code examples in this chapter are available here:</span></p>
<p><a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04</a></p>
<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/3m3oho7">https://bit.ly/3m3oho7</a></p>
<h1 id="uuid-128af5c7-b09d-44a0-b9f1-f71c7969512a">Keeping your Terraform configuration clean</h1>
<p class="mce-root">In any application with code, it is very important that the code is clean and clearly readable by all contributors (current and future) who will be involved in the maintenance and evolution of this code.</p>
<p class="mce-root">In IaC and with Terraform, it is even more important to have clear code because written code serving as documentation is an advantage of IaC.</p>
<p class="mce-root">In this recipe, we will look at how to use Terraform's command line to properly format its code and we will also see some tips for automating it.</p>
<h2 id="uuid-1de50849-23e9-4a4d-ad29-b4abc2ce071e">Getting ready</h2>
<p>To get started, we will start with a <kbd>main.tf</kbd> file that contains the following Terraform configuration:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2220917f-7221-4c62-99d6-38491466c531.png" style="width:21.83em;height:17.92em;"/></p>
<p class="mce-root">As we can see, this code is not very readable; it needs to be better formatted.</p>
<div class="packt_infobox">To execute Terraform commands with the CLI, we use a command-line terminal (CMD, PowerShell, Bash, and so on) and the execution folder will be the folder containing the Terraform configuration of the recipe. This will apply to all recipes in this chapter.</div>
<h2 id="uuid-906cb4b6-6d44-4361-b351-dea202803784">How to do it…</h2>
<p class="mce-root"><span>To fix the code indentation, execute the</span> <kbd>terraform fmt</kbd> <span>command as follows:</span></p>
<pre style="color: black;padding-left: 60px"><strong>terraform fmt</strong></pre>
<h2 id="uuid-e42af6c4-7834-4a48-9bc7-8145328a6892">How it works…</h2>
<p>The <kbd>terraform fmt</kbd> command makes it easier to arrange the code with the correct indentation.</p>
<p class="mce-root">At the end of its execution, this command displays the list of files that have been modified, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c7c7e0ad-f353-4a4b-8b36-d4a80accb9c1.png" style="width:35.17em;height:2.83em;"/></p>
<p class="mce-root">We can see that executing the <kbd>terraform fmt</kbd> command modified our <kbd>main.tf</kbd> file.</p>
<p class="mce-root">Then, we open the <kbd>main.tf</kbd> file and read it<span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e14b773a-0f43-4f91-a0f0-e1b870a25614.png" style="width:22.17em;height:18.33em;"/></p>
<p><span>We can see in the preceding screenshot that the code has been well indented and so is more easily readable.</span></p>
<h2 id="uuid-a49d9456-43a7-4419-abf0-395449e4a57b">There's more…</h2>
<p>In this recipe, we have learned that the <kbd>terraform fmt</kbd> command executed in its most basic way, that is, without any additional options.</p>
<p class="mce-root">This default command indents the Terraform file code, which is at the root of the current folder. We can also execute this command recursively, that is, it can also indent the code in subfolders of the current folder.</p>
<p class="mce-root">To do this, we execute the <kbd>terraform fmt</kbd> command with the <kbd>-recursive</kbd> option and its output is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bfddf070-0e1d-4b04-887e-e361220ea6db.png" style="width:35.42em;height:3.67em;"/></p>
<p class="mce-root">We see that the command has also formatted the <kbd>main.tf</kbd> file in the <kbd>sub</kbd> folder.</p>
<p class="mce-root">Among the other options of this command, there is also the <kbd>-check</kbd> option, which can be added and allows you to preview the files that will be indented, without applying the changes in the file(s).</p>
<p class="mce-root">Finally, it's also possible to automate the execution of this command, because apart from running it manually in a command terminal, as seen in this recipe, we can automate it to ensure that every time we save or commit a file in Git, the code provided and shared with the rest of the contributors will always be properly indented.</p>
<p class="mce-root">Thus, the IDEs that support Terraform have integrated the execution of this command natively with the writing of the code:</p>
<ul>
<li>With the Terraform extension of Visual Studio Code, we can have every Terraform file saved and formatted with the <kbd>terraform fmt</kbd> command. For more information, read the pertinent documentation: <a href="https://marketplace.visualstudio.com/items?itemName=HashiCorp.terraform">https://marketplace.visualstudio.com/items?itemName=HashiCorp.terraform</a>.</li>
<li>In IntelliJ, the <span class="packt_screen">Save action</span> plugi<span>n</span> enables the code to be formatted every time it is saved and the <strong>Terraform</strong> plugin has a large integration of the <kbd>terraform fmt</kbd> command within the IDE. Furthermore, with this Terraform plugin, it is possible to execute the <kbd>terraform fmt</kbd> command and arrange the code at every code commit, as shown in the following screenshot:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0df18552-6da3-4b9b-94a0-5e7e82113586.png" style="width:51.75em;height:35.33em;"/></p>
<div class="packt_infobox"><span>For more information on the <span class="packt_screen">Save action</span> plugin, refer to <a href="https://plugins.jetbrains.com/plugin/7642-save-actions">https://plugins.jetbrains.com/plugin/7642-save-actions</a> and for the Terraform plugin, refer to <a href="https://plugins.jetbrains.com/plugin/7808-hashicorp-terraform--hcl-language-support">https://plugins.jetbrains.com/plugin/7808-hashicorp-terraform--hcl-language-support</a>.</span></div>
<p class="CDPAlignLeft CDPAlign">For Git commits, it's possible to automate the execution of the <kbd>terraform fmt</kbd> command before each commit by using pre-commits that are hooks to Git: <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks</a>.</p>
<p class="CDPAlignLeft CDPAlign">To use pre-commits with Terraform, refer to this list of hooks provided by <em>Gruntwork</em>: <a href="https://github.com/gruntwork-io/pre-commit.">https://github.com/gruntwork-io/pre-commit</a>.</p>
<h2 id="uuid-a2b8306b-c85d-4237-8610-f92e46366eb1">See also</h2>
<p>The complete <kbd>terraform fmt</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/fmt.html">https://www.terraform.io/docs/commands/fmt.html</a>.</p>
<h1 id="uuid-e6e82a2d-8ec0-4036-97f2-b2d025108af1">Validating the code syntax</h1>
<p>When writing a Terraform configuration, it is important to be able to validate the syntax of the code we are writing before executing it, or even before archiving it in a Git repository.</p>
<p class="mce-root">We will see in this recipe how, by using the Terraform client tool, we can check the syntax of a Terraform configuration.</p>
<h2 id="uuid-2058f8c6-1ea9-4781-9078-753036cdaa76">Getting ready</h2>
<p>For this recipe, we will start with the following Terraform configuration, which is written in a <kbd>main.tf</kbd> file:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/783a84c0-e179-4f74-a564-ddebe7b28292.png" style="width:22.42em;height:18.67em;"/></p>
<p>What we notice in the preceding code is that the declaration of the <kbd>environment</kbd> <span>variable </span>is missing.</p>
<h2 id="uuid-3526fa31-6d3a-4e8d-8cf7-4db09e873d9c">How to do it…</h2>
<p>To validate our Terraform configuration syntax, perform the following steps:</p>
<ol>
<li class="mce-root">To start, initialize the Terraform context by running the following command:</li>
</ol>
<pre style="color: black;padding-left: 60px"><strong>terraform init</strong></pre>
<ol start="2">
<li>Then, validate the code by executing the <kbd>validate</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform validate</strong></pre>
<h2 id="uuid-9c309717-46cb-4b04-adfb-3f0fc1547a7e">How it works…</h2>
<p>In <em>step 1</em>, we initialize the Terraform context by executing the <kbd>terraform init</kbd> command. </p>
<p>Then, we perform a check of the code validity by executing the <kbd>terraform validate</kbd> command.</p>
<p class="mce-root">At the end of the execution of this command, we get the following output:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/578a737b-e1c6-4be0-a94c-41d563a15810.png" style="width:38.08em;height:9.75em;"/></p>
<p class="mce-root CDPAlignLeft CDPAlign">We see that there is one syntax error in the Terraform configuration, which indicates that we call the variable <kbd>var.environment</kbd>, which has not been declared.</p>
<p class="mce-root">So, we correct the code and run the <kbd>terraform validate</kbd> command again until we have no more errors, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b3b32978-0324-438a-889c-343cfa51fc81.png" style="width:37.58em;height:3.08em;"/></p>
<p class="mce-root">The output shows us that the Terraform configuration is valid.</p>
<h2 id="uuid-e3566237-76bd-4c50-a449-d868c1fd01cf">There's more…</h2>
<p>This validation command is useful in local development mode, but also in code integration in a <strong>continuous integration</strong> (<strong>CI</strong>) pipeline, so as to not execute the <kbd>terraform plan</kbd> command if the <kbd>terraform validate</kbd> command returns syntax errors.</p>
<p>The following PowerShell code shows an example of return code following the execution of this command:</p>
<pre><strong>&gt; terraform validate</strong><br/><strong>&gt; $LASTEXITCODE</strong></pre>
<p class="mce-root">The PowerShell variable, <kbd>$LASTEXITCODE</kbd>, which is native to PowerShell, will return <kbd>0</kbd> if there is no error, otherwise <kbd>1</kbd> if there is an error.</p>
<p class="mce-root">It is also possible to get the output of this command in JSON format by adding the <kbd>-json</kbd> option to this command, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9daeb7f4-ade6-45cb-8a19-4874d2557443.png"/></p>
<p class="mce-root">The JSON result can then be parsed with third-party tools such as <strong>jq</strong> and used in your workflow.</p>
<p class="mce-root">Be careful, however. This command only allows validation of the syntax of the configuration with, for example, the correct use of functions, variables, and object types, and not validation of the execution of the result of the Terraform configuration.</p>
<p>If the Terraform configuration contains a <kbd>backend</kbd> block, then, <span>for t</span><span>his validation of the configuration, we don't need to connect to this state</span><span> file. We can add the</span> <kbd>-backend=false</kbd> <span>option </span>to the <kbd>terraform init</kbd> command.</p>
<p class="mce-root">Finally, if the execution of this Terraform configuration requires variables passed with the <kbd>-var</kbd> argument, or with the <kbd>-var-file</kbd> option, you cannot use this command. Instead, use the <kbd>terraform plan</kbd> command, which performs validation during its execution.</p>
<h2 id="uuid-8bd4016f-447d-4d4b-900b-fe483afe6f1d">See also</h2>
<p>The <kbd>terraform validate</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/validate.html">https://www.terraform.io/docs/commands/validate.html</a></p>
<h1 id="uuid-9c566112-3765-46bd-be64-e98ff2c09ae4">Destroying infrastructure resources</h1>
<p>As we have said many times in this book, IaC allows the rapid provisioning of infrastructure.</p>
<p>Another advantage of <span>IaC</span> is that it allows a quick build and the cleaning up of resources that have been provisioned.</p>
<p>Indeed, we may need to clean up an infrastructure for different reasons. Here are a few examples:</p>
<ul>
<li>
<p>We destroy an infrastructure with a view to rebuild it better in accordance with new specifications.</p>
</li>
<li>
<p>We provide an infrastructure that is called on demand, which means it is temporary for a specific need (such as to test a new feature or a new branch of the application). And this infrastructure must be capable of being built and destroyed quickly and automatically.</p>
</li>
<li>
<p>We want to remove an unused infrastructure and, at the same time, no longer pay for it.</p>
</li>
</ul>
<p class="mce-root">In this recipe, we will discuss how to destroy an infrastructure that has been provisioned with Terraform.</p>
<h2 id="uuid-91ae4043-d21d-4a07-8ab3-8bec0fb42847">Getting ready</h2>
<p>To get started, we are going to provide an infrastructure in Azure that is composed of an Azure App Service.</p>
<p>For this we use the Terraform configuration, which can be found here: <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app</a></p>
<p>Then, to provision it, we execute the basic Terraform workflow with the following commands:</p>
<pre><strong>&gt; terraform init</strong><br/><strong>&gt; terraform plan -out="app.tfplan"</strong><br/><strong>&gt; terraform apply "app.tfplan"</strong></pre>
<p class="mce-root">At the end of its execution, we have a Resource Group, a Service Plan, an App Service, and an Application Insights resource in Azure.</p>
<p class="mce-root">The goal of this recipe is to completely destroy this infrastructure using Terraform commands.</p>
<h2 id="uuid-8b7e82a9-dab0-4aca-be8c-a1c685dae174">How to do it…</h2>
<p>For clean resources with Terraform, perform the following steps:</p>
<ol>
<li>To start, initialize the Terraform context by running the <kbd>init</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform init</strong></pre>
<ol start="2">
<li>Then, to clean the resources, we execute the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform destroy</strong></pre>
<p style="padding-left: 60px">At the beginning of its execution, this command displays all resources that will be destroyed and asks for confirmation to delete the resources. Validation is then confirmed by typing the word <kbd>yes</kbd>.</p>
<h2 id="uuid-d32dc867-df78-4940-bcfd-59693bda9c3f">How it works…</h2>
<p class="mce-root">In <em>step 2</em>, we are destroying all the provisioned resources by executing the <kbd>terraform destroy</kbd> command.</p>
<p class="mce-root">The following screenshot shows the extracted output of this command:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6a994fb5-d844-4078-a913-a71f6bdb2de5.png"/></p>
<p class="CDPAlignLeft CDPAlign">At the end of the command execution, Terraform reports that the resources have been successfully destroyed.</p>
<h2 id="uuid-50db41ee-554e-4a5e-9ed9-f692d5358dcc">There's more…</h2>
<p>In this recipe, we have studied how to destroy all the resources that have been described and provisioned with a Terraform configuration.</p>
<div class="packt_infobox">Since the <kbd>terraform destroy</kbd> command deletes all the resources tracked in the Terraform state file, it is important to break the Terraform configuration by separating it into multiple state files <span>to reduce the room for error when changing the infrastructure.</span></div>
<p>If you need to destroy a single resource and not all the resources tracked in the state file, you can add the <kbd>-target</kbd> option to the <kbd>terraform destroy</kbd> command, which allows you to target the resource to be deleted. The following is an example of this command with the <kbd>target</kbd> option:</p>
<pre><strong>terraform destroy -target <span>azurerm_application_insights.</span><span>appinsight-app</span></strong></pre>
<p>In this example, only the Application Insights resource is destroyed. For more details, read the pertinent documentation here: <a href="https://www.terraform.io/docs/commands/plan.html#resource-targeting">https://www.terraform.io/docs/commands/plan.html#resource-targeting</a></p>
<div class="packt_infobox">Note that the targeting mechanism should only be used as a last resort. In an ideal scenario, the configuration stays in sync with the state file (as applied without any extra <kbd>target</kbd> flags). The risk of executing a targeted apply or destroy operation is that other contributors may miss the context and, more importantly, it becomes much more difficult to apply further changes after changing the configuration.</div>
<p>In addition, if the <kbd>terraform plan</kbd> command in this Terraform configuration requires the <kbd>-var-file</kbd> option to specify or override values to the variables, then the same options must also be added to the <kbd>terraform destroy</kbd> command.</p>
<div class="packt_infobox"><span>In most cases, all options that apply to the </span><kbd>terraform plan</kbd><span> command also apply to the </span><kbd>terraform destroy</kbd><span> command.</span></div>
<h2 id="uuid-c3e696c5-293c-474f-bd9c-cac018dfb906">See also</h2>
<ul>
<li>The documentation pertaining to the <kbd>terraform destroy</kbd> command is available here: <a href="https://www.terraform.io/docs/commands/destroy.html">https://www.terraform.io/docs/commands/destroy.html</a></li>
<li>The documentation <span>pertaining to addressing the </span>resource target is available here: <a href="https://www.terraform.io/docs/internals/resource-addressing.html">https://www.terraform.io/docs/internals/resource-addressing.html</a></li>
</ul>
<h1 id="uuid-9bf23055-eec5-44ea-bc51-47a1b6823129">Using workspaces for managing environments</h1>
<p>In Terraform, there is the concept of <strong>workspaces</strong>, which enables the same Terraform configuration <span>to be used in order </span>to build multiple environments.</p>
<p>Each of these configurations will be written to a different Terraform state file and will thus be isolated from the other configurations. Workspaces can be used to create several environments of our infrastructure.</p>
<p class="mce-root">In this recipe, we will study the use of Terraform workspaces in the Terraform configuration, with the execution of Terraform commands.</p>
<h2 id="uuid-afda0d81-6733-4942-a19e-6e81c237f771">Getting ready</h2>
<p>The purpose of this recipe is for an application to create a Resource Group for each of its environments (<kbd>dev</kbd> and <kbd>prod</kbd>).</p>
<p class="mce-root">Regarding the Terraform configuration, no prerequisites are necessary. We will see it in the steps of the recipe.</p>
<p class="mce-root">The Terraform configuration for this recipe is available here: <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/workspaces">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/workspaces</a></p>
<h2 id="uuid-ae9d10b6-6010-4825-b5ad-1d2880d8db64">How to do it…</h2>
<p>To manage a Terraform workspace, perform the following steps:</p>
<ol>
<li>In a new <kbd>main.tf</kbd> file, we write the following Terraform configuration:</li>
</ol>
<pre style="padding-left: 60px"><span>resource </span><span>"azurerm_resource_group" </span><span>"rg-app" </span>{<br/>  <span>name     </span>= <span>"RG-APP-${terraform.</span><span>workspace</span><span>}"<br/></span><span>  </span><span>location </span>= <span>"westeurope"<br/></span>}</pre>
<ol start="2">
<li>In a command terminal, we navigate into the folder that contains this Terraform configuration and execute the following command:</li>
</ol>
<pre style="padding-left: 60px">terraform workspace new <strong>dev</strong></pre>
<ol start="3">
<li>To provision the <kbd>dev</kbd> environment, we run the basic commands of the Terraform workflow, which are as follows:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"><strong>&gt; terraform init</strong><br/><strong>&gt; terraform plan -out="outdev.tfplan"
&gt; terraform apply "outdev.tfplan"</strong></pre>
<ol start="4">
<li>Then, we execute the <kbd>workspace new</kbd> command with the name of the production workspace to be created:</li>
</ol>
<pre style="padding-left: 60px">terraform workspace new <strong>prod</strong></pre>
<ol start="5">
<li>To finish and provision the <kbd>prod</kbd> environment, we execute the basic commands of the Terraform workflow production, which are as follows:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"><strong>&gt; terraform init</strong><br/><strong>&gt; terraform plan -out="outprod.tfplan"
&gt; terraform apply "outprod.tfplan"</strong></pre>
<h2 id="uuid-77523f16-3d87-47d9-8e98-cb5cd3613be2">How it works…</h2>
<p>In <em>step 1</em>, in the Terraform configuration we wrote, we provide a Resource Group in Azure that will have a name composed of an <kbd>RG-APP</kbd> prefix and a dynamic suffix, <kbd>terraform.workspace</kbd>, which will be the name of the workspace we are going to create.</p>
<p class="mce-root">In <em>step 2</em>, we create the workspace that corresponds to the <kbd>dev</kbd> environment, and for this we use the <kbd>terraform workspace new</kbd> <span>command </span>followed by the workspace name (in this case, <kbd>dev</kbd>).</p>
<p class="mce-root">Once created, Terraform is automatically placed in this workspace, as you can see in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ccda3ae2-3ba8-47ca-ba3b-2a30fd1cd789.png" style="width:37.75em;height:6.08em;"/></p>
<p class="mce-root">After we've created the workspace, we just execute the basic commands of the Terraform workflow, which we do in <em>step 3</em>.</p>
<p>Note that here we have added the <kbd>-out</kbd> option to the <kbd>terraform plan</kbd> command to save the result of the plan in the <kbd>outdev.tfplan</kbd> file. Then, to apply the changes, we specifically add this file as an argument to the <kbd>terraform apply</kbd> command.</p>
<p class="mce-root">Then, to provision the <kbd>prod</kbd> environment, we repeat exactly the same <em>steps 2</em> and <em>3</em>, but this time creating a workspace called <kbd>prod</kbd>.</p>
<p class="mce-root">At the end of the execution of all these steps, we can see in the Azure portal that we have our two Resource Groups that contain in the suffix the name of their workspace, as you can see in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3fd1d118-f30b-4462-a496-0c947eea9842.png" style="width:12.25em;height:5.92em;"/></p>
<p class="mce-root">In addition, we also notice two Terraform state files, one for each workspace, which were created automatically, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ff0cf20e-0607-400f-92a5-a87dd02d6544.png" style="width:15.17em;height:9.33em;"/></p>
<p class="mce-root">In this screenshot, we can see two <kbd>terraform.tfstate</kbd> files, one in the <kbd>dev</kbd> directory and another in the <kbd>prod</kbd> directory.</p>
<h2 id="uuid-e8701fcf-5596-46ca-877e-4c56ade9731a">There's more…</h2>
<p>In any Terraform configuration execution, there is a default workspace that only names <kbd>default</kbd>.</p>
<p class="mce-root">It is possible to see the list of workspaces in our code by executing the following command:</p>
<pre class="mce-root"><strong>terraform workspace list</strong></pre>
<p class="mce-root">The following screenshot shows the execution of this command in the case of our recipe:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2e749ef2-3ea1-4198-aae7-65c914672b05.png"/></p>
<p class="mce-root CDPAlignLeft CDPAlign">We can clearly see our <kbd>dev</kbd> and <kbd>prod</kbd> workspace, and that the current workspace is <kbd>prod</kbd> (marked with an <kbd>*</kbd> in front of its name).</p>
<p class="mce-root">If you want to switch to another workspace, execute the <kbd>terraform workspace select</kbd> <span>command, </span>followed by the name of the workspace to be selected; for example:</p>
<pre class="mce-root">terraform workspace <strong>select</strong> dev</pre>
<p class="mce-root">Finally, you can also delete a workspace by executing the <kbd>terraform workspace delete</kbd> command, followed by the name of the workspace to be deleted; for example:</p>
<pre class="mce-root">terraform workspace <strong>delete</strong> dev</pre>
<div class="mce-root packt_infobox">Be careful when deleting a workspace that it does not delete the associated resources. That's why, in order to delete a workspace, you must first delete the resources provided by that workspace using the <kbd>terraform destroy</kbd> command. Otherwise, if this operation is not carried out, it will no longer be possible to manage these resources with Terraform because the Terraform state file of this workspace will have been deleted.</div>
<div>
<p>In addition, by default, it is not possible to delete a workspace whose state file is not empty. However, we can force the destruction of this workspace by adding the <kbd>-force</kbd> option to the <kbd>terraform workspace delete -force</kbd> <span>command, </span>as documented here: <a href="https://www.terraform.io/docs/commands/workspace/delete.html">https://www.terraform.io/docs/commands/workspace/delete.html</a>.</p>
</div>
<h2 id="uuid-4fb84824-9f34-4534-8c16-9879897f47bf">See also</h2>
<ul>
<li>The general documentation for workspaces is available here: <a href="https://www.terraform.io/docs/state/workspaces.html">https://www.terraform.io/docs/state/workspaces.html</a></li>
<li class="mce-root">The CLI documentation for the <kbd>terraform workspace</kbd> command is available here: <a href="https://www.terraform.io/docs/commands/workspace/index.html">https://www.terraform.io/docs/commands/workspace/index.html</a></li>
<li class="mce-root">Read this blog post for a more complete use of workspaces: <a href="https://www.colinsalmcorner.com/terraform-all-the-things-with-vsts/">https://www.colinsalmcorner.com/terraform-all-the-things-with-vsts/</a></li>
</ul>
<h1 id="uuid-679eb0bb-138f-44d7-baf2-05fc741f0f93">Importing existing resources</h1>
<p>So far in this book, we have seen the normal use of Terraform, which is to write a Terraform configuration that is going to be executed and applied by Terraform. This execution will provision or apply changes to an infrastructure that will be reflected in the Terraform state file.</p>
<p class="mce-root">In certain scenarios, however, it may be necessary to import resources that have already been provisioned into the Terraform state file. Examples of such scenarios include the following:</p>
<ul>
<li class="mce-root">
<p>Resources have been provisioned manually (or by scripts) and now it is desired that their configuration is in the Terraform configuration and in the state file.</p>
</li>
<li class="mce-root">
<p>A Terraform state file that contains the configuration of an infrastructure has been corrupted or deleted and regeneration is desirable.</p>
</li>
</ul>
<p class="mce-root">In this recipe, we will discuss how, with the assistance of Terraform commands, we can import the configuration of resources that have already been provisioned into the Terraform state file.</p>
<h2 id="uuid-7ed93691-2f7e-425c-a76a-219b22a0cf5c">Getting ready</h2>
<p>For this recipe, we will use the following Terraform configuration, which we have already written, in order to provision a Resource Group:</p>
<pre><span>resource </span><span>"azurerm_resource_group" </span><span>"rg-app" </span>{<br/>  <span>name     </span>= <span>"RG-APP-IMPORT"<br/></span><span>  </span><span>location </span>= <span>"westeurope"<br/></span>}</pre>
<p class="mce-root">This code is also available here: <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/import">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/import</a></p>
<p class="mce-root">Also, in the Azure portal, we have created this Resource Group called <kbd>RG-APP-IMPORT</kbd> manually, as explained in the pertinent documentation: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal">https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal</a></p>
<p class="mce-root">The following screenshot shows this Resource Group in Azure:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6a6e02a7-b2d7-4d33-b4e0-ba3725a77790.png" style="width:12.92em;height:3.25em;"/></p>
<p class="mce-root">At this point, if we run Terraform on this code, the <kbd>terraform apply</kbd> command will try to create this Resource Group. It will fail and return the error that the Resource Group already exists and cannot be created, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8e5454a5-f419-4ab8-a1c4-3b7c5f886dda.png"/></p>
<p class="mce-root">It is therefore necessary to use a resource import directly in the Terraform state file.</p>
<div class="packt_infobox">In this recipe, we will perform an import operation with one Resource Group in Azure. But it is important to note that each Terraform provider has different target parameters for the <kbd>import</kbd> command.</div>
<p class="mce-root">The goal of this recipe is to import the configuration of this Resource Group in the Terraform state file corresponding to our Terraform configuration.</p>
<h2 id="uuid-e99061ff-1591-4150-820f-0830e024a241">How to do it…</h2>
<p>Perform the following steps:</p>
<ol>
<li>We initialize the Terraform context by executing the <kbd>init</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform init</strong></pre>
<ol start="2">
<li>Then, we execute the <kbd>terraform import</kbd> <span>command </span>as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform import azurerm_resource_group.rg-app /subscriptions/8a7aace5-xxxxx-xxx/resourceGroups/RG-APP-IMPORT</strong></pre>
<h2 id="uuid-6e200b6b-04c7-4670-a9f5-c1df4bd1ba97">How it works…</h2>
<p>In <em>step 1</em>, the Terraform context is initialized with the <kbd>terraform init</kbd> <span>command.</span></p>
<p class="mce-root">Then, in <em>step 2</em>, we execute the <kbd>terraform import</kbd> command, which takes the reference of the Terraform resource as the first parameter and the Azure identifier of the Resource Group as the second parameter.</p>
<p class="mce-root">The following screenshot shows the output of the execution of this command:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/29adb1ae-4057-41bb-9a35-5b81f359fd5f.png"/></p>
<p class="mce-root">We can see that the resource was indeed imported into the Terraform state file.</p>
<p class="mce-root">We now have the Terraform configuration, the Terraform state file, and the resources in Azure up to date.</p>
<h2 id="uuid-df51468b-7f75-4e33-8618-012b3ff22849">There's more…</h2>
<p>To check the execution of the resource import, we execute the <kbd>terraform plan</kbd> command and we have to have a situation where no changes are required, as can be seen in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a0478c8c-f7ce-42ba-9fbd-dcc9a4c924a8.png"/></p>
<div class="mce-root packt_infobox">If you are provisioning resources in Azure, there are rather interesting tools that generate the Terraform configuration and the corresponding Terraform state file from Azure resources that have <span>already been created</span>. This open source <strong>Az2Tf</strong> tool is available at <a href="https://github.com/andyt530/py-az2tf">https://github.com/andyt530/py-az2tf</a>. Alternatively, there is <strong>TerraCognita</strong>, which is available at <a href="https://github.com/cycloidio/terracognita/blob/master/README.md">https://github.com/cycloidio/terracognita/blob/master/README.md</a>.</div>
<h2 id="uuid-c8b6efca-0297-4d97-9d73-c9039a7f8ae8">See also</h2>
<p>The documentation pertaining to the <kbd>import</kbd> command is available here: <a href="https://www.terraform.io/docs/commands/import.html">https://www.terraform.io/docs/commands/import.html</a></p>
<h1 id="uuid-d3a5da8f-5817-43a7-afd9-71fae553b1f9">Exporting the output in JSON</h1>
<p>We discussed in the <em>Looping over object collections</em> recipe of <a href="d019fed0-6c22-4da8-9796-58d45feafa2c.xhtml">Chapter 3</a>, <em>Building Dynamic Environments with Terraform</em>, the use of Terraform's outputs that allow you to have output values for the execution of the Terraform configuration. Indeed, we have seen how to declare an output in the Terraform configuration, and we learned that these outputs and their values were displayed at the end of the execution of the <kbd>terraform apply</kbd> command.</p>
<p class="mce-root">The advantage of these outputs is that they can be retrieved by a program and thus be used for another operation; for example, in a CI/CD pipeline.</p>
<p class="mce-root">In this recipe, we will see how the values of the outputs can be retrieved in JSON format so that they can be used in an external program.</p>
<h2 id="uuid-e135d952-7522-4aca-a550-39c89d11b535">Getting ready</h2>
<p>For this recipe, we will use only the Terraform configuration that we studied in <a href="d019fed0-6c22-4da8-9796-58d45feafa2c.xhtml">Chapter 3</a>, <em>Building Dynamic Environments with Terraform</em>, and whose sources can be found here: <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP03/list_map">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP03/list_map</a></p>
<p class="mce-root">In this code, we add another output that returns the list of App Service URLs as shown:</p>
<pre><span>output </span><span>"app_service_urls" </span>{<br/>  <span>value </span>= {for x in <span>azurerm_app_service</span>.app :  <span>x</span>.name =&gt; <span>x</span>.default_site_hostname  }<br/>}</pre>
<p class="mce-root">To exploit the values of the output, we need to use a tool that allows us to work on JSON. For this, you can use any framework and library according to your scripting languages. In this recipe, we will use <strong>jq</strong>, which is a free tool that allows you to easily manipulate JSON on the command line. The documentation on jq is available here <a href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a>.</p>
<p>The purpose of this recipe is to provision two Azure App Services using Terraform configuration and then, with a script, perform a response check of the URL of the first App Service.</p>
<h2 id="uuid-b426391d-ed92-4295-8f95-c831817390a1">How to do it…</h2>
<p>Perform the following steps to use the output:</p>
<ol>
<li>Execute the Terraform workflow with the following commands:</li>
</ol>
<pre style="padding-left: 60px"><strong>&gt; terraform init</strong><br/><strong>&gt; terraform plan -out="app.tfplan"</strong><br/><strong>&gt; terraform apply "app.tfplan"</strong></pre>
<ol start="2">
<li>Then, run the <kbd>terraform output</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform output</strong></pre>
<ol start="3">
<li>Finally, to retrieve the URL of the created App Service, we execute the following command in the command terminal:</li>
</ol>
<pre style="padding-left: 60px">urlwebapp1=$(<strong>terraform output -json</strong> | <strong>jq -r .app_service_urls.value.webappdemobook1</strong>) &amp;&amp;<br/>curl -sL "%{http_code}" -I "$urlwebapp1/hostingstart.html"</pre>
<h2 id="uuid-981e6143-8858-4cc2-8535-7fd2ab3275be">How it works…</h2>
<p>In <em>step 1</em>, we execute the basic commands of the Terraform workflow. After executing the <kbd>terraform apply</kbd> command, the command displays the output.</p>
<p class="mce-root">Then, in <em>step 2</em>, we visualize the output of this Terraform configuration more clearly by executing the <kbd>terraform output</kbd> <span>command, </span>as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a2306f84-2a90-4993-8b18-68bd678108cf.png"/></p>
<p class="mce-root">In the preceding screenshot, we can see that this command returns the two outputs declared in the code, which are as follows:</p>
<ul>
<li class="mce-root"><kbd>app_service_names</kbd>: This returns a list of App Service names provided.</li>
<li class="mce-root"><kbd>app_service_urls</kbd>: <span>This returns a list </span>of the URLs of provisioned App Services.</li>
</ul>
<p class="mce-root">Finally, in <em>step 3</em>, we run a script that checks the URL of the <kbd>webappdemobook1</kbd> App Service. In the first line of this script, we execute the <kbd>terraform output -json</kbd> command, which enables the result of the output to be <span>returned </span>in JSON format, as you can see in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b346db5e-0c06-4f63-b832-84082452c66d.png" style="width:42.42em;height:30.33em;"/></p>
<p class="mce-root">Then, with this result in JSON, we use the <strong>jq</strong> tool on it by retrieving the URL of the <kbd>webappdemobook1</kbd> <span>App Service. </span>The returned URL is put in a variable called <kbd>urlwebapp1</kbd>.</p>
<p class="mce-root">Then, in the second line of this script, we use the <kbd>curl</kbd> command on this URL by passing options to return only the HTTP header of this URL.</p>
<p class="mce-root">The result of the execution of this script is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2aee7893-7dcd-45e0-9d0a-ef97c73b36ff.png"/></p>
<p>You can see that the result of the check is <kbd>OK</kbd>, with a status code of <kbd>200</kbd>. </p>
<h2 id="uuid-386ade46-a0ff-4e1f-ad2c-32207fec95ea">There's more…</h2>
<p>In this recipe, we learned how to retrieve all the outputs of a Terraform configuration. It is also possible to retrieve the value of a particular output by executing the <kbd>terraform output &lt;output name&gt;</kbd> <span>command.</span></p>
<p class="mce-root">In our case, we could have executed the <kbd>app_service_urls</kbd> command to display the value of the output:</p>
<pre class="mce-root"><strong>terraform output app_service_urls</strong></pre>
<p class="mce-root">The following screenshot shows the execution of this command:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/69cecede-2901-4166-8eba-3f7d2edf43e9.png"/></p>
<p class="mce-root">Then, we would run the following command to check the URL:</p>
<pre class="mce-root">urlwebapp1=$(<strong>terraform output app_service_urls -json</strong> | <strong>jq -r .webappdemobook1</strong>) &amp;&amp;<br/>curl -sL "%{http_code}" -I "$urlwebapp1/hostingstart.html"</pre>
<p class="mce-root">We see in this script that the command used is <kbd>terraform output app_service_urls -json</kbd>, which is more <span>simplistic</span> than <kbd>$(terraform output -json | jq -r .app_service_urls.value.webappdemobook1)</kbd>.</p>
<h2 id="uuid-3bc33214-2805-44d1-b655-f8961ebc4312">See also</h2>
<ul>
<li class="mce-root">The <kbd>terraform output</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/output.html">https://www.terraform.io/docs/commands/output.html</a></li>
<li class="mce-root">jq's website can be found here: <a href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a></li>
</ul>
<h1 id="uuid-f6efd94d-1eca-448f-9387-24d5f9d94796">Tainting resources</h1>
<p>Earlier, in the <em>Destroying infrastructure resources</em> recipe, we learned how to destroy resources that have been provisioned with Terraform.</p>
<p class="mce-root">However, in certain situations, you may need to destroy a particular resource in order to rebuild it immediately. Examples of such situations may include modifications that have been made manually on that resource.</p>
<p class="mce-root">To destroy and rebuild <span>a</span> resource, you could perform the <kbd>terraform destroy -target &lt;resource&gt;</kbd> command, followed by the <kbd>apply</kbd> <span>command. </span>However, the problem is that between the <kbd>destroy</kbd> and <kbd>apply</kbd> <span>commands, </span>there may be other changes in the Terraform configuration that will be applied that are not desired.</p>
<p class="mce-root">So, in this recipe, we will see how to perform this operation using the Terraform notion of tainting.</p>
<h2 id="uuid-622a68a4-c149-452e-88e6-fd3bf79ed68d">Getting ready</h2>
<p>In order to apply this recipe, we have first provisioned the infrastructure <span>composed of a Resource Group, a Service Plan, an App Service, and an Application Insights resource. </span>The Terraform configuration used for this provisioning can be found here: <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app</a>.</p>
<p class="mce-root">The goal of this recipe is to destroy and then rebuild the App Service in a single operation using the <kbd>taint</kbd> command of Terraform.</p>
<h2 id="uuid-72a35025-5aad-4ca9-95fc-4bf9557f1038">How to do it…</h2>
<p>To apply the <kbd>taint</kbd> operation, perform the following steps:</p>
<ol>
<li>Run the <kbd>terraform init</kbd> command to initialize the context.</li>
<li>Then, execute the <kbd>terraform taint</kbd> command to flag the resource as <em>tainted</em>:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform taint azurerm_app_service.app</strong></pre>
<ol start="3">
<li>Finally, to rebuild the App Service, execute the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform apply</strong></pre>
<h2 id="uuid-a1a4887f-5cdb-4490-8800-811cdfde8814">How it works…</h2>
<p>In <em>step 1</em>, we execute the <kbd>terraform init</kbd> command to initialize the context. Then, in <em>step 2</em>, we execute the <kbd>terraform taint</kbd> command to flag the <kbd>azurerm_app_service.app</kbd> <span>resource </span>as tainted; that is, to be destroyed and rebuilt.</p>
<div class="mce-root packt_infobox">This command does not affect the resource itself, but <span>only marks it as tainted in the Terraform state file.</span></div>
<p class="mce-root">The following screenshot shows the result of the <kbd>taint</kbd> command:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4ce81d8d-4958-4a7b-a8ba-6961c6f963f5.png"/></p>
<p class="mce-root">Finally, in <em>step 3</em>, we execute the <kbd>terraform apply</kbd> command and, when it is executed, we can see that Terraform will delete and then recreate the Azure App Service, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f305383a-c0ba-4eb6-9fd5-460451b2046b.png"/></p>
<p class="mce-root">We can see in the preceding screenshot that Terraform destroys the App Service resource and then recreates it.</p>
<h2 id="uuid-b8bb296e-e56b-45bb-8e89-d78105f3ac28">There's more…</h2>
<p><span>To go further, </span>we can display in the terminal the status of this resource flagged in the Terraform state file by executing the <kbd>terraform state show</kbd> command, which displays the contents of the state file in the command terminal (documented here: <a href="https://www.terraform.io/docs/commands/state/show.html">https://www.terraform.io/docs/commands/state/show.html</a>) as follows:</p>
<pre><strong>terraform state show <span>azurerm_app_service.app</span></strong></pre>
<p>The following screenshot shows the result of this command:</p>
<p class="mce-root CDPAlignCenter CDPAlign"><img src="assets/6e21ebdd-972c-4e33-8d09-8271bc5aa1c8.png"/></p>
<p class="mce-root">We can see that the resource App Service has the flag <kbd>tainted</kbd>.</p>
<div class="packt_infobox">We have used the <kbd>terraform state</kbd> command to display the contents of the state, since it is strongly discouraged to read and modify the state file manually, as documented here: <a href="https://www.terraform.io/docs/state/index.html#inspection-and-modification">https://www.terraform.io/docs/state/index.html#inspection-and-modification</a></div>
<p class="mce-root">Moreover, in order to cancel the taint flag applied with the <kbd>terraform taint</kbd> command, we can execute the inverse command, which is <kbd>terraform untaint</kbd>. This command can be executed like this:</p>
<pre class="mce-root"><strong>terraform untaint azurerm_app_service.app</strong></pre>
<p class="mce-root">Then, if we execute the <kbd>terraform plan</kbd> command, we can see that there is no change, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e8ec7081-f7ac-4c32-a25f-652d9e5ebb4d.png"/></p>
<p>We see in this screenshot that the <kbd>untaint</kbd> command has cancelled the effect of the <kbd>taint</kbd> command and, during the execution of the <kbd>plan</kbd> command, no changes will be applied to the infrastructure.</p>
<h2 id="uuid-5c81627a-1d1e-4147-b426-47fb6f07e58b">See also</h2>
<ul>
<li>The <kbd>terraform taint</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/taint.html">https://www.terraform.io/docs/commands/taint.html</a></li>
<li class="mce-root">The <kbd>terraform untaint</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/untaint.html">https://www.terraform.io/docs/commands/untaint.html</a></li>
<li>The <kbd>terraform state</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/state/index.html">https://www.terraform.io/docs/commands/state/index.html</a></li>
<li class="mce-root">An article that explains the <kbd>taint</kbd> and <kbd>untaint</kbd> commands really well can be found here: <a href="https://www.devopsschool.com/blog/terraform-taint-and-untaint-explained-with-example-programs-and-tutorials/">https://www.devopsschool.com/blog/terraform-taint-and-untaint-explained-with-example-programs-and-tutorials/</a></li>
</ul>
<h1 id="uuid-17ca0768-e37e-480c-bea2-dc1f41691a2a">Generating the graph dependencies</h1>
<p>One of the interesting features of Terraform is the ability to generate a dependency graph of the resource dependencies mentioned in the Terraform configuration.</p>
<p class="mce-root">In this recipe, we will see how to generate and visualize this dependency graph.</p>
<h2 id="uuid-0ec5d0bd-90ee-4001-b21d-71c5bcdeaa0e">Getting ready</h2>
<p>For this recipe, we need to use a third-party drawing generation tool called <strong>Graphviz</strong>, which is available for download at <a href="https://graphviz.gitlab.io/download/">https://graphviz.gitlab.io/download/</a>. You will need to download and install the package corresponding to your operating system.</p>
<p class="mce-root">Moreover, as an example, we will take the Terraform configuration available at <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app.</a></p>
<h2 id="uuid-9c43bd68-16e3-4ad6-83bb-b1cfd0b4b771">How to do it…</h2>
<p>To generate the graph dependencies, perform the following steps:</p>
<ol>
<li>Execute the <kbd>terraform graph</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>terraform graph | dot -Tsvg &gt; graph.svg</strong></pre>
<ol start="2">
<li>Open the file explorer and navigate inside the folder that contains the Terraform configuration and open the file called <kbd>graph.svg</kbd>.</li>
</ol>
<h2 id="uuid-727f2934-8f0f-4168-87f5-2c8bd14fcb06">How it works…</h2>
<p>In <em>step 1</em>, we will execute the <kbd>terraform graph</kbd> command. Then, we send the result of this graph command to the <kbd>dot</kbd> utility that was previously installed with Graphviz. This <kbd><span><span>dot</span></span></kbd> <span><span>utility</span></span> will generate a <kbd>graph.svg</kbd> file, which contains the graphical representation of the Terraform configuration.</p>
<p class="mce-root">In <em>step 2</em>, we open the <kbd>graph.svg</kbd> file and we see the dependency graph as shown in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c9a04354-3503-42be-8da6-33b7955c9243.png" style="width:42.25em;height:21.42em;"/></p>
<p class="mce-root">In the preceding diagram, we can see the dependencies between variables, resources, and the provider.</p>
<h2 id="uuid-f72dff6c-da62-4ea6-a5e2-07a413f46ed7">See also</h2>
<ul>
<li>The <kbd>terraform graph</kbd> command documentation is available here: <a href="https://www.terraform.io/docs/commands/graph.html">https://www.terraform.io/docs/commands/graph.html</a></li>
<li class="mce-root">Documentation relating to Graphviz is available here: <a href="https://graphviz.gitlab.io/">https://graphviz.gitlab.io/</a></li>
<li>An excellent video about the generation of graph dependencies can be found here: <a href="https://techsnips.io/snips/how-to-use-graphviz-with-terraform-to-visualize-your-infrastructure/">https://techsnips.io/snips/how-to-use-graphviz-with-terraform-to-visualize-your-infrastructure/</a></li>
</ul>
<h1 id="uuid-564b1982-ce4a-4489-8e32-b8565635d915">Debugging the Terraform execution</h1>
<p>When we execute Terraform commands, the display output of the console is quite simple and clear.</p>
<p>In this recipe, we will study how to activate the debug mode in Terraform, which will allow us to display more information about its execution.</p>
<h2 id="uuid-e19ae57e-dcec-4d34-96b6-612b3547046a">Getting ready</h2>
<p>For this recipe, we will use the Terraform configuration available at <a href="https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app.">https://github.com/PacktPublishing/Terraform-Cookbook/tree/master/CHAP04/sample-app.</a></p>
<p class="mce-root">Furthermore, for the purposes of this demonstration, we will run it on a Windows operating system, but the operation is exactly the same on other operating systems.</p>
<h2 id="uuid-785dc3f8-875c-4798-a20e-82c13c74ce9a">How to do it…</h2>
<p>To activate the debug on Terraform, perform the following steps:</p>
<ol>
<li>In the PowerShell command-line terminal, execute the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>$env:TF_LOG = "TRACE"</strong></pre>
<ol start="2">
<li>Now, we can execute the Terraform workflow commands with display logs activated:</li>
</ol>
<pre style="padding-left: 60px"><strong>&gt; terraform init</strong><br/><strong>&gt; terraform plan -out=app.tfplan</strong><br/><strong>&gt; terraform apply app.tfplan</strong></pre>
<h2 id="uuid-124a4d98-3f9a-4d8d-b402-b35f5a222938">How it works…</h2>
<p>In <em>step 1</em>, we create a Terraform environment variable, <kbd>TF_LOG</kbd>, which enables Terraform's verbose mode to be activated, indicating that we want to see all traces of Terraform's execution displayed.</p>
<div class="mce-root packt_infobox">Here, in this recipe, we used the <kbd>$env</kbd> command to set this environment variable because we are working on Windows. You can, of course, do the same on other operating systems with the correct syntax.</div>
<p class="mce-root">Then, in <em>step 2</em>, we execute the commands of the Terraform workflow and we can see in the output all traces of this execution, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f868b821-4860-4277-a9aa-f805e2031a1d.png"/></p>
<p class="mce-root">In this screenshot, which is an extract of the execution of Terraform, you can see all the steps involved in the execution of Terraform.</p>
<h2 id="uuid-6e857ca8-e71d-4a69-9c71-3808231551fc">There's more…</h2>
<p>Instead of having all these traces displayed in the console output, it is also possible to save them in a file.</p>
<p>To do this, just create a second environment variable, <kbd>TF_LOG_PATH</kbd>, which will contain as a value the path to the log file. Indeed, the logs are often very verbose and difficult to read on the console output. That's why we prefer that the output of the logs is written in a file that can be read more easily.</p>
<p class="mce-root">Moreover, to disable these traces, the <kbd>TF_LOG</kbd> environment variable must be emptied by assigning it an empty value as follows:</p>
<pre class="mce-root"><strong>$env:TF_LOG = ""</strong></pre>
<h2 id="uuid-e8ea446d-06b3-47b6-9dfa-15ff53009d7c">See also</h2>
<ul>
<li>The documentation on the Terraform debug is available here: <a href="https://www.terraform.io/docs/internals/debugging.html">https://www.terraform.io/docs/internals/debugging.html</a></li>
<li class="mce-root">Documentation on Terraform's environment variables is available here: <a href="https://www.terraform.io/docs/commands/environment-variables.html">https://www.terraform.io/docs/commands/environment-variables.html</a></li>
</ul>


            </article>

            
        </section>
    </body></html>